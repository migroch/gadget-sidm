<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>GADGET-2: domain.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<h1>domain.c File Reference</h1>  </div>
</div>
<div class="contents">

<p>code for domain decomposition  
<a href="#_details">More...</a></p>
<code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;mpi.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="allvars_8h_source.html">allvars.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="proto_8h_source.html">proto.h</a>&quot;</code><br/>
<div class="dynheader">
Include dependency graph for domain.c:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c__incl.png" border="0" usemap="#domain_8c" alt=""/></div>
<map name="domain_8c" id="domain_8c">
<area shape="rect" id="node13" href="allvars_8h.html" title="declares global variables." alt="" coords="352,160,427,189"/><area shape="rect" id="node20" href="proto_8h.html" title="this file contains all function prototypes of the code" alt="" coords="437,83,504,112"/><area shape="rect" id="node18" href="tags_8h.html" title="declares various tags for labelling MPI messages." alt="" coords="412,237,473,267"/></map>
</div>

<p><a href="domain_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structtopnode__exchange.html">topnode_exchange</a></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#aebefeda80791480c21adcdd296f92c90">TOPNODEFACTOR</a>&nbsp;&nbsp;&nbsp;20.0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a503173887b0902500751aee72367e074">REDUC_FAC</a>&nbsp;&nbsp;&nbsp;0.98</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#ae8e3aa408eaab9544cb7f93e69185492">domain_Decomposition</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf">domain_decompose</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit</a> (int cpustart, int ncpu, int first, int <a class="el" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba">domain_shiftSplit</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9">domain_findExchangeNumbers</a> (int task, int partner, int sphflag, int *send, int *recv)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a> (int partner, int sphflag, int send_count, int recv_count)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c">domain_countToGo</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4">domain_walktoptree</a> (int no)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e">domain_sumCost</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e">domain_findExtent</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729">domain_determineTopTree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421">domain_topsplit_local</a> (int node, <a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> startkey)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a606de536756a67ad8f79f1135009195e">domain_topsplit</a> (int node, <a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> startkey)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700">domain_compare_toplist</a> (const void *a, const void *b)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37">domain_compare_key</a> (const void *a, const void *b)</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static long long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static long long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structtopnode__exchange.html">topnode_exchange</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structtopnode__exchange.html">topnode_exchange</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>code for domain decomposition </p>
<p>This file contains the code for the domain decomposition of the simulation volume. The domains are constructed from disjoint subsets of the leaves of a fiducial top-level tree that covers the full simulation volume. Domain boundaries hence run along tree-node divisions of a fiducial global BH tree. As a result of this method, the tree force are in principle strictly independent of the way the domains are cut. The domain decomposition can be carried out for an arbitrary number of CPUs. Individual domains are not cubical, but spatially coherent since the leaves are traversed in a Peano-Hilbert order and individual domains form segments along this order. This also ensures that each domain has a small surface to volume ratio, which minimizes communication. </p>

<p>Definition in file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a503173887b0902500751aee72367e074"></a><!-- doxytag: member="domain.c::REDUC_FAC" ref="a503173887b0902500751aee72367e074" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define REDUC_FAC&nbsp;&nbsp;&nbsp;0.98</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00031">31</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

</div>
</div>
<a class="anchor" id="aebefeda80791480c21adcdd296f92c90"></a><!-- doxytag: member="domain.c::TOPNODEFACTOR" ref="aebefeda80791480c21adcdd296f92c90" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TOPNODEFACTOR&nbsp;&nbsp;&nbsp;20.0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00029">29</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>, and <a class="el" href="domain_8c_source.html#l00982">domain_topsplit_local()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a5b596de46669fab5e125f163d44edc37"></a><!-- doxytag: member="domain.c::domain_compare_key" ref="a5b596de46669fab5e125f163d44edc37" args="(const void *a, const void *b)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int domain_compare_key </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>b</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This is a comparison kernel used in a sort routine. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l01119">1119</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(*(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) a &lt; *(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) b)
    <span class="keywordflow">return</span> -1;

  <span class="keywordflow">if</span>(*(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) a &gt; *(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) b)
    <span class="keywordflow">return</span> +1;

  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a5b596de46669fab5e125f163d44edc37_icgraph.png" border="0" usemap="#domain_8c_a5b596de46669fab5e125f163d44edc37_icgraph" alt=""/></div>
<map name="domain_8c_a5b596de46669fab5e125f163d44edc37_icgraph" id="domain_8c_a5b596de46669fab5e125f163d44edc37_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="216,57,408,87"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="456,57,608,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="656,57,829,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="877,5,1096,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1156,56,1199,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="967,109,1007,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1260,83,1313,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1144,109,1211,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a381621bc90438c5a50826bfdac8e4700"></a><!-- doxytag: member="domain.c::domain_compare_toplist" ref="a381621bc90438c5a50826bfdac8e4700" args="(const void *a, const void *b)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int domain_compare_toplist </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>b</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This is a comparison kernel used in a sort routine. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l01106">1106</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="domain_8c_source.html#l00049">topnode_exchange::Startkey</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a> *) a)-&gt;Startkey &lt; (((<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a> *) b)-&gt;Startkey))
    <span class="keywordflow">return</span> -1;

  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a> *) a)-&gt;Startkey &gt; (((<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a> *) b)-&gt;Startkey))
    <span class="keywordflow">return</span> +1;

  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a381621bc90438c5a50826bfdac8e4700_icgraph.png" border="0" usemap="#domain_8c_a381621bc90438c5a50826bfdac8e4700_icgraph" alt=""/></div>
<map name="domain_8c_a381621bc90438c5a50826bfdac8e4700_icgraph" id="domain_8c_a381621bc90438c5a50826bfdac8e4700_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="235,57,427,87"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="475,57,627,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="675,57,848,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="896,5,1115,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1175,56,1217,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="985,109,1025,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1279,83,1332,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1163,109,1229,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a77c115c3aa2069d0eb8521329be0483c"></a><!-- doxytag: member="domain.c::domain_countToGo" ref="a77c115c3aa2069d0eb8521329be0483c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_countToGo </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function determines how many particles that are currently stored on the local CPU have to be moved off according to the domain decomposition. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00729">729</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="domain_8c_source.html#l00038">local_toGo</a>, <a class="el" href="domain_8c_source.html#l00038">local_toGoSph</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="domain_8c_source.html#l00037">toGo</a>, <a class="el" href="domain_8c_source.html#l00037">toGoSph</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> n, no;

  <span class="keywordflow">for</span>(n = 0; n &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; n++)
    {
      <a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a>[n] = 0;
      <a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a>[n] = 0;
    }

  <span class="keywordflow">for</span>(n = 0; n &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; n++)
    {
      no = 0;

      <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter &gt;= 0)
        no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + (<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] - <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Size / 8);

      no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a>;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no] != <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
        {
          <a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no]] += 1;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type == 0)
            <a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a>[DomainTask[no]] += 1;
        }
    }

  MPI_Allgather(<a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a>, NTask, MPI_INT, <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>, NTask, MPI_INT, MPI_COMM_WORLD);
  MPI_Allgather(<a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a>, NTask, MPI_INT, <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>, NTask, MPI_INT, MPI_COMM_WORLD);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a77c115c3aa2069d0eb8521329be0483c_icgraph.png" border="0" usemap="#domain_8c_a77c115c3aa2069d0eb8521329be0483c_icgraph" alt=""/></div>
<map name="domain_8c_a77c115c3aa2069d0eb8521329be0483c_icgraph" id="domain_8c_a77c115c3aa2069d0eb8521329be0483c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="200,57,352,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="400,57,573,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="621,5,840,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="900,56,943,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="711,109,751,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1004,83,1057,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="888,109,955,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a647e0c1a76b7f064ed5d201662f364bf"></a><!-- doxytag: member="domain.c::domain_decompose" ref="a647e0c1a76b7f064ed5d201662f364bf" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_decompose </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function carries out the actual domain decomposition for all particle types. It will try to balance the work-load for each domain, as estimated based on the P[i]-GravCost values. The decomposition will respect the maximum allowed memory-imbalance given by the value of PartAllocFactor. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00154">154</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="domain_8c_source.html#l00729">domain_countToGo()</a>, <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>, <a class="el" href="domain_8c_source.html#l00595">domain_exchangeParticles()</a>, <a class="el" href="domain_8c_source.html#l00534">domain_findExchangeNumbers()</a>, <a class="el" href="domain_8c_source.html#l00845">domain_findExtent()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, <a class="el" href="domain_8c_source.html#l00447">domain_shiftSplit()</a>, <a class="el" href="domain_8c_source.html#l00786">domain_sumCost()</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="domain_8c_source.html#l00041">list_load</a>, <a class="el" href="domain_8c_source.html#l00040">list_N_gas</a>, <a class="el" href="domain_8c_source.html#l00039">list_NumPart</a>, <a class="el" href="domain_8c_source.html#l00043">list_work</a>, <a class="el" href="domain_8c_source.html#l00045">maxload</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, <a class="el" href="allvars_8c_source.html#l00021">Ntype</a>, <a class="el" href="allvars_8c_source.html#l00022">NtypeLocal</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="allvars_8h_source.html#l00477">global_data_all_processes::SofteningTable</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="domain_8c_source.html#l00037">toGo</a>, <a class="el" href="domain_8c_source.html#l00037">toGoSph</a>, and <a class="el" href="allvars_8h_source.html#l00273">global_data_all_processes::TotN_gas</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, status;
  <span class="keywordtype">int</span> ngrp, task, partner, sendcount, recvcount;
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> sumtogo, sumload;
  <span class="keywordtype">int</span> <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a>, *temp;
  <span class="keywordtype">double</span> sumwork, maxwork;

  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    <a class="code" href="allvars_8c.html#a7e6cdb6eab38cb043edcf56a4518dfca">NtypeLocal</a>[i] = 0;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <a class="code" href="allvars_8c.html#a7e6cdb6eab38cb043edcf56a4518dfca">NtypeLocal</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type]++;

  <span class="comment">/* because Ntype[] is of type `long long&#39;, we cannot do a simple</span>
<span class="comment">   * MPI_Allreduce() to sum the total particle numbers </span>
<span class="comment">   */</span>
  temp = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * 6 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  MPI_Allgather(<a class="code" href="allvars_8c.html#a7e6cdb6eab38cb043edcf56a4518dfca">NtypeLocal</a>, 6, MPI_INT, temp, 6, MPI_INT, MPI_COMM_WORLD);
  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    {
      <a class="code" href="allvars_8c.html#a697577a2a59bfa869161211cb134a6ae">Ntype</a>[i] = 0;
      <span class="keywordflow">for</span>(j = 0; j &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; j++)
        <a class="code" href="allvars_8c.html#a697577a2a59bfa869161211cb134a6ae">Ntype</a>[i] += temp[j * 6 + i];
    }
  free(temp);

<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a697577a2a59bfa869161211cb134a6ae">Ntype</a>[i] &gt; 0)
      <span class="keywordflow">break</span>;

  <span class="keywordflow">for</span>(ngrp = i + 1; ngrp &lt; 6; ngrp++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a697577a2a59bfa869161211cb134a6ae">Ntype</a>[ngrp] &gt; 0)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[ngrp] != <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[i])
          {
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
              {
                fprintf(stdout, <span class="stringliteral">&quot;Code was not compiled with UNEQUALSOFTENINGS, but some of the\n&quot;</span>);
                fprintf(stdout, <span class="stringliteral">&quot;softening lengths are unequal nevertheless.\n&quot;</span>);
                fprintf(stdout, <span class="stringliteral">&quot;This is not allowed.\n&quot;</span>);
              }
            <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
          }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="comment">/* determine global dimensions of domain grid */</span>
  <a class="code" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e">domain_findExtent</a>();

  <a class="code" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729">domain_determineTopTree</a>();

  <span class="comment">/* determine cost distribution in domain grid */</span>
  <a class="code" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e">domain_sumCost</a>();

  <span class="comment">/* find the split of the domain grid recursively */</span>
  status = <a class="code" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit</a>(0, <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>, 0, <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a> - 1);
  <span class="keywordflow">if</span>(status != 0)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nNo domain decomposition that stays within memory bounds is possible.\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

  <span class="comment">/* now try to improve the work-load balance of the split */</span>
  <a class="code" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba">domain_shiftSplit</a>();

  <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a> = <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>];
  <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a> = <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>];

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      sumload = maxload = 0;
      sumwork = maxwork = 0;
      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
        {
          sumload += <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[i];
          sumwork += <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[i];

          <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[i] &gt; maxload)
            maxload = <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[i];

          <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[i] &gt; maxwork)
            maxwork = <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[i];
        }

      printf(<span class="stringliteral">&quot;work-load balance=%g   memory-balance=%g\n&quot;</span>,
             maxwork / (sumwork / NTask), maxload / (((<span class="keywordtype">double</span>) sumload) / NTask));
    }


  <span class="comment">/* determine for each cpu how many particles have to be shifted to other cpus */</span>
  <a class="code" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c">domain_countToGo</a>();

  <span class="keywordflow">for</span>(i = 0, sumtogo = 0; i &lt; NTask * NTask; i++)
    sumtogo += <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[i];

  <span class="keywordflow">while</span>(sumtogo &gt; 0)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;exchange of %d%09d particles\n&quot;</span>, (<span class="keywordtype">int</span>) (sumtogo / 1000000000),
                 (<span class="keywordtype">int</span>) (sumtogo % 1000000000));
          fflush(stdout);
        }

      <span class="keywordflow">for</span>(ngrp = 1; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
        {
          <span class="keywordflow">for</span>(task = 0; task &lt; NTask; task++)
            {
              partner = task ^ ngrp;

              <span class="keywordflow">if</span>(partner &lt; NTask &amp;&amp; task &lt; partner)
                {
                  <span class="comment">/* treat SPH separately */</span>
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2bb70816a4d5f56e0df2d9b8d706cef2">TotN_gas</a> &gt; 0)
                    {
                      <a class="code" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9">domain_findExchangeNumbers</a>(task, partner, 1, &amp;sendcount, &amp;recvcount);

                      <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[task] += recvcount - sendcount;
                      <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[partner] -= recvcount - sendcount;
                      <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>[task] += recvcount - sendcount;
                      <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>[partner] -= recvcount - sendcount;

                      <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[task * NTask + partner] -= sendcount;
                      <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[partner * NTask + task] -= recvcount;
                      <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[task * NTask + partner] -= sendcount;
                      <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[partner * NTask + task] -= recvcount;

                      <span class="keywordflow">if</span>(task == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)      <span class="comment">/* actually carry out the exchange */</span>
                        <a class="code" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a>(partner, 1, sendcount, recvcount);
                      <span class="keywordflow">if</span>(partner == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                        <a class="code" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a>(task, 1, recvcount, sendcount);
                    }

                  <a class="code" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9">domain_findExchangeNumbers</a>(task, partner, 0, &amp;sendcount, &amp;recvcount);

                  <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[task] += recvcount - sendcount;
                  <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[partner] -= recvcount - sendcount;

                  <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[task * NTask + partner] -= sendcount;
                  <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[partner * NTask + task] -= recvcount;

                  <span class="keywordflow">if</span>(task == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)  <span class="comment">/* actually carry out the exchange */</span>
                    <a class="code" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a>(partner, 0, sendcount, recvcount);
                  <span class="keywordflow">if</span>(partner == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                    <a class="code" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a>(task, 0, recvcount, sendcount);
                }
            }
        }

      <span class="keywordflow">for</span>(i = 0, sumtogo = 0; i &lt; NTask * NTask; i++)
        sumtogo += <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[i];
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a647e0c1a76b7f064ed5d201662f364bf_cgraph.png" border="0" usemap="#domain_8c_a647e0c1a76b7f064ed5d201662f364bf_cgraph" alt=""/></div>
<map name="domain_8c_a647e0c1a76b7f064ed5d201662f364bf_cgraph" id="domain_8c_a647e0c1a76b7f064ed5d201662f364bf_cgraph">
<area shape="rect" id="node3" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c" title="domain_countToGo" alt="" coords="244,160,388,189"/><area shape="rect" id="node5" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="220,213,412,243"/><area shape="rect" id="node14" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="704,267,771,296"/><area shape="rect" id="node24" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca" title="domain_exchangeParticles" alt="" coords="220,371,412,400"/><area shape="rect" id="node27" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9" title="domain_findExchangeNumbers" alt="" coords="205,424,427,453"/><area shape="rect" id="node31" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e" title="domain_findExtent" alt="" coords="245,477,387,507"/><area shape="rect" id="node33" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="252,555,380,584"/><area shape="rect" id="node38" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba" title="domain_shiftSplit" alt="" coords="251,608,381,637"/><area shape="rect" id="node41" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e" title="domain_sumCost" alt="" coords="249,661,383,691"/><area shape="rect" id="node7" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37" title="domain_compare_key" alt="" coords="484,5,647,35"/><area shape="rect" id="node9" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700" title="domain_compare_toplist" alt="" coords="476,59,655,88"/><area shape="rect" id="node11" href="domain_8c.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="504,136,627,165"/><area shape="rect" id="node18" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="485,213,645,243"/><area shape="rect" id="node22" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="496,267,635,296"/><area shape="rect" id="node16" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="819,267,976,296"/><area shape="rect" id="node29" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644" title="imin" alt="" coords="541,424,589,453"/><area shape="rect" id="node35" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="536,581,595,611"/><area shape="rect" id="node43" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4" title="domain_walktoptree" alt="" coords="491,661,640,691"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a647e0c1a76b7f064ed5d201662f364bf_icgraph.png" border="0" usemap="#domain_8c_a647e0c1a76b7f064ed5d201662f364bf_icgraph" alt=""/></div>
<map name="domain_8c_a647e0c1a76b7f064ed5d201662f364bf_icgraph" id="domain_8c_a647e0c1a76b7f064ed5d201662f364bf_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="205,57,379,87"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="427,5,645,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="705,56,748,85"/><area shape="rect" id="node11" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="516,109,556,139"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="809,83,863,112"/><area shape="rect" id="node13" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="693,109,760,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae8e3aa408eaab9544cb7f93e69185492"></a><!-- doxytag: member="domain.c::domain_Decomposition" ref="ae8e3aa408eaab9544cb7f93e69185492" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_Decomposition </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This is the main routine for the domain decomposition. It acts as a driver routine that allocates various temporary buffers, maps the particles back onto the periodic box if needed, and then does the domain decomposition, and a final Peano-Hilbert order of all particles as a tuning measure. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00062">62</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00410">global_data_all_processes::CPU_Domain</a>, <a class="el" href="allvars_8h_source.html#l00423">global_data_all_processes::CPU_Peano</a>, <a class="el" href="predict_8c_source.html#l00103">do_box_wrapping()</a>, <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8c_source.html#l00071">KeySorted</a>, <a class="el" href="domain_8c_source.html#l00041">list_load</a>, <a class="el" href="domain_8c_source.html#l00042">list_loadsph</a>, <a class="el" href="domain_8c_source.html#l00040">list_N_gas</a>, <a class="el" href="domain_8c_source.html#l00039">list_NumPart</a>, <a class="el" href="domain_8c_source.html#l00043">list_work</a>, <a class="el" href="domain_8c_source.html#l00038">local_toGo</a>, <a class="el" href="domain_8c_source.html#l00038">local_toGoSph</a>, <a class="el" href="domain_8c_source.html#l00045">maxload</a>, <a class="el" href="domain_8c_source.html#l00045">maxloadsph</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00276">global_data_all_processes::MaxPartSph</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="peano_8c_source.html#l00034">peano_hilbert_order()</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="domain_8c_source.html#l00037">toGo</a>, <a class="el" href="domain_8c_source.html#l00037">toGoSph</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, and <a class="el" href="allvars_8c_source.html#l00038">TreeReconstructFlag</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>, <a class="el" href="init_8c_source.html#l00020">init()</a>, and <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> t0, t1;

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;
      <span class="comment">/* to make sure that we do a domain decomposition before the PM-force is evaluated.</span>
<span class="comment">         this is needed to make sure that the particles are wrapped into the box */</span>
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">/* Check whether it is really time for a new domain decomposition */</span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>)
    {
      t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      <a class="code" href="predict_8c.html#adda9e167a16a53d1aa40180406950446">do_box_wrapping</a>();        <span class="comment">/* map the particles back onto the box */</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 0;
      <a class="code" href="allvars_8c.html#aa32d7269f9baf3ffdbdd509982fca128">TreeReconstructFlag</a> = 1;  <span class="comment">/* ensures that new tree will be constructed */</span>

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;domain decomposition... \n&quot;</span>);
          fflush(stdout);
        }

      <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a> = malloc(<span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>);
      <a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a> = malloc(<span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>);

      <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);

      MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>, 1, MPI_INT, <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>, 1, MPI_INT, MPI_COMM_WORLD);
      MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>, 1, MPI_INT, <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>, 1, MPI_INT, MPI_COMM_WORLD);

      <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> * REDUC_FAC;
      <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> * REDUC_FAC;

      <a class="code" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf">domain_decompose</a>();

      free(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>);
      free(<a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>);
      free(<a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>);
      free(<a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>);
      free(<a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>);
      free(<a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a>);
      free(<a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a>);
      free(<a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>);
      free(<a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>);


      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;domain decomposition done. \n&quot;</span>);
          fflush(stdout);
        }

      t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a786736d9e91341733e286f6e03ab26a5">CPU_Domain</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);

<span class="preprocessor">#ifdef PEANOHILBERT</span>
<span class="preprocessor"></span>      t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="peano_8c.html#af3e45a4293584b3fe28e83af75c6ed71">peano_hilbert_order</a>();
      t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3d1492ec738b3ebf2025de1d2f398b7d">CPU_Peano</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      free(<a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a>);
      free(<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>);
    }

}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_ae8e3aa408eaab9544cb7f93e69185492_cgraph.png" border="0" usemap="#domain_8c_ae8e3aa408eaab9544cb7f93e69185492_cgraph" alt=""/></div>
<map name="domain_8c_ae8e3aa408eaab9544cb7f93e69185492_cgraph" id="domain_8c_ae8e3aa408eaab9544cb7f93e69185492_cgraph">
<area shape="rect" id="node3" href="predict_8c.html#adda9e167a16a53d1aa40180406950446" title="do_box_wrapping" alt="" coords="237,421,368,451"/><area shape="rect" id="node5" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="227,475,379,504"/><area shape="rect" id="node50" href="peano_8c.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="228,725,377,755"/><area shape="rect" id="node58" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="269,779,336,808"/><area shape="rect" id="node60" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="268,859,337,888"/><area shape="rect" id="node7" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c" title="domain_countToGo" alt="" coords="465,160,609,189"/><area shape="rect" id="node9" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="441,213,633,243"/><area shape="rect" id="node18" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="939,267,1005,296"/><area shape="rect" id="node28" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca" title="domain_exchangeParticles" alt="" coords="697,371,889,400"/><area shape="rect" id="node31" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9" title="domain_findExchangeNumbers" alt="" coords="427,421,648,451"/><area shape="rect" id="node35" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e" title="domain_findExtent" alt="" coords="467,475,608,504"/><area shape="rect" id="node37" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="473,552,601,581"/><area shape="rect" id="node42" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba" title="domain_shiftSplit" alt="" coords="472,605,603,635"/><area shape="rect" id="node45" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e" title="domain_sumCost" alt="" coords="471,659,604,688"/><area shape="rect" id="node11" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37" title="domain_compare_key" alt="" coords="712,5,875,35"/><area shape="rect" id="node13" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700" title="domain_compare_toplist" alt="" coords="704,59,883,88"/><area shape="rect" id="node15" href="domain_8c.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="732,136,855,165"/><area shape="rect" id="node22" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="713,213,873,243"/><area shape="rect" id="node26" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="724,267,863,296"/><area shape="rect" id="node20" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1053,267,1211,296"/><area shape="rect" id="node33" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644" title="imin" alt="" coords="769,424,817,453"/><area shape="rect" id="node39" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="764,579,823,608"/><area shape="rect" id="node47" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4" title="domain_walktoptree" alt="" coords="719,659,868,688"/><area shape="rect" id="node52" href="peano_8c.html#af3ffb253e14a79419d1effeee1b7261d" title="compare_key" alt="" coords="484,712,591,741"/><area shape="rect" id="node54" href="peano_8c.html#af744cef873e3093ba2924da8265d1711" title="reorder_gas" alt="" coords="488,765,587,795"/><area shape="rect" id="node56" href="peano_8c.html#afcb358154dd7fd5de8b4156f417fb0ba" title="reorder_particles" alt="" coords="472,819,603,848"/><area shape="rect" id="node62" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="515,872,560,901"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_ae8e3aa408eaab9544cb7f93e69185492_icgraph.png" border="0" usemap="#domain_8c_ae8e3aa408eaab9544cb7f93e69185492_icgraph" alt=""/></div>
<map name="domain_8c_ae8e3aa408eaab9544cb7f93e69185492_icgraph" id="domain_8c_ae8e3aa408eaab9544cb7f93e69185492_icgraph">
<area shape="rect" id="node3" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="227,5,445,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="505,56,548,85"/><area shape="rect" id="node9" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="316,109,356,139"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="609,83,663,112"/><area shape="rect" id="node11" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="493,109,560,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a25b4f5eb395f918bad4b4bc1fc3dc729"></a><!-- doxytag: member="domain.c::domain_determineTopTree" ref="a25b4f5eb395f918bad4b4bc1fc3dc729" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_determineTopTree </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function constructs the global top-level tree node that is used for the domain decomposition. This is done by considering the string of Peano-Hilbert keys for all particles, which is recursively chopped off in pieces of eight segments until each segment holds at most a certain number of particles. </p>

<p><p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 int, the allowed maximum is 10. If 64-bit integers are used, the maximum is 21</p>
<p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 0 , the allowed maximum is 10. If 64-bit integers are used, the maximum is 21</p>
<p>&lt; The number of different Peano-Hilbert cells</p>
<p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 0 , the allowed maximum is 10. If 64-bit integers are used, the maximum is 21</p>
<p>&lt; The number of different Peano-Hilbert cells </p>
</p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00896">896</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00050">BITS_PER_DIMENSION</a>, <a class="el" href="allvars_8h_source.html#l00224">topnode_data::Blocks</a>, <a class="el" href="domain_8c_source.html#l00050">topnode_exchange::Count</a>, <a class="el" href="allvars_8h_source.html#l00228">topnode_data::Count</a>, <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="domain_8c_source.html#l01119">domain_compare_key()</a>, <a class="el" href="domain_8c_source.html#l01106">domain_compare_toplist()</a>, <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>, <a class="el" href="domain_8c_source.html#l00982">domain_topsplit_local()</a>, <a class="el" href="allvars_8c_source.html#l00048">DomainCorner</a>, <a class="el" href="allvars_8c_source.html#l00051">DomainFac</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8c_source.html#l00071">KeySorted</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00074">NTopnodes</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="peano_8c_source.html#l00263">peano_hilbert_key()</a>, <a class="el" href="allvars_8h_source.html#l00223">topnode_data::Pstart</a>, <a class="el" href="allvars_8h_source.html#l00226">topnode_data::Size</a>, <a class="el" href="domain_8c_source.html#l00049">topnode_exchange::Startkey</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>, <a class="el" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>, <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>, and <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, ntop_local, ntop;
  <span class="keywordtype">int</span> *ntopnodelist, *ntopoffset;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a>[i] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[i] = <a class="code" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df">peano_hilbert_key</a>((<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[0]) * <a class="code" href="allvars_8c.html#a4488078cfcc203156f193c43a1d3a2ef">DomainFac</a>,
                                                (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[1] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[1]) * DomainFac,
                                                (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[2] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[2]) * DomainFac,
                                                <a class="code" href="allvars_8h.html#a84bc981fa6ccfbb15526a6e9da12087a">BITS_PER_DIMENSION</a>);
    }

  qsort(<a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a>, NumPart, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>), <a class="code" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37">domain_compare_key</a>);

  <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> = 1;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = -1;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> = PEANOCELLS;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a> = 0;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> = NumPart;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = 0;

  <a class="code" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421">domain_topsplit_local</a>(0, 0);

  <a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a> = malloc(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a>));

  <span class="keywordflow">for</span>(i = 0, ntop_local = 0; i &lt; <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[i].Daughter == -1)    <span class="comment">/* only use leaves */</span>
        {
          <a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>[ntop_local].<a class="code" href="structtopnode__exchange.html#a1320a6ec4ba632909af0c092bd7735b4">Startkey</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[i].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>;
          <a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>[ntop_local].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[i].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a>;
          ntop_local++;
        }
    }

  ntopnodelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  ntopoffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);

  MPI_Allgather(&amp;ntop_local, 1, MPI_INT, ntopnodelist, 1, MPI_INT, MPI_COMM_WORLD);

  <span class="keywordflow">for</span>(i = 0, ntop = 0, ntopoffset[0] = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
    {
      ntop += ntopnodelist[i];
      <span class="keywordflow">if</span>(i &gt; 0)
        ntopoffset[i] = ntopoffset[i - 1] + ntopnodelist[i - 1];
    }


  <a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a> = malloc(ntop * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a>));

  <span class="keywordflow">for</span>(i = 0; i &lt; NTask; i++)
    {
      ntopnodelist[i] *= <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structtopnode__exchange.html">topnode_exchange</a>);
      ntopoffset[i] *= <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structtopnode__exchange.html">topnode_exchange</a>);
    }

  MPI_Allgatherv(<a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>, ntop_local * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a>), MPI_BYTE,
                 <a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>, ntopnodelist, ntopoffset, MPI_BYTE, MPI_COMM_WORLD);

  qsort(<a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>, ntop, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a>), <a class="code" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700">domain_compare_toplist</a>);

  NTopnodes = 1;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = -1;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> = PEANOCELLS;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a> = 0;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a>;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = 0;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#abad41cd99537e7a3a0d78ac5f291e42d">Blocks</a> = ntop;

  <a class="code" href="domain_8c.html#a606de536756a67ad8f79f1135009195e">domain_topsplit</a>(0, 0);

  free(<a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>);
  free(ntopoffset);
  free(ntopnodelist);
  free(<a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>);

}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a25b4f5eb395f918bad4b4bc1fc3dc729_cgraph.png" border="0" usemap="#domain_8c_a25b4f5eb395f918bad4b4bc1fc3dc729_cgraph" alt=""/></div>
<map name="domain_8c_a25b4f5eb395f918bad4b4bc1fc3dc729_cgraph" id="domain_8c_a25b4f5eb395f918bad4b4bc1fc3dc729_cgraph">
<area shape="rect" id="node3" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37" title="domain_compare_key" alt="" coords="255,5,417,35"/><area shape="rect" id="node5" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700" title="domain_compare_toplist" alt="" coords="247,59,425,88"/><area shape="rect" id="node7" href="domain_8c.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="275,136,397,165"/><area shape="rect" id="node14" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="256,213,416,243"/><area shape="rect" id="node18" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="267,267,405,296"/><area shape="rect" id="node10" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="475,175,541,204"/><area shape="rect" id="node12" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="589,175,747,204"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a25b4f5eb395f918bad4b4bc1fc3dc729_icgraph.png" border="0" usemap="#domain_8c_a25b4f5eb395f918bad4b4bc1fc3dc729_icgraph" alt=""/></div>
<map name="domain_8c_a25b4f5eb395f918bad4b4bc1fc3dc729_icgraph" id="domain_8c_a25b4f5eb395f918bad4b4bc1fc3dc729_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="245,57,397,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="445,57,619,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="667,5,885,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="945,56,988,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="756,109,796,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1049,83,1103,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="933,109,1000,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab7d41435f73c1626208d63b2d5ba28ca"></a><!-- doxytag: member="domain.c::domain_exchangeParticles" ref="ab7d41435f73c1626208d63b2d5ba28ca" args="(int partner, int sphflag, int send_count, int recv_count)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_exchangeParticles </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>partner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sphflag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>send_count</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>recv_count</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function exchanges particles between two CPUs according to the domain split. In doing this, the memory boundaries which may restrict the exhange process are observed. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00595">595</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="allvars_8c_source.html#l00068">DomainKeyBuf</a>, <a class="el" href="allvars_8c_source.html#l00120">DomainPartBuf</a>, <a class="el" href="allvars_8c_source.html#l00128">DomainSphBuf</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="tags_8h_source.html#l00009">TAG_KEY</a>, <a class="el" href="tags_8h_source.html#l00007">TAG_PDATA</a>, <a class="el" href="tags_8h_source.html#l00008">TAG_SPHDATA</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no, n, count, rep;
  MPI_Status status;

  <span class="keywordflow">for</span>(n = 0, count = 0; count &lt; send_count &amp;&amp; n &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; n++)
    {
      <span class="keywordflow">if</span>(sphflag)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type != 0)
            <span class="keywordflow">continue</span>;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type == 0)
            <span class="keywordflow">continue</span>;
        }

      no = 0;

      <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter &gt;= 0)
        no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + (<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] - <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Size / 8);

      no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a>;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no] == partner)
        {
          <span class="keywordflow">if</span>(sphflag)           <span class="comment">/* special reorder routine for SPH particles (need to stay at beginning) */</span>
            {
              <a class="code" href="allvars_8c.html#a386309bed4018948d42bc72ae4b5e1bb">DomainPartBuf</a>[count] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n];      <span class="comment">/* copy particle and collect in contiguous memory */</span>
              <a class="code" href="allvars_8c.html#a6918a0815266193ad242888c455c5886">DomainKeyBuf</a>[count] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n];
              <a class="code" href="allvars_8c.html#a6034b1d1d1f6fb31d07d2077914aa1fc">DomainSphBuf</a>[count] = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[n];

              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1];
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[NumPart - 1];

              <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1];
              <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[NumPart - 1];

              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[n] = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1];

              <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>--;
            }
          <span class="keywordflow">else</span>
            {
              <a class="code" href="allvars_8c.html#a386309bed4018948d42bc72ae4b5e1bb">DomainPartBuf</a>[count] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n];      <span class="comment">/* copy particle and collect in contiguous memory */</span>
              <a class="code" href="allvars_8c.html#a6918a0815266193ad242888c455c5886">DomainKeyBuf</a>[count] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n];
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[NumPart - 1];
              <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[NumPart - 1];
            }

          count++;
          NumPart--;
          n--;
        }
    }

  <span class="keywordflow">if</span>(count != send_count)
    {
      printf(<span class="stringliteral">&quot;Houston, we got a problem...\n&quot;</span>);
      printf(<span class="stringliteral">&quot;ThisTask=%d count=%d send_count=%d\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, count, send_count);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(88);
    }

  <span class="comment">/* transmit */</span>

  <span class="keywordflow">for</span>(rep = 0; rep &lt; 2; rep++)
    {
      <span class="keywordflow">if</span>((rep == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &lt; partner) || (rep == 1 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &gt; partner))
        {
          <span class="keywordflow">if</span>(send_count &gt; 0)
            {
              MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a386309bed4018948d42bc72ae4b5e1bb">DomainPartBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner,
                        <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>, MPI_COMM_WORLD);

              MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a6918a0815266193ad242888c455c5886">DomainKeyBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a9808b602dc1ad05f05054f288e80099e">TAG_KEY</a>,
                        MPI_COMM_WORLD);

              <span class="keywordflow">if</span>(sphflag)
                MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a6034b1d1d1f6fb31d07d2077914aa1fc">DomainSphBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>), MPI_BYTE, partner,
                          <a class="code" href="tags_8h.html#a01c73f5108d850ffa33220b744576da7">TAG_SPHDATA</a>, MPI_COMM_WORLD);
            }
        }

      <span class="keywordflow">if</span>((rep == 1 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &lt; partner) || (rep == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &gt; partner))
        {
          <span class="keywordflow">if</span>(recv_count &gt; 0)
            {
              <span class="keywordflow">if</span>(sphflag)
                {
                  <span class="keywordflow">if</span>((NumPart - <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>) &gt; recv_count)
                    {
                      <span class="keywordflow">for</span>(i = 0; i &lt; recv_count; i++)
                        {
                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[NumPart + i] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> + i];
                          <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[NumPart + i] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> + i];
                        }
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">for</span>(i = NumPart - 1; i &gt;= <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i--)
                        {
                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i + recv_count] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i];
                          <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[i + recv_count] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[i];
                        }
                    }

                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>,
                           MPI_COMM_WORLD, &amp;status);
                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[N_gas], recv_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a9808b602dc1ad05f05054f288e80099e">TAG_KEY</a>,
                           MPI_COMM_WORLD, &amp;status);
                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[N_gas], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>), MPI_BYTE, partner,
                           <a class="code" href="tags_8h.html#a01c73f5108d850ffa33220b744576da7">TAG_SPHDATA</a>, MPI_COMM_WORLD, &amp;status);

                  N_gas += recv_count;
                }
              <span class="keywordflow">else</span>
                {
                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[NumPart], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner,
                           <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>, MPI_COMM_WORLD, &amp;status);
                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[NumPart], recv_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>), MPI_BYTE, partner,
                           <a class="code" href="tags_8h.html#a9808b602dc1ad05f05054f288e80099e">TAG_KEY</a>, MPI_COMM_WORLD, &amp;status);
                }

              NumPart += recv_count;
            }
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_ab7d41435f73c1626208d63b2d5ba28ca_cgraph.png" border="0" usemap="#domain_8c_ab7d41435f73c1626208d63b2d5ba28ca_cgraph" alt=""/></div>
<map name="domain_8c_ab7d41435f73c1626208d63b2d5ba28ca_cgraph" id="domain_8c_ab7d41435f73c1626208d63b2d5ba28ca_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="248,5,315,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="363,5,520,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_ab7d41435f73c1626208d63b2d5ba28ca_icgraph.png" border="0" usemap="#domain_8c_ab7d41435f73c1626208d63b2d5ba28ca_icgraph" alt=""/></div>
<map name="domain_8c_ab7d41435f73c1626208d63b2d5ba28ca_icgraph" id="domain_8c_ab7d41435f73c1626208d63b2d5ba28ca_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="248,57,400,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="448,57,621,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="669,5,888,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="948,56,991,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="759,109,799,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1052,83,1105,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="936,109,1003,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0e758ec7eef32fc7180092547f5a11b9"></a><!-- doxytag: member="domain.c::domain_findExchangeNumbers" ref="a0e758ec7eef32fc7180092547f5a11b9" args="(int task, int partner, int sphflag, int *send, int *recv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_findExchangeNumbers </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>partner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sphflag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>send</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>recv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function counts how many particles have to be exchanged between two CPUs according to the domain split. If the CPUs are already quite full and hold data from other CPUs as well, not all the particles may be exchanged at once. In this case the communication phase has to be repeated, until enough of the third-party particles have been moved away such that the decomposition can be completed. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00534">534</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00292">global_data_all_processes::BunchSizeDomain</a>, <a class="el" href="system_8c_source.html#l00121">imin()</a>, <a class="el" href="domain_8c_source.html#l00040">list_N_gas</a>, <a class="el" href="domain_8c_source.html#l00039">list_NumPart</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00276">global_data_all_processes::MaxPartSph</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="domain_8c_source.html#l00037">toGo</a>, and <a class="el" href="domain_8c_source.html#l00037">toGoSph</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> numpartA, numpartsphA, ntobesentA, maxsendA, maxsendA_old;
  <span class="keywordtype">int</span> numpartB, numpartsphB, ntobesentB, maxsendB, maxsendB_old;

  numpartA = <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[task];
  numpartsphA = <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>[task];

  numpartB = <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[partner];
  numpartsphB = <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>[partner];

  <span class="keywordflow">if</span>(sphflag == 1)
    {
      ntobesentA = <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[task * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + partner];
      ntobesentB = <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[partner * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + task];
    }
  <span class="keywordflow">else</span>
    {
      ntobesentA = <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[task * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + partner] - <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[task * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + partner];
      ntobesentB = <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[partner * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + task] - toGoSph[partner * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + task];
    }

  maxsendA = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(ntobesentA, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a>);
  maxsendB = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(ntobesentB, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a>);

  <span class="keywordflow">do</span>
    {
      maxsendA_old = maxsendA;
      maxsendB_old = maxsendB;

      maxsendA = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - numpartB + maxsendB, maxsendA);
      maxsendB = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - numpartA + maxsendA, maxsendB);
    }
  <span class="keywordflow">while</span>((maxsendA != maxsendA_old) || (maxsendB != maxsendB_old));


  <span class="comment">/* now make also sure that there is enough space for SPH particeles */</span>
  <span class="keywordflow">if</span>(sphflag == 1)
    {
      <span class="keywordflow">do</span>
        {
          maxsendA_old = maxsendA;
          maxsendB_old = maxsendB;

          maxsendA = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> - numpartsphB + maxsendB, maxsendA);
          maxsendB = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> - numpartsphA + maxsendA, maxsendB);
        }
      <span class="keywordflow">while</span>((maxsendA != maxsendA_old) || (maxsendB != maxsendB_old));
    }

  *send = maxsendA;
  *recv = maxsendB;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a0e758ec7eef32fc7180092547f5a11b9_cgraph.png" border="0" usemap="#domain_8c_a0e758ec7eef32fc7180092547f5a11b9_cgraph" alt=""/></div>
<map name="domain_8c_a0e758ec7eef32fc7180092547f5a11b9_cgraph" id="domain_8c_a0e758ec7eef32fc7180092547f5a11b9_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644" title="imin" alt="" coords="276,5,324,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a0e758ec7eef32fc7180092547f5a11b9_icgraph.png" border="0" usemap="#domain_8c_a0e758ec7eef32fc7180092547f5a11b9_icgraph" alt=""/></div>
<map name="domain_8c_a0e758ec7eef32fc7180092547f5a11b9_icgraph" id="domain_8c_a0e758ec7eef32fc7180092547f5a11b9_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="275,57,427,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="475,57,648,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="696,5,915,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="975,56,1017,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="785,109,825,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1079,83,1132,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="963,109,1029,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="add5620cbc133c73f0ce7da3a8fe9c01e"></a><!-- doxytag: member="domain.c::domain_findExtent" ref="add5620cbc133c73f0ce7da3a8fe9c01e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_findExtent </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine finds the extent of the global domain grid. </p>

<p><p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 int, the allowed maximum is 10. If 64-bit integers are used, the maximum is 21 </p>
</p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00845">845</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00049">DomainCenter</a>, <a class="el" href="allvars_8c_source.html#l00048">DomainCorner</a>, <a class="el" href="allvars_8c_source.html#l00051">DomainFac</a>, <a class="el" href="allvars_8c_source.html#l00050">DomainLen</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j;
  <span class="keywordtype">double</span> len, xmin[3], xmax[3], xmin_glob[3], xmax_glob[3];

  <span class="comment">/* determine local extension */</span>
  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    {
      xmin[j] = MAX_REAL_NUMBER;
      xmax[j] = -MAX_REAL_NUMBER;
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          <span class="keywordflow">if</span>(xmin[j] &gt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[j])
            xmin[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];

          <span class="keywordflow">if</span>(xmax[j] &lt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[j])
            xmax[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
        }
    }

  MPI_Allreduce(xmin, xmin_glob, 3, MPI_DOUBLE, MPI_MIN, MPI_COMM_WORLD);
  MPI_Allreduce(xmax, xmax_glob, 3, MPI_DOUBLE, MPI_MAX, MPI_COMM_WORLD);

  len = 0;
  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    <span class="keywordflow">if</span>(xmax_glob[j] - xmin_glob[j] &gt; len)
      len = xmax_glob[j] - xmin_glob[j];

  len *= 1.001;

  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    {
      <a class="code" href="allvars_8c.html#ad13aabcbb50307c005ffa0b2edccdaeb">DomainCenter</a>[j] = 0.5 * (xmin_glob[j] + xmax_glob[j]);
      <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[j] = 0.5 * (xmin_glob[j] + xmax_glob[j]) - 0.5 * len;
    }

  <a class="code" href="allvars_8c.html#a3dd9593672bf68f0c36fa3e5451e9265">DomainLen</a> = len;
  <a class="code" href="allvars_8c.html#a4488078cfcc203156f193c43a1d3a2ef">DomainFac</a> = 1.0 / len * (((peanokey) 1) &lt;&lt; (BITS_PER_DIMENSION));
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_add5620cbc133c73f0ce7da3a8fe9c01e_icgraph.png" border="0" usemap="#domain_8c_add5620cbc133c73f0ce7da3a8fe9c01e_icgraph" alt=""/></div>
<map name="domain_8c_add5620cbc133c73f0ce7da3a8fe9c01e_icgraph" id="domain_8c_add5620cbc133c73f0ce7da3a8fe9c01e_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="195,57,347,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="395,57,568,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="616,5,835,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="895,56,937,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="705,109,745,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="999,83,1052,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="883,109,949,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a412d5d8810751249cc8dcd9e219e4e57"></a><!-- doxytag: member="domain.c::domain_findSplit" ref="a412d5d8810751249cc8dcd9e219e4e57" args="(int cpustart, int ncpu, int first, int last)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int domain_findSplit </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cpustart</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ncpu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>first</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>last</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function tries to find a split point in a range of cells in the domain-grid. The range of cells starts at 'first', and ends at 'last' (inclusively). The number of cpus that holds the range is 'ncpu', with the first cpu given by 'cpustart'. If more than 2 cpus are to be split, the function calls itself recursively. The division tries to achieve a best particle-load balance under the constraint that 'maxload' and 'maxloadsph' may not be exceeded, and that each cpu holds at least one cell from the domaingrid. If such a decomposition cannot be achieved, a non-zero error code is returned.</p>
<p>After successful completion, DomainMyStart[] and DomainMyLast[] contain the first and last cell of the domaingrid assigned to the local task for the given type. Also, DomainTask[] contains for each cell the task it was assigned to. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00327">327</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, <a class="el" href="allvars_8c_source.html#l00057">DomainCount</a>, <a class="el" href="allvars_8c_source.html#l00058">DomainCountSph</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="domain_8c_source.html#l00041">list_load</a>, <a class="el" href="domain_8c_source.html#l00042">list_loadsph</a>, <a class="el" href="domain_8c_source.html#l00045">maxload</a>, and <a class="el" href="domain_8c_source.html#l00045">maxloadsph</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, and <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, split, ok_left, ok_right;
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> load, sphload, load_leftOfSplit, sphload_leftOfSplit;
  <span class="keywordtype">int</span> ncpu_leftOfSplit;
  <span class="keywordtype">double</span> maxAvgLoad_CurrentSplit, maxAvgLoad_NewSplit;


  ncpu_leftOfSplit = ncpu / 2;

  <span class="keywordflow">for</span>(i = first, load = 0, sphload = 0; i &lt;= <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>; i++)
    {
      load += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[i];
      sphload += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[i];
    }

  split = first + ncpu_leftOfSplit;

  <span class="keywordflow">for</span>(i = first, load_leftOfSplit = sphload_leftOfSplit = 0; i &lt; split; i++)
    {
      load_leftOfSplit += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[i];
      sphload_leftOfSplit += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[i];
    }

  <span class="comment">/* find the best split point in terms of work-load balance */</span>

  <span class="keywordflow">while</span>(split &lt; <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> - (ncpu - ncpu_leftOfSplit - 1) &amp;&amp; split &gt; 0)
    {
      maxAvgLoad_CurrentSplit =
        <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(load_leftOfSplit / ncpu_leftOfSplit, (load - load_leftOfSplit) / (ncpu - ncpu_leftOfSplit));

      maxAvgLoad_NewSplit =
        <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>((load_leftOfSplit + <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[split]) / ncpu_leftOfSplit,
             (load - load_leftOfSplit - <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[split]) / (ncpu - ncpu_leftOfSplit));

      <span class="keywordflow">if</span>(maxAvgLoad_NewSplit &lt;= maxAvgLoad_CurrentSplit)
        {
          load_leftOfSplit += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[split];
          sphload_leftOfSplit += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[split];
          split++;
        }
      <span class="keywordflow">else</span>
        <span class="keywordflow">break</span>;
    }


  <span class="comment">/* we will now have to check whether this solution is possible given the restrictions on the maximum load */</span>

  <span class="keywordflow">for</span>(i = first, load_leftOfSplit = 0, sphload_leftOfSplit = 0; i &lt; split; i++)
    {
      load_leftOfSplit += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[i];
      sphload_leftOfSplit += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[i];
    }

  <span class="keywordflow">if</span>(load_leftOfSplit &gt; <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a> * ncpu_leftOfSplit ||
     (load - load_leftOfSplit) &gt; <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a> * (ncpu - ncpu_leftOfSplit))
    {
      <span class="comment">/* we did not find a viable split */</span>
      <span class="keywordflow">return</span> -1;
    }

  <span class="keywordflow">if</span>(sphload_leftOfSplit &gt; <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a> * ncpu_leftOfSplit ||
     (sphload - sphload_leftOfSplit) &gt; <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a> * (ncpu - ncpu_leftOfSplit))
    {
      <span class="comment">/* we did not find a viable split */</span>
      <span class="keywordflow">return</span> -1;
    }

  <span class="keywordflow">if</span>(ncpu_leftOfSplit &gt;= 2)
    ok_left = <a class="code" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit</a>(cpustart, ncpu_leftOfSplit, first, split - 1);
  <span class="keywordflow">else</span>
    ok_left = 0;

  <span class="keywordflow">if</span>((ncpu - ncpu_leftOfSplit) &gt;= 2)
    ok_right = <a class="code" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit</a>(cpustart + ncpu_leftOfSplit, ncpu - ncpu_leftOfSplit, split, <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>);
  <span class="keywordflow">else</span>
    ok_right = 0;

  <span class="keywordflow">if</span>(ok_left == 0 &amp;&amp; ok_right == 0)
    {
      <span class="comment">/* found a viable split */</span>

      <span class="keywordflow">if</span>(ncpu_leftOfSplit == 1)
        {
          <span class="keywordflow">for</span>(i = first; i &lt; split; i++)
            <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[i] = cpustart;

          <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[cpustart] = load_leftOfSplit;
          <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[cpustart] = sphload_leftOfSplit;
          <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[cpustart] = first;
          <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[cpustart] = split - 1;
        }

      <span class="keywordflow">if</span>((ncpu - ncpu_leftOfSplit) == 1)
        {
          <span class="keywordflow">for</span>(i = split; i &lt;= <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>; i++)
            <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[i] = cpustart + ncpu_leftOfSplit;

          <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[cpustart + ncpu_leftOfSplit] = load - load_leftOfSplit;
          <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[cpustart + ncpu_leftOfSplit] = sphload - sphload_leftOfSplit;
          <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[cpustart + ncpu_leftOfSplit] = split;
          <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[cpustart + ncpu_leftOfSplit] = <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>;
        }

      <span class="keywordflow">return</span> 0;
    }

  <span class="comment">/* we did not find a viable split */</span>
  <span class="keywordflow">return</span> -1;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a412d5d8810751249cc8dcd9e219e4e57_cgraph.png" border="0" usemap="#domain_8c_a412d5d8810751249cc8dcd9e219e4e57_cgraph" alt=""/></div>
<map name="domain_8c_a412d5d8810751249cc8dcd9e219e4e57_cgraph" id="domain_8c_a412d5d8810751249cc8dcd9e219e4e57_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="181,29,240,59"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a412d5d8810751249cc8dcd9e219e4e57_icgraph.png" border="0" usemap="#domain_8c_a412d5d8810751249cc8dcd9e219e4e57_icgraph" alt=""/></div>
<map name="domain_8c_a412d5d8810751249cc8dcd9e219e4e57_icgraph" id="domain_8c_a412d5d8810751249cc8dcd9e219e4e57_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="357,57,509,87"/><area shape="rect" id="node19" href="proto_8h.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="181,95,309,124"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="557,57,731,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="779,5,997,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1057,56,1100,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="868,109,908,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1161,83,1215,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1045,109,1112,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a89c54187117b91d4270a4f0c406ce2ba"></a><!-- doxytag: member="domain.c::domain_shiftSplit" ref="a89c54187117b91d4270a4f0c406ce2ba" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_shiftSplit </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function tries to improve the domain decomposition found by <a class="el" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit()</a> with respect to work-load balance. To this end, the boundaries in the existing domain-split solution (which was found by trying to balance the particle load) are shifted as long as this leads to better work-load while still remaining within the allowed memory-imbalance constraints. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00447">447</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="allvars_8c_source.html#l00057">DomainCount</a>, <a class="el" href="allvars_8c_source.html#l00058">DomainCountSph</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="allvars_8c_source.html#l00056">DomainWork</a>, <a class="el" href="domain_8c_source.html#l00041">list_load</a>, <a class="el" href="domain_8c_source.html#l00042">list_loadsph</a>, <a class="el" href="domain_8c_source.html#l00043">list_work</a>, <a class="el" href="domain_8c_source.html#l00045">maxload</a>, <a class="el" href="domain_8c_source.html#l00045">maxloadsph</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, and <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, task, iter = 0, moved;
  <span class="keywordtype">double</span> maxw, newmaxw;

  <span class="keywordflow">for</span>(task = 0; task &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; task++)
    <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] = 0;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[i]] += <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[i];

  <span class="keywordflow">do</span>
    {
      <span class="keywordflow">for</span>(task = 0, moved = 0; task &lt; NTask - 1; task++)
        {
          maxw = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task], <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1]);

          <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] &lt; <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1])
            {
              newmaxw = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] + <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]],
                             <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1] - <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]]);
              <span class="keywordflow">if</span>(newmaxw &lt;= maxw)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task] + <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]] &lt;= <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a>)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task] + <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]] &gt; <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a>)
                        <span class="keywordflow">continue</span>;

                      <span class="comment">/* ok, we can move one domain cell from right to left */</span>
                      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] += <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]];
                      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task] += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[DomainStartList[task + 1]];
                      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task] += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[DomainStartList[task + 1]];
                      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1] -= <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[DomainStartList[task + 1]];
                      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task + 1] -= <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[DomainStartList[task + 1]];
                      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task + 1] -= <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[DomainStartList[task + 1]];

                      <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[DomainStartList[task + 1]] = task;
                      DomainStartList[task + 1] += 1;
                      <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task] += 1;

                      moved++;
                    }
                }
            }
          <span class="keywordflow">else</span>
            {
              newmaxw = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] - <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]],
                             <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1] + <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]]);
              <span class="keywordflow">if</span>(newmaxw &lt;= maxw)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task + 1] + <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]] &lt;= <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a>)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task + 1] + <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]] &gt; <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a>)
                        <span class="keywordflow">continue</span>;

                      <span class="comment">/* ok, we can move one domain cell from left to right */</span>
                      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] -= <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]];
                      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task] -= <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[DomainEndList[task]];
                      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task] -= <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[DomainEndList[task]];
                      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1] += <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[DomainEndList[task]];
                      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task + 1] += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[DomainEndList[task]];
                      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task + 1] += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[DomainEndList[task]];

                      <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[DomainEndList[task]] = task + 1;
                      DomainEndList[task] -= 1;
                      <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1] -= 1;

                      moved++;
                    }
                }

            }
        }

      iter++;
    }
  <span class="keywordflow">while</span>(moved &gt; 0 &amp;&amp; iter &lt; 10 * NTopleaves);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a89c54187117b91d4270a4f0c406ce2ba_cgraph.png" border="0" usemap="#domain_8c_a89c54187117b91d4270a4f0c406ce2ba_cgraph" alt=""/></div>
<map name="domain_8c_a89c54187117b91d4270a4f0c406ce2ba_cgraph" id="domain_8c_a89c54187117b91d4270a4f0c406ce2ba_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="187,5,245,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a89c54187117b91d4270a4f0c406ce2ba_icgraph.png" border="0" usemap="#domain_8c_a89c54187117b91d4270a4f0c406ce2ba_icgraph" alt=""/></div>
<map name="domain_8c_a89c54187117b91d4270a4f0c406ce2ba_icgraph" id="domain_8c_a89c54187117b91d4270a4f0c406ce2ba_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="187,57,339,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="387,57,560,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="608,5,827,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="887,56,929,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="697,109,737,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="991,83,1044,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="875,109,941,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a25aada0d3751c2afd2a376151d1d917e"></a><!-- doxytag: member="domain.c::domain_sumCost" ref="a25aada0d3751c2afd2a376151d1d917e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_sumCost </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine bins the particles onto the domain-grid, i.e. it sums up the total number of particles and the total amount of work in each of the domain-cells. This information forms the basis for the actual decision on the adopted domain decomposition. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00786">786</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="domain_8c_source.html#l00765">domain_walktoptree()</a>, <a class="el" href="allvars_8c_source.html#l00057">DomainCount</a>, <a class="el" href="allvars_8c_source.html#l00058">DomainCountSph</a>, <a class="el" href="allvars_8c_source.html#l00056">DomainWork</a>, <a class="el" href="allvars_8h_source.html#l00537">particle_data::GravCost</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, <a class="el" href="allvars_8c_source.html#l00074">NTopnodes</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, n, no;
  <span class="keywordtype">double</span> *local_DomainWork;
  <span class="keywordtype">int</span> *local_DomainCount;
  <span class="keywordtype">int</span> *local_DomainCountSph;

  local_DomainWork = malloc(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
  local_DomainCount = malloc(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  local_DomainCountSph = malloc(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));



  <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a> = 0;

  <a class="code" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4">domain_walktoptree</a>(0);

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    {
      local_DomainWork[i] = 0;
      local_DomainCount[i] = 0;
      local_DomainCountSph[i] = 0;
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;NTopleaves= %d\n&quot;</span>, NTopleaves);

  <span class="keywordflow">for</span>(n = 0; n &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; n++)
    {
      no = 0;

      <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter &gt;= 0)
        no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + (<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] - <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Size / 8);

      no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a>;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_endstep &gt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_begstep)
        local_DomainWork[no] += (1.0 + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a>) / (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_endstep - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_begstep);
      <span class="keywordflow">else</span>
        local_DomainWork[no] += (1.0 + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a>);

      local_DomainCount[no] += 1;
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type == 0)
        local_DomainCountSph[no] += 1;
    }

  MPI_Allreduce(local_DomainWork, <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>, NTopleaves, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
  MPI_Allreduce(local_DomainCount, <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>, NTopleaves, MPI_INT, MPI_SUM, MPI_COMM_WORLD);
  MPI_Allreduce(local_DomainCountSph, <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>, NTopleaves, MPI_INT, MPI_SUM, MPI_COMM_WORLD);


  free(local_DomainCountSph);
  free(local_DomainCount);
  free(local_DomainWork);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a25aada0d3751c2afd2a376151d1d917e_cgraph.png" border="0" usemap="#domain_8c_a25aada0d3751c2afd2a376151d1d917e_cgraph" alt=""/></div>
<map name="domain_8c_a25aada0d3751c2afd2a376151d1d917e_cgraph" id="domain_8c_a25aada0d3751c2afd2a376151d1d917e_cgraph">
<area shape="rect" id="node3" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4" title="domain_walktoptree" alt="" coords="191,5,340,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a25aada0d3751c2afd2a376151d1d917e_icgraph.png" border="0" usemap="#domain_8c_a25aada0d3751c2afd2a376151d1d917e_icgraph" alt=""/></div>
<map name="domain_8c_a25aada0d3751c2afd2a376151d1d917e_icgraph" id="domain_8c_a25aada0d3751c2afd2a376151d1d917e_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="189,57,341,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="389,57,563,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="611,5,829,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="889,56,932,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="700,109,740,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="993,83,1047,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="877,109,944,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a606de536756a67ad8f79f1135009195e"></a><!-- doxytag: member="domain.c::domain_topsplit" ref="a606de536756a67ad8f79f1135009195e" args="(int node, peanokey startkey)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_topsplit </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>node</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>&nbsp;</td>
          <td class="paramname"> <em>startkey</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is responsible for constructing the global top-level tree segments. Starting from a joint list of all local top-level segments, in which mulitple occurences of the same spatial segment have been combined, a segment is subdivided into 8 pieces recursively until the number of particles in each segment has fallen below All.TotNumPart / (TOPNODEFACTOR * NTask). </p>

<p><p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition </p>
</p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l01049">1049</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00224">topnode_data::Blocks</a>, <a class="el" href="domain_8c_source.html#l00050">topnode_exchange::Count</a>, <a class="el" href="allvars_8h_source.html#l00228">topnode_data::Count</a>, <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00045">MAXTOPNODES</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00074">NTopnodes</a>, <a class="el" href="allvars_8h_source.html#l00223">topnode_data::Pstart</a>, <a class="el" href="allvars_8h_source.html#l00226">topnode_data::Size</a>, <a class="el" href="domain_8c_source.html#l00049">topnode_exchange::Startkey</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>, <a class="el" href="domain_8c_source.html#l00029">TOPNODEFACTOR</a>, <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>, and <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>, and <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p, sub, bin;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Size &gt;= 8)
    {
      <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> &lt; <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a>)
            {
              sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + i;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> / 8;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> = 0;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abad41cd99537e7a3a0d78ac5f291e42d">Blocks</a> = 0;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = -1;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a> = startkey + i * <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a>;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a>;
              <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>++;
            }
          <span class="keywordflow">else</span>
            {
              printf(<span class="stringliteral">&quot;Task=%d: We are out of Topnodes. Increasing the constant MAXTOPNODES might help.\n&quot;</span>,
                     <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
              fflush(stdout);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(137213);
            }
        }

      <span class="keywordflow">for</span>(p = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Pstart; p &lt; <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> + <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abad41cd99537e7a3a0d78ac5f291e42d">Blocks</a>; p++)
        {
          bin = (<a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>[p].<a class="code" href="structtopnode__exchange.html#a1320a6ec4ba632909af0c092bd7735b4">Startkey</a> - startkey) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Size / 8);
          sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + bin;

          <span class="keywordflow">if</span>(bin &lt; 0 || bin &gt; 7)
            <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(77);

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].Blocks == 0)
            <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = p;

          <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> += <a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>[p].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a>;
          <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abad41cd99537e7a3a0d78ac5f291e42d">Blocks</a>++;
        }

      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        {
          sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + i;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> / (<a class="code" href="domain_8c.html#aebefeda80791480c21adcdd296f92c90">TOPNODEFACTOR</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>))
            <a class="code" href="domain_8c.html#a606de536756a67ad8f79f1135009195e">domain_topsplit</a>(sub, <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].StartKey);
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a606de536756a67ad8f79f1135009195e_cgraph.png" border="0" usemap="#domain_8c_a606de536756a67ad8f79f1135009195e_cgraph" alt=""/></div>
<map name="domain_8c_a606de536756a67ad8f79f1135009195e_cgraph" id="domain_8c_a606de536756a67ad8f79f1135009195e_cgraph">
<area shape="rect" id="node4" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="179,29,245,59"/><area shape="rect" id="node6" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="293,29,451,59"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a606de536756a67ad8f79f1135009195e_icgraph.png" border="0" usemap="#domain_8c_a606de536756a67ad8f79f1135009195e_icgraph" alt=""/></div>
<map name="domain_8c_a606de536756a67ad8f79f1135009195e_icgraph" id="domain_8c_a606de536756a67ad8f79f1135009195e_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="352,57,544,87"/><area shape="rect" id="node21" href="proto_8h.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="180,95,303,124"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="592,57,744,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="792,57,965,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="1013,5,1232,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1292,56,1335,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1103,109,1143,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1396,83,1449,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1280,109,1347,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa5001f9be833c4673392b40e7be3a421"></a><!-- doxytag: member="domain.c::domain_topsplit_local" ref="aa5001f9be833c4673392b40e7be3a421" args="(int node, peanokey startkey)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_topsplit_local </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>node</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>&nbsp;</td>
          <td class="paramname"> <em>startkey</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is responsible for constructing the local top-level Peano-Hilbert segments. A segment is cut into 8 pieces recursively until the number of particles in the segment has fallen below All.TotNumPart / (TOPNODEFACTOR * NTask * NTask). </p>

<p><p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition </p>
</p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00982">982</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="domain_8c_source.html#l00050">topnode_exchange::Count</a>, <a class="el" href="allvars_8h_source.html#l00228">topnode_data::Count</a>, <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="domain_8c_source.html#l00982">domain_topsplit_local()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00071">KeySorted</a>, <a class="el" href="allvars_8h_source.html#l00045">MAXTOPNODES</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00074">NTopnodes</a>, <a class="el" href="allvars_8h_source.html#l00223">topnode_data::Pstart</a>, <a class="el" href="allvars_8h_source.html#l00226">topnode_data::Size</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="domain_8c_source.html#l00029">TOPNODEFACTOR</a>, <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>, and <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>, and <a class="el" href="domain_8c_source.html#l00982">domain_topsplit_local()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p, sub, bin;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Size &gt;= 8)
    {
      <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> &lt; <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a>)
            {
              sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + i;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> / 8;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> = 0;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = -1;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a> = startkey + i * <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a>;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a>;

              <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>++;
            }
          <span class="keywordflow">else</span>
            {
              printf(<span class="stringliteral">&quot;task=%d: We are out of Topnodes. Increasing the constant MAXTOPNODES might help.\n&quot;</span>,
                     <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
              fflush(stdout);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(13213);
            }
        }

      <span class="keywordflow">for</span>(p = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Pstart; p &lt; <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> + <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a>; p++)
        {
          bin = (<a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a>[p] - startkey) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Size / 8);

          <span class="keywordflow">if</span>(bin &lt; 0 || bin &gt; 7)
            {
              printf(<span class="stringliteral">&quot;task=%d: something odd has happened here. bin=%d\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, bin);
              fflush(stdout);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(13123123);
            }

          sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + bin;

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a> == 0)
            <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = p;

          <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a>++;
        }

      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        {
          sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + i;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> / (<a class="code" href="domain_8c.html#aebefeda80791480c21adcdd296f92c90">TOPNODEFACTOR</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>))
            <a class="code" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421">domain_topsplit_local</a>(sub, <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].StartKey);
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_aa5001f9be833c4673392b40e7be3a421_cgraph.png" border="0" usemap="#domain_8c_aa5001f9be833c4673392b40e7be3a421_cgraph" alt=""/></div>
<map name="domain_8c_aa5001f9be833c4673392b40e7be3a421_cgraph" id="domain_8c_aa5001f9be833c4673392b40e7be3a421_cgraph">
<area shape="rect" id="node4" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="213,29,280,59"/><area shape="rect" id="node6" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="328,29,485,59"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_aa5001f9be833c4673392b40e7be3a421_icgraph.png" border="0" usemap="#domain_8c_aa5001f9be833c4673392b40e7be3a421_icgraph" alt=""/></div>
<map name="domain_8c_aa5001f9be833c4673392b40e7be3a421_icgraph" id="domain_8c_aa5001f9be833c4673392b40e7be3a421_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="421,57,613,87"/><area shape="rect" id="node21" href="proto_8h.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="213,95,373,124"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="661,57,813,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="861,57,1035,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="1083,5,1301,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1361,56,1404,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1172,109,1212,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1465,83,1519,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1349,109,1416,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9b1062a5c460164de378d5e8c45736c4"></a><!-- doxytag: member="domain.c::domain_walktoptree" ref="a9b1062a5c460164de378d5e8c45736c4" args="(int no)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_walktoptree </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>no</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function walks the global top tree in order to establish the number of leaves it has. These leaves are distributed to different processors. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00765">765</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00786">domain_sumCost()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter == -1)
    {
      <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a> = <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>;
      <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>++;
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        <a class="code" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4">domain_walktoptree</a>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter + i);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="domain_8c_a9b1062a5c460164de378d5e8c45736c4_icgraph.png" border="0" usemap="#domain_8c_a9b1062a5c460164de378d5e8c45736c4_icgraph" alt=""/></div>
<map name="domain_8c_a9b1062a5c460164de378d5e8c45736c4_icgraph" id="domain_8c_a9b1062a5c460164de378d5e8c45736c4_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25aada0d3751c2afd2a376151d1d917e" title="domain_sumCost" alt="" coords="207,57,340,87"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="389,57,541,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="589,57,763,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="811,5,1029,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1089,56,1132,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="900,109,940,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1193,83,1247,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1077,109,1144,139"/></map>
</div>
</p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="af3343810478135e16ac72ea1f0172cd6"></a><!-- doxytag: member="domain.c::list_load" ref="af3343810478135e16ac72ea1f0172cd6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int* <a class="el" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00041">41</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, and <a class="el" href="domain_8c_source.html#l00447">domain_shiftSplit()</a>.</p>

</div>
</div>
<a class="anchor" id="a97ae02d63ef3ac017dcbaea0d3b4dda4"></a><!-- doxytag: member="domain.c::list_loadsph" ref="a97ae02d63ef3ac017dcbaea0d3b4dda4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int* <a class="el" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00042">42</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, and <a class="el" href="domain_8c_source.html#l00447">domain_shiftSplit()</a>.</p>

</div>
</div>
<a class="anchor" id="a9819cd512382caee762325ea86f4b221"></a><!-- doxytag: member="domain.c::list_N_gas" ref="a9819cd512382caee762325ea86f4b221" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int* <a class="el" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00040">40</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, and <a class="el" href="domain_8c_source.html#l00534">domain_findExchangeNumbers()</a>.</p>

</div>
</div>
<a class="anchor" id="a040694ce8b01a0b994df96d39588813a"></a><!-- doxytag: member="domain.c::list_NumPart" ref="a040694ce8b01a0b994df96d39588813a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int* <a class="el" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00039">39</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, and <a class="el" href="domain_8c_source.html#l00534">domain_findExchangeNumbers()</a>.</p>

</div>
</div>
<a class="anchor" id="ad25e64ba07e1ed5350cceeab486c6f4a"></a><!-- doxytag: member="domain.c::list_work" ref="ad25e64ba07e1ed5350cceeab486c6f4a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double* <a class="el" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00043">43</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, and <a class="el" href="domain_8c_source.html#l00447">domain_shiftSplit()</a>.</p>

</div>
</div>
<a class="anchor" id="a394783c89866b4e48255038384f9539b"></a><!-- doxytag: member="domain.c::local_toGo" ref="a394783c89866b4e48255038384f9539b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int* <a class="el" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00038">38</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00729">domain_countToGo()</a>, and <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>.</p>

</div>
</div>
<a class="anchor" id="a119a354c6c46ee11fdb9c7ad131b787a"></a><!-- doxytag: member="domain.c::local_toGoSph" ref="a119a354c6c46ee11fdb9c7ad131b787a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int * <a class="el" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00038">38</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00729">domain_countToGo()</a>, and <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>.</p>

</div>
</div>
<a class="anchor" id="ac54707073f160b11ee4ba864066487c3"></a><!-- doxytag: member="domain.c::maxload" ref="ac54707073f160b11ee4ba864066487c3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">long long <a class="el" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00045">45</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, and <a class="el" href="domain_8c_source.html#l00447">domain_shiftSplit()</a>.</p>

</div>
</div>
<a class="anchor" id="afa6a98969329aca0189182e060a2834e"></a><!-- doxytag: member="domain.c::maxloadsph" ref="afa6a98969329aca0189182e060a2834e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">long long <a class="el" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00045">45</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, and <a class="el" href="domain_8c_source.html#l00447">domain_shiftSplit()</a>.</p>

</div>
</div>
<a class="anchor" id="a52aefc67245e1a334c311a420f89130c"></a><!-- doxytag: member="domain.c::toGo" ref="a52aefc67245e1a334c311a420f89130c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int* <a class="el" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>toGo[task*NTask + partner] gives the number of particles in task 'task' that have to go to task 'partner' </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00037">37</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00729">domain_countToGo()</a>, <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, and <a class="el" href="domain_8c_source.html#l00534">domain_findExchangeNumbers()</a>.</p>

</div>
</div>
<a class="anchor" id="af00bb52ac4aa095d4d6daac54833675f"></a><!-- doxytag: member="domain.c::toGoSph" ref="af00bb52ac4aa095d4d6daac54833675f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int * <a class="el" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="domain_8c_source.html#l00037">37</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00729">domain_countToGo()</a>, <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, and <a class="el" href="domain_8c_source.html#l00534">domain_findExchangeNumbers()</a>.</p>

</div>
</div>
<a class="anchor" id="aa4d05cc74afde41e1777c117c9103471"></a><!-- doxytag: member="domain.c::toplist" ref="aa4d05cc74afde41e1777c117c9103471" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structtopnode__exchange.html">topnode_exchange</a>
 * <a class="el" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>, and <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>.</p>

</div>
</div>
<a class="anchor" id="a62244375ee3d9bdb3f7428a58de42085"></a><!-- doxytag: member="domain.c::toplist_local" ref="a62244375ee3d9bdb3f7428a58de42085" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structtopnode__exchange.html">topnode_exchange</a> * <a class="el" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>.</p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Dec 3 2010 18:45:43 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
