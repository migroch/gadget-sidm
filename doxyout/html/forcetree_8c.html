<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>gadget-sidm: forcetree.c File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">gadget-sidm
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('forcetree_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">forcetree.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>gravitational tree and code for Ewald correction  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;time.h&gt;</code><br/>
<code>#include &lt;mpi.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="allvars_8h_source.html">allvars.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="proto_8h_source.html">proto.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for forcetree.c:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c__incl.png" border="0" usemap="#forcetree_8c" alt=""/></div>
<map name="forcetree_8c" id="forcetree_8c">
<area shape="rect" id="node15" href="allvars_8h.html" title="declares global variables." alt="" coords="437,161,512,189"/><area shape="rect" id="node22" href="proto_8h.html" title="this file contains all function prototypes of the code" alt="" coords="523,83,589,111"/><area shape="rect" id="node20" href="tags_8h.html" title="declares various tags for labelling MPI messages." alt="" coords="497,238,559,266"/></map>
</div>
</div>
<p><a href="forcetree_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a>&#160;&#160;&#160;1000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(x)&#160;&#160;&#160;(((x)&gt;boxhalf)?((x)-boxsize):(((x)&lt;-boxhalf)?((x)+boxsize):(x)))</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>&#160;&#160;&#160;64</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5">force_treebuild</a> (int npart)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6">force_treebuild_single</a> (int npart)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89">force_create_empty_nodes</a> (int no, int topnode, int bits, int x, int y, int z, int *nodecount, int *nextfree)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d">force_insert_pseudo_particles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d">force_update_node_recursive</a> (int no, int sib, int father)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0">force_update_pseudoparticles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb">force_exchange_pseudodata</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19">force_treeupdate_pseudos</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7">force_flag_localnodes</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a04fb647ef783d5baeb9275d806c08365">force_update_len</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a4592b750f8555f580691103acf1e5366">force_update_node_len_local</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a5f85438d619d63c812c8e05faf1f0074">force_update_node_len_toptree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a4764c1fb83a956c1712345538630854c">force_update_hmax</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a4c108b1da2bc4f2620f62aeab90c1074">force_update_node_hmax_local</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ac3f5945bb7c73936ef49af1507265afe">force_update_node_hmax_toptree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a59ae74ef51d6a7065605638422489391">force_treeevaluate</a> (int target, int mode, double *ewaldcountsum)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ae01e179b7686a7fe62970160b7bbdb46">force_treeevaluate_shortrange</a> (int target, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f">force_treeevaluate_ewald_correction</a> (int target, int mode, double pos_x, double pos_y, double pos_z, double aold)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#af29d257a1e4545ba4b9c3648444979b6">force_treeevaluate_potential</a> (int target, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#abd9d86a6c08e77a4fa78fa76b96cdde7">force_treeevaluate_potential_shortrange</a> (int target, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate</a> (int maxnodes, int maxpart)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888">force_treefree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a0ec221b2517893874b12dc366bfe0da8">force_treeevaluate_direct</a> (int target, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0">dump_particles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a47f99270d9b0b0f75d86b3b9d078dff6">ewald_init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ad8b8e212e593e1795f6ba522239086fc">ewald_corr</a> (double dx, double dy, double dz, double *fper)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#aa0657e3de6bfb76715c14ddd72d25e58">ewald_pot_corr</a> (double dx, double dy, double dz)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a4a219224b239f0c20497e54ae421f134">ewald_psi</a> (double x[3])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a49e4b7c0d57d0ab446b4ec38f3618925">ewald_force</a> (int iii, int jjj, int kkk, double x[3], double force[3])</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#abe941030bf66a95df993b617bffefd9b">tabfac</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a76b621ce2fa9c17911a62495174029eb">shortrange_table</a> [1000]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a196b7c27d03bd3ecc1259b2f67017fbe">shortrange_table_potential</a> [1000]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a37ea0ff529d9c7e76f1f7895bde01183">first_flag</a> = 0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a> [64+1][64+1][64+1]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a> [64+1][64+1][64+1]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a> [64+1][64+1][64+1]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a> [64+1][64+1][64+1]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>gravitational tree and code for Ewald correction </p>
<p>This file contains the computation of the gravitational force by means of a tree. The type of tree implemented is a geometrical oct-tree, starting from a cube encompassing all particles. This cube is automatically found in the domain decomposition, which also splits up the global "top-level" tree along node boundaries, moving the particles of different parts of the tree to separate processors. Tree nodes can be dynamically updated in drift/kick operations to avoid having to reconstruct the tree every timestep. </p>

<p>Definition in file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>
</div><hr/><h2>Define Documentation</h2>
<a class="anchor" id="a22e6626f2c98ed902f8ded47f6438c05"></a><!-- doxytag: member="forcetree.c::EN" ref="a22e6626f2c98ed902f8ded47f6438c05" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>&#160;&#160;&#160;64</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Size of 3D lock-up table for Ewald correction force </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00045">45</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03312">ewald_corr()</a>, <a class="el" href="forcetree_8c_source.html#l03163">ewald_init()</a>, <a class="el" href="forcetree_8c_source.html#l03401">ewald_pot_corr()</a>, and <a class="el" href="forcetree_8c_source.html#l02018">force_treeevaluate_ewald_correction()</a>.</p>

</div>
</div>
<a class="anchor" id="a1094686c363ae3a70dca627763873649"></a><!-- doxytag: member="forcetree.c::NEAREST" ref="a1094686c363ae3a70dca627763873649" args="(x)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a></td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td>&#160;&#160;&#160;(((x)&gt;boxhalf)?((x)-boxsize):(((x)&lt;-boxhalf)?((x)+boxsize):(x)))</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Macro that maps a distance to the nearest periodic neighbour </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00043">43</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l01126">force_treeevaluate()</a>, <a class="el" href="forcetree_8c_source.html#l02018">force_treeevaluate_ewald_correction()</a>, <a class="el" href="forcetree_8c_source.html#l02300">force_treeevaluate_potential()</a>, <a class="el" href="forcetree_8c_source.html#l02577">force_treeevaluate_potential_shortrange()</a>, and <a class="el" href="forcetree_8c_source.html#l01542">force_treeevaluate_shortrange()</a>.</p>

</div>
</div>
<a class="anchor" id="a0e93cfb2d62849853fd34957ba6e6fdc"></a><!-- doxytag: member="forcetree.c::NTAB" ref="a0e93cfb2d62849853fd34957ba6e6fdc" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a>&#160;&#160;&#160;1000</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>length of lock-up table for short-range force kernel in TreePM algorithm </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00031">31</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02911">force_treeallocate()</a>, <a class="el" href="forcetree_8c_source.html#l02577">force_treeevaluate_potential_shortrange()</a>, and <a class="el" href="forcetree_8c_source.html#l01542">force_treeevaluate_shortrange()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ab303b92c6d6b4144999c5cebabd65ec0"></a><!-- doxytag: member="forcetree.c::dump_particles" ref="ab303b92c6d6b4144999c5cebabd65ec0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#ab303b92c6d6b4144999c5cebabd65ec0">dump_particles</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function dumps some of the basic particle data to a file. In case the tree construction fails, it is called just before the run terminates with an error message. Examination of the generated file may then give clues to what caused the problem. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03124">3124</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="io_8c_source.html#l01122">my_fwrite()</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, and <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>.</p>
<div class="fragment"><pre class="fragment">{
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>;
  <span class="keywordtype">char</span> buffer[200];
  <span class="keywordtype">int</span> i;

  sprintf(buffer, <span class="stringliteral">&quot;particles%d.dat&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
  fd = fopen(buffer, <span class="stringliteral">&quot;w&quot;</span>);
  <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), fd);

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0], 3, <span class="keyword">sizeof</span>(FLOAT), fd);

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Vel[0], 3, <span class="keyword">sizeof</span>(FLOAT), fd);

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].ID, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), fd);

  fclose(fd);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ab303b92c6d6b4144999c5cebabd65ec0_cgraph.png" border="0" usemap="#forcetree_8c_ab303b92c6d6b4144999c5cebabd65ec0_cgraph" alt=""/></div>
<map name="forcetree_8c_ab303b92c6d6b4144999c5cebabd65ec0_cgraph" id="forcetree_8c_ab303b92c6d6b4144999c5cebabd65ec0_cgraph">
<area shape="rect" id="node3" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="173,5,256,33"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="304,5,371,33"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="419,5,576,33"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ab303b92c6d6b4144999c5cebabd65ec0_icgraph.png" border="0" usemap="#forcetree_8c_ab303b92c6d6b4144999c5cebabd65ec0_icgraph" alt=""/></div>
<map name="forcetree_8c_ab303b92c6d6b4144999c5cebabd65ec0_icgraph" id="forcetree_8c_ab303b92c6d6b4144999c5cebabd65ec0_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="175,30,369,58"/><area shape="rect" id="node5" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="420,55,580,83"/><area shape="rect" id="node7" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="629,55,747,83"/><area shape="rect" id="node9" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="817,55,916,83"/><area shape="rect" id="node17" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="812,5,921,33"/><area shape="rect" id="node24" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="796,106,937,134"/><area shape="rect" id="node11" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="1011,55,1181,83"/><area shape="rect" id="node13" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1265,94,1308,122"/><area shape="rect" id="node15" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1369,57,1423,85"/><area shape="rect" id="node19" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1076,5,1116,33"/><area shape="rect" id="node21" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1253,18,1320,46"/><area shape="rect" id="node27" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="987,106,1205,134"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad8b8e212e593e1795f6ba522239086fc"></a><!-- doxytag: member="forcetree.c::ewald_corr" ref="ad8b8e212e593e1795f6ba522239086fc" args="(double dx, double dy, double dz, double *fper)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#ad8b8e212e593e1795f6ba522239086fc">ewald_corr</a> </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>dx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>dy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>dz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>fper</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function looks up the correction force due to the infinite number of periodic particle/node images. We here use trilinear interpolation to get it from the precomputed tables, which contain one octant around the target particle at the origin. The other octants are obtained from it by exploiting the symmetry properties. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03312">3312</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="forcetree_8c_source.html#l00045">EN</a>, <a class="el" href="forcetree_8c_source.html#l00053">fac_intp</a>, <a class="el" href="forcetree_8c_source.html#l00049">fcorrx</a>, <a class="el" href="forcetree_8c_source.html#l00050">fcorry</a>, and <a class="el" href="forcetree_8c_source.html#l00051">fcorrz</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02993">force_treeevaluate_direct()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> signx, signy, signz;
  <span class="keywordtype">int</span> i, j, k;
  <span class="keywordtype">double</span> u, v, w;
  <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;

  <span class="keywordflow">if</span>(dx &lt; 0)
    {
      dx = -dx;
      signx = +1;
    }
  <span class="keywordflow">else</span>
    signx = -1;

  <span class="keywordflow">if</span>(dy &lt; 0)
    {
      dy = -dy;
      signy = +1;
    }
  <span class="keywordflow">else</span>
    signy = -1;

  <span class="keywordflow">if</span>(dz &lt; 0)
    {
      dz = -dz;
      signz = +1;
    }
  <span class="keywordflow">else</span>
    signz = -1;

  u = dx * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
  i = (int) u;
  <span class="keywordflow">if</span>(i &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    i = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  u -= i;
  v = dy * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
  j = (int) v;
  <span class="keywordflow">if</span>(j &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    j = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  v -= j;
  w = dz * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
  k = (int) w;
  <span class="keywordflow">if</span>(k &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    k = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  w -= k;

  f1 = (1 - u) * (1 - v) * (1 - w);
  f2 = (1 - u) * (1 - v) * (w);
  f3 = (1 - u) * (v) * (1 - w);
  f4 = (1 - u) * (v) * (w);
  f5 = (u) * (1 - v) * (1 - w);
  f6 = (u) * (1 - v) * (w);
  f7 = (u) * (v) * (1 - w);
  f8 = (u) * (v) * (w);

  fper[0] = signx * (<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k] * f1 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k + 1] * f2 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j + 1][k] * f3 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j + 1][k + 1] * f4 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j][k] * f5 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j][k + 1] * f6 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j + 1][k + 1] * f8);

  fper[1] = signy * (<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k] * f1 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k + 1] * f2 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j + 1][k] * f3 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j + 1][k + 1] * f4 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j][k] * f5 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j][k + 1] * f6 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j + 1][k + 1] * f8);

  fper[2] = signz * (<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k] * f1 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k + 1] * f2 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j + 1][k] * f3 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j + 1][k + 1] * f4 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j][k] * f5 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j][k + 1] * f6 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j + 1][k + 1] * f8);
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ad8b8e212e593e1795f6ba522239086fc_icgraph.png" border="0" usemap="#forcetree_8c_ad8b8e212e593e1795f6ba522239086fc_icgraph" alt=""/></div>
<map name="forcetree_8c_ad8b8e212e593e1795f6ba522239086fc_icgraph" id="forcetree_8c_ad8b8e212e593e1795f6ba522239086fc_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a0ec221b2517893874b12dc366bfe0da8" title="force_treeevaluate_direct" alt="" coords="145,5,329,33"/><area shape="rect" id="node5" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="380,5,508,33"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="557,5,728,33"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="776,5,819,33"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="868,5,921,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a49e4b7c0d57d0ab446b4ec38f3618925"></a><!-- doxytag: member="forcetree.c::ewald_force" ref="a49e4b7c0d57d0ab446b4ec38f3618925" args="(int iii, int jjj, int kkk, double x[3], double force[3])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a0c4d2bd0695737095313d7dc47ce120c">ewald_force</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>iii</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>jjj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>kkk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>x</em>[3], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>force</em>[3]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the force correction term (difference between full force of infinite lattice and nearest image) by Ewald summation. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03495">3495</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03163">ewald_init()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> alpha, r2;
  <span class="keywordtype">double</span> r, val, hdotx, dx[3];
  <span class="keywordtype">int</span> i, h[3], n[3], h2;

  alpha = 2.0;

  <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
    force[i] = 0;

  <span class="keywordflow">if</span>(iii == 0 &amp;&amp; jjj == 0 &amp;&amp; kkk == 0)
    <span class="keywordflow">return</span>;

  r2 = x[0] * x[0] + x[1] * x[1] + x[2] * x[2];

  <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
    force[i] += x[i] / (r2 * sqrt(r2));

  <span class="keywordflow">for</span>(n[0] = -4; n[0] &lt;= 4; n[0]++)
    <span class="keywordflow">for</span>(n[1] = -4; n[1] &lt;= 4; n[1]++)
      <span class="keywordflow">for</span>(n[2] = -4; n[2] &lt;= 4; n[2]++)
        {
          <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
            dx[i] = x[i] - n[i];

          r = sqrt(dx[0] * dx[0] + dx[1] * dx[1] + dx[2] * dx[2]);

          val = erfc(alpha * r) + 2 * alpha * r / sqrt(M_PI) * exp(-alpha * alpha * r * r);

          <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
            force[i] -= dx[i] / (r * r * r) * val;
        }

  <span class="keywordflow">for</span>(h[0] = -4; h[0] &lt;= 4; h[0]++)
    <span class="keywordflow">for</span>(h[1] = -4; h[1] &lt;= 4; h[1]++)
      <span class="keywordflow">for</span>(h[2] = -4; h[2] &lt;= 4; h[2]++)
        {
          hdotx = x[0] * h[0] + x[1] * h[1] + x[2] * h[2];
          h2 = h[0] * h[0] + h[1] * h[1] + h[2] * h[2];

          <span class="keywordflow">if</span>(h2 &gt; 0)
            {
              val = 2.0 / ((double) h2) * exp(-M_PI * M_PI * h2 / (alpha * alpha)) * sin(2 * M_PI * hdotx);

              <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
                force[i] -= h[i] * val;
            }
        }
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a49e4b7c0d57d0ab446b4ec38f3618925_icgraph.png" border="0" usemap="#forcetree_8c_a49e4b7c0d57d0ab446b4ec38f3618925_icgraph" alt=""/></div>
<map name="forcetree_8c_a49e4b7c0d57d0ab446b4ec38f3618925_icgraph" id="forcetree_8c_a49e4b7c0d57d0ab446b4ec38f3618925_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a47f99270d9b0b0f75d86b3b9d078dff6" title="ewald_init" alt="" coords="153,5,236,33"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="285,5,352,33"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="401,5,455,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a47f99270d9b0b0f75d86b3b9d078dff6"></a><!-- doxytag: member="forcetree.c::ewald_init" ref="a47f99270d9b0b0f75d86b3b9d078dff6" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a47f99270d9b0b0f75d86b3b9d078dff6">ewald_init</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function initializes tables with the correction force and the correction potential due to the periodic images of a point mass located at the origin. These corrections are obtained by Ewald summation. (See Hernquist, Bouchet, Suto, ApJS, 1991, 75, 231) The correction fields are used to obtain the full periodic force if periodic boundaries combined with the pure tree algorithm are used. For the TreePM algorithm, the Ewald correction is not used.</p>
<p>The correction fields are stored on disk once they are computed. If a corresponding file is found, they are loaded from disk to speed up the initialization. The Ewald summation is done in parallel, i.e. the processors share the work to compute the tables if needed. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03163">3163</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="forcetree_8c_source.html#l00045">EN</a>, <a class="el" href="forcetree_8c_source.html#l03495">ewald_force()</a>, <a class="el" href="forcetree_8c_source.html#l03454">ewald_psi()</a>, <a class="el" href="forcetree_8c_source.html#l00053">fac_intp</a>, <a class="el" href="forcetree_8c_source.html#l00049">fcorrx</a>, <a class="el" href="forcetree_8c_source.html#l00050">fcorry</a>, <a class="el" href="forcetree_8c_source.html#l00051">fcorrz</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="io_8c_source.html#l01139">my_fread()</a>, <a class="el" href="io_8c_source.html#l01122">my_fwrite()</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="forcetree_8c_source.html#l00052">potcorr</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, k, beg, len, size, n, task, count;
  <span class="keywordtype">double</span> x[3], force[3];
  <span class="keywordtype">char</span> buf[200];
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;initialize Ewald correction...\n&quot;</span>);
      fflush(stdout);
    }

<span class="preprocessor">#ifdef DOUBLEPRECISION</span>
<span class="preprocessor"></span>  sprintf(buf, <span class="stringliteral">&quot;ewald_spc_table_%d_dbl.dat&quot;</span>, <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  sprintf(buf, <span class="stringliteral">&quot;ewald_spc_table_%d.dat&quot;</span>, <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>((fd = fopen(buf, <span class="stringliteral">&quot;r&quot;</span>)))
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;\nreading Ewald tables from file `%s&#39;\n&quot;</span>, buf);
          fflush(stdout);
        }

      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
      fclose(fd);
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;\nNo Ewald tables in file `%s&#39; found.\nRecomputing them...\n&quot;</span>, buf);
          fflush(stdout);
        }

      <span class="comment">/* ok, let&#39;s recompute things. Actually, we do that in parallel. */</span>

      size = (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) / <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>;


      beg = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * size;
      len = size;
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == (<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> - 1))
        len = (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) - beg;

      <span class="keywordflow">for</span>(i = 0, count = 0; i &lt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>; j++)
          <span class="keywordflow">for</span>(k = 0; k &lt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>; k++)
            {
              n = (i * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) + j) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) + k;
              <span class="keywordflow">if</span>(n &gt;= beg &amp;&amp; n &lt; (beg + len))
                {
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
                    {
                      <span class="keywordflow">if</span>((count % (len / 20)) == 0)
                        {
                          printf(<span class="stringliteral">&quot;%4.1f percent done\n&quot;</span>, count / (len / 100.0));
                          fflush(stdout);
                        }
                    }

                  x[0] = 0.5 * ((double) i) / <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>;
                  x[1] = 0.5 * ((double) j) / <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>;
                  x[2] = 0.5 * ((double) k) / <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>;

                  <a class="code" href="forcetree_8c.html#a49e4b7c0d57d0ab446b4ec38f3618925">ewald_force</a>(i, j, k, x, force);

                  <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k] = force[0];
                  <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k] = force[1];
                  <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k] = force[2];

                  <span class="keywordflow">if</span>(i + j + k == 0)
                    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k] = 2.8372975;
                  <span class="keywordflow">else</span>
                    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k] = <a class="code" href="forcetree_8c.html#a4a219224b239f0c20497e54ae421f134">ewald_psi</a>(x);

                  count++;
                }
            }

      <span class="keywordflow">for</span>(task = 0; task &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; task++)
        {
          beg = task * size;
          len = size;
          <span class="keywordflow">if</span>(task == (NTask - 1))
            len = (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) - beg;

<span class="preprocessor">#ifdef DOUBLEPRECISION</span>
<span class="preprocessor"></span>          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;\nwriting Ewald tables to file `%s&#39;\n&quot;</span>, buf);
          fflush(stdout);

          <span class="keywordflow">if</span>((fd = fopen(buf, <span class="stringliteral">&quot;w&quot;</span>)))
            {
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
              fclose(fd);
            }
        }
    }

  <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a> = 2 * <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;

  <span class="keywordflow">for</span>(i = 0; i &lt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>; i++)
    <span class="keywordflow">for</span>(j = 0; j &lt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>; j++)
      <span class="keywordflow">for</span>(k = 0; k &lt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>; k++)
        {
          <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k] /= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
          <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k] /= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
          <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k] /= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
          <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k] /= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
        }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;initialization of periodic boundaries finished.\n&quot;</span>);
      fflush(stdout);
    }
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a47f99270d9b0b0f75d86b3b9d078dff6_cgraph.png" border="0" usemap="#forcetree_8c_a47f99270d9b0b0f75d86b3b9d078dff6_cgraph" alt=""/></div>
<map name="forcetree_8c_a47f99270d9b0b0f75d86b3b9d078dff6_cgraph" id="forcetree_8c_a47f99270d9b0b0f75d86b3b9d078dff6_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a49e4b7c0d57d0ab446b4ec38f3618925" title="ewald_force" alt="" coords="140,5,236,33"/><area shape="rect" id="node5" href="forcetree_8c.html#a4a219224b239f0c20497e54ae421f134" title="ewald_psi" alt="" coords="147,55,229,83"/><area shape="rect" id="node7" href="io_8c.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="147,106,229,134"/><area shape="rect" id="node13" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="147,157,229,185"/><area shape="rect" id="node9" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="285,131,352,159"/><area shape="rect" id="node11" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="400,131,557,159"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a47f99270d9b0b0f75d86b3b9d078dff6_icgraph.png" border="0" usemap="#forcetree_8c_a47f99270d9b0b0f75d86b3b9d078dff6_icgraph" alt=""/></div>
<map name="forcetree_8c_a47f99270d9b0b0f75d86b3b9d078dff6_icgraph" id="forcetree_8c_a47f99270d9b0b0f75d86b3b9d078dff6_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="139,5,205,33"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="255,5,308,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa0657e3de6bfb76715c14ddd72d25e58"></a><!-- doxytag: member="forcetree.c::ewald_pot_corr" ref="aa0657e3de6bfb76715c14ddd72d25e58" args="(double dx, double dy, double dz)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="proto_8h.html#aa0657e3de6bfb76715c14ddd72d25e58">ewald_pot_corr</a> </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>dx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>dy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>dz</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function looks up the correction potential due to the infinite number of periodic particle/node images. We here use tri-linear interpolation to get it from the precomputed table, which contains one octant around the target particle at the origin. The other octants are obtained from it by exploiting symmetry properties. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03401">3401</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="forcetree_8c_source.html#l00045">EN</a>, <a class="el" href="forcetree_8c_source.html#l00053">fac_intp</a>, and <a class="el" href="forcetree_8c_source.html#l00052">potcorr</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02300">force_treeevaluate_potential()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, k;
  <span class="keywordtype">double</span> u, v, w;
  <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;

  <span class="keywordflow">if</span>(dx &lt; 0)
    dx = -dx;

  <span class="keywordflow">if</span>(dy &lt; 0)
    dy = -dy;

  <span class="keywordflow">if</span>(dz &lt; 0)
    dz = -dz;

  u = dx * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
  i = (int) u;
  <span class="keywordflow">if</span>(i &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    i = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  u -= i;
  v = dy * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
  j = (int) v;
  <span class="keywordflow">if</span>(j &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    j = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  v -= j;
  w = dz * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
  k = (int) w;
  <span class="keywordflow">if</span>(k &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    k = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  w -= k;

  f1 = (1 - u) * (1 - v) * (1 - w);
  f2 = (1 - u) * (1 - v) * (w);
  f3 = (1 - u) * (v) * (1 - w);
  f4 = (1 - u) * (v) * (w);
  f5 = (u) * (1 - v) * (1 - w);
  f6 = (u) * (1 - v) * (w);
  f7 = (u) * (v) * (1 - w);
  f8 = (u) * (v) * (w);

  <span class="keywordflow">return</span> <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k] * f1 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k + 1] * f2 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j + 1][k] * f3 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j + 1][k + 1] * f4 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i + 1][j][k] * f5 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i + 1][j][k + 1] * f6 + <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i + 1][j + 1][k + 1] * f8;
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_aa0657e3de6bfb76715c14ddd72d25e58_icgraph.png" border="0" usemap="#forcetree_8c_aa0657e3de6bfb76715c14ddd72d25e58_icgraph" alt=""/></div>
<map name="forcetree_8c_aa0657e3de6bfb76715c14ddd72d25e58_icgraph" id="forcetree_8c_aa0657e3de6bfb76715c14ddd72d25e58_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a804166b1847da509d8fe57072b40d5f9" title="force_treeevaluate_potential" alt="" coords="173,5,379,33"/><area shape="rect" id="node5" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="428,5,569,33"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="885,5,928,33"/><area shape="rect" id="node11" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="619,30,837,58"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="977,5,1031,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4a219224b239f0c20497e54ae421f134"></a><!-- doxytag: member="forcetree.c::ewald_psi" ref="a4a219224b239f0c20497e54ae421f134" args="(double x[3])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="proto_8h.html#a4a219224b239f0c20497e54ae421f134">ewald_psi</a> </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>x</em>[3]</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the potential correction term by means of Ewald summation. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03454">3454</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03163">ewald_init()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> alpha, psi;
  <span class="keywordtype">double</span> r, sum1, sum2, hdotx;
  <span class="keywordtype">double</span> dx[3];
  <span class="keywordtype">int</span> i, n[3], h[3], h2;

  alpha = 2.0;

  <span class="keywordflow">for</span>(n[0] = -4, sum1 = 0; n[0] &lt;= 4; n[0]++)
    <span class="keywordflow">for</span>(n[1] = -4; n[1] &lt;= 4; n[1]++)
      <span class="keywordflow">for</span>(n[2] = -4; n[2] &lt;= 4; n[2]++)
        {
          <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
            dx[i] = x[i] - n[i];

          r = sqrt(dx[0] * dx[0] + dx[1] * dx[1] + dx[2] * dx[2]);
          sum1 += erfc(alpha * r) / r;
        }

  <span class="keywordflow">for</span>(h[0] = -4, sum2 = 0; h[0] &lt;= 4; h[0]++)
    <span class="keywordflow">for</span>(h[1] = -4; h[1] &lt;= 4; h[1]++)
      <span class="keywordflow">for</span>(h[2] = -4; h[2] &lt;= 4; h[2]++)
        {
          hdotx = x[0] * h[0] + x[1] * h[1] + x[2] * h[2];
          h2 = h[0] * h[0] + h[1] * h[1] + h[2] * h[2];
          <span class="keywordflow">if</span>(h2 &gt; 0)
            sum2 += 1 / (M_PI * h2) * exp(-M_PI * M_PI * h2 / (alpha * alpha)) * cos(2 * M_PI * hdotx);
        }

  r = sqrt(x[0] * x[0] + x[1] * x[1] + x[2] * x[2]);

  psi = M_PI / (alpha * alpha) - sum1 - sum2 + 1 / r;

  <span class="keywordflow">return</span> psi;
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a4a219224b239f0c20497e54ae421f134_icgraph.png" border="0" usemap="#forcetree_8c_a4a219224b239f0c20497e54ae421f134_icgraph" alt=""/></div>
<map name="forcetree_8c_a4a219224b239f0c20497e54ae421f134_icgraph" id="forcetree_8c_a4a219224b239f0c20497e54ae421f134_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a47f99270d9b0b0f75d86b3b9d078dff6" title="ewald_init" alt="" coords="137,5,220,33"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="269,5,336,33"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="385,5,439,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8eaedfa5c6d72bca79b465003679ed89"></a><!-- doxytag: member="forcetree.c::force_create_empty_nodes" ref="a8eaedfa5c6d72bca79b465003679ed89" args="(int no, int topnode, int bits, int x, int y, int z, int *nodecount, int *nextfree)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89">force_create_empty_nodes</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>no</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>topnode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>bits</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>nodecount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>nextfree</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function recursively creates a set of empty tree nodes which corresponds to the top-level tree for the domain grid. This is done to ensure that this top-level tree is always "complete" so that we can easily associate the pseudo-particles of other CPUs with tree-nodes at a given level in the tree, even when the particle population is so sparse that some of these nodes are actually empty. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00292">292</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="forcetree_8c_source.html#l03124">dump_particles()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="peano_8c_source.html#l00263">peano_hilbert_key()</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, and <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, k, n, sub, count;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[topnode].Daughter &gt;= 0)
    {
      <span class="keywordflow">for</span>(i = 0; i &lt; 2; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt; 2; j++)
          <span class="keywordflow">for</span>(k = 0; k &lt; 2; k++)
            {
              sub = 7 &amp; <a class="code" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df">peano_hilbert_key</a>((x &lt;&lt; 1) + i, (y &lt;&lt; 1) + j, (z &lt;&lt; 1) + k, bits);

              count = i + 2 * j + 4 * k;

              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.suns[count] = *nextfree;


              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].len = 0.5 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].center[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[0] + (2 * i - 1) * 0.25 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].center[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[1] + (2 * j - 1) * 0.25 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].center[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[2] + (2 * k - 1) * 0.25 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;

              <span class="keywordflow">for</span>(n = 0; n &lt; 8; n++)
                <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].u.suns[n] = -1;

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[topnode].Daughter + sub].Daughter == -1)
                <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[topnode].Daughter + sub].Leaf] = *nextfree;

              *nextfree = *nextfree + 1;
              *nodecount = *nodecount + 1;

              <span class="keywordflow">if</span>((*nodecount) &gt;= <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)
                {
                  printf(<span class="stringliteral">&quot;task %d: maximum number %d of tree-nodes reached.\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>);
                  printf(<span class="stringliteral">&quot;in create empty nodes\n&quot;</span>);
                  <a class="code" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0">dump_particles</a>();
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(11);
                }

              <a class="code" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89">force_create_empty_nodes</a>(*nextfree - 1, TopNodes[topnode].Daughter + sub,
                                       bits + 1, 2 * x + i, 2 * y + j, 2 * z + k, nodecount, nextfree);
            }
    }
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a8eaedfa5c6d72bca79b465003679ed89_cgraph.png" border="0" usemap="#forcetree_8c_a8eaedfa5c6d72bca79b465003679ed89_cgraph" alt=""/></div>
<map name="forcetree_8c_a8eaedfa5c6d72bca79b465003679ed89_cgraph" id="forcetree_8c_a8eaedfa5c6d72bca79b465003679ed89_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="260,5,380,33"/><area shape="rect" id="node7" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="568,30,635,58"/><area shape="rect" id="node13" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="251,106,389,134"/><area shape="rect" id="node5" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="437,5,520,33"/><area shape="rect" id="node9" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="683,30,840,58"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a8eaedfa5c6d72bca79b465003679ed89_icgraph.png" border="0" usemap="#forcetree_8c_a8eaedfa5c6d72bca79b465003679ed89_icgraph" alt=""/></div>
<map name="forcetree_8c_a8eaedfa5c6d72bca79b465003679ed89_icgraph" id="forcetree_8c_a8eaedfa5c6d72bca79b465003679ed89_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="252,30,447,58"/><area shape="rect" id="node5" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="497,55,657,83"/><area shape="rect" id="node7" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="707,55,824,83"/><area shape="rect" id="node9" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="895,55,993,83"/><area shape="rect" id="node17" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="889,5,999,33"/><area shape="rect" id="node24" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="873,106,1015,134"/><area shape="rect" id="node11" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="1088,55,1259,83"/><area shape="rect" id="node13" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1343,94,1385,122"/><area shape="rect" id="node15" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1447,57,1500,85"/><area shape="rect" id="node19" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1153,5,1193,33"/><area shape="rect" id="node21" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1331,18,1397,46"/><area shape="rect" id="node27" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="1064,106,1283,134"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aaabf16b5e99c9ac6bc6bbe039756bddb"></a><!-- doxytag: member="forcetree.c::force_exchange_pseudodata" ref="aaabf16b5e99c9ac6bc6bbe039756bddb" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#aaabf16b5e99c9ac6bc6bbe039756bddb">force_exchange_pseudodata</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function communicates the values of the multipole moments of the top-level tree-nodes of the domain grid. This data can then be used to update the pseudo-particles on each CPU accordingly. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00684">684</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00065">DomainMoment</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="tags_8h_source.html#l00010">TAG_DMOM</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00671">force_update_pseudoparticles()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no;
  MPI_Status status;
  <span class="keywordtype">int</span> level, sendTask, recvTask;

  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>; i &lt;= <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <span class="comment">/* read out the multipole moments from the local base cells */</span>
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[0];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[1];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[2];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].vs[0] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[0];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].vs[1] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[1];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].vs[2] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[2];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].mass = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.mass;
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].bitflags = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].maxsoft = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="comment">/* share the pseudo-particle data accross CPUs */</span>

  <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
    {
      sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
      recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ level;

      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[sendTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask] + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> DomainNODE),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a45efe3f9114b060471619398972c9d84">TAG_DMOM</a>,
                     &amp;<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[recvTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask] + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> DomainNODE),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a45efe3f9114b060471619398972c9d84">TAG_DMOM</a>, MPI_COMM_WORLD, &amp;status);
    }

}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_aaabf16b5e99c9ac6bc6bbe039756bddb_icgraph.png" border="0" usemap="#forcetree_8c_aaabf16b5e99c9ac6bc6bbe039756bddb_icgraph" alt=""/></div>
<map name="forcetree_8c_aaabf16b5e99c9ac6bc6bbe039756bddb_icgraph" id="forcetree_8c_aaabf16b5e99c9ac6bc6bbe039756bddb_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="263,57,476,85"/><area shape="rect" id="node5" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="527,94,644,122"/><area shape="rect" id="node28" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="527,18,644,46"/><area shape="rect" id="node7" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="716,106,815,134"/><area shape="rect" id="node15" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="711,157,820,185"/><area shape="rect" id="node22" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="695,55,836,83"/><area shape="rect" id="node9" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="909,106,1080,134"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1164,81,1207,109"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1268,106,1321,134"/><area shape="rect" id="node17" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="975,157,1015,185"/><area shape="rect" id="node19" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1152,131,1219,159"/><area shape="rect" id="node25" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="885,5,1104,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a947a734f3bbba14d4092c7480880d3c7"></a><!-- doxytag: member="forcetree.c::force_flag_localnodes" ref="a947a734f3bbba14d4092c7480880d3c7" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a947a734f3bbba14d4092c7480880d3c7">force_flag_localnodes</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function flags nodes in the top-level tree that are dependent on local particle data. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00834">834</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, and <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> no, i;

  <span class="comment">/* mark all top-level nodes */</span>

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <span class="keywordflow">while</span>(no &gt;= 0)
        {
          <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &amp; 1))
            <span class="keywordflow">break</span>;

          <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags |= 1;

          no = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.father;
        }
    }

  <span class="comment">/* mark top-level nodes that contain local particles */</span>

  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>; i &lt;= <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>; i++)
    {
      <span class="comment">/*</span>
<span class="comment">         if(DomainMoment[i].mass &gt; 0)</span>
<span class="comment">       */</span>
      {
        no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

        <span class="keywordflow">while</span>(no &gt;= 0)
          {
            <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &amp; 2))
              <span class="keywordflow">break</span>;

            <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags |= 2;

            no = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.father;
          }
      }
    }
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a947a734f3bbba14d4092c7480880d3c7_icgraph.png" border="0" usemap="#forcetree_8c_a947a734f3bbba14d4092c7480880d3c7_icgraph" alt=""/></div>
<map name="forcetree_8c_a947a734f3bbba14d4092c7480880d3c7_icgraph" id="forcetree_8c_a947a734f3bbba14d4092c7480880d3c7_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="213,55,331,83"/><area shape="rect" id="node5" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="401,55,500,83"/><area shape="rect" id="node13" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="396,5,505,33"/><area shape="rect" id="node20" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="380,106,521,134"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="595,55,765,83"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="849,81,892,109"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="953,50,1007,78"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="660,5,700,33"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="837,18,904,46"/><area shape="rect" id="node23" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="571,106,789,134"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad9e0a57b7577d64a315c142e197d292d"></a><!-- doxytag: member="forcetree.c::force_insert_pseudo_particles" ref="ad9e0a57b7577d64a315c142e197d292d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#ad9e0a57b7577d64a315c142e197d292d">force_insert_pseudo_particles</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>this function inserts pseudo-particles which will represent the mass distribution of the other CPUs. Initially, the mass of the pseudo-particles is set to zero, and their coordinate is set to the center of the domain-cell they correspond to. These quantities will be updated later on. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00346">346</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8c_source.html#l00065">DomainMoment</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, and <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, index, subnode, nn, th;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    {
      index = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].mass = 0;
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[index].center[0];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[index].center[1];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[index].center[2];
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    {
      <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>)
        {
          th = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;     <span class="comment">/* select index of first node in tree */</span>

          <span class="keywordflow">while</span>(1)
            {
              <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)     <span class="comment">/* we are dealing with an internal node */</span>
                {
                  <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)
                    <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(888);        <span class="comment">/* this can&#39;t be */</span>

                  subnode = 0;
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[0] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[0])
                    subnode += 1;
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[1] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[1])
                    subnode += 2;
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[2] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[2])
                    subnode += 4;

                  nn = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].u.suns[subnode];

                  <span class="keywordflow">if</span>(nn &gt;= 0)   <span class="comment">/* ok, something is in the daughter slot already, need to continue */</span>
                    {
                      th = nn;
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="comment">/* here we have found an empty slot where we can </span>
<span class="comment">                       * attach the pseudo particle as a leaf </span>
<span class="comment">                       */</span>
                      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].u.suns[subnode] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> + i;

                      <span class="keywordflow">break</span>;    <span class="comment">/* done for this pseudo particle */</span>
                    }
                }
              <span class="keywordflow">else</span>
                {
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(889);  <span class="comment">/* this can&#39;t be */</span>
                }
            }
        }
    }
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ad9e0a57b7577d64a315c142e197d292d_cgraph.png" border="0" usemap="#forcetree_8c_ad9e0a57b7577d64a315c142e197d292d_cgraph" alt=""/></div>
<map name="forcetree_8c_ad9e0a57b7577d64a315c142e197d292d_cgraph" id="forcetree_8c_ad9e0a57b7577d64a315c142e197d292d_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="267,5,333,33"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="381,5,539,33"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ad9e0a57b7577d64a315c142e197d292d_icgraph.png" border="0" usemap="#forcetree_8c_ad9e0a57b7577d64a315c142e197d292d_icgraph" alt=""/></div>
<map name="forcetree_8c_ad9e0a57b7577d64a315c142e197d292d_icgraph" id="forcetree_8c_ad9e0a57b7577d64a315c142e197d292d_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="268,55,428,83"/><area shape="rect" id="node5" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="477,55,595,83"/><area shape="rect" id="node7" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="665,55,764,83"/><area shape="rect" id="node15" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="660,5,769,33"/><area shape="rect" id="node22" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="644,106,785,134"/><area shape="rect" id="node9" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="859,55,1029,83"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1113,81,1156,109"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1217,50,1271,78"/><area shape="rect" id="node17" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="924,5,964,33"/><area shape="rect" id="node19" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1101,18,1168,46"/><area shape="rect" id="node25" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="835,106,1053,134"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab98788ba31869c7bc55ce71b807d2ff2"></a><!-- doxytag: member="forcetree.c::force_treeallocate" ref="ab98788ba31869c7bc55ce71b807d2ff2" args="(int maxnodes, int maxpart)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>maxnodes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>maxpart</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function allocates the memory used for storage of the tree and of auxiliary arrays needed for tree-walk and link-lists. Usually, maxnodes approximately equal to 0.7*maxpart is sufficient to store the tree for up to maxpart particles. </p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02911">2911</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes_base</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="forcetree_8c_source.html#l00036">first_flag</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes_base</a>, <a class="el" href="forcetree_8c_source.html#l00031">NTAB</a>, <a class="el" href="forcetree_8c_source.html#l00033">shortrange_table</a>, <a class="el" href="forcetree_8c_source.html#l00033">shortrange_table_potential</a>, <a class="el" href="forcetree_8c_source.html#l00033">tabfac</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l00020">init()</a>, <a class="el" href="pm__periodic_8c_source.html#l00180">pmforce_periodic()</a>, <a class="el" href="pm__periodic_8c_source.html#l00693">pmpotential_periodic()</a>, and <a class="el" href="restart_8c_source.html#l00035">restart()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;
  <span class="keywordtype">size_t</span> bytes;
  <span class="keywordtype">double</span> allbytes = 0;
  <span class="keywordtype">double</span> u;

  <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> = maxnodes;

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a> = malloc(bytes = (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> NODE))))
    {
      printf(<span class="stringliteral">&quot;failed to allocate memory for %d tree-nodes (%g MB).\n&quot;</span>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>, bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(3);
    }
  allbytes += bytes;

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a57932378336b142ac6e6a9ddb60dce3f">Extnodes_base</a> = malloc(bytes = (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> extNODE))))
    {
      printf(<span class="stringliteral">&quot;failed to allocate memory for %d tree-extnodes (%g MB).\n&quot;</span>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>,
             bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(3);
    }
  allbytes += bytes;

  <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a> = <a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;
  <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a> = <a class="code" href="allvars_8c.html#a57932378336b142ac6e6a9ddb60dce3f">Extnodes_base</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a> = malloc(bytes = (maxpart + MAXTOPNODES) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))))
    {
      printf(<span class="stringliteral">&quot;Failed to allocate %d spaces for &#39;Nextnode&#39; array (%g MB)\n&quot;</span>, maxpart + MAXTOPNODES,
             bytes / (1024.0 * 1024.0));
      exit(0);
    }
  allbytes += bytes;

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a> = malloc(bytes = (maxpart) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))))
    {
      printf(<span class="stringliteral">&quot;Failed to allocate %d spaces for &#39;Father&#39; array (%g MB)\n&quot;</span>, maxpart, bytes / (1024.0 * 1024.0));
      exit(0);
    }
  allbytes += bytes;

  <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a37ea0ff529d9c7e76f1f7895bde01183">first_flag</a> == 0)
    {
      <a class="code" href="forcetree_8c.html#a37ea0ff529d9c7e76f1f7895bde01183">first_flag</a> = 1;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nAllocated %g MByte for BH-tree. %lu\n\n&quot;</span>, allbytes / (1024.0 * 1024.0),
               <span class="keyword">sizeof</span>(<span class="keyword">struct</span> NODE) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> extNODE));

      <a class="code" href="forcetree_8c.html#abe941030bf66a95df993b617bffefd9b">tabfac</a> = <a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a> / 3.0;

      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a>; i++)
        {
          u = 3.0 / NTAB * (i + 0.5);
          <a class="code" href="forcetree_8c.html#a76b621ce2fa9c17911a62495174029eb">shortrange_table</a>[i] = erfc(u) + 2.0 * u / sqrt(M_PI) * exp(-u * u);
          <a class="code" href="forcetree_8c.html#a196b7c27d03bd3ecc1259b2f67017fbe">shortrange_table_potential</a>[i] = erfc(u);
        }
    }
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ab98788ba31869c7bc55ce71b807d2ff2_cgraph.png" border="0" usemap="#forcetree_8c_ab98788ba31869c7bc55ce71b807d2ff2_cgraph" alt=""/></div>
<map name="forcetree_8c_ab98788ba31869c7bc55ce71b807d2ff2_cgraph" id="forcetree_8c_ab98788ba31869c7bc55ce71b807d2ff2_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="192,5,259,33"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="307,5,464,33"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ab98788ba31869c7bc55ce71b807d2ff2_icgraph.png" border="0" usemap="#forcetree_8c_ab98788ba31869c7bc55ce71b807d2ff2_icgraph" alt=""/></div>
<map name="forcetree_8c_ab98788ba31869c7bc55ce71b807d2ff2_icgraph" id="forcetree_8c_ab98788ba31869c7bc55ce71b807d2ff2_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="251,5,291,33"/><area shape="rect" id="node9" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="205,106,336,134"/><area shape="rect" id="node18" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="193,157,348,185"/><area shape="rect" id="node26" href="restart_8c.html#ae81d30f52dddd39aef76bb1890d16f2f" title="restart" alt="" coords="239,55,303,83"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="436,5,503,33"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="948,55,1001,83"/><area shape="rect" id="node11" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="404,106,535,134"/><area shape="rect" id="node13" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="613,106,784,134"/><area shape="rect" id="node15" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="856,106,899,134"/><area shape="rect" id="node20" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="399,157,540,185"/><area shape="rect" id="node23" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="589,157,808,185"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a10f92098e86f82baec9f84a283f4c9e5"></a><!-- doxytag: member="forcetree.c::force_treebuild" ref="a10f92098e86f82baec9f84a283f4c9e5" args="(int npart)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5">force_treebuild</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>npart</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is a driver routine for constructing the gravitational oct-tree, which is done by calling a small number of other functions. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00061">61</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="forcetree_8c_source.html#l00834">force_flag_localnodes()</a>, <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>, <a class="el" href="forcetree_8c_source.html#l00671">force_update_pseudoparticles()</a>, <a class="el" href="allvars_8c_source.html#l00140">Numnodestree</a>, and <a class="el" href="allvars_8c_source.html#l00081">TimeOfLastTreeConstruction</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>, and <a class="el" href="ngb_8c_source.html#l00403">ngb_treebuild()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a> = <a class="code" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6">force_treebuild_single</a>(npart);

  <a class="code" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0">force_update_pseudoparticles</a>();

  <a class="code" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7">force_flag_localnodes</a>();

  <a class="code" href="allvars_8c.html#ae43d9623e3a2c88558e99ecf90948906">TimeOfLastTreeConstruction</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Time;

  <span class="keywordflow">return</span> <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a>;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a10f92098e86f82baec9f84a283f4c9e5_cgraph.png" border="0" usemap="#forcetree_8c_a10f92098e86f82baec9f84a283f4c9e5_cgraph" alt=""/></div>
<map name="forcetree_8c_a10f92098e86f82baec9f84a283f4c9e5_cgraph" id="forcetree_8c_a10f92098e86f82baec9f84a283f4c9e5_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7" title="force_flag_localnodes" alt="" coords="200,155,357,183"/><area shape="rect" id="node5" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="199,206,359,234"/><area shape="rect" id="node32" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="172,407,385,435"/><area shape="rect" id="node7" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="443,79,637,107"/><area shape="rect" id="node9" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="703,29,823,57"/><area shape="rect" id="node13" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="1141,130,1208,158"/><area shape="rect" id="node19" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="693,130,832,158"/><area shape="rect" id="node22" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="461,231,619,259"/><area shape="rect" id="node26" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="881,257,1092,285"/><area shape="rect" id="node29" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="435,357,645,385"/><area shape="rect" id="node11" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="945,29,1028,57"/><area shape="rect" id="node15" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1256,130,1413,158"/><area shape="rect" id="node34" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb" title="force_exchange_pseudodata" alt="" coords="437,407,643,435"/><area shape="rect" id="node36" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19" title="force_treeupdate_pseudos" alt="" coords="444,458,636,486"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a10f92098e86f82baec9f84a283f4c9e5_icgraph.png" border="0" usemap="#forcetree_8c_a10f92098e86f82baec9f84a283f4c9e5_icgraph" alt=""/></div>
<map name="forcetree_8c_a10f92098e86f82baec9f84a283f4c9e5_icgraph" id="forcetree_8c_a10f92098e86f82baec9f84a283f4c9e5_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="172,31,313,59"/><area shape="rect" id="node12" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="193,82,292,110"/><area shape="rect" id="node17" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="188,132,297,160"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="641,56,684,84"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="363,31,581,59"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="745,82,799,110"/><area shape="rect" id="node14" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="387,82,557,110"/><area shape="rect" id="node19" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="452,132,492,160"/><area shape="rect" id="node21" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="629,107,696,135"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aadc9b1624ed78f3ccd0dbb9908fe0bb6"></a><!-- doxytag: member="forcetree.c::force_treebuild_single" ref="aadc9b1624ed78f3ccd0dbb9908fe0bb6" args="(int npart)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6">force_treebuild_single</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>npart</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Constructs the gravitational oct-tree.</p>
<p>The index convention for accessing tree nodes is the following: the indices 0...NumPart-1 reference single particles, the indices All.MaxPart.... All.MaxPart+nodes-1 reference tree nodes. `Nodes_base' points to the first tree node, while `nodes' is shifted such that nodes[All.MaxPart] gives the first tree node. Finally, node indices with values 'All.MaxPart + MaxNodes' and larger indicate "pseudo
  particles", i.e. multipole moments of top-level nodes that lie on different CPUs. If such a node needs to be opened, the corresponding particle must be exported to that CPU. The 'Extnodes' structure parallels that of 'Nodes'. Its information is only needed for the SPH part of the computation. (The data is split onto these two structures as a tuning measure. If it is merged into 'Nodes' a somewhat bigger size of the nodes also for gravity would result, which would reduce cache utilization slightly. </p>
<p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined as type int, the allowed maximum is 10. If 64-bit integers are used, the maximum is 21 </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00093">93</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8c_source.html#l00049">DomainCenter</a>, <a class="el" href="allvars_8c_source.html#l00048">DomainCorner</a>, <a class="el" href="allvars_8c_source.html#l00051">DomainFac</a>, <a class="el" href="allvars_8c_source.html#l00050">DomainLen</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="forcetree_8c_source.html#l03124">dump_particles()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, <a class="el" href="forcetree_8c_source.html#l00346">force_insert_pseudo_particles()</a>, <a class="el" href="forcetree_8c_source.html#l00422">force_update_node_recursive()</a>, <a class="el" href="system_8c_source.html#l00029">get_random_number()</a>, <a class="el" href="forcetree_8c_source.html#l00026">last</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="peano_8c_source.html#l00263">peano_hilbert_key()</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, subnode = 0, parent, numnodes;
  <span class="keywordtype">int</span> nfree, th, nn, no;
  <span class="keyword">struct </span>NODE *nfreep;
  <span class="keywordtype">double</span> lenhalf, epsilon;
  peanokey key;


  <span class="comment">/* create an empty root node  */</span>
  nfree = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;          <span class="comment">/* index of first free node */</span>
  nfreep = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[nfree];       <span class="comment">/* select first node */</span>

  nfreep-&gt;len = <a class="code" href="allvars_8c.html#a3dd9593672bf68f0c36fa3e5451e9265">DomainLen</a>;
  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    nfreep-&gt;center[j] = <a class="code" href="allvars_8c.html#ad13aabcbb50307c005ffa0b2edccdaeb">DomainCenter</a>[j];
  <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
    nfreep-&gt;u.suns[j] = -1;


  numnodes = 1;
  nfreep++;
  nfree++;

  <span class="comment">/* create a set of empty nodes corresponding to the top-level domain</span>
<span class="comment">   * grid. We need to generate these nodes first to make sure that we have a</span>
<span class="comment">   * complete top-level tree which allows the easy insertion of the</span>
<span class="comment">   * pseudo-particles at the right place </span>
<span class="comment">   */</span>

  <a class="code" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89">force_create_empty_nodes</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart, 0, 1, 0, 0, 0, &amp;numnodes, &amp;nfree);


  <span class="comment">/* if a high-resolution region in a global tree is used, we need to generate</span>
<span class="comment">   * an additional set empty nodes to make sure that we have a complete</span>
<span class="comment">   * top-level tree for the high-resolution inset</span>
<span class="comment">   */</span>

  nfreep = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[nfree];
  parent = -1;                  <span class="comment">/* note: will not be used below before it is changed */</span>


  <span class="comment">/* now we insert all particles */</span>
  <span class="keywordflow">for</span>(i = 0; i &lt; npart; i++)
    {

      <span class="comment">/* the softening is only used to check whether particles are so close</span>
<span class="comment">       * that the tree needs not to be refined further</span>
<span class="comment">       */</span>
      epsilon = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type];

      key = <a class="code" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df">peano_hilbert_key</a>((<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[0]) * <a class="code" href="allvars_8c.html#a4488078cfcc203156f193c43a1d3a2ef">DomainFac</a>,
                              (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[1] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[1]) * DomainFac,
                              (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[2] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[2]) * DomainFac, BITS_PER_DIMENSION);

      no = 0;
      <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter &gt;= 0)
        no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter + (key - <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].StartKey) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Size / 8);

      no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Leaf;
      th = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[no];

      <span class="keywordflow">while</span>(1)
        {
          <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart) <span class="comment">/* we are dealing with an internal node */</span>
            {
              subnode = 0;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[0])
                subnode += 1;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[1] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[1])
                subnode += 2;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[2] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[2])
                subnode += 4;

              nn = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].u.suns[subnode];

              <span class="keywordflow">if</span>(nn &gt;= 0)       <span class="comment">/* ok, something is in the daughter slot already, need to continue */</span>
                {
                  parent = th;
                  th = nn;
                }
              <span class="keywordflow">else</span>
                {
                  <span class="comment">/* here we have found an empty slot where we can attach</span>
<span class="comment">                   * the new particle as a leaf.</span>
<span class="comment">                   */</span>
                  <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].u.suns[subnode] = i;
                  <span class="keywordflow">break</span>;        <span class="comment">/* done for this particle */</span>
                }
            }
          <span class="keywordflow">else</span>
            {
              <span class="comment">/* We try to insert into a leaf with a single particle.  Need</span>
<span class="comment">               * to generate a new internal node at this point.</span>
<span class="comment">               */</span>
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].u.suns[subnode] = nfree;

              nfreep-&gt;len = 0.5 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].len;
              lenhalf = 0.25 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].len;

              <span class="keywordflow">if</span>(subnode &amp; 1)
                nfreep-&gt;center[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].center[0] + lenhalf;
              <span class="keywordflow">else</span>
                nfreep-&gt;center[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].center[0] - lenhalf;

              <span class="keywordflow">if</span>(subnode &amp; 2)
                nfreep-&gt;center[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].center[1] + lenhalf;
              <span class="keywordflow">else</span>
                nfreep-&gt;center[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].center[1] - lenhalf;

              <span class="keywordflow">if</span>(subnode &amp; 4)
                nfreep-&gt;center[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].center[2] + lenhalf;
              <span class="keywordflow">else</span>
                nfreep-&gt;center[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].center[2] - lenhalf;

              nfreep-&gt;u.suns[0] = -1;
              nfreep-&gt;u.suns[1] = -1;
              nfreep-&gt;u.suns[2] = -1;
              nfreep-&gt;u.suns[3] = -1;
              nfreep-&gt;u.suns[4] = -1;
              nfreep-&gt;u.suns[5] = -1;
              nfreep-&gt;u.suns[6] = -1;
              nfreep-&gt;u.suns[7] = -1;


              subnode = 0;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[th].Pos[0] &gt; nfreep-&gt;center[0])
                subnode += 1;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[th].Pos[1] &gt; nfreep-&gt;center[1])
                subnode += 2;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[th].Pos[2] &gt; nfreep-&gt;center[2])
                subnode += 4;
<span class="preprocessor">#ifndef NOTREERND</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(nfreep-&gt;len &lt; 1.0e-3 * epsilon)
                {
                  <span class="comment">/* seems like we&#39;re dealing with particles at identical (or extremely close)</span>
<span class="comment">                   * locations. Randomize subnode index to allow tree construction. Note: Multipole moments</span>
<span class="comment">                   * of tree are still correct, but this will only happen well below gravitational softening</span>
<span class="comment">                   * length-scale anyway.</span>
<span class="comment">                   */</span>
                  subnode = (int) (8.0 * <a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>((0xffff &amp; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].ID) + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravCost));
                  <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravCost += 1;
                  <span class="keywordflow">if</span>(subnode &gt;= 8)
                    subnode = 7;
                }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              nfreep-&gt;u.suns[subnode] = th;

              th = nfree;       <span class="comment">/* resume trying to insert the new particle at</span>
<span class="comment">                                 * the newly created internal node</span>
<span class="comment">                                 */</span>

              numnodes++;
              nfree++;
              nfreep++;

              <span class="keywordflow">if</span>((numnodes) &gt;= <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)
                {
                  printf(<span class="stringliteral">&quot;task %d: maximum number %d of tree-nodes reached.\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>);
                  printf(<span class="stringliteral">&quot;for particle %d\n&quot;</span>, i);
                  <a class="code" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0">dump_particles</a>();
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
                }
            }
        }
    }


  <span class="comment">/* insert the pseudo particles that represent the mass distribution of other domains */</span>
  <a class="code" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d">force_insert_pseudo_particles</a>();


  <span class="comment">/* now compute the multipole moments recursively */</span>
  <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> = -1;

  <a class="code" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d">force_update_node_recursive</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart, -1, -1);

  <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)
    {
      <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)        <span class="comment">/* a pseudo-particle */</span>
        <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>] = -1;
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>].u.d.nextnode = -1;
    }
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>] = -1;

  <span class="keywordflow">return</span> numnodes;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_aadc9b1624ed78f3ccd0dbb9908fe0bb6_cgraph.png" border="0" usemap="#forcetree_8c_aadc9b1624ed78f3ccd0dbb9908fe0bb6_cgraph" alt=""/></div>
<map name="forcetree_8c_aadc9b1624ed78f3ccd0dbb9908fe0bb6_cgraph" id="forcetree_8c_aadc9b1624ed78f3ccd0dbb9908fe0bb6_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="484,49,604,77"/><area shape="rect" id="node7" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="923,75,989,103"/><area shape="rect" id="node12" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="224,100,419,128"/><area shape="rect" id="node17" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="475,151,613,179"/><area shape="rect" id="node19" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="663,176,873,204"/><area shape="rect" id="node22" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="216,276,427,304"/><area shape="rect" id="node25" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="243,327,400,355"/><area shape="rect" id="node5" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="727,49,809,77"/><area shape="rect" id="node9" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1037,75,1195,103"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_aadc9b1624ed78f3ccd0dbb9908fe0bb6_icgraph.png" border="0" usemap="#forcetree_8c_aadc9b1624ed78f3ccd0dbb9908fe0bb6_icgraph" alt=""/></div>
<map name="forcetree_8c_aadc9b1624ed78f3ccd0dbb9908fe0bb6_icgraph" id="forcetree_8c_aadc9b1624ed78f3ccd0dbb9908fe0bb6_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="216,55,333,83"/><area shape="rect" id="node5" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="404,55,503,83"/><area shape="rect" id="node13" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="399,5,508,33"/><area shape="rect" id="node20" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="383,106,524,134"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="597,55,768,83"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="852,81,895,109"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="956,50,1009,78"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="663,5,703,33"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="840,18,907,46"/><area shape="rect" id="node23" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="573,106,792,134"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a59ae74ef51d6a7065605638422489391"></a><!-- doxytag: member="forcetree.c::force_treeevaluate" ref="a59ae74ef51d6a7065605638422489391" args="(int target, int mode, double *ewaldcountsum)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="proto_8h.html#a59ae74ef51d6a7065605638422489391">force_treeevaluate</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>ewaldcountsum</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine computes the gravitational force for a given local particle, or for a particle in the communication buffer. Depending on the value of TypeOfOpeningCriterion, either the geometrical BH cell-opening criterion, or the `relative' opening criterion is used. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01126">1126</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="sidm__routines_8c_source.html#l00094">calculate_interact_kick()</a>, <a class="el" href="sidm__routines_8c_source.html#l00282">check_interaction_table()</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="forcetree_8c_source.html#l02018">force_treeevaluate_ewald_correction()</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="sidm__routines_8c_source.html#l00032">prob_of_interaction()</a>, <a class="el" href="allvars_8c_source.html#l00043">random_generator</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, and <a class="el" href="sidm__routines_8c_source.html#l00205">update_interaction_table()</a>.</p>

<p>Referenced by <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span>NODE *nop = 0;
  <span class="keywordtype">int</span> no, ninteractions, ptype;
  <span class="keywordtype">double</span> r2, dx, dy, dz, mass, r, fac, u, h, h_inv, h3_inv;
  <span class="keywordtype">double</span> acc_x, acc_y, acc_z, pos_x, pos_y, pos_z, aold;
<span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center,kick_x,kick_y,kick_z,kick_target[3],kick_no[3],prob,prob_tmp,max_prob;
  FLOAT  targetVel[3];
  <span class="keywordtype">int</span> targetBegstep,targetEndstep,targetdTi_selfInt;
  IDTYPE targetID;              
  <span class="keywordtype">int</span> si_count,i;
  kick_x = 0;
  kick_y = 0;
  kick_z = 0;
  si_count = 0;
  max_prob = 0;
  <span class="keywordflow">if</span>(mode == 0)
  {
    <span class="keywordflow">for</span>(i=0;i&lt;3;i++)
      targetVel[i] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[i];
    targetBegstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Ti_begstep;
    targetEndstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Ti_endstep;
    targetID      = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].ID;
    targetdTi_selfInt = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].dTi_selfInt;
  }
  <span class="keywordflow">else</span>
  {
    <span class="keywordflow">for</span>(i=0;i&lt;3;i++)
      targetVel[i] = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Vel[i];
    targetBegstep = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Ti_begstep;
    targetEndstep = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Ti_endstep;
    targetID      = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].ID;
    targetdTi_selfInt =  <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].dTi_selfInt;
  }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  acc_x = 0;
  acc_y = 0;
  acc_z = 0;
  ninteractions = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Type;
      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolForceAcc * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].OldAcc;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].Hsml;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].Type;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK      </span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolForceAcc * <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].w.OldAcc;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Soft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }



<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
  h_inv = 1.0 / h;
  h3_inv = h_inv * h_inv * h_inv;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;             <span class="comment">/* root node */</span>

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)      <span class="comment">/* single particle */</span>
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          <span class="comment">/* observe the sign */</span>

          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[2] - pos_z;

          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Mass;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }
          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          dx = nop-&gt;u.d.s[0] - pos_x;
          dy = nop-&gt;u.d.s[1] - pos_y;
          dz = nop-&gt;u.d.s[2] - pos_z;

          mass = nop-&gt;u.d.mass;
        }
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
      dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
      dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 0)
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml)
                h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type])
                h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type];
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
          <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type])
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span> (targetID != <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID)
            {
              <span class="keywordflow">if</span> (ptype == 1 &amp;&amp; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 1) 
              <span class="comment">//if ((ptype == 1 &amp;&amp; P[no].Type == 4) || (ptype == 4 &amp;&amp; P[no].Type == 1) ) /*Use this for Test1 and Test2 only*/</span>
                {
                  r = sqrt(r2);
                  <span class="keywordflow">if</span> (r &lt; 2.0*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.SIDMSmoothingFactor*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[1])
                    {
                      <span class="keywordflow">if</span> (<a class="code" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4">check_interaction_table</a>(targetID,<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID) == 0)
                        {
                          prob = <a class="code" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8">prob_of_interaction</a>(r, targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, targetBegstep, targetEndstep);
                          <span class="keywordflow">if</span>(prob &gt; max_prob) max_prob = prob;
                          
                          <span class="keywordflow">if</span>(prob &gt; 0.2)
                            {
                              <span class="keywordflow">if</span>(targetdTi_selfInt == 0 || <a class="code" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8">prob_of_interaction</a>(r, targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, 0, targetdTi_selfInt) &gt; 0.2)
                                {
                                  targetdTi_selfInt = targetEndstep-targetBegstep;
                                  prob_tmp = prob;
                                  <span class="keywordflow">while</span>(prob_tmp &gt; 0.2)
                                    {
                                      targetdTi_selfInt /= 2; 
                                      prob_tmp = <a class="code" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8">prob_of_interaction</a>(r, targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, 0, targetdTi_selfInt); 
                                    }
                                }
                            }
                          
                          <span class="keywordflow">if</span> (gsl_rng_uniform(<a class="code" href="allvars_8c.html#a4ec93729b85eb5da23dd6ffb23c3702b">random_generator</a>) &lt; prob)
                            {
                              <a class="code" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9">calculate_interact_kick</a>(targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, kick_target, kick_no); 
                              kick_x += kick_target[0];
                              kick_y += kick_target[1];
                              kick_z += kick_target[2];
                              <span class="keywordflow">for</span> (i = 0; i &lt; 3 ; i++)
                                <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel[i] += kick_no[i];
                              <span class="comment">//if(sqrt(pos_x*pos_x + pos_y*pos_y + pos_z*pos_z) &gt; 127.0 &amp;&amp; sqrt(pos_x*pos_x + pos_y*pos_y + pos_z*pos_z) &lt; 167.0 ) /* This if statement is for the sake of Test1 only. REMOVE FOR ANY OTHER RUNS!!.*/</span>
                              si_count+=1;
                              <a class="code" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615">update_interaction_table</a>(targetID,<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID);
                            }                   
                        }
                    }
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          
          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
        {
          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;u.d.bitflags &amp; 3) == 1)  <span class="comment">/* if it&#39;s a top-level node</span>
<span class="comment">                                                 * which does not contain</span>
<span class="comment">                                                 * local particles we can</span>
<span class="comment">                                                 * continue to do a short-cut */</span>
                {
                  no = nop-&gt;u.d.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;center[0] - pos_x)*(nop-&gt;center[0] - pos_x) + 
                                (nop-&gt;center[1] - pos_y)*(nop-&gt;center[1] - pos_y) +
                                (nop-&gt;center[2] - pos_z)*(nop-&gt;center[2] - pos_z));
           <span class="comment">/* check if any portion the cell lies withing the intercation range */</span>
          <span class="keywordflow">if</span>(dist_to_center - nop-&gt;len*sqrt(3.0)/2.0 &lt; 2.0*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.SIDMSmoothingFactor*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[1])
            {
              <span class="comment">/* open cell */</span>
              no = nop-&gt;u.d.nextnode;
              <span class="keywordflow">continue</span>;
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;len * nop-&gt;len &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;len * nop-&gt;len &gt; r2 * r2 * aold)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="comment">/* check in addition whether we lie inside the cell */</span>

              <span class="keywordflow">if</span>(fabs(nop-&gt;center[0] - pos_x) &lt; 0.60 * nop-&gt;len)
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;center[1] - pos_y) &lt; 0.60 * nop-&gt;len)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;center[2] - pos_z) &lt; 0.60 * nop-&gt;len)
                        {
                          no = nop-&gt;u.d.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
          maxsofttype = (nop-&gt;u.d.bitflags &gt;&gt; 2) &amp; 7;
          <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
            {
              <span class="keywordflow">if</span>(mass &gt; 0)
                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(986);
              no = nop-&gt;u.d.nextnode;
              <span class="keywordflow">continue</span>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                {
                  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype];
                  <span class="keywordflow">if</span>(r2 &lt; h * h)
                    {
                      <span class="keywordflow">if</span>(((nop-&gt;u.d.bitflags &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
                        {
                          no = nop-&gt;u.d.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];

          <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
            {
              h = nop-&gt;maxsoft;
              <span class="keywordflow">if</span>(r2 &lt; h * h)
                {
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          no = nop-&gt;u.d.sibling;        <span class="comment">/* ok, node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>(((nop-&gt;u.d.bitflags) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      r = sqrt(r2);

      <span class="keywordflow">if</span>(r &gt;= h)
        fac = mass / (r2 * r);
      <span class="keywordflow">else</span>
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>          h_inv = 1.0 / h;
          h3_inv = h_inv * h_inv * h_inv;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          u = r * h_inv;
          <span class="keywordflow">if</span>(u &lt; 0.5)
            fac = mass * h3_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
          <span class="keywordflow">else</span>
            fac =
              mass * h3_inv * (21.333333333333 - 48.0 * u +
                               38.4 * u * u - 10.666666666667 * u * u * u - 0.066666666667 / (u * u * u));
        }
      
        acc_x += dx * fac;
        acc_y += dy * fac;
        acc_z += dz * fac;

      ninteractions++;
    }
  
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK </span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactions += si_count;
  <span class="keywordflow">if</span>(max_prob &lt; 0.1 &amp;&amp; max_prob &gt; 0 &amp;&amp; mode == 0 &amp;&amp; targetdTi_selfInt &gt; 0)
    {
      <span class="keywordflow">while</span>(max_prob &lt; 0.1)
        {
          targetdTi_selfInt *= 2; 
          max_prob *= 2.0;
        }
    }

  <span class="comment">/*for test2 we want to turn off gravity for all the particles</span>
<span class="comment">  acc_x = 0.0;</span>
<span class="comment">  acc_y = 0.0;</span>
<span class="comment">  acc_z = 0.0;*/</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">/* store result at the proper place */</span>
  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[0] = acc_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[1] = acc_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[2] = acc_z;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravCost = ninteractions;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[0] += kick_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[1] += kick_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[2] += kick_z;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].dTi_selfInt = targetdTi_selfInt;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[0] = acc_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[1] = acc_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[2] = acc_z;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].w.Ninteractions = ninteractions;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[0] = kick_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[1] = kick_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[2] = kick_z;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].dTi_selfInt = targetdTi_selfInt;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  *ewaldcountsum += <a class="code" href="forcetree_8c.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f">force_treeevaluate_ewald_correction</a>(target, mode, pos_x, pos_y, pos_z, aold);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">return</span> ninteractions;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a59ae74ef51d6a7065605638422489391_cgraph.png" border="0" usemap="#forcetree_8c_a59ae74ef51d6a7065605638422489391_cgraph" alt=""/></div>
<map name="forcetree_8c_a59ae74ef51d6a7065605638422489391_cgraph" id="forcetree_8c_a59ae74ef51d6a7065605638422489391_cgraph">
<area shape="rect" id="node3" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9" title="calculate_interact_kick" alt="" coords="243,5,408,33"/><area shape="rect" id="node5" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4" title="check_interaction_table" alt="" coords="239,55,412,83"/><area shape="rect" id="node7" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="501,157,568,185"/><area shape="rect" id="node11" href="forcetree_8c.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f" title="force_treeevaluate_ewald_correction" alt="" coords="197,157,453,185"/><area shape="rect" id="node13" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8" title="prob_of_interaction" alt="" coords="253,258,397,286"/><area shape="rect" id="node17" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615" title="update_interaction_table" alt="" coords="235,207,416,235"/><area shape="rect" id="node9" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="616,157,773,185"/><area shape="rect" id="node15" href="sidm__routines_8c.html#ab5ff10bfb368309b0dd01aaa72c6be1d" title="g_geo" alt="" coords="504,258,565,286"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a59ae74ef51d6a7065605638422489391_icgraph.png" border="0" usemap="#forcetree_8c_a59ae74ef51d6a7065605638422489391_icgraph" alt=""/></div>
<map name="forcetree_8c_a59ae74ef51d6a7065605638422489391_icgraph" id="forcetree_8c_a59ae74ef51d6a7065605638422489391_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="197,5,296,33"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="344,5,515,33"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="563,5,605,33"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="655,5,708,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0ec221b2517893874b12dc366bfe0da8"></a><!-- doxytag: member="forcetree.c::force_treeevaluate_direct" ref="a0ec221b2517893874b12dc366bfe0da8" args="(int target, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="proto_8h.html#a0ec221b2517893874b12dc366bfe0da8">force_treeevaluate_direct</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>mode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function does the force computation with direct summation for the specified particle in the communication buffer. This can be useful for debugging purposes, in particular for explicit checks of the force accuracy. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02993">2993</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="forcetree_8c_source.html#l03312">ewald_corr()</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, and <a class="el" href="allvars_8c_source.html#l00120">P</a>.</p>

<p>Referenced by <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> epsilon;
  <span class="keywordtype">double</span> h, h_inv, dx, dy, dz, r, r2, u, r_inv, fac;
  <span class="keywordtype">int</span> i, ptype;
  <span class="keywordtype">double</span> pos_x, pos_y, pos_z;
  <span class="keywordtype">double</span> acc_x, acc_y, acc_z;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> fcorr[3];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  acc_x = 0;
  acc_y = 0;
  acc_z = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Type;
    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].Type;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      epsilon = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type], <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype]);

      h = epsilon;
      h_inv = 1 / h;

      dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0] - pos_x;
      dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[1] - pos_y;
      dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[2] - pos_z;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      <span class="keywordflow">while</span>(dx &gt; boxhalf)
        dx -= boxsize;
      <span class="keywordflow">while</span>(dy &gt; boxhalf)
        dy -= boxsize;
      <span class="keywordflow">while</span>(dz &gt; boxhalf)
        dz -= boxsize;
      <span class="keywordflow">while</span>(dx &lt; -boxhalf)
        dx += boxsize;
      <span class="keywordflow">while</span>(dy &lt; -boxhalf)
        dy += boxsize;
      <span class="keywordflow">while</span>(dz &lt; -boxhalf)
        dz += boxsize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      r = sqrt(r2);

      u = r * h_inv;

      <span class="keywordflow">if</span>(u &gt;= 1)
        {
          r_inv = 1 / r;

          fac = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * r_inv * r_inv * r_inv;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(u &lt; 0.5)
            fac = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * h_inv * h_inv * h_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
          <span class="keywordflow">else</span>
            fac =
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * h_inv * h_inv * h_inv * (21.333333333333 -
                                                   48.0 * u + 38.4 * u * u -
                                                   10.666666666667 * u * u *
                                                   u - 0.066666666667 / (u * u * u));
        }

      acc_x += dx * fac;
      acc_y += dy * fac;
      acc_z += dz * fac;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(u &gt; 1.0e-5)
        {
          <a class="code" href="forcetree_8c.html#ad8b8e212e593e1795f6ba522239086fc">ewald_corr</a>(dx, dy, dz, fcorr);

          acc_x += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * fcorr[0];
          acc_y += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * fcorr[1];
          acc_z += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * fcorr[2];
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }


  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccelDirect[0] = acc_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccelDirect[1] = acc_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccelDirect[2] = acc_z;
    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[0] = acc_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[1] = acc_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[2] = acc_z;
    }


  <span class="keywordflow">return</span> <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a0ec221b2517893874b12dc366bfe0da8_cgraph.png" border="0" usemap="#forcetree_8c_a0ec221b2517893874b12dc366bfe0da8_cgraph" alt=""/></div>
<map name="forcetree_8c_a0ec221b2517893874b12dc366bfe0da8_cgraph" id="forcetree_8c_a0ec221b2517893874b12dc366bfe0da8_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="256,5,315,33"/><area shape="rect" id="node5" href="forcetree_8c.html#ad8b8e212e593e1795f6ba522239086fc" title="ewald_corr" alt="" coords="240,55,331,83"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a0ec221b2517893874b12dc366bfe0da8_icgraph.png" border="0" usemap="#forcetree_8c_a0ec221b2517893874b12dc366bfe0da8_icgraph" alt=""/></div>
<map name="forcetree_8c_a0ec221b2517893874b12dc366bfe0da8_icgraph" id="forcetree_8c_a0ec221b2517893874b12dc366bfe0da8_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="241,5,369,33"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="419,5,589,33"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="637,5,680,33"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="729,5,783,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab6894fe5ae268ea8f6bc7c4a8c87a87f"></a><!-- doxytag: member="forcetree.c::force_treeevaluate_ewald_correction" ref="ab6894fe5ae268ea8f6bc7c4a8c87a87f" args="(int target, int mode, double pos_x, double pos_y, double pos_z, double aold)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="proto_8h.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f">force_treeevaluate_ewald_correction</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>pos_x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>pos_y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>pos_z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>aold</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the Ewald correction, and is needed if periodic boundary conditions together with a pure tree algorithm are used. Note that the ordinary tree walk does not carry out this correction directly as it was done in Gadget-1.1. Instead, the tree is walked a second time. This is actually faster because the "Ewald-Treewalk" can use a different opening criterion than the normal tree walk. In particular, the Ewald correction is negligible for particles that are very close, but it is large for particles that are far away (this is quite different for the normal direct force). So we can here use a different opening criterion. Sufficient accuracy is usually obtained if the node length has dropped to a certain fraction ~&lt; 0.25 of the BoxLength. However, we may only short-cut the interaction list of the normal full Ewald tree walk if we are sure that the whole node and all daughter nodes "lie on the same side" of the periodic boundary, i.e. that the real tree walk would not find a daughter node or particle that was mapped to a different nearest neighbour position when the tree walk would be further refined. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02018">2018</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="forcetree_8c_source.html#l00045">EN</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="forcetree_8c_source.html#l00053">fac_intp</a>, <a class="el" href="forcetree_8c_source.html#l00049">fcorrx</a>, <a class="el" href="forcetree_8c_source.html#l00050">fcorry</a>, <a class="el" href="forcetree_8c_source.html#l00051">fcorrz</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, and <a class="el" href="allvars_8c_source.html#l00120">P</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l01126">force_treeevaluate()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span>NODE *nop = 0;
  <span class="keywordtype">int</span> no, cost;
  <span class="keywordtype">double</span> dx, dy, dz, mass, r2;
  <span class="keywordtype">int</span> signx, signy, signz;
  <span class="keywordtype">int</span> i, j, k, openflag;
  <span class="keywordtype">double</span> u, v, w;
  <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;
  <span class="keywordtype">double</span> acc_x, acc_y, acc_z;
  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  
  acc_x = 0;
  acc_y = 0;
  acc_z = 0;
  cost = 0;

  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)      <span class="comment">/* single particle */</span>
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          <span class="comment">/* observe the sign */</span>

          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[2] - pos_z;
          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Mass;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }

              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          dx = nop-&gt;u.d.s[0] - pos_x;
          dy = nop-&gt;u.d.s[1] - pos_y;
          dz = nop-&gt;u.d.s[2] - pos_z;
          mass = nop-&gt;u.d.mass;
        }

      dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
      dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
      dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)
        no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
        {
          openflag = 0;

          r2 = dx * dx + dy * dy + dz * dz;
        
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;center[0] - pos_x)*(nop-&gt;center[0] - pos_x) +
                              (nop-&gt;center[1] - pos_y)*(nop-&gt;center[1] - pos_y) +
                              (nop-&gt;center[2] - pos_z)*(nop-&gt;center[2] - pos_z));
          <span class="comment">/*check if any portion the cell lies withing the intercation range*/</span>
        <span class="keywordflow">if</span>(dist_to_center - nop-&gt;len * sqrt(3.0) / 2.0 &lt; 2.0*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.SIDMSmoothingFactor*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[1])
            {
              <span class="comment">/* open cell */</span>
              no = nop-&gt;u.d.nextnode;
              <span class="keywordflow">continue</span>;
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;len * nop-&gt;len &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)
                {
                  openflag = 1;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;len * nop-&gt;len &gt; r2 * r2 * aold)
                {
                  openflag = 1;
                }
              <span class="keywordflow">else</span>
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;center[0] - pos_x) &lt; 0.60 * nop-&gt;len)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;center[1] - pos_y) &lt; 0.60 * nop-&gt;len)
                        {
                          <span class="keywordflow">if</span>(fabs(nop-&gt;center[2] - pos_z) &lt; 0.60 * nop-&gt;len)
                            {
                              openflag = 1;
                            }
                        }
                    }
                }
            }

          <span class="keywordflow">if</span>(openflag)
            {
              <span class="comment">/* now we check if we can avoid opening the cell */</span>

              u = nop-&gt;center[0] - pos_x;
              <span class="keywordflow">if</span>(u &gt; boxhalf)
                u -= boxsize;
              <span class="keywordflow">if</span>(u &lt; -boxhalf)
                u += boxsize;

              <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;len))
                {
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              u = nop-&gt;center[1] - pos_y;
              <span class="keywordflow">if</span>(u &gt; boxhalf)
                u -= boxsize;
              <span class="keywordflow">if</span>(u &lt; -boxhalf)
                u += boxsize;

              <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;len))
                {
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              u = nop-&gt;center[2] - pos_z;
              <span class="keywordflow">if</span>(u &gt; boxhalf)
                u -= boxsize;
              <span class="keywordflow">if</span>(u &lt; -boxhalf)
                u += boxsize;

              <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;len))
                {
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="comment">/* if the cell is too large, we need to refine</span>
<span class="comment">               * it further </span>
<span class="comment">               */</span>
              <span class="keywordflow">if</span>(nop-&gt;len &gt; 0.20 * boxsize)
                {
                  <span class="comment">/* cell is too large */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }

          no = nop-&gt;u.d.sibling;        <span class="comment">/* ok, node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;u.d.bitflags &amp; 1))       <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      <span class="comment">/* compute the Ewald correction force */</span>

      <span class="keywordflow">if</span>(dx &lt; 0)
        {
          dx = -dx;
          signx = +1;
        }
      <span class="keywordflow">else</span>
        signx = -1;

      <span class="keywordflow">if</span>(dy &lt; 0)
        {
          dy = -dy;
          signy = +1;
        }
      <span class="keywordflow">else</span>
        signy = -1;

      <span class="keywordflow">if</span>(dz &lt; 0)
        {
          dz = -dz;
          signz = +1;
        }
      <span class="keywordflow">else</span>
        signz = -1;

      u = dx * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
      i = (int) u;
      <span class="keywordflow">if</span>(i &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
        i = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
      u -= i;
      v = dy * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
      j = (int) v;
      <span class="keywordflow">if</span>(j &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
        j = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
      v -= j;
      w = dz * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
      k = (int) w;
      <span class="keywordflow">if</span>(k &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
        k = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
      w -= k;

      <span class="comment">/* compute factors for trilinear interpolation */</span>

      f1 = (1 - u) * (1 - v) * (1 - w);
      f2 = (1 - u) * (1 - v) * (w);
      f3 = (1 - u) * (v) * (1 - w);
      f4 = (1 - u) * (v) * (w);
      f5 = (u) * (1 - v) * (1 - w);
      f6 = (u) * (1 - v) * (w);
      f7 = (u) * (v) * (1 - w);
      f8 = (u) * (v) * (w);

      acc_x += mass * signx * (<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k] * f1 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k + 1] * f2 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j + 1][k] * f3 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j + 1][k + 1] * f4 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j][k] * f5 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j][k + 1] * f6 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j + 1][k + 1] * f8);

      acc_y += mass * signy * (<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k] * f1 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k + 1] * f2 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j + 1][k] * f3 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j + 1][k + 1] * f4 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j][k] * f5 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j][k + 1] * f6 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j + 1][k + 1] * f8);

      acc_z += mass * signz * (<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k] * f1 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k + 1] * f2 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j + 1][k] * f3 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j + 1][k + 1] * f4 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j][k] * f5 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j][k + 1] * f6 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j + 1][k + 1] * f8);
      cost++;
    }


  <span class="comment">/* add the result at the proper place */</span>

  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[0] += acc_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[1] += acc_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[2] += acc_z;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravCost += cost;
    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[0] += acc_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[1] += acc_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[2] += acc_z;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].w.Ninteractions += cost;
    }

  <span class="keywordflow">return</span> cost;
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ab6894fe5ae268ea8f6bc7c4a8c87a87f_icgraph.png" border="0" usemap="#forcetree_8c_ab6894fe5ae268ea8f6bc7c4a8c87a87f_icgraph" alt=""/></div>
<map name="forcetree_8c_ab6894fe5ae268ea8f6bc7c4a8c87a87f_icgraph" id="forcetree_8c_ab6894fe5ae268ea8f6bc7c4a8c87a87f_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a59ae74ef51d6a7065605638422489391" title="force_treeevaluate" alt="" coords="311,5,452,33"/><area shape="rect" id="node5" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="501,5,600,33"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="648,5,819,33"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="867,5,909,33"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="959,5,1012,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af29d257a1e4545ba4b9c3648444979b6"></a><!-- doxytag: member="forcetree.c::force_treeevaluate_potential" ref="af29d257a1e4545ba4b9c3648444979b6" args="(int target, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a804166b1847da509d8fe57072b40d5f9">force_treeevaluate_potential</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>mode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine computes the gravitational potential by walking the tree. The same opening criteria is used as for the gravitational force walk. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02300">2300</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="forcetree_8c_source.html#l03401">ewald_pot_corr()</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8c_source.html#l00128">SphP</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span>NODE *nop = 0;
  <span class="keywordtype">int</span> no, ptype;
  <span class="keywordtype">double</span> r2, dx, dy, dz, mass, r, u, h, h_inv, wp;
  <span class="keywordtype">double</span> pot, pos_x, pos_y, pos_z, aold;
<span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  
  pot = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Type;
      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolForceAcc * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].OldAcc;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].Hsml;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].Type;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolForceAcc * <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].w.OldAcc;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Soft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }


<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
  h_inv = 1.0 / h;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)      <span class="comment">/* single particle */</span>
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          <span class="comment">/* observe the sign */</span>

          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[2] - pos_z;
          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Mass;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          dx = nop-&gt;u.d.s[0] - pos_x;
          dy = nop-&gt;u.d.s[1] - pos_y;
          dz = nop-&gt;u.d.s[2] - pos_z;
          mass = nop-&gt;u.d.mass;
        }

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
      dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
      dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 0)
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml)
                h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type])
                h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type];
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
          <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type])
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an internal node. Need to check opening criterion */</span>
        {
          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;u.d.bitflags &amp; 3) == 1)  <span class="comment">/* if it&#39;s a top-level node</span>
<span class="comment">                                                 * which does not contain</span>
<span class="comment">                                                 * local particles we can make</span>
<span class="comment">                                                 * a short-cut </span>
<span class="comment">                                                 */</span>
                {
                  no = nop-&gt;u.d.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;center[0] - pos_x)*(nop-&gt;center[0] - pos_x) + 
                                (nop-&gt;center[1] - pos_y)*(nop-&gt;center[1] - pos_y) +
                                (nop-&gt;center[2] - pos_z)*(nop-&gt;center[2] - pos_z));
           <span class="comment">/*check if any portion the cell lies withing the intercation range*/</span>
          <span class="keywordflow">if</span>(dist_to_center - nop-&gt;len * sqrt(3.0) / 2.0 &lt; 2.0*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.SIDMSmoothingFactor*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[1])
          {
            <span class="comment">/* open cell */</span>
            no = nop-&gt;u.d.nextnode;
            <span class="keywordflow">continue</span>;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;len * nop-&gt;len &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;len * nop-&gt;len &gt; r2 * r2 * aold)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="keywordflow">if</span>(fabs(nop-&gt;center[0] - pos_x) &lt; 0.60 * nop-&gt;len)
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;center[1] - pos_y) &lt; 0.60 * nop-&gt;len)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;center[2] - pos_z) &lt; 0.60 * nop-&gt;len)
                        {
                          no = nop-&gt;u.d.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
          maxsofttype = (nop-&gt;u.d.bitflags &gt;&gt; 2) &amp; 7;
          <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
            {
              <span class="keywordflow">if</span>(mass &gt; 0)
                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(988);
              no = nop-&gt;u.d.nextnode;
              <span class="keywordflow">continue</span>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                {
                  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype];
                  <span class="keywordflow">if</span>(r2 &lt; h * h)
                    {
                      <span class="keywordflow">if</span>(((nop-&gt;u.d.bitflags &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
                        {
                          no = nop-&gt;u.d.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];

          <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
            {
              h = nop-&gt;maxsoft;
              <span class="keywordflow">if</span>(r2 &lt; h * h)
                {
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          no = nop-&gt;u.d.sibling;        <span class="comment">/* node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>(((nop-&gt;u.d.bitflags) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      r = sqrt(r2);

      <span class="keywordflow">if</span>(r &gt;= h)
        pot -= mass / r;
      <span class="keywordflow">else</span>
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>          h_inv = 1.0 / h;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          u = r * h_inv;

          <span class="keywordflow">if</span>(u &lt; 0.5)
            wp = -2.8 + u * u * (5.333333333333 + u * u * (6.4 * u - 9.6));
          <span class="keywordflow">else</span>
            wp =
              -3.2 + 0.066666666667 / u + u * u * (10.666666666667 +
                                                   u * (-16.0 + u * (9.6 - 2.133333333333 * u)));

          pot += mass * h_inv * wp;
        }
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      pot += mass * <a class="code" href="forcetree_8c.html#aa0657e3de6bfb76715c14ddd72d25e58">ewald_pot_corr</a>(dx, dy, dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="comment">/* store result at the proper place */</span>

  <span class="keywordflow">if</span>(mode == 0)
    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Potential = pot;
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Potential = pot;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_af29d257a1e4545ba4b9c3648444979b6_cgraph.png" border="0" usemap="#forcetree_8c_af29d257a1e4545ba4b9c3648444979b6_cgraph" alt=""/></div>
<map name="forcetree_8c_af29d257a1e4545ba4b9c3648444979b6_cgraph" id="forcetree_8c_af29d257a1e4545ba4b9c3648444979b6_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="285,5,352,33"/><area shape="rect" id="node7" href="forcetree_8c.html#aa0657e3de6bfb76715c14ddd72d25e58" title="ewald_pot_corr" alt="" coords="260,55,377,83"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="427,5,584,33"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_af29d257a1e4545ba4b9c3648444979b6_icgraph.png" border="0" usemap="#forcetree_8c_af29d257a1e4545ba4b9c3648444979b6_icgraph" alt=""/></div>
<map name="forcetree_8c_af29d257a1e4545ba4b9c3648444979b6_icgraph" id="forcetree_8c_af29d257a1e4545ba4b9c3648444979b6_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="260,5,401,33"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="717,5,760,33"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="451,30,669,58"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="809,5,863,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="abd9d86a6c08e77a4fa78fa76b96cdde7"></a><!-- doxytag: member="forcetree.c::force_treeevaluate_potential_shortrange" ref="abd9d86a6c08e77a4fa78fa76b96cdde7" args="(int target, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#abd9d86a6c08e77a4fa78fa76b96cdde7">force_treeevaluate_potential_shortrange</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>mode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the short-range potential when the TreePM algorithm is used. This potential is the Newtonian potential, modified by a complementary error function. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02577">2577</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="forcetree_8c_source.html#l00031">NTAB</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="forcetree_8c_source.html#l00033">shortrange_table_potential</a>, and <a class="el" href="allvars_8c_source.html#l00128">SphP</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span>NODE *nop = 0;
  <span class="keywordtype">int</span> no, ptype, tabindex;
  <span class="keywordtype">double</span> r2, dx, dy, dz, mass, r, u, h, h_inv, wp;
  <span class="keywordtype">double</span> pot, pos_x, pos_y, pos_z, aold;
  <span class="keywordtype">double</span> eff_dist, fac, rcut, asmth, asmthfac;
  <span class="keywordtype">double</span> dxx, dyy, dzz;
<span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  pot = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Type;
      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolForceAcc * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].OldAcc;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].Hsml;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].Type;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolForceAcc * <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].w.OldAcc;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Soft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }


  rcut = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Rcut[0];
  asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Asmth[0];
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(((1 &lt;&lt; ptype) &amp; (PLACEHIGHRESREGION)))
    {
      rcut = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Rcut[1];
      asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Asmth[1];
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  asmthfac = 0.5 / asmth * (<a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a> / 3.0);

<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
  h_inv = 1.0 / h;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)      <span class="comment">/* single particle */</span>
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          <span class="comment">/* observe the sign  */</span>

          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[2] - pos_z;
          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Mass;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          dx = nop-&gt;u.d.s[0] - pos_x;
          dy = nop-&gt;u.d.s[1] - pos_y;
          dz = nop-&gt;u.d.s[2] - pos_z;
          mass = nop-&gt;u.d.mass;
        }

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
      dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
      dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 0)
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml)
                h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type])
                h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type];
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
          <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type])
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
        {
          <span class="comment">/* check whether we can stop walking along this branch */</span>
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;u.d.bitflags &amp; 3) == 1)  <span class="comment">/* if it&#39;s a top-level node which does not contain local particles */</span>
                {
                  no = nop-&gt;u.d.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

          eff_dist = rcut + 0.5 * nop-&gt;len;

          dxx = nop-&gt;center[0] - pos_x; <span class="comment">/* observe the sign ! */</span>
          dyy = nop-&gt;center[1] - pos_y; <span class="comment">/* this vector is -y in my thesis notation */</span>
          dzz = nop-&gt;center[2] - pos_z;
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          dxx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dxx);
          dyy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dyy);
          dzz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dzz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(dxx &lt; -eff_dist || dxx &gt; eff_dist)
            {
              no = nop-&gt;u.d.sibling;
              <span class="keywordflow">continue</span>;
            }

          <span class="keywordflow">if</span>(dyy &lt; -eff_dist || dyy &gt; eff_dist)
            {
              no = nop-&gt;u.d.sibling;
              <span class="keywordflow">continue</span>;
            }

          <span class="keywordflow">if</span>(dzz &lt; -eff_dist || dzz &gt; eff_dist)
            {
              no = nop-&gt;u.d.sibling;
              <span class="keywordflow">continue</span>;
            }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;center[0] - pos_x)*(nop-&gt;center[0] - pos_x) + 
                                (nop-&gt;center[1] - pos_y)*(nop-&gt;center[1] - pos_y) +
                                (nop-&gt;center[2] - pos_z)*(nop-&gt;center[2] - pos_z));
           <span class="comment">/*check if any portion the cell lies withing the intercation range*/</span>
          <span class="keywordflow">if</span>(dist_to_center - nop-&gt;len * sqrt(3.0) / 2.0 &lt; 2.0*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.SIDMSmoothingFactor*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[1])
          {
            <span class="comment">/* open cell */</span>
            no = nop-&gt;u.d.nextnode;
            <span class="keywordflow">continue</span>;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;len * nop-&gt;len &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;len * nop-&gt;len &gt; r2 * r2 * aold)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="keywordflow">if</span>(fabs(nop-&gt;center[0] - pos_x) &lt; 0.60 * nop-&gt;len)
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;center[1] - pos_y) &lt; 0.60 * nop-&gt;len)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;center[2] - pos_z) &lt; 0.60 * nop-&gt;len)
                        {
                          no = nop-&gt;u.d.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
          maxsofttype = (nop-&gt;u.d.bitflags &gt;&gt; 2) &amp; 7;
          <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
            {
              <span class="keywordflow">if</span>(mass &gt; 0)
                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(989);
              no = nop-&gt;u.d.nextnode;
              <span class="keywordflow">continue</span>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                {
                  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype];
                  <span class="keywordflow">if</span>(r2 &lt; h * h)
                    {
                      <span class="comment">/* bit-5 signals that there are particles of</span>
<span class="comment">                       * different softening in the node</span>
<span class="comment">                       */</span>
                      <span class="keywordflow">if</span>(((nop-&gt;u.d.bitflags &gt;&gt; 5) &amp; 1))
                        {
                          no = nop-&gt;u.d.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];

          <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
            {
              h = nop-&gt;maxsoft;
              <span class="keywordflow">if</span>(r2 &lt; h * h)
                {
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = nop-&gt;u.d.sibling;        <span class="comment">/* node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>(((nop-&gt;u.d.bitflags) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      r = sqrt(r2);

      tabindex = (int) (r * asmthfac);

      <span class="keywordflow">if</span>(tabindex &lt; <a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a>)
        {
          fac = <a class="code" href="forcetree_8c.html#a196b7c27d03bd3ecc1259b2f67017fbe">shortrange_table_potential</a>[tabindex];

          <span class="keywordflow">if</span>(r &gt;= h)
            pot -= fac * mass / r;
          <span class="keywordflow">else</span>
            {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>              h_inv = 1.0 / h;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              u = r * h_inv;

              <span class="keywordflow">if</span>(u &lt; 0.5)
                wp = -2.8 + u * u * (5.333333333333 + u * u * (6.4 * u - 9.6));
              <span class="keywordflow">else</span>
                wp =
                  -3.2 + 0.066666666667 / u + u * u * (10.666666666667 +
                                                       u * (-16.0 + u * (9.6 - 2.133333333333 * u)));
              pot += fac * mass * h_inv * wp;
            }
        }
    }


  <span class="comment">/* store result at the proper place */</span>
  <span class="keywordflow">if</span>(mode == 0)
    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Potential = pot;
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Potential = pot;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_abd9d86a6c08e77a4fa78fa76b96cdde7_cgraph.png" border="0" usemap="#forcetree_8c_abd9d86a6c08e77a4fa78fa76b96cdde7_cgraph" alt=""/></div>
<map name="forcetree_8c_abd9d86a6c08e77a4fa78fa76b96cdde7_cgraph" id="forcetree_8c_abd9d86a6c08e77a4fa78fa76b96cdde7_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="336,5,403,33"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="451,5,608,33"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_abd9d86a6c08e77a4fa78fa76b96cdde7_icgraph.png" border="0" usemap="#forcetree_8c_abd9d86a6c08e77a4fa78fa76b96cdde7_icgraph" alt=""/></div>
<map name="forcetree_8c_abd9d86a6c08e77a4fa78fa76b96cdde7_icgraph" id="forcetree_8c_abd9d86a6c08e77a4fa78fa76b96cdde7_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="337,5,479,33"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="795,5,837,33"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="528,30,747,58"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="887,5,940,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae01e179b7686a7fe62970160b7bbdb46"></a><!-- doxytag: member="forcetree.c::force_treeevaluate_shortrange" ref="ae01e179b7686a7fe62970160b7bbdb46" args="(int target, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="proto_8h.html#ae01e179b7686a7fe62970160b7bbdb46">force_treeevaluate_shortrange</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>mode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>In the TreePM algorithm, the tree is walked only locally around the target coordinate. Tree nodes that fall outside a box of half side-length Rcut= RCUT*ASMTH*MeshSize can be discarded. The short-range potential is modified by a complementary error function, multiplied with the Newtonian form. The resulting short-range suppression compared to the Newtonian force is tabulated, because looking up from this table is faster than recomputing the corresponding factor, despite the memory-access panelty (which reduces cache performance) incurred by the table. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01542">1542</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="sidm__routines_8c_source.html#l00094">calculate_interact_kick()</a>, <a class="el" href="sidm__routines_8c_source.html#l00282">check_interaction_table()</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="forcetree_8c_source.html#l00031">NTAB</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="sidm__routines_8c_source.html#l00032">prob_of_interaction()</a>, <a class="el" href="allvars_8c_source.html#l00043">random_generator</a>, <a class="el" href="forcetree_8c_source.html#l00033">shortrange_table</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, and <a class="el" href="sidm__routines_8c_source.html#l00205">update_interaction_table()</a>.</p>

<p>Referenced by <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span>NODE *nop = 0;
  <span class="keywordtype">int</span> no, ptype, ninteractions, tabindex;
  <span class="keywordtype">double</span> r2, dx, dy, dz, mass, r, fac, u, h, h_inv, h3_inv;
  <span class="keywordtype">double</span> acc_x, acc_y, acc_z, pos_x, pos_y, pos_z, aold;
  <span class="keywordtype">double</span> eff_dist;
  <span class="keywordtype">double</span> rcut, asmth, asmthfac, rcut2, dist;
<span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.BoxSize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center,kick_x,kick_y,kick_z,kick_target[3],kick_no[3],prob,prob_tmp,max_prob;
  FLOAT targetVel[3];
  <span class="keywordtype">int</span> targetBegstep,targetEndstep,targetdTi_selfInt;
  IDTYPE targetID;              
  <span class="keywordtype">int</span> si_count,i;
  kick_x = 0;
  kick_y = 0;
  kick_z = 0;
  si_count = 0;
  max_prob = 0;
  <span class="keywordflow">if</span>(mode == 0)
    {
      <span class="keywordflow">for</span>(i=0;i&lt;3;i++)
        targetVel[i] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[i];
      targetBegstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Ti_begstep;
      targetEndstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Ti_endstep;
      targetID      = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].ID;
      targetdTi_selfInt = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].dTi_selfInt;
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">for</span>(i=0;i&lt;3;i++)
        targetVel[i] = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Vel[i];
      targetBegstep = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Ti_begstep;
      targetEndstep = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Ti_endstep;
      targetID      = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].ID;
      targetdTi_selfInt = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].dTi_selfInt;;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  acc_x = 0;
  acc_y = 0;
  acc_z = 0;
  ninteractions = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Pos[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Type;
      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolForceAcc * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].OldAcc;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].Hsml;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].u.Pos[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].Type;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK      </span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolForceAcc * <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].w.OldAcc;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Soft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  rcut = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Rcut[0];
  asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Asmth[0];
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(((1 &lt;&lt; ptype) &amp; (PLACEHIGHRESREGION)))
    {
      rcut = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Rcut[1];
      asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Asmth[1];
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  rcut2 = rcut * rcut;

  asmthfac = 0.5 / asmth * (<a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a> / 3.0);

<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
  h_inv = 1.0 / h;
  h3_inv = h_inv * h_inv * h_inv;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart;             <span class="comment">/* root node */</span>

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Pos[2] - pos_z;
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
          dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
          dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;

          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Mass;
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 0)
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml)
                h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type])
                h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type];
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
          <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type])
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span> (targetID != <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID)
            {
              <span class="keywordflow">if</span> (ptype == 1 &amp;&amp; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 1)
              <span class="comment">//if ((ptype == 1 &amp;&amp; P[no].Type == 4) || (ptype == 4 &amp;&amp; P[no].Type == 1) ) /*Use this for Test1 and Test2 only*/ </span>
                {
                  r = sqrt(r2);
                  <span class="keywordflow">if</span> (r &lt; 2.0*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.SIDMSmoothingFactor*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[1])
                    {
                      <span class="keywordflow">if</span> (<a class="code" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4">check_interaction_table</a>(targetID,<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID) == 0)
                        {
                          prob = <a class="code" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8">prob_of_interaction</a>(r, targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, targetBegstep, targetEndstep);
                          <span class="keywordflow">if</span>(prob &gt; max_prob) max_prob = prob;
                          
                          <span class="keywordflow">if</span>(prob &gt; 0.2)
                            {
                              <span class="keywordflow">if</span>(targetdTi_selfInt == 0 || <a class="code" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8">prob_of_interaction</a>(r, targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, 0, targetdTi_selfInt) &gt; 0.2)
                                {
                                  targetdTi_selfInt = targetEndstep-targetBegstep;
                                  prob_tmp = prob;
                                  <span class="keywordflow">while</span>(prob_tmp &gt; 0.2)
                                    {
                                      targetdTi_selfInt /= 2; 
                                      prob_tmp = <a class="code" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8">prob_of_interaction</a>(r, targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, 0, targetdTi_selfInt); 
                                    }
                                }
                            }
                          
                          <span class="keywordflow">if</span>(gsl_rng_uniform(<a class="code" href="allvars_8c.html#a4ec93729b85eb5da23dd6ffb23c3702b">random_generator</a>) &lt; prob)
                            {
                              <a class="code" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9">calculate_interact_kick</a>(targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, kick_target, kick_no);
                              kick_x += kick_target[0];
                              kick_y += kick_target[1];
                              kick_z += kick_target[2];
                              <span class="keywordflow">for</span>(i = 0; i &lt; 3 ; i++)
                                <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel[i] += kick_no[i];
                              <span class="comment">//if(sqrt(pos_x*pos_x + pos_y*pos_y + pos_z*pos_z) &gt; 127.0 &amp;&amp; sqrt(pos_x*pos_x + pos_y*pos_y + pos_z*pos_z) &lt; 167.0 ) /* This if statement is for the sake of Test1 only. REMOVE FOR ANY OTHER RUNS!!.*/</span>
                              si_count+=1;
                              <a class="code" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615">update_interaction_table</a>(targetID,<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID);
                            }
                        }
                    }
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          
          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node */</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;u.d.bitflags &amp; 3) == 1)  <span class="comment">/* if it&#39;s a top-level node</span>
<span class="comment">                                                 * which does not contain</span>
<span class="comment">                                                 * local particles we can</span>
<span class="comment">                                                 * continue at this point</span>
<span class="comment">                                                 */</span>
                {
                  no = nop-&gt;u.d.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

          mass = nop-&gt;u.d.mass;

          dx = nop-&gt;u.d.s[0] - pos_x;
          dy = nop-&gt;u.d.s[1] - pos_y;
          dz = nop-&gt;u.d.s[2] - pos_z;
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
          dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
          dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;

          <span class="keywordflow">if</span>(r2 &gt; rcut2)
            {
              <span class="comment">/* check whether we can stop walking along this branch */</span>
              eff_dist = rcut + 0.5 * nop-&gt;len;
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(nop-&gt;center[0] - pos_x);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>              dist = nop-&gt;center[0] - pos_x;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
                {
                  no = nop-&gt;u.d.sibling;
                  <span class="keywordflow">continue</span>;
                }
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(nop-&gt;center[1] - pos_y);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>              dist = nop-&gt;center[1] - pos_y;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
                {
                  no = nop-&gt;u.d.sibling;
                  <span class="keywordflow">continue</span>;
                }
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(nop-&gt;center[2] - pos_z);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>              dist = nop-&gt;center[2] - pos_z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
                {
                  no = nop-&gt;u.d.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;center[0] - pos_x)*(nop-&gt;center[0] - pos_x) + 
                                (nop-&gt;center[1] - pos_y)*(nop-&gt;center[1] - pos_y) +
                                (nop-&gt;center[2] - pos_z)*(nop-&gt;center[2] - pos_z));
          <span class="comment">/*check if any portion the cell lies withing the intercation range */</span>
          <span class="keywordflow">if</span>(dist_to_center - nop-&gt;len*sqrt(3.0)/2.0 &lt; 2.0*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.SIDMSmoothingFactor*<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[1])
            {
              <span class="comment">/* open cell */</span>
              no = nop-&gt;u.d.nextnode;
              <span class="keywordflow">continue</span>;
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;len * nop-&gt;len &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ErrTolTheta)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;len * nop-&gt;len &gt; r2 * r2 * aold)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="comment">/* check in addition whether we lie inside the cell */</span>

              <span class="keywordflow">if</span>(fabs(nop-&gt;center[0] - pos_x) &lt; 0.60 * nop-&gt;len)
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;center[1] - pos_y) &lt; 0.60 * nop-&gt;len)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;center[2] - pos_z) &lt; 0.60 * nop-&gt;len)
                        {
                          no = nop-&gt;u.d.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];
          maxsofttype = (nop-&gt;u.d.bitflags &gt;&gt; 2) &amp; 7;
          <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
            {
              <span class="keywordflow">if</span>(mass &gt; 0)
                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(987);
              no = nop-&gt;u.d.nextnode;
              <span class="keywordflow">continue</span>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                {
                  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype];
                  <span class="keywordflow">if</span>(r2 &lt; h * h)
                    {
                      <span class="keywordflow">if</span>(((nop-&gt;u.d.bitflags &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
                        {
                          no = nop-&gt;u.d.nextnode;
                          
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[ptype];

          <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
            {
              h = nop-&gt;maxsoft;
              <span class="keywordflow">if</span>(r2 &lt; h * h)
                {
                  no = nop-&gt;u.d.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = nop-&gt;u.d.sibling;        <span class="comment">/* ok, node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>(((nop-&gt;u.d.bitflags) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      r = sqrt(r2);

      <span class="keywordflow">if</span>(r &gt;= h)
        fac = mass / (r2 * r);
      <span class="keywordflow">else</span>
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>          h_inv = 1.0 / h;
          h3_inv = h_inv * h_inv * h_inv;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          u = r * h_inv;
          <span class="keywordflow">if</span>(u &lt; 0.5)
            fac = mass * h3_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
          <span class="keywordflow">else</span>
            fac =
              mass * h3_inv * (21.333333333333 - 48.0 * u +
                               38.4 * u * u - 10.666666666667 * u * u * u - 0.066666666667 / (u * u * u));
        }

      tabindex = (int) (asmthfac * r);

      <span class="keywordflow">if</span>(tabindex &lt; <a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a>)
        {
          fac *= <a class="code" href="forcetree_8c.html#a76b621ce2fa9c17911a62495174029eb">shortrange_table</a>[tabindex];

          acc_x += dx * fac;
          acc_y += dy * fac;
          acc_z += dz * fac;

          ninteractions++;
        }
    }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK </span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactions += si_count;
  <span class="keywordflow">if</span>(max_prob &lt; 0.1 &amp;&amp; max_prob &gt; 0 &amp;&amp; mode == 0 &amp;&amp; targetdTi_selfInt &gt; 0)
    {
      <span class="keywordflow">while</span>(max_prob &lt; 0.1)
        {
          targetdTi_selfInt *= 2; 
          max_prob *= 2.0;
        }
    }
 
  <span class="comment">/*for test2 we want to turn off gravity for all the particles</span>
<span class="comment">  acc_x = 0.0;</span>
<span class="comment">  acc_y = 0.0;</span>
<span class="comment">  acc_z = 0.0;*/</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">/* store result at the proper place */</span>

  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[0] = acc_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[1] = acc_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravAccel[2] = acc_z;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].GravCost = ninteractions;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[0] += kick_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[1] += kick_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[2] += kick_z;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].dTi_selfInt = targetdTi_selfInt;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[0] = acc_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[1] = acc_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].u.Acc[2] = acc_z;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].w.Ninteractions = ninteractions;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[0] = kick_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[1] = kick_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[2] = kick_z;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].dTi_selfInt = targetdTi_selfInt;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="keywordflow">return</span> ninteractions;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ae01e179b7686a7fe62970160b7bbdb46_cgraph.png" border="0" usemap="#forcetree_8c_ae01e179b7686a7fe62970160b7bbdb46_cgraph" alt=""/></div>
<map name="forcetree_8c_ae01e179b7686a7fe62970160b7bbdb46_cgraph" id="forcetree_8c_ae01e179b7686a7fe62970160b7bbdb46_cgraph">
<area shape="rect" id="node3" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9" title="calculate_interact_kick" alt="" coords="280,5,445,33"/><area shape="rect" id="node5" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4" title="check_interaction_table" alt="" coords="276,55,449,83"/><area shape="rect" id="node7" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="501,131,568,159"/><area shape="rect" id="node11" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8" title="prob_of_interaction" alt="" coords="291,207,435,235"/><area shape="rect" id="node15" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615" title="update_interaction_table" alt="" coords="272,157,453,185"/><area shape="rect" id="node9" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="616,131,773,159"/><area shape="rect" id="node13" href="sidm__routines_8c.html#ab5ff10bfb368309b0dd01aaa72c6be1d" title="g_geo" alt="" coords="504,207,565,235"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ae01e179b7686a7fe62970160b7bbdb46_icgraph.png" border="0" usemap="#forcetree_8c_ae01e179b7686a7fe62970160b7bbdb46_icgraph" alt=""/></div>
<map name="forcetree_8c_ae01e179b7686a7fe62970160b7bbdb46_icgraph" id="forcetree_8c_ae01e179b7686a7fe62970160b7bbdb46_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="272,5,371,33"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="419,5,589,33"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="637,5,680,33"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="729,5,783,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0a9667f530dad09ebed8c0c98e5d3888"></a><!-- doxytag: member="forcetree.c::force_treefree" ref="a0a9667f530dad09ebed8c0c98e5d3888" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a0a9667f530dad09ebed8c0c98e5d3888">force_treefree</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function frees the memory allocated for the tree, i.e. it frees the space allocated by the function <a class="el" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate()</a>. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02976">2976</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00152">Extnodes_base</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, and <a class="el" href="allvars_8c_source.html#l00142">Nodes_base</a>.</p>

<p>Referenced by <a class="el" href="pm__periodic_8c_source.html#l00180">pmforce_periodic()</a>, and <a class="el" href="pm__periodic_8c_source.html#l00693">pmpotential_periodic()</a>.</p>
<div class="fragment"><pre class="fragment">{
  free(<a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>);
  free(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>);
  free(<a class="code" href="allvars_8c.html#a57932378336b142ac6e6a9ddb60dce3f">Extnodes_base</a>);
  free(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>);
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a0a9667f530dad09ebed8c0c98e5d3888_icgraph.png" border="0" usemap="#forcetree_8c_a0a9667f530dad09ebed8c0c98e5d3888_icgraph" alt=""/></div>
<map name="forcetree_8c_a0a9667f530dad09ebed8c0c98e5d3888_icgraph" id="forcetree_8c_a0a9667f530dad09ebed8c0c98e5d3888_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="179,5,309,33"/><area shape="rect" id="node13" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="167,55,321,83"/><area shape="rect" id="node5" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="377,5,508,33"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="587,5,757,33"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="829,55,872,83"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="921,55,975,83"/><area shape="rect" id="node15" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="372,55,513,83"/><area shape="rect" id="node18" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="563,106,781,134"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab8e5d4fed349d96c6d4f55897473ce19"></a><!-- doxytag: member="forcetree.c::force_treeupdate_pseudos" ref="ab8e5d4fed349d96c6d4f55897473ce19" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#ab8e5d4fed349d96c6d4f55897473ce19">force_treeupdate_pseudos</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function updates the top-level tree after the multipole moments of the pseudo-particles have been updated. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00732">732</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8c_source.html#l00065">DomainMoment</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, and <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00671">force_update_pseudoparticles()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, k, no;
  FLOAT sold[3], vsold[3], snew[3], vsnew[3], massold, massnew, mm;

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype, diffsoftflag;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  FLOAT maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>)
      {
        no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

        <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
          {
            sold[k] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[k];
            vsold[k] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[k];
          }
        massold = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.mass;

        <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
          {
            snew[k] = <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[k];
            vsnew[k] = <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].vs[k];
          }
        massnew = <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].mass;


<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>        maxsofttype = (<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].bitflags &gt;&gt; 2) &amp; 7;
        diffsoftflag = (<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].bitflags &gt;&gt; 5) &amp; 1;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        maxsoft = <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        <span class="keywordflow">do</span>
          {
            mm = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.mass + massnew - massold;
            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              {
                <span class="keywordflow">if</span>(mm &gt; 0)
                  {
                    <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[k] =
                      (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.mass * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[k] + massnew * snew[k] - massold * sold[k]) / mm;
                    <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[k] =
                      (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.mass * <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[k] + massnew * vsnew[k] -
                       massold * vsold[k]) / mm;
                  }
              }
            <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.mass = mm;


<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>            diffsoftflag |= (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &gt;&gt; 5) &amp; 1;

            <span class="keywordflow">if</span>(maxsofttype == 7)
              maxsofttype = (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &gt;&gt; 2) &amp; 7;
            <span class="keywordflow">else</span>
              {
                <span class="keywordflow">if</span>(((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &gt;&gt; 2) &amp; 7) != 7)
                  {
                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &gt;&gt; 2) &amp; 7)] &gt;
                       <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                      {
                        maxsofttype = ((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &gt;&gt; 2) &amp; 7);
                        diffsoftflag = 1;
                      }
                    <span class="keywordflow">else</span>
                      {
                        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &gt;&gt; 2) &amp; 7)] &lt;
                           <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                          diffsoftflag = 1;
                      }
                  }
              }

            <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags = (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags &amp; 3) + 4 * maxsofttype + 32 * diffsoftflag;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft &lt; maxsoft)
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft = maxsoft;
            maxsoft = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            no = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.father;

          }
        <span class="keywordflow">while</span>(no &gt;= 0);
      }
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ab8e5d4fed349d96c6d4f55897473ce19_icgraph.png" border="0" usemap="#forcetree_8c_ab8e5d4fed349d96c6d4f55897473ce19_icgraph" alt=""/></div>
<map name="forcetree_8c_ab8e5d4fed349d96c6d4f55897473ce19_icgraph" id="forcetree_8c_ab8e5d4fed349d96c6d4f55897473ce19_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="249,57,463,85"/><area shape="rect" id="node5" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="513,94,631,122"/><area shape="rect" id="node28" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="513,18,631,46"/><area shape="rect" id="node7" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="703,106,801,134"/><area shape="rect" id="node15" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="697,157,807,185"/><area shape="rect" id="node22" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="681,55,823,83"/><area shape="rect" id="node9" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="896,106,1067,134"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1151,81,1193,109"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1255,106,1308,134"/><area shape="rect" id="node17" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="961,157,1001,185"/><area shape="rect" id="node19" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1139,131,1205,159"/><area shape="rect" id="node25" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="872,5,1091,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4764c1fb83a956c1712345538630854c"></a><!-- doxytag: member="forcetree.c::force_update_hmax" ref="a4764c1fb83a956c1712345538630854c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a4764c1fb83a956c1712345538630854c">force_update_hmax</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function updates the hmax-values in tree nodes that hold SPH particles. These values are needed to find all neighbors in the hydro-force computation. Since the Hsml-values are potentially changed in the SPH-denity computation, <a class="el" href="forcetree_8c.html#a4764c1fb83a956c1712345538630854c">force_update_hmax()</a> should be carried out just before the hydrodynamical SPH forces are computed, i.e. after <a class="el" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c">density()</a>. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01014">1014</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00063">DomainHmax</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="forcetree_8c_source.html#l01051">force_update_node_hmax_local()</a>, <a class="el" href="forcetree_8c_source.html#l01087">force_update_node_hmax_toptree()</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="tags_8h_source.html#l00012">TAG_HMAX</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no;
  MPI_Status status;
  <span class="keywordtype">int</span> level, sendTask, recvTask;

  <a class="code" href="forcetree_8c.html#a4c108b1da2bc4f2620f62aeab90c1074">force_update_node_hmax_local</a>();

  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>; i &lt;= <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[i] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax;
    }

  <span class="comment">/* share the hmax-data of the pseudo-particles accross CPUs */</span>

  <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
    {
      sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
      recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ level;

      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[sendTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask] + 1) * <span class="keyword">sizeof</span>(FLOAT),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a4471e29d2a7331edc863bbf97d324190">TAG_HMAX</a>,
                     &amp;<a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[recvTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask] + 1) * <span class="keyword">sizeof</span>(FLOAT),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a4471e29d2a7331edc863bbf97d324190">TAG_HMAX</a>, MPI_COMM_WORLD, &amp;status);
    }


  <a class="code" href="forcetree_8c.html#ac3f5945bb7c73936ef49af1507265afe">force_update_node_hmax_toptree</a>();
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a4764c1fb83a956c1712345538630854c_cgraph.png" border="0" usemap="#forcetree_8c_a4764c1fb83a956c1712345538630854c_cgraph" alt=""/></div>
<map name="forcetree_8c_a4764c1fb83a956c1712345538630854c_cgraph" id="forcetree_8c_a4764c1fb83a956c1712345538630854c_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a4c108b1da2bc4f2620f62aeab90c1074" title="force_update_node_hmax_local" alt="" coords="212,5,436,33"/><area shape="rect" id="node5" href="forcetree_8c.html#ac3f5945bb7c73936ef49af1507265afe" title="force_update_node_hmax_toptree" alt="" coords="203,55,445,83"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a4764c1fb83a956c1712345538630854c_icgraph.png" border="0" usemap="#forcetree_8c_a4764c1fb83a956c1712345538630854c_icgraph" alt=""/></div>
<map name="forcetree_8c_a4764c1fb83a956c1712345538630854c_icgraph" id="forcetree_8c_a4764c1fb83a956c1712345538630854c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="203,5,373,33"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="421,5,464,33"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="513,5,567,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a04fb647ef783d5baeb9275d806c08365"></a><!-- doxytag: member="forcetree.c::force_update_len" ref="a04fb647ef783d5baeb9275d806c08365" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a04fb647ef783d5baeb9275d806c08365">force_update_len</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function updates the side-length of tree nodes in case the tree is not reconstructed, but only drifted. The grouping of particles to tree nodes is not changed in this case, but some tree nodes may need to be enlarged because particles moved out of their original bounds. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00885">885</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00062">DomainTreeNodeLen</a>, <a class="el" href="forcetree_8c_source.html#l00923">force_update_node_len_local()</a>, <a class="el" href="forcetree_8c_source.html#l00970">force_update_node_len_toptree()</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="tags_8h_source.html#l00011">TAG_NODELEN</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no;
  MPI_Status status;
  <span class="keywordtype">int</span> level, sendTask, recvTask;

  <a class="code" href="forcetree_8c.html#a4592b750f8555f580691103acf1e5366">force_update_node_len_local</a>();

  <span class="comment">/* first update the side-lengths of all local nodes */</span>
  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>; i &lt;= <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[i] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;
    }

  <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
    {
      sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
      recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ level;

      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[sendTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask] + 1) * <span class="keyword">sizeof</span>(FLOAT),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a34f71af73ed54d427aaa8c6df5d3a3d2">TAG_NODELEN</a>,
                     &amp;<a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[recvTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask] + 1) * <span class="keyword">sizeof</span>(FLOAT),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a34f71af73ed54d427aaa8c6df5d3a3d2">TAG_NODELEN</a>, MPI_COMM_WORLD, &amp;status);
    }

  <span class="comment">/* Finally, we update the top-level tree. */</span>
  <a class="code" href="forcetree_8c.html#a5f85438d619d63c812c8e05faf1f0074">force_update_node_len_toptree</a>();
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a04fb647ef783d5baeb9275d806c08365_cgraph.png" border="0" usemap="#forcetree_8c_a04fb647ef783d5baeb9275d806c08365_cgraph" alt=""/></div>
<map name="forcetree_8c_a04fb647ef783d5baeb9275d806c08365_cgraph" id="forcetree_8c_a04fb647ef783d5baeb9275d806c08365_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a4592b750f8555f580691103acf1e5366" title="force_update_node_len_local" alt="" coords="197,5,403,33"/><area shape="rect" id="node5" href="forcetree_8c.html#a5f85438d619d63c812c8e05faf1f0074" title="force_update_node_len_toptree" alt="" coords="188,55,412,83"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a04fb647ef783d5baeb9275d806c08365_icgraph.png" border="0" usemap="#forcetree_8c_a04fb647ef783d5baeb9275d806c08365_icgraph" alt=""/></div>
<map name="forcetree_8c_a04fb647ef783d5baeb9275d806c08365_icgraph" id="forcetree_8c_a04fb647ef783d5baeb9275d806c08365_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="188,5,305,33"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="355,5,573,33"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="621,5,664,33"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="713,5,767,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4c108b1da2bc4f2620f62aeab90c1074"></a><!-- doxytag: member="forcetree.c::force_update_node_hmax_local" ref="a4c108b1da2bc4f2620f62aeab90c1074" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a4c108b1da2bc4f2620f62aeab90c1074">force_update_node_hmax_local</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine updates the hmax-values of local tree nodes. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01051">1051</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, and <a class="el" href="allvars_8c_source.html#l00128">SphP</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l01014">force_update_hmax()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p, no;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i++)
    {

      no = <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[i];

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml &gt; <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax)
        {

          <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml;
          p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.father;

          <span class="keywordflow">while</span>(p &gt;= 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax &gt; <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax)
                {
                  <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax;
                  no = p;
                  p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.father;
                }
              <span class="keywordflow">else</span>
                <span class="keywordflow">break</span>;
            }
        }

    }
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a4c108b1da2bc4f2620f62aeab90c1074_icgraph.png" border="0" usemap="#forcetree_8c_a4c108b1da2bc4f2620f62aeab90c1074_icgraph" alt=""/></div>
<map name="forcetree_8c_a4c108b1da2bc4f2620f62aeab90c1074_icgraph" id="forcetree_8c_a4c108b1da2bc4f2620f62aeab90c1074_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a4764c1fb83a956c1712345538630854c" title="force_update_hmax" alt="" coords="277,5,427,33"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="475,5,645,33"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="693,5,736,33"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="785,5,839,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac3f5945bb7c73936ef49af1507265afe"></a><!-- doxytag: member="forcetree.c::force_update_node_hmax_toptree" ref="ac3f5945bb7c73936ef49af1507265afe" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#ac3f5945bb7c73936ef49af1507265afe">force_update_node_hmax_toptree</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function recursively sets the hmax-values of the top-level tree. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01087">1087</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00063">DomainHmax</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, and <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l01014">force_update_hmax()</a>.</p>
<div class="fragment"><pre class="fragment">{

  <span class="keywordtype">int</span> i, no, p;


  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>)
      {
        no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax &lt; <a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[i])
          <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax = <a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[i];

        p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.father;

        <span class="keywordflow">while</span>(p &gt;= 0)
          {
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax &gt; <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax)
              {
                <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax;
                no = p;
                p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.father;
              }
            <span class="keywordflow">else</span>
              <span class="keywordflow">break</span>;
          }
      }
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ac3f5945bb7c73936ef49af1507265afe_icgraph.png" border="0" usemap="#forcetree_8c_ac3f5945bb7c73936ef49af1507265afe_icgraph" alt=""/></div>
<map name="forcetree_8c_ac3f5945bb7c73936ef49af1507265afe_icgraph" id="forcetree_8c_ac3f5945bb7c73936ef49af1507265afe_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a4764c1fb83a956c1712345538630854c" title="force_update_hmax" alt="" coords="296,5,445,33"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="493,5,664,33"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="712,5,755,33"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="804,5,857,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4592b750f8555f580691103acf1e5366"></a><!-- doxytag: member="forcetree.c::force_update_node_len_local" ref="a4592b750f8555f580691103acf1e5366" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a4592b750f8555f580691103acf1e5366">force_update_node_len_local</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function recursively enlarges nodes such that they always contain all their daughter nodes and daughter particles. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00923">923</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, and <a class="el" href="allvars_8c_source.html#l00120">P</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00885">force_update_len()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p, k, no;
  FLOAT dist, distmax;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[i];

      <span class="keywordflow">for</span>(k = 0, distmax = 0; k &lt; 3; k++)
        {
          dist = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[k] - <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[k];
          <span class="keywordflow">if</span>(dist &lt; 0)
            dist = -dist;
          <span class="keywordflow">if</span>(dist &gt; distmax)
            distmax = dist;
        }

      <span class="keywordflow">if</span>(distmax + distmax &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len)
        {
          <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len = distmax + distmax;
          p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.father;

          <span class="keywordflow">while</span>(p &gt;= 0)
            {
              distmax = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].center[0] - <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[0];
              <span class="keywordflow">if</span>(distmax &lt; 0)
                distmax = -distmax;
              distmax = distmax + distmax + <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;

              <span class="keywordflow">if</span>(0.999999 * distmax &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].len)
                {
                  <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].len = distmax;
                  no = p;
                  p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.father;
                }
              <span class="keywordflow">else</span>
                <span class="keywordflow">break</span>;
            }
        }
    }
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a4592b750f8555f580691103acf1e5366_icgraph.png" border="0" usemap="#forcetree_8c_a4592b750f8555f580691103acf1e5366_icgraph" alt=""/></div>
<map name="forcetree_8c_a4592b750f8555f580691103acf1e5366_icgraph" id="forcetree_8c_a4592b750f8555f580691103acf1e5366_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04fb647ef783d5baeb9275d806c08365" title="force_update_len" alt="" coords="263,5,393,33"/><area shape="rect" id="node5" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="444,5,561,33"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="611,5,829,33"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="877,5,920,33"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="969,5,1023,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5f85438d619d63c812c8e05faf1f0074"></a><!-- doxytag: member="forcetree.c::force_update_node_len_toptree" ref="a5f85438d619d63c812c8e05faf1f0074" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#a5f85438d619d63c812c8e05faf1f0074">force_update_node_len_toptree</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function recursively enlarges nodes of the top-level tree such that they always contain all their daughter nodes. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00970">970</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00062">DomainTreeNodeLen</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, and <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00885">force_update_len()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no, p;
  FLOAT distmax;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>)
      {
        no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len &lt; <a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[i])
          <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len = <a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[i];

        p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.father;

        <span class="keywordflow">while</span>(p &gt;= 0)
          {
            distmax = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].center[0] - <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[0];
            <span class="keywordflow">if</span>(distmax &lt; 0)
              distmax = -distmax;
            distmax = distmax + distmax + <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;

            <span class="keywordflow">if</span>(0.999999 * distmax &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].len)
              {
                <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].len = distmax;
                no = p;
                p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.father;
              }
            <span class="keywordflow">else</span>
              <span class="keywordflow">break</span>;
          }
      }
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_a5f85438d619d63c812c8e05faf1f0074_icgraph.png" border="0" usemap="#forcetree_8c_a5f85438d619d63c812c8e05faf1f0074_icgraph" alt=""/></div>
<map name="forcetree_8c_a5f85438d619d63c812c8e05faf1f0074_icgraph" id="forcetree_8c_a5f85438d619d63c812c8e05faf1f0074_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04fb647ef783d5baeb9275d806c08365" title="force_update_len" alt="" coords="281,5,412,33"/><area shape="rect" id="node5" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="463,5,580,33"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="629,5,848,33"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="896,5,939,33"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="988,5,1041,33"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab745c54c805d07ad255a3f86ff77e18d"></a><!-- doxytag: member="forcetree.c::force_update_node_recursive" ref="ab745c54c805d07ad255a3f86ff77e18d" args="(int no, int sib, int father)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#ab745c54c805d07ad255a3f86ff77e18d">force_update_node_recursive</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>no</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>sib</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>father</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>this routine determines the multipole moments for a given internal node and all its subnodes using a recursive computation. The result is stored in the Nodes[] structure in the sequence of this tree-walk.</p>
<p>Note that the bitflags-variable for each node is used to store in the lowest bits some special information: Bit 0 flags whether the node belongs to the top-level tree corresponding to the domain decomposition, while Bit 1 signals whether the top-level node is dependent on local mass.</p>
<p>If UNEQUALSOFTENINGS is set, bits 2-4 give the particle type with the maximum softening among the particles in the node, and bit 5 flags whether the node contains any particles with lower softening than that. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00422">422</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="forcetree_8c_source.html#l00422">force_update_node_recursive()</a>, <a class="el" href="forcetree_8c_source.html#l00026">last</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8c_source.html#l00128">SphP</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>, and <a class="el" href="forcetree_8c_source.html#l00422">force_update_node_recursive()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> j, jj, p, pp, nextsib, suns[8];
  FLOAT hmax;

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype, diffsoftflag;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  FLOAT maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  <span class="keyword">struct </span>particle_data *pa;
  <span class="keywordtype">double</span> s[3], vs[3], mass;

  <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart &amp;&amp; no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)  <span class="comment">/* internal node */</span>
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
        suns[j] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.suns[j];  <span class="comment">/* this &quot;backup&quot; is necessary because the nextnode entry will</span>
<span class="comment">                                           overwrite one element (union!) */</span>
      <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= 0)
        {
          <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)
            {
              <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)        <span class="comment">/* a pseudo-particle */</span>
                <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>] = no;
              <span class="keywordflow">else</span>
                <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>].u.d.nextnode = no;
            }
          <span class="keywordflow">else</span>
            <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>] = no;
        }

      <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> = no;

      mass = 0;
      s[0] = 0;
      s[1] = 0;
      s[2] = 0;
      vs[0] = 0;
      vs[1] = 0;
      vs[2] = 0;
      hmax = 0;
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      maxsofttype = 7;
      diffsoftflag = 0;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      maxsoft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
        {
          <span class="keywordflow">if</span>((p = suns[j]) &gt;= 0)
            {
              <span class="comment">/* check if we have a sibling on the same level */</span>
              <span class="keywordflow">for</span>(jj = j + 1; jj &lt; 8; jj++)
                <span class="keywordflow">if</span>((pp = suns[jj]) &gt;= 0)
                  <span class="keywordflow">break</span>;

              <span class="keywordflow">if</span>(jj &lt; 8)        <span class="comment">/* yes, we do */</span>
                nextsib = pp;
              <span class="keywordflow">else</span>
                nextsib = sib;

              <a class="code" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d">force_update_node_recursive</a>(p, nextsib, no);


              <span class="keywordflow">if</span>(p &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)      <span class="comment">/* an internal node or pseudo particle */</span>
                {
                  <span class="keywordflow">if</span>(p &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)       <span class="comment">/* a pseudo particle */</span>
                    {
                      <span class="comment">/* nothing to be done here because the mass of the</span>
<span class="comment">                       * pseudo-particle is still zero. This will be changed</span>
<span class="comment">                       * later.</span>
<span class="comment">                       */</span>
                    }
                  <span class="keywordflow">else</span>
                    {
                      mass += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.mass;
                      s[0] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.mass * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.s[0];
                      s[1] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.mass * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.s[1];
                      s[2] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.mass * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.s[2];
                      vs[0] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.mass * <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].vs[0];
                      vs[1] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.mass * <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].vs[1];
                      vs[2] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.mass * <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].vs[2];

                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax &gt; hmax)
                        hmax = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax;

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>                      diffsoftflag |= (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.bitflags &gt;&gt; 5) &amp; 1;

                      <span class="keywordflow">if</span>(maxsofttype == 7)
                        {
                          maxsofttype = (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.bitflags &gt;&gt; 2) &amp; 7;
                        }
                      <span class="keywordflow">else</span>
                        {
                          <span class="keywordflow">if</span>(((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.bitflags &gt;&gt; 2) &amp; 7) != 7)
                            {
                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.bitflags &gt;&gt; 2) &amp; 7)] &gt;
                                 <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                                {
                                  maxsofttype = ((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.bitflags &gt;&gt; 2) &amp; 7);
                                  diffsoftflag = 1;
                                }
                              <span class="keywordflow">else</span>
                                {
                                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.d.bitflags &gt;&gt; 2) &amp; 7)] &lt;
                                     <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                                    diffsoftflag = 1;
                                }
                            }
                        }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].maxsoft &gt; maxsoft)
                        maxsoft = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                    }
                }
              <span class="keywordflow">else</span>              <span class="comment">/* a particle */</span>
                {
                  pa = &amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p];

                  mass += pa-&gt;Mass;
                  s[0] += pa-&gt;Mass * pa-&gt;Pos[0];
                  s[1] += pa-&gt;Mass * pa-&gt;Pos[1];
                  s[2] += pa-&gt;Mass * pa-&gt;Pos[2];
                  vs[0] += pa-&gt;Mass * pa-&gt;Vel[0];
                  vs[1] += pa-&gt;Mass * pa-&gt;Vel[1];
                  vs[2] += pa-&gt;Mass * pa-&gt;Vel[2];

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>                  <span class="keywordflow">if</span>(maxsofttype == 7)
                    {
                      maxsofttype = pa-&gt;Type;
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[pa-&gt;Type] &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                        {
                          maxsofttype = pa-&gt;Type;
                          diffsoftflag = 1;
                        }
                      <span class="keywordflow">else</span>
                        {
                          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[pa-&gt;Type] &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[maxsofttype])
                            diffsoftflag = 1;
                        }
                    }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>                  <span class="keywordflow">if</span>(pa-&gt;Type == 0)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Hsml &gt; maxsoft)
                        maxsoft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Hsml;
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[pa-&gt;Type] &gt; maxsoft)
                        maxsoft = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.ForceSoftening[pa-&gt;Type];
                    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                  <span class="keywordflow">if</span>(pa-&gt;Type == 0)
                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Hsml &gt; hmax)
                      hmax = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Hsml;
                }
            }
        }


      <span class="keywordflow">if</span>(mass)
        {
          s[0] /= mass;
          s[1] /= mass;
          s[2] /= mass;
          vs[0] /= mass;
          vs[1] /= mass;
          vs[2] /= mass;
        }
      <span class="keywordflow">else</span>
        {
          s[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[0];
          s[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[1];
          s[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].center[2];
        }

      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[0] = s[0];
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[1] = s[1];
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.s[2] = s[2];
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.mass = mass;


<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags = 4 * maxsofttype + 32 * diffsoftflag;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags = 0;
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft = maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.bitflags = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

      <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[0] = vs[0];
      <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[1] = vs[1];
      <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[2] = vs[2];
      <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax = hmax;

      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.sibling = sib;
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.d.father = father;
    }
  <span class="keywordflow">else</span>                          <span class="comment">/* single particle or pseudo particle */</span>
    {
      <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= 0)
        {
          <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)
            {
              <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)        <span class="comment">/* a pseudo-particle */</span>
                <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>] = no;
              <span class="keywordflow">else</span>
                <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>].u.d.nextnode = no;
            }
          <span class="keywordflow">else</span>
            <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>] = no;
        }

      <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> = no;

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.MaxPart)      <span class="comment">/* only set it for single particles */</span>
        <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[no] = father;
    }

}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ab745c54c805d07ad255a3f86ff77e18d_cgraph.png" border="0" usemap="#forcetree_8c_ab745c54c805d07ad255a3f86ff77e18d_cgraph" alt=""/></div>
<map name="forcetree_8c_ab745c54c805d07ad255a3f86ff77e18d_cgraph" id="forcetree_8c_ab745c54c805d07ad255a3f86ff77e18d_cgraph">
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_ab745c54c805d07ad255a3f86ff77e18d_icgraph.png" border="0" usemap="#forcetree_8c_ab745c54c805d07ad255a3f86ff77e18d_icgraph" alt=""/></div>
<map name="forcetree_8c_ab745c54c805d07ad255a3f86ff77e18d_icgraph" id="forcetree_8c_ab745c54c805d07ad255a3f86ff77e18d_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="524,55,684,83"/><area shape="rect" id="node28" href="proto_8h.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="264,93,475,121"/><area shape="rect" id="node5" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="733,55,851,83"/><area shape="rect" id="node7" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="921,55,1020,83"/><area shape="rect" id="node15" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="916,5,1025,33"/><area shape="rect" id="node22" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="900,106,1041,134"/><area shape="rect" id="node9" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="1115,55,1285,83"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1369,94,1412,122"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1473,57,1527,85"/><area shape="rect" id="node17" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1180,5,1220,33"/><area shape="rect" id="node19" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1357,18,1424,46"/><area shape="rect" id="node25" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="1091,106,1309,134"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af9a7e3a922557e089da5d7ee1dde89a0"></a><!-- doxytag: member="forcetree.c::force_update_pseudoparticles" ref="af9a7e3a922557e089da5d7ee1dde89a0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="proto_8h.html#af9a7e3a922557e089da5d7ee1dde89a0">force_update_pseudoparticles</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function updates the multipole moments of the pseudo-particles that represent the mass distribution on different CPUs. For that purpose, it first exchanges the necessary data, and then updates the top-level tree accordingly. The detailed implementation of these two tasks is done in separate functions. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00671">671</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="forcetree_8c_source.html#l00684">force_exchange_pseudodata()</a>, and <a class="el" href="forcetree_8c_source.html#l00732">force_treeupdate_pseudos()</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>, and <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>.</p>
<div class="fragment"><pre class="fragment">{
  <a class="code" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb">force_exchange_pseudodata</a>();

  <a class="code" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19">force_treeupdate_pseudos</a>();
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_af9a7e3a922557e089da5d7ee1dde89a0_cgraph.png" border="0" usemap="#forcetree_8c_af9a7e3a922557e089da5d7ee1dde89a0_cgraph" alt=""/></div>
<map name="forcetree_8c_af9a7e3a922557e089da5d7ee1dde89a0_cgraph" id="forcetree_8c_af9a7e3a922557e089da5d7ee1dde89a0_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb" title="force_exchange_pseudodata" alt="" coords="271,5,476,33"/><area shape="rect" id="node5" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19" title="force_treeupdate_pseudos" alt="" coords="277,55,469,83"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="forcetree_8c_af9a7e3a922557e089da5d7ee1dde89a0_icgraph.png" border="0" usemap="#forcetree_8c_af9a7e3a922557e089da5d7ee1dde89a0_icgraph" alt=""/></div>
<map name="forcetree_8c_af9a7e3a922557e089da5d7ee1dde89a0_icgraph" id="forcetree_8c_af9a7e3a922557e089da5d7ee1dde89a0_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="271,94,388,122"/><area shape="rect" id="node26" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="271,18,388,46"/><area shape="rect" id="node5" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="460,106,559,134"/><area shape="rect" id="node13" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="455,157,564,185"/><area shape="rect" id="node20" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="439,55,580,83"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="653,106,824,134"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="908,81,951,109"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1012,106,1065,134"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="719,157,759,185"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="896,131,963,159"/><area shape="rect" id="node23" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="629,5,848,33"/></map>
</div>
</p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="af6350369fa0c71cba122f936412fcb4d"></a><!-- doxytag: member="forcetree.c::fac_intp" ref="af6350369fa0c71cba122f936412fcb4d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00053">53</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03312">ewald_corr()</a>, <a class="el" href="forcetree_8c_source.html#l03163">ewald_init()</a>, <a class="el" href="forcetree_8c_source.html#l03401">ewald_pot_corr()</a>, and <a class="el" href="forcetree_8c_source.html#l02018">force_treeevaluate_ewald_correction()</a>.</p>

</div>
</div>
<a class="anchor" id="aa5cc9e7d836cdcf307f7640533e5e928"></a><!-- doxytag: member="forcetree.c::fcorrx" ref="aa5cc9e7d836cdcf307f7640533e5e928" args="[64+1][64+1][64+1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float <a class="el" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[64+1][64+1][64+1]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>3D lock-up table for Ewald correction to force and potential. Only one octant is stored, the rest constructed by using the symmetry </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00049">49</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03312">ewald_corr()</a>, <a class="el" href="forcetree_8c_source.html#l03163">ewald_init()</a>, and <a class="el" href="forcetree_8c_source.html#l02018">force_treeevaluate_ewald_correction()</a>.</p>

</div>
</div>
<a class="anchor" id="ac7d44a9c9f475423540e3acd8bca75d3"></a><!-- doxytag: member="forcetree.c::fcorry" ref="ac7d44a9c9f475423540e3acd8bca75d3" args="[64+1][64+1][64+1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float <a class="el" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[64+1][64+1][64+1]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00050">50</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03312">ewald_corr()</a>, <a class="el" href="forcetree_8c_source.html#l03163">ewald_init()</a>, and <a class="el" href="forcetree_8c_source.html#l02018">force_treeevaluate_ewald_correction()</a>.</p>

</div>
</div>
<a class="anchor" id="aa4f6ad92e563dd2a0d0b324452b051f6"></a><!-- doxytag: member="forcetree.c::fcorrz" ref="aa4f6ad92e563dd2a0d0b324452b051f6" args="[64+1][64+1][64+1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float <a class="el" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[64+1][64+1][64+1]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00051">51</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03312">ewald_corr()</a>, <a class="el" href="forcetree_8c_source.html#l03163">ewald_init()</a>, and <a class="el" href="forcetree_8c_source.html#l02018">force_treeevaluate_ewald_correction()</a>.</p>

</div>
</div>
<a class="anchor" id="a37ea0ff529d9c7e76f1f7895bde01183"></a><!-- doxytag: member="forcetree.c::first_flag" ref="a37ea0ff529d9c7e76f1f7895bde01183" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="forcetree_8c.html#a37ea0ff529d9c7e76f1f7895bde01183">first_flag</a> = 0<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>toggles after first tree-memory allocation, has only influence on log-files </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00036">36</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02911">force_treeallocate()</a>.</p>

</div>
</div>
<a class="anchor" id="a72e27dee31b1c4c6a504fbed29542d97"></a><!-- doxytag: member="forcetree.c::last" ref="a72e27dee31b1c4c6a504fbed29542d97" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>auxialiary variable used to set-up non-recursive walk </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00026">26</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>, and <a class="el" href="forcetree_8c_source.html#l00422">force_update_node_recursive()</a>.</p>

</div>
</div>
<a class="anchor" id="a7a88fa4a0ea6d18436481c44288646a0"></a><!-- doxytag: member="forcetree.c::potcorr" ref="a7a88fa4a0ea6d18436481c44288646a0" args="[64+1][64+1][64+1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float <a class="el" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[64+1][64+1][64+1]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00052">52</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03163">ewald_init()</a>, and <a class="el" href="forcetree_8c_source.html#l03401">ewald_pot_corr()</a>.</p>

</div>
</div>
<a class="anchor" id="a76b621ce2fa9c17911a62495174029eb"></a><!-- doxytag: member="forcetree.c::shortrange_table" ref="a76b621ce2fa9c17911a62495174029eb" args="[1000]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float <a class="el" href="forcetree_8c.html#a76b621ce2fa9c17911a62495174029eb">shortrange_table</a>[1000]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00033">33</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02911">force_treeallocate()</a>, and <a class="el" href="forcetree_8c_source.html#l01542">force_treeevaluate_shortrange()</a>.</p>

</div>
</div>
<a class="anchor" id="a196b7c27d03bd3ecc1259b2f67017fbe"></a><!-- doxytag: member="forcetree.c::shortrange_table_potential" ref="a196b7c27d03bd3ecc1259b2f67017fbe" args="[1000]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float <a class="el" href="forcetree_8c.html#a196b7c27d03bd3ecc1259b2f67017fbe">shortrange_table_potential</a>[1000]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00033">33</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02911">force_treeallocate()</a>, and <a class="el" href="forcetree_8c_source.html#l02577">force_treeevaluate_potential_shortrange()</a>.</p>

</div>
</div>
<a class="anchor" id="abe941030bf66a95df993b617bffefd9b"></a><!-- doxytag: member="forcetree.c::tabfac" ref="abe941030bf66a95df993b617bffefd9b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float <a class="el" href="forcetree_8c.html#abe941030bf66a95df993b617bffefd9b">tabfac</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>variables for short-range lookup table </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00033">33</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02911">force_treeallocate()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="forcetree_8c.html">forcetree.c</a>      </li>

    <li class="footer">Generated on Fri Dec 6 2013 15:20:10 for gadget-sidm by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
