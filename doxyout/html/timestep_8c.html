<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>GADGET-2: timestep.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<h1>timestep.c File Reference</h1>  </div>
</div>
<div class="contents">

<p>routines for 'kicking' particles in momentum space and assigning new timesteps  
<a href="#_details">More...</a></p>
<code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;mpi.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="allvars_8h_source.html">allvars.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="proto_8h_source.html">proto.h</a>&quot;</code><br/>
<div class="dynheader">
Include dependency graph for timestep.c:</div>
<div class="dyncontent">
<div class="center"><img src="timestep_8c__incl.png" border="0" usemap="#timestep_8c" alt=""/></div>
<map name="timestep_8c" id="timestep_8c">
<area shape="rect" id="node13" href="allvars_8h.html" title="declares global variables." alt="" coords="352,160,427,189"/><area shape="rect" id="node20" href="proto_8h.html" title="this file contains all function prototypes of the code" alt="" coords="437,83,504,112"/><area shape="rect" id="node18" href="tags_8h.html" title="declares various tags for labelling MPI messages." alt="" coords="412,237,473,267"/></map>
</div>

<p><a href="timestep_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06">advance_and_find_timesteps</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#af48922752ff457721f558510789e61e1">get_timestep</a> (int p, double *aphys, int flag)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#a78ed439b8a1cb93647a2b9de998d9269">find_dt_displacement_constraint</a> (double hfac)</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#aebe1da050ef46b7b63c856394494292c">fac3</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> = 0</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>routines for 'kicking' particles in momentum space and assigning new timesteps </p>

<p>Definition in file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a05e5a546d63684b55d2457aa56efdd06"></a><!-- doxytag: member="timestep.c::advance_and_find_timesteps" ref="a05e5a546d63684b55d2457aa56efdd06" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void advance_and_find_timesteps </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function advances the system in momentum space, i.e. it does apply the 'kick' operation after the forces have been computed. Additionally, it assigns new timesteps to particles. At start-up, a half-timestep is carried out, as well as at the end of the simulation. In between, the half-step kick that ends the previous timestep and the half-step kick for the new timestep are combined into one operation. </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29 </p>
</p>

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00024">24</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>References <a class="el" href="timestep_8c_source.html#l00013">a3inv</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="timestep_8c_source.html#l00013">atime</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00421">global_data_all_processes::CPU_TimeLine</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="timestep_8c_source.html#l00014">dt_displacement</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="allvars_8h_source.html#l00554">sph_particle_data::Entropy</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="timestep_8c_source.html#l00013">fac1</a>, <a class="el" href="timestep_8c_source.html#l00013">fac2</a>, <a class="el" href="timestep_8c_source.html#l00013">fac3</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="timestep_8c_source.html#l00566">find_dt_displacement_constraint()</a>, <a class="el" href="allvars_8c_source.html#l00040">Flag_FullStep</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="allvars_8h_source.html#l00071">GAMMA_MINUS1</a>, <a class="el" href="driftfac_8c_source.html#l00105">get_gravkick_factor()</a>, <a class="el" href="driftfac_8c_source.html#l00142">get_hydrokick_factor()</a>, <a class="el" href="system_8c_source.html#l00029">get_random_number()</a>, <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00518">particle_data::GravPM</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="timestep_8c_source.html#l00013">hubble_a</a>, <a class="el" href="allvars_8h_source.html#l00562">sph_particle_data::HydroAccel</a>, <a class="el" href="allvars_8h_source.html#l00438">global_data_all_processes::MaxSizeTimestep</a>, <a class="el" href="allvars_8h_source.html#l00310">global_data_all_processes::MinEgySpec</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00386">global_data_all_processes::PM_Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00041">TIMEBASE</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00563">sph_particle_data::VelPred</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, no, ti_step, ti_min, tend, tstart;
  <span class="keywordtype">double</span> dt_entr, dt_entr2, dt_gravkick, dt_hydrokick, dt_gravkick2, dt_hydrokick2, t0, t1;
  <span class="keywordtype">double</span> minentropy, aphys;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> dv[3];

<span class="preprocessor">#ifdef FLEXSTEPS</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> ti_grp;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#if defined(PSEUDOSYMMETRIC) &amp;&amp; !defined(FLEXSTEPS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> apred, prob;
  <span class="keywordtype">int</span> ti_step2;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_gravkickA, dt_gravkickB;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef MAKEGLASS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> disp, dispmax, globmax, dmean, fac, disp2sum, globdisp2sum;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> = 1 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>);
      <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> = 1 / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, 3 * <a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> - 2);
      <a class="code" href="timestep_8c.html#aebe1da050ef46b7b63c856394494292c">fac3</a> = <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, 3 * (1 - <a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a>) / 2.0);
      <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>)
        + (1 - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>) / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>;

      <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * sqrt(<a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>);
      <a class="code" href="timestep_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a> = 1 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>);
      <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
    }
  <span class="keywordflow">else</span>
    <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> = <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> = <a class="code" href="timestep_8c.html#aebe1da050ef46b7b63c856394494292c">fac3</a> = <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="timestep_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a> = <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> = 1;

<span class="preprocessor">#ifdef NOPMSTEPADJUSTMENT</span>
<span class="preprocessor"></span>  <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a6343a9f3619e77c1796309b8deda7f50">Flag_FullStep</a> || <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> == 0)
    <a class="code" href="proto_8h.html#a78ed439b8a1cb93647a2b9de998d9269">find_dt_displacement_constraint</a>(<a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    dt_gravkickB = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
      <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2);
  <span class="keywordflow">else</span>
    dt_gravkickB = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)       <span class="comment">/* need to do long-range kick */</span>
    {
      <span class="comment">/* make sure that we reconstruct the domain/tree next time because we don&#39;t kick the tree nodes in this case */</span>
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="preprocessor">#ifdef MAKEGLASS</span>
<span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0, dispmax = 0, disp2sum = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] *= -1;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] *= -1;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j];
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] = 0;
        }

      disp = sqrt(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravAccel[0] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravAccel[0] +
                  <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravAccel[1] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravAccel[1] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravAccel[2] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravAccel[2]);

      disp *= 2.0 / (3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>);

      disp2sum += disp * disp;

      <span class="keywordflow">if</span>(disp &gt; dispmax)
        dispmax = disp;
    }

  MPI_Allreduce(&amp;dispmax, &amp;globmax, 1, MPI_DOUBLE, MPI_MAX, MPI_COMM_WORLD);
  MPI_Allreduce(&amp;disp2sum, &amp;globdisp2sum, 1, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);

  dmean = <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].Mass / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> * 3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>)), 1.0 / 3);

  <span class="keywordflow">if</span>(globmax &gt; dmean)
    fac = dmean / globmax;
  <span class="keywordflow">else</span>
    fac = 1.0;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;\nglass-making:  dmean= %g  global disp-maximum= %g  rms= %g\n\n&quot;</span>,
             dmean, globmax, sqrt(globdisp2sum / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a>));
      fflush(stdout);
    }

  <span class="keywordflow">for</span>(i = 0, dispmax = 0; i &lt; NumPart; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] = 0;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j] += fac * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] * 2.0 / (3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>);
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] = 0;
        }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>



  <span class="comment">/* Now assign new timesteps and kick */</span>

<span class="preprocessor">#ifdef FLEXSTEPS</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> % (4 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep)) == 0)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep &lt; <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>)
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep *= 2;

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
        {
          ti_step = <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;aphys, 0);

          <span class="comment">/* make it a power 2 subdivision */</span>
          ti_min = TIMEBASE;
          <span class="keywordflow">while</span>(ti_min &gt; ti_step)
            ti_min &gt;&gt;= 1;
          ti_step = ti_min;

          <span class="keywordflow">if</span>(ti_step &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep)
            <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep = ti_step;
        }
    }

  ti_step = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep;
  MPI_Allreduce(&amp;ti_step, &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep, 1, MPI_INT, MPI_MIN, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(<a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>)
    ti_step = (int) (<a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>);
  <span class="keywordflow">else</span>
    ti_step = (int) (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>);

  <span class="comment">/* make it a power 2 subdivision */</span>
  ti_min = TIMEBASE;
  <span class="keywordflow">while</span>(ti_min &gt; ti_step)
    ti_min &gt;&gt;= 1;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMaxStep = ti_min;


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;Syn Range = %g  PresentMinStep = %d  PresentMaxStep = %d \n&quot;</span>,
           (<span class="keywordtype">double</span>) <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMaxStep / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMaxStep);

<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
        {
          ti_step = <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;aphys, 0);

          <span class="comment">/* make it a power 2 subdivision */</span>
          ti_min = TIMEBASE;
          <span class="keywordflow">while</span>(ti_min &gt; ti_step)
            ti_min &gt;&gt;= 1;
          ti_step = ti_min;

<span class="preprocessor">#ifdef FLEXSTEPS</span>
<span class="preprocessor"></span>          ti_grp = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].FlexStepGrp % <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMaxStep;
          ti_grp = (ti_grp / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep;
          ti_step = ((<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> + ti_grp + ti_step) / ti_step) * ti_step - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep + ti_grp);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef PSEUDOSYMMETRIC</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type != 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep &gt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep)
                {
                  apred = aphys + ((aphys - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].AphysOld) / (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep)) * ti_step;
                  <span class="keywordflow">if</span>(fabs(apred - aphys) &lt; 0.5 * aphys)
                    {
                      ti_step2 = <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;apred, -1);
                      ti_min = TIMEBASE;
                      <span class="keywordflow">while</span>(ti_min &gt; ti_step2)
                        ti_min &gt;&gt;= 1;
                      ti_step2 = ti_min;

                      <span class="keywordflow">if</span>(ti_step2 &lt; ti_step)
                        {
                          <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;apred, ti_step);
                          prob =
                            ((apred - aphys) / (aphys - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].AphysOld) * (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> -
                                                                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>)) / ti_step;
                          <span class="keywordflow">if</span>(prob &lt; <a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].ID))
                            ti_step /= 2;
                        }
                      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ti_step2 &gt; ti_step)
                        {
                          <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;apred, 2 * ti_step);
                          prob =
                            ((apred - aphys) / (aphys - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].AphysOld) * (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> -
                                                                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>)) / ti_step;
                          <span class="keywordflow">if</span>(prob &lt; <a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].ID + 1))
                            ti_step *= 2;
                        }
                    }
                }
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].AphysOld = aphys;
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef SYNCHRONIZATION</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ti_step &gt; (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep))     <span class="comment">/* timestep wants to increase */</span>
            {
              <span class="keywordflow">if</span>(((<a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep) % ti_step) &gt; 0)
                ti_step = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>;    <span class="comment">/* leave at old step */</span>
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* end of FLEXSTEPS */</span>

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> == <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>)        <span class="comment">/* we here finish the last timestep. */</span>
            ti_step = 0;

          <span class="keywordflow">if</span>((<a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) &lt; ti_step)     <span class="comment">/* check that we don&#39;t run beyond the end */</span>
            ti_step = <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>;

          tstart = (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2;     <span class="comment">/* midpoint of old step */</span>
          tend = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> + ti_step / 2; <span class="comment">/* midpoint of new step */</span>

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
            {
              dt_entr = (tend - tstart) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              dt_entr2 = (tend - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              dt_gravkick = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(tstart, tend);
              dt_hydrokick = <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(tstart, tend);
              dt_gravkick2 = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep, tend);
              dt_hydrokick2 = <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep, tend);
            }
          <span class="keywordflow">else</span>
            {
              dt_entr = dt_gravkick = dt_hydrokick = (tend - tstart) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              dt_gravkick2 = dt_hydrokick2 = dt_entr2 = (tend - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
            }

          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + ti_step;


          <span class="comment">/* do the kick */</span>

          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            {
              dv[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] * dt_gravkick;
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] += dv[j];
            }

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type == 0)    <span class="comment">/* SPH stuff */</span>
            {
              <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
                {
                  dv[j] += <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j] * dt_hydrokick;
                  <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] += <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j] * dt_hydrokick;

                  <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[j] =
                    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] - dt_gravkick2 * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] - dt_hydrokick2 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j];
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>                  <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] * dt_gravkickB;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                }

              <span class="comment">/* In case of cooling, we prevent that the entropy (and</span>
<span class="comment">                 hence temperature decreases by more than a factor 0.5 */</span>

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].DtEntropy * dt_entr &gt; -0.5 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy)
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> += <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> * dt_entr;
              <span class="keywordflow">else</span>
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> *= 0.5;

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a>)
                {
                  minentropy = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a> * <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a> / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Density * <a class="code" href="timestep_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a>, <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>);
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy &lt; minentropy)
                    {
                      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> = minentropy;
                      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> = 0;
                    }
                }

              <span class="comment">/* In case the timestep increases in the new step, we</span>
<span class="comment">                 make sure that we do not &#39;overcool&#39; when deriving</span>
<span class="comment">                 predicted temperatures. The maximum timespan over</span>
<span class="comment">                 which prediction can occur is ti_step/2, i.e. from</span>
<span class="comment">                 the middle to the end of the current step */</span>

              dt_entr = ti_step / 2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].DtEntropy * dt_entr &lt; 0.5 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy)
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> = -0.5 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> / dt_entr;
            }


          <span class="comment">/* if tree is not going to be reconstructed, kick parent nodes dynamically.</span>
<span class="comment">           */</span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>)
            {
              no = <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[i];
              <span class="keywordflow">while</span>(no &gt;= 0)
                {
                  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
                    <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[j] += dv[j] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass / <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;

                  no = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;
                }
            }
        }
    }



<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)       <span class="comment">/* need to do long-range kick */</span>
    {
      ti_step = TIMEBASE;
      <span class="keywordflow">while</span>(ti_step &gt; (<a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>))
        ti_step &gt;&gt;= 1;

      <span class="keywordflow">if</span>(ti_step &gt; (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>))     <span class="comment">/* PM-timestep wants to increase */</span>
        {
          <span class="comment">/* we only increase if an integer number of steps will bring us to the end */</span>
          <span class="keywordflow">if</span>(((<a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) % ti_step) &gt; 0)
            ti_step = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>;    <span class="comment">/* leave at old step */</span>
        }

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> == <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>)    <span class="comment">/* we here finish the last timestep. */</span>
        ti_step = 0;

      tstart = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2;
      tend = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> + ti_step / 2;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        dt_gravkick = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(tstart, tend);
      <span class="keywordflow">else</span>
        dt_gravkick = (tend - tstart) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + ti_step;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        dt_gravkickB = -<a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2);
      <span class="keywordflow">else</span>
        dt_gravkickB =
          -((<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2 - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        {
          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)        <span class="comment">/* do the kick */</span>
            <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Vel[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravPM[j] * dt_gravkick;

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type == 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
                {
                  dt_gravkickA = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
                    <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep) / 2);
                  dt_hydrokick = <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
                    <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep) / 2);
                }
              <span class="keywordflow">else</span>
                dt_gravkickA = dt_hydrokick =
                  (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

              <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].VelPred[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Vel[j]
                  + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravAccel[j] * dt_gravkickA
                  + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].HydroAccel[j] * dt_hydrokick + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravPM[j] * dt_gravkickB;
            }
        }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a675f7230ece5f6d88fcc0384a8e1f6c9">CPU_TimeLine</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="timestep_8c_a05e5a546d63684b55d2457aa56efdd06_cgraph.png" border="0" usemap="#timestep_8c_a05e5a546d63684b55d2457aa56efdd06_cgraph" alt=""/></div>
<map name="timestep_8c_a05e5a546d63684b55d2457aa56efdd06_cgraph" id="timestep_8c_a05e5a546d63684b55d2457aa56efdd06_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a78ed439b8a1cb93647a2b9de998d9269" title="find_dt_displacement_constraint" alt="" coords="261,250,491,279"/><area shape="rect" id="node5" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="549,36,595,66"/><area shape="rect" id="node7" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="303,90,449,119"/><area shape="rect" id="node9" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="299,143,453,172"/><area shape="rect" id="node11" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="297,196,455,226"/><area shape="rect" id="node13" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8" title="get_timestep" alt="" coords="323,356,429,386"/><area shape="rect" id="node20" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="343,303,409,332"/><area shape="rect" id="node22" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="341,36,411,66"/><area shape="rect" id="node15" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="539,356,605,386"/><area shape="rect" id="node17" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="653,356,811,386"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="timestep_8c_a05e5a546d63684b55d2457aa56efdd06_icgraph.png" border="0" usemap="#timestep_8c_a05e5a546d63684b55d2457aa56efdd06_icgraph" alt=""/></div>
<map name="timestep_8c_a05e5a546d63684b55d2457aa56efdd06_icgraph" id="timestep_8c_a05e5a546d63684b55d2457aa56efdd06_icgraph">
<area shape="rect" id="node3" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="261,5,304,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="353,5,407,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a78ed439b8a1cb93647a2b9de998d9269"></a><!-- doxytag: member="timestep.c::find_dt_displacement_constraint" ref="a78ed439b8a1cb93647a2b9de998d9269" args="(double hfac)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void find_dt_displacement_constraint </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>hfac</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes an upper limit ('dt_displacement') to the global timestep of the system based on the rms velocities of particles. For cosmological simulations, the criterion used is that the rms displacement should be at most a fraction MaxRMSDisplacementFac of the mean particle separation. Note that the latter is estimated using the assigned particle masses, separately for each particle type. If comoving integration is not used, the function imposes no constraint on the timestep. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>hfac</em>&nbsp;</td><td>should be a^2*H(a) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00566">566</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00393">global_data_all_processes::Asmth</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="timestep_8c_source.html#l00014">dt_displacement</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00440">global_data_all_processes::MaxRMSDisplacementFac</a>, <a class="el" href="allvars_8h_source.html#l00438">global_data_all_processes::MaxSizeTimestep</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00341">global_data_all_processes::OmegaBaryon</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, and <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, type, *temp;
  <span class="keywordtype">int</span> count[6];
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> count_sum[6];
  <span class="keywordtype">double</span> v[6], v_sum[6], mim[6], min_mass[6];
  <span class="keywordtype">double</span> dt, dmean, asmth = 0;

  <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
        {
          count[type] = 0;
          v[type] = 0;
          mim[type] = 1.0e30;
        }

      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
        {
          v[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] += P[i].Vel[0] * P[i].Vel[0] + P[i].Vel[1] * P[i].Vel[1] + P[i].Vel[2] * P[i].Vel[2];
          <span class="keywordflow">if</span>(mim[P[i].Type] &gt; P[i].Mass)
            mim[P[i].Type] = P[i].Mass;
          count[P[i].Type]++;
        }

      MPI_Allreduce(v, v_sum, 6, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
      MPI_Allreduce(mim, min_mass, 6, MPI_DOUBLE, MPI_MIN, MPI_COMM_WORLD);

      temp = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * 6 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
      MPI_Allgather(count, 6, MPI_INT, temp, 6, MPI_INT, MPI_COMM_WORLD);
      <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
        {
          count_sum[i] = 0;
          <span class="keywordflow">for</span>(j = 0; j &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; j++)
            count_sum[i] += temp[j * 6 + i];
        }
      free(temp);

      <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
        {
          <span class="keywordflow">if</span>(count_sum[type] &gt; 0)
            {
              <span class="keywordflow">if</span>(type == 0)
                dmean =
                  <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(min_mass[type] / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5656f8668fd420a86cb7372869745fee">OmegaBaryon</a> * 3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>)),
                      1.0 / 3);
              <span class="keywordflow">else</span>
                dmean =
                  <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(min_mass[type] /
                      ((<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5656f8668fd420a86cb7372869745fee">OmegaBaryon</a>) * 3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>)),
                      1.0 / 3);

              dt = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a988ecf1fcfe5e61ff9ac29792c816c24">MaxRMSDisplacementFac</a> * hfac * dmean / sqrt(v_sum[type] / count_sum[type]);

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>              asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[0];
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(((1 &lt;&lt; type) &amp; (PLACEHIGHRESREGION)))
                asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[1];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(asmth &lt; dmean)
                dt = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a988ecf1fcfe5e61ff9ac29792c816c24">MaxRMSDisplacementFac</a> * hfac * asmth / sqrt(v_sum[type] / count_sum[type]);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
                printf(<span class="stringliteral">&quot;type=%d  dmean=%g asmth=%g minmass=%g a=%g  sqrt(&lt;p^2&gt;)=%g  dlogmax=%g\n&quot;</span>,
                       type, dmean, asmth, min_mass[type], <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, sqrt(v_sum[type] / count_sum[type]), dt);

              <span class="keywordflow">if</span>(dt &lt; <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a>)
                <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> = dt;
            }
        }

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;displacement time constraint: %g  (%g)\n&quot;</span>, <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="timestep_8c_a78ed439b8a1cb93647a2b9de998d9269_cgraph.png" border="0" usemap="#timestep_8c_a78ed439b8a1cb93647a2b9de998d9269_cgraph" alt=""/></div>
<map name="timestep_8c_a78ed439b8a1cb93647a2b9de998d9269_cgraph" id="timestep_8c_a78ed439b8a1cb93647a2b9de998d9269_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="284,5,329,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="timestep_8c_a78ed439b8a1cb93647a2b9de998d9269_icgraph.png" border="0" usemap="#timestep_8c_a78ed439b8a1cb93647a2b9de998d9269_icgraph" alt=""/></div>
<map name="timestep_8c_a78ed439b8a1cb93647a2b9de998d9269_icgraph" id="timestep_8c_a78ed439b8a1cb93647a2b9de998d9269_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="283,5,491,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="539,5,581,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="631,5,684,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af48922752ff457721f558510789e61e1"></a><!-- doxytag: member="timestep.c::get_timestep" ref="af48922752ff457721f558510789e61e1" args="(int p, double *aphys, int flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_timestep </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>aphys</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function normally (for flag==0) returns the maximum allowed timestep of a particle, expressed in terms of the integer mapping that is used to represent the total simulated timespan. The physical acceleration is returned in `aphys'. The latter is used in conjunction with the PSEUDOSYMMETRIC integration option, which also makes of the second function of get_timestep. When it is called with a finite timestep for flag, it returns the physical acceleration that would lead to this timestep, assuming timestep criterion 0. </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29 </p>
</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>p</em>&nbsp;</td><td>particle index </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>aphys</em>&nbsp;</td><td>acceleration (physical units) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flag</em>&nbsp;</td><td>either 0 for normal operation, or finite timestep to get corresponding aphys </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00423">423</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="timestep_8c_source.html#l00013">atime</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00447">global_data_all_processes::CourantFac</a>, <a class="el" href="timestep_8c_source.html#l00014">dt_displacement</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00433">global_data_all_processes::ErrTolIntAccuracy</a>, <a class="el" href="timestep_8c_source.html#l00013">fac1</a>, <a class="el" href="timestep_8c_source.html#l00013">fac2</a>, <a class="el" href="timestep_8c_source.html#l00013">fac3</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00518">particle_data::GravPM</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="timestep_8c_source.html#l00013">hubble_a</a>, <a class="el" href="allvars_8h_source.html#l00562">sph_particle_data::HydroAccel</a>, <a class="el" href="allvars_8h_source.html#l00568">sph_particle_data::MaxSignalVel</a>, <a class="el" href="allvars_8h_source.html#l00438">global_data_all_processes::MaxSizeTimestep</a>, <a class="el" href="allvars_8h_source.html#l00436">global_data_all_processes::MinSizeTimestep</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00477">global_data_all_processes::SofteningTable</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00041">TIMEBASE</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, and <a class="el" href="allvars_8h_source.html#l00351">global_data_all_processes::TypeOfTimestepCriterion</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> ax, ay, az, ac, csnd;
  <span class="keywordtype">double</span> dt = 0, dt_courant = 0, dt_accel;
  <span class="keywordtype">int</span> ti_step;

<span class="preprocessor">#ifdef CONDUCTION</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_cond;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(flag == 0)
    {
      ax = <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0];
      ay = <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1];
      az = <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2];

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>      ax += <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[0];
      ay += <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[1];
      az += <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[2];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Type == 0)
        {
          ax += <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[0];
          ay += <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[1];
          az += <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[2];
        }

      ac = sqrt(ax * ax + ay * ay + az * az);   <span class="comment">/* this is now the physical acceleration */</span>
      *aphys = ac;
    }
  <span class="keywordflow">else</span>
    ac = *aphys;

  <span class="keywordflow">if</span>(ac == 0)
    ac = 1.0e-30;

  <span class="keywordflow">switch</span> (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2cc704c49ada031fae9619dbf163e32d">TypeOfTimestepCriterion</a>)
    {
    <span class="keywordflow">case</span> 0:
      <span class="keywordflow">if</span>(flag &gt; 0)
        {
          dt = flag * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
          dt /= <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>;       <span class="comment">/* convert dloga to physical timestep  */</span>
          ac = 2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] / (dt * dt);
          *aphys = ac;
          <span class="keywordflow">return</span> flag;
        }
      dt = dt_accel = sqrt(2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] / ac);
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Type == 0)
        dt = dt_accel = sqrt(2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> / 2.8 / ac);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(888);
      <span class="keywordflow">break</span>;
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Type == 0)
    {
      csnd = sqrt(<a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Pressure / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Density);

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        dt_courant = 2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa4cf405da4e0a6fc588f5a5ba7e8fde8">CourantFac</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> / (<a class="code" href="timestep_8c.html#aebe1da050ef46b7b63c856394494292c">fac3</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#a86da008875968dfca41b35f4ca7f3164">MaxSignalVel</a>);
      <span class="keywordflow">else</span>
        dt_courant = 2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa4cf405da4e0a6fc588f5a5ba7e8fde8">CourantFac</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#a86da008875968dfca41b35f4ca7f3164">MaxSignalVel</a>;

      <span class="keywordflow">if</span>(dt_courant &lt; dt)
        dt = dt_courant;
    }

  <span class="comment">/* convert the physical timestep to dloga if needed. Note: If comoving integration has not been selected,</span>
<span class="comment">     hubble_a=1.</span>
<span class="comment">   */</span>
  dt *= <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>;

  <span class="keywordflow">if</span>(dt &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>)
    dt = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>;

  <span class="keywordflow">if</span>(dt &gt;= <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a>)
    dt = <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a>;

  <span class="keywordflow">if</span>(dt &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab5f56d94a4417c5a703b6d2d4cb81a05">MinSizeTimestep</a>)
    {
<span class="preprocessor">#ifndef NOSTOP_WHEN_BELOW_MINTIMESTEP</span>
<span class="preprocessor"></span>      printf(<span class="stringliteral">&quot;warning: Timestep wants to be below the limit `MinSizeTimestep&#39;\n&quot;</span>);

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Type == 0)
        {
          printf
            (<span class="stringliteral">&quot;Part-ID=%d  dt=%g dtc=%g ac=%g xyz=(%g|%g|%g)  hsml=%g  maxsignalvel=%g dt0=%g eps=%g\n&quot;</span>,
             (<span class="keywordtype">int</span>) <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].ID, dt, dt_courant * <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>, ac, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2],
             <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Hsml, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].MaxSignalVel,
             sqrt(2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] / ac) * hubble_a,
             <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>]);
        }
      <span class="keywordflow">else</span>
        {
          printf(<span class="stringliteral">&quot;Part-ID=%d  dt=%g ac=%g xyz=(%g|%g|%g)\n&quot;</span>, (<span class="keywordtype">int</span>) <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].ID, dt, ac, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1],
                 <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2]);
        }
      fflush(stdout);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(888);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      dt = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab5f56d94a4417c5a703b6d2d4cb81a05">MinSizeTimestep</a>;
    }

  ti_step = dt / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  <span class="keywordflow">if</span>(!(ti_step &gt; 0 &amp;&amp; ti_step &lt; <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>))
    {
      printf(<span class="stringliteral">&quot;\nError: A timestep of size zero was assigned on the integer timeline!\n&quot;</span>
             <span class="stringliteral">&quot;We better stop.\n&quot;</span>
             <span class="stringliteral">&quot;Task=%d Part-ID=%d dt=%g tibase=%g ti_step=%d ac=%g xyz=(%g|%g|%g) tree=(%g|%g%g)\n\n&quot;</span>,
             <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, (<span class="keywordtype">int</span>) <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].ID, dt, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>, ti_step, ac,
             <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2]);
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>      printf(<span class="stringliteral">&quot;pm_force=(%g|%g|%g)\n&quot;</span>, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].GravPM[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].GravPM[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].GravPM[2]);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Type == 0)
        printf(<span class="stringliteral">&quot;hydro-frc=(%g|%g|%g)\n&quot;</span>, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].HydroAccel[0], <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].HydroAccel[1], <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].HydroAccel[2]);

      fflush(stdout);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(818);
    }

  <span class="keywordflow">return</span> ti_step;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="timestep_8c_af48922752ff457721f558510789e61e1_cgraph.png" border="0" usemap="#timestep_8c_af48922752ff457721f558510789e61e1_cgraph" alt=""/></div>
<map name="timestep_8c_af48922752ff457721f558510789e61e1_cgraph" id="timestep_8c_af48922752ff457721f558510789e61e1_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="160,5,227,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="275,5,432,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="timestep_8c_af48922752ff457721f558510789e61e1_icgraph.png" border="0" usemap="#timestep_8c_af48922752ff457721f558510789e61e1_icgraph" alt=""/></div>
<map name="timestep_8c_af48922752ff457721f558510789e61e1_icgraph" id="timestep_8c_af48922752ff457721f558510789e61e1_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="160,5,368,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="416,5,459,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="508,5,561,35"/></map>
</div>
</p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a7f2a6bb4bade30e4e04ee29be22d0962"></a><!-- doxytag: member="timestep.c::a3inv" ref="a7f2a6bb4bade30e4e04ee29be22d0962" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="timestep_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00013">13</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>.</p>

</div>
</div>
<a class="anchor" id="aec7bcb1d46812f966d89f66dc1a399ea"></a><!-- doxytag: member="timestep.c::atime" ref="aec7bcb1d46812f966d89f66dc1a399ea" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00013">13</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, and <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>.</p>

</div>
</div>
<a class="anchor" id="aebcd2de4b9dfac8c2feb1594616f4803"></a><!-- doxytag: member="timestep.c::dt_displacement" ref="aebcd2de4b9dfac8c2feb1594616f4803" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> = 0<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00014">14</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="timestep_8c_source.html#l00566">find_dt_displacement_constraint()</a>, and <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>.</p>

</div>
</div>
<a class="anchor" id="a59a20f8242197c1ba41f7a0b1b880d62"></a><!-- doxytag: member="timestep.c::fac1" ref="a59a20f8242197c1ba41f7a0b1b880d62" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00013">13</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="io_8c_source.html#l00129">fill_write_buffer()</a>, <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>, and <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>.</p>

</div>
</div>
<a class="anchor" id="a1a666a0983f6d540fa41ec867aa40d09"></a><!-- doxytag: member="timestep.c::fac2" ref="a1a666a0983f6d540fa41ec867aa40d09" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00013">13</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="io_8c_source.html#l00129">fill_write_buffer()</a>, and <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>.</p>

</div>
</div>
<a class="anchor" id="aebe1da050ef46b7b63c856394494292c"></a><!-- doxytag: member="timestep.c::fac3" ref="aebe1da050ef46b7b63c856394494292c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="timestep_8c.html#aebe1da050ef46b7b63c856394494292c">fac3</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00013">13</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, and <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>.</p>

</div>
</div>
<a class="anchor" id="abb7074f2e4b01309c6f2dc87bb3a1a40"></a><!-- doxytag: member="timestep.c::hubble_a" ref="abb7074f2e4b01309c6f2dc87bb3a1a40" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00013">13</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, and <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>.</p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Dec 3 2010 18:45:45 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
