<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>GADGET-2: proto.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>proto.h File Reference</h1>  </div>
</div>
<div class="contents">

<p>this file contains all function prototypes of the code  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="allvars_8h_source.html">allvars.h</a>&quot;</code><br/>
<code>#include &lt;hdf5.h&gt;</code><br/>
<div class="dynheader">
Include dependency graph for proto.h:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h__incl.png" border="0" usemap="#proto_8h" alt=""/></div>
<map name="proto_8h" id="proto_8h">
<area shape="rect" id="node3" href="allvars_8h.html" title="declares global variables." alt="" coords="107,83,181,112"/><area shape="rect" id="node9" href="tags_8h.html" title="declares various tags for labelling MPI messages." alt="" coords="219,160,280,189"/></map>
</div>
<div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h__dep__incl.png" border="0" usemap="#proto_8hdep" alt=""/></div>
<map name="proto_8hdep" id="proto_8hdep">
<area shape="rect" id="node3" href="accel_8c.html" title="driver routine to carry out force computation" alt="" coords="5,83,72,112"/><area shape="rect" id="node5" href="allocate_8c.html" title="routines for allocating particle and tree storage" alt="" coords="96,83,179,112"/><area shape="rect" id="node7" href="begrun_8c.html" title="initial set&#45;up of a simulation run" alt="" coords="203,83,280,112"/><area shape="rect" id="node9" href="density_8c.html" title="SPH density computation and smoothing length determination." alt="" coords="304,83,381,112"/><area shape="rect" id="node11" href="domain_8c.html" title="code for domain decomposition" alt="" coords="405,83,485,112"/><area shape="rect" id="node13" href="driftfac_8c.html" title="compute loop&#45;up tables for prefactors in cosmological integration" alt="" coords="509,83,587,112"/><area shape="rect" id="node15" href="endrun_8c.html" title="Termination of simulation." alt="" coords="611,83,688,112"/><area shape="rect" id="node17" href="forcetree_8c.html" title="gravitational tree and code for Ewald correction" alt="" coords="712,83,803,112"/><area shape="rect" id="node19" href="global_8c.html" title="Computes global physical properties of the system." alt="" coords="827,83,896,112"/><area shape="rect" id="node21" href="gravtree_8c.html" title="main driver routines for gravitational (short&#45;range) force computation" alt="" coords="920,83,1005,112"/><area shape="rect" id="node23" href="gravtree__forcetest_8c.html" title="routines for direct summation forces" alt="" coords="1029,83,1179,112"/><area shape="rect" id="node25" href="hydra_8c.html" title="Computation of SPH forces and rate of entropy generation." alt="" coords="1203,83,1272,112"/><area shape="rect" id="node27" href="init_8c.html" title="Code for initialisation of a simulation from initial conditions." alt="" coords="1296,83,1347,112"/><area shape="rect" id="node29" href="io_8c.html" title="Routines for producing a snapshot file on disk." alt="" coords="1371,83,1413,112"/><area shape="rect" id="node31" href="longrange_8c.html" title="driver routines for computation of long&#45;range gravitational PM force" alt="" coords="1437,83,1533,112"/><area shape="rect" id="node33" href="main_8c.html" title="start of the program" alt="" coords="1557,83,1621,112"/><area shape="rect" id="node35" href="ngb_8c.html" title="neighbour search by means of the tree" alt="" coords="1645,83,1701,112"/><area shape="rect" id="node37" href="peano_8c.html" title="Routines to compute a Peano&#45;Hilbert order." alt="" coords="1725,83,1797,112"/><area shape="rect" id="node39" href="pm__periodic_8c.html" title="routines for periodic PM&#45;force computation" alt="" coords="1821,83,1931,112"/><area shape="rect" id="node41" href="potential_8c.html" title="Computation of the gravitational potential of particles." alt="" coords="1955,83,2043,112"/><area shape="rect" id="node43" href="predict_8c.html" title="drift particles by a small time interval" alt="" coords="2067,83,2144,112"/><area shape="rect" id="node45" href="read__ic_8c.html" title="Read initial conditions in one of Gadget&#39;s file formats." alt="" coords="2168,83,2245,112"/><area shape="rect" id="node47" href="restart_8c.html" title="Code for reading and writing restart files." alt="" coords="2269,83,2344,112"/><area shape="rect" id="node49" href="run_8c.html" title="iterates over timesteps, main loop" alt="" coords="2368,83,2421,112"/><area shape="rect" id="node51" href="sidm__routines_8c.html" title="Extra fuctions and routines needed for the calculations of dark matter self interactions." alt="" coords="2445,83,2568,112"/><area shape="rect" id="node53" href="system_8c.html" title="contains miscellaneous routines, e.g. elapsed time measurements" alt="" coords="2592,83,2672,112"/><area shape="rect" id="node55" href="timestep_8c.html" title="routines for &#39;kicking&#39; particles in momentum space and assigning new timesteps" alt="" coords="2696,83,2787,112"/></map>
</div>

<p><a href="proto_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a05e5a546d63684b55d2457aa56efdd06">advance_and_find_timesteps</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a9e761db39213af33ba28aeed461f1a5a">allocate_commbuffers</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a7fe5e304baaf5f418a22fef9a9cc02c7">allocate_memory</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82">begrun</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad9c685a2d6d48224bfec61680ce82b1e">blockpresent</a> (enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#adf560a3f7c53865f7edbf9ff3b16c8fd">catch_abort</a> (int sig)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a690d62711b56d77e574ae4dd38fb72f0">catch_fatal</a> (int sig)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a1b96c5b41f1209ee91cd369f01a52352">check_omega</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aa1abb9ee0e0a43ec19cdaa55c8ecd43c">close_outputfiles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af3ffb253e14a79419d1effeee1b7261d">compare_key</a> (const void *a, const void *b)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a147f9422f4bca4666608da992486b417">compute_accelerations</a> (int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ada58109949c2431ca9b0cdaa01cfb5b1">compute_global_quantities_of_system</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a04474459731219f9601aaefedb37ab27">compute_potential</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ab6453dd0ac2ecf2478b1208374e68ae1">dens_compare_key</a> (const void *a, const void *b)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c">density</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aaeec847fb319935d1a6e765ffbb9c6d9">density_decouple</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a19f7a07621c698ae894f53836e9ff03c">density_evaluate</a> (int i, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab">distribute_file</a> (int nfiles, int firstfile, int firsttask, int lasttask, int *filenr, int *master, int *<a class="el" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a> (double, double)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a128779c23a7c6e9cca2374c5e7c91483">dmin</a> (double, double)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#adda9e167a16a53d1aa40180406950446">do_box_wrapping</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492">domain_Decomposition</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a5b596de46669fab5e125f163d44edc37">domain_compare_key</a> (const void *a, const void *b)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a381621bc90438c5a50826bfdac8e4700">domain_compare_toplist</a> (const void *a, const void *b)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a77c115c3aa2069d0eb8521329be0483c">domain_countToGo</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf">domain_decompose</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729">domain_determineTopTree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a> (int partner, int sphflag, int send_count, int recv_count)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a0e758ec7eef32fc7180092547f5a11b9">domain_findExchangeNumbers</a> (int task, int partner, int sphflag, int *send, int *recv)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#add5620cbc133c73f0ce7da3a8fe9c01e">domain_findExtent</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit</a> (int cpustart, int ncpu, int first, int <a class="el" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a89c54187117b91d4270a4f0c406ce2ba">domain_shiftSplit</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a25aada0d3751c2afd2a376151d1d917e">domain_sumCost</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a606de536756a67ad8f79f1135009195e">domain_topsplit</a> (int node, <a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> startkey)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aa5001f9be833c4673392b40e7be3a421">domain_topsplit_local</a> (int node, <a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> startkey)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a8cb77fa18fd6b91a358bd0a9c04cbf2e">drift_integ</a> (double a, void *param)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ab303b92c6d6b4144999c5cebabd65ec0">dump_particles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a3757efb7e470353080a128388ccebec9">empty_read_buffer</a> (enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr, int offset, int pc, int type)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a9c69e0b6a074bb9341cf9854f17f245d">endrun</a> (int)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ae903322da17c6875ab606b032b918099">energy_statistics</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a7e26319b203616f2c85b5fd6f2ade85d">every_timestep_stuff</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad8b8e212e593e1795f6ba522239086fc">ewald_corr</a> (double dx, double dy, double dz, double *fper)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a0c4d2bd0695737095313d7dc47ce120c">ewald_force</a> (int ii, int jj, int kk, double x[3], double force[3])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a47f99270d9b0b0f75d86b3b9d078dff6">ewald_init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aa0657e3de6bfb76715c14ddd72d25e58">ewald_pot_corr</a> (double dx, double dy, double dz)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a4a219224b239f0c20497e54ae421f134">ewald_psi</a> (double x[3])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a10281a87abe1e07d6ca603de6a533345">fill_Tab_IO_Labels</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aea8fa222a10c4796687c6ff25550cd74">fill_write_buffer</a> (enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr, int *pindex, int pc, int type)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a78ed439b8a1cb93647a2b9de998d9269">find_dt_displacement_constraint</a> (double hfac)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ac028b474d53a40e79377b7ae5dde636a">find_files</a> (char *fname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a532b4637166ab194c1b1d0dee9f003f2">find_next_outputtime</a> (int time)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad52604af910b3e1677718d863ab09391">find_next_sync_point_and_drift</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89">force_create_empty_nodes</a> (int no, int topnode, int bits, int x, int y, int z, int *nodecount, int *nextfree)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aaabf16b5e99c9ac6bc6bbe039756bddb">force_exchange_pseudodata</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a947a734f3bbba14d4092c7480880d3c7">force_flag_localnodes</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad9e0a57b7577d64a315c142e197d292d">force_insert_pseudo_particles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ae809fba68f599de9874f593b77d0bbfd">force_setupnonrecursive</a> (int no)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate</a> (int maxnodes, int maxpart)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5">force_treebuild</a> (int npart)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6">force_treebuild_single</a> (int npart)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a59ae74ef51d6a7065605638422489391">force_treeevaluate</a> (int target, int mode, double *ewaldcountsum)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a0ec221b2517893874b12dc366bfe0da8">force_treeevaluate_direct</a> (int target, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f">force_treeevaluate_ewald_correction</a> (int target, int mode, double pos_x, double pos_y, double pos_z, double aold)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a804166b1847da509d8fe57072b40d5f9">force_treeevaluate_potential</a> (int target, int type)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#abd9d86a6c08e77a4fa78fa76b96cdde7">force_treeevaluate_potential_shortrange</a> (int target, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ae01e179b7686a7fe62970160b7bbdb46">force_treeevaluate_shortrange</a> (int target, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a0a9667f530dad09ebed8c0c98e5d3888">force_treefree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ab8e5d4fed349d96c6d4f55897473ce19">force_treeupdate_pseudos</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a4764c1fb83a956c1712345538630854c">force_update_hmax</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a04fb647ef783d5baeb9275d806c08365">force_update_len</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a0292cb282788bf4e4f06636096c5abdf">force_update_node</a> (int no, int flag)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a4c108b1da2bc4f2620f62aeab90c1074">force_update_node_hmax_local</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ac3f5945bb7c73936ef49af1507265afe">force_update_node_hmax_toptree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a4592b750f8555f580691103acf1e5366">force_update_node_len_local</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a5f85438d619d63c812c8e05faf1f0074">force_update_node_len_toptree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ab745c54c805d07ad255a3f86ff77e18d">force_update_node_recursive</a> (int no, int sib, int father)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af9a7e3a922557e089da5d7ee1dde89a0">force_update_pseudoparticles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a207b80df2a123bc29295a0d496186d70">force_update_size_of_parent_node</a> (int no)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a99877ff0dc6228eabf8f959569f2771e">free_memory</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a49492470fcccf9d05bf51993f281f16c">get_bytes_per_blockelement</a> (enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a4d30ce1aad9c69d5af676a6a13173686">get_dataset_name</a> (enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr, char *buf)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#acdf59daa02f065452a596cf88b4de1a1">get_datatype_in_block</a> (enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#adadb384299eb936596574417d4b6b28c">get_drift_factor</a> (int time0, int time1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a> (int time0, int time1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a> (int time0, int time1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a5ce310b1efc19d96d530c1264fd5eca9">get_particles_in_block</a> (enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr, int *typelist)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a> (int id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a> (int p, double *a, int flag)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a3892776d6528c51f720d2a48deb2486f">get_values_per_blockelement</a> (enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ae9c157451dcc4cdbe02813141df2be42">grav_tree_compare_key</a> (const void *a, const void *b)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79">gravity_forcetest</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af">gravity_tree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a483c8f5e73b8445bbb44e3bab59f2f1d">gravity_tree_shortrange</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a2eafe05fb12d7f9d954d5b501e186051">gravkick_integ</a> (double a, void *param)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a8331f87f49dedbeb9e7d61d0deb8926a">hydro_compare_key</a> (const void *a, const void *b)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a818695254c9525e01bc9ddc95e8eaf7e">hydro_evaluate</a> (int target, int mode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607">hydro_force</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a5ebdee2c7332bed6c1a8994ac3c38c0d">hydrokick_integ</a> (double a, void *param)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10">imax</a> (int, int)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a> (int, int)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc">init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aea1f81063199abb9d89802b444098018">init_drift_table</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a5052a0489feb425d7d910e57d7ad8102">init_peano_map</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25">long_range_force</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af52079f2c63002aca9463ba0b13727df">long_range_init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad295b3023b3d8fad337637a640362262">long_range_init_regionsize</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31">move_particles</a> (int time0, int time1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">size_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a1609620c03f6b0068601735c42e3c660">my_fread</a> (void *ptr, size_t size, size_t nmemb, FILE *stream)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">size_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a> (void *ptr, size_t size, size_t nmemb, FILE *stream)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a72ee1196e73c7c6e8683d35e4692d840">ngb_clear_buf</a> (float searchcenter[3], float hguess, int numngb)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a6f7a3b85f10701b9067f012cc9a30f55">ngb_treeallocate</a> (int npart)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79">ngb_treebuild</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a96ec7acfa3c046abc6902ca77ee4bddd">ngb_treefind_pairs</a> (float searchcenter[3], float hsml, int *startnode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a008284f92570d4d1fa6e3dadb5902cf8">ngb_treefind_variable</a> (float searchcenter[3], float hguess, int *startnode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aab22cf240079ef5846d83729e4565f97">ngb_treefree</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ab68e970cf33f44c3ff421fc2ea6e9290">ngb_treesearch</a> (int)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad387916b04773b495483e10f3d24e9d6">ngb_treesearch_pairs</a> (int)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a6895b316b66ff5f9f78910d65823bf00">ngb_update_nodes</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a6f629274f7b036874c743fb81d58ce68">open_outputfiles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a9eec17b80ae63eb79e98064f2d4f25df">peano_hilbert_key</a> (int x, int y, int z, int bits)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af3e45a4293584b3fe28e83af75c6ed71">peano_hilbert_order</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a0784ca56372f6ce3cf46e8b6623e4ea0">pm_init_nonperiodic</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ac8030592010e755c61e6ee358ee0895d">pm_init_nonperiodic_allocate</a> (int dimprod)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#afd73e48ecc5be43d057dd718f78d187d">pm_init_nonperiodic_free</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a13e381f05efdb739cf5026384e908409">pm_init_periodic</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#acb5c64377fad9e1a34bad88fb7c61a3e">pm_init_periodic_allocate</a> (int dimprod)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a259e6f8400ee889c64bc667334060742">pm_init_periodic_free</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic</a> (int grnr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b">pmforce_periodic</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9">pmpotential_nonperiodic</a> (int grnr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0">pmpotential_periodic</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a> (double, double)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#affd0f4e6b7bcdabf7d6f8191145f78d1">read_file</a> (char *fname, int readTask, int lastTask)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af87c21a0c70ac5e7d5f769b952d08fe9">read_header_attributes_in_hdf5</a> (char *fname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a150344fdc0c6e132aecdb6c646529df1">read_ic</a> (char *fname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a849a294ac908c933ffb82dc4319af513">read_outputlist</a> (char *fname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a952eae1977b498c4fdfabed1742a3ba2">read_parameter_file</a> (char *fname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#acc4d1f5e4e51140090a7ce25ea263b98">readjust_timebase</a> (double TimeMax_old, double TimeMax_new)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af744cef873e3093ba2924da8265d1711">reorder_gas</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#afcb358154dd7fd5de8b4156f417fb0ba">reorder_particles</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#af3e3dd8294f983f9ed9f75c81d149ec9">restart</a> (int mod)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2">run</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5">savepositions</a> (int num)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aeb05544fcefa17dff1e34bf3c65a0135">seed_glass</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a9cb45ef22cae101906f021fb7a23afbe">set_random_numbers</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aab39b7857a85e95ef6f926ac82d4ff91">set_softenings</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#aba986f6be1d66945199c7ea43e5c9610">set_units</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5">setup_smoothinglengths</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad47ac005519641e0cfc423c3802d3ef2">statistics</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8">terminate_processes</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a> (double t0, double t1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#ad5243b69dcba17be62f7d64f422bfbbf">write_header_attributes_in_hdf5</a> (hid_t handle)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c">write_file</a> (char *fname, int readTask, int lastTask)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="proto_8h.html#a38a8b7521229c82f0f4146f60b88d9c5">write_pid_file</a> (void)</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>this file contains all function prototypes of the code </p>

<p>Definition in file <a class="el" href="proto_8h_source.html">proto.h</a>.</p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a05e5a546d63684b55d2457aa56efdd06"></a><!-- doxytag: member="proto.h::advance_and_find_timesteps" ref="a05e5a546d63684b55d2457aa56efdd06" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void advance_and_find_timesteps </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function advances the system in momentum space, i.e. it does apply the 'kick' operation after the forces have been computed. Additionally, it assigns new timesteps to particles. At start-up, a half-timestep is carried out, as well as at the end of the simulation. In between, the half-step kick that ends the previous timestep and the half-step kick for the new timestep are combined into one operation. </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29 </p>
</p>

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00024">24</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>References <a class="el" href="timestep_8c_source.html#l00013">a3inv</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="timestep_8c_source.html#l00013">atime</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00421">global_data_all_processes::CPU_TimeLine</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="timestep_8c_source.html#l00014">dt_displacement</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="allvars_8h_source.html#l00554">sph_particle_data::Entropy</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="timestep_8c_source.html#l00013">fac1</a>, <a class="el" href="timestep_8c_source.html#l00013">fac2</a>, <a class="el" href="timestep_8c_source.html#l00013">fac3</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="timestep_8c_source.html#l00566">find_dt_displacement_constraint()</a>, <a class="el" href="allvars_8c_source.html#l00040">Flag_FullStep</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="allvars_8h_source.html#l00071">GAMMA_MINUS1</a>, <a class="el" href="driftfac_8c_source.html#l00105">get_gravkick_factor()</a>, <a class="el" href="driftfac_8c_source.html#l00142">get_hydrokick_factor()</a>, <a class="el" href="system_8c_source.html#l00029">get_random_number()</a>, <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00518">particle_data::GravPM</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="timestep_8c_source.html#l00013">hubble_a</a>, <a class="el" href="allvars_8h_source.html#l00562">sph_particle_data::HydroAccel</a>, <a class="el" href="allvars_8h_source.html#l00438">global_data_all_processes::MaxSizeTimestep</a>, <a class="el" href="allvars_8h_source.html#l00310">global_data_all_processes::MinEgySpec</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00386">global_data_all_processes::PM_Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00041">TIMEBASE</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00563">sph_particle_data::VelPred</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, no, ti_step, ti_min, tend, tstart;
  <span class="keywordtype">double</span> dt_entr, dt_entr2, dt_gravkick, dt_hydrokick, dt_gravkick2, dt_hydrokick2, t0, t1;
  <span class="keywordtype">double</span> minentropy, aphys;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> dv[3];

<span class="preprocessor">#ifdef FLEXSTEPS</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> ti_grp;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#if defined(PSEUDOSYMMETRIC) &amp;&amp; !defined(FLEXSTEPS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> apred, prob;
  <span class="keywordtype">int</span> ti_step2;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_gravkickA, dt_gravkickB;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef MAKEGLASS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> disp, dispmax, globmax, dmean, fac, disp2sum, globdisp2sum;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> = 1 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>);
      <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> = 1 / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, 3 * <a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> - 2);
      <a class="code" href="timestep_8c.html#aebe1da050ef46b7b63c856394494292c">fac3</a> = <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, 3 * (1 - <a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a>) / 2.0);
      <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>)
        + (1 - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>) / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>;

      <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * sqrt(<a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>);
      <a class="code" href="timestep_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a> = 1 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>);
      <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
    }
  <span class="keywordflow">else</span>
    <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> = <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> = <a class="code" href="timestep_8c.html#aebe1da050ef46b7b63c856394494292c">fac3</a> = <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="timestep_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a> = <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> = 1;

<span class="preprocessor">#ifdef NOPMSTEPADJUSTMENT</span>
<span class="preprocessor"></span>  <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a6343a9f3619e77c1796309b8deda7f50">Flag_FullStep</a> || <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> == 0)
    <a class="code" href="proto_8h.html#a78ed439b8a1cb93647a2b9de998d9269">find_dt_displacement_constraint</a>(<a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    dt_gravkickB = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
      <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2);
  <span class="keywordflow">else</span>
    dt_gravkickB = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)       <span class="comment">/* need to do long-range kick */</span>
    {
      <span class="comment">/* make sure that we reconstruct the domain/tree next time because we don&#39;t kick the tree nodes in this case */</span>
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="preprocessor">#ifdef MAKEGLASS</span>
<span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0, dispmax = 0, disp2sum = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] *= -1;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] *= -1;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j];
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] = 0;
        }

      disp = sqrt(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0] +
                  <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2]);

      disp *= 2.0 / (3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>);

      disp2sum += disp * disp;

      <span class="keywordflow">if</span>(disp &gt; dispmax)
        dispmax = disp;
    }

  MPI_Allreduce(&amp;dispmax, &amp;globmax, 1, MPI_DOUBLE, MPI_MAX, MPI_COMM_WORLD);
  MPI_Allreduce(&amp;disp2sum, &amp;globdisp2sum, 1, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);

  dmean = <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> * 3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>)), 1.0 / 3);

  <span class="keywordflow">if</span>(globmax &gt; dmean)
    fac = dmean / globmax;
  <span class="keywordflow">else</span>
    fac = 1.0;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;\nglass-making:  dmean= %g  global disp-maximum= %g  rms= %g\n\n&quot;</span>,
             dmean, globmax, sqrt(globdisp2sum / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a>));
      fflush(stdout);
    }

  <span class="keywordflow">for</span>(i = 0, dispmax = 0; i &lt; NumPart; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] = 0;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j] += fac * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] * 2.0 / (3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>);
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] = 0;
        }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>



  <span class="comment">/* Now assign new timesteps and kick */</span>

<span class="preprocessor">#ifdef FLEXSTEPS</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> % (4 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep)) == 0)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep &lt; <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>)
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep *= 2;

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
        {
          ti_step = <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;aphys, 0);

          <span class="comment">/* make it a power 2 subdivision */</span>
          ti_min = TIMEBASE;
          <span class="keywordflow">while</span>(ti_min &gt; ti_step)
            ti_min &gt;&gt;= 1;
          ti_step = ti_min;

          <span class="keywordflow">if</span>(ti_step &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep)
            <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep = ti_step;
        }
    }

  ti_step = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep;
  MPI_Allreduce(&amp;ti_step, &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep, 1, MPI_INT, MPI_MIN, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(<a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>)
    ti_step = (int) (<a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>);
  <span class="keywordflow">else</span>
    ti_step = (int) (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>);

  <span class="comment">/* make it a power 2 subdivision */</span>
  ti_min = TIMEBASE;
  <span class="keywordflow">while</span>(ti_min &gt; ti_step)
    ti_min &gt;&gt;= 1;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMaxStep = ti_min;


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;Syn Range = %g  PresentMinStep = %d  PresentMaxStep = %d \n&quot;</span>,
           (<span class="keywordtype">double</span>) <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMaxStep / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMaxStep);

<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
        {
          ti_step = <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;aphys, 0);

          <span class="comment">/* make it a power 2 subdivision */</span>
          ti_min = TIMEBASE;
          <span class="keywordflow">while</span>(ti_min &gt; ti_step)
            ti_min &gt;&gt;= 1;
          ti_step = ti_min;

<span class="preprocessor">#ifdef FLEXSTEPS</span>
<span class="preprocessor"></span>          ti_grp = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].FlexStepGrp % <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMaxStep;
          ti_grp = (ti_grp / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep;
          ti_step = ((<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> + ti_grp + ti_step) / ti_step) * ti_step - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> + ti_grp);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef PSEUDOSYMMETRIC</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> != 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> &gt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>)
                {
                  apred = aphys + ((aphys - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].AphysOld) / (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep)) * ti_step;
                  <span class="keywordflow">if</span>(fabs(apred - aphys) &lt; 0.5 * aphys)
                    {
                      ti_step2 = <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;apred, -1);
                      ti_min = TIMEBASE;
                      <span class="keywordflow">while</span>(ti_min &gt; ti_step2)
                        ti_min &gt;&gt;= 1;
                      ti_step2 = ti_min;

                      <span class="keywordflow">if</span>(ti_step2 &lt; ti_step)
                        {
                          <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;apred, ti_step);
                          prob =
                            ((apred - aphys) / (aphys - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].AphysOld) * (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> -
                                                                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>)) / ti_step;
                          <span class="keywordflow">if</span>(prob &lt; <a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>))
                            ti_step /= 2;
                        }
                      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ti_step2 &gt; ti_step)
                        {
                          <a class="code" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8">get_timestep</a>(i, &amp;apred, 2 * ti_step);
                          prob =
                            ((apred - aphys) / (aphys - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].AphysOld) * (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> -
                                                                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>)) / ti_step;
                          <span class="keywordflow">if</span>(prob &lt; <a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a> + 1))
                            ti_step *= 2;
                        }
                    }
                }
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].AphysOld = aphys;
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef SYNCHRONIZATION</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ti_step &gt; (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep))     <span class="comment">/* timestep wants to increase */</span>
            {
              <span class="keywordflow">if</span>(((<a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) % ti_step) &gt; 0)
                ti_step = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>;    <span class="comment">/* leave at old step */</span>
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* end of FLEXSTEPS */</span>

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> == <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>)        <span class="comment">/* we here finish the last timestep. */</span>
            ti_step = 0;

          <span class="keywordflow">if</span>((<a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) &lt; ti_step)     <span class="comment">/* check that we don&#39;t run beyond the end */</span>
            ti_step = <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>;

          tstart = (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2;     <span class="comment">/* midpoint of old step */</span>
          tend = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> + ti_step / 2; <span class="comment">/* midpoint of new step */</span>

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
            {
              dt_entr = (tend - tstart) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              dt_entr2 = (tend - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              dt_gravkick = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(tstart, tend);
              dt_hydrokick = <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(tstart, tend);
              dt_gravkick2 = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>, tend);
              dt_hydrokick2 = <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>, tend);
            }
          <span class="keywordflow">else</span>
            {
              dt_entr = dt_gravkick = dt_hydrokick = (tend - tstart) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              dt_gravkick2 = dt_hydrokick2 = dt_entr2 = (tend - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
            }

          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + ti_step;


          <span class="comment">/* do the kick */</span>

          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            {
              dv[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] * dt_gravkick;
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] += dv[j];
            }

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)    <span class="comment">/* SPH stuff */</span>
            {
              <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
                {
                  dv[j] += <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j] * dt_hydrokick;
                  <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] += <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j] * dt_hydrokick;

                  <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[j] =
                    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] - dt_gravkick2 * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] - dt_hydrokick2 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j];
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>                  <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] * dt_gravkickB;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                }

              <span class="comment">/* In case of cooling, we prevent that the entropy (and</span>
<span class="comment">                 hence temperature decreases by more than a factor 0.5 */</span>

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].DtEntropy * dt_entr &gt; -0.5 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy)
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> += <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> * dt_entr;
              <span class="keywordflow">else</span>
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> *= 0.5;

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a>)
                {
                  minentropy = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a> * <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a> / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Density * <a class="code" href="timestep_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a>, <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>);
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy &lt; minentropy)
                    {
                      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> = minentropy;
                      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> = 0;
                    }
                }

              <span class="comment">/* In case the timestep increases in the new step, we</span>
<span class="comment">                 make sure that we do not &#39;overcool&#39; when deriving</span>
<span class="comment">                 predicted temperatures. The maximum timespan over</span>
<span class="comment">                 which prediction can occur is ti_step/2, i.e. from</span>
<span class="comment">                 the middle to the end of the current step */</span>

              dt_entr = ti_step / 2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].DtEntropy * dt_entr &lt; 0.5 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy)
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> = -0.5 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> / dt_entr;
            }


          <span class="comment">/* if tree is not going to be reconstructed, kick parent nodes dynamically.</span>
<span class="comment">           */</span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>)
            {
              no = <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[i];
              <span class="keywordflow">while</span>(no &gt;= 0)
                {
                  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
                    <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].vs[j] += dv[j] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> / <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;

                  no = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;
                }
            }
        }
    }



<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)       <span class="comment">/* need to do long-range kick */</span>
    {
      ti_step = TIMEBASE;
      <span class="keywordflow">while</span>(ti_step &gt; (<a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>))
        ti_step &gt;&gt;= 1;

      <span class="keywordflow">if</span>(ti_step &gt; (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>))     <span class="comment">/* PM-timestep wants to increase */</span>
        {
          <span class="comment">/* we only increase if an integer number of steps will bring us to the end */</span>
          <span class="keywordflow">if</span>(((<a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) % ti_step) &gt; 0)
            ti_step = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>;    <span class="comment">/* leave at old step */</span>
        }

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> == <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>)    <span class="comment">/* we here finish the last timestep. */</span>
        ti_step = 0;

      tstart = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2;
      tend = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> + ti_step / 2;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        dt_gravkick = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(tstart, tend);
      <span class="keywordflow">else</span>
        dt_gravkick = (tend - tstart) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + ti_step;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        dt_gravkickB = -<a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2);
      <span class="keywordflow">else</span>
        dt_gravkickB =
          -((<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2 - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        {
          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)        <span class="comment">/* do the kick */</span>
            <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] * dt_gravkick;

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
                {
                  dt_gravkickA = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
                    <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2);
                  dt_hydrokick = <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
                    <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2);
                }
              <span class="keywordflow">else</span>
                dt_gravkickA = dt_hydrokick =
                  (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

              <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].VelPred[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j]
                  + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] * dt_gravkickA
                  + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].HydroAccel[j] * dt_hydrokick + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] * dt_gravkickB;
            }
        }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a675f7230ece5f6d88fcc0384a8e1f6c9">CPU_TimeLine</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a05e5a546d63684b55d2457aa56efdd06_cgraph.png" border="0" usemap="#proto_8h_a05e5a546d63684b55d2457aa56efdd06_cgraph" alt=""/></div>
<map name="proto_8h_a05e5a546d63684b55d2457aa56efdd06_cgraph" id="proto_8h_a05e5a546d63684b55d2457aa56efdd06_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a78ed439b8a1cb93647a2b9de998d9269" title="find_dt_displacement_constraint" alt="" coords="261,250,491,279"/><area shape="rect" id="node5" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="549,36,595,66"/><area shape="rect" id="node7" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="303,90,449,119"/><area shape="rect" id="node9" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="299,143,453,172"/><area shape="rect" id="node11" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="297,196,455,226"/><area shape="rect" id="node13" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8" title="get_timestep" alt="" coords="323,356,429,386"/><area shape="rect" id="node20" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="343,303,409,332"/><area shape="rect" id="node22" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="341,36,411,66"/><area shape="rect" id="node15" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="539,356,605,386"/><area shape="rect" id="node17" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="653,356,811,386"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a05e5a546d63684b55d2457aa56efdd06_icgraph.png" border="0" usemap="#proto_8h_a05e5a546d63684b55d2457aa56efdd06_icgraph" alt=""/></div>
<map name="proto_8h_a05e5a546d63684b55d2457aa56efdd06_icgraph" id="proto_8h_a05e5a546d63684b55d2457aa56efdd06_icgraph">
<area shape="rect" id="node3" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="261,5,304,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="353,5,407,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9e761db39213af33ba28aeed461f1a5a"></a><!-- doxytag: member="proto.h::allocate_commbuffers" ref="a9e761db39213af33ba28aeed461f1a5a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void allocate_commbuffers </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Allocates a number of small buffers and arrays, the largest one being the communication buffer. The communication buffer itself is mapped onto various tables used in the different parts of the force algorithms. We further allocate space for the top-level tree nodes, and auxiliary arrays for the domain decomposition algorithm. </p>

<p><p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition </p>
</p>

<p>Definition at line <a class="el" href="allocate_8c_source.html#l00019">19</a> of file <a class="el" href="allocate_8c_source.html">allocate.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00288">global_data_all_processes::BufferSize</a>, <a class="el" href="allvars_8h_source.html#l00290">global_data_all_processes::BunchSizeDensity</a>, <a class="el" href="allvars_8h_source.html#l00292">global_data_all_processes::BunchSizeDomain</a>, <a class="el" href="allvars_8h_source.html#l00289">global_data_all_processes::BunchSizeForce</a>, <a class="el" href="allvars_8h_source.html#l00291">global_data_all_processes::BunchSizeHydro</a>, <a class="el" href="allvars_8c_source.html#l00102">CommBuffer</a>, <a class="el" href="allvars_8c_source.html#l00191">DensDataGet</a>, <a class="el" href="allvars_8c_source.html#l00191">DensDataIn</a>, <a class="el" href="allvars_8c_source.html#l00195">DensDataPartialResult</a>, <a class="el" href="allvars_8c_source.html#l00195">DensDataResult</a>, <a class="el" href="allvars_8c_source.html#l00057">DomainCount</a>, <a class="el" href="allvars_8c_source.html#l00058">DomainCountSph</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00063">DomainHmax</a>, <a class="el" href="allvars_8c_source.html#l00068">DomainKeyBuf</a>, <a class="el" href="allvars_8c_source.html#l00065">DomainMoment</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00120">DomainPartBuf</a>, <a class="el" href="allvars_8c_source.html#l00128">DomainSphBuf</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="allvars_8c_source.html#l00062">DomainTreeNodeLen</a>, <a class="el" href="allvars_8c_source.html#l00056">DomainWork</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataIn</a>, <a class="el" href="allvars_8c_source.html#l00186">GravDataIndexTable</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataOut</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8c_source.html#l00201">HydroDataGet</a>, <a class="el" href="allvars_8c_source.html#l00201">HydroDataIn</a>, <a class="el" href="allvars_8c_source.html#l00205">HydroDataPartialResult</a>, <a class="el" href="allvars_8c_source.html#l00205">HydroDataResult</a>, <a class="el" href="allvars_8h_source.html#l00045">MAXTOPNODES</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">size_t</span> bytes;

  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a> = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
  <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a> = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a> = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));

  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__data.html">topnode_data</a>));

  <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
  <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  <a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>));
  <a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>));
  <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a> = malloc(<a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structDomainNODE.html">DomainNODE</a>));

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a> = malloc(bytes = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a> * 1024 * 1024)))
    {
      printf(<span class="stringliteral">&quot;failed to allocate memory for `CommBuffer&#39; (%g MB).\n&quot;</span>, bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(2);
    }

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a> =
    (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a> * 1024 * 1024) / (<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a>) + 2 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structgravdata__in.html">gravdata_in</a>));

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a> &amp; 1)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a> -= 1;    <span class="comment">/* make sure that All.BunchSizeForce is an even number </span>
<span class="comment">                                   --&gt; 8-byte alignment for 64bit processors */</span>

  <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a> = (<span class="keyword">struct </span><a class="code" href="structgravdata__index.html">gravdata_index</a> *) <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>;
  <a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a> = (<span class="keyword">struct </span><a class="code" href="structgravdata__in.html">gravdata_in</a> *) (<a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>);
  <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a> = <a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>;
  <a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a> = <a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a>;     <span class="comment">/* this will overwrite the GravDataIn-Table */</span>
  <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a> = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>; <span class="comment">/* this will overwrite the GravDataGet-Table */</span>


  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a> =
    (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a> * 1024 * 1024) / (2 * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a>) + 2 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structdensdata__out.html">densdata_out</a>));

  <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a> = (<span class="keyword">struct </span><a class="code" href="structdensdata__in.html">densdata_in</a> *) <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>;
  <a class="code" href="allvars_8c.html#aa2903f03b426e94ee0e7dbd08e281e3e">DensDataGet</a> = <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a>;
  <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a> = (<span class="keyword">struct </span><a class="code" href="structdensdata__out.html">densdata_out</a> *) (<a class="code" href="allvars_8c.html#aa2903f03b426e94ee0e7dbd08e281e3e">DensDataGet</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a>);
  <a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a> = <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a>;

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a> =
    (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a> * 1024 * 1024) / (2 * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a>) + 2 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structhydrodata__out.html">hydrodata_out</a>));

  <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a> = (<span class="keyword">struct </span><a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>;
  <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a> = <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a>;
  <a class="code" href="allvars_8c.html#a4ec6a36a80786f2f8e7fb9794c1f6629">HydroDataResult</a> = (<span class="keyword">struct </span><a class="code" href="structhydrodata__out.html">hydrodata_out</a> *) (<a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a>);
  <a class="code" href="allvars_8c.html#ab7f7e4c36b3ed818849ba610d82b38bc">HydroDataPartialResult</a> = <a class="code" href="allvars_8c.html#a4ec6a36a80786f2f8e7fb9794c1f6629">HydroDataResult</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a>;

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a> =
    (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a> * 1024 * 1024) / (<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>) + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structsph__particle__data.html">sph_particle_data</a>) +
                                      sizeof(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>));

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a> &amp; 1)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a> -= 1;   <span class="comment">/* make sure that All.BunchSizeDomain is even </span>
<span class="comment">                                   --&gt; 8-byte alignment of DomainKeyBuf for 64bit processors */</span>

  <a class="code" href="allvars_8c.html#a386309bed4018948d42bc72ae4b5e1bb">DomainPartBuf</a> = (<span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a> *) <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>;
  <a class="code" href="allvars_8c.html#a6034b1d1d1f6fb31d07d2077914aa1fc">DomainSphBuf</a> = (<span class="keyword">struct </span><a class="code" href="structsph__particle__data.html">sph_particle_data</a> *) (<a class="code" href="allvars_8c.html#a386309bed4018948d42bc72ae4b5e1bb">DomainPartBuf</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a>);
  <a class="code" href="allvars_8c.html#a6918a0815266193ad242888c455c5886">DomainKeyBuf</a> = (<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) (<a class="code" href="allvars_8c.html#a6034b1d1d1f6fb31d07d2077914aa1fc">DomainSphBuf</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a>);


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;\nAllocated %d MByte communication buffer per processor.\n\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a>);
      printf(<span class="stringliteral">&quot;Communication buffer has room for %d particles in gravity computation\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>);
      printf(<span class="stringliteral">&quot;Communication buffer has room for %d particles in density computation\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a>);
      printf(<span class="stringliteral">&quot;Communication buffer has room for %d particles in hydro computation\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a>);
      printf(<span class="stringliteral">&quot;Communication buffer has room for %d particles in domain decomposition\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a>);
      printf(<span class="stringliteral">&quot;\n&quot;</span>);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a9e761db39213af33ba28aeed461f1a5a_cgraph.png" border="0" usemap="#proto_8h_a9e761db39213af33ba28aeed461f1a5a_cgraph" alt=""/></div>
<map name="proto_8h_a9e761db39213af33ba28aeed461f1a5a_cgraph" id="proto_8h_a9e761db39213af33ba28aeed461f1a5a_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="219,5,285,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="333,5,491,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a9e761db39213af33ba28aeed461f1a5a_icgraph.png" border="0" usemap="#proto_8h_a9e761db39213af33ba28aeed461f1a5a_icgraph" alt=""/></div>
<map name="proto_8h_a9e761db39213af33ba28aeed461f1a5a_icgraph" id="proto_8h_a9e761db39213af33ba28aeed461f1a5a_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="219,5,285,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="335,5,388,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a7fe5e304baaf5f418a22fef9a9cc02c7"></a><!-- doxytag: member="proto.h::allocate_memory" ref="a7fe5e304baaf5f418a22fef9a9cc02c7" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void allocate_memory </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine allocates memory for particle storage, both the collisionless and the SPH particles. </p>

<p>Definition at line <a class="el" href="allocate_8c_source.html#l00103">103</a> of file <a class="el" href="allocate_8c_source.html">allocate.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00276">global_data_all_processes::MaxPartSph</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, and <a class="el" href="restart_8c_source.html#l00035">restart()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">size_t</span> bytes;
  <span class="keywordtype">double</span> bytes_tot = 0;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> &gt; 0)
    {
      <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a> = malloc(bytes = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>))))
        {
          printf(<span class="stringliteral">&quot;failed to allocate memory for `P&#39; (%g MB).\n&quot;</span>, bytes / (1024.0 * 1024.0));
          <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
        }
      bytes_tot += bytes;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nAllocated %g MByte for particle storage. %lu\n\n&quot;</span>, bytes_tot / (1024.0 * 1024.0), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>));
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> &gt; 0)
    {
      bytes_tot = 0;

      <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a> = malloc(bytes = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>))))
        {
          printf(<span class="stringliteral">&quot;failed to allocate memory for `SphP&#39; (%g MB) %lu.\n&quot;</span>, bytes / (1024.0 * 1024.0), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>));
          <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
        }
      bytes_tot += bytes;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Allocated %g MByte for storage of SPH data. %lu\n\n&quot;</span>, bytes_tot / (1024.0 * 1024.0), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>));
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a7fe5e304baaf5f418a22fef9a9cc02c7_cgraph.png" border="0" usemap="#proto_8h_a7fe5e304baaf5f418a22fef9a9cc02c7_cgraph" alt=""/></div>
<map name="proto_8h_a7fe5e304baaf5f418a22fef9a9cc02c7_cgraph" id="proto_8h_a7fe5e304baaf5f418a22fef9a9cc02c7_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="187,5,253,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="301,5,459,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a7fe5e304baaf5f418a22fef9a9cc02c7_icgraph.png" border="0" usemap="#proto_8h_a7fe5e304baaf5f418a22fef9a9cc02c7_icgraph" alt=""/></div>
<map name="proto_8h_a7fe5e304baaf5f418a22fef9a9cc02c7_icgraph" id="proto_8h_a7fe5e304baaf5f418a22fef9a9cc02c7_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="188,7,263,36"/><area shape="rect" id="node13" href="restart_8c.html#ae81d30f52dddd39aef76bb1890d16f2f" title="restart" alt="" coords="431,59,495,88"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="313,7,380,36"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="443,5,483,35"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="544,5,611,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="660,32,713,61"/><area shape="rect" id="node16" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="556,59,599,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aceeb5c8909331b90ea8345e0fc853f82"></a><!-- doxytag: member="proto.h::begrun" ref="aceeb5c8909331b90ea8345e0fc853f82" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void begrun </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function performs the initial set-up of the simulation. First, the parameterfile is set, then routines for setting units, reading ICs/restart-files are called, auxialiary memory is allocated, etc. </p>

<p><p>&lt; code version string </p>
</p>

<p>Definition at line <a class="el" href="begrun_8c_source.html#l00028">28</a> of file <a class="el" href="begrun_8c_source.html">begrun.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allocate_8c_source.html#l00019">allocate_commbuffers()</a>, <a class="el" href="sidm__routines_8c_source.html#l00323">AllocateInteractionTable()</a>, <a class="el" href="allvars_8h_source.html#l00307">global_data_all_processes::ArtBulkViscConst</a>, <a class="el" href="allvars_8h_source.html#l00288">global_data_all_processes::BufferSize</a>, <a class="el" href="allvars_8h_source.html#l00290">global_data_all_processes::BunchSizeDensity</a>, <a class="el" href="allvars_8h_source.html#l00292">global_data_all_processes::BunchSizeDomain</a>, <a class="el" href="allvars_8h_source.html#l00289">global_data_all_processes::BunchSizeForce</a>, <a class="el" href="allvars_8h_source.html#l00291">global_data_all_processes::BunchSizeHydro</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00447">global_data_all_processes::CourantFac</a>, <a class="el" href="allvars_8h_source.html#l00493">global_data_all_processes::CpuFile</a>, <a class="el" href="allvars_8c_source.html#l00027">CPUThisRun</a>, <a class="el" href="allvars_8h_source.html#l00360">global_data_all_processes::CpuTimeBetRestartFile</a>, <a class="el" href="allvars_8h_source.html#l00492">global_data_all_processes::EnergyFile</a>, <a class="el" href="allvars_8h_source.html#l00428">global_data_all_processes::ErrTolForceAcc</a>, <a class="el" href="allvars_8h_source.html#l00433">global_data_all_processes::ErrTolIntAccuracy</a>, <a class="el" href="forcetree_8c_source.html#l03079">ewald_init()</a>, <a class="el" href="run_8c_source.html#l00244">find_next_outputtime()</a>, <a class="el" href="allvars_8h_source.html#l00039">GADGETVERSION</a>, <a class="el" href="allvars_8h_source.html#l00494">global_data_all_processes::InfoFile</a>, <a class="el" href="init_8c_source.html#l00020">init()</a>, <a class="el" href="driftfac_8c_source.html#l00026">init_drift_table()</a>, <a class="el" href="sidm__routines_8c_source.html#l00120">init_geofactor_table()</a>, <a class="el" href="longrange_8c_source.html#l00020">long_range_init()</a>, <a class="el" href="longrange_8c_source.html#l00036">long_range_init_regionsize()</a>, <a class="el" href="allvars_8h_source.html#l00305">global_data_all_processes::MaxNumNgbDeviation</a>, <a class="el" href="allvars_8h_source.html#l00440">global_data_all_processes::MaxRMSDisplacementFac</a>, <a class="el" href="allvars_8h_source.html#l00438">global_data_all_processes::MaxSizeTimestep</a>, <a class="el" href="allvars_8h_source.html#l00436">global_data_all_processes::MinSizeTimestep</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00284">global_data_all_processes::NumFilesPerSnapshot</a>, <a class="el" href="allvars_8h_source.html#l00285">global_data_all_processes::NumFilesWrittenInParallel</a>, <a class="el" href="begrun_8c_source.html#l00204">open_outputfiles()</a>, <a class="el" href="allvars_8h_source.html#l00490">global_data_all_processes::OutputDir</a>, <a class="el" href="allvars_8h_source.html#l00498">global_data_all_processes::OutputListFilename</a>, <a class="el" href="allvars_8h_source.html#l00501">global_data_all_processes::OutputListLength</a>, <a class="el" href="allvars_8h_source.html#l00352">global_data_all_processes::OutputListOn</a>, <a class="el" href="allvars_8h_source.html#l00500">global_data_all_processes::OutputListTimes</a>, <a class="el" href="allvars_8c_source.html#l00087">ParameterFile</a>, <a class="el" href="allvars_8c_source.html#l00043">random_generator</a>, <a class="el" href="begrun_8c_source.html#l00285">read_parameter_file()</a>, <a class="el" href="begrun_8c_source.html#l00804">readjust_timebase()</a>, <a class="el" href="restart_8c_source.html#l00035">restart()</a>, <a class="el" href="allvars_8h_source.html#l00496">global_data_all_processes::RestartFile</a>, <a class="el" href="allvars_8c_source.html#l00030">RestartFlag</a>, <a class="el" href="allvars_8h_source.html#l00497">global_data_all_processes::ResubmitCommand</a>, <a class="el" href="allvars_8h_source.html#l00349">global_data_all_processes::ResubmitOn</a>, <a class="el" href="system_8c_source.html#l00037">set_random_numbers()</a>, <a class="el" href="begrun_8c_source.html#l00154">set_units()</a>, <a class="el" href="allvars_8h_source.html#l00282">global_data_all_processes::SnapFormat</a>, <a class="el" href="allvars_8h_source.html#l00491">global_data_all_processes::SnapshotFileBase</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00379">global_data_all_processes::Ti_nextoutput</a>, <a class="el" href="allvars_8h_source.html#l00358">global_data_all_processes::TimeBetSnapshot</a>, <a class="el" href="allvars_8h_source.html#l00362">global_data_all_processes::TimeBetStatistics</a>, <a class="el" href="allvars_8h_source.html#l00361">global_data_all_processes::TimeLastRestartFile</a>, <a class="el" href="allvars_8h_source.html#l00405">global_data_all_processes::TimeLimitCPU</a>, <a class="el" href="allvars_8h_source.html#l00372">global_data_all_processes::TimeMax</a>, <a class="el" href="allvars_8h_source.html#l00495">global_data_all_processes::TimingsFile</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, <a class="el" href="allvars_8h_source.html#l00350">global_data_all_processes::TypeOfOpeningCriterion</a>, and <a class="el" href="allvars_8h_source.html#l00351">global_data_all_processes::TypeOfTimestepCriterion</a>.</p>

<p>Referenced by <a class="el" href="main_8c_source.html#l00022">main()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structglobal__data__all__processes.html">global_data_all_processes</a> all;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;\nThis is Gadget, version `%s&#39;.\n&quot;</span>, <a class="code" href="allvars_8h.html#aa7cd216e76b2710261f7eb5e862073a7">GADGETVERSION</a>);
      printf(<span class="stringliteral">&quot;\nRunning on %d processors.\n&quot;</span>, <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
    }

  <a class="code" href="begrun_8c.html#a952eae1977b498c4fdfabed1742a3ba2">read_parameter_file</a>(<a class="code" href="allvars_8c.html#aad74b601033a4fe957c6129de6e8406c">ParameterFile</a>);   <span class="comment">/* ... read in parameters for this run */</span>

  <a class="code" href="allocate_8c.html#a9e761db39213af33ba28aeed461f1a5a">allocate_commbuffers</a>();       <span class="comment">/* ... allocate buffer-memory for particle </span>
<span class="comment">                                   exchange during force computation */</span>
  <a class="code" href="begrun_8c.html#aba986f6be1d66945199c7ea43e5c9610">set_units</a>();

<span class="preprocessor">#if defined(PERIODIC) &amp;&amp; (!defined(PMGRID) || defined(FORCETEST))</span>
<span class="preprocessor"></span>  <a class="code" href="forcetree_8c.html#a47f99270d9b0b0f75d86b3b9d078dff6">ewald_init</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <a class="code" href="begrun_8c.html#a6f629274f7b036874c743fb81d58ce68">open_outputfiles</a>();

  <a class="code" href="allvars_8c.html#a4ec93729b85eb5da23dd6ffb23c3702b">random_generator</a> = gsl_rng_alloc(gsl_rng_ranlxd1);
  gsl_rng_set(<a class="code" href="allvars_8c.html#a4ec93729b85eb5da23dd6ffb23c3702b">random_generator</a>, 42);    <span class="comment">/* start-up seed */</span>

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <a class="code" href="longrange_8c.html#af52079f2c63002aca9463ba0b13727df">long_range_init</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1042ebf3c648c2b23dca6fc65ff22785">TimeLastRestartFile</a> = <a class="code" href="allvars_8c.html#a2550e86a899b36eaf7428b23f98a05ec">CPUThisRun</a>;

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <a class="code" href="sidm__routines_8c.html#a75d4b55f95852e708a563c3521438fe1">AllocateInteractionTable</a>(INTERACTION_TABLE_LENGTH, PARTICLE_MAX_INTERACTIONS + 1);
  <a class="code" href="sidm__routines_8c.html#ae54bb3071b061a41ef29fcd551f50da5">init_geofactor_table</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 0 || <a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 2)
    {
      <a class="code" href="proto_8h.html#a9cb45ef22cae101906f021fb7a23afbe">set_random_numbers</a>();

      <a class="code" href="init_8c.html#a2858154e2009b0e6e616f313177762bc">init</a>();                   <span class="comment">/* ... read in initial model */</span>
    }
  <span class="keywordflow">else</span>
    {
      all = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>;                <span class="comment">/* save global variables. (will be read from restart file) */</span>

      <a class="code" href="proto_8h.html#af3e3dd8294f983f9ed9f75c81d149ec9">restart</a>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a>);     <span class="comment">/* ... read restart file. Note: This also resets </span>
<span class="comment">                                   all variables in the struct `All&#39;. </span>
<span class="comment">                                   However, during the run, some variables in the parameter</span>
<span class="comment">                                   file are allowed to be changed, if desired. These need to </span>
<span class="comment">                                   copied in the way below.</span>
<span class="comment">                                   Note:  All.PartAllocFactor is treated in restart() separately.  </span>
<span class="comment">                                 */</span>

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab5f56d94a4417c5a703b6d2d4cb81a05">MinSizeTimestep</a> = all.MinSizeTimestep;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a> = all.MaxSizeTimestep;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a> = all.BufferSize;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a> = all.BunchSizeForce;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a> = all.BunchSizeDensity;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a> = all.BunchSizeHydro;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a> = all.BunchSizeDomain;

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accf0e0ec1acab3f51f583470910049d2">TimeLimitCPU</a> = all.TimeLimitCPU;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6578ce0ee08f770891c662c0ab4ad10c">ResubmitOn</a> = all.ResubmitOn;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c02c06bb5214dcf72dd4eb757df8ad3">TimeBetSnapshot</a> = all.TimeBetSnapshot;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a516be9ff5c4fd4171aa8e1a687e1e72d">TimeBetStatistics</a> = all.TimeBetStatistics;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af087b459cc41cb6b81bdbdd0e339cb6f">CpuTimeBetRestartFile</a> = all.CpuTimeBetRestartFile;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> = all.ErrTolIntAccuracy;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a988ecf1fcfe5e61ff9ac29792c816c24">MaxRMSDisplacementFac</a> = all.MaxRMSDisplacementFac;

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> = all.ErrTolForceAcc;

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2cc704c49ada031fae9619dbf163e32d">TypeOfTimestepCriterion</a> = all.TypeOfTimestepCriterion;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c2a481de17eefbbd973fb8a7bb6f8fc">TypeOfOpeningCriterion</a> = all.TypeOfOpeningCriterion;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a> = all.NumFilesWrittenInParallel;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a> = all.TreeDomainUpdateFrequency;

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> = all.SnapFormat;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3749135400fbf51c319054233d7a64a7">NumFilesPerSnapshot</a> = all.NumFilesPerSnapshot;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a388690a6ee1497eea2f19e3984afa088">MaxNumNgbDeviation</a> = all.MaxNumNgbDeviation;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a14b9df6a6579d2ce6ef7c86aa0230217">ArtBulkViscConst</a> = all.ArtBulkViscConst;


      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4e9d69a3dd88c6aef6f4afd640243950">OutputListOn</a> = all.OutputListOn;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa4cf405da4e0a6fc588f5a5ba7e8fde8">CourantFac</a> = all.CourantFac;

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a> = all.OutputListLength;
      memcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7f3307450336a806e545661ba6c79ba5">OutputListTimes</a>, all.OutputListTimes, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a>);


      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a59f86964a3a1b03933a787cfc280951a">ResubmitCommand</a>, all.ResubmitCommand);
      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a063be13ecadec873ebaad1b3645a5323">OutputListFilename</a>, all.OutputListFilename);
      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, all.OutputDir);
      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a67e197a37469217aa8ad32c42230b286">RestartFile</a>, all.RestartFile);
      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa97394ab3a522c46b75f8b57a59ca0b5">EnergyFile</a>, all.EnergyFile);
      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3cbcdacb8b522288268993f0ce5b15ac">InfoFile</a>, all.InfoFile);
      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac2ba980c60460b89534ca8bba63cd679">CpuFile</a>, all.CpuFile);
      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae0f7c691d211f8076374cc55271022e8">TimingsFile</a>, all.TimingsFile);
      strcpy(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4bcf5b5c31545691038015af9ae9acb3">SnapshotFileBase</a>, all.SnapshotFileBase);

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a> != all.TimeMax)
        <a class="code" href="begrun_8c.html#acc4d1f5e4e51140090a7ce25ea263b98">readjust_timebase</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a>, all.TimeMax);
    }

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <a class="code" href="longrange_8c.html#ad295b3023b3d8fad337637a640362262">long_range_init_regionsize</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span> 
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    <a class="code" href="driftfac_8c.html#aea1f81063199abb9d89802b444098018">init_drift_table</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 2)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af1655016614a8c7ae59520abae300f67">Ti_nextoutput</a> = <a class="code" href="proto_8h.html#a532b4637166ab194c1b1d0dee9f003f2">find_next_outputtime</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> + 1);
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af1655016614a8c7ae59520abae300f67">Ti_nextoutput</a> = <a class="code" href="proto_8h.html#a532b4637166ab194c1b1d0dee9f003f2">find_next_outputtime</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>);


  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1042ebf3c648c2b23dca6fc65ff22785">TimeLastRestartFile</a> = <a class="code" href="allvars_8c.html#a2550e86a899b36eaf7428b23f98a05ec">CPUThisRun</a>;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aceeb5c8909331b90ea8345e0fc853f82_cgraph.png" border="0" usemap="#proto_8h_aceeb5c8909331b90ea8345e0fc853f82_cgraph" alt=""/></div>
<map name="proto_8h_aceeb5c8909331b90ea8345e0fc853f82_cgraph" id="proto_8h_aceeb5c8909331b90ea8345e0fc853f82_cgraph">
<area shape="rect" id="node3" href="allocate_8c.html#a9e761db39213af33ba28aeed461f1a5a" title="allocate_commbuffers" alt="" coords="631,1315,793,1344"/><area shape="rect" id="node9" href="sidm__routines_8c.html#a75d4b55f95852e708a563c3521438fe1" title="AllocateInteractionTable" alt="" coords="129,1360,303,1390"/><area shape="rect" id="node12" href="forcetree_8c.html#a47f99270d9b0b0f75d86b3b9d078dff6" title="ewald_init" alt="" coords="425,136,508,166"/><area shape="rect" id="node24" href="proto_8h.html#a532b4637166ab194c1b1d0dee9f003f2" title="find_next_outputtime" alt="" coords="137,98,295,127"/><area shape="rect" id="node27" href="init_8c.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="196,763,236,792"/><area shape="rect" id="node77" href="driftfac_8c.html#aea1f81063199abb9d89802b444098018" title="init_drift_table" alt="" coords="160,1467,272,1496"/><area shape="rect" id="node79" href="sidm__routines_8c.html#ae54bb3071b061a41ef29fcd551f50da5" title="init_geofactor_table" alt="" coords="143,1520,289,1550"/><area shape="rect" id="node81" href="longrange_8c.html#af52079f2c63002aca9463ba0b13727df" title="long_range_init" alt="" coords="157,1574,275,1603"/><area shape="rect" id="node87" href="longrange_8c.html#ad295b3023b3d8fad337637a640362262" title="long_range_init_regionsize" alt="" coords="121,1627,311,1656"/><area shape="rect" id="node93" href="begrun_8c.html#a6f629274f7b036874c743fb81d58ce68" title="open_outputfiles" alt="" coords="152,606,280,635"/><area shape="rect" id="node96" href="begrun_8c.html#a952eae1977b498c4fdfabed1742a3ba2" title="read_parameter_file" alt="" coords="141,1307,291,1336"/><area shape="rect" id="node101" href="begrun_8c.html#acc4d1f5e4e51140090a7ce25ea263b98" title="readjust_timebase" alt="" coords="145,1178,287,1207"/><area shape="rect" id="node104" href="proto_8h.html#af3e3dd8294f983f9ed9f75c81d149ec9" title="restart" alt="" coords="184,346,248,375"/><area shape="rect" id="node120" href="proto_8h.html#a9cb45ef22cae101906f021fb7a23afbe" title="set_random_numbers" alt="" coords="135,1680,297,1710"/><area shape="rect" id="node122" href="begrun_8c.html#aba986f6be1d66945199c7ea43e5c9610" title="set_units" alt="" coords="176,1414,256,1443"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="851,500,917,530"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="965,500,1123,530"/><area shape="rect" id="node14" href="forcetree_8c.html#a49e4b7c0d57d0ab446b4ec38f3618925" title="ewald_force" alt="" coords="664,83,760,112"/><area shape="rect" id="node16" href="forcetree_8c.html#a4a219224b239f0c20497e54ae421f134" title="ewald_psi" alt="" coords="671,136,753,166"/><area shape="rect" id="node18" href="io_8c.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="671,190,753,219"/><area shape="rect" id="node21" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="671,243,753,272"/><area shape="rect" id="node29" href="init_8c.html#a1b96c5b41f1209ee91cd369f01a52352" title="check_omega" alt="" coords="657,603,767,632"/><area shape="rect" id="node32" href="domain_8c.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="380,972,553,1002"/><area shape="rect" id="node45" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="861,1238,907,1267"/><area shape="rect" id="node48" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="399,398,535,427"/><area shape="rect" id="node51" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="388,816,545,846"/><area shape="rect" id="node53" href="ngb_8c.html#a6f7a3b85f10701b9067f012cc9a30f55" title="ngb_treeallocate" alt="" coords="403,451,531,480"/><area shape="rect" id="node56" href="ngb_8c.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="412,763,521,792"/><area shape="rect" id="node61" href="proto_8h.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="433,870,500,899"/><area shape="rect" id="node70" href="proto_8h.html#aeb05544fcefa17dff1e34bf3c65a0135" title="seed_glass" alt="" coords="420,656,513,686"/><area shape="rect" id="node72" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91" title="set_softenings" alt="" coords="409,710,524,739"/><area shape="rect" id="node74" href="init_8c.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="623,1211,801,1240"/><area shape="rect" id="node34" href="predict_8c.html#adda9e167a16a53d1aa40180406950446" title="do_box_wrapping" alt="" coords="647,947,777,976"/><area shape="rect" id="node36" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="636,894,788,923"/><area shape="rect" id="node39" href="peano_8c.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="637,1000,787,1030"/><area shape="rect" id="node41" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="679,1054,745,1083"/><area shape="rect" id="node43" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="677,1158,747,1187"/><area shape="rect" id="node58" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="653,656,771,686"/><area shape="rect" id="node63" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab" title="distribute_file" alt="" coords="659,787,765,816"/><area shape="rect" id="node66" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="683,840,741,870"/><area shape="rect" id="node68" href="io_8c.html#a10281a87abe1e07d6ca603de6a533345" title="fill_Tab_IO_Labels" alt="" coords="647,710,777,739"/><area shape="rect" id="node83" href="proto_8h.html#a0784ca56372f6ce3cf46e8b6623e4ea0" title="pm_init_nonperiodic" alt="" coords="392,1574,541,1603"/><area shape="rect" id="node85" href="pm__periodic_8c.html#a13e381f05efdb739cf5026384e908409" title="pm_init_periodic" alt="" coords="404,1520,529,1550"/><area shape="rect" id="node89" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97" title="pm_init_regionsize" alt="" coords="396,1680,537,1710"/><area shape="rect" id="node91" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4" title="pm_setup_nonperiodic_kernel" alt="" coords="360,1627,573,1656"/><area shape="rect" id="node99" href="begrun_8c.html#a849a294ac908c933ffb82dc4319af513" title="read_outputlist" alt="" coords="408,1366,525,1395"/><area shape="rect" id="node106" href="allocate_8c.html#a7fe5e304baaf5f418a22fef9a9cc02c7" title="allocate_memory" alt="" coords="645,347,779,376"/><area shape="rect" id="node109" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21" title="byten" alt="" coords="437,190,496,219"/><area shape="rect" id="node115" href="restart_8c.html#a2f4631df8dbc2cc10c5d7ce28c975ad5" title="in" alt="" coords="448,243,485,272"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aceeb5c8909331b90ea8345e0fc853f82_icgraph.png" border="0" usemap="#proto_8h_aceeb5c8909331b90ea8345e0fc853f82_icgraph" alt=""/></div>
<map name="proto_8h_aceeb5c8909331b90ea8345e0fc853f82_icgraph" id="proto_8h_aceeb5c8909331b90ea8345e0fc853f82_icgraph">
<area shape="rect" id="node3" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="121,5,175,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad9c685a2d6d48224bfec61680ce82b1e"></a><!-- doxytag: member="proto.h::blockpresent" ref="ad9c685a2d6d48224bfec61680ce82b1e" args="(enum iofields blocknr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int blockpresent </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a>&nbsp;</td>
          <td class="paramname"> <em>blocknr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function tells whether or not a given block in the output file is present, depending on the type of simulation run and the compile-time options. If one wants to add a new output-block, this function should be augmented accordingly. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00532">532</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00669">IO_ACCEL</a>, <a class="el" href="allvars_8h_source.html#l00670">IO_DTENTR</a>, <a class="el" href="allvars_8h_source.html#l00668">IO_POT</a>, and <a class="el" href="allvars_8h_source.html#l00671">IO_TSTP</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{

<span class="preprocessor">#ifndef OUTPUTPOTENTIAL</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(blocknr == <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>)
    <span class="keywordflow">return</span> 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifndef OUTPUTACCELERATION</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(blocknr == <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>)
    <span class="keywordflow">return</span> 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifndef OUTPUTCHANGEOFENTROPY</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(blocknr == <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>)
    <span class="keywordflow">return</span> 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifndef OUTPUTTIMESTEP</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(blocknr == <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>)
    <span class="keywordflow">return</span> 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">return</span> 1;                     <span class="comment">/* default: present */</span>
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad9c685a2d6d48224bfec61680ce82b1e_icgraph.png" border="0" usemap="#proto_8h_ad9c685a2d6d48224bfec61680ce82b1e_icgraph" alt=""/></div>
<map name="proto_8h_ad9c685a2d6d48224bfec61680ce82b1e_icgraph" id="proto_8h_ad9c685a2d6d48224bfec61680ce82b1e_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="159,5,233,35"/><area shape="rect" id="node13" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="157,59,235,88"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="304,5,371,35"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="529,5,569,35"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="707,5,773,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="823,32,876,61"/><area shape="rect" id="node15" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="283,59,392,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="440,59,659,88"/><area shape="rect" id="node19" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="719,59,761,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="adf560a3f7c53865f7edbf9ff3b16c8fd"></a><!-- doxytag: member="proto.h::catch_abort" ref="adf560a3f7c53865f7edbf9ff3b16c8fd" args="(int sig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void catch_abort </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sig</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a690d62711b56d77e574ae4dd38fb72f0"></a><!-- doxytag: member="proto.h::catch_fatal" ref="a690d62711b56d77e574ae4dd38fb72f0" args="(int sig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void catch_fatal </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sig</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a1b96c5b41f1209ee91cd369f01a52352"></a><!-- doxytag: member="proto.h::check_omega" ref="a1b96c5b41f1209ee91cd369f01a52352" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void check_omega </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine computes the mass content of the box and compares it to the specified value of Omega-matter. If discrepant, the run is terminated. </p>

<p>Definition at line <a class="el" href="init_8c_source.html#l00162">162</a> of file <a class="el" href="init_8c_source.html">init.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00682">state_of_system::Mass</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l00020">init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> mass = 0, masstot, omega;
  <span class="keywordtype">int</span> i;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    mass += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass;

  MPI_Allreduce(&amp;mass, &amp;masstot, 1, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);

  omega =
    masstot / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>) / (3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>));

  <span class="keywordflow">if</span>(fabs(omega - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a>) &gt; 1.0e-3)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;\n\nI&#39;ve found something odd!\n&quot;</span>);
          printf
            (<span class="stringliteral">&quot;The mass content accounts only for Omega=%g,\nbut you specified Omega=%g in the parameterfile.\n&quot;</span>,
             omega, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a>);
          printf(<span class="stringliteral">&quot;\nI better stop.\n&quot;</span>);

          fflush(stdout);
        }
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a1b96c5b41f1209ee91cd369f01a52352_cgraph.png" border="0" usemap="#proto_8h_a1b96c5b41f1209ee91cd369f01a52352_cgraph" alt=""/></div>
<map name="proto_8h_a1b96c5b41f1209ee91cd369f01a52352_cgraph" id="proto_8h_a1b96c5b41f1209ee91cd369f01a52352_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="165,5,232,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="280,5,437,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a1b96c5b41f1209ee91cd369f01a52352_icgraph.png" border="0" usemap="#proto_8h_a1b96c5b41f1209ee91cd369f01a52352_icgraph" alt=""/></div>
<map name="proto_8h_a1b96c5b41f1209ee91cd369f01a52352_icgraph" id="proto_8h_a1b96c5b41f1209ee91cd369f01a52352_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="167,5,207,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="256,5,323,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="372,5,425,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa1abb9ee0e0a43ec19cdaa55c8ecd43c"></a><!-- doxytag: member="proto.h::close_outputfiles" ref="aa1abb9ee0e0a43ec19cdaa55c8ecd43c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void close_outputfiles </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function closes the global log-files. </p>

<p>Definition at line <a class="el" href="begrun_8c_source.html#l00262">262</a> of file <a class="el" href="begrun_8c_source.html">begrun.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00092">FdCPU</a>, <a class="el" href="allvars_8c_source.html#l00090">FdEnergy</a>, <a class="el" href="allvars_8c_source.html#l00095">FdForceTest</a>, <a class="el" href="allvars_8c_source.html#l00089">FdInfo</a>, <a class="el" href="allvars_8c_source.html#l00091">FdTimings</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> != 0)             <span class="comment">/* only the root processor writes to the log files */</span>
    <span class="keywordflow">return</span>;

  fclose(<a class="code" href="allvars_8c.html#a889700103f4f515009e98a7d789fd164">FdCPU</a>);
  fclose(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>);
  fclose(<a class="code" href="allvars_8c.html#a0230903e40950ac42dbff71dddd12176">FdEnergy</a>);
  fclose(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>);
<span class="preprocessor">#ifdef FORCETEST</span>
<span class="preprocessor"></span>  fclose(<a class="code" href="allvars_8c.html#ae16a08c18946ccba84c72541b51055dd">FdForceTest</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aa1abb9ee0e0a43ec19cdaa55c8ecd43c_icgraph.png" border="0" usemap="#proto_8h_aa1abb9ee0e0a43ec19cdaa55c8ecd43c_icgraph" alt=""/></div>
<map name="proto_8h_aa1abb9ee0e0a43ec19cdaa55c8ecd43c_icgraph" id="proto_8h_aa1abb9ee0e0a43ec19cdaa55c8ecd43c_icgraph">
<area shape="rect" id="node3" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="184,5,227,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="276,5,329,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af3ffb253e14a79419d1effeee1b7261d"></a><!-- doxytag: member="proto.h::compare_key" ref="af3ffb253e14a79419d1effeee1b7261d" args="(const void *a, const void *b)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compare_key </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>b</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is a comparison kernel for sorting the Peano-Hilbert keys. </p>

<p>Definition at line <a class="el" href="peano_8c_source.html#l00098">98</a> of file <a class="el" href="peano_8c_source.html">peano.c</a>.</p>

<p>Referenced by <a class="el" href="peano_8c_source.html#l00034">peano_hilbert_order()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structpeano__hilbert__data.html">peano_hilbert_data</a> *) a)-&gt;key &lt; (((<span class="keyword">struct</span> <a class="code" href="structpeano__hilbert__data.html">peano_hilbert_data</a> *) b)-&gt;key))
    <span class="keywordflow">return</span> -1;

  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structpeano__hilbert__data.html">peano_hilbert_data</a> *) a)-&gt;key &gt; (((<span class="keyword">struct</span> <a class="code" href="structpeano__hilbert__data.html">peano_hilbert_data</a> *) b)-&gt;key))
    <span class="keywordflow">return</span> +1;

  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af3ffb253e14a79419d1effeee1b7261d_icgraph.png" border="0" usemap="#proto_8h_af3ffb253e14a79419d1effeee1b7261d_icgraph" alt=""/></div>
<map name="proto_8h_af3ffb253e14a79419d1effeee1b7261d_icgraph" id="proto_8h_af3ffb253e14a79419d1effeee1b7261d_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="164,57,313,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="363,57,536,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="584,5,803,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="863,56,905,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="673,109,713,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="967,83,1020,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="851,109,917,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a147f9422f4bca4666608da992486b417"></a><!-- doxytag: member="proto.h::compute_accelerations" ref="a147f9422f4bca4666608da992486b417" args="(int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void compute_accelerations </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine computes the accelerations for all active particles. First, the long-range PM force is computed if the TreePM algorithm is used and a "big" PM step is done. Next, the gravitational tree forces are computed. This also constructs the tree, if needed.</p>
<p>If gas particles are present, the density-loop for active SPH particles is carried out. This includes an iteration on the correct number of neighbours. Finally, the hydrodynamical forces are added. </p>

<p>Definition at line <a class="el" href="accel_8c_source.html#l00024">24</a> of file <a class="el" href="accel_8c_source.html">accel.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00408">global_data_all_processes::CPU_Gravity</a>, <a class="el" href="allvars_8h_source.html#l00418">global_data_all_processes::CPU_Hydro</a>, <a class="el" href="allvars_8h_source.html#l00422">global_data_all_processes::CPU_PM</a>, <a class="el" href="allvars_8h_source.html#l00420">global_data_all_processes::CPU_Predict</a>, <a class="el" href="density_8c_source.html#l00056">density()</a>, <a class="el" href="forcetree_8c_source.html#l01014">force_update_hmax()</a>, <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>, <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>, <a class="el" href="hydra_8c_source.html#l00050">hydro_force()</a>, <a class="el" href="longrange_8c_source.html#l00056">long_range_force()</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00273">global_data_all_processes::TotN_gas</a>, and <a class="el" href="allvars_8h_source.html#l00350">global_data_all_processes::TypeOfOpeningCriterion</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> tstart, tend;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;Start force computation...\n&quot;</span>);
      fflush(stdout);
    }

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
    {
      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="longrange_8c.html#a5989a3f57c7d6dfdef205dc6b72a1d25">long_range_force</a>();
      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2251bf94479cb20a7af9c34ed56587d1">CPU_PM</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();            <span class="comment">/* measure the time for the full force computation */</span>

  <a class="code" href="gravtree_8c.html#ac559dc2aeb21d5a379a3751bea7736af">gravity_tree</a>();               <span class="comment">/* computes gravity accel. */</span>

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c2a481de17eefbbd973fb8a7bb6f8fc">TypeOfOpeningCriterion</a> == 1 &amp;&amp; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> == 0)
    <a class="code" href="gravtree_8c.html#ac559dc2aeb21d5a379a3751bea7736af">gravity_tree</a>();             <span class="comment">/* For the first timestep, we redo it</span>
<span class="comment">                                 * to allow usage of relative opening</span>
<span class="comment">                                 * criterion for consistent accuracy.</span>
<span class="comment">                                 */</span>
  tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a27dce58feba6ff0e933ed6f24f857168">CPU_Gravity</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

<span class="preprocessor">#ifdef FORCETEST</span>
<span class="preprocessor"></span>  <a class="code" href="gravtree__forcetest_8c.html#a51b074bdf1ec1efc0f7a323415a47e79">gravity_forcetest</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2bb70816a4d5f56e0df2d9b8d706cef2">TotN_gas</a> &gt; 0)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;Start density computation...\n&quot;</span>);
          fflush(stdout);
        }

      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c">density</a>();                <span class="comment">/* computes density, and pressure */</span>
      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#add20a8e70f3c4cc7912dc81ef141daa2">CPU_Hydro</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="forcetree_8c.html#a4764c1fb83a956c1712345538630854c">force_update_hmax</a>();      <span class="comment">/* tell the tree nodes the new SPH smoothing length such that they are guaranteed to hold the correct max(Hsml) */</span>
      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afb9d30620ea0dc8b9e46000e3ce0b3e3">CPU_Predict</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);


      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;Start hydro-force computation...\n&quot;</span>);
          fflush(stdout);
        }

      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="hydra_8c.html#a6789381bce7d1c316df8ecf04b47a607">hydro_force</a>();            <span class="comment">/* adds hydrodynamical accelerations and computes viscous entropy injection  */</span>
      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#add20a8e70f3c4cc7912dc81ef141daa2">CPU_Hydro</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;force computation done.\n&quot;</span>);
      fflush(stdout);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a147f9422f4bca4666608da992486b417_cgraph.png" border="0" usemap="#proto_8h_a147f9422f4bca4666608da992486b417_cgraph" alt=""/></div>
<map name="proto_8h_a147f9422f4bca4666608da992486b417_cgraph" id="proto_8h_a147f9422f4bca4666608da992486b417_cgraph">
<area shape="rect" id="node3" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="265,293,332,323"/><area shape="rect" id="node21" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="509,581,576,611"/><area shape="rect" id="node23" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="508,421,577,451"/><area shape="rect" id="node26" href="forcetree_8c.html#a4764c1fb83a956c1712345538630854c" title="force_update_hmax" alt="" coords="224,59,373,88"/><area shape="rect" id="node32" href="gravtree__forcetest_8c.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="235,661,363,691"/><area shape="rect" id="node48" href="gravtree_8c.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="249,816,348,845"/><area shape="rect" id="node94" href="hydra_8c.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="251,515,347,544"/><area shape="rect" id="node109" href="longrange_8c.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="477,1315,608,1344"/><area shape="rect" id="node5" href="density_8c.html#ab6453dd0ac2ecf2478b1208374e68ae1" title="dens_compare_key" alt="" coords="469,216,616,245"/><area shape="rect" id="node7" href="density_8c.html#a4e6b32342a24a33518b6ae8723809749" title="density_evaluate" alt="" coords="477,112,608,141"/><area shape="rect" id="node13" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="792,476,851,505"/><area shape="rect" id="node15" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="1309,975,1376,1004"/><area shape="rect" id="node19" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="799,369,844,399"/><area shape="rect" id="node9" href="ngb_8c.html#ae39a878e9bb71ae346097aace71632f9" title="ngb_treefind_variable" alt="" coords="743,112,900,141"/><area shape="rect" id="node11" href="ngb_8c.html#a674ac0d18eaff78ba700f1278f078274" title="ngb_clear_buf" alt="" coords="1052,112,1161,141"/><area shape="rect" id="node17" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1451,975,1608,1004"/><area shape="rect" id="node28" href="forcetree_8c.html#a4c108b1da2bc4f2620f62aeab90c1074" title="force_update_node_hmax_local" alt="" coords="431,59,655,88"/><area shape="rect" id="node30" href="forcetree_8c.html#ac3f5945bb7c73936ef49af1507265afe" title="force_update_node_hmax_toptree" alt="" coords="421,5,664,35"/><area shape="rect" id="node35" href="forcetree_8c.html#a0ec221b2517893874b12dc366bfe0da8" title="force_treeevaluate_direct" alt="" coords="451,635,635,664"/><area shape="rect" id="node40" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="1028,789,1185,819"/><area shape="rect" id="node42" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42" title="grav_tree_compare_key" alt="" coords="455,843,631,872"/><area shape="rect" id="node45" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91" title="set_softenings" alt="" coords="485,789,600,819"/><area shape="rect" id="node38" href="forcetree_8c.html#ad8b8e212e593e1795f6ba522239086fc" title="ewald_corr" alt="" coords="776,633,867,663"/><area shape="rect" id="node50" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="484,896,601,925"/><area shape="rect" id="node67" href="forcetree_8c.html#a59ae74ef51d6a7065605638422489391" title="force_treeevaluate" alt="" coords="751,948,892,977"/><area shape="rect" id="node82" href="forcetree_8c.html#ae01e179b7686a7fe62970160b7bbdb46" title="force_treeevaluate_shortrange" alt="" coords="712,1001,931,1031"/><area shape="rect" id="node52" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7" title="force_flag_localnodes" alt="" coords="743,895,900,924"/><area shape="rect" id="node54" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="741,737,901,767"/><area shape="rect" id="node65" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="715,841,928,871"/><area shape="rect" id="node56" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="1283,547,1403,576"/><area shape="rect" id="node59" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="1009,584,1204,613"/><area shape="rect" id="node69" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9" title="calculate_interact_kick" alt="" coords="1024,1000,1189,1029"/><area shape="rect" id="node71" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4" title="check_interaction_table" alt="" coords="1020,1053,1193,1083"/><area shape="rect" id="node74" href="forcetree_8c.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f" title="force_treeevaluate_ewald_correction" alt="" coords="979,893,1235,923"/><area shape="rect" id="node77" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8" title="prob_of_interaction" alt="" coords="1035,947,1179,976"/><area shape="rect" id="node79" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615" title="update_interaction_table" alt="" coords="1016,1107,1197,1136"/><area shape="rect" id="node96" href="hydra_8c.html#a8331f87f49dedbeb9e7d61d0deb8926a" title="hydro_compare_key" alt="" coords="468,528,617,557"/><area shape="rect" id="node98" href="hydra_8c.html#a818695254c9525e01bc9ddc95e8eaf7e" title="hydro_evaluate" alt="" coords="483,475,603,504"/><area shape="rect" id="node100" href="proto_8h.html#a128779c23a7c6e9cca2374c5e7c91483" title="dmin" alt="" coords="795,529,848,559"/><area shape="rect" id="node102" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10" title="imax" alt="" coords="1316,1237,1369,1267"/><area shape="rect" id="node104" href="ngb_8c.html#a96ec7acfa3c046abc6902ca77ee4bddd" title="ngb_treefind_pairs" alt="" coords="752,423,891,452"/><area shape="rect" id="node112" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97" title="pm_init_regionsize" alt="" coords="751,1341,892,1371"/><area shape="rect" id="node114" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4" title="pm_setup_nonperiodic_kernel" alt="" coords="715,1395,928,1424"/><area shape="rect" id="node116" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc" title="pmforce_nonperiodic" alt="" coords="744,1448,899,1477"/><area shape="rect" id="node118" href="pm__periodic_8c.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="756,1288,887,1317"/><area shape="rect" id="node120" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="1039,1261,1175,1291"/><area shape="rect" id="node123" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888" title="force_treefree" alt="" coords="1051,1421,1163,1451"/><area shape="rect" id="node125" href="pm__periodic_8c.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="1016,1315,1197,1344"/><area shape="rect" id="node129" href="pm__periodic_8c.html#a259e6f8400ee889c64bc667334060742" title="pm_init_periodic_free" alt="" coords="1028,1368,1185,1397"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a147f9422f4bca4666608da992486b417_icgraph.png" border="0" usemap="#proto_8h_a147f9422f4bca4666608da992486b417_icgraph" alt=""/></div>
<map name="proto_8h_a147f9422f4bca4666608da992486b417_icgraph" id="proto_8h_a147f9422f4bca4666608da992486b417_icgraph">
<area shape="rect" id="node3" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="224,5,267,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="316,5,369,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ada58109949c2431ca9b0cdaa01cfb5b1"></a><!-- doxytag: member="proto.h::compute_global_quantities_of_system" ref="ada58109949c2431ca9b0cdaa01cfb5b1" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void compute_global_quantities_of_system </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine computes various global properties of the particle distribution and stores the result in the struct `SysState'. Currently, not all the information that's computed here is actually used (e.g. momentum is not really used anywhere), just the energies are written to a log-file every once in a while. </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas </p>
</p>

<p>Definition at line <a class="el" href="global_8c_source.html#l00022">22</a> of file <a class="el" href="global_8c_source.html">global.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00688">state_of_system::AngMomentum</a>, <a class="el" href="allvars_8h_source.html#l00696">state_of_system::AngMomentumComp</a>, <a class="el" href="allvars_8h_source.html#l00689">state_of_system::CenterOfMass</a>, <a class="el" href="allvars_8h_source.html#l00697">state_of_system::CenterOfMassComp</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="allvars_8h_source.html#l00685">state_of_system::EnergyInt</a>, <a class="el" href="allvars_8h_source.html#l00693">state_of_system::EnergyIntComp</a>, <a class="el" href="allvars_8h_source.html#l00683">state_of_system::EnergyKin</a>, <a class="el" href="allvars_8h_source.html#l00691">state_of_system::EnergyKinComp</a>, <a class="el" href="allvars_8h_source.html#l00684">state_of_system::EnergyPot</a>, <a class="el" href="allvars_8h_source.html#l00692">state_of_system::EnergyPotComp</a>, <a class="el" href="allvars_8h_source.html#l00686">state_of_system::EnergyTot</a>, <a class="el" href="allvars_8h_source.html#l00694">state_of_system::EnergyTotComp</a>, <a class="el" href="allvars_8h_source.html#l00554">sph_particle_data::Entropy</a>, <a class="el" href="allvars_8h_source.html#l00071">GAMMA_MINUS1</a>, <a class="el" href="driftfac_8c_source.html#l00105">get_gravkick_factor()</a>, <a class="el" href="driftfac_8c_source.html#l00142">get_hydrokick_factor()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00562">sph_particle_data::HydroAccel</a>, <a class="el" href="allvars_8h_source.html#l00682">state_of_system::Mass</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00690">state_of_system::MassComp</a>, <a class="el" href="allvars_8h_source.html#l00687">state_of_system::Momentum</a>, <a class="el" href="allvars_8h_source.html#l00695">state_of_system::MomentumComp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00386">global_data_all_processes::PM_Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00523">particle_data::Potential</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00173">SysState</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, and <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00432">energy_statistics()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, n;
  <span class="keyword">struct </span><a class="code" href="structstate__of__system.html">state_of_system</a> sys;
  <span class="keywordtype">double</span> a1, a2, a3;
  <span class="keywordtype">double</span> entr = 0, egyspec, vel[3];
  <span class="keywordtype">double</span> dt_entr, dt_gravkick, dt_hydrokick;



  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      a1 = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
      a2 = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
      a3 = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
    }
  <span class="keywordflow">else</span>
    {
      a1 = a2 = a3 = 1;
    }


  <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
    {
      sys.MassComp[n] = sys.EnergyKinComp[n] = sys.EnergyPotComp[n] = sys.EnergyIntComp[n] = 0;

      <span class="keywordflow">for</span>(j = 0; j &lt; 4; j++)
        sys.CenterOfMassComp[n][j] = sys.MomentumComp[n][j] = sys.AngMomentumComp[n][j] = 0;
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      sys.MassComp[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;

      sys.EnergyPotComp[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] += 0.5 * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> / a1;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        {
          dt_entr = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
          dt_gravkick = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
            <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep) / 2);
          dt_hydrokick = <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
            <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep, (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_begstep + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep) / 2);
        }
      <span class="keywordflow">else</span>
        dt_entr = dt_gravkick = dt_hydrokick =
          (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          vel[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] * dt_gravkick;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type == 0)
            vel[j] += <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j] * dt_hydrokick;
        }
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type == 0)
        entr = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> * dt_entr;

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        dt_gravkick = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
          <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2);
      <span class="keywordflow">else</span>
        dt_gravkick = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        vel[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].GravPM[j] * dt_gravkick;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      sys.EnergyKinComp[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] +=
        0.5 * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * (vel[0] * vel[0] + vel[1] * vel[1] + vel[2] * vel[2]) / a2;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type == 0)
        {
<span class="preprocessor">#ifdef ISOTHERM_EQS</span>
<span class="preprocessor"></span>          egyspec = entr;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          egyspec = entr / (GAMMA_MINUS1) * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Density / a3, <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          sys.EnergyIntComp[0] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * egyspec;
        }



      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          sys.MomentumComp[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>][j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * vel[j];
          sys.CenterOfMassComp[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>][j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
        }

      sys.AngMomentumComp[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>][0] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] * vel[2] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] * vel[1]);
      sys.AngMomentumComp[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>][1] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] * vel[0] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] * vel[2]);
      sys.AngMomentumComp[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>][2] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] * vel[1] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] * vel[0]);
    }


  <span class="comment">/* some the stuff over all processors */</span>
  MPI_Reduce(&amp;sys.MassComp[0], &amp;<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[0], 6, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;sys.EnergyPotComp[0], &amp;<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[0], 6, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;sys.EnergyIntComp[0], &amp;<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[0], 6, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;sys.EnergyKinComp[0], &amp;<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[0], 6, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;sys.MomentumComp[0][0], &amp;<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a795ecb5f9b1749847bdb2d8d275323c1">MomentumComp</a>[0][0], 6 * 4, MPI_DOUBLE, MPI_SUM, 0,
             MPI_COMM_WORLD);
  MPI_Reduce(&amp;sys.AngMomentumComp[0][0], &amp;<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a384a907f66c243418fbd02c317154c72">AngMomentumComp</a>[0][0], 6 * 4, MPI_DOUBLE, MPI_SUM, 0,
             MPI_COMM_WORLD);
  MPI_Reduce(&amp;sys.CenterOfMassComp[0][0], &amp;<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[0][0], 6 * 4, MPI_DOUBLE, MPI_SUM, 0,
             MPI_COMM_WORLD);


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
        <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a2e9e012733cab8c6352b8eb23dfa4763">EnergyTotComp</a>[i] = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[i] +
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[i] + <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[i];

      <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8a3263df2542de95325b0684814dab52">Mass</a> = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a92ed1ad5f1a02586030b21f5f3e560ec">EnergyKin</a> = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#aece07698cdbe00520fcb92ad9f04d435">EnergyPot</a> = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8ee567f49007a65817989a252d8c4f90">EnergyInt</a> = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a2e6631f75e195c1b3cc446478bbdf413">EnergyTot</a> = 0;

      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a052f3f69811197adc33ecb8c4c1f8d6e">Momentum</a>[j] = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a47635bc3c684637fff0c078223ae59fc">AngMomentum</a>[j] = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[j] = 0;

      <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
        {
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8a3263df2542de95325b0684814dab52">Mass</a> += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[i];
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a92ed1ad5f1a02586030b21f5f3e560ec">EnergyKin</a> += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[i];
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#aece07698cdbe00520fcb92ad9f04d435">EnergyPot</a> += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[i];
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8ee567f49007a65817989a252d8c4f90">EnergyInt</a> += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[i];
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a2e6631f75e195c1b3cc446478bbdf413">EnergyTot</a> += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a2e9e012733cab8c6352b8eb23dfa4763">EnergyTotComp</a>[i];

          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            {
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a052f3f69811197adc33ecb8c4c1f8d6e">Momentum</a>[j] += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a795ecb5f9b1749847bdb2d8d275323c1">MomentumComp</a>[i][j];
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a47635bc3c684637fff0c078223ae59fc">AngMomentum</a>[j] += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a384a907f66c243418fbd02c317154c72">AngMomentumComp</a>[i][j];
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[j] += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[i][j];
            }
        }

      <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[i] &gt; 0)
            <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[i][j] /= <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[i];

      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8a3263df2542de95325b0684814dab52">Mass</a> &gt; 0)
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[j] /= <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8a3263df2542de95325b0684814dab52">Mass</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
        {
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[i][3] = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a795ecb5f9b1749847bdb2d8d275323c1">MomentumComp</a>[i][3] = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a384a907f66c243418fbd02c317154c72">AngMomentumComp</a>[i][3] = 0;
          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            {
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[i][3] +=
                <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[i][j] * <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[i][j];
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a795ecb5f9b1749847bdb2d8d275323c1">MomentumComp</a>[i][3] += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a795ecb5f9b1749847bdb2d8d275323c1">MomentumComp</a>[i][j] * <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a795ecb5f9b1749847bdb2d8d275323c1">MomentumComp</a>[i][j];
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a384a907f66c243418fbd02c317154c72">AngMomentumComp</a>[i][3] +=
                <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a384a907f66c243418fbd02c317154c72">AngMomentumComp</a>[i][j] * <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a384a907f66c243418fbd02c317154c72">AngMomentumComp</a>[i][j];
            }
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[i][3] = sqrt(<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a828dd437a8be308919aa25633135a902">CenterOfMassComp</a>[i][3]);
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a795ecb5f9b1749847bdb2d8d275323c1">MomentumComp</a>[i][3] = sqrt(<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a795ecb5f9b1749847bdb2d8d275323c1">MomentumComp</a>[i][3]);
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a384a907f66c243418fbd02c317154c72">AngMomentumComp</a>[i][3] = sqrt(<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a384a907f66c243418fbd02c317154c72">AngMomentumComp</a>[i][3]);
        }

      <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[3] = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a052f3f69811197adc33ecb8c4c1f8d6e">Momentum</a>[3] = <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a47635bc3c684637fff0c078223ae59fc">AngMomentum</a>[3] = 0;

      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[3] += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[j] * <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[j];
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a052f3f69811197adc33ecb8c4c1f8d6e">Momentum</a>[3] += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a052f3f69811197adc33ecb8c4c1f8d6e">Momentum</a>[j] * <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a052f3f69811197adc33ecb8c4c1f8d6e">Momentum</a>[j];
          <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a47635bc3c684637fff0c078223ae59fc">AngMomentum</a>[3] += <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a47635bc3c684637fff0c078223ae59fc">AngMomentum</a>[j] * <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a47635bc3c684637fff0c078223ae59fc">AngMomentum</a>[j];
        }

      <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[3] = sqrt(<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#abdfe2ff074685ef9fdc4043beb898e98">CenterOfMass</a>[3]);
      <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a052f3f69811197adc33ecb8c4c1f8d6e">Momentum</a>[3] = sqrt(<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a052f3f69811197adc33ecb8c4c1f8d6e">Momentum</a>[3]);
      <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a47635bc3c684637fff0c078223ae59fc">AngMomentum</a>[3] = sqrt(<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a47635bc3c684637fff0c078223ae59fc">AngMomentum</a>[3]);
    }

  <span class="comment">/* give everyone the result, maybe the want to do something with it */</span>
  MPI_Bcast(&amp;<a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structstate__of__system.html">state_of_system</a>), MPI_BYTE, 0, MPI_COMM_WORLD);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ada58109949c2431ca9b0cdaa01cfb5b1_cgraph.png" border="0" usemap="#proto_8h_ada58109949c2431ca9b0cdaa01cfb5b1_cgraph" alt=""/></div>
<map name="proto_8h_ada58109949c2431ca9b0cdaa01cfb5b1_cgraph" id="proto_8h_ada58109949c2431ca9b0cdaa01cfb5b1_cgraph">
<area shape="rect" id="node3" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="324,5,471,35"/><area shape="rect" id="node5" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="320,59,475,88"/><area shape="rect" id="node7" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="375,112,420,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ada58109949c2431ca9b0cdaa01cfb5b1_icgraph.png" border="0" usemap="#proto_8h_ada58109949c2431ca9b0cdaa01cfb5b1_icgraph" alt=""/></div>
<map name="proto_8h_ada58109949c2431ca9b0cdaa01cfb5b1_icgraph" id="proto_8h_ada58109949c2431ca9b0cdaa01cfb5b1_icgraph">
<area shape="rect" id="node3" href="run_8c.html#ae903322da17c6875ab606b032b918099" title="energy_statistics" alt="" coords="320,5,451,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="499,5,541,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="591,5,644,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a04474459731219f9601aaefedb37ab27"></a><!-- doxytag: member="proto.h::compute_potential" ref="a04474459731219f9601aaefedb37ab27" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void compute_potential </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the gravitational potential for ALL the particles. First, the (short-range) tree potential is computed, and then, if needed, the long range PM potential is added. </p>

<p>Definition at line <a class="el" href="potential_8c_source.html#l00022">22</a> of file <a class="el" href="potential_8c_source.html">potential.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00289">global_data_all_processes::BunchSizeForce</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00409">global_data_all_processes::CPU_Potential</a>, <a class="el" href="allvars_8h_source.html#l00406">global_data_all_processes::CPU_TreeConstruction</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>, <a class="el" href="forcetree_8c_source.html#l02216">force_treeevaluate_potential()</a>, <a class="el" href="forcetree_8c_source.html#l02493">force_treeevaluate_potential_shortrange()</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="gravtree_8c_source.html#l00544">grav_tree_compare_key()</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataIn</a>, <a class="el" href="allvars_8c_source.html#l00186">GravDataIndexTable</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataOut</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00744">gravdata_index::Index</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00524">particle_data::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00731">gravdata_in::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00348">global_data_all_processes::PeriodicBoundariesOn</a>, <a class="el" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize()</a>, <a class="el" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel()</a>, <a class="el" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9">pmpotential_nonperiodic()</a>, <a class="el" href="pm__periodic_8c_source.html#l00693">pmpotential_periodic()</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00709">gravdata_in::Pos</a>, <a class="el" href="allvars_8h_source.html#l00711">gravdata_in::Potential</a>, <a class="el" href="allvars_8h_source.html#l00523">particle_data::Potential</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="gravtree_8c_source.html#l00487">set_softenings()</a>, <a class="el" href="allvars_8h_source.html#l00477">global_data_all_processes::SofteningTable</a>, <a class="el" href="allvars_8h_source.html#l00745">gravdata_index::SortIndex</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="tags_8h_source.html#l00028">TAG_POTENTIAL_A</a>, <a class="el" href="tags_8h_source.html#l00029">TAG_POTENTIAL_B</a>, <a class="el" href="allvars_8h_source.html#l00743">gravdata_index::Task</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8c_source.html#l00038">TreeReconstructFlag</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">gravdata_in::u</a>, and <a class="el" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">gravdata_in::w</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>, and <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;

<span class="preprocessor">#ifndef NOGRAVITY</span>
<span class="preprocessor"></span>  <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot, ntotleft;
  <span class="keywordtype">int</span> j, k, level, sendTask, recvTask;
  <span class="keywordtype">int</span> ndone;
  <span class="keywordtype">int</span> maxfill, ngrp, place, nexport;
  <span class="keywordtype">int</span> *nsend, *noffset, *nsend_local, *nbuffer, *ndonelist, *numlist;
  <span class="keywordtype">double</span> fac;
  <span class="keywordtype">double</span> t0, t1, tstart, tend;
  MPI_Status status;
  <span class="keywordtype">double</span> r2;

  t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    <a class="code" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91">set_softenings</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;Start computation of potential for all particles...\n&quot;</span>);
      fflush(stdout);
    }


  tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#aa32d7269f9baf3ffdbdd509982fca128">TreeReconstructFlag</a>)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Tree construction.\n&quot;</span>);

      <a class="code" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5">force_treebuild</a>(<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>);

      <a class="code" href="allvars_8c.html#aa32d7269f9baf3ffdbdd509982fca128">TreeReconstructFlag</a> = 0;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Tree construction done.\n&quot;</span>);
    }
  tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac9eb650a8550b48eb464b6a0a8629a27">CPU_TreeConstruction</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

  numlist = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
  <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
    ntot += numlist[i];
  free(numlist);

  noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);        <span class="comment">/* offsets of bunches in common list */</span>
  nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
  nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
  nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask * NTask);
  ndonelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);

  i = 0;                        <span class="comment">/* beginn with this index */</span>
  ntotleft = ntot;              <span class="comment">/* particles left for all tasks together */</span>

  <span class="keywordflow">while</span>(ntotleft &gt; 0)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
        nsend_local[j] = 0;

      <span class="comment">/* do local particles and prepare export list */</span>
      <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a> - NTask; i++)
        {
          ndone++;

          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j] = 0;

<span class="preprocessor">#ifndef PMGRID</span>
<span class="preprocessor"></span>          <a class="code" href="forcetree_8c.html#af29d257a1e4545ba4b9c3648444979b6">force_treeevaluate_potential</a>(i, 0);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <a class="code" href="forcetree_8c.html#abd9d86a6c08e77a4fa78fa76b96cdde7">force_treeevaluate_potential_shortrange</a>(i, 0);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j])
                {
                  <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].u.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[k] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[k];
#ifdef UNEQUALSOFTENINGS
                  <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Type = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
#ifdef ADAPTIVE_GRAVSOFT_FORGAS
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                  <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#aba8345d83e2a1512a83563dbd87c9a3f">OldAcc</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a>;

                  <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#afacf7009bcd9677cf8ddff3dc927d6c5">Task</a> = j;
                  <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#aac6e682d48cdd924a09384b4551b678e">Index</a> = i;
                  <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#a34600f886624e73eb38845cb5d51d04c">SortIndex</a> = nexport;

                  nexport++;
                  nsend_local[j]++;
                }
            }
        }

      qsort(<a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a>), <a class="code" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42">grav_tree_compare_key</a>);

      <span class="keywordflow">for</span>(j = 0; j &lt; nexport; j++)
        <a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a>[j] = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[<a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[j].SortIndex];

      <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
        noffset[j] = noffset[j - 1] + nsend_local[j - 1];

      MPI_Allgather(nsend_local, NTask, MPI_INT, nsend, NTask, MPI_INT, MPI_COMM_WORLD);

      <span class="comment">/* now do the particles that need to be exported */</span>

      <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
        {
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nbuffer[j] = 0;
          <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
            {
              maxfill = 0;
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                {
                  <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                    <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                      maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                }
              <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>)
                <span class="keywordflow">break</span>;

              sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
              recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;

              <span class="keywordflow">if</span>(recvTask &lt; NTask)
                {
                  <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                    {
                      <span class="comment">/* get the particles */</span>
                      MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a>[noffset[recvTask]],
                                   nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#a14a200d0ece81daba5a1ce1638300430">TAG_POTENTIAL_A</a>,
                                   &amp;<a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                   nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#a14a200d0ece81daba5a1ce1638300430">TAG_POTENTIAL_A</a>, MPI_COMM_WORLD, &amp;status);
                    }
                }

              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                  nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
            }

          <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]; j++)
            {
<span class="preprocessor">#ifndef PMGRID</span>
<span class="preprocessor"></span>              <a class="code" href="forcetree_8c.html#af29d257a1e4545ba4b9c3648444979b6">force_treeevaluate_potential</a>(j, 1);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>              <a class="code" href="forcetree_8c.html#abd9d86a6c08e77a4fa78fa76b96cdde7">force_treeevaluate_potential_shortrange</a>(j, 1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            }


          <span class="comment">/* get the result */</span>
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nbuffer[j] = 0;
          <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
            {
              maxfill = 0;
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                {
                  <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                    <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                      maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                }
              <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>)
                <span class="keywordflow">break</span>;

              sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
              recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;

              <span class="keywordflow">if</span>(recvTask &lt; NTask)
                {
                  <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                    {
                      <span class="comment">/* send the results */</span>
                      MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                   nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#aa6da9595a9251b1362b6b3e0366d92c8">TAG_POTENTIAL_B</a>,
                                   &amp;<a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a>[noffset[recvTask]],
                                   nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#aa6da9595a9251b1362b6b3e0366d92c8">TAG_POTENTIAL_B</a>, MPI_COMM_WORLD, &amp;status);

                      <span class="comment">/* add the result to the particles */</span>
                      <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
                        {
                          place = <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[noffset[recvTask] + j].<a class="code" href="structgravdata__index.html#aac6e682d48cdd924a09384b4551b678e">Index</a>;

                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[place].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a>[j + noffset[recvTask]].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#ac003758a6c6e72bb9cc1ce619fabf148">Potential</a>;
                        }
                    }
                }

              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                  nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
            }

          level = ngrp - 1;
        }

      MPI_Allgather(&amp;ndone, 1, MPI_INT, ndonelist, 1, MPI_INT, MPI_COMM_WORLD);
      <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
        ntotleft -= ndonelist[j];
    }

  free(ndonelist);
  free(nsend);
  free(nsend_local);
  free(nbuffer);
  free(noffset);


  <span class="comment">/* add correction to exclude self-potential */</span>

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="comment">/* remove self-potential */</span>
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a52b027433ffad064869c606656e9bf7d">PeriodicBoundariesOn</a>)
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> -= 2.8372975 * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structstate__of__system.html#a8a3263df2542de95325b0684814dab52">Mass</a>, 2.0 / 3) *
            <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> * 3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>), 1.0 / 3);
    }


  <span class="comment">/* multiply with the gravitational constant */</span>

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Potential *= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>;


#ifdef PMGRID

#ifdef PERIODIC
  <a class="code" href="pm__periodic_8c.html#a7938f2181f23d56ac46f3625d1a855a0">pmpotential_periodic</a>();
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9">pmpotential_nonperiodic</a>(1);
  <span class="keywordflow">if</span>(i == 1)  <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
    {
      <a class="code" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a>();
      <a class="code" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel</a>();
      i = <a class="code" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9">pmpotential_nonperiodic</a>(1);   <span class="comment">/* try again */</span>
    }
  <span class="keywordflow">if</span>(i == 1)
    <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(88686);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9">pmpotential_nonperiodic</a>(0);
  <span class="keywordflow">if</span>(i == 1)                    <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
    {
      <a class="code" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a>();
      <a class="code" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel</a>();
      i = <a class="code" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9">pmpotential_nonperiodic</a>(0);   <span class="comment">/* try again */</span>
    }
  <span class="keywordflow">if</span>(i == 1)
    <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(88687);
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9">pmpotential_nonperiodic</a>(1);
  <span class="keywordflow">if</span>(i == 1)                    <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
    {
      <a class="code" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a>();

      i = <a class="code" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9">pmpotential_nonperiodic</a>(1);
    }
  <span class="keywordflow">if</span>(i != 0)
    <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(88688);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
<span class="preprocessor">#ifndef PERIODIC</span>
<span class="preprocessor"></span>      fac = -0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        {
          <span class="keywordflow">for</span>(k = 0, r2 = 0; k &lt; 3; k++)
            r2 += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[k] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[k];

          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += fac * r2;
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      fac = -0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>;
      <span class="keywordflow">if</span>(fac != 0)
        {
          <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
            {
              <span class="keywordflow">for</span>(k = 0, r2 = 0; k &lt; 3; k++)
                r2 += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[k] * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[k];

              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += fac * r2;
            }
        }
    }


  <span class="keywordflow">if</span>(ThisTask == 0)
    {
      printf(<span class="stringliteral">&quot;potential done.\n&quot;</span>);
      fflush(stdout);
    }

  t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab5f1e056cdaa2562ec2bd3945f634d73">CPU_Potential</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);

<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Potential = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a04474459731219f9601aaefedb37ab27_cgraph.png" border="0" usemap="#proto_8h_a04474459731219f9601aaefedb37ab27_cgraph" alt=""/></div>
<map name="proto_8h_a04474459731219f9601aaefedb37ab27_cgraph" id="proto_8h_a04474459731219f9601aaefedb37ab27_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="1544,289,1611,319"/><area shape="rect" id="node7" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="245,377,363,407"/><area shape="rect" id="node41" href="forcetree_8c.html#af29d257a1e4545ba4b9c3648444979b6" title="force_treeevaluate_potential" alt="" coords="201,613,407,643"/><area shape="rect" id="node46" href="forcetree_8c.html#abd9d86a6c08e77a4fa78fa76b96cdde7" title="force_treeevaluate_potential_shortrange" alt="" coords="981,640,1264,669"/><area shape="rect" id="node49" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42" title="grav_tree_compare_key" alt="" coords="216,717,392,747"/><area shape="rect" id="node51" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97" title="pm_init_regionsize" alt="" coords="233,771,375,800"/><area shape="rect" id="node53" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4" title="pm_setup_nonperiodic_kernel" alt="" coords="197,824,411,853"/><area shape="rect" id="node55" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9" title="pmpotential_nonperiodic" alt="" coords="215,877,393,907"/><area shape="rect" id="node57" href="pm__periodic_8c.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="1045,784,1200,813"/><area shape="rect" id="node71" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="544,1060,589,1089"/><area shape="rect" id="node73" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="271,1032,337,1061"/><area shape="rect" id="node75" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91" title="set_softenings" alt="" coords="247,1085,361,1115"/><area shape="rect" id="node77" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="269,1139,339,1168"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1659,289,1816,319"/><area shape="rect" id="node9" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7" title="force_flag_localnodes" alt="" coords="488,233,645,263"/><area shape="rect" id="node11" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="487,287,647,316"/><area shape="rect" id="node35" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="460,469,673,499"/><area shape="rect" id="node13" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="1063,132,1183,161"/><area shape="rect" id="node19" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="731,184,925,213"/><area shape="rect" id="node24" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="1053,236,1192,265"/><area shape="rect" id="node26" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="1017,289,1228,319"/><area shape="rect" id="node29" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="723,363,933,392"/><area shape="rect" id="node32" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="749,416,907,445"/><area shape="rect" id="node15" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="1363,132,1445,161"/><area shape="rect" id="node37" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb" title="force_exchange_pseudodata" alt="" coords="725,469,931,499"/><area shape="rect" id="node39" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19" title="force_treeupdate_pseudos" alt="" coords="732,523,924,552"/><area shape="rect" id="node44" href="forcetree_8c.html#aa0657e3de6bfb76715c14ddd72d25e58" title="ewald_pot_corr" alt="" coords="508,613,625,643"/><area shape="rect" id="node59" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="1336,677,1472,707"/><area shape="rect" id="node62" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888" title="force_treefree" alt="" coords="1348,731,1460,760"/><area shape="rect" id="node64" href="pm__periodic_8c.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="1313,784,1495,813"/><area shape="rect" id="node69" href="pm__periodic_8c.html#a259e6f8400ee889c64bc667334060742" title="pm_init_periodic_free" alt="" coords="1325,837,1483,867"/><area shape="rect" id="node67" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10" title="imax" alt="" coords="1551,784,1604,813"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a04474459731219f9601aaefedb37ab27_icgraph.png" border="0" usemap="#proto_8h_a04474459731219f9601aaefedb37ab27_icgraph" alt=""/></div>
<map name="proto_8h_a04474459731219f9601aaefedb37ab27_icgraph" id="proto_8h_a04474459731219f9601aaefedb37ab27_icgraph">
<area shape="rect" id="node3" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="197,5,416,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="464,32,507,61"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="556,32,609,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab6453dd0ac2ecf2478b1208374e68ae1"></a><!-- doxytag: member="proto.h::dens_compare_key" ref="ab6453dd0ac2ecf2478b1208374e68ae1" args="(const void *a, const void *b)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int dens_compare_key </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>b</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine is a comparison kernel used in a sort routine to group particles that are exported to the same processor. </p>

<p>Definition at line <a class="el" href="density_8c_source.html#l00607">607</a> of file <a class="el" href="density_8c_source.html">density.c</a>.</p>

<p>Referenced by <a class="el" href="density_8c_source.html#l00056">density()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a> *) a)-&gt;Task &lt; (((<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a> *) b)-&gt;Task))
    <span class="keywordflow">return</span> -1;

  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a> *) a)-&gt;Task &gt; (((<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a> *) b)-&gt;Task))
    <span class="keywordflow">return</span> +1;

  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab6453dd0ac2ecf2478b1208374e68ae1_icgraph.png" border="0" usemap="#proto_8h_ab6453dd0ac2ecf2478b1208374e68ae1_icgraph" alt=""/></div>
<map name="proto_8h_ab6453dd0ac2ecf2478b1208374e68ae1_icgraph" id="proto_8h_ab6453dd0ac2ecf2478b1208374e68ae1_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="201,32,268,61"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="323,5,493,35"/><area shape="rect" id="node11" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="319,59,497,88"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="649,5,692,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="753,32,807,61"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="548,59,588,88"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="637,59,704,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad86cdeb9e3bfbe9af379ac9f7daf194c"></a><!-- doxytag: member="proto.h::density" ref="ad86cdeb9e3bfbe9af379ac9f7daf194c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void density </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the local density for each active SPH particle, the number of neighbours in the current smoothing radius, and the divergence and curl of the velocity field. The pressure is updated as well. If a particle with its smoothing region is fully inside the local domain, it is not exported to the other processors. The function also detects particles that have a number of neighbours outside the allowed tolerance range. For these particles, the smoothing length is adjusted accordingly, and the density computation is executed again. Note that the smoothing length is not allowed to fall below the lower bound set by MinGasHsml. </p>

<p><p>&lt; For 3D-normalized kernel</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; maxmimum number of steps for SPH neighbour iteration</p>
<p>&lt; For 3D-normalized kernel</p>
<p>&lt; For 3D-normalized kernel</p>
<p>&lt; maxmimum number of steps for SPH neighbour iteration </p>
</p>

<p>Definition at line <a class="el" href="density_8c_source.html#l00056">56</a> of file <a class="el" href="density_8c_source.html">density.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="density_8c_source.html#l00022">boxHalf</a>, <a class="el" href="density_8c_source.html#l00028">boxHalf_X</a>, <a class="el" href="density_8c_source.html#l00034">boxHalf_Y</a>, <a class="el" href="density_8c_source.html#l00040">boxHalf_Z</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="density_8c_source.html#l00022">boxSize</a>, <a class="el" href="density_8c_source.html#l00027">boxSize_X</a>, <a class="el" href="density_8c_source.html#l00033">boxSize_Y</a>, <a class="el" href="density_8c_source.html#l00039">boxSize_Z</a>, <a class="el" href="allvars_8h_source.html#l00290">global_data_all_processes::BunchSizeDensity</a>, <a class="el" href="allvars_8h_source.html#l00419">global_data_all_processes::CPU_EnsureNgb</a>, <a class="el" href="allvars_8h_source.html#l00416">global_data_all_processes::CPU_HydCommSumm</a>, <a class="el" href="allvars_8h_source.html#l00415">global_data_all_processes::CPU_HydCompWalk</a>, <a class="el" href="allvars_8h_source.html#l00417">global_data_all_processes::CPU_HydImbalance</a>, <a class="el" href="allvars_8h_source.html#l00565">sph_particle_data::CurlVel</a>, <a class="el" href="density_8c_source.html#l00607">dens_compare_key()</a>, <a class="el" href="allvars_8c_source.html#l00191">DensDataGet</a>, <a class="el" href="allvars_8c_source.html#l00191">DensDataIn</a>, <a class="el" href="allvars_8c_source.html#l00195">DensDataPartialResult</a>, <a class="el" href="allvars_8c_source.html#l00195">DensDataResult</a>, <a class="el" href="allvars_8h_source.html#l00555">sph_particle_data::Density</a>, <a class="el" href="density_8c_source.html#l00467">density_evaluate()</a>, <a class="el" href="allvars_8h_source.html#l00304">global_data_all_processes::DesNumNgb</a>, <a class="el" href="allvars_8h_source.html#l00766">densdata_out::DhsmlDensity</a>, <a class="el" href="allvars_8h_source.html#l00567">sph_particle_data::DhsmlDensityFactor</a>, <a class="el" href="allvars_8h_source.html#l00765">densdata_out::Div</a>, <a class="el" href="allvars_8h_source.html#l00564">sph_particle_data::DivVel</a>, <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00554">sph_particle_data::Entropy</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00755">densdata_in::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00756">densdata_in::Index</a>, <a class="el" href="allvars_8h_source.html#l00557">sph_particle_data::Left</a>, <a class="el" href="allvars_8h_source.html#l00113">MAXITER</a>, <a class="el" href="allvars_8h_source.html#l00305">global_data_all_processes::MaxNumNgbDeviation</a>, <a class="el" href="allvars_8h_source.html#l00460">global_data_all_processes::MinGasHsml</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8h_source.html#l00767">densdata_out::Ngb</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00124">NUMDIMS</a>, <a class="el" href="allvars_8h_source.html#l00559">sph_particle_data::NumNgb</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00025">NumSphUpdate</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00753">densdata_in::Pos</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8h_source.html#l00560">sph_particle_data::Pressure</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="allvars_8h_source.html#l00764">densdata_out::Rho</a>, <a class="el" href="allvars_8h_source.html#l00558">sph_particle_data::Right</a>, <a class="el" href="allvars_8h_source.html#l00765">densdata_out::Rot</a>, <a class="el" href="allvars_8h_source.html#l00566">sph_particle_data::Rot</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="tags_8h_source.html#l00030">TAG_DENS_A</a>, <a class="el" href="tags_8h_source.html#l00031">TAG_DENS_B</a>, <a class="el" href="allvars_8h_source.html#l00757">densdata_in::Task</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00754">densdata_in::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00563">sph_particle_data::VelPred</a>.</p>

<p>Referenced by <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>, and <a class="el" href="init_8c_source.html#l00199">setup_smoothinglengths()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot, ntotleft;
  <span class="keywordtype">int</span> *noffset, *nbuffer, *nsend, *nsend_local, *numlist, *ndonelist;
  <span class="keywordtype">int</span> i, j, n, ndone, npleft, maxfill, source, iter = 0;
  <span class="keywordtype">int</span> level, ngrp, sendTask, recvTask, place, nexport;
  <span class="keywordtype">double</span> dt_entr, tstart, tend, tstart_ngb = 0, tend_ngb = 0;
  <span class="keywordtype">double</span> sumt, sumcomm, timengb, sumtimengb;
  <span class="keywordtype">double</span> timecomp = 0, timeimbalance = 0, timecommsumm = 0, sumimbalance;
  MPI_Status status;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <a class="code" href="density_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  <a class="code" href="density_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#ifdef LONG_X</span>
<span class="preprocessor"></span>  <a class="code" href="density_8c.html#a0ecceb71797a529fb6f2b8c47b51686c">boxHalf_X</a> = <a class="code" href="density_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_X;
  <a class="code" href="density_8c.html#a5c5328b307b005e6682669279878cef0">boxSize_X</a> = <a class="code" href="density_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_X;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
<span class="preprocessor"></span>  <a class="code" href="density_8c.html#a59f20d7decc2bdfedcaafb70ef23df0e">boxHalf_Y</a> = <a class="code" href="density_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_Y;
  <a class="code" href="density_8c.html#ab0db73a31e08d33d840e28651e3cf610">boxSize_Y</a> = <a class="code" href="density_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_Y;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
<span class="preprocessor"></span>  <a class="code" href="density_8c.html#a34e9d5d079320cbfc0576d26f58d2fe7">boxHalf_Z</a> = <a class="code" href="density_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_Z;
  <a class="code" href="density_8c.html#a8a97a1c456bdd396791c84c370f0aa18">boxSize_Z</a> = <a class="code" href="density_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);        <span class="comment">/* offsets of bunches in common list */</span>
  nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  ndonelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);

  <span class="keywordflow">for</span>(n = 0, <a class="code" href="allvars_8c.html#a0da112f9d57d7d936055dbb1035cd7fa">NumSphUpdate</a> = 0; n &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; n++)
    {
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[n].<a class="code" href="structsph__particle__data.html#a05d75ccc7dbd52562b7211fc74e674af">Left</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[n].<a class="code" href="structsph__particle__data.html#ae21f207de0a8a6f53cc891a7556f2592">Right</a> = 0;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_endstep == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
        <a class="code" href="allvars_8c.html#a0da112f9d57d7d936055dbb1035cd7fa">NumSphUpdate</a>++;
    }

  numlist = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a0da112f9d57d7d936055dbb1035cd7fa">NumSphUpdate</a>, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
  <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
    ntot += numlist[i];
  free(numlist);



  <span class="comment">/* we will repeat the whole thing for those particles where we didn&#39;t</span>
<span class="comment">   * find enough neighbours</span>
<span class="comment">   */</span>
  <span class="keywordflow">do</span>
    {
      i = 0;                    <span class="comment">/* beginn with this index */</span>
      ntotleft = ntot;          <span class="comment">/* particles left for all tasks together */</span>

      <span class="keywordflow">while</span>(ntotleft &gt; 0)
        {
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nsend_local[j] = 0;

          <span class="comment">/* do local particles and prepare export list */</span>
          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; N_gas &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a> - NTask; i++)
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
              {
                ndone++;

                <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j] = 0;

                <a class="code" href="density_8c.html#a4e6b32342a24a33518b6ae8723809749">density_evaluate</a>(i, 0);

                <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                  {
                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j])
                      {
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a619b6e6d76f91b047119249915527164">Pos</a>[0] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a619b6e6d76f91b047119249915527164">Pos</a>[1] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a619b6e6d76f91b047119249915527164">Pos</a>[2] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a8df7f2cfb255b800bbbbb69d674ae4ac">Vel</a>[0] = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[0];
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a8df7f2cfb255b800bbbbb69d674ae4ac">Vel</a>[1] = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[1];
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a8df7f2cfb255b800bbbbb69d674ae4ac">Vel</a>[2] = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[2];
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a5a572c3fbe7024feabd787fde3bd8689">Hsml</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a1c79a4d4fdcc9e483946193f2d030308">Index</a> = i;
                        <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#a010be125c58096f5cd2fec47f210747b">Task</a> = j;
                        nexport++;
                        nsend_local[j]++;
                      }
                  }
              }
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timecomp += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

          qsort(<a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a>), <a class="code" href="density_8c.html#ab6453dd0ac2ecf2478b1208374e68ae1">dens_compare_key</a>);

          <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
            noffset[j] = noffset[j - 1] + nsend_local[j - 1];

          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

          MPI_Allgather(nsend_local, NTask, MPI_INT, nsend, NTask, MPI_INT, MPI_COMM_WORLD);

          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timeimbalance += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);


          <span class="comment">/* now do the particles that need to be exported */</span>

          <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
            {
              tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                nbuffer[j] = 0;
              <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
                {
                  maxfill = 0;
                  <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                    {
                      <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                        <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                          maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                    }
                  <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a>)
                    <span class="keywordflow">break</span>;

                  sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
                  recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;

                  <span class="keywordflow">if</span>(recvTask &lt; NTask)
                    {
                      <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                        {
                          <span class="comment">/* get the particles */</span>
                          MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[noffset[recvTask]],
                                       nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a>), MPI_BYTE,
                                       recvTask, <a class="code" href="tags_8h.html#a1978a19a0edd12d682fe3b33dfe1780d">TAG_DENS_A</a>,
                                       &amp;<a class="code" href="allvars_8c.html#aa2903f03b426e94ee0e7dbd08e281e3e">DensDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                       nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a>),
                                       MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a1978a19a0edd12d682fe3b33dfe1780d">TAG_DENS_A</a>, MPI_COMM_WORLD, &amp;status);
                        }
                    }

                  <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                    <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                      nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
                }
              tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
              timecommsumm += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);


              tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
              <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]; j++)
                <a class="code" href="density_8c.html#a4e6b32342a24a33518b6ae8723809749">density_evaluate</a>(j, 1);
              tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
              timecomp += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

              <span class="comment">/* do a block to explicitly measure imbalance */</span>
              tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
              MPI_Barrier(MPI_COMM_WORLD);
              tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
              timeimbalance += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

              <span class="comment">/* get the result */</span>
              tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                nbuffer[j] = 0;
              <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
                {
                  maxfill = 0;
                  <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                    {
                      <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                        <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                          maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                    }
                  <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a9ab84bfa2f66ade551d613aeb3921d76">BunchSizeDensity</a>)
                    <span class="keywordflow">break</span>;

                  sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
                  recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;

                  <span class="keywordflow">if</span>(recvTask &lt; NTask)
                    {
                      <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                        {
                          <span class="comment">/* send the results */</span>
                          MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                       nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdensdata__out.html">densdata_out</a>),
                                       MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#af5fcb5427e3fea5a318be153b781aba2">TAG_DENS_B</a>,
                                       &amp;<a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a>[noffset[recvTask]],
                                       nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdensdata__out.html">densdata_out</a>),
                                       MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#af5fcb5427e3fea5a318be153b781aba2">TAG_DENS_B</a>, MPI_COMM_WORLD, &amp;status);

                          <span class="comment">/* add the result to the particles */</span>
                          <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
                            {
                              source = j + noffset[recvTask];
                              place = <a class="code" href="allvars_8c.html#ae697d6f8bee6bc6d77eb68e46155aed6">DensDataIn</a>[source].<a class="code" href="structdensdata__in.html#a1c79a4d4fdcc9e483946193f2d030308">Index</a>;

                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#a8038c8b4be4a553e5c13c9b9e711c5c0">NumNgb</a> += <a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#ad78ddc3f9c8fb77b2e98f04d5cd2dfb4">Ngb</a>;
                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a> += <a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#a7a4edc5de1283464a658fb089594d11c">Rho</a>;
                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#a1af47e5f5e7ef9e4a656411c468c8d14">DivVel</a> += <a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#af3c2ce61474da5764ac1b50155c0aa7e">Div</a>;

                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a> += <a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#a4a4b92bd40642207d3e6748ae90c8d49">DhsmlDensity</a>;

                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#a6b9b7ed346c2d65d50dacd4b43cdd1d2">Rot</a>[0] += <a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#a748be7d0e50757980389fb667d6d022b">Rot</a>[0];
                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#a6b9b7ed346c2d65d50dacd4b43cdd1d2">Rot</a>[1] += <a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#a748be7d0e50757980389fb667d6d022b">Rot</a>[1];
                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#a6b9b7ed346c2d65d50dacd4b43cdd1d2">Rot</a>[2] += <a class="code" href="allvars_8c.html#a6ba7d2763f0c08d5759c63d3ba44b3bd">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#a748be7d0e50757980389fb667d6d022b">Rot</a>[2];
                            }
                        }
                    }

                  <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                    <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                      nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
                }
              tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
              timecommsumm += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

              level = ngrp - 1;
            }

          MPI_Allgather(&amp;ndone, 1, MPI_INT, ndonelist, 1, MPI_INT, MPI_COMM_WORLD);
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            ntotleft -= ndonelist[j];
        }



      <span class="comment">/* do final operations on results */</span>
      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <span class="keywordflow">for</span>(i = 0, npleft = 0; i &lt; N_gas; i++)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
            {
              {
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a> =
                  1 / (1 + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a> / (<a class="code" href="allvars_8h.html#a2e32e163509d0638d5c54046429c00b3">NUMDIMS</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a>));

                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a843c827a50c8783218cd850925deb575">CurlVel</a> = sqrt(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Rot[0] * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Rot[0] +
                                       <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Rot[1] * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Rot[1] +
                                       <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Rot[2] * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Rot[2]) / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a>;

                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a1af47e5f5e7ef9e4a656411c468c8d14">DivVel</a> /= <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a>;

                dt_entr = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a9201a97de5fe06f6ed6fcc33386eccda">Pressure</a> =
                  (<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> * dt_entr) * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Density, <a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a>);
              }


              <span class="comment">/* now check whether we had enough neighbours */</span>

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].NumNgb &lt; (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a388690a6ee1497eea2f19e3984afa088">MaxNumNgbDeviation</a>) ||
                 (<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a8038c8b4be4a553e5c13c9b9e711c5c0">NumNgb</a> &gt; (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a388690a6ee1497eea2f19e3984afa088">MaxNumNgbDeviation</a>)
                  &amp;&amp; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml &gt; (1.01 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aec92c94dd2a1d0f0e1ad56f2e790384a">MinGasHsml</a>)))
                {
                  <span class="comment">/* need to redo this particle */</span>
                  npleft++;

                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left &gt; 0 &amp;&amp; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right &gt; 0)
                    <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right - <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left) &lt; 1.0e-3 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a05d75ccc7dbd52562b7211fc74e674af">Left</a>)
                      {
                        <span class="comment">/* this one should be ok */</span>
                        npleft--;
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - 1; <span class="comment">/* Mark as inactive */</span>
                        <span class="keywordflow">continue</span>;
                      }

                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].NumNgb &lt; (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a388690a6ee1497eea2f19e3984afa088">MaxNumNgbDeviation</a>))
                    <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left);
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right != 0)
                        {
                          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right)
                            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#ae21f207de0a8a6f53cc891a7556f2592">Right</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
                        }
                      <span class="keywordflow">else</span>
                        <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#ae21f207de0a8a6f53cc891a7556f2592">Right</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
                    }

                  <span class="keywordflow">if</span>(iter &gt;= <a class="code" href="allvars_8h.html#a9e60f3e57fde2b9b1c7fe2eab7334add">MAXITER</a> - 10)
                    {
                      printf
                        (<span class="stringliteral">&quot;i=%d task=%d ID=%d Hsml=%g Left=%g Right=%g Ngbs=%g Right-Left=%g\n   pos=(%g|%g|%g)\n&quot;</span>,
                         i, ThisTask, (<span class="keywordtype">int</span>) <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].ID, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right,
                         (<span class="keywordtype">float</span>) <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].NumNgb, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right - <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[1],
                         <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[2]);
                      fflush(stdout);
                    }

                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right &gt; 0 &amp;&amp; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left &gt; 0)
                    <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> = <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(0.5 * (<a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left, 3) + <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right, 3)), 1.0 / 3);
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left == 0)
                        <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(8188);   <span class="comment">/* can&#39;t occur */</span>

                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left &gt; 0)
                        {
                          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type == 0 &amp;&amp; fabs(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].NumNgb - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a>) &lt; 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a>)
                            {
                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> *=
                                1 - (<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a8038c8b4be4a553e5c13c9b9e711c5c0">NumNgb</a> -
                                     <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a>) / (<a class="code" href="allvars_8h.html#a2e32e163509d0638d5c54046429c00b3">NUMDIMS</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].NumNgb) * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a>;
                            }
                          <span class="keywordflow">else</span>
                            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> *= 1.26;
                        }

                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Right &gt; 0 &amp;&amp; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Left == 0)
                        {
                          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type == 0 &amp;&amp; fabs(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].NumNgb - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a>) &lt; 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a>)
                            {
                              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> *=
                                1 - (<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a8038c8b4be4a553e5c13c9b9e711c5c0">NumNgb</a> -
                                     <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a>) / (<a class="code" href="allvars_8h.html#a2e32e163509d0638d5c54046429c00b3">NUMDIMS</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].NumNgb) * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a>;
                            }
                          <span class="keywordflow">else</span>
                            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> /= 1.26;
                        }
                    }

                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aec92c94dd2a1d0f0e1ad56f2e790384a">MinGasHsml</a>)
                    <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aec92c94dd2a1d0f0e1ad56f2e790384a">MinGasHsml</a>;
                }
              <span class="keywordflow">else</span>
                <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - 1; <span class="comment">/* Mark as inactive */</span>
            }
        }
      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      timecomp += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);


      numlist = malloc(NTask * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
      MPI_Allgather(&amp;npleft, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
      <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; NTask; i++)
        ntot += numlist[i];
      free(numlist);

      <span class="keywordflow">if</span>(ntot &gt; 0)
        {
          <span class="keywordflow">if</span>(iter == 0)
            tstart_ngb = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

          iter++;

          <span class="keywordflow">if</span>(iter &gt; 0 &amp;&amp; ThisTask == 0)
            {
              printf(<span class="stringliteral">&quot;ngb iteration %d: need to repeat for %d%09d particles.\n&quot;</span>, iter,
                     (<span class="keywordtype">int</span>) (ntot / 1000000000), (<span class="keywordtype">int</span>) (ntot % 1000000000));
              fflush(stdout);
            }

          <span class="keywordflow">if</span>(iter &gt; <a class="code" href="allvars_8h.html#a9e60f3e57fde2b9b1c7fe2eab7334add">MAXITER</a>)
            {
              printf(<span class="stringliteral">&quot;failed to converge in neighbour iteration in density()\n&quot;</span>);
              fflush(stdout);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1155);
            }
        }
      <span class="keywordflow">else</span>
        tend_ngb = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
    }
  <span class="keywordflow">while</span>(ntot &gt; 0);


  <span class="comment">/* mark as active again */</span>
  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Ti_endstep &lt; 0)
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - 1;

  free(ndonelist);
  free(nsend);
  free(nsend_local);
  free(nbuffer);
  free(noffset);


  <span class="comment">/* collect some timing information */</span>
  <span class="keywordflow">if</span>(iter &gt; 0)
    timengb = <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart_ngb, tend_ngb);
  <span class="keywordflow">else</span>
    timengb = 0;

  MPI_Reduce(&amp;timengb, &amp;sumtimengb, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;timecomp, &amp;sumt, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;timecommsumm, &amp;sumcomm, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;timeimbalance, &amp;sumimbalance, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(ThisTask == 0)
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a918e3d80cf4fdaf22a803f4014588ad4">CPU_HydCompWalk</a> += sumt / NTask;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad03842fb23d3c15316ca07c7ac1bce27">CPU_HydCommSumm</a> += sumcomm / NTask;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a848f914dfb3ae24d6faedc1944bcb265">CPU_HydImbalance</a> += sumimbalance / NTask;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad3447593858d4165b669b5e70b2521cd">CPU_EnsureNgb</a> += sumtimengb / NTask;
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad86cdeb9e3bfbe9af379ac9f7daf194c_cgraph.png" border="0" usemap="#proto_8h_ad86cdeb9e3bfbe9af379ac9f7daf194c_cgraph" alt=""/></div>
<map name="proto_8h_ad86cdeb9e3bfbe9af379ac9f7daf194c_cgraph" id="proto_8h_ad86cdeb9e3bfbe9af379ac9f7daf194c_cgraph">
<area shape="rect" id="node3" href="density_8c.html#ab6453dd0ac2ecf2478b1208374e68ae1" title="dens_compare_key" alt="" coords="123,5,269,35"/><area shape="rect" id="node5" href="density_8c.html#a4e6b32342a24a33518b6ae8723809749" title="density_evaluate" alt="" coords="131,59,261,88"/><area shape="rect" id="node11" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="167,112,225,141"/><area shape="rect" id="node13" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="163,165,229,195"/><area shape="rect" id="node17" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="375,271,420,300"/><area shape="rect" id="node19" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="163,269,229,299"/><area shape="rect" id="node21" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="161,323,231,352"/><area shape="rect" id="node7" href="ngb_8c.html#ae39a878e9bb71ae346097aace71632f9" title="ngb_treefind_variable" alt="" coords="319,59,476,88"/><area shape="rect" id="node9" href="ngb_8c.html#a674ac0d18eaff78ba700f1278f078274" title="ngb_clear_buf" alt="" coords="527,59,636,88"/><area shape="rect" id="node15" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="319,165,476,195"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad86cdeb9e3bfbe9af379ac9f7daf194c_icgraph.png" border="0" usemap="#proto_8h_ad86cdeb9e3bfbe9af379ac9f7daf194c_icgraph" alt=""/></div>
<map name="proto_8h_ad86cdeb9e3bfbe9af379ac9f7daf194c_icgraph" id="proto_8h_ad86cdeb9e3bfbe9af379ac9f7daf194c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="128,5,299,35"/><area shape="rect" id="node9" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="124,59,303,88"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="455,5,497,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="559,32,612,61"/><area shape="rect" id="node11" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="353,59,393,88"/><area shape="rect" id="node13" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="443,59,509,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aaeec847fb319935d1a6e765ffbb9c6d9"></a><!-- doxytag: member="proto.h::density_decouple" ref="aaeec847fb319935d1a6e765ffbb9c6d9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void density_decouple </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a19f7a07621c698ae894f53836e9ff03c"></a><!-- doxytag: member="proto.h::density_evaluate" ref="a19f7a07621c698ae894f53836e9ff03c" args="(int i, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void density_evaluate </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function represents the core of the SPH density computation. The target particle may either be local, or reside in the communication buffer. </p>

<p><p>&lt; Coefficients for SPH spline kernel and its derivative</p>
<p>&lt; Coefficient for kernel normalization. Note: 4.0/3 * PI = 4.188790204786</p>
<p>&lt; For 3D-normalized kernel </p>
</p>

<p>Definition at line <a class="el" href="density_8c_source.html#l00467">467</a> of file <a class="el" href="density_8c_source.html">density.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="density_8c_source.html#l00028">boxHalf_X</a>, <a class="el" href="density_8c_source.html#l00034">boxHalf_Y</a>, <a class="el" href="density_8c_source.html#l00040">boxHalf_Z</a>, <a class="el" href="allvars_8c_source.html#l00191">DensDataGet</a>, <a class="el" href="allvars_8c_source.html#l00195">DensDataResult</a>, <a class="el" href="allvars_8h_source.html#l00555">sph_particle_data::Density</a>, <a class="el" href="allvars_8h_source.html#l00766">densdata_out::DhsmlDensity</a>, <a class="el" href="allvars_8h_source.html#l00567">sph_particle_data::DhsmlDensityFactor</a>, <a class="el" href="allvars_8h_source.html#l00765">densdata_out::Div</a>, <a class="el" href="allvars_8h_source.html#l00564">sph_particle_data::DivVel</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00755">densdata_in::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00125">KERNEL_COEFF_1</a>, <a class="el" href="allvars_8h_source.html#l00126">KERNEL_COEFF_2</a>, <a class="el" href="allvars_8h_source.html#l00127">KERNEL_COEFF_3</a>, <a class="el" href="allvars_8h_source.html#l00129">KERNEL_COEFF_5</a>, <a class="el" href="allvars_8h_source.html#l00130">KERNEL_COEFF_6</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00767">densdata_out::Ngb</a>, <a class="el" href="ngb_8c_source.html#l00194">ngb_treefind_variable()</a>, <a class="el" href="allvars_8c_source.html#l00036">Ngblist</a>, <a class="el" href="allvars_8h_source.html#l00131">NORM_COEFF</a>, <a class="el" href="allvars_8h_source.html#l00124">NUMDIMS</a>, <a class="el" href="allvars_8h_source.html#l00559">sph_particle_data::NumNgb</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00753">densdata_in::Pos</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00764">densdata_out::Rho</a>, <a class="el" href="allvars_8h_source.html#l00765">densdata_out::Rot</a>, <a class="el" href="allvars_8h_source.html#l00566">sph_particle_data::Rot</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00754">densdata_in::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00563">sph_particle_data::VelPred</a>.</p>

<p>Referenced by <a class="el" href="density_8c_source.html#l00056">density()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> j, n, startnode, numngb, numngb_inbox;
  <span class="keywordtype">double</span> h, h2, fac, hinv, hinv3, hinv4;
  <span class="keywordtype">double</span> rho, divv, wk, dwk;
  <span class="keywordtype">double</span> dx, dy, dz, r, r2, u, mass_j;
  <span class="keywordtype">double</span> dvx, dvy, dvz, rotv[3];
  <span class="keywordtype">double</span> weighted_numngb, dhsmlrho;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> *pos, *vel;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>;
      vel = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>;
      h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
    }
  <span class="keywordflow">else</span>
    {
      pos = <a class="code" href="allvars_8c.html#aa2903f03b426e94ee0e7dbd08e281e3e">DensDataGet</a>[target].<a class="code" href="structdensdata__in.html#a619b6e6d76f91b047119249915527164">Pos</a>;
      vel = <a class="code" href="allvars_8c.html#aa2903f03b426e94ee0e7dbd08e281e3e">DensDataGet</a>[target].<a class="code" href="structdensdata__in.html#a8df7f2cfb255b800bbbbb69d674ae4ac">Vel</a>;
      h = <a class="code" href="allvars_8c.html#aa2903f03b426e94ee0e7dbd08e281e3e">DensDataGet</a>[target].<a class="code" href="structdensdata__in.html#a5a572c3fbe7024feabd787fde3bd8689">Hsml</a>;
    }

  h2 = h * h;
  hinv = 1.0 / h;
<span class="preprocessor">#ifndef  TWODIMS</span>
<span class="preprocessor"></span>  hinv3 = hinv * hinv * hinv;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  hinv3 = hinv * hinv / boxSize_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  hinv4 = hinv3 * hinv;

  rho = divv = rotv[0] = rotv[1] = rotv[2] = 0;
  weighted_numngb = 0;
  dhsmlrho = 0;

  startnode = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;
  numngb = 0;
  <span class="keywordflow">do</span>
    {
      numngb_inbox = <a class="code" href="ngb_8c.html#ae39a878e9bb71ae346097aace71632f9">ngb_treefind_variable</a>(&amp;pos[0], h, &amp;startnode);

      <span class="keywordflow">for</span>(n = 0; n &lt; numngb_inbox; n++)
        {
          j = <a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a>[n];

          dx = pos[0] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
          dy = pos[1] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
          dz = pos[2] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];

<span class="preprocessor">#ifdef PERIODIC                 </span><span class="comment">/*  now find the closest image in the given box size  */</span>
          <span class="keywordflow">if</span>(dx &gt; <a class="code" href="density_8c.html#a0ecceb71797a529fb6f2b8c47b51686c">boxHalf_X</a>)
            dx -= boxSize_X;
          <span class="keywordflow">if</span>(dx &lt; -<a class="code" href="density_8c.html#a0ecceb71797a529fb6f2b8c47b51686c">boxHalf_X</a>)
            dx += boxSize_X;
          <span class="keywordflow">if</span>(dy &gt; <a class="code" href="density_8c.html#a59f20d7decc2bdfedcaafb70ef23df0e">boxHalf_Y</a>)
            dy -= boxSize_Y;
          <span class="keywordflow">if</span>(dy &lt; -<a class="code" href="density_8c.html#a59f20d7decc2bdfedcaafb70ef23df0e">boxHalf_Y</a>)
            dy += boxSize_Y;
          <span class="keywordflow">if</span>(dz &gt; <a class="code" href="density_8c.html#a34e9d5d079320cbfc0576d26f58d2fe7">boxHalf_Z</a>)
            dz -= boxSize_Z;
          <span class="keywordflow">if</span>(dz &lt; -<a class="code" href="density_8c.html#a34e9d5d079320cbfc0576d26f58d2fe7">boxHalf_Z</a>)
            dz += boxSize_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;

          <span class="keywordflow">if</span>(r2 &lt; h2)
            {
              numngb++;

              r = sqrt(r2);

              u = r * hinv;

              <span class="keywordflow">if</span>(u &lt; 0.5)
                {
                  wk = hinv3 * (<a class="code" href="allvars_8h.html#ab5f539f35b0297ef0f6650cf869ce461">KERNEL_COEFF_1</a> + <a class="code" href="allvars_8h.html#a5d38a374d10a6baf4406b7c65b542056">KERNEL_COEFF_2</a> * (u - 1) * u * u);
                  dwk = hinv4 * u * (<a class="code" href="allvars_8h.html#a3bb5c97343f773154b21becfa01914c3">KERNEL_COEFF_3</a> * u - KERNEL_COEFF_4);
                }
              <span class="keywordflow">else</span>
                {
                  wk = hinv3 * <a class="code" href="allvars_8h.html#a7840162cc2fd06c919b18817d647b667">KERNEL_COEFF_5</a> * (1.0 - u) * (1.0 - u) * (1.0 - u);
                  dwk = hinv4 * <a class="code" href="allvars_8h.html#a7b9464063f0137e9da842c10d1b86ed2">KERNEL_COEFF_6</a> * (1.0 - u) * (1.0 - u);
                }

              mass_j = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;

              rho += mass_j * wk;

              weighted_numngb += <a class="code" href="allvars_8h.html#a2c92c6993dec8847de1e1621d81818ce">NORM_COEFF</a> * wk / hinv3;

              dhsmlrho += -mass_j * (<a class="code" href="allvars_8h.html#a2e32e163509d0638d5c54046429c00b3">NUMDIMS</a> * hinv * wk + u * dwk);

              <span class="keywordflow">if</span>(r &gt; 0)
                {
                  fac = mass_j * dwk / r;

                  dvx = vel[0] - <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[0];
                  dvy = vel[1] - <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[1];
                  dvz = vel[2] - <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[2];

                  divv -= fac * (dx * dvx + dy * dvy + dz * dvz);

                  rotv[0] += fac * (dz * dvy - dy * dvz);
                  rotv[1] += fac * (dx * dvz - dz * dvx);
                  rotv[2] += fac * (dy * dvx - dx * dvy);
                }
            }
        }
    }
  <span class="keywordflow">while</span>(startnode &gt;= 0);

  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a8038c8b4be4a553e5c13c9b9e711c5c0">NumNgb</a> = weighted_numngb;
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a> = rho;
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a1af47e5f5e7ef9e4a656411c468c8d14">DivVel</a> = divv;
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a> = dhsmlrho;
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a6b9b7ed346c2d65d50dacd4b43cdd1d2">Rot</a>[0] = rotv[0];
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a6b9b7ed346c2d65d50dacd4b43cdd1d2">Rot</a>[1] = rotv[1];
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a6b9b7ed346c2d65d50dacd4b43cdd1d2">Rot</a>[2] = rotv[2];
    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#a7a4edc5de1283464a658fb089594d11c">Rho</a> = rho;
      <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#af3c2ce61474da5764ac1b50155c0aa7e">Div</a> = divv;
      <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#ad78ddc3f9c8fb77b2e98f04d5cd2dfb4">Ngb</a> = weighted_numngb;
      <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#a4a4b92bd40642207d3e6748ae90c8d49">DhsmlDensity</a> = dhsmlrho;
      <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#a748be7d0e50757980389fb667d6d022b">Rot</a>[0] = rotv[0];
      <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#a748be7d0e50757980389fb667d6d022b">Rot</a>[1] = rotv[1];
      <a class="code" href="allvars_8c.html#a85a5932e895f3ffca16cbfdb0b0d4b10">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#a748be7d0e50757980389fb667d6d022b">Rot</a>[2] = rotv[2];
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a19f7a07621c698ae894f53836e9ff03c_cgraph.png" border="0" usemap="#proto_8h_a19f7a07621c698ae894f53836e9ff03c_cgraph" alt=""/></div>
<map name="proto_8h_a19f7a07621c698ae894f53836e9ff03c_cgraph" id="proto_8h_a19f7a07621c698ae894f53836e9ff03c_cgraph">
<area shape="rect" id="node3" href="ngb_8c.html#ae39a878e9bb71ae346097aace71632f9" title="ngb_treefind_variable" alt="" coords="185,5,343,35"/><area shape="rect" id="node5" href="ngb_8c.html#a674ac0d18eaff78ba700f1278f078274" title="ngb_clear_buf" alt="" coords="393,5,503,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a19f7a07621c698ae894f53836e9ff03c_icgraph.png" border="0" usemap="#proto_8h_a19f7a07621c698ae894f53836e9ff03c_icgraph" alt=""/></div>
<map name="proto_8h_a19f7a07621c698ae894f53836e9ff03c_icgraph" id="proto_8h_a19f7a07621c698ae894f53836e9ff03c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="185,32,252,61"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="307,5,477,35"/><area shape="rect" id="node11" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="303,59,481,88"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="633,5,676,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="737,32,791,61"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="532,59,572,88"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="621,59,688,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="abf75a70e8719e8ed6de565a6ae90f1ab"></a><!-- doxytag: member="proto.h::distribute_file" ref="abf75a70e8719e8ed6de565a6ae90f1ab" args="(int nfiles, int firstfile, int firsttask, int lasttask, int *filenr, int *master, int *last)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void distribute_file </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>nfiles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>firstfile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>firsttask</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>lasttask</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>filenr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>master</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>last</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function assigns a certain number of files to processors, such that each processor is exactly assigned to one file, and the number of cpus per file is as homogenous as possible. The number of files may at most be equal to the number of processors. </p>

<p>Definition at line <a class="el" href="read__ic_8c_source.html#l00724">724</a> of file <a class="el" href="read__ic_8c_source.html">read_ic.c</a>.</p>

<p>References <a class="el" href="read__ic_8c_source.html#l00724">distribute_file()</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00724">distribute_file()</a>, <a class="el" href="read__ic_8c_source.html#l00031">read_ic()</a>, and <a class="el" href="io_8c_source.html#l00033">savepositions()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> ntask, filesleft, filesright, tasksleft, tasksright;

  <span class="keywordflow">if</span>(nfiles &gt; 1)
    {
      ntask = lasttask - firsttask + 1;

      filesleft = (((double) (ntask / 2)) / ntask) * nfiles;
      <span class="keywordflow">if</span>(filesleft &lt;= 0)
        filesleft = 1;
      <span class="keywordflow">if</span>(filesleft &gt;= nfiles)
        filesleft = nfiles - 1;

      filesright = nfiles - filesleft;

      tasksleft = ntask / 2;
      tasksright = ntask - tasksleft;

      <a class="code" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab">distribute_file</a>(filesleft, firstfile, firsttask, firsttask + tasksleft - 1, filenr, master, <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>);
      <a class="code" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab">distribute_file</a>(filesright, firstfile + filesleft, firsttask + tasksleft, lasttask, filenr, master,
                      <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>);
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &gt;= firsttask &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &lt;= lasttask)
        {
          *filenr = firstfile;
          *master = firsttask;
          *<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> = lasttask;
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_abf75a70e8719e8ed6de565a6ae90f1ab_cgraph.png" border="0" usemap="#proto_8h_abf75a70e8719e8ed6de565a6ae90f1ab_cgraph" alt=""/></div>
<map name="proto_8h_abf75a70e8719e8ed6de565a6ae90f1ab_cgraph" id="proto_8h_abf75a70e8719e8ed6de565a6ae90f1ab_cgraph">
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_abf75a70e8719e8ed6de565a6ae90f1ab_icgraph.png" border="0" usemap="#proto_8h_abf75a70e8719e8ed6de565a6ae90f1ab_icgraph" alt=""/></div>
<map name="proto_8h_abf75a70e8719e8ed6de565a6ae90f1ab_icgraph" id="proto_8h_abf75a70e8719e8ed6de565a6ae90f1ab_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#abf75a70e8719e8ed6de565a6ae90f1ab" title="distribute_file" alt="" coords="160,57,267,87"/><area shape="rect" id="node6" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="336,5,403,35"/><area shape="rect" id="node14" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="315,85,424,115"/><area shape="rect" id="node8" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="561,5,601,35"/><area shape="rect" id="node10" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="739,5,805,35"/><area shape="rect" id="node12" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="855,32,908,61"/><area shape="rect" id="node16" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="472,59,691,88"/><area shape="rect" id="node18" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="751,59,793,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac5e72d197cde6d71017e89db9b986b85"></a><!-- doxytag: member="proto.h::dmax" ref="ac5e72d197cde6d71017e89db9b986b85" args="(double, double)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double dmax </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>y</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>returns the maximum of two double </p>

<p>Definition at line <a class="el" href="system_8c_source.html#l00091">91</a> of file <a class="el" href="system_8c_source.html">system.c</a>.</p>

<p>Referenced by <a class="el" href="density_8c_source.html#l00056">density()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, <a class="el" href="domain_8c_source.html#l00447">domain_shiftSplit()</a>, <a class="el" href="io_8c_source.html#l00129">fill_write_buffer()</a>, <a class="el" href="forcetree_8c_source.html#l02909">force_treeevaluate_direct()</a>, and <a class="el" href="read__ic_8c_source.html#l00031">read_ic()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(x &gt; y)
    <span class="keywordflow">return</span> x;
  <span class="keywordflow">else</span>
    <span class="keywordflow">return</span> y;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ac5e72d197cde6d71017e89db9b986b85_icgraph.png" border="0" usemap="#proto_8h_ac5e72d197cde6d71017e89db9b986b85_icgraph" alt=""/></div>
<map name="proto_8h_ac5e72d197cde6d71017e89db9b986b85_icgraph" id="proto_8h_ac5e72d197cde6d71017e89db9b986b85_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="389,185,456,214"/><area shape="rect" id="node18" href="proto_8h.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="141,134,269,164"/><area shape="rect" id="node30" href="proto_8h.html#a89c54187117b91d4270a4f0c406ce2ba" title="domain_shiftSplit" alt="" coords="140,57,271,86"/><area shape="rect" id="node33" href="proto_8h.html#aea8fa222a10c4796687c6ff25550cd74" title="fill_write_buffer" alt="" coords="148,238,263,268"/><area shape="rect" id="node41" href="proto_8h.html#a0ec221b2517893874b12dc366bfe0da8" title="force_treeevaluate_direct" alt="" coords="113,292,297,321"/><area shape="rect" id="node46" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="389,9,456,38"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="552,289,723,318"/><area shape="rect" id="node11" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="548,81,727,110"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1055,185,1097,214"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1159,146,1212,176"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="865,81,905,110"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1043,106,1109,136"/><area shape="rect" id="node20" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="347,132,499,161"/><area shape="rect" id="node22" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="551,134,724,164"/><area shape="rect" id="node24" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="776,185,995,214"/><area shape="rect" id="node35" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="384,238,461,268"/><area shape="rect" id="node37" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="583,236,692,265"/><area shape="rect" id="node43" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="359,292,487,321"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a128779c23a7c6e9cca2374c5e7c91483"></a><!-- doxytag: member="proto.h::dmin" ref="a128779c23a7c6e9cca2374c5e7c91483" args="(double, double)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double dmin </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>y</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>returns the minimum of two double </p>

<p>Definition at line <a class="el" href="system_8c_source.html#l00101">101</a> of file <a class="el" href="system_8c_source.html">system.c</a>.</p>

<p>Referenced by <a class="el" href="hydra_8c_source.html#l00353">hydro_evaluate()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(x &lt; y)
    <span class="keywordflow">return</span> x;
  <span class="keywordflow">else</span>
    <span class="keywordflow">return</span> y;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a128779c23a7c6e9cca2374c5e7c91483_icgraph.png" border="0" usemap="#proto_8h_a128779c23a7c6e9cca2374c5e7c91483_icgraph" alt=""/></div>
<map name="proto_8h_a128779c23a7c6e9cca2374c5e7c91483_icgraph" id="proto_8h_a128779c23a7c6e9cca2374c5e7c91483_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a818695254c9525e01bc9ddc95e8eaf7e" title="hydro_evaluate" alt="" coords="109,5,229,35"/><area shape="rect" id="node5" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="279,5,375,35"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="424,5,595,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="643,5,685,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="735,5,788,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="adda9e167a16a53d1aa40180406950446"></a><!-- doxytag: member="proto.h::do_box_wrapping" ref="adda9e167a16a53d1aa40180406950446" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void do_box_wrapping </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function makes sure that all particle coordinates (Pos) are periodically mapped onto the interval [0, BoxSize]. After this function has been called, a new domain decomposition should be done, which will also force a new tree construction. </p>

<p>Definition at line <a class="el" href="predict_8c_source.html#l00103">103</a> of file <a class="el" href="predict_8c_source.html">predict.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j;
  <span class="keywordtype">double</span> boxsize[3];

  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    boxsize[j] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;

#ifdef LONG_X
  boxsize[0] *= LONG_X;
#endif
#ifdef LONG_Y
  boxsize[1] *= LONG_Y;
#endif
#ifdef LONG_Z
  boxsize[2] *= LONG_Z;
#endif

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
      {
        <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[j] &lt; 0)
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j] += boxsize[j];

        <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[j] &gt;= boxsize[j])
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j] -= boxsize[j];
      }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_adda9e167a16a53d1aa40180406950446_icgraph.png" border="0" usemap="#proto_8h_adda9e167a16a53d1aa40180406950446_icgraph" alt=""/></div>
<map name="proto_8h_adda9e167a16a53d1aa40180406950446_icgraph" id="proto_8h_adda9e167a16a53d1aa40180406950446_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="187,57,360,87"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="408,5,627,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="687,56,729,85"/><area shape="rect" id="node11" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="497,109,537,139"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="791,83,844,112"/><area shape="rect" id="node13" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="675,109,741,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5b596de46669fab5e125f163d44edc37"></a><!-- doxytag: member="proto.h::domain_compare_key" ref="a5b596de46669fab5e125f163d44edc37" args="(const void *a, const void *b)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int domain_compare_key </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>b</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This is a comparison kernel used in a sort routine. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l01119">1119</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(*(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) a &lt; *(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) b)
    <span class="keywordflow">return</span> -1;

  <span class="keywordflow">if</span>(*(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) a &gt; *(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> *) b)
    <span class="keywordflow">return</span> +1;

  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a5b596de46669fab5e125f163d44edc37_icgraph.png" border="0" usemap="#proto_8h_a5b596de46669fab5e125f163d44edc37_icgraph" alt=""/></div>
<map name="proto_8h_a5b596de46669fab5e125f163d44edc37_icgraph" id="proto_8h_a5b596de46669fab5e125f163d44edc37_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="216,57,408,87"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="456,57,608,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="656,57,829,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="877,5,1096,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1156,56,1199,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="967,109,1007,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1260,83,1313,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1144,109,1211,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a381621bc90438c5a50826bfdac8e4700"></a><!-- doxytag: member="proto.h::domain_compare_toplist" ref="a381621bc90438c5a50826bfdac8e4700" args="(const void *a, const void *b)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int domain_compare_toplist </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>b</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This is a comparison kernel used in a sort routine. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l01106">1106</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="domain_8c_source.html#l00049">topnode_exchange::Startkey</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a> *) a)-&gt;Startkey &lt; (((<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a> *) b)-&gt;Startkey))
    <span class="keywordflow">return</span> -1;

  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a> *) a)-&gt;Startkey &gt; (((<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a> *) b)-&gt;Startkey))
    <span class="keywordflow">return</span> +1;

  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a381621bc90438c5a50826bfdac8e4700_icgraph.png" border="0" usemap="#proto_8h_a381621bc90438c5a50826bfdac8e4700_icgraph" alt=""/></div>
<map name="proto_8h_a381621bc90438c5a50826bfdac8e4700_icgraph" id="proto_8h_a381621bc90438c5a50826bfdac8e4700_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="235,57,427,87"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="475,57,627,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="675,57,848,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="896,5,1115,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1175,56,1217,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="985,109,1025,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1279,83,1332,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1163,109,1229,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a77c115c3aa2069d0eb8521329be0483c"></a><!-- doxytag: member="proto.h::domain_countToGo" ref="a77c115c3aa2069d0eb8521329be0483c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_countToGo </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function determines how many particles that are currently stored on the local CPU have to be moved off according to the domain decomposition. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00729">729</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="domain_8c_source.html#l00038">local_toGo</a>, <a class="el" href="domain_8c_source.html#l00038">local_toGoSph</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="domain_8c_source.html#l00037">toGo</a>, <a class="el" href="domain_8c_source.html#l00037">toGoSph</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> n, no;

  <span class="keywordflow">for</span>(n = 0; n &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; n++)
    {
      <a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a>[n] = 0;
      <a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a>[n] = 0;
    }

  <span class="keywordflow">for</span>(n = 0; n &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; n++)
    {
      no = 0;

      <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter &gt;= 0)
        no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + (<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] - <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Size / 8);

      no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a>;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no] != <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
        {
          <a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no]] += 1;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type == 0)
            <a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a>[DomainTask[no]] += 1;
        }
    }

  MPI_Allgather(<a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a>, NTask, MPI_INT, <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>, NTask, MPI_INT, MPI_COMM_WORLD);
  MPI_Allgather(<a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a>, NTask, MPI_INT, <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>, NTask, MPI_INT, MPI_COMM_WORLD);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a77c115c3aa2069d0eb8521329be0483c_icgraph.png" border="0" usemap="#proto_8h_a77c115c3aa2069d0eb8521329be0483c_icgraph" alt=""/></div>
<map name="proto_8h_a77c115c3aa2069d0eb8521329be0483c_icgraph" id="proto_8h_a77c115c3aa2069d0eb8521329be0483c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="200,57,352,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="400,57,573,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="621,5,840,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="900,56,943,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="711,109,751,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1004,83,1057,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="888,109,955,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a647e0c1a76b7f064ed5d201662f364bf"></a><!-- doxytag: member="proto.h::domain_decompose" ref="a647e0c1a76b7f064ed5d201662f364bf" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_decompose </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function carries out the actual domain decomposition for all particle types. It will try to balance the work-load for each domain, as estimated based on the P[i]-GravCost values. The decomposition will respect the maximum allowed memory-imbalance given by the value of PartAllocFactor. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00154">154</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="domain_8c_source.html#l00729">domain_countToGo()</a>, <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>, <a class="el" href="domain_8c_source.html#l00595">domain_exchangeParticles()</a>, <a class="el" href="domain_8c_source.html#l00534">domain_findExchangeNumbers()</a>, <a class="el" href="domain_8c_source.html#l00845">domain_findExtent()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, <a class="el" href="domain_8c_source.html#l00447">domain_shiftSplit()</a>, <a class="el" href="domain_8c_source.html#l00786">domain_sumCost()</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="domain_8c_source.html#l00041">list_load</a>, <a class="el" href="domain_8c_source.html#l00040">list_N_gas</a>, <a class="el" href="domain_8c_source.html#l00039">list_NumPart</a>, <a class="el" href="domain_8c_source.html#l00043">list_work</a>, <a class="el" href="domain_8c_source.html#l00045">maxload</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, <a class="el" href="allvars_8c_source.html#l00021">Ntype</a>, <a class="el" href="allvars_8c_source.html#l00022">NtypeLocal</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="allvars_8h_source.html#l00477">global_data_all_processes::SofteningTable</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="domain_8c_source.html#l00037">toGo</a>, <a class="el" href="domain_8c_source.html#l00037">toGoSph</a>, and <a class="el" href="allvars_8h_source.html#l00273">global_data_all_processes::TotN_gas</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, status;
  <span class="keywordtype">int</span> ngrp, task, partner, sendcount, recvcount;
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> sumtogo, sumload;
  <span class="keywordtype">int</span> <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a>, *temp;
  <span class="keywordtype">double</span> sumwork, maxwork;

  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    <a class="code" href="allvars_8c.html#a7e6cdb6eab38cb043edcf56a4518dfca">NtypeLocal</a>[i] = 0;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <a class="code" href="allvars_8c.html#a7e6cdb6eab38cb043edcf56a4518dfca">NtypeLocal</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type]++;

  <span class="comment">/* because Ntype[] is of type `long long&#39;, we cannot do a simple</span>
<span class="comment">   * MPI_Allreduce() to sum the total particle numbers </span>
<span class="comment">   */</span>
  temp = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * 6 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  MPI_Allgather(<a class="code" href="allvars_8c.html#a7e6cdb6eab38cb043edcf56a4518dfca">NtypeLocal</a>, 6, MPI_INT, temp, 6, MPI_INT, MPI_COMM_WORLD);
  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    {
      <a class="code" href="allvars_8c.html#a697577a2a59bfa869161211cb134a6ae">Ntype</a>[i] = 0;
      <span class="keywordflow">for</span>(j = 0; j &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; j++)
        <a class="code" href="allvars_8c.html#a697577a2a59bfa869161211cb134a6ae">Ntype</a>[i] += temp[j * 6 + i];
    }
  free(temp);

<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a697577a2a59bfa869161211cb134a6ae">Ntype</a>[i] &gt; 0)
      <span class="keywordflow">break</span>;

  <span class="keywordflow">for</span>(ngrp = i + 1; ngrp &lt; 6; ngrp++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a697577a2a59bfa869161211cb134a6ae">Ntype</a>[ngrp] &gt; 0)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[ngrp] != <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[i])
          {
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
              {
                fprintf(stdout, <span class="stringliteral">&quot;Code was not compiled with UNEQUALSOFTENINGS, but some of the\n&quot;</span>);
                fprintf(stdout, <span class="stringliteral">&quot;softening lengths are unequal nevertheless.\n&quot;</span>);
                fprintf(stdout, <span class="stringliteral">&quot;This is not allowed.\n&quot;</span>);
              }
            <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
          }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="comment">/* determine global dimensions of domain grid */</span>
  <a class="code" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e">domain_findExtent</a>();

  <a class="code" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729">domain_determineTopTree</a>();

  <span class="comment">/* determine cost distribution in domain grid */</span>
  <a class="code" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e">domain_sumCost</a>();

  <span class="comment">/* find the split of the domain grid recursively */</span>
  status = <a class="code" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit</a>(0, <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>, 0, <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a> - 1);
  <span class="keywordflow">if</span>(status != 0)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nNo domain decomposition that stays within memory bounds is possible.\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

  <span class="comment">/* now try to improve the work-load balance of the split */</span>
  <a class="code" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba">domain_shiftSplit</a>();

  <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a> = <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>];
  <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a> = <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>];

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      sumload = maxload = 0;
      sumwork = maxwork = 0;
      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
        {
          sumload += <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[i];
          sumwork += <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[i];

          <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[i] &gt; maxload)
            maxload = <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[i];

          <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[i] &gt; maxwork)
            maxwork = <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[i];
        }

      printf(<span class="stringliteral">&quot;work-load balance=%g   memory-balance=%g\n&quot;</span>,
             maxwork / (sumwork / NTask), maxload / (((<span class="keywordtype">double</span>) sumload) / NTask));
    }


  <span class="comment">/* determine for each cpu how many particles have to be shifted to other cpus */</span>
  <a class="code" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c">domain_countToGo</a>();

  <span class="keywordflow">for</span>(i = 0, sumtogo = 0; i &lt; NTask * NTask; i++)
    sumtogo += <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[i];

  <span class="keywordflow">while</span>(sumtogo &gt; 0)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;exchange of %d%09d particles\n&quot;</span>, (<span class="keywordtype">int</span>) (sumtogo / 1000000000),
                 (<span class="keywordtype">int</span>) (sumtogo % 1000000000));
          fflush(stdout);
        }

      <span class="keywordflow">for</span>(ngrp = 1; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
        {
          <span class="keywordflow">for</span>(task = 0; task &lt; NTask; task++)
            {
              partner = task ^ ngrp;

              <span class="keywordflow">if</span>(partner &lt; NTask &amp;&amp; task &lt; partner)
                {
                  <span class="comment">/* treat SPH separately */</span>
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2bb70816a4d5f56e0df2d9b8d706cef2">TotN_gas</a> &gt; 0)
                    {
                      <a class="code" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9">domain_findExchangeNumbers</a>(task, partner, 1, &amp;sendcount, &amp;recvcount);

                      <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[task] += recvcount - sendcount;
                      <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[partner] -= recvcount - sendcount;
                      <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>[task] += recvcount - sendcount;
                      <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>[partner] -= recvcount - sendcount;

                      <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[task * NTask + partner] -= sendcount;
                      <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[partner * NTask + task] -= recvcount;
                      <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[task * NTask + partner] -= sendcount;
                      <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[partner * NTask + task] -= recvcount;

                      <span class="keywordflow">if</span>(task == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)      <span class="comment">/* actually carry out the exchange */</span>
                        <a class="code" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a>(partner, 1, sendcount, recvcount);
                      <span class="keywordflow">if</span>(partner == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                        <a class="code" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a>(task, 1, recvcount, sendcount);
                    }

                  <a class="code" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9">domain_findExchangeNumbers</a>(task, partner, 0, &amp;sendcount, &amp;recvcount);

                  <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[task] += recvcount - sendcount;
                  <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[partner] -= recvcount - sendcount;

                  <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[task * NTask + partner] -= sendcount;
                  <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[partner * NTask + task] -= recvcount;

                  <span class="keywordflow">if</span>(task == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)  <span class="comment">/* actually carry out the exchange */</span>
                    <a class="code" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a>(partner, 0, sendcount, recvcount);
                  <span class="keywordflow">if</span>(partner == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                    <a class="code" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca">domain_exchangeParticles</a>(task, 0, recvcount, sendcount);
                }
            }
        }

      <span class="keywordflow">for</span>(i = 0, sumtogo = 0; i &lt; NTask * NTask; i++)
        sumtogo += <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[i];
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a647e0c1a76b7f064ed5d201662f364bf_cgraph.png" border="0" usemap="#proto_8h_a647e0c1a76b7f064ed5d201662f364bf_cgraph" alt=""/></div>
<map name="proto_8h_a647e0c1a76b7f064ed5d201662f364bf_cgraph" id="proto_8h_a647e0c1a76b7f064ed5d201662f364bf_cgraph">
<area shape="rect" id="node3" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c" title="domain_countToGo" alt="" coords="244,160,388,189"/><area shape="rect" id="node5" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="220,213,412,243"/><area shape="rect" id="node14" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="704,267,771,296"/><area shape="rect" id="node24" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca" title="domain_exchangeParticles" alt="" coords="220,371,412,400"/><area shape="rect" id="node27" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9" title="domain_findExchangeNumbers" alt="" coords="205,424,427,453"/><area shape="rect" id="node31" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e" title="domain_findExtent" alt="" coords="245,477,387,507"/><area shape="rect" id="node33" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="252,555,380,584"/><area shape="rect" id="node38" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba" title="domain_shiftSplit" alt="" coords="251,608,381,637"/><area shape="rect" id="node41" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e" title="domain_sumCost" alt="" coords="249,661,383,691"/><area shape="rect" id="node7" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37" title="domain_compare_key" alt="" coords="484,5,647,35"/><area shape="rect" id="node9" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700" title="domain_compare_toplist" alt="" coords="476,59,655,88"/><area shape="rect" id="node11" href="domain_8c.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="504,136,627,165"/><area shape="rect" id="node18" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="485,213,645,243"/><area shape="rect" id="node22" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="496,267,635,296"/><area shape="rect" id="node16" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="819,267,976,296"/><area shape="rect" id="node29" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644" title="imin" alt="" coords="541,424,589,453"/><area shape="rect" id="node35" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="536,581,595,611"/><area shape="rect" id="node43" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4" title="domain_walktoptree" alt="" coords="491,661,640,691"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a647e0c1a76b7f064ed5d201662f364bf_icgraph.png" border="0" usemap="#proto_8h_a647e0c1a76b7f064ed5d201662f364bf_icgraph" alt=""/></div>
<map name="proto_8h_a647e0c1a76b7f064ed5d201662f364bf_icgraph" id="proto_8h_a647e0c1a76b7f064ed5d201662f364bf_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="205,57,379,87"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="427,5,645,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="705,56,748,85"/><area shape="rect" id="node11" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="516,109,556,139"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="809,83,863,112"/><area shape="rect" id="node13" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="693,109,760,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae8e3aa408eaab9544cb7f93e69185492"></a><!-- doxytag: member="proto.h::domain_Decomposition" ref="ae8e3aa408eaab9544cb7f93e69185492" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_Decomposition </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This is the main routine for the domain decomposition. It acts as a driver routine that allocates various temporary buffers, maps the particles back onto the periodic box if needed, and then does the domain decomposition, and a final Peano-Hilbert order of all particles as a tuning measure. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00062">62</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00410">global_data_all_processes::CPU_Domain</a>, <a class="el" href="allvars_8h_source.html#l00423">global_data_all_processes::CPU_Peano</a>, <a class="el" href="predict_8c_source.html#l00103">do_box_wrapping()</a>, <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8c_source.html#l00071">KeySorted</a>, <a class="el" href="domain_8c_source.html#l00041">list_load</a>, <a class="el" href="domain_8c_source.html#l00042">list_loadsph</a>, <a class="el" href="domain_8c_source.html#l00040">list_N_gas</a>, <a class="el" href="domain_8c_source.html#l00039">list_NumPart</a>, <a class="el" href="domain_8c_source.html#l00043">list_work</a>, <a class="el" href="domain_8c_source.html#l00038">local_toGo</a>, <a class="el" href="domain_8c_source.html#l00038">local_toGoSph</a>, <a class="el" href="domain_8c_source.html#l00045">maxload</a>, <a class="el" href="domain_8c_source.html#l00045">maxloadsph</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00276">global_data_all_processes::MaxPartSph</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="peano_8c_source.html#l00034">peano_hilbert_order()</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="domain_8c_source.html#l00037">toGo</a>, <a class="el" href="domain_8c_source.html#l00037">toGoSph</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, and <a class="el" href="allvars_8c_source.html#l00038">TreeReconstructFlag</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>, <a class="el" href="init_8c_source.html#l00020">init()</a>, and <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> t0, t1;

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;
      <span class="comment">/* to make sure that we do a domain decomposition before the PM-force is evaluated.</span>
<span class="comment">         this is needed to make sure that the particles are wrapped into the box */</span>
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">/* Check whether it is really time for a new domain decomposition */</span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>)
    {
      t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      <a class="code" href="predict_8c.html#adda9e167a16a53d1aa40180406950446">do_box_wrapping</a>();        <span class="comment">/* map the particles back onto the box */</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 0;
      <a class="code" href="allvars_8c.html#aa32d7269f9baf3ffdbdd509982fca128">TreeReconstructFlag</a> = 1;  <span class="comment">/* ensures that new tree will be constructed */</span>

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;domain decomposition... \n&quot;</span>);
          fflush(stdout);
        }

      <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a> = malloc(<span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>);
      <a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a> = malloc(<span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>);

      <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);

      MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>, 1, MPI_INT, <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>, 1, MPI_INT, MPI_COMM_WORLD);
      MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>, 1, MPI_INT, <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>, 1, MPI_INT, MPI_COMM_WORLD);

      <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> * REDUC_FAC;
      <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> * REDUC_FAC;

      <a class="code" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf">domain_decompose</a>();

      free(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>);
      free(<a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>);
      free(<a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>);
      free(<a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>);
      free(<a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>);
      free(<a class="code" href="domain_8c.html#a119a354c6c46ee11fdb9c7ad131b787a">local_toGoSph</a>);
      free(<a class="code" href="domain_8c.html#a394783c89866b4e48255038384f9539b">local_toGo</a>);
      free(<a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>);
      free(<a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>);


      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;domain decomposition done. \n&quot;</span>);
          fflush(stdout);
        }

      t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a786736d9e91341733e286f6e03ab26a5">CPU_Domain</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);

<span class="preprocessor">#ifdef PEANOHILBERT</span>
<span class="preprocessor"></span>      t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="peano_8c.html#af3e45a4293584b3fe28e83af75c6ed71">peano_hilbert_order</a>();
      t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3d1492ec738b3ebf2025de1d2f398b7d">CPU_Peano</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      free(<a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a>);
      free(<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>);
    }

}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ae8e3aa408eaab9544cb7f93e69185492_cgraph.png" border="0" usemap="#proto_8h_ae8e3aa408eaab9544cb7f93e69185492_cgraph" alt=""/></div>
<map name="proto_8h_ae8e3aa408eaab9544cb7f93e69185492_cgraph" id="proto_8h_ae8e3aa408eaab9544cb7f93e69185492_cgraph">
<area shape="rect" id="node3" href="predict_8c.html#adda9e167a16a53d1aa40180406950446" title="do_box_wrapping" alt="" coords="237,421,368,451"/><area shape="rect" id="node5" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="227,475,379,504"/><area shape="rect" id="node50" href="peano_8c.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="228,725,377,755"/><area shape="rect" id="node58" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="269,779,336,808"/><area shape="rect" id="node60" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="268,859,337,888"/><area shape="rect" id="node7" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c" title="domain_countToGo" alt="" coords="465,160,609,189"/><area shape="rect" id="node9" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="441,213,633,243"/><area shape="rect" id="node18" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="939,267,1005,296"/><area shape="rect" id="node28" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca" title="domain_exchangeParticles" alt="" coords="697,371,889,400"/><area shape="rect" id="node31" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9" title="domain_findExchangeNumbers" alt="" coords="427,421,648,451"/><area shape="rect" id="node35" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e" title="domain_findExtent" alt="" coords="467,475,608,504"/><area shape="rect" id="node37" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="473,552,601,581"/><area shape="rect" id="node42" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba" title="domain_shiftSplit" alt="" coords="472,605,603,635"/><area shape="rect" id="node45" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e" title="domain_sumCost" alt="" coords="471,659,604,688"/><area shape="rect" id="node11" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37" title="domain_compare_key" alt="" coords="712,5,875,35"/><area shape="rect" id="node13" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700" title="domain_compare_toplist" alt="" coords="704,59,883,88"/><area shape="rect" id="node15" href="domain_8c.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="732,136,855,165"/><area shape="rect" id="node22" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="713,213,873,243"/><area shape="rect" id="node26" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="724,267,863,296"/><area shape="rect" id="node20" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1053,267,1211,296"/><area shape="rect" id="node33" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644" title="imin" alt="" coords="769,424,817,453"/><area shape="rect" id="node39" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="764,579,823,608"/><area shape="rect" id="node47" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4" title="domain_walktoptree" alt="" coords="719,659,868,688"/><area shape="rect" id="node52" href="peano_8c.html#af3ffb253e14a79419d1effeee1b7261d" title="compare_key" alt="" coords="484,712,591,741"/><area shape="rect" id="node54" href="peano_8c.html#af744cef873e3093ba2924da8265d1711" title="reorder_gas" alt="" coords="488,765,587,795"/><area shape="rect" id="node56" href="peano_8c.html#afcb358154dd7fd5de8b4156f417fb0ba" title="reorder_particles" alt="" coords="472,819,603,848"/><area shape="rect" id="node62" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="515,872,560,901"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ae8e3aa408eaab9544cb7f93e69185492_icgraph.png" border="0" usemap="#proto_8h_ae8e3aa408eaab9544cb7f93e69185492_icgraph" alt=""/></div>
<map name="proto_8h_ae8e3aa408eaab9544cb7f93e69185492_icgraph" id="proto_8h_ae8e3aa408eaab9544cb7f93e69185492_icgraph">
<area shape="rect" id="node3" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="227,5,445,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="505,56,548,85"/><area shape="rect" id="node9" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="316,109,356,139"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="609,83,663,112"/><area shape="rect" id="node11" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="493,109,560,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a25b4f5eb395f918bad4b4bc1fc3dc729"></a><!-- doxytag: member="proto.h::domain_determineTopTree" ref="a25b4f5eb395f918bad4b4bc1fc3dc729" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_determineTopTree </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function constructs the global top-level tree node that is used for the domain decomposition. This is done by considering the string of Peano-Hilbert keys for all particles, which is recursively chopped off in pieces of eight segments until each segment holds at most a certain number of particles. </p>

<p><p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 int, the allowed maximum is 10. If 64-bit integers are used, the maximum is 21</p>
<p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 0 , the allowed maximum is 10. If 64-bit integers are used, the maximum is 21</p>
<p>&lt; The number of different Peano-Hilbert cells</p>
<p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 0 , the allowed maximum is 10. If 64-bit integers are used, the maximum is 21</p>
<p>&lt; The number of different Peano-Hilbert cells </p>
</p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00896">896</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00050">BITS_PER_DIMENSION</a>, <a class="el" href="allvars_8h_source.html#l00224">topnode_data::Blocks</a>, <a class="el" href="domain_8c_source.html#l00050">topnode_exchange::Count</a>, <a class="el" href="allvars_8h_source.html#l00228">topnode_data::Count</a>, <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="domain_8c_source.html#l01119">domain_compare_key()</a>, <a class="el" href="domain_8c_source.html#l01106">domain_compare_toplist()</a>, <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>, <a class="el" href="domain_8c_source.html#l00982">domain_topsplit_local()</a>, <a class="el" href="allvars_8c_source.html#l00048">DomainCorner</a>, <a class="el" href="allvars_8c_source.html#l00051">DomainFac</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8c_source.html#l00071">KeySorted</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00074">NTopnodes</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="peano_8c_source.html#l00263">peano_hilbert_key()</a>, <a class="el" href="allvars_8h_source.html#l00223">topnode_data::Pstart</a>, <a class="el" href="allvars_8h_source.html#l00226">topnode_data::Size</a>, <a class="el" href="domain_8c_source.html#l00049">topnode_exchange::Startkey</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>, <a class="el" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>, <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>, and <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, ntop_local, ntop;
  <span class="keywordtype">int</span> *ntopnodelist, *ntopoffset;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a>[i] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[i] = <a class="code" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df">peano_hilbert_key</a>((<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[0]) * <a class="code" href="allvars_8c.html#a4488078cfcc203156f193c43a1d3a2ef">DomainFac</a>,
                                                (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[1] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[1]) * DomainFac,
                                                (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[2] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[2]) * DomainFac,
                                                <a class="code" href="allvars_8h.html#a84bc981fa6ccfbb15526a6e9da12087a">BITS_PER_DIMENSION</a>);
    }

  qsort(<a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a>, NumPart, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>), <a class="code" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37">domain_compare_key</a>);

  <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> = 1;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = -1;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> = PEANOCELLS;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a> = 0;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> = NumPart;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = 0;

  <a class="code" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421">domain_topsplit_local</a>(0, 0);

  <a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a> = malloc(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a>));

  <span class="keywordflow">for</span>(i = 0, ntop_local = 0; i &lt; <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[i].Daughter == -1)    <span class="comment">/* only use leaves */</span>
        {
          <a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>[ntop_local].<a class="code" href="structtopnode__exchange.html#a1320a6ec4ba632909af0c092bd7735b4">Startkey</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[i].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>;
          <a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>[ntop_local].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[i].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a>;
          ntop_local++;
        }
    }

  ntopnodelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  ntopoffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);

  MPI_Allgather(&amp;ntop_local, 1, MPI_INT, ntopnodelist, 1, MPI_INT, MPI_COMM_WORLD);

  <span class="keywordflow">for</span>(i = 0, ntop = 0, ntopoffset[0] = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
    {
      ntop += ntopnodelist[i];
      <span class="keywordflow">if</span>(i &gt; 0)
        ntopoffset[i] = ntopoffset[i - 1] + ntopnodelist[i - 1];
    }


  <a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a> = malloc(ntop * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a>));

  <span class="keywordflow">for</span>(i = 0; i &lt; NTask; i++)
    {
      ntopnodelist[i] *= <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structtopnode__exchange.html">topnode_exchange</a>);
      ntopoffset[i] *= <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structtopnode__exchange.html">topnode_exchange</a>);
    }

  MPI_Allgatherv(<a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>, ntop_local * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a>), MPI_BYTE,
                 <a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>, ntopnodelist, ntopoffset, MPI_BYTE, MPI_COMM_WORLD);

  qsort(<a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>, ntop, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__exchange.html">topnode_exchange</a>), <a class="code" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700">domain_compare_toplist</a>);

  NTopnodes = 1;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = -1;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> = PEANOCELLS;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a> = 0;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a>;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = 0;
  <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#abad41cd99537e7a3a0d78ac5f291e42d">Blocks</a> = ntop;

  <a class="code" href="domain_8c.html#a606de536756a67ad8f79f1135009195e">domain_topsplit</a>(0, 0);

  free(<a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>);
  free(ntopoffset);
  free(ntopnodelist);
  free(<a class="code" href="domain_8c.html#a62244375ee3d9bdb3f7428a58de42085">toplist_local</a>);

}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a25b4f5eb395f918bad4b4bc1fc3dc729_cgraph.png" border="0" usemap="#proto_8h_a25b4f5eb395f918bad4b4bc1fc3dc729_cgraph" alt=""/></div>
<map name="proto_8h_a25b4f5eb395f918bad4b4bc1fc3dc729_cgraph" id="proto_8h_a25b4f5eb395f918bad4b4bc1fc3dc729_cgraph">
<area shape="rect" id="node3" href="domain_8c.html#a5b596de46669fab5e125f163d44edc37" title="domain_compare_key" alt="" coords="255,5,417,35"/><area shape="rect" id="node5" href="domain_8c.html#a381621bc90438c5a50826bfdac8e4700" title="domain_compare_toplist" alt="" coords="247,59,425,88"/><area shape="rect" id="node7" href="domain_8c.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="275,136,397,165"/><area shape="rect" id="node14" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="256,213,416,243"/><area shape="rect" id="node18" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="267,267,405,296"/><area shape="rect" id="node10" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="475,175,541,204"/><area shape="rect" id="node12" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="589,175,747,204"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a25b4f5eb395f918bad4b4bc1fc3dc729_icgraph.png" border="0" usemap="#proto_8h_a25b4f5eb395f918bad4b4bc1fc3dc729_icgraph" alt=""/></div>
<map name="proto_8h_a25b4f5eb395f918bad4b4bc1fc3dc729_icgraph" id="proto_8h_a25b4f5eb395f918bad4b4bc1fc3dc729_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="245,57,397,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="445,57,619,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="667,5,885,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="945,56,988,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="756,109,796,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1049,83,1103,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="933,109,1000,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab7d41435f73c1626208d63b2d5ba28ca"></a><!-- doxytag: member="proto.h::domain_exchangeParticles" ref="ab7d41435f73c1626208d63b2d5ba28ca" args="(int partner, int sphflag, int send_count, int recv_count)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_exchangeParticles </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>partner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sphflag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>send_count</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>recv_count</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function exchanges particles between two CPUs according to the domain split. In doing this, the memory boundaries which may restrict the exhange process are observed. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00595">595</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="allvars_8c_source.html#l00068">DomainKeyBuf</a>, <a class="el" href="allvars_8c_source.html#l00120">DomainPartBuf</a>, <a class="el" href="allvars_8c_source.html#l00128">DomainSphBuf</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="tags_8h_source.html#l00009">TAG_KEY</a>, <a class="el" href="tags_8h_source.html#l00007">TAG_PDATA</a>, <a class="el" href="tags_8h_source.html#l00008">TAG_SPHDATA</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no, n, count, rep;
  MPI_Status status;

  <span class="keywordflow">for</span>(n = 0, count = 0; count &lt; send_count &amp;&amp; n &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; n++)
    {
      <span class="keywordflow">if</span>(sphflag)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type != 0)
            <span class="keywordflow">continue</span>;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type == 0)
            <span class="keywordflow">continue</span>;
        }

      no = 0;

      <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter &gt;= 0)
        no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + (<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] - <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Size / 8);

      no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a>;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no] == partner)
        {
          <span class="keywordflow">if</span>(sphflag)           <span class="comment">/* special reorder routine for SPH particles (need to stay at beginning) */</span>
            {
              <a class="code" href="allvars_8c.html#a386309bed4018948d42bc72ae4b5e1bb">DomainPartBuf</a>[count] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n];      <span class="comment">/* copy particle and collect in contiguous memory */</span>
              <a class="code" href="allvars_8c.html#a6918a0815266193ad242888c455c5886">DomainKeyBuf</a>[count] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n];
              <a class="code" href="allvars_8c.html#a6034b1d1d1f6fb31d07d2077914aa1fc">DomainSphBuf</a>[count] = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[n];

              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1];
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[NumPart - 1];

              <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1];
              <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[NumPart - 1];

              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[n] = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> - 1];

              <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>--;
            }
          <span class="keywordflow">else</span>
            {
              <a class="code" href="allvars_8c.html#a386309bed4018948d42bc72ae4b5e1bb">DomainPartBuf</a>[count] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n];      <span class="comment">/* copy particle and collect in contiguous memory */</span>
              <a class="code" href="allvars_8c.html#a6918a0815266193ad242888c455c5886">DomainKeyBuf</a>[count] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n];
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[NumPart - 1];
              <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[NumPart - 1];
            }

          count++;
          NumPart--;
          n--;
        }
    }

  <span class="keywordflow">if</span>(count != send_count)
    {
      printf(<span class="stringliteral">&quot;Houston, we got a problem...\n&quot;</span>);
      printf(<span class="stringliteral">&quot;ThisTask=%d count=%d send_count=%d\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, count, send_count);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(88);
    }

  <span class="comment">/* transmit */</span>

  <span class="keywordflow">for</span>(rep = 0; rep &lt; 2; rep++)
    {
      <span class="keywordflow">if</span>((rep == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &lt; partner) || (rep == 1 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &gt; partner))
        {
          <span class="keywordflow">if</span>(send_count &gt; 0)
            {
              MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a386309bed4018948d42bc72ae4b5e1bb">DomainPartBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner,
                        <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>, MPI_COMM_WORLD);

              MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a6918a0815266193ad242888c455c5886">DomainKeyBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a9808b602dc1ad05f05054f288e80099e">TAG_KEY</a>,
                        MPI_COMM_WORLD);

              <span class="keywordflow">if</span>(sphflag)
                MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a6034b1d1d1f6fb31d07d2077914aa1fc">DomainSphBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>), MPI_BYTE, partner,
                          <a class="code" href="tags_8h.html#a01c73f5108d850ffa33220b744576da7">TAG_SPHDATA</a>, MPI_COMM_WORLD);
            }
        }

      <span class="keywordflow">if</span>((rep == 1 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &lt; partner) || (rep == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> &gt; partner))
        {
          <span class="keywordflow">if</span>(recv_count &gt; 0)
            {
              <span class="keywordflow">if</span>(sphflag)
                {
                  <span class="keywordflow">if</span>((NumPart - <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>) &gt; recv_count)
                    {
                      <span class="keywordflow">for</span>(i = 0; i &lt; recv_count; i++)
                        {
                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[NumPart + i] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> + i];
                          <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[NumPart + i] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> + i];
                        }
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">for</span>(i = NumPart - 1; i &gt;= <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i--)
                        {
                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i + recv_count] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i];
                          <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[i + recv_count] = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[i];
                        }
                    }

                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>,
                           MPI_COMM_WORLD, &amp;status);
                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[N_gas], recv_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a9808b602dc1ad05f05054f288e80099e">TAG_KEY</a>,
                           MPI_COMM_WORLD, &amp;status);
                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[N_gas], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>), MPI_BYTE, partner,
                           <a class="code" href="tags_8h.html#a01c73f5108d850ffa33220b744576da7">TAG_SPHDATA</a>, MPI_COMM_WORLD, &amp;status);

                  N_gas += recv_count;
                }
              <span class="keywordflow">else</span>
                {
                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[NumPart], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner,
                           <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>, MPI_COMM_WORLD, &amp;status);
                  MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[NumPart], recv_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>), MPI_BYTE, partner,
                           <a class="code" href="tags_8h.html#a9808b602dc1ad05f05054f288e80099e">TAG_KEY</a>, MPI_COMM_WORLD, &amp;status);
                }

              NumPart += recv_count;
            }
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab7d41435f73c1626208d63b2d5ba28ca_cgraph.png" border="0" usemap="#proto_8h_ab7d41435f73c1626208d63b2d5ba28ca_cgraph" alt=""/></div>
<map name="proto_8h_ab7d41435f73c1626208d63b2d5ba28ca_cgraph" id="proto_8h_ab7d41435f73c1626208d63b2d5ba28ca_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="248,5,315,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="363,5,520,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab7d41435f73c1626208d63b2d5ba28ca_icgraph.png" border="0" usemap="#proto_8h_ab7d41435f73c1626208d63b2d5ba28ca_icgraph" alt=""/></div>
<map name="proto_8h_ab7d41435f73c1626208d63b2d5ba28ca_icgraph" id="proto_8h_ab7d41435f73c1626208d63b2d5ba28ca_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="248,57,400,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="448,57,621,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="669,5,888,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="948,56,991,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="759,109,799,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1052,83,1105,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="936,109,1003,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0e758ec7eef32fc7180092547f5a11b9"></a><!-- doxytag: member="proto.h::domain_findExchangeNumbers" ref="a0e758ec7eef32fc7180092547f5a11b9" args="(int task, int partner, int sphflag, int *send, int *recv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_findExchangeNumbers </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>partner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sphflag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>send</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>recv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function counts how many particles have to be exchanged between two CPUs according to the domain split. If the CPUs are already quite full and hold data from other CPUs as well, not all the particles may be exchanged at once. In this case the communication phase has to be repeated, until enough of the third-party particles have been moved away such that the decomposition can be completed. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00534">534</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00292">global_data_all_processes::BunchSizeDomain</a>, <a class="el" href="system_8c_source.html#l00121">imin()</a>, <a class="el" href="domain_8c_source.html#l00040">list_N_gas</a>, <a class="el" href="domain_8c_source.html#l00039">list_NumPart</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00276">global_data_all_processes::MaxPartSph</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="domain_8c_source.html#l00037">toGo</a>, and <a class="el" href="domain_8c_source.html#l00037">toGoSph</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> numpartA, numpartsphA, ntobesentA, maxsendA, maxsendA_old;
  <span class="keywordtype">int</span> numpartB, numpartsphB, ntobesentB, maxsendB, maxsendB_old;

  numpartA = <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[task];
  numpartsphA = <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>[task];

  numpartB = <a class="code" href="domain_8c.html#a040694ce8b01a0b994df96d39588813a">list_NumPart</a>[partner];
  numpartsphB = <a class="code" href="domain_8c.html#a9819cd512382caee762325ea86f4b221">list_N_gas</a>[partner];

  <span class="keywordflow">if</span>(sphflag == 1)
    {
      ntobesentA = <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[task * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + partner];
      ntobesentB = <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[partner * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + task];
    }
  <span class="keywordflow">else</span>
    {
      ntobesentA = <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[task * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + partner] - <a class="code" href="domain_8c.html#af00bb52ac4aa095d4d6daac54833675f">toGoSph</a>[task * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + partner];
      ntobesentB = <a class="code" href="domain_8c.html#a52aefc67245e1a334c311a420f89130c">toGo</a>[partner * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + task] - toGoSph[partner * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> + task];
    }

  maxsendA = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(ntobesentA, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a>);
  maxsendB = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(ntobesentB, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abf3206e6032910640e91585c25bd85b2">BunchSizeDomain</a>);

  <span class="keywordflow">do</span>
    {
      maxsendA_old = maxsendA;
      maxsendB_old = maxsendB;

      maxsendA = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - numpartB + maxsendB, maxsendA);
      maxsendB = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - numpartA + maxsendA, maxsendB);
    }
  <span class="keywordflow">while</span>((maxsendA != maxsendA_old) || (maxsendB != maxsendB_old));


  <span class="comment">/* now make also sure that there is enough space for SPH particeles */</span>
  <span class="keywordflow">if</span>(sphflag == 1)
    {
      <span class="keywordflow">do</span>
        {
          maxsendA_old = maxsendA;
          maxsendB_old = maxsendB;

          maxsendA = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> - numpartsphB + maxsendB, maxsendA);
          maxsendB = <a class="code" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644">imin</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> - numpartsphA + maxsendA, maxsendB);
        }
      <span class="keywordflow">while</span>((maxsendA != maxsendA_old) || (maxsendB != maxsendB_old));
    }

  *send = maxsendA;
  *recv = maxsendB;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a0e758ec7eef32fc7180092547f5a11b9_cgraph.png" border="0" usemap="#proto_8h_a0e758ec7eef32fc7180092547f5a11b9_cgraph" alt=""/></div>
<map name="proto_8h_a0e758ec7eef32fc7180092547f5a11b9_cgraph" id="proto_8h_a0e758ec7eef32fc7180092547f5a11b9_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#af52841aeeb1b5bf6787e1e2036088644" title="imin" alt="" coords="276,5,324,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a0e758ec7eef32fc7180092547f5a11b9_icgraph.png" border="0" usemap="#proto_8h_a0e758ec7eef32fc7180092547f5a11b9_icgraph" alt=""/></div>
<map name="proto_8h_a0e758ec7eef32fc7180092547f5a11b9_icgraph" id="proto_8h_a0e758ec7eef32fc7180092547f5a11b9_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="275,57,427,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="475,57,648,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="696,5,915,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="975,56,1017,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="785,109,825,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1079,83,1132,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="963,109,1029,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="add5620cbc133c73f0ce7da3a8fe9c01e"></a><!-- doxytag: member="proto.h::domain_findExtent" ref="add5620cbc133c73f0ce7da3a8fe9c01e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_findExtent </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine finds the extent of the global domain grid. </p>

<p><p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 int, the allowed maximum is 10. If 64-bit integers are used, the maximum is 21 </p>
</p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00845">845</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00049">DomainCenter</a>, <a class="el" href="allvars_8c_source.html#l00048">DomainCorner</a>, <a class="el" href="allvars_8c_source.html#l00051">DomainFac</a>, <a class="el" href="allvars_8c_source.html#l00050">DomainLen</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j;
  <span class="keywordtype">double</span> len, xmin[3], xmax[3], xmin_glob[3], xmax_glob[3];

  <span class="comment">/* determine local extension */</span>
  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    {
      xmin[j] = MAX_REAL_NUMBER;
      xmax[j] = -MAX_REAL_NUMBER;
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          <span class="keywordflow">if</span>(xmin[j] &gt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[j])
            xmin[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];

          <span class="keywordflow">if</span>(xmax[j] &lt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[j])
            xmax[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
        }
    }

  MPI_Allreduce(xmin, xmin_glob, 3, MPI_DOUBLE, MPI_MIN, MPI_COMM_WORLD);
  MPI_Allreduce(xmax, xmax_glob, 3, MPI_DOUBLE, MPI_MAX, MPI_COMM_WORLD);

  len = 0;
  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    <span class="keywordflow">if</span>(xmax_glob[j] - xmin_glob[j] &gt; len)
      len = xmax_glob[j] - xmin_glob[j];

  len *= 1.001;

  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    {
      <a class="code" href="allvars_8c.html#ad13aabcbb50307c005ffa0b2edccdaeb">DomainCenter</a>[j] = 0.5 * (xmin_glob[j] + xmax_glob[j]);
      <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[j] = 0.5 * (xmin_glob[j] + xmax_glob[j]) - 0.5 * len;
    }

  <a class="code" href="allvars_8c.html#a3dd9593672bf68f0c36fa3e5451e9265">DomainLen</a> = len;
  <a class="code" href="allvars_8c.html#a4488078cfcc203156f193c43a1d3a2ef">DomainFac</a> = 1.0 / len * (((peanokey) 1) &lt;&lt; (BITS_PER_DIMENSION));
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_add5620cbc133c73f0ce7da3a8fe9c01e_icgraph.png" border="0" usemap="#proto_8h_add5620cbc133c73f0ce7da3a8fe9c01e_icgraph" alt=""/></div>
<map name="proto_8h_add5620cbc133c73f0ce7da3a8fe9c01e_icgraph" id="proto_8h_add5620cbc133c73f0ce7da3a8fe9c01e_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="195,57,347,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="395,57,568,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="616,5,835,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="895,56,937,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="705,109,745,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="999,83,1052,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="883,109,949,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a412d5d8810751249cc8dcd9e219e4e57"></a><!-- doxytag: member="proto.h::domain_findSplit" ref="a412d5d8810751249cc8dcd9e219e4e57" args="(int cpustart, int ncpu, int first, int last)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int domain_findSplit </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cpustart</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ncpu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>first</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>last</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function tries to find a split point in a range of cells in the domain-grid. The range of cells starts at 'first', and ends at 'last' (inclusively). The number of cpus that holds the range is 'ncpu', with the first cpu given by 'cpustart'. If more than 2 cpus are to be split, the function calls itself recursively. The division tries to achieve a best particle-load balance under the constraint that 'maxload' and 'maxloadsph' may not be exceeded, and that each cpu holds at least one cell from the domaingrid. If such a decomposition cannot be achieved, a non-zero error code is returned.</p>
<p>After successful completion, DomainMyStart[] and DomainMyLast[] contain the first and last cell of the domaingrid assigned to the local task for the given type. Also, DomainTask[] contains for each cell the task it was assigned to. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00327">327</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>, <a class="el" href="allvars_8c_source.html#l00057">DomainCount</a>, <a class="el" href="allvars_8c_source.html#l00058">DomainCountSph</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="domain_8c_source.html#l00041">list_load</a>, <a class="el" href="domain_8c_source.html#l00042">list_loadsph</a>, <a class="el" href="domain_8c_source.html#l00045">maxload</a>, and <a class="el" href="domain_8c_source.html#l00045">maxloadsph</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, and <a class="el" href="domain_8c_source.html#l00327">domain_findSplit()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, split, ok_left, ok_right;
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> load, sphload, load_leftOfSplit, sphload_leftOfSplit;
  <span class="keywordtype">int</span> ncpu_leftOfSplit;
  <span class="keywordtype">double</span> maxAvgLoad_CurrentSplit, maxAvgLoad_NewSplit;


  ncpu_leftOfSplit = ncpu / 2;

  <span class="keywordflow">for</span>(i = first, load = 0, sphload = 0; i &lt;= <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>; i++)
    {
      load += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[i];
      sphload += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[i];
    }

  split = first + ncpu_leftOfSplit;

  <span class="keywordflow">for</span>(i = first, load_leftOfSplit = sphload_leftOfSplit = 0; i &lt; split; i++)
    {
      load_leftOfSplit += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[i];
      sphload_leftOfSplit += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[i];
    }

  <span class="comment">/* find the best split point in terms of work-load balance */</span>

  <span class="keywordflow">while</span>(split &lt; <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> - (ncpu - ncpu_leftOfSplit - 1) &amp;&amp; split &gt; 0)
    {
      maxAvgLoad_CurrentSplit =
        <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(load_leftOfSplit / ncpu_leftOfSplit, (load - load_leftOfSplit) / (ncpu - ncpu_leftOfSplit));

      maxAvgLoad_NewSplit =
        <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>((load_leftOfSplit + <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[split]) / ncpu_leftOfSplit,
             (load - load_leftOfSplit - <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[split]) / (ncpu - ncpu_leftOfSplit));

      <span class="keywordflow">if</span>(maxAvgLoad_NewSplit &lt;= maxAvgLoad_CurrentSplit)
        {
          load_leftOfSplit += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[split];
          sphload_leftOfSplit += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[split];
          split++;
        }
      <span class="keywordflow">else</span>
        <span class="keywordflow">break</span>;
    }


  <span class="comment">/* we will now have to check whether this solution is possible given the restrictions on the maximum load */</span>

  <span class="keywordflow">for</span>(i = first, load_leftOfSplit = 0, sphload_leftOfSplit = 0; i &lt; split; i++)
    {
      load_leftOfSplit += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[i];
      sphload_leftOfSplit += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[i];
    }

  <span class="keywordflow">if</span>(load_leftOfSplit &gt; <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a> * ncpu_leftOfSplit ||
     (load - load_leftOfSplit) &gt; <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a> * (ncpu - ncpu_leftOfSplit))
    {
      <span class="comment">/* we did not find a viable split */</span>
      <span class="keywordflow">return</span> -1;
    }

  <span class="keywordflow">if</span>(sphload_leftOfSplit &gt; <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a> * ncpu_leftOfSplit ||
     (sphload - sphload_leftOfSplit) &gt; <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a> * (ncpu - ncpu_leftOfSplit))
    {
      <span class="comment">/* we did not find a viable split */</span>
      <span class="keywordflow">return</span> -1;
    }

  <span class="keywordflow">if</span>(ncpu_leftOfSplit &gt;= 2)
    ok_left = <a class="code" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit</a>(cpustart, ncpu_leftOfSplit, first, split - 1);
  <span class="keywordflow">else</span>
    ok_left = 0;

  <span class="keywordflow">if</span>((ncpu - ncpu_leftOfSplit) &gt;= 2)
    ok_right = <a class="code" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit</a>(cpustart + ncpu_leftOfSplit, ncpu - ncpu_leftOfSplit, split, <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>);
  <span class="keywordflow">else</span>
    ok_right = 0;

  <span class="keywordflow">if</span>(ok_left == 0 &amp;&amp; ok_right == 0)
    {
      <span class="comment">/* found a viable split */</span>

      <span class="keywordflow">if</span>(ncpu_leftOfSplit == 1)
        {
          <span class="keywordflow">for</span>(i = first; i &lt; split; i++)
            <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[i] = cpustart;

          <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[cpustart] = load_leftOfSplit;
          <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[cpustart] = sphload_leftOfSplit;
          <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[cpustart] = first;
          <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[cpustart] = split - 1;
        }

      <span class="keywordflow">if</span>((ncpu - ncpu_leftOfSplit) == 1)
        {
          <span class="keywordflow">for</span>(i = split; i &lt;= <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>; i++)
            <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[i] = cpustart + ncpu_leftOfSplit;

          <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[cpustart + ncpu_leftOfSplit] = load - load_leftOfSplit;
          <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[cpustart + ncpu_leftOfSplit] = sphload - sphload_leftOfSplit;
          <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[cpustart + ncpu_leftOfSplit] = split;
          <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[cpustart + ncpu_leftOfSplit] = <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>;
        }

      <span class="keywordflow">return</span> 0;
    }

  <span class="comment">/* we did not find a viable split */</span>
  <span class="keywordflow">return</span> -1;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a412d5d8810751249cc8dcd9e219e4e57_cgraph.png" border="0" usemap="#proto_8h_a412d5d8810751249cc8dcd9e219e4e57_cgraph" alt=""/></div>
<map name="proto_8h_a412d5d8810751249cc8dcd9e219e4e57_cgraph" id="proto_8h_a412d5d8810751249cc8dcd9e219e4e57_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="357,7,416,37"/><area shape="rect" id="node5" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="181,45,309,74"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a412d5d8810751249cc8dcd9e219e4e57_icgraph.png" border="0" usemap="#proto_8h_a412d5d8810751249cc8dcd9e219e4e57_icgraph" alt=""/></div>
<map name="proto_8h_a412d5d8810751249cc8dcd9e219e4e57_icgraph" id="proto_8h_a412d5d8810751249cc8dcd9e219e4e57_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="181,57,333,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="381,57,555,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="603,5,821,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="881,56,924,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="692,109,732,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="985,83,1039,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="869,109,936,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a89c54187117b91d4270a4f0c406ce2ba"></a><!-- doxytag: member="proto.h::domain_shiftSplit" ref="a89c54187117b91d4270a4f0c406ce2ba" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_shiftSplit </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function tries to improve the domain decomposition found by <a class="el" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57">domain_findSplit()</a> with respect to work-load balance. To this end, the boundaries in the existing domain-split solution (which was found by trying to balance the particle load) are shifted as long as this leads to better work-load while still remaining within the allowed memory-imbalance constraints. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00447">447</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="allvars_8c_source.html#l00057">DomainCount</a>, <a class="el" href="allvars_8c_source.html#l00058">DomainCountSph</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="allvars_8c_source.html#l00056">DomainWork</a>, <a class="el" href="domain_8c_source.html#l00041">list_load</a>, <a class="el" href="domain_8c_source.html#l00042">list_loadsph</a>, <a class="el" href="domain_8c_source.html#l00043">list_work</a>, <a class="el" href="domain_8c_source.html#l00045">maxload</a>, <a class="el" href="domain_8c_source.html#l00045">maxloadsph</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, and <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, task, iter = 0, moved;
  <span class="keywordtype">double</span> maxw, newmaxw;

  <span class="keywordflow">for</span>(task = 0; task &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; task++)
    <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] = 0;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[i]] += <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[i];

  <span class="keywordflow">do</span>
    {
      <span class="keywordflow">for</span>(task = 0, moved = 0; task &lt; NTask - 1; task++)
        {
          maxw = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task], <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1]);

          <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] &lt; <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1])
            {
              newmaxw = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] + <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]],
                             <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1] - <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]]);
              <span class="keywordflow">if</span>(newmaxw &lt;= maxw)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task] + <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]] &lt;= <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a>)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task] + <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]] &gt; <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a>)
                        <span class="keywordflow">continue</span>;

                      <span class="comment">/* ok, we can move one domain cell from right to left */</span>
                      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] += <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1]];
                      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task] += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[DomainStartList[task + 1]];
                      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task] += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[DomainStartList[task + 1]];
                      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1] -= <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[DomainStartList[task + 1]];
                      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task + 1] -= <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[DomainStartList[task + 1]];
                      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task + 1] -= <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[DomainStartList[task + 1]];

                      <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[DomainStartList[task + 1]] = task;
                      DomainStartList[task + 1] += 1;
                      <a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task] += 1;

                      moved++;
                    }
                }
            }
          <span class="keywordflow">else</span>
            {
              newmaxw = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] - <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]],
                             <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1] + <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]]);
              <span class="keywordflow">if</span>(newmaxw &lt;= maxw)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task + 1] + <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]] &lt;= <a class="code" href="domain_8c.html#ac54707073f160b11ee4ba864066487c3">maxload</a>)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task + 1] + <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]] &gt; <a class="code" href="domain_8c.html#afa6a98969329aca0189182e060a2834e">maxloadsph</a>)
                        <span class="keywordflow">continue</span>;

                      <span class="comment">/* ok, we can move one domain cell from left to right */</span>
                      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task] -= <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[task]];
                      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task] -= <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[DomainEndList[task]];
                      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task] -= <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[DomainEndList[task]];
                      <a class="code" href="domain_8c.html#ad25e64ba07e1ed5350cceeab486c6f4a">list_work</a>[task + 1] += <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>[DomainEndList[task]];
                      <a class="code" href="domain_8c.html#af3343810478135e16ac72ea1f0172cd6">list_load</a>[task + 1] += <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>[DomainEndList[task]];
                      <a class="code" href="domain_8c.html#a97ae02d63ef3ac017dcbaea0d3b4dda4">list_loadsph</a>[task + 1] += <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>[DomainEndList[task]];

                      <a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[DomainEndList[task]] = task + 1;
                      DomainEndList[task] -= 1;
                      <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[task + 1] -= 1;

                      moved++;
                    }
                }

            }
        }

      iter++;
    }
  <span class="keywordflow">while</span>(moved &gt; 0 &amp;&amp; iter &lt; 10 * NTopleaves);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a89c54187117b91d4270a4f0c406ce2ba_cgraph.png" border="0" usemap="#proto_8h_a89c54187117b91d4270a4f0c406ce2ba_cgraph" alt=""/></div>
<map name="proto_8h_a89c54187117b91d4270a4f0c406ce2ba_cgraph" id="proto_8h_a89c54187117b91d4270a4f0c406ce2ba_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="187,5,245,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a89c54187117b91d4270a4f0c406ce2ba_icgraph.png" border="0" usemap="#proto_8h_a89c54187117b91d4270a4f0c406ce2ba_icgraph" alt=""/></div>
<map name="proto_8h_a89c54187117b91d4270a4f0c406ce2ba_icgraph" id="proto_8h_a89c54187117b91d4270a4f0c406ce2ba_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="187,57,339,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="387,57,560,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="608,5,827,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="887,56,929,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="697,109,737,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="991,83,1044,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="875,109,941,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a25aada0d3751c2afd2a376151d1d917e"></a><!-- doxytag: member="proto.h::domain_sumCost" ref="a25aada0d3751c2afd2a376151d1d917e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_sumCost </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine bins the particles onto the domain-grid, i.e. it sums up the total number of particles and the total amount of work in each of the domain-cells. This information forms the basis for the actual decision on the adopted domain decomposition. </p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00786">786</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="domain_8c_source.html#l00765">domain_walktoptree()</a>, <a class="el" href="allvars_8c_source.html#l00057">DomainCount</a>, <a class="el" href="allvars_8c_source.html#l00058">DomainCountSph</a>, <a class="el" href="allvars_8c_source.html#l00056">DomainWork</a>, <a class="el" href="allvars_8h_source.html#l00537">particle_data::GravCost</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, <a class="el" href="allvars_8c_source.html#l00074">NTopnodes</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, n, no;
  <span class="keywordtype">double</span> *local_DomainWork;
  <span class="keywordtype">int</span> *local_DomainCount;
  <span class="keywordtype">int</span> *local_DomainCountSph;

  local_DomainWork = malloc(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
  local_DomainCount = malloc(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  local_DomainCountSph = malloc(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));



  <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a> = 0;

  <a class="code" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4">domain_walktoptree</a>(0);

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    {
      local_DomainWork[i] = 0;
      local_DomainCount[i] = 0;
      local_DomainCountSph[i] = 0;
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;NTopleaves= %d\n&quot;</span>, NTopleaves);

  <span class="keywordflow">for</span>(n = 0; n &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; n++)
    {
      no = 0;

      <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter &gt;= 0)
        no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + (<a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[n] - <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Size / 8);

      no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a>;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_endstep &gt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_begstep)
        local_DomainWork[no] += (1.0 + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a>) / (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_endstep - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_begstep);
      <span class="keywordflow">else</span>
        local_DomainWork[no] += (1.0 + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a>);

      local_DomainCount[no] += 1;
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type == 0)
        local_DomainCountSph[no] += 1;
    }

  MPI_Allreduce(local_DomainWork, <a class="code" href="allvars_8c.html#aed1b2c641567602d5935709a6a05b363">DomainWork</a>, NTopleaves, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
  MPI_Allreduce(local_DomainCount, <a class="code" href="allvars_8c.html#a743ddd39e492911973f9acd210df0c7c">DomainCount</a>, NTopleaves, MPI_INT, MPI_SUM, MPI_COMM_WORLD);
  MPI_Allreduce(local_DomainCountSph, <a class="code" href="allvars_8c.html#acfb9351c127127b0de4a310bf91974e4">DomainCountSph</a>, NTopleaves, MPI_INT, MPI_SUM, MPI_COMM_WORLD);


  free(local_DomainCountSph);
  free(local_DomainCount);
  free(local_DomainWork);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a25aada0d3751c2afd2a376151d1d917e_cgraph.png" border="0" usemap="#proto_8h_a25aada0d3751c2afd2a376151d1d917e_cgraph" alt=""/></div>
<map name="proto_8h_a25aada0d3751c2afd2a376151d1d917e_cgraph" id="proto_8h_a25aada0d3751c2afd2a376151d1d917e_cgraph">
<area shape="rect" id="node3" href="domain_8c.html#a9b1062a5c460164de378d5e8c45736c4" title="domain_walktoptree" alt="" coords="191,5,340,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a25aada0d3751c2afd2a376151d1d917e_icgraph.png" border="0" usemap="#proto_8h_a25aada0d3751c2afd2a376151d1d917e_icgraph" alt=""/></div>
<map name="proto_8h_a25aada0d3751c2afd2a376151d1d917e_icgraph" id="proto_8h_a25aada0d3751c2afd2a376151d1d917e_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="189,57,341,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="389,57,563,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="611,5,829,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="889,56,932,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="700,109,740,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="993,83,1047,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="877,109,944,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a606de536756a67ad8f79f1135009195e"></a><!-- doxytag: member="proto.h::domain_topsplit" ref="a606de536756a67ad8f79f1135009195e" args="(int node, peanokey startkey)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_topsplit </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>node</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>&nbsp;</td>
          <td class="paramname"> <em>startkey</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is responsible for constructing the global top-level tree segments. Starting from a joint list of all local top-level segments, in which mulitple occurences of the same spatial segment have been combined, a segment is subdivided into 8 pieces recursively until the number of particles in each segment has fallen below All.TotNumPart / (TOPNODEFACTOR * NTask). </p>

<p><p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition </p>
</p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l01049">1049</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00224">topnode_data::Blocks</a>, <a class="el" href="domain_8c_source.html#l00050">topnode_exchange::Count</a>, <a class="el" href="allvars_8h_source.html#l00228">topnode_data::Count</a>, <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00045">MAXTOPNODES</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00074">NTopnodes</a>, <a class="el" href="allvars_8h_source.html#l00223">topnode_data::Pstart</a>, <a class="el" href="allvars_8h_source.html#l00226">topnode_data::Size</a>, <a class="el" href="domain_8c_source.html#l00049">topnode_exchange::Startkey</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>, <a class="el" href="domain_8c_source.html#l00029">TOPNODEFACTOR</a>, <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>, and <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>, and <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p, sub, bin;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Size &gt;= 8)
    {
      <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> &lt; <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a>)
            {
              sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + i;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> / 8;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> = 0;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abad41cd99537e7a3a0d78ac5f291e42d">Blocks</a> = 0;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = -1;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a> = startkey + i * <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a>;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a>;
              <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>++;
            }
          <span class="keywordflow">else</span>
            {
              printf(<span class="stringliteral">&quot;Task=%d: We are out of Topnodes. Increasing the constant MAXTOPNODES might help.\n&quot;</span>,
                     <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
              fflush(stdout);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(137213);
            }
        }

      <span class="keywordflow">for</span>(p = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Pstart; p &lt; <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> + <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abad41cd99537e7a3a0d78ac5f291e42d">Blocks</a>; p++)
        {
          bin = (<a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>[p].<a class="code" href="structtopnode__exchange.html#a1320a6ec4ba632909af0c092bd7735b4">Startkey</a> - startkey) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Size / 8);
          sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + bin;

          <span class="keywordflow">if</span>(bin &lt; 0 || bin &gt; 7)
            <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(77);

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].Blocks == 0)
            <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = p;

          <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> += <a class="code" href="domain_8c.html#aa4d05cc74afde41e1777c117c9103471">toplist</a>[p].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a>;
          <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abad41cd99537e7a3a0d78ac5f291e42d">Blocks</a>++;
        }

      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        {
          sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + i;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> / (<a class="code" href="domain_8c.html#aebefeda80791480c21adcdd296f92c90">TOPNODEFACTOR</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>))
            <a class="code" href="domain_8c.html#a606de536756a67ad8f79f1135009195e">domain_topsplit</a>(sub, <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].StartKey);
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a606de536756a67ad8f79f1135009195e_cgraph.png" border="0" usemap="#proto_8h_a606de536756a67ad8f79f1135009195e_cgraph" alt=""/></div>
<map name="proto_8h_a606de536756a67ad8f79f1135009195e_cgraph" id="proto_8h_a606de536756a67ad8f79f1135009195e_cgraph">
<area shape="rect" id="node3" href="domain_8c.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="180,29,303,59"/><area shape="rect" id="node6" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="352,56,419,85"/><area shape="rect" id="node8" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="467,56,624,85"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a606de536756a67ad8f79f1135009195e_icgraph.png" border="0" usemap="#proto_8h_a606de536756a67ad8f79f1135009195e_icgraph" alt=""/></div>
<map name="proto_8h_a606de536756a67ad8f79f1135009195e_icgraph" id="proto_8h_a606de536756a67ad8f79f1135009195e_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="179,57,371,87"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="419,57,571,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="619,57,792,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="840,5,1059,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1119,56,1161,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="929,109,969,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1223,83,1276,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1107,109,1173,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa5001f9be833c4673392b40e7be3a421"></a><!-- doxytag: member="proto.h::domain_topsplit_local" ref="aa5001f9be833c4673392b40e7be3a421" args="(int node, peanokey startkey)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void domain_topsplit_local </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>node</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a>&nbsp;</td>
          <td class="paramname"> <em>startkey</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is responsible for constructing the local top-level Peano-Hilbert segments. A segment is cut into 8 pieces recursively until the number of particles in the segment has fallen below All.TotNumPart / (TOPNODEFACTOR * NTask * NTask). </p>

<p><p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition </p>
</p>

<p>Definition at line <a class="el" href="domain_8c_source.html#l00982">982</a> of file <a class="el" href="domain_8c_source.html">domain.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="domain_8c_source.html#l00050">topnode_exchange::Count</a>, <a class="el" href="allvars_8h_source.html#l00228">topnode_data::Count</a>, <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="domain_8c_source.html#l00982">domain_topsplit_local()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00071">KeySorted</a>, <a class="el" href="allvars_8h_source.html#l00045">MAXTOPNODES</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00074">NTopnodes</a>, <a class="el" href="allvars_8h_source.html#l00223">topnode_data::Pstart</a>, <a class="el" href="allvars_8h_source.html#l00226">topnode_data::Size</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="domain_8c_source.html#l00029">TOPNODEFACTOR</a>, <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>, and <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>, and <a class="el" href="domain_8c_source.html#l00982">domain_topsplit_local()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p, sub, bin;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Size &gt;= 8)
    {
      <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a> &lt; <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a>)
            {
              sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + i;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a> / 8;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a> = 0;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> = -1;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a> = startkey + i * <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a7a06f0263a5602d4c073100a517892b8">Size</a>;
              <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a>;

              <a class="code" href="allvars_8c.html#a269a1fc2bea249d93115b160fd42ee84">NTopnodes</a>++;
            }
          <span class="keywordflow">else</span>
            {
              printf(<span class="stringliteral">&quot;task=%d: We are out of Topnodes. Increasing the constant MAXTOPNODES might help.\n&quot;</span>,
                     <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
              fflush(stdout);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(13213);
            }
        }

      <span class="keywordflow">for</span>(p = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Pstart; p &lt; <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> + <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a>; p++)
        {
          bin = (<a class="code" href="allvars_8c.html#a8b9ee62bf965346f051e19e013d998b4">KeySorted</a>[p] - startkey) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].Size / 8);

          <span class="keywordflow">if</span>(bin &lt; 0 || bin &gt; 7)
            {
              printf(<span class="stringliteral">&quot;task=%d: something odd has happened here. bin=%d\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, bin);
              fflush(stdout);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(13123123);
            }

          sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + bin;

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a> == 0)
            <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#abe0b214b3cf372c95a16966304b1592c">Pstart</a> = p;

          <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#a3cae714f1f71f6ce4750004ee6fbda06">Count</a>++;
        }

      <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
        {
          sub = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + i;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].<a class="code" href="structtopnode__exchange.html#a8c37f88a4fac1e60c0132abfc976ce70">Count</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> / (<a class="code" href="domain_8c.html#aebefeda80791480c21adcdd296f92c90">TOPNODEFACTOR</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>))
            <a class="code" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421">domain_topsplit_local</a>(sub, <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[sub].StartKey);
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aa5001f9be833c4673392b40e7be3a421_cgraph.png" border="0" usemap="#proto_8h_aa5001f9be833c4673392b40e7be3a421_cgraph" alt=""/></div>
<map name="proto_8h_aa5001f9be833c4673392b40e7be3a421_cgraph" id="proto_8h_aa5001f9be833c4673392b40e7be3a421_cgraph">
<area shape="rect" id="node3" href="domain_8c.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="213,29,373,59"/><area shape="rect" id="node6" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="421,56,488,85"/><area shape="rect" id="node8" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="536,56,693,85"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aa5001f9be833c4673392b40e7be3a421_icgraph.png" border="0" usemap="#proto_8h_aa5001f9be833c4673392b40e7be3a421_icgraph" alt=""/></div>
<map name="proto_8h_aa5001f9be833c4673392b40e7be3a421_icgraph" id="proto_8h_aa5001f9be833c4673392b40e7be3a421_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="213,57,405,87"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="453,57,605,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="653,57,827,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="875,5,1093,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1153,56,1196,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="964,109,1004,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1257,83,1311,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1141,109,1208,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8cb77fa18fd6b91a358bd0a9c04cbf2e"></a><!-- doxytag: member="proto.h::drift_integ" ref="a8cb77fa18fd6b91a358bd0a9c04cbf2e" args="(double a, void *param)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double drift_integ </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>param</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Integration kernel for drift factor computation. </p>

<p>Definition at line <a class="el" href="driftfac_8c_source.html#l00179">179</a> of file <a class="el" href="driftfac_8c_source.html">driftfac.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, and <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> h;

  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> / (a * a * a) + (1 - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>) / (a * a) + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>;
  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * sqrt(h);

  <span class="keywordflow">return</span> 1 / (h * a * a * a);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab303b92c6d6b4144999c5cebabd65ec0"></a><!-- doxytag: member="proto.h::dump_particles" ref="ab303b92c6d6b4144999c5cebabd65ec0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void dump_particles </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function dumps some of the basic particle data to a file. In case the tree construction fails, it is called just before the run terminates with an error message. Examination of the generated file may then give clues to what caused the problem. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03040">3040</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="io_8c_source.html#l01122">my_fwrite()</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, and <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>;
  <span class="keywordtype">char</span> buffer[200];
  <span class="keywordtype">int</span> i;

  sprintf(buffer, <span class="stringliteral">&quot;particles%d.dat&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
  fd = fopen(buffer, <span class="stringliteral">&quot;w&quot;</span>);
  <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), fd);

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0], 3, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), fd);

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Vel[0], 3, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), fd);

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].ID, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), fd);

  fclose(fd);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab303b92c6d6b4144999c5cebabd65ec0_cgraph.png" border="0" usemap="#proto_8h_ab303b92c6d6b4144999c5cebabd65ec0_cgraph" alt=""/></div>
<map name="proto_8h_ab303b92c6d6b4144999c5cebabd65ec0_cgraph" id="proto_8h_ab303b92c6d6b4144999c5cebabd65ec0_cgraph">
<area shape="rect" id="node3" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="173,5,256,35"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="304,5,371,35"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="419,5,576,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab303b92c6d6b4144999c5cebabd65ec0_icgraph.png" border="0" usemap="#proto_8h_ab303b92c6d6b4144999c5cebabd65ec0_icgraph" alt=""/></div>
<map name="proto_8h_ab303b92c6d6b4144999c5cebabd65ec0_icgraph" id="proto_8h_ab303b92c6d6b4144999c5cebabd65ec0_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="175,83,369,112"/><area shape="rect" id="node6" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="420,109,580,139"/><area shape="rect" id="node8" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="629,109,747,139"/><area shape="rect" id="node10" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="796,56,937,85"/><area shape="rect" id="node19" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="817,109,916,139"/><area shape="rect" id="node24" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="812,163,921,192"/><area shape="rect" id="node12" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="987,5,1205,35"/><area shape="rect" id="node14" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1265,84,1308,113"/><area shape="rect" id="node16" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1369,111,1423,140"/><area shape="rect" id="node21" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="1011,109,1181,139"/><area shape="rect" id="node26" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1076,163,1116,192"/><area shape="rect" id="node28" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1253,137,1320,167"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3757efb7e470353080a128388ccebec9"></a><!-- doxytag: member="proto.h::empty_read_buffer" ref="a3757efb7e470353080a128388ccebec9" args="(enum iofields blocknr, int offset, int pc, int type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void empty_read_buffer </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a>&nbsp;</td>
          <td class="paramname"> <em>blocknr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>pc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function reads out the buffer that was filled with particle data, and stores it at the appropriate place in the particle structures. </p>

<p>Definition at line <a class="el" href="read__ic_8c_source.html#l00168">168</a> of file <a class="el" href="read__ic_8c_source.html">read_ic.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00102">CommBuffer</a>, <a class="el" href="allvars_8h_source.html#l00526">particle_data::ID</a>, <a class="el" href="allvars_8h_source.html#l00669">IO_ACCEL</a>, <a class="el" href="allvars_8h_source.html#l00670">IO_DTENTR</a>, <a class="el" href="allvars_8h_source.html#l00667">IO_HSML</a>, <a class="el" href="allvars_8h_source.html#l00663">IO_ID</a>, <a class="el" href="allvars_8h_source.html#l00664">IO_MASS</a>, <a class="el" href="allvars_8h_source.html#l00661">IO_POS</a>, <a class="el" href="allvars_8h_source.html#l00668">IO_POT</a>, <a class="el" href="allvars_8h_source.html#l00666">IO_RHO</a>, <a class="el" href="allvars_8h_source.html#l00671">IO_TSTP</a>, <a class="el" href="allvars_8h_source.html#l00665">IO_U</a>, <a class="el" href="allvars_8h_source.html#l00662">IO_VEL</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, and <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> n, k;
  <span class="keywordtype">float</span> *fp;

<span class="preprocessor">#ifdef LONGIDS</span>
<span class="preprocessor"></span>  <span class="keywordtype">long</span> <span class="keywordtype">long</span> *ip;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> *ip;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  fp = <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>;
  ip = <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>;

  <span class="keywordflow">switch</span> (blocknr)
    {
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a0207eb67d96fe97fb8158c42af624f8f">IO_POS</a>:                <span class="comment">/* positions */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
        <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[offset + n].Pos[k] = *fp++;

      <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[offset + n].Type = type;      <span class="comment">/* initialize type here as well */</span>
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aa4c3992546632e0db8015ebe534c0282">IO_VEL</a>:                <span class="comment">/* velocities */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
        <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[offset + n].Vel[k] = *fp++;
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>:         <span class="comment">/* particle ID */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[offset + n].ID = *ip++;
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a72e1cc8b602ab38f0f3491464ed82063">IO_MASS</a>:               <span class="comment">/* particle mass */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[offset + n].Mass = *fp++;
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>:                  <span class="comment">/* temperature */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
        <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[offset + n].Entropy = *fp++;
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a8dd43018a3f2d1caed951b249a38b106">IO_RHO</a>:                <span class="comment">/* density */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
        <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[offset + n].Density = *fp++;
      <span class="keywordflow">break</span>;


    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a429c6a7a56e3b53597bd1eb72b87f941">IO_HSML</a>:               <span class="comment">/* SPH smoothing length */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
        <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[offset + n].Hsml = *fp++;
      <span class="keywordflow">break</span>;




      <span class="comment">/* the other input fields (if present) are not needed to define the </span>
<span class="comment">         initial conditions of the code */</span>

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>:
      <span class="keywordflow">break</span>;
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a3757efb7e470353080a128388ccebec9_icgraph.png" border="0" usemap="#proto_8h_a3757efb7e470353080a128388ccebec9_icgraph" alt=""/></div>
<map name="proto_8h_a3757efb7e470353080a128388ccebec9_icgraph" id="proto_8h_a3757efb7e470353080a128388ccebec9_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="199,5,273,35"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="324,5,391,35"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="441,5,481,35"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="531,5,597,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="647,5,700,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9c69e0b6a074bb9341cf9854f17f245d"></a><!-- doxytag: member="proto.h::endrun" ref="a9c69e0b6a074bb9341cf9854f17f245d" args="(int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void endrun </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ierr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function aborts the simulations. If a single processors wants an immediate termination, the function needs to be called with ierr&gt;0. A bunch of MPI-error messages may also appear in this case. For ierr=0, MPI is gracefully cleaned up, but this requires that all processors call <a class="el" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun()</a>. </p>

<p>Definition at line <a class="el" href="endrun_8c_source.html#l00025">25</a> of file <a class="el" href="endrun_8c_source.html">endrun.c</a>.</p>

<p>References <a class="el" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8">terminate_processes()</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="allocate_8c_source.html#l00019">allocate_commbuffers()</a>, <a class="el" href="allocate_8c_source.html#l00103">allocate_memory()</a>, <a class="el" href="sidm__routines_8c_source.html#l00323">AllocateInteractionTable()</a>, <a class="el" href="init_8c_source.html#l00162">check_omega()</a>, <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="density_8c_source.html#l00056">density()</a>, <a class="el" href="domain_8c_source.html#l00154">domain_decompose()</a>, <a class="el" href="domain_8c_source.html#l00595">domain_exchangeParticles()</a>, <a class="el" href="domain_8c_source.html#l01049">domain_topsplit()</a>, <a class="el" href="domain_8c_source.html#l00982">domain_topsplit_local()</a>, <a class="el" href="read__ic_8c_source.html#l00615">find_files()</a>, <a class="el" href="run_8c_source.html#l00244">find_next_outputtime()</a>, <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, <a class="el" href="forcetree_8c_source.html#l00346">force_insert_pseudo_particles()</a>, <a class="el" href="forcetree_8c_source.html#l02827">force_treeallocate()</a>, <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>, <a class="el" href="forcetree_8c_source.html#l01126">force_treeevaluate()</a>, <a class="el" href="forcetree_8c_source.html#l02216">force_treeevaluate_potential()</a>, <a class="el" href="forcetree_8c_source.html#l02493">force_treeevaluate_potential_shortrange()</a>, <a class="el" href="forcetree_8c_source.html#l01500">force_treeevaluate_shortrange()</a>, <a class="el" href="io_8c_source.html#l00465">get_particles_in_block()</a>, <a class="el" href="timestep_8c_source.html#l00423">get_timestep()</a>, <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>, <a class="el" href="init_8c_source.html#l00020">init()</a>, <a class="el" href="longrange_8c_source.html#l00056">long_range_force()</a>, <a class="el" href="main_8c_source.html#l00022">main()</a>, <a class="el" href="io_8c_source.html#l01139">my_fread()</a>, <a class="el" href="io_8c_source.html#l01122">my_fwrite()</a>, <a class="el" href="ngb_8c_source.html#l00358">ngb_treeallocate()</a>, <a class="el" href="begrun_8c_source.html#l00204">open_outputfiles()</a>, <a class="el" href="pm__periodic_8c_source.html#l00113">pm_init_periodic_allocate()</a>, <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, <a class="el" href="begrun_8c_source.html#l00285">read_parameter_file()</a>, <a class="el" href="begrun_8c_source.html#l00804">readjust_timebase()</a>, <a class="el" href="restart_8c_source.html#l00035">restart()</a>, <a class="el" href="io_8c_source.html#l00033">savepositions()</a>, <a class="el" href="sidm__routines_8c_source.html#l00205">update_interaction_table()</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(ierr)
    {
      printf(<span class="stringliteral">&quot;task %d: endrun called with an error level of %d\n\n\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, ierr);
      fflush(stdout);
<span class="preprocessor">#ifdef DEBUG</span>
<span class="preprocessor"></span>      <a class="code" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8">terminate_processes</a>();
      <span class="keyword">raise</span>(SIGABRT);
      sleep(60);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      MPI_Abort(MPI_COMM_WORLD, ierr);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      exit(0);
    }

  MPI_Finalize();
  exit(0);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a9c69e0b6a074bb9341cf9854f17f245d_cgraph.png" border="0" usemap="#proto_8h_a9c69e0b6a074bb9341cf9854f17f245d_cgraph" alt=""/></div>
<map name="proto_8h_a9c69e0b6a074bb9341cf9854f17f245d_cgraph" id="proto_8h_a9c69e0b6a074bb9341cf9854f17f245d_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="120,5,277,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a9c69e0b6a074bb9341cf9854f17f245d_icgraph.png" border="0" usemap="#proto_8h_a9c69e0b6a074bb9341cf9854f17f245d_icgraph" alt=""/></div>
<map name="proto_8h_a9c69e0b6a074bb9341cf9854f17f245d_icgraph" id="proto_8h_a9c69e0b6a074bb9341cf9854f17f245d_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a9e761db39213af33ba28aeed461f1a5a" title="allocate_commbuffers" alt="" coords="1236,271,1399,300"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1591,499,1644,528"/><area shape="rect" id="node9" href="proto_8h.html#a7fe5e304baaf5f418a22fef9a9cc02c7" title="allocate_memory" alt="" coords="160,526,293,555"/><area shape="rect" id="node11" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="453,371,528,400"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1297,526,1337,555"/><area shape="rect" id="node18" href="restart_8c.html#ae81d30f52dddd39aef76bb1890d16f2f" title="restart" alt="" coords="459,603,523,632"/><area shape="rect" id="node24" href="sidm__routines_8c.html#a75d4b55f95852e708a563c3521438fe1" title="AllocateInteractionTable" alt="" coords="1231,387,1404,416"/><area shape="rect" id="node27" href="proto_8h.html#a1b96c5b41f1209ee91cd369f01a52352" title="check_omega" alt="" coords="1015,422,1124,451"/><area shape="rect" id="node30" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="999,1506,1140,1535"/><area shape="rect" id="node36" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="756,680,823,710"/><area shape="rect" id="node44" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="713,1375,865,1404"/><area shape="rect" id="node51" href="proto_8h.html#ab7d41435f73c1626208d63b2d5ba28ca" title="domain_exchangeParticles" alt="" coords="395,1454,587,1483"/><area shape="rect" id="node54" href="proto_8h.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="165,1352,288,1382"/><area shape="rect" id="node60" href="proto_8h.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="147,1275,307,1304"/><area shape="rect" id="node64" href="read__ic_8c.html#ac028b474d53a40e79377b7ae5dde636a" title="find_files" alt="" coords="452,294,529,323"/><area shape="rect" id="node67" href="run_8c.html#a00802290d71ce2a6de3f121de55ddd20" title="find_next_outputtime" alt="" coords="991,784,1148,814"/><area shape="rect" id="node71" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="129,1683,324,1712"/><area shape="rect" id="node74" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="411,1666,571,1695"/><area shape="rect" id="node79" href="proto_8h.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="121,1736,332,1766"/><area shape="rect" id="node82" href="proto_8h.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="159,1043,295,1072"/><area shape="rect" id="node87" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="724,1043,855,1072"/><area shape="rect" id="node95" href="proto_8h.html#a59ae74ef51d6a7065605638422489391" title="force_treeevaluate" alt="" coords="420,1852,561,1882"/><area shape="rect" id="node97" href="proto_8h.html#a804166b1847da509d8fe57072b40d5f9" title="force_treeevaluate_potential" alt="" coords="687,1744,892,1774"/><area shape="rect" id="node100" href="proto_8h.html#abd9d86a6c08e77a4fa78fa76b96cdde7" title="force_treeevaluate_potential_shortrange" alt="" coords="648,1558,931,1587"/><area shape="rect" id="node103" href="proto_8h.html#ae01e179b7686a7fe62970160b7bbdb46" title="force_treeevaluate_shortrange" alt="" coords="381,1930,600,1959"/><area shape="rect" id="node105" href="proto_8h.html#a5ce310b1efc19d96d530c1264fd5eca9" title="get_particles_in_block" alt="" coords="145,835,308,864"/><area shape="rect" id="node108" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="452,888,529,918"/><area shape="rect" id="node110" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="735,915,844,944"/><area shape="rect" id="node114" href="timestep_8c.html#af48922752ff457721f558510789e61e1" title="get_timestep" alt="" coords="173,1995,280,2024"/><area shape="rect" id="node116" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="725,1186,853,1215"/><area shape="rect" id="node122" href="proto_8h.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="185,320,268,350"/><area shape="rect" id="node125" href="proto_8h.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="185,939,268,968"/><area shape="rect" id="node128" href="proto_8h.html#a6f7a3b85f10701b9067f012cc9a30f55" title="ngb_treeallocate" alt="" coords="163,579,291,608"/><area shape="rect" id="node132" href="proto_8h.html#a6f629274f7b036874c743fb81d58ce68" title="open_outputfiles" alt="" coords="1253,472,1381,502"/><area shape="rect" id="node135" href="proto_8h.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="136,1096,317,1126"/><area shape="rect" id="node140" href="proto_8h.html#a952eae1977b498c4fdfabed1742a3ba2" title="read_parameter_file" alt="" coords="1243,694,1392,723"/><area shape="rect" id="node143" href="proto_8h.html#acc4d1f5e4e51140090a7ce25ea263b98" title="readjust_timebase" alt="" coords="999,64,1140,94"/><area shape="rect" id="node148" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615" title="update_interaction_table" alt="" coords="136,1891,317,1920"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1475,499,1541,528"/><area shape="rect" id="node13" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="756,370,823,399"/><area shape="rect" id="node21" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1487,954,1529,983"/><area shape="rect" id="node32" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="1208,1006,1427,1035"/><area shape="rect" id="node38" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="984,1043,1155,1072"/><area shape="rect" id="node41" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="980,680,1159,710"/><area shape="rect" id="node46" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="983,1096,1156,1126"/><area shape="rect" id="node56" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="395,1350,587,1379"/><area shape="rect" id="node76" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="731,1647,848,1676"/><area shape="rect" id="node85" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="425,1043,556,1072"/><area shape="rect" id="node90" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="413,1096,568,1126"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae903322da17c6875ab606b032b918099"></a><!-- doxytag: member="proto.h::energy_statistics" ref="ae903322da17c6875ab606b032b918099" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void energy_statistics </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine first calls a computation of various global quantities of the particle distribution, and then writes some statistics about the energies in the various particle components to the file FdEnergy. </p>

<p>Definition at line <a class="el" href="run_8c_source.html#l00432">432</a> of file <a class="el" href="run_8c_source.html">run.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="global_8c_source.html#l00022">compute_global_quantities_of_system()</a>, <a class="el" href="allvars_8h_source.html#l00685">state_of_system::EnergyInt</a>, <a class="el" href="allvars_8h_source.html#l00693">state_of_system::EnergyIntComp</a>, <a class="el" href="allvars_8h_source.html#l00683">state_of_system::EnergyKin</a>, <a class="el" href="allvars_8h_source.html#l00691">state_of_system::EnergyKinComp</a>, <a class="el" href="allvars_8h_source.html#l00684">state_of_system::EnergyPot</a>, <a class="el" href="allvars_8h_source.html#l00692">state_of_system::EnergyPotComp</a>, <a class="el" href="allvars_8c_source.html#l00090">FdEnergy</a>, <a class="el" href="allvars_8h_source.html#l00690">state_of_system::MassComp</a>, <a class="el" href="allvars_8c_source.html#l00173">SysState</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <a class="code" href="global_8c.html#ada58109949c2431ca9b0cdaa01cfb5b1">compute_global_quantities_of_system</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      fprintf(<a class="code" href="allvars_8c.html#a0230903e40950ac42dbff71dddd12176">FdEnergy</a>,
              <span class="stringliteral">&quot;%g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g\n&quot;</span>,
              <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8ee567f49007a65817989a252d8c4f90">EnergyInt</a>, <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#aece07698cdbe00520fcb92ad9f04d435">EnergyPot</a>, <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a92ed1ad5f1a02586030b21f5f3e560ec">EnergyKin</a>, <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[0],
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[0], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[0], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[1],
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[1], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[1], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[2],
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[2], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[2], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[3],
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[3], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[3], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[4],
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[4], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[4], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af96bea4b9655900eef6d7734629241a7">EnergyIntComp</a>[5],
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#af495e90a93989d10e7f138c33c5cdad3">EnergyPotComp</a>[5], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a8b776a503b441fc690c0940e3386a2fb">EnergyKinComp</a>[5], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[0],
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[1], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[2], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[3], <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[4],
              <a class="code" href="allvars_8c.html#af53292602db23da91797b37daeb9b8ce">SysState</a>.<a class="code" href="structstate__of__system.html#a760dbd458028ff092d8fab04f54f90ff">MassComp</a>[5]);

      fflush(<a class="code" href="allvars_8c.html#a0230903e40950ac42dbff71dddd12176">FdEnergy</a>);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ae903322da17c6875ab606b032b918099_cgraph.png" border="0" usemap="#proto_8h_ae903322da17c6875ab606b032b918099_cgraph" alt=""/></div>
<map name="proto_8h_ae903322da17c6875ab606b032b918099_cgraph" id="proto_8h_ae903322da17c6875ab606b032b918099_cgraph">
<area shape="rect" id="node3" href="global_8c.html#ada58109949c2431ca9b0cdaa01cfb5b1" title="compute_global_quantities_of_system" alt="" coords="184,59,451,88"/><area shape="rect" id="node5" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="503,5,649,35"/><area shape="rect" id="node7" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="499,59,653,88"/><area shape="rect" id="node9" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="553,112,599,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ae903322da17c6875ab606b032b918099_icgraph.png" border="0" usemap="#proto_8h_ae903322da17c6875ab606b032b918099_icgraph" alt=""/></div>
<map name="proto_8h_ae903322da17c6875ab606b032b918099_icgraph" id="proto_8h_ae903322da17c6875ab606b032b918099_icgraph">
<area shape="rect" id="node3" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="184,5,227,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="276,5,329,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a7e26319b203616f2c85b5fd6f2ade85d"></a><!-- doxytag: member="proto.h::every_timestep_stuff" ref="a7e26319b203616f2c85b5fd6f2ade85d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void every_timestep_stuff </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine writes one line for every timestep to two log-files. In FdInfo, we just list the timesteps that have been done, while in FdCPU the cumulative cpu-time consumption in various parts of the code is stored. </p>

<p>Definition at line <a class="el" href="run_8c_source.html#l00370">370</a> of file <a class="el" href="run_8c_source.html">run.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00413">global_data_all_processes::CPU_CommSum</a>, <a class="el" href="allvars_8h_source.html#l00410">global_data_all_processes::CPU_Domain</a>, <a class="el" href="allvars_8h_source.html#l00419">global_data_all_processes::CPU_EnsureNgb</a>, <a class="el" href="allvars_8h_source.html#l00408">global_data_all_processes::CPU_Gravity</a>, <a class="el" href="allvars_8h_source.html#l00416">global_data_all_processes::CPU_HydCommSumm</a>, <a class="el" href="allvars_8h_source.html#l00415">global_data_all_processes::CPU_HydCompWalk</a>, <a class="el" href="allvars_8h_source.html#l00417">global_data_all_processes::CPU_HydImbalance</a>, <a class="el" href="allvars_8h_source.html#l00418">global_data_all_processes::CPU_Hydro</a>, <a class="el" href="allvars_8h_source.html#l00414">global_data_all_processes::CPU_Imbalance</a>, <a class="el" href="allvars_8h_source.html#l00423">global_data_all_processes::CPU_Peano</a>, <a class="el" href="allvars_8h_source.html#l00422">global_data_all_processes::CPU_PM</a>, <a class="el" href="allvars_8h_source.html#l00409">global_data_all_processes::CPU_Potential</a>, <a class="el" href="allvars_8h_source.html#l00420">global_data_all_processes::CPU_Predict</a>, <a class="el" href="allvars_8h_source.html#l00411">global_data_all_processes::CPU_Snapshot</a>, <a class="el" href="allvars_8h_source.html#l00421">global_data_all_processes::CPU_TimeLine</a>, <a class="el" href="allvars_8h_source.html#l00412">global_data_all_processes::CPU_Total</a>, <a class="el" href="allvars_8h_source.html#l00406">global_data_all_processes::CPU_TreeConstruction</a>, <a class="el" href="allvars_8h_source.html#l00407">global_data_all_processes::CPU_TreeWalk</a>, <a class="el" href="allvars_8c_source.html#l00092">FdCPU</a>, <a class="el" href="allvars_8c_source.html#l00089">FdInfo</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00364">global_data_all_processes::NumCurrentTiStep</a>, <a class="el" href="system_8c_source.html#l00037">set_random_numbers()</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, and <a class="el" href="allvars_8h_source.html#l00371">global_data_all_processes::TimeStep</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> z;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        {
          z = 1.0 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) - 1;
          fprintf(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>, <span class="stringliteral">&quot;\nBegin Step %d, Time: %g, Redshift: %g, Systemstep: %g, Dloga: %g, NselfInteractions: %lu\n&quot;</span>, 
                  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, z, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>,
                  log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) - log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>),  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactionsSum);
          printf(<span class="stringliteral">&quot;\nBegin Step %d, Time: %g, Redshift: %g, Systemstep: %g, Dloga: %g, NselfInteractions: %lu\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>,
                 <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, z, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>, log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) - log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>), <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactionsSum);
          fflush(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>);
        }
      <span class="keywordflow">else</span>
        {
          fprintf(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>, <span class="stringliteral">&quot;\nBegin Step %d, Time: %g, Systemstep: %g, NselfInteractions: %lu\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>,
                  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactionsSum);
          printf(<span class="stringliteral">&quot;\nBegin Step %d, Time: %g, Systemstep: %g, NselfInteractions: %lu\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactionsSum);
          fflush(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>);
        }
<span class="preprocessor">#else       </span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        {
          z = 1.0 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) - 1;
          fprintf(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>, <span class="stringliteral">&quot;\nBegin Step %d, Time: %g, Redshift: %g, Systemstep: %g, Dloga: %g\n&quot;</span>,
                  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, z, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>,
                  log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) - log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>));
          printf(<span class="stringliteral">&quot;\nBegin Step %d, Time: %g, Redshift: %g, Systemstep: %g, Dloga: %g\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>,
                 <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, z, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>, log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) - log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>));
          fflush(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>);
        }
      <span class="keywordflow">else</span>
        {
          fprintf(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>, <span class="stringliteral">&quot;\nBegin Step %d, Time: %g, Systemstep: %g\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>,
                  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>);
          printf(<span class="stringliteral">&quot;\nBegin Step %d, Time: %g, Systemstep: %g\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>);
          fflush(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a>);
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      fprintf(<a class="code" href="allvars_8c.html#a889700103f4f515009e98a7d789fd164">FdCPU</a>, <span class="stringliteral">&quot;Step %d, Time: %g, CPUs: %d\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);

      fprintf(<a class="code" href="allvars_8c.html#a889700103f4f515009e98a7d789fd164">FdCPU</a>,
              <span class="stringliteral">&quot;%10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f\n&quot;</span>,
              <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3d87cd9a94ce540341d4fb713b253c9e">CPU_Total</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a27dce58feba6ff0e933ed6f24f857168">CPU_Gravity</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#add20a8e70f3c4cc7912dc81ef141daa2">CPU_Hydro</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a786736d9e91341733e286f6e03ab26a5">CPU_Domain</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab5f1e056cdaa2562ec2bd3945f634d73">CPU_Potential</a>,
              <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afb9d30620ea0dc8b9e46000e3ce0b3e3">CPU_Predict</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a675f7230ece5f6d88fcc0384a8e1f6c9">CPU_TimeLine</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4b533ec2fc1af7ee057eaa5805a65a7a">CPU_Snapshot</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#acf5e983357d7be116cd6663958e5a149">CPU_TreeWalk</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac9eb650a8550b48eb464b6a0a8629a27">CPU_TreeConstruction</a>,
              <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a41ab81d126219e1ff8119f8400428216">CPU_CommSum</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a94e4eed16c5b353ec3c3c9ce380ec96a">CPU_Imbalance</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a918e3d80cf4fdaf22a803f4014588ad4">CPU_HydCompWalk</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad03842fb23d3c15316ca07c7ac1bce27">CPU_HydCommSumm</a>,
              <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a848f914dfb3ae24d6faedc1944bcb265">CPU_HydImbalance</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad3447593858d4165b669b5e70b2521cd">CPU_EnsureNgb</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2251bf94479cb20a7af9c34ed56587d1">CPU_PM</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3d1492ec738b3ebf2025de1d2f398b7d">CPU_Peano</a>);
      fflush(<a class="code" href="allvars_8c.html#a889700103f4f515009e98a7d789fd164">FdCPU</a>);
    }

  <a class="code" href="proto_8h.html#a9cb45ef22cae101906f021fb7a23afbe">set_random_numbers</a>();
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a7e26319b203616f2c85b5fd6f2ade85d_cgraph.png" border="0" usemap="#proto_8h_a7e26319b203616f2c85b5fd6f2ade85d_cgraph" alt=""/></div>
<map name="proto_8h_a7e26319b203616f2c85b5fd6f2ade85d_cgraph" id="proto_8h_a7e26319b203616f2c85b5fd6f2ade85d_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a9cb45ef22cae101906f021fb7a23afbe" title="set_random_numbers" alt="" coords="211,5,373,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a7e26319b203616f2c85b5fd6f2ade85d_icgraph.png" border="0" usemap="#proto_8h_a7e26319b203616f2c85b5fd6f2ade85d_icgraph" alt=""/></div>
<map name="proto_8h_a7e26319b203616f2c85b5fd6f2ade85d_icgraph" id="proto_8h_a7e26319b203616f2c85b5fd6f2ade85d_icgraph">
<area shape="rect" id="node3" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="211,5,253,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="303,5,356,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad8b8e212e593e1795f6ba522239086fc"></a><!-- doxytag: member="proto.h::ewald_corr" ref="ad8b8e212e593e1795f6ba522239086fc" args="(double dx, double dy, double dz, double *fper)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ewald_corr </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>fper</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function looks up the correction force due to the infinite number of periodic particle/node images. We here use trilinear interpolation to get it from the precomputed tables, which contain one octant around the target particle at the origin. The other octants are obtained from it by exploiting the symmetry properties. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03228">3228</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="forcetree_8c_source.html#l00045">EN</a>, <a class="el" href="forcetree_8c_source.html#l00053">fac_intp</a>, <a class="el" href="forcetree_8c_source.html#l00049">fcorrx</a>, <a class="el" href="forcetree_8c_source.html#l00050">fcorry</a>, <a class="el" href="forcetree_8c_source.html#l00051">fcorrz</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02909">force_treeevaluate_direct()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> signx, signy, signz;
  <span class="keywordtype">int</span> i, j, k;
  <span class="keywordtype">double</span> u, v, w;
  <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;

  <span class="keywordflow">if</span>(dx &lt; 0)
    {
      dx = -dx;
      signx = +1;
    }
  <span class="keywordflow">else</span>
    signx = -1;

  <span class="keywordflow">if</span>(dy &lt; 0)
    {
      dy = -dy;
      signy = +1;
    }
  <span class="keywordflow">else</span>
    signy = -1;

  <span class="keywordflow">if</span>(dz &lt; 0)
    {
      dz = -dz;
      signz = +1;
    }
  <span class="keywordflow">else</span>
    signz = -1;

  u = dx * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
  i = (int) u;
  <span class="keywordflow">if</span>(i &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    i = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  u -= i;
  v = dy * fac_intp;
  j = (int) v;
  <span class="keywordflow">if</span>(j &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    j = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  v -= j;
  w = dz * fac_intp;
  k = (int) w;
  <span class="keywordflow">if</span>(k &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    k = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  w -= k;

  f1 = (1 - u) * (1 - v) * (1 - w);
  f2 = (1 - u) * (1 - v) * (w);
  f3 = (1 - u) * (v) * (1 - w);
  f4 = (1 - u) * (v) * (w);
  f5 = (u) * (1 - v) * (1 - w);
  f6 = (u) * (1 - v) * (w);
  f7 = (u) * (v) * (1 - w);
  f8 = (u) * (v) * (w);

  fper[0] = signx * (<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k] * f1 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k + 1] * f2 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j + 1][k] * f3 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j + 1][k + 1] * f4 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j][k] * f5 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j][k + 1] * f6 +
                     <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j + 1][k + 1] * f8);

  fper[1] = signy * (<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k] * f1 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k + 1] * f2 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j + 1][k] * f3 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j + 1][k + 1] * f4 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j][k] * f5 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j][k + 1] * f6 +
                     <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j + 1][k + 1] * f8);

  fper[2] = signz * (<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k] * f1 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k + 1] * f2 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j + 1][k] * f3 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j + 1][k + 1] * f4 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j][k] * f5 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j][k + 1] * f6 +
                     <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j + 1][k + 1] * f8);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad8b8e212e593e1795f6ba522239086fc_icgraph.png" border="0" usemap="#proto_8h_ad8b8e212e593e1795f6ba522239086fc_icgraph" alt=""/></div>
<map name="proto_8h_ad8b8e212e593e1795f6ba522239086fc_icgraph" id="proto_8h_ad8b8e212e593e1795f6ba522239086fc_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a0ec221b2517893874b12dc366bfe0da8" title="force_treeevaluate_direct" alt="" coords="145,5,329,35"/><area shape="rect" id="node5" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="380,5,508,35"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="557,5,728,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="776,5,819,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="868,5,921,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0c4d2bd0695737095313d7dc47ce120c"></a><!-- doxytag: member="proto.h::ewald_force" ref="a0c4d2bd0695737095313d7dc47ce120c" args="(int ii, int jj, int kk, double x[3], double force[3])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ewald_force </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>iii</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>jjj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>kkk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>x</em>[3], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>force</em>[3]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the force correction term (difference between full force of infinite lattice and nearest image) by Ewald summation. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03411">3411</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03079">ewald_init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> alpha, r2;
  <span class="keywordtype">double</span> r, val, hdotx, dx[3];
  <span class="keywordtype">int</span> i, h[3], n[3], h2;

  alpha = 2.0;

  <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
    force[i] = 0;

  <span class="keywordflow">if</span>(iii == 0 &amp;&amp; jjj == 0 &amp;&amp; kkk == 0)
    <span class="keywordflow">return</span>;

  r2 = x[0] * x[0] + x[1] * x[1] + x[2] * x[2];

  <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
    force[i] += x[i] / (r2 * sqrt(r2));

  <span class="keywordflow">for</span>(n[0] = -4; n[0] &lt;= 4; n[0]++)
    <span class="keywordflow">for</span>(n[1] = -4; n[1] &lt;= 4; n[1]++)
      <span class="keywordflow">for</span>(n[2] = -4; n[2] &lt;= 4; n[2]++)
        {
          <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
            dx[i] = x[i] - n[i];

          r = sqrt(dx[0] * dx[0] + dx[1] * dx[1] + dx[2] * dx[2]);

          val = erfc(alpha * r) + 2 * alpha * r / sqrt(M_PI) * exp(-alpha * alpha * r * r);

          <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
            force[i] -= dx[i] / (r * r * r) * val;
        }

  <span class="keywordflow">for</span>(h[0] = -4; h[0] &lt;= 4; h[0]++)
    <span class="keywordflow">for</span>(h[1] = -4; h[1] &lt;= 4; h[1]++)
      <span class="keywordflow">for</span>(h[2] = -4; h[2] &lt;= 4; h[2]++)
        {
          hdotx = x[0] * h[0] + x[1] * h[1] + x[2] * h[2];
          h2 = h[0] * h[0] + h[1] * h[1] + h[2] * h[2];

          <span class="keywordflow">if</span>(h2 &gt; 0)
            {
              val = 2.0 / ((double) h2) * exp(-M_PI * M_PI * h2 / (alpha * alpha)) * sin(2 * M_PI * hdotx);

              <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
                force[i] -= h[i] * val;
            }
        }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a0c4d2bd0695737095313d7dc47ce120c_icgraph.png" border="0" usemap="#proto_8h_a0c4d2bd0695737095313d7dc47ce120c_icgraph" alt=""/></div>
<map name="proto_8h_a0c4d2bd0695737095313d7dc47ce120c_icgraph" id="proto_8h_a0c4d2bd0695737095313d7dc47ce120c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a47f99270d9b0b0f75d86b3b9d078dff6" title="ewald_init" alt="" coords="153,5,236,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="285,5,352,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="401,5,455,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a47f99270d9b0b0f75d86b3b9d078dff6"></a><!-- doxytag: member="proto.h::ewald_init" ref="a47f99270d9b0b0f75d86b3b9d078dff6" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ewald_init </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function initializes tables with the correction force and the correction potential due to the periodic images of a point mass located at the origin. These corrections are obtained by Ewald summation. (See Hernquist, Bouchet, Suto, ApJS, 1991, 75, 231) The correction fields are used to obtain the full periodic force if periodic boundaries combined with the pure tree algorithm are used. For the TreePM algorithm, the Ewald correction is not used.</p>
<p>The correction fields are stored on disk once they are computed. If a corresponding file is found, they are loaded from disk to speed up the initialization. The Ewald summation is done in parallel, i.e. the processors share the work to compute the tables if needed. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03079">3079</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="forcetree_8c_source.html#l00045">EN</a>, <a class="el" href="forcetree_8c_source.html#l03411">ewald_force()</a>, <a class="el" href="forcetree_8c_source.html#l03370">ewald_psi()</a>, <a class="el" href="forcetree_8c_source.html#l00053">fac_intp</a>, <a class="el" href="forcetree_8c_source.html#l00049">fcorrx</a>, <a class="el" href="forcetree_8c_source.html#l00050">fcorry</a>, <a class="el" href="forcetree_8c_source.html#l00051">fcorrz</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="io_8c_source.html#l01139">my_fread()</a>, <a class="el" href="io_8c_source.html#l01122">my_fwrite()</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="forcetree_8c_source.html#l00052">potcorr</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, k, beg, len, size, n, task, count;
  <span class="keywordtype">double</span> x[3], force[3];
  <span class="keywordtype">char</span> buf[200];
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;initialize Ewald correction...\n&quot;</span>);
      fflush(stdout);
    }

<span class="preprocessor">#ifdef DOUBLEPRECISION</span>
<span class="preprocessor"></span>  sprintf(buf, <span class="stringliteral">&quot;ewald_spc_table_%d_dbl.dat&quot;</span>, <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  sprintf(buf, <span class="stringliteral">&quot;ewald_spc_table_%d.dat&quot;</span>, <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>((fd = fopen(buf, <span class="stringliteral">&quot;r&quot;</span>)))
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;\nreading Ewald tables from file `%s&#39;\n&quot;</span>, buf);
          fflush(stdout);
        }

      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[0][0][0], <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[0][0][0], <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[0][0][0], <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[0][0][0], <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
      fclose(fd);
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;\nNo Ewald tables in file `%s&#39; found.\nRecomputing them...\n&quot;</span>, buf);
          fflush(stdout);
        }

      <span class="comment">/* ok, let&#39;s recompute things. Actually, we do that in parallel. */</span>

      size = (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) / <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>;


      beg = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * size;
      len = size;
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == (<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> - 1))
        len = (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) - beg;

      <span class="keywordflow">for</span>(i = 0, count = 0; i &lt;= EN; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt;= EN; j++)
          <span class="keywordflow">for</span>(k = 0; k &lt;= EN; k++)
            {
              n = (i * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) + j) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) + k;
              <span class="keywordflow">if</span>(n &gt;= beg &amp;&amp; n &lt; (beg + len))
                {
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
                    {
                      <span class="keywordflow">if</span>((count % (len / 20)) == 0)
                        {
                          printf(<span class="stringliteral">&quot;%4.1f percent done\n&quot;</span>, count / (len / 100.0));
                          fflush(stdout);
                        }
                    }

                  x[0] = 0.5 * ((double) i) / EN;
                  x[1] = 0.5 * ((double) j) / EN;
                  x[2] = 0.5 * ((double) k) / EN;

                  <a class="code" href="forcetree_8c.html#a49e4b7c0d57d0ab446b4ec38f3618925">ewald_force</a>(i, j, k, x, force);

                  <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k] = force[0];
                  <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k] = force[1];
                  <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k] = force[2];

                  <span class="keywordflow">if</span>(i + j + k == 0)
                    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k] = 2.8372975;
                  <span class="keywordflow">else</span>
                    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k] = <a class="code" href="forcetree_8c.html#a4a219224b239f0c20497e54ae421f134">ewald_psi</a>(x);

                  count++;
                }
            }

      <span class="keywordflow">for</span>(task = 0; task &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; task++)
        {
          beg = task * size;
          len = size;
          <span class="keywordflow">if</span>(task == (NTask - 1))
            len = (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) - beg;

<span class="preprocessor">#ifdef DOUBLEPRECISION</span>
<span class="preprocessor"></span>          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
          MPI_Bcast(&amp;<a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;\nwriting Ewald tables to file `%s&#39;\n&quot;</span>, buf);
          fflush(stdout);

          <span class="keywordflow">if</span>((fd = fopen(buf, <span class="stringliteral">&quot;w&quot;</span>)))
            {
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[0][0][0], <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[0][0][0], <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[0][0][0], <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[0][0][0], <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> + 1), fd);
              fclose(fd);
            }
        }
    }

  <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a> = 2 * <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;

  <span class="keywordflow">for</span>(i = 0; i &lt;= EN; i++)
    <span class="keywordflow">for</span>(j = 0; j &lt;= EN; j++)
      <span class="keywordflow">for</span>(k = 0; k &lt;= EN; k++)
        {
          <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k] /= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
          <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k] /= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
          <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k] /= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
          <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k] /= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
        }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;initialization of periodic boundaries finished.\n&quot;</span>);
      fflush(stdout);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a47f99270d9b0b0f75d86b3b9d078dff6_cgraph.png" border="0" usemap="#proto_8h_a47f99270d9b0b0f75d86b3b9d078dff6_cgraph" alt=""/></div>
<map name="proto_8h_a47f99270d9b0b0f75d86b3b9d078dff6_cgraph" id="proto_8h_a47f99270d9b0b0f75d86b3b9d078dff6_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a49e4b7c0d57d0ab446b4ec38f3618925" title="ewald_force" alt="" coords="140,5,236,35"/><area shape="rect" id="node5" href="forcetree_8c.html#a4a219224b239f0c20497e54ae421f134" title="ewald_psi" alt="" coords="147,59,229,88"/><area shape="rect" id="node7" href="io_8c.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="147,112,229,141"/><area shape="rect" id="node13" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="147,165,229,195"/><area shape="rect" id="node9" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="285,139,352,168"/><area shape="rect" id="node11" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="400,139,557,168"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a47f99270d9b0b0f75d86b3b9d078dff6_icgraph.png" border="0" usemap="#proto_8h_a47f99270d9b0b0f75d86b3b9d078dff6_icgraph" alt=""/></div>
<map name="proto_8h_a47f99270d9b0b0f75d86b3b9d078dff6_icgraph" id="proto_8h_a47f99270d9b0b0f75d86b3b9d078dff6_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="139,5,205,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="255,5,308,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa0657e3de6bfb76715c14ddd72d25e58"></a><!-- doxytag: member="proto.h::ewald_pot_corr" ref="aa0657e3de6bfb76715c14ddd72d25e58" args="(double dx, double dy, double dz)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double ewald_pot_corr </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dz</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function looks up the correction potential due to the infinite number of periodic particle/node images. We here use tri-linear interpolation to get it from the precomputed table, which contains one octant around the target particle at the origin. The other octants are obtained from it by exploiting symmetry properties. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03317">3317</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="forcetree_8c_source.html#l00045">EN</a>, <a class="el" href="forcetree_8c_source.html#l00053">fac_intp</a>, <a class="el" href="forcetree_8c_source.html#l00052">potcorr</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l02216">force_treeevaluate_potential()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, k;
  <span class="keywordtype">double</span> u, v, w;
  <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;

  <span class="keywordflow">if</span>(dx &lt; 0)
    dx = -dx;

  <span class="keywordflow">if</span>(dy &lt; 0)
    dy = -dy;

  <span class="keywordflow">if</span>(dz &lt; 0)
    dz = -dz;

  u = dx * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
  i = (int) u;
  <span class="keywordflow">if</span>(i &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    i = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  u -= i;
  v = dy * fac_intp;
  j = (int) v;
  <span class="keywordflow">if</span>(j &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    j = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  v -= j;
  w = dz * fac_intp;
  k = (int) w;
  <span class="keywordflow">if</span>(k &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
    k = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
  w -= k;

  f1 = (1 - u) * (1 - v) * (1 - w);
  f2 = (1 - u) * (1 - v) * (w);
  f3 = (1 - u) * (v) * (1 - w);
  f4 = (1 - u) * (v) * (w);
  f5 = (u) * (1 - v) * (1 - w);
  f6 = (u) * (1 - v) * (w);
  f7 = (u) * (v) * (1 - w);
  f8 = (u) * (v) * (w);

  <span class="keywordflow">return</span> <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k] * f1 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j][k + 1] * f2 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j + 1][k] * f3 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i][j + 1][k + 1] * f4 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i + 1][j][k] * f5 +
    <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i + 1][j][k + 1] * f6 + <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#a7a88fa4a0ea6d18436481c44288646a0">potcorr</a>[i + 1][j + 1][k + 1] * f8;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aa0657e3de6bfb76715c14ddd72d25e58_icgraph.png" border="0" usemap="#proto_8h_aa0657e3de6bfb76715c14ddd72d25e58_icgraph" alt=""/></div>
<map name="proto_8h_aa0657e3de6bfb76715c14ddd72d25e58_icgraph" id="proto_8h_aa0657e3de6bfb76715c14ddd72d25e58_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a804166b1847da509d8fe57072b40d5f9" title="force_treeevaluate_potential" alt="" coords="173,32,379,61"/><area shape="rect" id="node5" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="428,32,569,61"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="619,5,837,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="885,32,928,61"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="977,32,1031,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4a219224b239f0c20497e54ae421f134"></a><!-- doxytag: member="proto.h::ewald_psi" ref="a4a219224b239f0c20497e54ae421f134" args="(double x[3])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double ewald_psi </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>x</em>[3]</td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the potential correction term by means of Ewald summation. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l03370">3370</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l03079">ewald_init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> alpha, psi;
  <span class="keywordtype">double</span> r, sum1, sum2, hdotx;
  <span class="keywordtype">double</span> dx[3];
  <span class="keywordtype">int</span> i, n[3], h[3], h2;

  alpha = 2.0;

  <span class="keywordflow">for</span>(n[0] = -4, sum1 = 0; n[0] &lt;= 4; n[0]++)
    <span class="keywordflow">for</span>(n[1] = -4; n[1] &lt;= 4; n[1]++)
      <span class="keywordflow">for</span>(n[2] = -4; n[2] &lt;= 4; n[2]++)
        {
          <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
            dx[i] = x[i] - n[i];

          r = sqrt(dx[0] * dx[0] + dx[1] * dx[1] + dx[2] * dx[2]);
          sum1 += erfc(alpha * r) / r;
        }

  <span class="keywordflow">for</span>(h[0] = -4, sum2 = 0; h[0] &lt;= 4; h[0]++)
    <span class="keywordflow">for</span>(h[1] = -4; h[1] &lt;= 4; h[1]++)
      <span class="keywordflow">for</span>(h[2] = -4; h[2] &lt;= 4; h[2]++)
        {
          hdotx = x[0] * h[0] + x[1] * h[1] + x[2] * h[2];
          h2 = h[0] * h[0] + h[1] * h[1] + h[2] * h[2];
          <span class="keywordflow">if</span>(h2 &gt; 0)
            sum2 += 1 / (M_PI * h2) * exp(-M_PI * M_PI * h2 / (alpha * alpha)) * cos(2 * M_PI * hdotx);
        }

  r = sqrt(x[0] * x[0] + x[1] * x[1] + x[2] * x[2]);

  psi = M_PI / (alpha * alpha) - sum1 - sum2 + 1 / r;

  <span class="keywordflow">return</span> psi;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a4a219224b239f0c20497e54ae421f134_icgraph.png" border="0" usemap="#proto_8h_a4a219224b239f0c20497e54ae421f134_icgraph" alt=""/></div>
<map name="proto_8h_a4a219224b239f0c20497e54ae421f134_icgraph" id="proto_8h_a4a219224b239f0c20497e54ae421f134_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a47f99270d9b0b0f75d86b3b9d078dff6" title="ewald_init" alt="" coords="137,5,220,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="269,5,336,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="385,5,439,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a10281a87abe1e07d6ca603de6a533345"></a><!-- doxytag: member="proto.h::fill_Tab_IO_Labels" ref="a10281a87abe1e07d6ca603de6a533345" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void fill_Tab_IO_Labels </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function associates a short 4-character block name with each block number. This is stored in front of each block for snapshot FileFormat=2. If one wants to add a new output-block, this function should be augmented accordingly. </p>

<p><p>&lt; total number of defined 0 0 for snapshot files. Must be equal to the number of entries in "enum iofields" </p>
</p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00566">566</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00669">IO_ACCEL</a>, <a class="el" href="allvars_8h_source.html#l00670">IO_DTENTR</a>, <a class="el" href="allvars_8h_source.html#l00667">IO_HSML</a>, <a class="el" href="allvars_8h_source.html#l00663">IO_ID</a>, <a class="el" href="allvars_8h_source.html#l00664">IO_MASS</a>, <a class="el" href="allvars_8h_source.html#l00661">IO_POS</a>, <a class="el" href="allvars_8h_source.html#l00668">IO_POT</a>, <a class="el" href="allvars_8h_source.html#l00666">IO_RHO</a>, <a class="el" href="allvars_8h_source.html#l00671">IO_TSTP</a>, <a class="el" href="allvars_8h_source.html#l00665">IO_U</a>, <a class="el" href="allvars_8h_source.html#l00662">IO_VEL</a>, and <a class="el" href="allvars_8c_source.html#l00167">Tab_IO_Labels</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00031">read_ic()</a>, and <a class="el" href="io_8c_source.html#l00033">savepositions()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keyword">enum</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> i;

  <span class="keywordflow">for</span>(i = 0; i &lt; IO_NBLOCKS; i++)
    <span class="keywordflow">switch</span> (i)
      {
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a0207eb67d96fe97fb8158c42af624f8f">IO_POS</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a0207eb67d96fe97fb8158c42af624f8f">IO_POS</a>], <span class="stringliteral">&quot;POS &quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aa4c3992546632e0db8015ebe534c0282">IO_VEL</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aa4c3992546632e0db8015ebe534c0282">IO_VEL</a>], <span class="stringliteral">&quot;VEL &quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>], <span class="stringliteral">&quot;ID  &quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a72e1cc8b602ab38f0f3491464ed82063">IO_MASS</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a72e1cc8b602ab38f0f3491464ed82063">IO_MASS</a>], <span class="stringliteral">&quot;MASS&quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>], <span class="stringliteral">&quot;U   &quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a8dd43018a3f2d1caed951b249a38b106">IO_RHO</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a8dd43018a3f2d1caed951b249a38b106">IO_RHO</a>], <span class="stringliteral">&quot;RHO &quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a429c6a7a56e3b53597bd1eb72b87f941">IO_HSML</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a429c6a7a56e3b53597bd1eb72b87f941">IO_HSML</a>], <span class="stringliteral">&quot;HSML&quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>], <span class="stringliteral">&quot;POT &quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>], <span class="stringliteral">&quot;ACCE&quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>], <span class="stringliteral">&quot;ENDT&quot;</span>, 4);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>:
        strncpy(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>], <span class="stringliteral">&quot;TSTP&quot;</span>, 4);
        <span class="keywordflow">break</span>;
      }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a10281a87abe1e07d6ca603de6a533345_icgraph.png" border="0" usemap="#proto_8h_a10281a87abe1e07d6ca603de6a533345_icgraph" alt=""/></div>
<map name="proto_8h_a10281a87abe1e07d6ca603de6a533345_icgraph" id="proto_8h_a10281a87abe1e07d6ca603de6a533345_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="208,5,275,35"/><area shape="rect" id="node11" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="187,59,296,88"/><area shape="rect" id="node5" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="433,5,473,35"/><area shape="rect" id="node7" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="611,5,677,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="727,32,780,61"/><area shape="rect" id="node13" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="344,59,563,88"/><area shape="rect" id="node15" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="623,59,665,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aea8fa222a10c4796687c6ff25550cd74"></a><!-- doxytag: member="proto.h::fill_write_buffer" ref="aea8fa222a10c4796687c6ff25550cd74" args="(enum iofields blocknr, int *pindex, int pc, int type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void fill_write_buffer </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a>&nbsp;</td>
          <td class="paramname"> <em>blocknr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>startindex</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>pc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function fills the write buffer with particle data. New output blocks can in principle be added here. </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas </p>
</p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00129">129</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="hydra_8c_source.html#l00019">a3inv</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="density_8c_source.html#l00022">boxSize</a>, <a class="el" href="allvars_8c_source.html#l00102">CommBuffer</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00555">sph_particle_data::Density</a>, <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="allvars_8h_source.html#l00554">sph_particle_data::Entropy</a>, <a class="el" href="timestep_8c_source.html#l00013">fac1</a>, <a class="el" href="timestep_8c_source.html#l00013">fac2</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="allvars_8h_source.html#l00071">GAMMA_MINUS1</a>, <a class="el" href="driftfac_8c_source.html#l00105">get_gravkick_factor()</a>, <a class="el" href="driftfac_8c_source.html#l00142">get_hydrokick_factor()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00562">sph_particle_data::HydroAccel</a>, <a class="el" href="allvars_8h_source.html#l00526">particle_data::ID</a>, <a class="el" href="allvars_8h_source.html#l00669">IO_ACCEL</a>, <a class="el" href="allvars_8h_source.html#l00670">IO_DTENTR</a>, <a class="el" href="allvars_8h_source.html#l00667">IO_HSML</a>, <a class="el" href="allvars_8h_source.html#l00663">IO_ID</a>, <a class="el" href="allvars_8h_source.html#l00664">IO_MASS</a>, <a class="el" href="allvars_8h_source.html#l00661">IO_POS</a>, <a class="el" href="allvars_8h_source.html#l00668">IO_POT</a>, <a class="el" href="allvars_8h_source.html#l00666">IO_RHO</a>, <a class="el" href="allvars_8h_source.html#l00671">IO_TSTP</a>, <a class="el" href="allvars_8h_source.html#l00665">IO_U</a>, <a class="el" href="allvars_8h_source.html#l00662">IO_VEL</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00310">global_data_all_processes::MinEgySpec</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00386">global_data_all_processes::PM_Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00523">particle_data::Potential</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, and <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>.</p>

<p>Referenced by <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> n, k, pindex;
  <span class="keywordtype">float</span> *fp;

<span class="preprocessor">#ifdef LONGIDS</span>
<span class="preprocessor"></span>  <span class="keywordtype">long</span> <span class="keywordtype">long</span> *ip;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> *ip;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> <a class="code" href="density_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_gravkick_pm = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_gravkick, dt_hydrokick, <a class="code" href="hydra_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a> = 1, <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a>, <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a>;


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      a3inv = 1 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>);
      <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> = 1 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>);
      fac2 = 1 / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, 3 * <a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> - 2);
    }
  <span class="keywordflow">else</span>
    a3inv = <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> = fac2 = 1;

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    dt_gravkick_pm =
      <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>,
                          <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
      <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2);
  <span class="keywordflow">else</span>
    dt_gravkick_pm = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>


  fp = <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>;
  ip = <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>;

  pindex = *startindex;

  <span class="keywordflow">switch</span> (blocknr)
    {
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a0207eb67d96fe97fb8158c42af624f8f">IO_POS</a>:                <span class="comment">/* positions */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              {
                fp[k] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[k];
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>                boxSize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#ifdef LONG_X</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span>(k == 0)
                  boxSize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> * LONG_X;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span>(k == 1)
                  boxSize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> * LONG_Y;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span>(k == 2)
                  boxSize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> * LONG_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                <span class="keywordflow">while</span>(fp[k] &lt; 0)
                  fp[k] += boxSize;
                <span class="keywordflow">while</span>(fp[k] &gt;= boxSize)
                  fp[k] -= boxSize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              }
            n++;
            fp += 3;
          }
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aa4c3992546632e0db8015ebe534c0282">IO_VEL</a>:                <span class="comment">/* velocities */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
              {
                dt_gravkick =
                  <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Ti_begstep,
                                      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
                  <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Ti_begstep,
                                      (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Ti_begstep + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Ti_endstep) / 2);
                dt_hydrokick =
                  <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Ti_begstep,
                                       <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>) -
                  <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Ti_begstep,
                                       (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Ti_begstep + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Ti_endstep) / 2);
              }
            <span class="keywordflow">else</span>
              dt_gravkick = dt_hydrokick =
                (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              {
                fp[k] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[k] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[k] * dt_gravkick;
                <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == 0)
                  fp[k] += <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[k] * dt_hydrokick;
              }
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              fp[k] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].GravPM[k] * dt_gravkick_pm;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              fp[k] *= sqrt(a3inv);

            n++;
            fp += 3;
          }
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>:         <span class="comment">/* particle ID */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            *ip++ = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>;
            n++;
          }
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a72e1cc8b602ab38f0f3491464ed82063">IO_MASS</a>:               <span class="comment">/* particle mass */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            *fp++ = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
            n++;
          }
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>:                  <span class="comment">/* internal energy */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
<span class="preprocessor">#ifdef ISOTHERM_EQS</span>
<span class="preprocessor"></span>            *fp++ = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            *fp++ =
              <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a>,
                   <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> / <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a> * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[pindex].Density * a3inv, <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            n++;
          }
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a8dd43018a3f2d1caed951b249a38b106">IO_RHO</a>:                <span class="comment">/* density */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            *fp++ = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a>;
            n++;
          }
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a429c6a7a56e3b53597bd1eb72b87f941">IO_HSML</a>:               <span class="comment">/* SPH smoothing length */</span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            *fp++ = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
            n++;
          }
      <span class="keywordflow">break</span>;


    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>:                <span class="comment">/* gravitational potential */</span>
<span class="preprocessor">#ifdef OUTPUTPOTENTIAL</span>
<span class="preprocessor"></span>      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            *fp++ = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a>;
            n++;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>:              <span class="comment">/* acceleration */</span>
<span class="preprocessor">#ifdef OUTPUTACCELERATION</span>
<span class="preprocessor"></span>      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              fp[k] = <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].GravAccel[k];
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              fp[k] += <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].GravPM[k];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == 0)
              <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                fp[k] += fac2 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[pindex].HydroAccel[k];
            fp += 3;
            n++;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>:             <span class="comment">/* rate of change of entropy */</span>
<span class="preprocessor">#ifdef OUTPUTCHANGEOFENTROPY</span>
<span class="preprocessor"></span>      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            *fp++ = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a>;
            n++;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>:               <span class="comment">/* timestep  */</span>
<span class="preprocessor">#ifdef OUTPUTTIMESTEP</span>
<span class="preprocessor"></span>
      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].Type == type)
          {
            *fp++ = (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[pindex].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
            n++;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;

    }

  *startindex = pindex;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aea8fa222a10c4796687c6ff25550cd74_cgraph.png" border="0" usemap="#proto_8h_aea8fa222a10c4796687c6ff25550cd74_cgraph" alt=""/></div>
<map name="proto_8h_aea8fa222a10c4796687c6ff25550cd74_cgraph" id="proto_8h_aea8fa222a10c4796687c6ff25550cd74_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="219,5,277,35"/><area shape="rect" id="node5" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="175,59,321,88"/><area shape="rect" id="node7" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="171,112,325,141"/><area shape="rect" id="node9" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="225,165,271,195"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aea8fa222a10c4796687c6ff25550cd74_icgraph.png" border="0" usemap="#proto_8h_aea8fa222a10c4796687c6ff25550cd74_icgraph" alt=""/></div>
<map name="proto_8h_aea8fa222a10c4796687c6ff25550cd74_icgraph" id="proto_8h_aea8fa222a10c4796687c6ff25550cd74_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="171,32,248,61"/><area shape="rect" id="node5" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="296,32,405,61"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="453,5,672,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="720,32,763,61"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="812,32,865,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a78ed439b8a1cb93647a2b9de998d9269"></a><!-- doxytag: member="proto.h::find_dt_displacement_constraint" ref="a78ed439b8a1cb93647a2b9de998d9269" args="(double hfac)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void find_dt_displacement_constraint </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>hfac</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes an upper limit ('dt_displacement') to the global timestep of the system based on the rms velocities of particles. For cosmological simulations, the criterion used is that the rms displacement should be at most a fraction MaxRMSDisplacementFac of the mean particle separation. Note that the latter is estimated using the assigned particle masses, separately for each particle type. If comoving integration is not used, the function imposes no constraint on the timestep. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>hfac</em>&nbsp;</td><td>should be a^2*H(a) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00566">566</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00393">global_data_all_processes::Asmth</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="timestep_8c_source.html#l00014">dt_displacement</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00440">global_data_all_processes::MaxRMSDisplacementFac</a>, <a class="el" href="allvars_8h_source.html#l00438">global_data_all_processes::MaxSizeTimestep</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00341">global_data_all_processes::OmegaBaryon</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, and <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, type, *temp;
  <span class="keywordtype">int</span> count[6];
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> count_sum[6];
  <span class="keywordtype">double</span> v[6], v_sum[6], mim[6], min_mass[6];
  <span class="keywordtype">double</span> dt, dmean, asmth = 0;

  <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
        {
          count[type] = 0;
          v[type] = 0;
          mim[type] = 1.0e30;
        }

      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
        {
          v[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] += P[i].Vel[0] * P[i].Vel[0] + P[i].Vel[1] * P[i].Vel[1] + P[i].Vel[2] * P[i].Vel[2];
          <span class="keywordflow">if</span>(mim[P[i].Type] &gt; P[i].Mass)
            mim[P[i].Type] = P[i].Mass;
          count[P[i].Type]++;
        }

      MPI_Allreduce(v, v_sum, 6, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
      MPI_Allreduce(mim, min_mass, 6, MPI_DOUBLE, MPI_MIN, MPI_COMM_WORLD);

      temp = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * 6 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
      MPI_Allgather(count, 6, MPI_INT, temp, 6, MPI_INT, MPI_COMM_WORLD);
      <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
        {
          count_sum[i] = 0;
          <span class="keywordflow">for</span>(j = 0; j &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; j++)
            count_sum[i] += temp[j * 6 + i];
        }
      free(temp);

      <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
        {
          <span class="keywordflow">if</span>(count_sum[type] &gt; 0)
            {
              <span class="keywordflow">if</span>(type == 0)
                dmean =
                  <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(min_mass[type] / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5656f8668fd420a86cb7372869745fee">OmegaBaryon</a> * 3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>)),
                      1.0 / 3);
              <span class="keywordflow">else</span>
                dmean =
                  <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(min_mass[type] /
                      ((<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5656f8668fd420a86cb7372869745fee">OmegaBaryon</a>) * 3 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>)),
                      1.0 / 3);

              dt = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a988ecf1fcfe5e61ff9ac29792c816c24">MaxRMSDisplacementFac</a> * hfac * dmean / sqrt(v_sum[type] / count_sum[type]);

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>              asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[0];
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(((1 &lt;&lt; type) &amp; (PLACEHIGHRESREGION)))
                asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[1];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(asmth &lt; dmean)
                dt = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a988ecf1fcfe5e61ff9ac29792c816c24">MaxRMSDisplacementFac</a> * hfac * asmth / sqrt(v_sum[type] / count_sum[type]);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
                printf(<span class="stringliteral">&quot;type=%d  dmean=%g asmth=%g minmass=%g a=%g  sqrt(&lt;p^2&gt;)=%g  dlogmax=%g\n&quot;</span>,
                       type, dmean, asmth, min_mass[type], <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, sqrt(v_sum[type] / count_sum[type]), dt);

              <span class="keywordflow">if</span>(dt &lt; <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a>)
                <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a> = dt;
            }
        }

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;displacement time constraint: %g  (%g)\n&quot;</span>, <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a78ed439b8a1cb93647a2b9de998d9269_cgraph.png" border="0" usemap="#proto_8h_a78ed439b8a1cb93647a2b9de998d9269_cgraph" alt=""/></div>
<map name="proto_8h_a78ed439b8a1cb93647a2b9de998d9269_cgraph" id="proto_8h_a78ed439b8a1cb93647a2b9de998d9269_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="284,5,329,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a78ed439b8a1cb93647a2b9de998d9269_icgraph.png" border="0" usemap="#proto_8h_a78ed439b8a1cb93647a2b9de998d9269_icgraph" alt=""/></div>
<map name="proto_8h_a78ed439b8a1cb93647a2b9de998d9269_icgraph" id="proto_8h_a78ed439b8a1cb93647a2b9de998d9269_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="283,5,491,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="539,5,581,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="631,5,684,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac028b474d53a40e79377b7ae5dde636a"></a><!-- doxytag: member="proto.h::find_files" ref="ac028b474d53a40e79377b7ae5dde636a" args="(char *fname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int find_files </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fname</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function determines onto how many files a given snapshot is distributed. </p>

<p>Definition at line <a class="el" href="read__ic_8c_source.html#l00615">615</a> of file <a class="el" href="read__ic_8c_source.html">read_ic.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="allvars_8c_source.html#l00162">header</a>, <a class="el" href="allvars_8h_source.html#l00280">global_data_all_processes::ICFormat</a>, <a class="el" href="allvars_8h_source.html#l00642">io_header::num_files</a>, <a class="el" href="read__ic_8c_source.html#l00764">read_header_attributes_in_hdf5()</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00031">read_ic()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>;
  <span class="keywordtype">char</span> buf[200], buf1[200];
  <span class="keywordtype">int</span> dummy;

  sprintf(buf, <span class="stringliteral">&quot;%s.%d&quot;</span>, fname, 0);
  sprintf(buf1, <span class="stringliteral">&quot;%s&quot;</span>, fname);

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
    {
      sprintf(buf, <span class="stringliteral">&quot;%s.%d.hdf5&quot;</span>, fname, 0);
      sprintf(buf1, <span class="stringliteral">&quot;%s.hdf5&quot;</span>, fname);
    }

<span class="preprocessor">#ifndef  HAVE_HDF5</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Code wasn&#39;t compiled with HDF5 support enabled!\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a> = 0;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      <span class="keywordflow">if</span>((fd = fopen(buf, <span class="stringliteral">&quot;r&quot;</span>)))
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
                {
                  fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
                  fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
                  fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
                  fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
                }

              fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
              fread(&amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>), 1, fd);
              fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
            }
          fclose(fd);

<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
            <a class="code" href="proto_8h.html#af87c21a0c70ac5e7d5f769b952d08fe9">read_header_attributes_in_hdf5</a>(buf);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }
    }

  MPI_Bcast(&amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>), MPI_BYTE, 0, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a> &gt; 0)
    <span class="keywordflow">return</span> <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      <span class="keywordflow">if</span>((fd = fopen(buf1, <span class="stringliteral">&quot;r&quot;</span>)))
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
                {
                  fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
                  fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
                  fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
                  fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
                }

              fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
              fread(&amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>), 1, fd);
              fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
            }
          fclose(fd);

<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
            <a class="code" href="proto_8h.html#af87c21a0c70ac5e7d5f769b952d08fe9">read_header_attributes_in_hdf5</a>(buf1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a> = 1;
        }
    }

  MPI_Bcast(&amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>), MPI_BYTE, 0, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a> &gt; 0)
    <span class="keywordflow">return</span> <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;\nCan&#39;t find initial conditions file.&quot;</span>);
      printf(<span class="stringliteral">&quot;neither as &#39;%s&#39;\nnor as &#39;%s&#39;\n&quot;</span>, buf, buf1);
      fflush(stdout);
    }

  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ac028b474d53a40e79377b7ae5dde636a_cgraph.png" border="0" usemap="#proto_8h_ac028b474d53a40e79377b7ae5dde636a_cgraph" alt=""/></div>
<map name="proto_8h_ac028b474d53a40e79377b7ae5dde636a_cgraph" id="proto_8h_ac028b474d53a40e79377b7ae5dde636a_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="211,5,277,35"/><area shape="rect" id="node7" href="proto_8h.html#af87c21a0c70ac5e7d5f769b952d08fe9" title="read_header_attributes_in_hdf5" alt="" coords="132,59,356,88"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="405,5,563,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ac028b474d53a40e79377b7ae5dde636a_icgraph.png" border="0" usemap="#proto_8h_ac028b474d53a40e79377b7ae5dde636a_icgraph" alt=""/></div>
<map name="proto_8h_ac028b474d53a40e79377b7ae5dde636a_icgraph" id="proto_8h_ac028b474d53a40e79377b7ae5dde636a_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="132,5,199,35"/><area shape="rect" id="node5" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="249,5,289,35"/><area shape="rect" id="node7" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="339,5,405,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="455,5,508,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a532b4637166ab194c1b1d0dee9f003f2"></a><!-- doxytag: member="proto.h::find_next_outputtime" ref="a532b4637166ab194c1b1d0dee9f003f2" args="(int time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int find_next_outputtime </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ti_curr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>this function returns the next output time that is equal or larger to ti_curr </p>

<p><p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29 </p>
</p>

<p>Definition at line <a class="el" href="run_8c_source.html#l00244">244</a> of file <a class="el" href="run_8c_source.html">run.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00501">global_data_all_processes::OutputListLength</a>, <a class="el" href="allvars_8h_source.html#l00352">global_data_all_processes::OutputListOn</a>, <a class="el" href="allvars_8h_source.html#l00500">global_data_all_processes::OutputListTimes</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="allvars_8h_source.html#l00370">global_data_all_processes::TimeBegin</a>, <a class="el" href="allvars_8h_source.html#l00358">global_data_all_processes::TimeBetSnapshot</a>, <a class="el" href="allvars_8h_source.html#l00372">global_data_all_processes::TimeMax</a>, and <a class="el" href="allvars_8h_source.html#l00359">global_data_all_processes::TimeOfFirstSnapshot</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>, and <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, ti, ti_next, iter = 0;
  <span class="keywordtype">double</span> next, time;

  ti_next = -1;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4e9d69a3dd88c6aef6f4afd640243950">OutputListOn</a>)
    {
      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a>; i++)
        {
          time = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7f3307450336a806e545661ba6c79ba5">OutputListTimes</a>[i];

          <span class="keywordflow">if</span>(time &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> &amp;&amp; time &lt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a>)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
                ti = log(time / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>) / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
              <span class="keywordflow">else</span>
                ti = (time - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>) / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

              <span class="keywordflow">if</span>(ti &gt;= ti_curr)
                {
                  <span class="keywordflow">if</span>(ti_next == -1)
                    ti_next = ti;

                  <span class="keywordflow">if</span>(ti_next &gt; ti)
                    ti_next = ti;
                }
            }
        }
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c02c06bb5214dcf72dd4eb757df8ad3">TimeBetSnapshot</a> &lt;= 1.0)
            {
              printf(<span class="stringliteral">&quot;TimeBetSnapshot &gt; 1.0 required for your simulation.\n&quot;</span>);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(13123);
            }
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c02c06bb5214dcf72dd4eb757df8ad3">TimeBetSnapshot</a> &lt;= 0.0)
            {
              printf(<span class="stringliteral">&quot;TimeBetSnapshot &gt; 0.0 required for your simulation.\n&quot;</span>);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(13123);
            }
        }

      time = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a18e4063fbc1f92e8c59d6e59c7b20631">TimeOfFirstSnapshot</a>;

      iter = 0;

      <span class="keywordflow">while</span>(time &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
            time *= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c02c06bb5214dcf72dd4eb757df8ad3">TimeBetSnapshot</a>;
          <span class="keywordflow">else</span>
            time += <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c02c06bb5214dcf72dd4eb757df8ad3">TimeBetSnapshot</a>;

          iter++;

          <span class="keywordflow">if</span>(iter &gt; 1000000)
            {
              printf(<span class="stringliteral">&quot;Can&#39;t determine next output time.\n&quot;</span>);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(110);
            }
        }

      <span class="keywordflow">while</span>(time &lt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a>)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
            ti = log(time / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>) / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
          <span class="keywordflow">else</span>
            ti = (time - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>) / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

          <span class="keywordflow">if</span>(ti &gt;= ti_curr)
            {
              ti_next = ti;
              <span class="keywordflow">break</span>;
            }

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
            time *= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c02c06bb5214dcf72dd4eb757df8ad3">TimeBetSnapshot</a>;
          <span class="keywordflow">else</span>
            time += <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c02c06bb5214dcf72dd4eb757df8ad3">TimeBetSnapshot</a>;

          iter++;

          <span class="keywordflow">if</span>(iter &gt; 1000000)
            {
              printf(<span class="stringliteral">&quot;Can&#39;t determine next output time.\n&quot;</span>);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(111);
            }
        }
    }

  <span class="keywordflow">if</span>(ti_next == -1)
    {
      ti_next = 2 * TIMEBASE;   <span class="comment">/* this will prevent any further output */</span>

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nThere is no valid time for a further snapshot file.\n&quot;</span>);
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        next = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> * exp(ti_next * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>);
      <span class="keywordflow">else</span>
        next = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> + ti_next * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nSetting next time for snapshot file to Time_next= %g\n\n&quot;</span>, next);
    }

  <span class="keywordflow">return</span> ti_next;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a532b4637166ab194c1b1d0dee9f003f2_cgraph.png" border="0" usemap="#proto_8h_a532b4637166ab194c1b1d0dee9f003f2_cgraph" alt=""/></div>
<map name="proto_8h_a532b4637166ab194c1b1d0dee9f003f2_cgraph" id="proto_8h_a532b4637166ab194c1b1d0dee9f003f2_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="213,5,280,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="328,5,485,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a532b4637166ab194c1b1d0dee9f003f2_icgraph.png" border="0" usemap="#proto_8h_a532b4637166ab194c1b1d0dee9f003f2_icgraph" alt=""/></div>
<map name="proto_8h_a532b4637166ab194c1b1d0dee9f003f2_icgraph" id="proto_8h_a532b4637166ab194c1b1d0dee9f003f2_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="480,5,547,35"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="213,59,432,88"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="596,32,649,61"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="492,59,535,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad52604af910b3e1677718d863ab09391"></a><!-- doxytag: member="proto.h::find_next_sync_point_and_drift" ref="ad52604af910b3e1677718d863ab09391" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void find_next_sync_point_and_drift </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function finds the next synchronization point of the system (i.e. the earliest point of time any of the particles needs a force computation), and drifts the system to this point of time. If the system drifts over the desired time of a snapshot file, the function will drift to this moment, generate an output, and then resume the drift. </p>

<p>Definition at line <a class="el" href="run_8c_source.html#l00151">151</a> of file <a class="el" href="run_8c_source.html">run.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="allvars_8h_source.html#l00420">global_data_all_processes::CPU_Predict</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="run_8c_source.html#l00244">find_next_outputtime()</a>, <a class="el" href="allvars_8c_source.html#l00040">Flag_FullStep</a>, <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00024">NumForceUpdate</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="io_8c_source.html#l00033">savepositions()</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8h_source.html#l00357">global_data_all_processes::SnapshotFileCount</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00379">global_data_all_processes::Ti_nextoutput</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="allvars_8h_source.html#l00370">global_data_all_processes::TimeBegin</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00371">global_data_all_processes::TimeStep</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, and <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> n, min, min_glob, flag, *temp;
  <span class="keywordtype">double</span> timeold;
  <span class="keywordtype">double</span> t0, t1;

  t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  timeold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;

  <span class="keywordflow">for</span>(n = 1, min = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].Ti_endstep; n &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; n++)
    <span class="keywordflow">if</span>(min &gt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_endstep)
      min = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>;

  MPI_Allreduce(&amp;min, &amp;min_glob, 1, MPI_INT, MPI_MIN, MPI_COMM_WORLD);

  <span class="comment">/* We check whether this is a full step where all particles are synchronized */</span>
  flag = 1;
  <span class="keywordflow">for</span>(n = 0; n &lt; NumPart; n++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_endstep &gt; min_glob)
      flag = 0;

  MPI_Allreduce(&amp;flag, &amp;<a class="code" href="allvars_8c.html#a6343a9f3619e77c1796309b8deda7f50">Flag_FullStep</a>, 1, MPI_INT, MPI_MIN, MPI_COMM_WORLD);

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(min_glob &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>)
    {
      min_glob = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a>;
      <a class="code" href="allvars_8c.html#a6343a9f3619e77c1796309b8deda7f50">Flag_FullStep</a> = 1;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">/* Determine &#39;NumForceUpdate&#39;, i.e. the number of particles on this processor that are going to be active */</span>
  <span class="keywordflow">for</span>(n = 0, <a class="code" href="allvars_8c.html#a4c8b412a9883b4f6e0e8962ba54fd4ef">NumForceUpdate</a> = 0; n &lt; NumPart; n++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Ti_endstep == min_glob)
<span class="preprocessor">#ifdef SELECTIVE_NO_GRAVITY</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(!((1 &lt;&lt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type) &amp; (SELECTIVE_NO_GRAVITY)))
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a4c8b412a9883b4f6e0e8962ba54fd4ef">NumForceUpdate</a>++;
    }

  <span class="comment">/* note: NumForcesSinceLastDomainDecomp has type &quot;long long&quot; */</span>
  temp = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a4c8b412a9883b4f6e0e8962ba54fd4ef">NumForceUpdate</a>, 1, MPI_INT, temp, 1, MPI_INT, MPI_COMM_WORLD);
  <span class="keywordflow">for</span>(n = 0; n &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; n++)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> += temp[n];
  free(temp);



  t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afb9d30620ea0dc8b9e46000e3ce0b3e3">CPU_Predict</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);

  <span class="keywordflow">while</span>(min_glob &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af1655016614a8c7ae59520abae300f67">Ti_nextoutput</a> &amp;&amp; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af1655016614a8c7ae59520abae300f67">Ti_nextoutput</a> &gt;= 0)
    {
      <a class="code" href="predict_8c.html#a02a8a27a7a75ce5cd6c2a27b4d641e31">move_particles</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af1655016614a8c7ae59520abae300f67">Ti_nextoutput</a>);

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af1655016614a8c7ae59520abae300f67">Ti_nextoutput</a>;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> * exp(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>);
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

<span class="preprocessor">#ifdef OUTPUTPOTENTIAL</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;
      <a class="code" href="domain_8c.html#ae8e3aa408eaab9544cb7f93e69185492">domain_Decomposition</a>();
      <a class="code" href="potential_8c.html#a04474459731219f9601aaefedb37ab27">compute_potential</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <a class="code" href="io_8c.html#a523730833804b6d92aa7f4dd474805c5">savepositions</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aac0d3fcbac688a31e6bda55ef819c44b">SnapshotFileCount</a>++);   <span class="comment">/* write snapshot file */</span>

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af1655016614a8c7ae59520abae300f67">Ti_nextoutput</a> = <a class="code" href="proto_8h.html#a532b4637166ab194c1b1d0dee9f003f2">find_next_outputtime</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af1655016614a8c7ae59520abae300f67">Ti_nextoutput</a> + 1);
    }

  <a class="code" href="predict_8c.html#a02a8a27a7a75ce5cd6c2a27b4d641e31">move_particles</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>, min_glob);

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> = min_glob;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> * exp(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>);
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - timeold;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad52604af910b3e1677718d863ab09391_cgraph.png" border="0" usemap="#proto_8h_ad52604af910b3e1677718d863ab09391_cgraph" alt=""/></div>
<map name="proto_8h_ad52604af910b3e1677718d863ab09391_cgraph" id="proto_8h_ad52604af910b3e1677718d863ab09391_cgraph">
<area shape="rect" id="node3" href="potential_8c.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="288,477,429,507"/><area shape="rect" id="node48" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="601,949,668,979"/><area shape="rect" id="node52" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="600,1003,669,1032"/><area shape="rect" id="node55" href="domain_8c.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="272,1053,445,1083"/><area shape="rect" id="node90" href="proto_8h.html#a532b4637166ab194c1b1d0dee9f003f2" title="find_next_outputtime" alt="" coords="280,240,437,269"/><area shape="rect" id="node93" href="predict_8c.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="300,1159,417,1188"/><area shape="rect" id="node109" href="io_8c.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="304,896,413,925"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="1093,557,1160,587"/><area shape="rect" id="node9" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="576,557,693,587"/><area shape="rect" id="node18" href="forcetree_8c.html#af29d257a1e4545ba4b9c3648444979b6" title="force_treeevaluate_potential" alt="" coords="532,344,737,373"/><area shape="rect" id="node23" href="forcetree_8c.html#abd9d86a6c08e77a4fa78fa76b96cdde7" title="force_treeevaluate_potential_shortrange" alt="" coords="493,611,776,640"/><area shape="rect" id="node26" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42" title="grav_tree_compare_key" alt="" coords="547,397,723,427"/><area shape="rect" id="node28" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97" title="pm_init_regionsize" alt="" coords="564,451,705,480"/><area shape="rect" id="node30" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4" title="pm_setup_nonperiodic_kernel" alt="" coords="528,504,741,533"/><area shape="rect" id="node32" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9" title="pmpotential_nonperiodic" alt="" coords="545,133,724,163"/><area shape="rect" id="node34" href="pm__periodic_8c.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="557,187,712,216"/><area shape="rect" id="node46" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="912,837,957,867"/><area shape="rect" id="node50" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91" title="set_softenings" alt="" coords="577,291,692,320"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1208,557,1365,587"/><area shape="rect" id="node11" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7" title="force_flag_localnodes" alt="" coords="856,504,1013,533"/><area shape="rect" id="node13" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="855,557,1015,587"/><area shape="rect" id="node16" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="828,781,1041,811"/><area shape="rect" id="node21" href="forcetree_8c.html#aa0657e3de6bfb76715c14ddd72d25e58" title="ewald_pot_corr" alt="" coords="876,371,993,400"/><area shape="rect" id="node36" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="867,107,1003,136"/><area shape="rect" id="node39" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888" title="force_treefree" alt="" coords="879,267,991,296"/><area shape="rect" id="node41" href="pm__periodic_8c.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="844,160,1025,189"/><area shape="rect" id="node44" href="pm__periodic_8c.html#a259e6f8400ee889c64bc667334060742" title="pm_init_periodic_free" alt="" coords="856,213,1013,243"/><area shape="rect" id="node57" href="predict_8c.html#adda9e167a16a53d1aa40180406950446" title="do_box_wrapping" alt="" coords="569,1056,700,1085"/><area shape="rect" id="node59" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="559,1211,711,1240"/><area shape="rect" id="node80" href="peano_8c.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="560,1264,709,1293"/><area shape="rect" id="node61" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c" title="domain_countToGo" alt="" coords="863,1101,1007,1131"/><area shape="rect" id="node63" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="839,1155,1031,1184"/><area shape="rect" id="node65" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca" title="domain_exchangeParticles" alt="" coords="839,941,1031,971"/><area shape="rect" id="node68" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9" title="domain_findExchangeNumbers" alt="" coords="824,1208,1045,1237"/><area shape="rect" id="node70" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e" title="domain_findExtent" alt="" coords="864,1261,1005,1291"/><area shape="rect" id="node72" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="871,1339,999,1368"/><area shape="rect" id="node75" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba" title="domain_shiftSplit" alt="" coords="869,995,1000,1024"/><area shape="rect" id="node77" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e" title="domain_sumCost" alt="" coords="868,1048,1001,1077"/><area shape="rect" id="node82" href="peano_8c.html#af3ffb253e14a79419d1effeee1b7261d" title="compare_key" alt="" coords="881,1392,988,1421"/><area shape="rect" id="node84" href="peano_8c.html#af744cef873e3093ba2924da8265d1711" title="reorder_gas" alt="" coords="885,1445,984,1475"/><area shape="rect" id="node86" href="peano_8c.html#afcb358154dd7fd5de8b4156f417fb0ba" title="reorder_particles" alt="" coords="869,1499,1000,1528"/><area shape="rect" id="node95" href="forcetree_8c.html#a04fb647ef783d5baeb9275d806c08365" title="force_update_len" alt="" coords="569,1371,700,1400"/><area shape="rect" id="node100" href="driftfac_8c.html#adadb384299eb936596574417d4b6b28c" title="get_drift_factor" alt="" coords="576,1477,693,1507"/><area shape="rect" id="node102" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="561,1317,708,1347"/><area shape="rect" id="node104" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="557,1424,712,1453"/><area shape="rect" id="node97" href="forcetree_8c.html#a4592b750f8555f580691103acf1e5366" title="force_update_node_len_local" alt="" coords="832,1552,1037,1581"/><area shape="rect" id="node111" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab" title="distribute_file" alt="" coords="581,896,688,925"/><area shape="rect" id="node115" href="io_8c.html#a10281a87abe1e07d6ca603de6a533345" title="fill_Tab_IO_Labels" alt="" coords="569,819,700,848"/><area shape="rect" id="node119" href="io_8c.html#a2b3f5bacd7313da0f3ffa55e41907481" title="write_file" alt="" coords="596,765,673,795"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad52604af910b3e1677718d863ab09391_icgraph.png" border="0" usemap="#proto_8h_ad52604af910b3e1677718d863ab09391_icgraph" alt=""/></div>
<map name="proto_8h_ad52604af910b3e1677718d863ab09391_icgraph" id="proto_8h_ad52604af910b3e1677718d863ab09391_icgraph">
<area shape="rect" id="node3" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="272,5,315,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="364,5,417,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8eaedfa5c6d72bca79b465003679ed89"></a><!-- doxytag: member="proto.h::force_create_empty_nodes" ref="a8eaedfa5c6d72bca79b465003679ed89" args="(int no, int topnode, int bits, int x, int y, int z, int *nodecount, int *nextfree)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_create_empty_nodes </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>no</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>topnode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bits</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>nodecount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>nextfree</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function recursively creates a set of empty tree nodes which corresponds to the top-level tree for the domain grid. This is done to ensure that this top-level tree is always "complete" so that we can easily associate the pseudo-particles of other CPUs with tree-nodes at a given level in the tree, even when the particle population is so sparse that some of these nodes are actually empty. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00292">292</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="forcetree_8c_source.html#l03040">dump_particles()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="peano_8c_source.html#l00263">peano_hilbert_key()</a>, <a class="el" href="allvars_8h_source.html#l00593">NODE::suns</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, and <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, k, n, sub, count;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[topnode].Daughter &gt;= 0)
    {
      <span class="keywordflow">for</span>(i = 0; i &lt; 2; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt; 2; j++)
          <span class="keywordflow">for</span>(k = 0; k &lt; 2; k++)
            {
              sub = 7 &amp; <a class="code" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df">peano_hilbert_key</a>((x &lt;&lt; 1) + i, (y &lt;&lt; 1) + j, (z &lt;&lt; 1) + k, bits);

              count = i + 2 * j + 4 * k;

              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[count] = *nextfree;


              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> = 0.5 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] + (2 * i - 1) * 0.25 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] + (2 * j - 1) * 0.25 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] + (2 * k - 1) * 0.25 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].len;

              <span class="keywordflow">for</span>(n = 0; n &lt; 8; n++)
                <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[*nextfree].u.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[n] = -1;

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[topnode].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + sub].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> == -1)
                <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[topnode].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + sub].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a>] = *nextfree;

              *nextfree = *nextfree + 1;
              *nodecount = *nodecount + 1;

              <span class="keywordflow">if</span>((*nodecount) &gt;= <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)
                {
                  printf(<span class="stringliteral">&quot;task %d: maximum number %d of tree-nodes reached.\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>);
                  printf(<span class="stringliteral">&quot;in create empty nodes\n&quot;</span>);
                  <a class="code" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0">dump_particles</a>();
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(11);
                }

              <a class="code" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89">force_create_empty_nodes</a>(*nextfree - 1, TopNodes[topnode].Daughter + sub,
                                       bits + 1, 2 * x + i, 2 * y + j, 2 * z + k, nodecount, nextfree);
            }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a8eaedfa5c6d72bca79b465003679ed89_cgraph.png" border="0" usemap="#proto_8h_a8eaedfa5c6d72bca79b465003679ed89_cgraph" alt=""/></div>
<map name="proto_8h_a8eaedfa5c6d72bca79b465003679ed89_cgraph" id="proto_8h_a8eaedfa5c6d72bca79b465003679ed89_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="505,37,625,66"/><area shape="rect" id="node7" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="813,37,880,66"/><area shape="rect" id="node12" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="252,106,447,135"/><area shape="rect" id="node17" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="496,154,635,183"/><area shape="rect" id="node5" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="683,37,765,66"/><area shape="rect" id="node9" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="928,37,1085,66"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a8eaedfa5c6d72bca79b465003679ed89_icgraph.png" border="0" usemap="#proto_8h_a8eaedfa5c6d72bca79b465003679ed89_icgraph" alt=""/></div>
<map name="proto_8h_a8eaedfa5c6d72bca79b465003679ed89_icgraph" id="proto_8h_a8eaedfa5c6d72bca79b465003679ed89_icgraph">
<area shape="rect" id="node4" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="252,109,412,139"/><area shape="rect" id="node6" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="461,109,579,139"/><area shape="rect" id="node8" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="628,56,769,85"/><area shape="rect" id="node17" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="649,109,748,139"/><area shape="rect" id="node22" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="644,163,753,192"/><area shape="rect" id="node10" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="819,5,1037,35"/><area shape="rect" id="node12" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1097,71,1140,100"/><area shape="rect" id="node14" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1201,111,1255,140"/><area shape="rect" id="node19" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="843,109,1013,139"/><area shape="rect" id="node24" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="908,163,948,192"/><area shape="rect" id="node26" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1085,149,1152,179"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aaabf16b5e99c9ac6bc6bbe039756bddb"></a><!-- doxytag: member="proto.h::force_exchange_pseudodata" ref="aaabf16b5e99c9ac6bc6bbe039756bddb" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_exchange_pseudodata </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function communicates the values of the multipole moments of the top-level tree-nodes of the domain grid. This data can then be used to update the pseudo-particles on each CPU accordingly. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00684">684</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00065">DomainMoment</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8h_source.html#l00199">DomainNODE::mass</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="allvars_8h_source.html#l00197">DomainNODE::s</a>, <a class="el" href="tags_8h_source.html#l00010">TAG_DMOM</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, <a class="el" href="allvars_8h_source.html#l00619">extNODE::vs</a>, and <a class="el" href="allvars_8h_source.html#l00198">DomainNODE::vs</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00671">force_update_pseudoparticles()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no;
  MPI_Status status;
  <span class="keywordtype">int</span> level, sendTask, recvTask;

  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>; i &lt;= <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <span class="comment">/* read out the multipole moments from the local base cells */</span>
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#ae047a14ee5331dc9d6e128cb6c5e95e4">s</a>[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[0];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#ae047a14ee5331dc9d6e128cb6c5e95e4">s</a>[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[1];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#ae047a14ee5331dc9d6e128cb6c5e95e4">s</a>[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[2];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#a52c312bfff90fd7236c7d1e176c03d9c">vs</a>[0] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[0];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#a52c312bfff90fd7236c7d1e176c03d9c">vs</a>[1] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[1];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#a52c312bfff90fd7236c7d1e176c03d9c">vs</a>[2] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[2];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#afb739de9da1eb6908f9064093e02e7bc">mass</a> = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].bitflags = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].maxsoft = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="comment">/* share the pseudo-particle data accross CPUs */</span>

  <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
    {
      sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
      recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ level;

      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[sendTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask] + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structDomainNODE.html">DomainNODE</a>),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a45efe3f9114b060471619398972c9d84">TAG_DMOM</a>,
                     &amp;<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[recvTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask] + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structDomainNODE.html">DomainNODE</a>),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a45efe3f9114b060471619398972c9d84">TAG_DMOM</a>, MPI_COMM_WORLD, &amp;status);
    }

}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aaabf16b5e99c9ac6bc6bbe039756bddb_icgraph.png" border="0" usemap="#proto_8h_aaabf16b5e99c9ac6bc6bbe039756bddb_icgraph" alt=""/></div>
<map name="proto_8h_aaabf16b5e99c9ac6bc6bbe039756bddb_icgraph" id="proto_8h_aaabf16b5e99c9ac6bc6bbe039756bddb_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="263,105,476,135"/><area shape="rect" id="node5" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="527,72,644,101"/><area shape="rect" id="node28" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="527,139,644,168"/><area shape="rect" id="node7" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="695,112,836,141"/><area shape="rect" id="node16" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="716,59,815,88"/><area shape="rect" id="node21" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="711,5,820,35"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="885,163,1104,192"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1164,97,1207,127"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1268,59,1321,88"/><area shape="rect" id="node18" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="909,59,1080,88"/><area shape="rect" id="node23" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="975,5,1015,35"/><area shape="rect" id="node25" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1152,19,1219,48"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a947a734f3bbba14d4092c7480880d3c7"></a><!-- doxytag: member="proto.h::force_flag_localnodes" ref="a947a734f3bbba14d4092c7480880d3c7" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_flag_localnodes </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function flags nodes in the top-level tree that are dependent on local particle data. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00834">834</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> no, i;

  <span class="comment">/* mark all top-level nodes */</span>

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <span class="keywordflow">while</span>(no &gt;= 0)
        {
          <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &amp; 1))
            <span class="keywordflow">break</span>;

          <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags |= 1;

          no = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;
        }
    }

  <span class="comment">/* mark top-level nodes that contain local particles */</span>

  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>; i &lt;= <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>; i++)
    {
      <span class="comment">/*</span>
<span class="comment">         if(DomainMoment[i].mass &gt; 0)</span>
<span class="comment">       */</span>
      {
        no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

        <span class="keywordflow">while</span>(no &gt;= 0)
          {
            <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &amp; 2))
              <span class="keywordflow">break</span>;

            <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags |= 2;

            no = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;
          }
      }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a947a734f3bbba14d4092c7480880d3c7_icgraph.png" border="0" usemap="#proto_8h_a947a734f3bbba14d4092c7480880d3c7_icgraph" alt=""/></div>
<map name="proto_8h_a947a734f3bbba14d4092c7480880d3c7_icgraph" id="proto_8h_a947a734f3bbba14d4092c7480880d3c7_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="213,109,331,139"/><area shape="rect" id="node5" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="380,56,521,85"/><area shape="rect" id="node14" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="401,109,500,139"/><area shape="rect" id="node19" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="396,163,505,192"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="571,5,789,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="849,71,892,100"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="953,111,1007,140"/><area shape="rect" id="node16" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="595,109,765,139"/><area shape="rect" id="node21" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="660,163,700,192"/><area shape="rect" id="node23" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="837,149,904,179"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad9e0a57b7577d64a315c142e197d292d"></a><!-- doxytag: member="proto.h::force_insert_pseudo_particles" ref="ad9e0a57b7577d64a315c142e197d292d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_insert_pseudo_particles </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>this function inserts pseudo-particles which will represent the mass distribution of the other CPUs. Initially, the mass of the pseudo-particles is set to zero, and their coordinate is set to the center of the domain-cell they correspond to. These quantities will be updated later on. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00346">346</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="allvars_8c_source.html#l00065">DomainMoment</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00199">DomainNODE::mass</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, <a class="el" href="allvars_8h_source.html#l00596">NODE::s</a>, <a class="el" href="allvars_8h_source.html#l00197">DomainNODE::s</a>, <a class="el" href="allvars_8h_source.html#l00593">NODE::suns</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, index, subnode, nn, th;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    {
      index = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#afb739de9da1eb6908f9064093e02e7bc">mass</a> = 0;
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#ae047a14ee5331dc9d6e128cb6c5e95e4">s</a>[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[index].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#ae047a14ee5331dc9d6e128cb6c5e95e4">s</a>[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[index].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1];
      <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#ae047a14ee5331dc9d6e128cb6c5e95e4">s</a>[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[index].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2];
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
    {
      <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>)
        {
          th = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;     <span class="comment">/* select index of first node in tree */</span>

          <span class="keywordflow">while</span>(1)
            {
              <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)     <span class="comment">/* we are dealing with an internal node */</span>
                {
                  <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)
                    <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(888);        <span class="comment">/* this can&#39;t be */</span>

                  subnode = 0;
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[0] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[0])
                    subnode += 1;
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[1] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[1])
                    subnode += 2;
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].s[2] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[2])
                    subnode += 4;

                  nn = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[subnode];

                  <span class="keywordflow">if</span>(nn &gt;= 0)   <span class="comment">/* ok, something is in the daughter slot already, need to continue */</span>
                    {
                      th = nn;
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="comment">/* here we have found an empty slot where we can </span>
<span class="comment">                       * attach the pseudo particle as a leaf </span>
<span class="comment">                       */</span>
                      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[subnode] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> + i;

                      <span class="keywordflow">break</span>;    <span class="comment">/* done for this pseudo particle */</span>
                    }
                }
              <span class="keywordflow">else</span>
                {
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(889);  <span class="comment">/* this can&#39;t be */</span>
                }
            }
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad9e0a57b7577d64a315c142e197d292d_cgraph.png" border="0" usemap="#proto_8h_ad9e0a57b7577d64a315c142e197d292d_cgraph" alt=""/></div>
<map name="proto_8h_ad9e0a57b7577d64a315c142e197d292d_cgraph" id="proto_8h_ad9e0a57b7577d64a315c142e197d292d_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="267,5,333,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="381,5,539,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad9e0a57b7577d64a315c142e197d292d_icgraph.png" border="0" usemap="#proto_8h_ad9e0a57b7577d64a315c142e197d292d_icgraph" alt=""/></div>
<map name="proto_8h_ad9e0a57b7577d64a315c142e197d292d_icgraph" id="proto_8h_ad9e0a57b7577d64a315c142e197d292d_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="268,109,428,139"/><area shape="rect" id="node5" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="477,109,595,139"/><area shape="rect" id="node7" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="644,56,785,85"/><area shape="rect" id="node16" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="665,109,764,139"/><area shape="rect" id="node21" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="660,163,769,192"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="835,5,1053,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1113,71,1156,100"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1217,111,1271,140"/><area shape="rect" id="node18" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="859,109,1029,139"/><area shape="rect" id="node23" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="924,163,964,192"/><area shape="rect" id="node25" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1101,149,1168,179"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae809fba68f599de9874f593b77d0bbfd"></a><!-- doxytag: member="proto.h::force_setupnonrecursive" ref="ae809fba68f599de9874f593b77d0bbfd" args="(int no)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_setupnonrecursive </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>no</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="ab98788ba31869c7bc55ce71b807d2ff2"></a><!-- doxytag: member="proto.h::force_treeallocate" ref="ab98788ba31869c7bc55ce71b807d2ff2" args="(int maxnodes, int maxpart)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_treeallocate </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>maxnodes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>maxpart</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function allocates the memory used for storage of the tree and of auxiliary arrays needed for tree-walk and link-lists. Usually, maxnodes approximately equal to 0.7*maxpart is sufficient to store the tree for up to maxpart particles. </p>

<p><p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition </p>
</p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02827">2827</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes_base</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="forcetree_8c_source.html#l00036">first_flag</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00045">MAXTOPNODES</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes_base</a>, <a class="el" href="forcetree_8c_source.html#l00031">NTAB</a>, <a class="el" href="forcetree_8c_source.html#l00033">shortrange_table</a>, <a class="el" href="forcetree_8c_source.html#l00033">shortrange_table_potential</a>, <a class="el" href="forcetree_8c_source.html#l00033">tabfac</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l00020">init()</a>, <a class="el" href="pm__periodic_8c_source.html#l00180">pmforce_periodic()</a>, <a class="el" href="pm__periodic_8c_source.html#l00693">pmpotential_periodic()</a>, and <a class="el" href="restart_8c_source.html#l00035">restart()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;
  <span class="keywordtype">size_t</span> bytes;
  <span class="keywordtype">double</span> allbytes = 0;
  <span class="keywordtype">double</span> u;

  <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> = maxnodes;

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a> = malloc(bytes = (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structNODE.html">NODE</a>))))
    {
      printf(<span class="stringliteral">&quot;failed to allocate memory for %d tree-nodes (%g MB).\n&quot;</span>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>, bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(3);
    }
  allbytes += bytes;

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a57932378336b142ac6e6a9ddb60dce3f">Extnodes_base</a> = malloc(bytes = (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structextNODE.html">extNODE</a>))))
    {
      printf(<span class="stringliteral">&quot;failed to allocate memory for %d tree-extnodes (%g MB).\n&quot;</span>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>,
             bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(3);
    }
  allbytes += bytes;

  <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a> = <a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;
  <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a> = <a class="code" href="allvars_8c.html#a57932378336b142ac6e6a9ddb60dce3f">Extnodes_base</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a> = malloc(bytes = (maxpart + <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a>) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))))
    {
      printf(<span class="stringliteral">&quot;Failed to allocate %d spaces for &#39;Nextnode&#39; array (%g MB)\n&quot;</span>, maxpart + <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a>,
             bytes / (1024.0 * 1024.0));
      exit(0);
    }
  allbytes += bytes;

  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a> = malloc(bytes = (maxpart) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))))
    {
      printf(<span class="stringliteral">&quot;Failed to allocate %d spaces for &#39;Father&#39; array (%g MB)\n&quot;</span>, maxpart, bytes / (1024.0 * 1024.0));
      exit(0);
    }
  allbytes += bytes;

  <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a37ea0ff529d9c7e76f1f7895bde01183">first_flag</a> == 0)
    {
      <a class="code" href="forcetree_8c.html#a37ea0ff529d9c7e76f1f7895bde01183">first_flag</a> = 1;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nAllocated %g MByte for BH-tree. %lu\n\n&quot;</span>, allbytes / (1024.0 * 1024.0),
               <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structNODE.html">NODE</a>) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structextNODE.html">extNODE</a>));

      <a class="code" href="forcetree_8c.html#abe941030bf66a95df993b617bffefd9b">tabfac</a> = <a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a> / 3.0;

      <span class="keywordflow">for</span>(i = 0; i &lt; NTAB; i++)
        {
          u = 3.0 / NTAB * (i + 0.5);
          <a class="code" href="forcetree_8c.html#a76b621ce2fa9c17911a62495174029eb">shortrange_table</a>[i] = erfc(u) + 2.0 * u / sqrt(M_PI) * exp(-u * u);
          <a class="code" href="forcetree_8c.html#a196b7c27d03bd3ecc1259b2f67017fbe">shortrange_table_potential</a>[i] = erfc(u);
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab98788ba31869c7bc55ce71b807d2ff2_cgraph.png" border="0" usemap="#proto_8h_ab98788ba31869c7bc55ce71b807d2ff2_cgraph" alt=""/></div>
<map name="proto_8h_ab98788ba31869c7bc55ce71b807d2ff2_cgraph" id="proto_8h_ab98788ba31869c7bc55ce71b807d2ff2_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="192,5,259,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="307,5,464,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab98788ba31869c7bc55ce71b807d2ff2_icgraph.png" border="0" usemap="#proto_8h_ab98788ba31869c7bc55ce71b807d2ff2_icgraph" alt=""/></div>
<map name="proto_8h_ab98788ba31869c7bc55ce71b807d2ff2_icgraph" id="proto_8h_ab98788ba31869c7bc55ce71b807d2ff2_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="251,5,291,35"/><area shape="rect" id="node9" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="205,112,336,141"/><area shape="rect" id="node18" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="193,165,348,195"/><area shape="rect" id="node26" href="restart_8c.html#ae81d30f52dddd39aef76bb1890d16f2f" title="restart" alt="" coords="239,59,303,88"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="436,7,503,36"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="948,60,1001,89"/><area shape="rect" id="node11" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="404,112,535,141"/><area shape="rect" id="node13" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="613,111,784,140"/><area shape="rect" id="node15" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="856,111,899,140"/><area shape="rect" id="node20" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="399,165,540,195"/><area shape="rect" id="node22" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="589,164,808,193"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a10f92098e86f82baec9f84a283f4c9e5"></a><!-- doxytag: member="proto.h::force_treebuild" ref="a10f92098e86f82baec9f84a283f4c9e5" args="(int npart)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int force_treebuild </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>npart</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is a driver routine for constructing the gravitational oct-tree, which is done by calling a small number of other functions. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00061">61</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="forcetree_8c_source.html#l00834">force_flag_localnodes()</a>, <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>, <a class="el" href="forcetree_8c_source.html#l00671">force_update_pseudoparticles()</a>, <a class="el" href="allvars_8c_source.html#l00140">Numnodestree</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, and <a class="el" href="allvars_8c_source.html#l00081">TimeOfLastTreeConstruction</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>, and <a class="el" href="ngb_8c_source.html#l00403">ngb_treebuild()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a> = <a class="code" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6">force_treebuild_single</a>(npart);

  <a class="code" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0">force_update_pseudoparticles</a>();

  <a class="code" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7">force_flag_localnodes</a>();

  <a class="code" href="allvars_8c.html#ae43d9623e3a2c88558e99ecf90948906">TimeOfLastTreeConstruction</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;

  <span class="keywordflow">return</span> <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a>;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a10f92098e86f82baec9f84a283f4c9e5_cgraph.png" border="0" usemap="#proto_8h_a10f92098e86f82baec9f84a283f4c9e5_cgraph" alt=""/></div>
<map name="proto_8h_a10f92098e86f82baec9f84a283f4c9e5_cgraph" id="proto_8h_a10f92098e86f82baec9f84a283f4c9e5_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7" title="force_flag_localnodes" alt="" coords="200,171,357,200"/><area shape="rect" id="node5" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="199,224,359,253"/><area shape="rect" id="node32" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="172,416,385,445"/><area shape="rect" id="node7" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="703,208,823,237"/><area shape="rect" id="node11" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="1141,235,1208,264"/><area shape="rect" id="node16" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="443,261,637,291"/><area shape="rect" id="node21" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="693,312,832,341"/><area shape="rect" id="node23" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="881,337,1092,367"/><area shape="rect" id="node26" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="435,29,645,59"/><area shape="rect" id="node29" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="461,83,619,112"/><area shape="rect" id="node9" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="945,208,1028,237"/><area shape="rect" id="node13" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1256,235,1413,264"/><area shape="rect" id="node34" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb" title="force_exchange_pseudodata" alt="" coords="437,469,643,499"/><area shape="rect" id="node36" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19" title="force_treeupdate_pseudos" alt="" coords="444,416,636,445"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a10f92098e86f82baec9f84a283f4c9e5_icgraph.png" border="0" usemap="#proto_8h_a10f92098e86f82baec9f84a283f4c9e5_icgraph" alt=""/></div>
<map name="proto_8h_a10f92098e86f82baec9f84a283f4c9e5_icgraph" id="proto_8h_a10f92098e86f82baec9f84a283f4c9e5_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="172,56,313,85"/><area shape="rect" id="node12" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="193,109,292,139"/><area shape="rect" id="node17" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="188,163,297,192"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="363,5,581,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="641,71,684,100"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="745,111,799,140"/><area shape="rect" id="node14" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="387,109,557,139"/><area shape="rect" id="node19" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="452,163,492,192"/><area shape="rect" id="node21" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="629,149,696,179"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aadc9b1624ed78f3ccd0dbb9908fe0bb6"></a><!-- doxytag: member="proto.h::force_treebuild_single" ref="aadc9b1624ed78f3ccd0dbb9908fe0bb6" args="(int npart)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int force_treebuild_single </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>npart</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Constructs the gravitational oct-tree.</p>
<p>The index convention for accessing tree nodes is the following: the indices 0...NumPart-1 reference single particles, the indices All.MaxPart.... All.MaxPart+nodes-1 reference tree nodes. `Nodes_base' points to the first tree node, while `nodes' is shifted such that nodes[All.MaxPart] gives the first tree node. Finally, node indices with values 'All.MaxPart + MaxNodes' and larger indicate "pseudo
  particles", i.e. multipole moments of top-level nodes that lie on different CPUs. If such a node needs to be opened, the corresponding particle must be exported to that CPU. The 'Extnodes' structure parallels that of 'Nodes'. Its information is only needed for the SPH part of the computation. (The data is split onto these two structures as a tuning measure. If it is merged into 'Nodes' a somewhat bigger size of the nodes also for gravity would result, which would reduce cache utilization slightly. </p>

<p><p>&lt; Bits per dimension available for Peano-Hilbert order. Note: If peanokey is defined 0 0 int, the allowed maximum is 10. If 64-bit integers are used, the maximum is 21 </p>
</p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00093">93</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00050">BITS_PER_DIMENSION</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8h_source.html#l00222">topnode_data::Daughter</a>, <a class="el" href="allvars_8c_source.html#l00049">DomainCenter</a>, <a class="el" href="allvars_8c_source.html#l00048">DomainCorner</a>, <a class="el" href="allvars_8c_source.html#l00051">DomainFac</a>, <a class="el" href="allvars_8c_source.html#l00050">DomainLen</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="forcetree_8c_source.html#l03040">dump_particles()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, <a class="el" href="forcetree_8c_source.html#l00346">force_insert_pseudo_particles()</a>, <a class="el" href="forcetree_8c_source.html#l00422">force_update_node_recursive()</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="system_8c_source.html#l00029">get_random_number()</a>, <a class="el" href="allvars_8h_source.html#l00537">particle_data::GravCost</a>, <a class="el" href="forcetree_8c_source.html#l00026">last</a>, <a class="el" href="allvars_8h_source.html#l00225">topnode_data::Leaf</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="peano_8c_source.html#l00263">peano_hilbert_key()</a>, <a class="el" href="allvars_8h_source.html#l00227">topnode_data::StartKey</a>, <a class="el" href="allvars_8h_source.html#l00593">NODE::suns</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8c_source.html#l00077">TopNodes</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j, subnode = 0, parent, numnodes;
  <span class="keywordtype">int</span> nfree, th, nn, no;
  <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nfreep;
  <span class="keywordtype">double</span> lenhalf, epsilon;
  <a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> key;


  <span class="comment">/* create an empty root node  */</span>
  nfree = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;          <span class="comment">/* index of first free node */</span>
  nfreep = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[nfree];       <span class="comment">/* select first node */</span>

  nfreep-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> = <a class="code" href="allvars_8c.html#a3dd9593672bf68f0c36fa3e5451e9265">DomainLen</a>;
  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[j] = <a class="code" href="allvars_8c.html#ad13aabcbb50307c005ffa0b2edccdaeb">DomainCenter</a>[j];
  <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
    nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[j] = -1;


  numnodes = 1;
  nfreep++;
  nfree++;

  <span class="comment">/* create a set of empty nodes corresponding to the top-level domain</span>
<span class="comment">   * grid. We need to generate these nodes first to make sure that we have a</span>
<span class="comment">   * complete top-level tree which allows the easy insertion of the</span>
<span class="comment">   * pseudo-particles at the right place </span>
<span class="comment">   */</span>

  <a class="code" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89">force_create_empty_nodes</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>, 0, 1, 0, 0, 0, &amp;numnodes, &amp;nfree);


  <span class="comment">/* if a high-resolution region in a global tree is used, we need to generate</span>
<span class="comment">   * an additional set empty nodes to make sure that we have a complete</span>
<span class="comment">   * top-level tree for the high-resolution inset</span>
<span class="comment">   */</span>

  nfreep = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[nfree];
  parent = -1;                  <span class="comment">/* note: will not be used below before it is changed */</span>


  <span class="comment">/* now we insert all particles */</span>
  <span class="keywordflow">for</span>(i = 0; i &lt; npart; i++)
    {

      <span class="comment">/* the softening is only used to check whether particles are so close</span>
<span class="comment">       * that the tree needs not to be refined further</span>
<span class="comment">       */</span>
      epsilon = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];

      key = <a class="code" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df">peano_hilbert_key</a>((<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[0]) * <a class="code" href="allvars_8c.html#a4488078cfcc203156f193c43a1d3a2ef">DomainFac</a>,
                              (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[1] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[1]) * DomainFac,
                              (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[2] - <a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>[2]) * DomainFac, <a class="code" href="allvars_8h.html#a84bc981fa6ccfbb15526a6e9da12087a">BITS_PER_DIMENSION</a>);

      no = 0;
      <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Daughter &gt;= 0)
        no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ad2e76e39d74f3c299b38fa680ecdb794">Daughter</a> + (key - <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#ab6ae6e924fec05c69ab73ddc2941e855">StartKey</a>) / (<a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].Size / 8);

      no = <a class="code" href="allvars_8c.html#a855acc131f2f1193f48d60fe63037e8c">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#aa5c48f2ae0bd1e2ed8ca069e4eeb29cd">Leaf</a>;
      th = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[no];

      <span class="keywordflow">while</span>(1)
        {
          <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>) <span class="comment">/* we are dealing with an internal node */</span>
            {
              subnode = 0;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[0] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0])
                subnode += 1;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[1] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[1])
                subnode += 2;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Pos[2] &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].center[2])
                subnode += 4;

              nn = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[subnode];

              <span class="keywordflow">if</span>(nn &gt;= 0)       <span class="comment">/* ok, something is in the daughter slot already, need to continue */</span>
                {
                  parent = th;
                  th = nn;
                }
              <span class="keywordflow">else</span>
                {
                  <span class="comment">/* here we have found an empty slot where we can attach</span>
<span class="comment">                   * the new particle as a leaf.</span>
<span class="comment">                   */</span>
                  <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[th].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[subnode] = i;
                  <span class="keywordflow">break</span>;        <span class="comment">/* done for this particle */</span>
                }
            }
          <span class="keywordflow">else</span>
            {
              <span class="comment">/* We try to insert into a leaf with a single particle.  Need</span>
<span class="comment">               * to generate a new internal node at this point.</span>
<span class="comment">               */</span>
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[subnode] = nfree;

              nfreep-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> = 0.5 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;
              lenhalf = 0.25 * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;

              <span class="keywordflow">if</span>(subnode &amp; 1)
                nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] + lenhalf;
              <span class="keywordflow">else</span>
                nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - lenhalf;

              <span class="keywordflow">if</span>(subnode &amp; 2)
                nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] + lenhalf;
              <span class="keywordflow">else</span>
                nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - lenhalf;

              <span class="keywordflow">if</span>(subnode &amp; 4)
                nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] + lenhalf;
              <span class="keywordflow">else</span>
                nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[parent].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - lenhalf;

              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[0] = -1;
              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[1] = -1;
              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[2] = -1;
              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[3] = -1;
              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[4] = -1;
              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[5] = -1;
              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[6] = -1;
              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[7] = -1;


              subnode = 0;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[th].Pos[0] &gt; nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0])
                subnode += 1;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[th].Pos[1] &gt; nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1])
                subnode += 2;
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[th].Pos[2] &gt; nfreep-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2])
                subnode += 4;
<span class="preprocessor">#ifndef NOTREERND</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(nfreep-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &lt; 1.0e-3 * epsilon)
                {
                  <span class="comment">/* seems like we&#39;re dealing with particles at identical (or extremely close)</span>
<span class="comment">                   * locations. Randomize subnode index to allow tree construction. Note: Multipole moments</span>
<span class="comment">                   * of tree are still correct, but this will only happen well below gravitational softening</span>
<span class="comment">                   * length-scale anyway.</span>
<span class="comment">                   */</span>
                  subnode = (int) (8.0 * <a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>((0xffff &amp; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].ID) + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a>));
                  <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a> += 1;
                  <span class="keywordflow">if</span>(subnode &gt;= 8)
                    subnode = 7;
                }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              nfreep-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[subnode] = th;

              th = nfree;       <span class="comment">/* resume trying to insert the new particle at</span>
<span class="comment">                                 * the newly created internal node</span>
<span class="comment">                                 */</span>

              numnodes++;
              nfree++;
              nfreep++;

              <span class="keywordflow">if</span>((numnodes) &gt;= <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)
                {
                  printf(<span class="stringliteral">&quot;task %d: maximum number %d of tree-nodes reached.\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>);
                  printf(<span class="stringliteral">&quot;for particle %d\n&quot;</span>, i);
                  <a class="code" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0">dump_particles</a>();
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
                }
            }
        }
    }


  <span class="comment">/* insert the pseudo particles that represent the mass distribution of other domains */</span>
  <a class="code" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d">force_insert_pseudo_particles</a>();


  <span class="comment">/* now compute the multipole moments recursively */</span>
  <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> = -1;

  <a class="code" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d">force_update_node_recursive</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>, -1, -1);

  <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
    {
      <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)        <span class="comment">/* a pseudo-particle */</span>
        <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>] = -1;
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode = -1;
    }
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>] = -1;

  <span class="keywordflow">return</span> numnodes;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aadc9b1624ed78f3ccd0dbb9908fe0bb6_cgraph.png" border="0" usemap="#proto_8h_aadc9b1624ed78f3ccd0dbb9908fe0bb6_cgraph" alt=""/></div>
<map name="proto_8h_aadc9b1624ed78f3ccd0dbb9908fe0bb6_cgraph" id="proto_8h_aadc9b1624ed78f3ccd0dbb9908fe0bb6_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="484,92,604,122"/><area shape="rect" id="node7" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="923,119,989,148"/><area shape="rect" id="node12" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="224,146,419,175"/><area shape="rect" id="node17" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="475,196,613,226"/><area shape="rect" id="node19" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="663,222,873,251"/><area shape="rect" id="node22" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="216,324,427,354"/><area shape="rect" id="node25" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="243,378,400,407"/><area shape="rect" id="node5" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="727,92,809,122"/><area shape="rect" id="node9" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1037,119,1195,148"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aadc9b1624ed78f3ccd0dbb9908fe0bb6_icgraph.png" border="0" usemap="#proto_8h_aadc9b1624ed78f3ccd0dbb9908fe0bb6_icgraph" alt=""/></div>
<map name="proto_8h_aadc9b1624ed78f3ccd0dbb9908fe0bb6_icgraph" id="proto_8h_aadc9b1624ed78f3ccd0dbb9908fe0bb6_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="216,109,333,139"/><area shape="rect" id="node5" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="383,56,524,85"/><area shape="rect" id="node14" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="404,109,503,139"/><area shape="rect" id="node19" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="399,163,508,192"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="573,5,792,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="852,71,895,100"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="956,111,1009,140"/><area shape="rect" id="node16" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="597,109,768,139"/><area shape="rect" id="node21" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="663,163,703,192"/><area shape="rect" id="node23" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="840,149,907,179"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a59ae74ef51d6a7065605638422489391"></a><!-- doxytag: member="proto.h::force_treeevaluate" ref="a59ae74ef51d6a7065605638422489391" args="(int target, int mode, double *ewaldcountsum)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int force_treeevaluate </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>ewaldcountsum</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine computes the gravitational force for a given local particle, or for a particle in the communication buffer. Depending on the value of TypeOfOpeningCriterion, either the geometrical BH cell-opening criterion, or the `relative' opening criterion is used. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01126">1126</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00710">gravdata_in::Acc</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="sidm__routines_8c_source.html#l00094">calculate_interact_kick()</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="sidm__routines_8c_source.html#l00292">check_interaction_table()</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00428">global_data_all_processes::ErrTolForceAcc</a>, <a class="el" href="allvars_8h_source.html#l00427">global_data_all_processes::ErrTolTheta</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="forcetree_8c_source.html#l01934">force_treeevaluate_ewald_correction()</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="system_8c_source.html#l00029">get_random_number()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00537">particle_data::GravCost</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00526">particle_data::ID</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00597">NODE::mass</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8h_source.html#l00732">gravdata_in::Ninteractions</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8h_source.html#l00731">gravdata_in::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00524">particle_data::OldAcc</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00709">gravdata_in::Pos</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="sidm__routines_8c_source.html#l00032">prob_of_interaction()</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">gravdata_in::u</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, <a class="el" href="sidm__routines_8c_source.html#l00205">update_interaction_table()</a>, <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>, and <a class="el" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">gravdata_in::w</a>.</p>

<p>Referenced by <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
  <span class="keywordtype">int</span> no, ninteractions, ptype;
  <span class="keywordtype">double</span> r2, dx, dy, dz, <a class="code" href="structNODE.html#adfb345bd40fc1835e54589b46622efda">mass</a>, r, fac, <a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>, h, h_inv, h3_inv;
  <span class="keywordtype">double</span> acc_x, acc_y, acc_z, pos_x, pos_y, pos_z, aold;
<span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center,kick_x,kick_y,kick_z,kick_target[3],kick_no[3],prob;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>  targetVel[3];
  <span class="keywordtype">int</span> targetBegstep,targetEndstep;
  IDTYPE targetID;              
  <span class="keywordtype">int</span> si_count,i;
  kick_x = 0;
  kick_y = 0;
  kick_z = 0;
  si_count = 0;
  <span class="keywordflow">if</span>(mode == 0)
  {
    <span class="keywordflow">for</span>(i=0;i&lt;3;i++)
      targetVel[i] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[i];
    targetBegstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>;
    targetEndstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>;
    targetID      = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>;
  }
  <span class="keywordflow">else</span>
  {
    <span class="keywordflow">for</span>(i=0;i&lt;3;i++)
      targetVel[i] = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Vel[i];
    targetBegstep = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Ti_begstep;
    targetEndstep = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Ti_endstep;
    targetID      = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].ID;
  }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  acc_x = 0;
  acc_y = 0;
  acc_z = 0;
  ninteractions = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK      </span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#aba8345d83e2a1512a83563dbd87c9a3f">OldAcc</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Soft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }



<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
  h_inv = 1.0 / h;
  h3_inv = h_inv * h_inv * h_inv;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;             <span class="comment">/* root node */</span>

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)      <span class="comment">/* single particle */</span>
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          <span class="comment">/* observe the sign */</span>

          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - pos_z;

          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }
          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          dx = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[0] - pos_x;
          dy = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[1] - pos_y;
          dz = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[2] - pos_z;

          mass = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;
        }
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
      dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
      dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 0)
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml)
                h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>])
                h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
          <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>])
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
        {
          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &amp; 3) == 1)  <span class="comment">/* if it&#39;s a top-level node</span>
<span class="comment">                                                 * which does not contain</span>
<span class="comment">                                                 * local particles we can</span>
<span class="comment">                                                 * continue to do a short-cut */</span>
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) + 
                                (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) +
                                (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z));
           <span class="comment">/* check if any portion the cell lies withing the intercation range */</span>
          <span class="keywordflow">if</span>(dist_to_center - nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * sqrt(3.0) / 2.0 &lt; 2.0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[1])
            {
              <span class="comment">/* open cell */</span>
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
              <span class="keywordflow">continue</span>;
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * r2 * aold)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="comment">/* check in addition whether we lie inside the cell */</span>

              <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                        {
                          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
          maxsofttype = (nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7;
          <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
            {
              <span class="keywordflow">if</span>(mass &gt; 0)
                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(986);
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
              <span class="keywordflow">continue</span>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                {
                  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype];
                  <span class="keywordflow">if</span>(r2 &lt; h * h)
                    {
                      <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
                        {
                          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];

          <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
            {
              h = nop-&gt;maxsoft;
              <span class="keywordflow">if</span>(r2 &lt; h * h)
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;        <span class="comment">/* ok, node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      r = sqrt(r2);

      <span class="keywordflow">if</span>(r &gt;= h)
        fac = mass / (r2 * r);
      <span class="keywordflow">else</span>
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>          h_inv = 1.0 / h;
          h3_inv = h_inv * h_inv * h_inv;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          u = r * h_inv;
          <span class="keywordflow">if</span>(u &lt; 0.5)
            fac = mass * h3_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
          <span class="keywordflow">else</span>
            fac =
              mass * h3_inv * (21.333333333333 - 48.0 * u +
                               38.4 * u * u - 10.666666666667 * u * u * u - 0.066666666667 / (u * u * u));
        }
      
        acc_x += dx * fac;
        acc_y += dy * fac;
        acc_z += dz * fac;

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
          {
            <span class="keywordflow">if</span> ((ptype == 1 &amp;&amp; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 4) || (ptype == 4 &amp;&amp; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 1) ) <span class="comment">/*This line has been modified for the Test1. original: if (ptype == 1 &amp;&amp; P[no].Type == 1)*/</span>
              {
                <span class="keywordflow">if</span> (r &lt; 2.0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[1] &amp;&amp; <a class="code" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4">check_interaction_table</a>(targetID,<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID) == 0)
                  {
                    prob = <a class="code" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8">prob_of_interaction</a>(r, targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, targetBegstep, targetEndstep);
                    <span class="keywordflow">if</span> (<a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID) &lt; prob)
                      {
                        <a class="code" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9">calculate_interact_kick</a>(targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, kick_target, kick_no);
                        kick_x += kick_target[0];
                        kick_y += kick_target[1];
                        kick_z += kick_target[2];
                        <span class="keywordflow">for</span> (i = 0; i &lt; 3 ; i++)
                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel[i] += kick_no[i];
                        si_count+=1;
                        <a class="code" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615">update_interaction_table</a>(targetID,<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID);
                      }
                  }
              }
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      ninteractions++;
    }
  
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK </span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactions += si_count;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">/* store result at the proper place */</span>
  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0] = acc_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1] = acc_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2] = acc_z;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a> = ninteractions;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[0] += kick_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[1] += kick_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[2] += kick_z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[0] = acc_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[1] = acc_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[2] = acc_z;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#a6b47f6ca387f17b375c949bbc9c0572f">Ninteractions</a> = ninteractions;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[0] = kick_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[1] = kick_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[2] = kick_z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  *ewaldcountsum += <a class="code" href="forcetree_8c.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f">force_treeevaluate_ewald_correction</a>(target, mode, pos_x, pos_y, pos_z, aold);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">return</span> ninteractions;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a59ae74ef51d6a7065605638422489391_cgraph.png" border="0" usemap="#proto_8h_a59ae74ef51d6a7065605638422489391_cgraph" alt=""/></div>
<map name="proto_8h_a59ae74ef51d6a7065605638422489391_cgraph" id="proto_8h_a59ae74ef51d6a7065605638422489391_cgraph">
<area shape="rect" id="node3" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9" title="calculate_interact_kick" alt="" coords="243,5,408,35"/><area shape="rect" id="node5" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4" title="check_interaction_table" alt="" coords="239,59,412,88"/><area shape="rect" id="node7" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="501,191,568,220"/><area shape="rect" id="node11" href="forcetree_8c.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f" title="force_treeevaluate_ewald_correction" alt="" coords="197,163,453,192"/><area shape="rect" id="node13" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="247,216,404,245"/><area shape="rect" id="node15" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8" title="prob_of_interaction" alt="" coords="253,323,397,352"/><area shape="rect" id="node19" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615" title="update_interaction_table" alt="" coords="235,269,416,299"/><area shape="rect" id="node9" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="616,191,773,220"/><area shape="rect" id="node17" href="sidm__routines_8c.html#ab5ff10bfb368309b0dd01aaa72c6be1d" title="g_geo" alt="" coords="504,323,565,352"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a59ae74ef51d6a7065605638422489391_icgraph.png" border="0" usemap="#proto_8h_a59ae74ef51d6a7065605638422489391_icgraph" alt=""/></div>
<map name="proto_8h_a59ae74ef51d6a7065605638422489391_icgraph" id="proto_8h_a59ae74ef51d6a7065605638422489391_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="197,5,296,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="344,5,515,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="563,5,605,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="655,5,708,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0ec221b2517893874b12dc366bfe0da8"></a><!-- doxytag: member="proto.h::force_treeevaluate_direct" ref="a0ec221b2517893874b12dc366bfe0da8" args="(int target, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int force_treeevaluate_direct </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function does the force computation with direct summation for the specified particle in the communication buffer. This can be useful for debugging purposes, in particular for explicit checks of the force accuracy. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02909">2909</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00710">gravdata_in::Acc</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="forcetree_8c_source.html#l03228">ewald_corr()</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="allvars_8h_source.html#l00521">particle_data::GravAccelDirect</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00709">gravdata_in::Pos</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">gravdata_in::u</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> epsilon;
  <span class="keywordtype">double</span> h, h_inv, dx, dy, dz, r, r2, <a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>, r_inv, fac;
  <span class="keywordtype">int</span> i, ptype;
  <span class="keywordtype">double</span> pos_x, pos_y, pos_z;
  <span class="keywordtype">double</span> acc_x, acc_y, acc_z;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> fcorr[3];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  acc_x = 0;
  acc_y = 0;
  acc_z = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      epsilon = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>], <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype]);

      h = epsilon;
      h_inv = 1 / h;

      dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - pos_x;
      dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - pos_y;
      dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - pos_z;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      <span class="keywordflow">while</span>(dx &gt; boxhalf)
        dx -= boxsize;
      <span class="keywordflow">while</span>(dy &gt; boxhalf)
        dy -= boxsize;
      <span class="keywordflow">while</span>(dz &gt; boxhalf)
        dz -= boxsize;
      <span class="keywordflow">while</span>(dx &lt; -boxhalf)
        dx += boxsize;
      <span class="keywordflow">while</span>(dy &lt; -boxhalf)
        dy += boxsize;
      <span class="keywordflow">while</span>(dz &lt; -boxhalf)
        dz += boxsize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      r = sqrt(r2);

      u = r * h_inv;

      <span class="keywordflow">if</span>(u &gt;= 1)
        {
          r_inv = 1 / r;

          fac = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * r_inv * r_inv * r_inv;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(u &lt; 0.5)
            fac = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * h_inv * h_inv * h_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
          <span class="keywordflow">else</span>
            fac =
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * h_inv * h_inv * h_inv * (21.333333333333 -
                                                   48.0 * u + 38.4 * u * u -
                                                   10.666666666667 * u * u *
                                                   u - 0.066666666667 / (u * u * u));
        }

      acc_x += dx * fac;
      acc_y += dy * fac;
      acc_z += dz * fac;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(u &gt; 1.0e-5)
        {
          <a class="code" href="forcetree_8c.html#ad8b8e212e593e1795f6ba522239086fc">ewald_corr</a>(dx, dy, dz, fcorr);

          acc_x += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * fcorr[0];
          acc_y += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * fcorr[1];
          acc_z += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * fcorr[2];
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }


  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[0] = acc_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[1] = acc_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[2] = acc_z;
    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[0] = acc_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[1] = acc_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[2] = acc_z;
    }


  <span class="keywordflow">return</span> NumPart;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a0ec221b2517893874b12dc366bfe0da8_cgraph.png" border="0" usemap="#proto_8h_a0ec221b2517893874b12dc366bfe0da8_cgraph" alt=""/></div>
<map name="proto_8h_a0ec221b2517893874b12dc366bfe0da8_cgraph" id="proto_8h_a0ec221b2517893874b12dc366bfe0da8_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="256,5,315,35"/><area shape="rect" id="node5" href="forcetree_8c.html#ad8b8e212e593e1795f6ba522239086fc" title="ewald_corr" alt="" coords="240,59,331,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a0ec221b2517893874b12dc366bfe0da8_icgraph.png" border="0" usemap="#proto_8h_a0ec221b2517893874b12dc366bfe0da8_icgraph" alt=""/></div>
<map name="proto_8h_a0ec221b2517893874b12dc366bfe0da8_icgraph" id="proto_8h_a0ec221b2517893874b12dc366bfe0da8_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="241,5,369,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="419,5,589,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="637,5,680,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="729,5,783,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab6894fe5ae268ea8f6bc7c4a8c87a87f"></a><!-- doxytag: member="proto.h::force_treeevaluate_ewald_correction" ref="ab6894fe5ae268ea8f6bc7c4a8c87a87f" args="(int target, int mode, double pos_x, double pos_y, double pos_z, double aold)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int force_treeevaluate_ewald_correction </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>pos_x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>pos_y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>pos_z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>aold</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the Ewald correction, and is needed if periodic boundary conditions together with a pure tree algorithm are used. Note that the ordinary tree walk does not carry out this correction directly as it was done in Gadget-1.1. Instead, the tree is walked a second time. This is actually faster because the "Ewald-Treewalk" can use a different opening criterion than the normal tree walk. In particular, the Ewald correction is negligible for particles that are very close, but it is large for particles that are far away (this is quite different for the normal direct force). So we can here use a different opening criterion. Sufficient accuracy is usually obtained if the node length has dropped to a certain fraction ~&lt; 0.25 of the BoxLength. However, we may only short-cut the interaction list of the normal full Ewald tree walk if we are sure that the whole node and all daughter nodes "lie on the same side" of the periodic boundary, i.e. that the real tree walk would not find a daughter node or particle that was mapped to a different nearest neighbour position when the tree walk would be further refined. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01934">1934</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00710">gravdata_in::Acc</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="forcetree_8c_source.html#l00045">EN</a>, <a class="el" href="allvars_8h_source.html#l00427">global_data_all_processes::ErrTolTheta</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="forcetree_8c_source.html#l00053">fac_intp</a>, <a class="el" href="forcetree_8c_source.html#l00049">fcorrx</a>, <a class="el" href="forcetree_8c_source.html#l00050">fcorry</a>, <a class="el" href="forcetree_8c_source.html#l00051">fcorrz</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00537">particle_data::GravCost</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00597">NODE::mass</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8h_source.html#l00732">gravdata_in::Ninteractions</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">gravdata_in::u</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, and <a class="el" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">gravdata_in::w</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l01126">force_treeevaluate()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
  <span class="keywordtype">int</span> no, cost;
  <span class="keywordtype">double</span> dx, dy, dz, <a class="code" href="structNODE.html#adfb345bd40fc1835e54589b46622efda">mass</a>, r2;
  <span class="keywordtype">int</span> signx, signy, signz;
  <span class="keywordtype">int</span> i, j, k, openflag;
  <span class="keywordtype">double</span> <a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>, v, w;
  <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;
  <span class="keywordtype">double</span> acc_x, acc_y, acc_z;
  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  
  acc_x = 0;
  acc_y = 0;
  acc_z = 0;
  cost = 0;

  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)      <span class="comment">/* single particle */</span>
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          <span class="comment">/* observe the sign */</span>

          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - pos_z;
          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }

              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          dx = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[0] - pos_x;
          dy = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[1] - pos_y;
          dz = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[2] - pos_z;
          mass = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;
        }

      dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
      dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
      dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
        no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
        {
          openflag = 0;

          r2 = dx * dx + dy * dy + dz * dz;
        
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) +
                              (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) +
                              (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z));
          <span class="comment">/*check if any portion the cell lies withing the intercation range*/</span>
        <span class="keywordflow">if</span>(dist_to_center - nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * sqrt(3.0) / 2.0 &lt; 2.0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[1])
            {
              <span class="comment">/* open cell */</span>
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
              <span class="keywordflow">continue</span>;
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)
                {
                  openflag = 1;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * r2 * aold)
                {
                  openflag = 1;
                }
              <span class="keywordflow">else</span>
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                        {
                          <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                            {
                              openflag = 1;
                            }
                        }
                    }
                }
            }

          <span class="keywordflow">if</span>(openflag)
            {
              <span class="comment">/* now we check if we can avoid opening the cell */</span>

              u = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x;
              <span class="keywordflow">if</span>(u &gt; boxhalf)
                u -= boxsize;
              <span class="keywordflow">if</span>(u &lt; -boxhalf)
                u += boxsize;

              <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>))
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              u = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y;
              <span class="keywordflow">if</span>(u &gt; boxhalf)
                u -= boxsize;
              <span class="keywordflow">if</span>(u &lt; -boxhalf)
                u += boxsize;

              <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>))
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              u = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z;
              <span class="keywordflow">if</span>(u &gt; boxhalf)
                u -= boxsize;
              <span class="keywordflow">if</span>(u &lt; -boxhalf)
                u += boxsize;

              <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>))
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="comment">/* if the cell is too large, we need to refine</span>
<span class="comment">               * it further </span>
<span class="comment">               */</span>
              <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; 0.20 * boxsize)
                {
                  <span class="comment">/* cell is too large */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }

          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;        <span class="comment">/* ok, node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &amp; 1))       <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      <span class="comment">/* compute the Ewald correction force */</span>

      <span class="keywordflow">if</span>(dx &lt; 0)
        {
          dx = -dx;
          signx = +1;
        }
      <span class="keywordflow">else</span>
        signx = -1;

      <span class="keywordflow">if</span>(dy &lt; 0)
        {
          dy = -dy;
          signy = +1;
        }
      <span class="keywordflow">else</span>
        signy = -1;

      <span class="keywordflow">if</span>(dz &lt; 0)
        {
          dz = -dz;
          signz = +1;
        }
      <span class="keywordflow">else</span>
        signz = -1;

      u = dx * <a class="code" href="forcetree_8c.html#af6350369fa0c71cba122f936412fcb4d">fac_intp</a>;
      i = (int) u;
      <span class="keywordflow">if</span>(i &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
        i = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
      u -= i;
      v = dy * fac_intp;
      j = (int) v;
      <span class="keywordflow">if</span>(j &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
        j = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
      v -= j;
      w = dz * fac_intp;
      k = (int) w;
      <span class="keywordflow">if</span>(k &gt;= <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a>)
        k = <a class="code" href="forcetree_8c.html#a22e6626f2c98ed902f8ded47f6438c05">EN</a> - 1;
      w -= k;

      <span class="comment">/* compute factors for trilinear interpolation */</span>

      f1 = (1 - u) * (1 - v) * (1 - w);
      f2 = (1 - u) * (1 - v) * (w);
      f3 = (1 - u) * (v) * (1 - w);
      f4 = (1 - u) * (v) * (w);
      f5 = (u) * (1 - v) * (1 - w);
      f6 = (u) * (1 - v) * (w);
      f7 = (u) * (v) * (1 - w);
      f8 = (u) * (v) * (w);

      acc_x += mass * signx * (<a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k] * f1 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j][k + 1] * f2 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j + 1][k] * f3 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i][j + 1][k + 1] * f4 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j][k] * f5 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j][k + 1] * f6 +
                               <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#aa5cc9e7d836cdcf307f7640533e5e928">fcorrx</a>[i + 1][j + 1][k + 1] * f8);

      acc_y += mass * signy * (<a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k] * f1 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j][k + 1] * f2 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j + 1][k] * f3 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i][j + 1][k + 1] * f4 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j][k] * f5 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j][k + 1] * f6 +
                               <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#ac7d44a9c9f475423540e3acd8bca75d3">fcorry</a>[i + 1][j + 1][k + 1] * f8);

      acc_z += mass * signz * (<a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k] * f1 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j][k + 1] * f2 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j + 1][k] * f3 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i][j + 1][k + 1] * f4 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j][k] * f5 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j][k + 1] * f6 +
                               <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j + 1][k] * f7 + <a class="code" href="forcetree_8c.html#aa4f6ad92e563dd2a0d0b324452b051f6">fcorrz</a>[i + 1][j + 1][k + 1] * f8);
      cost++;
    }


  <span class="comment">/* add the result at the proper place */</span>

  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0] += acc_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1] += acc_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2] += acc_z;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a> += cost;
    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[0] += acc_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[1] += acc_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[2] += acc_z;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#a6b47f6ca387f17b375c949bbc9c0572f">Ninteractions</a> += cost;
    }

  <span class="keywordflow">return</span> cost;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab6894fe5ae268ea8f6bc7c4a8c87a87f_icgraph.png" border="0" usemap="#proto_8h_ab6894fe5ae268ea8f6bc7c4a8c87a87f_icgraph" alt=""/></div>
<map name="proto_8h_ab6894fe5ae268ea8f6bc7c4a8c87a87f_icgraph" id="proto_8h_ab6894fe5ae268ea8f6bc7c4a8c87a87f_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a59ae74ef51d6a7065605638422489391" title="force_treeevaluate" alt="" coords="311,5,452,35"/><area shape="rect" id="node5" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="501,5,600,35"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="648,5,819,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="867,5,909,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="959,5,1012,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a804166b1847da509d8fe57072b40d5f9"></a><!-- doxytag: member="proto.h::force_treeevaluate_potential" ref="a804166b1847da509d8fe57072b40d5f9" args="(int target, int type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_treeevaluate_potential </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine computes the gravitational potential by walking the tree. The same opening criteria is used as for the gravitational force walk. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02216">2216</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00428">global_data_all_processes::ErrTolForceAcc</a>, <a class="el" href="allvars_8h_source.html#l00427">global_data_all_processes::ErrTolTheta</a>, <a class="el" href="forcetree_8c_source.html#l03317">ewald_pot_corr()</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00597">NODE::mass</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8h_source.html#l00731">gravdata_in::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00524">particle_data::OldAcc</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00709">gravdata_in::Pos</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00711">gravdata_in::Potential</a>, <a class="el" href="allvars_8h_source.html#l00523">particle_data::Potential</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">gravdata_in::u</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, and <a class="el" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">gravdata_in::w</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
  <span class="keywordtype">int</span> no, ptype;
  <span class="keywordtype">double</span> r2, dx, dy, dz, <a class="code" href="structNODE.html#adfb345bd40fc1835e54589b46622efda">mass</a>, r, <a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>, h, h_inv, wp;
  <span class="keywordtype">double</span> pot, pos_x, pos_y, pos_z, aold;
<span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  
  pot = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#aba8345d83e2a1512a83563dbd87c9a3f">OldAcc</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Soft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }


<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
  h_inv = 1.0 / h;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)      <span class="comment">/* single particle */</span>
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          <span class="comment">/* observe the sign */</span>

          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - pos_z;
          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          dx = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[0] - pos_x;
          dy = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[1] - pos_y;
          dz = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[2] - pos_z;
          mass = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;
        }

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
      dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
      dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 0)
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml)
                h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>])
                h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
          <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>])
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an internal node. Need to check opening criterion */</span>
        {
          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &amp; 3) == 1)  <span class="comment">/* if it&#39;s a top-level node</span>
<span class="comment">                                                 * which does not contain</span>
<span class="comment">                                                 * local particles we can make</span>
<span class="comment">                                                 * a short-cut </span>
<span class="comment">                                                 */</span>
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) + 
                                (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) +
                                (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z));
           <span class="comment">/*check if any portion the cell lies withing the intercation range*/</span>
          <span class="keywordflow">if</span>(dist_to_center - nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * sqrt(3.0) / 2.0 &lt; 2.0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[1])
          {
            <span class="comment">/* open cell */</span>
            no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
            <span class="keywordflow">continue</span>;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * r2 * aold)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                        {
                          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
          maxsofttype = (nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7;
          <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
            {
              <span class="keywordflow">if</span>(mass &gt; 0)
                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(988);
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
              <span class="keywordflow">continue</span>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                {
                  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype];
                  <span class="keywordflow">if</span>(r2 &lt; h * h)
                    {
                      <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
                        {
                          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];

          <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
            {
              h = nop-&gt;maxsoft;
              <span class="keywordflow">if</span>(r2 &lt; h * h)
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;        <span class="comment">/* node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      r = sqrt(r2);

      <span class="keywordflow">if</span>(r &gt;= h)
        pot -= mass / r;
      <span class="keywordflow">else</span>
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>          h_inv = 1.0 / h;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          u = r * h_inv;

          <span class="keywordflow">if</span>(u &lt; 0.5)
            wp = -2.8 + u * u * (5.333333333333 + u * u * (6.4 * u - 9.6));
          <span class="keywordflow">else</span>
            wp =
              -3.2 + 0.066666666667 / u + u * u * (10.666666666667 +
                                                   u * (-16.0 + u * (9.6 - 2.133333333333 * u)));

          pot += mass * h_inv * wp;
        }
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      pot += mass * <a class="code" href="forcetree_8c.html#aa0657e3de6bfb76715c14ddd72d25e58">ewald_pot_corr</a>(dx, dy, dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="comment">/* store result at the proper place */</span>

  <span class="keywordflow">if</span>(mode == 0)
    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> = pot;
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#ac003758a6c6e72bb9cc1ce619fabf148">Potential</a> = pot;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a804166b1847da509d8fe57072b40d5f9_cgraph.png" border="0" usemap="#proto_8h_a804166b1847da509d8fe57072b40d5f9_cgraph" alt=""/></div>
<map name="proto_8h_a804166b1847da509d8fe57072b40d5f9_cgraph" id="proto_8h_a804166b1847da509d8fe57072b40d5f9_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="285,5,352,35"/><area shape="rect" id="node7" href="forcetree_8c.html#aa0657e3de6bfb76715c14ddd72d25e58" title="ewald_pot_corr" alt="" coords="260,59,377,88"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="427,5,584,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a804166b1847da509d8fe57072b40d5f9_icgraph.png" border="0" usemap="#proto_8h_a804166b1847da509d8fe57072b40d5f9_icgraph" alt=""/></div>
<map name="proto_8h_a804166b1847da509d8fe57072b40d5f9_icgraph" id="proto_8h_a804166b1847da509d8fe57072b40d5f9_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="260,32,401,61"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="451,5,669,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="717,32,760,61"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="809,32,863,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="abd9d86a6c08e77a4fa78fa76b96cdde7"></a><!-- doxytag: member="proto.h::force_treeevaluate_potential_shortrange" ref="abd9d86a6c08e77a4fa78fa76b96cdde7" args="(int target, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_treeevaluate_potential_shortrange </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the short-range potential when the TreePM algorithm is used. This potential is the Newtonian potential, modified by a complementary error function. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02493">2493</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00393">global_data_all_processes::Asmth</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00428">global_data_all_processes::ErrTolForceAcc</a>, <a class="el" href="allvars_8h_source.html#l00427">global_data_all_processes::ErrTolTheta</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00597">NODE::mass</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="forcetree_8c_source.html#l00031">NTAB</a>, <a class="el" href="allvars_8h_source.html#l00731">gravdata_in::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00524">particle_data::OldAcc</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00709">gravdata_in::Pos</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00711">gravdata_in::Potential</a>, <a class="el" href="allvars_8h_source.html#l00523">particle_data::Potential</a>, <a class="el" href="allvars_8h_source.html#l00394">global_data_all_processes::Rcut</a>, <a class="el" href="forcetree_8c_source.html#l00033">shortrange_table_potential</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">gravdata_in::u</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, and <a class="el" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">gravdata_in::w</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
  <span class="keywordtype">int</span> no, ptype, tabindex;
  <span class="keywordtype">double</span> r2, dx, dy, dz, <a class="code" href="structNODE.html#adfb345bd40fc1835e54589b46622efda">mass</a>, r, <a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>, h, h_inv, wp;
  <span class="keywordtype">double</span> pot, pos_x, pos_y, pos_z, aold;
  <span class="keywordtype">double</span> eff_dist, fac, rcut, asmth, asmthfac;
  <span class="keywordtype">double</span> dxx, dyy, dzz;
<span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  pot = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#aba8345d83e2a1512a83563dbd87c9a3f">OldAcc</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Soft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }


  rcut = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aeb7ceb2f4d86465e1febbfad5fa849d6">Rcut</a>[0];
  asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[0];
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(((1 &lt;&lt; ptype) &amp; (PLACEHIGHRESREGION)))
    {
      rcut = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aeb7ceb2f4d86465e1febbfad5fa849d6">Rcut</a>[1];
      asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[1];
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  asmthfac = 0.5 / asmth * (<a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a> / 3.0);

<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
  h_inv = 1.0 / h;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)      <span class="comment">/* single particle */</span>
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          <span class="comment">/* observe the sign  */</span>

          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - pos_z;
          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          dx = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[0] - pos_x;
          dy = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[1] - pos_y;
          dz = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[2] - pos_z;
          mass = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;
        }

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
      dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
      dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 0)
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml)
                h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>])
                h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
          <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>])
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
        {
          <span class="comment">/* check whether we can stop walking along this branch */</span>
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &amp; 3) == 1)  <span class="comment">/* if it&#39;s a top-level node which does not contain local particles */</span>
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

          eff_dist = rcut + 0.5 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;

          dxx = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x; <span class="comment">/* observe the sign ! */</span>
          dyy = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y; <span class="comment">/* this vector is -y in my thesis notation */</span>
          dzz = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z;
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          dxx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dxx);
          dyy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dyy);
          dzz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dzz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(dxx &lt; -eff_dist || dxx &gt; eff_dist)
            {
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
              <span class="keywordflow">continue</span>;
            }

          <span class="keywordflow">if</span>(dyy &lt; -eff_dist || dyy &gt; eff_dist)
            {
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
              <span class="keywordflow">continue</span>;
            }

          <span class="keywordflow">if</span>(dzz &lt; -eff_dist || dzz &gt; eff_dist)
            {
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
              <span class="keywordflow">continue</span>;
            }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) + 
                                (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) +
                                (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z));
           <span class="comment">/*check if any portion the cell lies withing the intercation range*/</span>
          <span class="keywordflow">if</span>(dist_to_center - nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * sqrt(3.0) / 2.0 &lt; 2.0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[1])
          {
            <span class="comment">/* open cell */</span>
            no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
            <span class="keywordflow">continue</span>;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * r2 * aold)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                        {
                          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
          maxsofttype = (nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7;
          <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
            {
              <span class="keywordflow">if</span>(mass &gt; 0)
                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(989);
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
              <span class="keywordflow">continue</span>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                {
                  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype];
                  <span class="keywordflow">if</span>(r2 &lt; h * h)
                    {
                      <span class="comment">/* bit-5 signals that there are particles of</span>
<span class="comment">                       * different softening in the node</span>
<span class="comment">                       */</span>
                      <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 5) &amp; 1))
                        {
                          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];

          <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
            {
              h = nop-&gt;maxsoft;
              <span class="keywordflow">if</span>(r2 &lt; h * h)
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;        <span class="comment">/* node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      r = sqrt(r2);

      tabindex = (int) (r * asmthfac);

      <span class="keywordflow">if</span>(tabindex &lt; <a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a>)
        {
          fac = <a class="code" href="forcetree_8c.html#a196b7c27d03bd3ecc1259b2f67017fbe">shortrange_table_potential</a>[tabindex];

          <span class="keywordflow">if</span>(r &gt;= h)
            pot -= fac * mass / r;
          <span class="keywordflow">else</span>
            {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>              h_inv = 1.0 / h;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              u = r * h_inv;

              <span class="keywordflow">if</span>(u &lt; 0.5)
                wp = -2.8 + u * u * (5.333333333333 + u * u * (6.4 * u - 9.6));
              <span class="keywordflow">else</span>
                wp =
                  -3.2 + 0.066666666667 / u + u * u * (10.666666666667 +
                                                       u * (-16.0 + u * (9.6 - 2.133333333333 * u)));
              pot += fac * mass * h_inv * wp;
            }
        }
    }


  <span class="comment">/* store result at the proper place */</span>
  <span class="keywordflow">if</span>(mode == 0)
    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> = pot;
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#ac003758a6c6e72bb9cc1ce619fabf148">Potential</a> = pot;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_abd9d86a6c08e77a4fa78fa76b96cdde7_cgraph.png" border="0" usemap="#proto_8h_abd9d86a6c08e77a4fa78fa76b96cdde7_cgraph" alt=""/></div>
<map name="proto_8h_abd9d86a6c08e77a4fa78fa76b96cdde7_cgraph" id="proto_8h_abd9d86a6c08e77a4fa78fa76b96cdde7_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="336,5,403,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="451,5,608,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_abd9d86a6c08e77a4fa78fa76b96cdde7_icgraph.png" border="0" usemap="#proto_8h_abd9d86a6c08e77a4fa78fa76b96cdde7_icgraph" alt=""/></div>
<map name="proto_8h_abd9d86a6c08e77a4fa78fa76b96cdde7_icgraph" id="proto_8h_abd9d86a6c08e77a4fa78fa76b96cdde7_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="337,32,479,61"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="528,5,747,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="795,32,837,61"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="887,32,940,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae01e179b7686a7fe62970160b7bbdb46"></a><!-- doxytag: member="proto.h::force_treeevaluate_shortrange" ref="ae01e179b7686a7fe62970160b7bbdb46" args="(int target, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int force_treeevaluate_shortrange </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>In the TreePM algorithm, the tree is walked only locally around the target coordinate. Tree nodes that fall outside a box of half side-length Rcut= RCUT*ASMTH*MeshSize can be discarded. The short-range potential is modified by a complementary error function, multiplied with the Newtonian form. The resulting short-range suppression compared to the Newtonian force is tabulated, because looking up from this table is faster than recomputing the corresponding factor, despite the memory-access panelty (which reduces cache performance) incurred by the table. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01500">1500</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00710">gravdata_in::Acc</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00393">global_data_all_processes::Asmth</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="sidm__routines_8c_source.html#l00094">calculate_interact_kick()</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="sidm__routines_8c_source.html#l00292">check_interaction_table()</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00428">global_data_all_processes::ErrTolForceAcc</a>, <a class="el" href="allvars_8h_source.html#l00427">global_data_all_processes::ErrTolTheta</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="system_8c_source.html#l00029">get_random_number()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00537">particle_data::GravCost</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00526">particle_data::ID</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00597">NODE::mass</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="forcetree_8c_source.html#l00043">NEAREST</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8h_source.html#l00732">gravdata_in::Ninteractions</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="forcetree_8c_source.html#l00031">NTAB</a>, <a class="el" href="allvars_8h_source.html#l00731">gravdata_in::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00524">particle_data::OldAcc</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00709">gravdata_in::Pos</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="sidm__routines_8c_source.html#l00032">prob_of_interaction()</a>, <a class="el" href="allvars_8h_source.html#l00394">global_data_all_processes::Rcut</a>, <a class="el" href="forcetree_8c_source.html#l00033">shortrange_table</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">gravdata_in::u</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, <a class="el" href="sidm__routines_8c_source.html#l00205">update_interaction_table()</a>, <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>, and <a class="el" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">gravdata_in::w</a>.</p>

<p>Referenced by <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
  <span class="keywordtype">int</span> no, ptype, ninteractions, tabindex;
  <span class="keywordtype">double</span> r2, dx, dy, dz, <a class="code" href="structNODE.html#adfb345bd40fc1835e54589b46622efda">mass</a>, r, fac, <a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>, h, h_inv, h3_inv;
  <span class="keywordtype">double</span> acc_x, acc_y, acc_z, pos_x, pos_y, pos_z, aold;
  <span class="keywordtype">double</span> eff_dist;
  <span class="keywordtype">double</span> rcut, asmth, asmthfac, rcut2, dist;
<span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;

  boxsize = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  boxhalf = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span>  dist_to_center,kick_x,kick_y,kick_z,kick_target[3],kick_no[3],prob;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> targetVel[3];
  <span class="keywordtype">int</span> targetBegstep,targetEndstep;
  IDTYPE targetID;              
  <span class="keywordtype">int</span> si_count,i;
  kick_x = 0;
  kick_y = 0;
  kick_z = 0;
  si_count = 0;
  <span class="keywordflow">if</span>(mode == 0)
    {
      <span class="keywordflow">for</span>(i=0;i&lt;3;i++)
        targetVel[i] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].Vel[i];
      targetBegstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>;
      targetEndstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>;
      targetID      = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>;
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">for</span>(i=0;i&lt;3;i++)
        targetVel[i] = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Vel[i];
      targetBegstep = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Ti_begstep;
      targetEndstep = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Ti_endstep;
      targetID      = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].ID;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  acc_x = 0;
  acc_y = 0;
  acc_z = 0;
  ninteractions = 0;

  <span class="keywordflow">if</span>(mode == 0)
    {
      pos_x = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      pos_x = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[0];
      pos_y = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[1];
      pos_z = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[2];
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK      </span>
<span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Type;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#aba8345d83e2a1512a83563dbd87c9a3f">OldAcc</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
        soft = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[target].Soft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  rcut = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aeb7ceb2f4d86465e1febbfad5fa849d6">Rcut</a>[0];
  asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[0];
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(((1 &lt;&lt; ptype) &amp; (PLACEHIGHRESREGION)))
    {
      rcut = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aeb7ceb2f4d86465e1febbfad5fa849d6">Rcut</a>[1];
      asmth = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[1];
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  rcut2 = rcut * rcut;

  asmthfac = 0.5 / asmth * (<a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a> / 3.0);

<span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
  h_inv = 1.0 / h;
  h3_inv = h_inv * h_inv * h_inv;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;             <span class="comment">/* root node */</span>

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
        {
          <span class="comment">/* the index of the node is the index of the particle */</span>
          dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - pos_x;
          dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - pos_y;
          dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - pos_z;
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
          dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
          dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;

          mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 0)
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].Hsml)
                h = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[no].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>])
                h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
          <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>])
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node */</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <span class="keywordflow">if</span>(mode == 0)
                {
                  <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
                }
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          nop = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &amp; 3) == 1)  <span class="comment">/* if it&#39;s a top-level node</span>
<span class="comment">                                                 * which does not contain</span>
<span class="comment">                                                 * local particles we can</span>
<span class="comment">                                                 * continue at this point</span>
<span class="comment">                                                 */</span>
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

          mass = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;

          dx = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[0] - pos_x;
          dy = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[1] - pos_y;
          dz = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[2] - pos_z;
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          dx = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dx);
          dy = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dy);
          dz = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(dz);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;

          <span class="keywordflow">if</span>(r2 &gt; rcut2)
            {
              <span class="comment">/* check whether we can stop walking along this branch */</span>
              eff_dist = rcut + 0.5 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>              dist = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
                  <span class="keywordflow">continue</span>;
                }
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>              dist = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
                  <span class="keywordflow">continue</span>;
                }
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1094686c363ae3a70dca627763873649">NEAREST</a>(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>              dist = nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;
                  <span class="keywordflow">continue</span>;
                }
            }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          dist_to_center = sqrt((nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) + 
                                (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) +
                                (nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z)*(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z));
          <span class="comment">/*check if any portion the cell lies withing the intercation range */</span>
          <span class="keywordflow">if</span>(dist_to_center - nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * sqrt(3.0) / 2.0 &lt; 2.0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[1])
            {
              <span class="comment">/* open cell */</span>
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
              <span class="keywordflow">continue</span>;
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
            {
              <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
          <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
            {
              <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &gt; r2 * r2 * aold)
                {
                  <span class="comment">/* open cell */</span>
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }

              <span class="comment">/* check in addition whether we lie inside the cell */</span>

              <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                {
                  <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                    {
                      <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
                        {
                          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];
          maxsofttype = (nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7;
          <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
            {
              <span class="keywordflow">if</span>(mass &gt; 0)
                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(987);
              no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
              <span class="keywordflow">continue</span>;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                {
                  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype];
                  <span class="keywordflow">if</span>(r2 &lt; h * h)
                    {
                      <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
                        {
                          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                          
                          <span class="keywordflow">continue</span>;
                        }
                    }
                }
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
            h = soft;
          <span class="keywordflow">else</span>
            h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[ptype];

          <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
            {
              h = nop-&gt;maxsoft;
              <span class="keywordflow">if</span>(r2 &lt; h * h)
                {
                  no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode;
                  <span class="keywordflow">continue</span>;
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling;        <span class="comment">/* ok, node can be used */</span>

          <span class="keywordflow">if</span>(mode == 1)
            {
              <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
                <span class="keywordflow">continue</span>;
            }
        }

      r = sqrt(r2);

      <span class="keywordflow">if</span>(r &gt;= h)
        fac = mass / (r2 * r);
      <span class="keywordflow">else</span>
        {
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>          h_inv = 1.0 / h;
          h3_inv = h_inv * h_inv * h_inv;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          u = r * h_inv;
          <span class="keywordflow">if</span>(u &lt; 0.5)
            fac = mass * h3_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
          <span class="keywordflow">else</span>
            fac =
              mass * h3_inv * (21.333333333333 - 48.0 * u +
                               38.4 * u * u - 10.666666666667 * u * u * u - 0.066666666667 / (u * u * u));
        }

      tabindex = (int) (asmthfac * r);

      <span class="keywordflow">if</span>(tabindex &lt; <a class="code" href="forcetree_8c.html#a0e93cfb2d62849853fd34957ba6e6fdc">NTAB</a>)
        {
          fac *= <a class="code" href="forcetree_8c.html#a76b621ce2fa9c17911a62495174029eb">shortrange_table</a>[tabindex];

          acc_x += dx * fac;
          acc_y += dy * fac;
          acc_z += dz * fac;
        
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
            {
              <span class="keywordflow">if</span> ((ptype == 1 &amp;&amp; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Type == 4) || (ptype == 4 &amp;&amp; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 1) ) <span class="comment">/*This line has been modified for the Test1. original: if (ptype == 1 &amp;&amp; P[no].Type == 1)*/</span>
                {
                  <span class="keywordflow">if</span>(r &lt; 2.0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[1] &amp;&amp; <a class="code" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4">check_interaction_table</a>(targetID,<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID) == 0)
                    {
                      prob = <a class="code" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8">prob_of_interaction</a>(r, targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, targetBegstep, targetEndstep);
                      <span class="keywordflow">if</span>(<a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID) &lt; prob)
                        {
                          <a class="code" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9">calculate_interact_kick</a>(targetVel, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel, kick_target, kick_no);
                          kick_x += kick_target[0];
                          kick_y += kick_target[1];
                          kick_z += kick_target[2];
                          <span class="keywordflow">for</span>(i = 0; i &lt; 3 ; i++)
                              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].Vel[i] += kick_no[i];
                          si_count+=1;
                          <a class="code" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615">update_interaction_table</a>(targetID,<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[no].ID);
                        }
                    }
                }
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          ninteractions++;
        }
    }

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK </span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactions += si_count;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">/* store result at the proper place */</span>

  <span class="keywordflow">if</span>(mode == 0)
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0] = acc_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1] = acc_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2] = acc_z;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a> = ninteractions;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[0] += kick_x;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[1] += kick_y;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[2] += kick_z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[0] = acc_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[1] = acc_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#a89df6fdf4fb1512fa2b491eb4fb10662">u</a>.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[2] = acc_z;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#a6b47f6ca387f17b375c949bbc9c0572f">Ninteractions</a> = ninteractions;
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[0] = kick_x;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[1] = kick_y;
      <a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[target].Vel[2] = kick_z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="keywordflow">return</span> ninteractions;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ae01e179b7686a7fe62970160b7bbdb46_cgraph.png" border="0" usemap="#proto_8h_ae01e179b7686a7fe62970160b7bbdb46_cgraph" alt=""/></div>
<map name="proto_8h_ae01e179b7686a7fe62970160b7bbdb46_cgraph" id="proto_8h_ae01e179b7686a7fe62970160b7bbdb46_cgraph">
<area shape="rect" id="node3" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9" title="calculate_interact_kick" alt="" coords="280,5,445,35"/><area shape="rect" id="node5" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4" title="check_interaction_table" alt="" coords="276,59,449,88"/><area shape="rect" id="node7" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="501,164,568,193"/><area shape="rect" id="node11" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="284,163,441,192"/><area shape="rect" id="node13" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8" title="prob_of_interaction" alt="" coords="291,269,435,299"/><area shape="rect" id="node17" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615" title="update_interaction_table" alt="" coords="272,216,453,245"/><area shape="rect" id="node9" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="616,164,773,193"/><area shape="rect" id="node15" href="sidm__routines_8c.html#ab5ff10bfb368309b0dd01aaa72c6be1d" title="g_geo" alt="" coords="504,269,565,299"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ae01e179b7686a7fe62970160b7bbdb46_icgraph.png" border="0" usemap="#proto_8h_ae01e179b7686a7fe62970160b7bbdb46_icgraph" alt=""/></div>
<map name="proto_8h_ae01e179b7686a7fe62970160b7bbdb46_icgraph" id="proto_8h_ae01e179b7686a7fe62970160b7bbdb46_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="272,5,371,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="419,5,589,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="637,5,680,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="729,5,783,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0a9667f530dad09ebed8c0c98e5d3888"></a><!-- doxytag: member="proto.h::force_treefree" ref="a0a9667f530dad09ebed8c0c98e5d3888" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_treefree </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function frees the memory allocated for the tree, i.e. it frees the space allocated by the function <a class="el" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate()</a>. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l02892">2892</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00152">Extnodes_base</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, and <a class="el" href="allvars_8c_source.html#l00142">Nodes_base</a>.</p>

<p>Referenced by <a class="el" href="pm__periodic_8c_source.html#l00180">pmforce_periodic()</a>, and <a class="el" href="pm__periodic_8c_source.html#l00693">pmpotential_periodic()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  free(<a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>);
  free(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>);
  free(<a class="code" href="allvars_8c.html#a57932378336b142ac6e6a9ddb60dce3f">Extnodes_base</a>);
  free(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a0a9667f530dad09ebed8c0c98e5d3888_icgraph.png" border="0" usemap="#proto_8h_a0a9667f530dad09ebed8c0c98e5d3888_icgraph" alt=""/></div>
<map name="proto_8h_a0a9667f530dad09ebed8c0c98e5d3888_icgraph" id="proto_8h_a0a9667f530dad09ebed8c0c98e5d3888_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="179,5,309,35"/><area shape="rect" id="node13" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="167,59,321,88"/><area shape="rect" id="node5" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="377,5,508,35"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="587,5,757,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="829,57,872,87"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="921,57,975,87"/><area shape="rect" id="node15" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="372,59,513,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="563,109,781,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab8e5d4fed349d96c6d4f55897473ce19"></a><!-- doxytag: member="proto.h::force_treeupdate_pseudos" ref="ab8e5d4fed349d96c6d4f55897473ce19" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_treeupdate_pseudos </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function updates the top-level tree after the multipole moments of the pseudo-particles have been updated. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00732">732</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00065">DomainMoment</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="allvars_8h_source.html#l00199">DomainNODE::mass</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, <a class="el" href="allvars_8h_source.html#l00197">DomainNODE::s</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, <a class="el" href="allvars_8h_source.html#l00198">DomainNODE::vs</a>, and <a class="el" href="allvars_8h_source.html#l00619">extNODE::vs</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00671">force_update_pseudoparticles()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, k, no;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> sold[3], vsold[3], snew[3], vsnew[3], massold, massnew, mm;

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype, diffsoftflag;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>)
      {
        no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

        <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
          {
            sold[k] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[k];
            vsold[k] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[k];
          }
        massold = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;

        <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
          {
            snew[k] = <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#ae047a14ee5331dc9d6e128cb6c5e95e4">s</a>[k];
            vsnew[k] = <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#a52c312bfff90fd7236c7d1e176c03d9c">vs</a>[k];
          }
        massnew = <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#afb739de9da1eb6908f9064093e02e7bc">mass</a>;


<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>        maxsofttype = (<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].bitflags &gt;&gt; 2) &amp; 7;
        diffsoftflag = (<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].bitflags &gt;&gt; 5) &amp; 1;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        maxsoft = <a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>[i].maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        <span class="keywordflow">do</span>
          {
            mm = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass + massnew - massold;
            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              {
                <span class="keywordflow">if</span>(mm &gt; 0)
                  {
                    <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[k] =
                      (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[k] + massnew * snew[k] - massold * sold[k]) / mm;
                    <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[k] =
                      (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass * <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[k] + massnew * vsnew[k] -
                       massold * vsold[k]) / mm;
                  }
              }
            <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass = mm;


<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>            diffsoftflag |= (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 5) &amp; 1;

            <span class="keywordflow">if</span>(maxsofttype == 7)
              maxsofttype = (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7;
            <span class="keywordflow">else</span>
              {
                <span class="keywordflow">if</span>(((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.d.bitflags &gt;&gt; 2) &amp; 7) != 7)
                  {
                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7)] &gt;
                       <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                      {
                        maxsofttype = ((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7);
                        diffsoftflag = 1;
                      }
                    <span class="keywordflow">else</span>
                      {
                        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7)] &lt;
                           <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                          diffsoftflag = 1;
                      }
                  }
              }

            <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags = (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &amp; 3) + 4 * maxsofttype + 32 * diffsoftflag;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft &lt; maxsoft)
              <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft = maxsoft;
            maxsoft = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            no = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;

          }
        <span class="keywordflow">while</span>(no &gt;= 0);
      }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab8e5d4fed349d96c6d4f55897473ce19_icgraph.png" border="0" usemap="#proto_8h_ab8e5d4fed349d96c6d4f55897473ce19_icgraph" alt=""/></div>
<map name="proto_8h_ab8e5d4fed349d96c6d4f55897473ce19_icgraph" id="proto_8h_ab8e5d4fed349d96c6d4f55897473ce19_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="249,105,463,135"/><area shape="rect" id="node5" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="513,72,631,101"/><area shape="rect" id="node28" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="513,139,631,168"/><area shape="rect" id="node7" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="681,112,823,141"/><area shape="rect" id="node16" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="703,59,801,88"/><area shape="rect" id="node21" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="697,5,807,35"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="872,163,1091,192"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1151,97,1193,127"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1255,59,1308,88"/><area shape="rect" id="node18" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="896,59,1067,88"/><area shape="rect" id="node23" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="961,5,1001,35"/><area shape="rect" id="node25" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1139,19,1205,48"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4764c1fb83a956c1712345538630854c"></a><!-- doxytag: member="proto.h::force_update_hmax" ref="a4764c1fb83a956c1712345538630854c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_hmax </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function updates the hmax-values in tree nodes that hold SPH particles. These values are needed to find all neighbors in the hydro-force computation. Since the Hsml-values are potentially changed in the SPH-denity computation, <a class="el" href="forcetree_8c.html#a4764c1fb83a956c1712345538630854c">force_update_hmax()</a> should be carried out just before the hydrodynamical SPH forces are computed, i.e. after <a class="el" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c">density()</a>. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01014">1014</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00063">DomainHmax</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="forcetree_8c_source.html#l01051">force_update_node_hmax_local()</a>, <a class="el" href="forcetree_8c_source.html#l01087">force_update_node_hmax_toptree()</a>, <a class="el" href="allvars_8h_source.html#l00618">extNODE::hmax</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="tags_8h_source.html#l00012">TAG_HMAX</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no;
  MPI_Status status;
  <span class="keywordtype">int</span> level, sendTask, recvTask;

  <a class="code" href="forcetree_8c.html#a4c108b1da2bc4f2620f62aeab90c1074">force_update_node_hmax_local</a>();

  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>; i &lt;= <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[i] = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a>;
    }

  <span class="comment">/* share the hmax-data of the pseudo-particles accross CPUs */</span>

  <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
    {
      sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
      recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ level;

      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[sendTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask] + 1) * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a4471e29d2a7331edc863bbf97d324190">TAG_HMAX</a>,
                     &amp;<a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[recvTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask] + 1) * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a4471e29d2a7331edc863bbf97d324190">TAG_HMAX</a>, MPI_COMM_WORLD, &amp;status);
    }


  <a class="code" href="forcetree_8c.html#ac3f5945bb7c73936ef49af1507265afe">force_update_node_hmax_toptree</a>();
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a4764c1fb83a956c1712345538630854c_cgraph.png" border="0" usemap="#proto_8h_a4764c1fb83a956c1712345538630854c_cgraph" alt=""/></div>
<map name="proto_8h_a4764c1fb83a956c1712345538630854c_cgraph" id="proto_8h_a4764c1fb83a956c1712345538630854c_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a4c108b1da2bc4f2620f62aeab90c1074" title="force_update_node_hmax_local" alt="" coords="212,5,436,35"/><area shape="rect" id="node5" href="forcetree_8c.html#ac3f5945bb7c73936ef49af1507265afe" title="force_update_node_hmax_toptree" alt="" coords="203,59,445,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a4764c1fb83a956c1712345538630854c_icgraph.png" border="0" usemap="#proto_8h_a4764c1fb83a956c1712345538630854c_icgraph" alt=""/></div>
<map name="proto_8h_a4764c1fb83a956c1712345538630854c_icgraph" id="proto_8h_a4764c1fb83a956c1712345538630854c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="203,5,373,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="421,5,464,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="513,5,567,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a04fb647ef783d5baeb9275d806c08365"></a><!-- doxytag: member="proto.h::force_update_len" ref="a04fb647ef783d5baeb9275d806c08365" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_len </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function updates the side-length of tree nodes in case the tree is not reconstructed, but only drifted. The grouping of particles to tree nodes is not changed in this case, but some tree nodes may need to be enlarged because particles moved out of their original bounds. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00885">885</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00062">DomainTreeNodeLen</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="forcetree_8c_source.html#l00923">force_update_node_len_local()</a>, <a class="el" href="forcetree_8c_source.html#l00970">force_update_node_len_toptree()</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="tags_8h_source.html#l00011">TAG_NODELEN</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no;
  MPI_Status status;
  <span class="keywordtype">int</span> level, sendTask, recvTask;

  <a class="code" href="forcetree_8c.html#a4592b750f8555f580691103acf1e5366">force_update_node_len_local</a>();

  <span class="comment">/* first update the side-lengths of all local nodes */</span>
  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>; i &lt;= <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

      <a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[i] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;
    }

  <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
    {
      sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
      recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ level;

      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[sendTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[sendTask] + 1) * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a34f71af73ed54d427aaa8c6df5d3a3d2">TAG_NODELEN</a>,
                     &amp;<a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask]],
                     (<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>[recvTask] - <a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>[recvTask] + 1) * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>),
                     MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a34f71af73ed54d427aaa8c6df5d3a3d2">TAG_NODELEN</a>, MPI_COMM_WORLD, &amp;status);
    }

  <span class="comment">/* Finally, we update the top-level tree. */</span>
  <a class="code" href="forcetree_8c.html#a5f85438d619d63c812c8e05faf1f0074">force_update_node_len_toptree</a>();
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a04fb647ef783d5baeb9275d806c08365_cgraph.png" border="0" usemap="#proto_8h_a04fb647ef783d5baeb9275d806c08365_cgraph" alt=""/></div>
<map name="proto_8h_a04fb647ef783d5baeb9275d806c08365_cgraph" id="proto_8h_a04fb647ef783d5baeb9275d806c08365_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a4592b750f8555f580691103acf1e5366" title="force_update_node_len_local" alt="" coords="197,5,403,35"/><area shape="rect" id="node5" href="forcetree_8c.html#a5f85438d619d63c812c8e05faf1f0074" title="force_update_node_len_toptree" alt="" coords="188,59,412,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a04fb647ef783d5baeb9275d806c08365_icgraph.png" border="0" usemap="#proto_8h_a04fb647ef783d5baeb9275d806c08365_icgraph" alt=""/></div>
<map name="proto_8h_a04fb647ef783d5baeb9275d806c08365_icgraph" id="proto_8h_a04fb647ef783d5baeb9275d806c08365_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="188,5,305,35"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="355,5,573,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="621,5,664,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="713,5,767,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0292cb282788bf4e4f06636096c5abdf"></a><!-- doxytag: member="proto.h::force_update_node" ref="a0292cb282788bf4e4f06636096c5abdf" args="(int no, int flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_node </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>no</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a4c108b1da2bc4f2620f62aeab90c1074"></a><!-- doxytag: member="proto.h::force_update_node_hmax_local" ref="a4c108b1da2bc4f2620f62aeab90c1074" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_node_hmax_local </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine updates the hmax-values of local tree nodes. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01051">1051</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="allvars_8h_source.html#l00618">extNODE::hmax</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l01014">force_update_hmax()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p, no;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i++)
    {

      no = <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[i];

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml &gt; <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax)
        {

          <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
          p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;

          <span class="keywordflow">while</span>(p &gt;= 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax &gt; <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax)
                {
                  <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a> = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a>;
                  no = p;
                  p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;
                }
              <span class="keywordflow">else</span>
                <span class="keywordflow">break</span>;
            }
        }

    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a4c108b1da2bc4f2620f62aeab90c1074_icgraph.png" border="0" usemap="#proto_8h_a4c108b1da2bc4f2620f62aeab90c1074_icgraph" alt=""/></div>
<map name="proto_8h_a4c108b1da2bc4f2620f62aeab90c1074_icgraph" id="proto_8h_a4c108b1da2bc4f2620f62aeab90c1074_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a4764c1fb83a956c1712345538630854c" title="force_update_hmax" alt="" coords="277,5,427,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="475,5,645,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="693,5,736,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="785,5,839,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac3f5945bb7c73936ef49af1507265afe"></a><!-- doxytag: member="proto.h::force_update_node_hmax_toptree" ref="ac3f5945bb7c73936ef49af1507265afe" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_node_hmax_toptree </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function recursively sets the hmax-values of the top-level tree. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l01087">1087</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00063">DomainHmax</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8h_source.html#l00618">extNODE::hmax</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l01014">force_update_hmax()</a>.</p>

<p><div class="fragment"><pre class="fragment">{

  <span class="keywordtype">int</span> i, no, p;


  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>)
      {
        no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax &lt; <a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[i])
          <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a> = <a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>[i];

        p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;

        <span class="keywordflow">while</span>(p &gt;= 0)
          {
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].hmax &gt; <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax)
              {
                <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a> = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a>;
                no = p;
                p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;
              }
            <span class="keywordflow">else</span>
              <span class="keywordflow">break</span>;
          }
      }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ac3f5945bb7c73936ef49af1507265afe_icgraph.png" border="0" usemap="#proto_8h_ac3f5945bb7c73936ef49af1507265afe_icgraph" alt=""/></div>
<map name="proto_8h_ac3f5945bb7c73936ef49af1507265afe_icgraph" id="proto_8h_ac3f5945bb7c73936ef49af1507265afe_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a4764c1fb83a956c1712345538630854c" title="force_update_hmax" alt="" coords="296,5,445,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="493,5,664,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="712,5,755,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="804,5,857,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4592b750f8555f580691103acf1e5366"></a><!-- doxytag: member="proto.h::force_update_node_len_local" ref="a4592b750f8555f580691103acf1e5366" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_node_len_local </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function recursively enlarges nodes such that they always contain all their daughter nodes and daughter particles. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00923">923</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00885">force_update_len()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p, k, no;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> dist, distmax;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      no = <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[i];

      <span class="keywordflow">for</span>(k = 0, distmax = 0; k &lt; 3; k++)
        {
          dist = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[k] - <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[k];
          <span class="keywordflow">if</span>(dist &lt; 0)
            dist = -dist;
          <span class="keywordflow">if</span>(dist &gt; distmax)
            distmax = dist;
        }

      <span class="keywordflow">if</span>(distmax + distmax &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
        {
          <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> = distmax + distmax;
          p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;

          <span class="keywordflow">while</span>(p &gt;= 0)
            {
              distmax = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0];
              <span class="keywordflow">if</span>(distmax &lt; 0)
                distmax = -distmax;
              distmax = distmax + distmax + <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;

              <span class="keywordflow">if</span>(0.999999 * distmax &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].len)
                {
                  <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> = distmax;
                  no = p;
                  p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;
                }
              <span class="keywordflow">else</span>
                <span class="keywordflow">break</span>;
            }
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a4592b750f8555f580691103acf1e5366_icgraph.png" border="0" usemap="#proto_8h_a4592b750f8555f580691103acf1e5366_icgraph" alt=""/></div>
<map name="proto_8h_a4592b750f8555f580691103acf1e5366_icgraph" id="proto_8h_a4592b750f8555f580691103acf1e5366_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04fb647ef783d5baeb9275d806c08365" title="force_update_len" alt="" coords="263,5,393,35"/><area shape="rect" id="node5" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="444,5,561,35"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="611,5,829,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="877,5,920,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="969,5,1023,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5f85438d619d63c812c8e05faf1f0074"></a><!-- doxytag: member="proto.h::force_update_node_len_toptree" ref="a5f85438d619d63c812c8e05faf1f0074" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_node_len_toptree </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function recursively enlarges nodes of the top-level tree such that they always contain all their daughter nodes. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00970">970</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00062">DomainTreeNodeLen</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00075">NTopleaves</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00885">force_update_len()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no, p;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> distmax;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a820bd6735d7313b9e7a3dcbe6c2f93d4">NTopleaves</a>; i++)
    <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; <a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>)
      {
        no = <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i];

        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> &lt; <a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[i])
          <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> = <a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>[i];

        p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;

        <span class="keywordflow">while</span>(p &gt;= 0)
          {
            distmax = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0];
            <span class="keywordflow">if</span>(distmax &lt; 0)
              distmax = -distmax;
            distmax = distmax + distmax + <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;

            <span class="keywordflow">if</span>(0.999999 * distmax &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>)
              {
                <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a> = distmax;
                no = p;
                p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;
              }
            <span class="keywordflow">else</span>
              <span class="keywordflow">break</span>;
          }
      }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a5f85438d619d63c812c8e05faf1f0074_icgraph.png" border="0" usemap="#proto_8h_a5f85438d619d63c812c8e05faf1f0074_icgraph" alt=""/></div>
<map name="proto_8h_a5f85438d619d63c812c8e05faf1f0074_icgraph" id="proto_8h_a5f85438d619d63c812c8e05faf1f0074_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04fb647ef783d5baeb9275d806c08365" title="force_update_len" alt="" coords="281,5,412,35"/><area shape="rect" id="node5" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="463,5,580,35"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="629,5,848,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="896,5,939,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="988,5,1041,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab745c54c805d07ad255a3f86ff77e18d"></a><!-- doxytag: member="proto.h::force_update_node_recursive" ref="ab745c54c805d07ad255a3f86ff77e18d" args="(int no, int sib, int father)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_node_recursive </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>no</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sib</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>father</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>this routine determines the multipole moments for a given internal node and all its subnodes using a recursive computation. The result is stored in the Nodes[] structure in the sequence of this tree-walk.</p>
<p>Note that the bitflags-variable for each node is used to store in the lowest bits some special information: Bit 0 flags whether the node belongs to the top-level tree corresponding to the domain decomposition, while Bit 1 signals whether the top-level node is dependent on local mass.</p>
<p>If UNEQUALSOFTENINGS is set, bits 2-4 give the particle type with the maximum softening among the particles in the node, and bit 5 flags whether the node contains any particles with lower softening than that. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00422">422</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="forcetree_8c_source.html#l00422">force_update_node_recursive()</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="allvars_8h_source.html#l00618">extNODE::hmax</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="forcetree_8c_source.html#l00026">last</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00593">NODE::suns</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00619">extNODE::vs</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>, and <a class="el" href="forcetree_8c_source.html#l00422">force_update_node_recursive()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> j, jj, p, pp, nextsib, <a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[8];
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> hmax;

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype, diffsoftflag;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  <span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a> *pa;
  <span class="keywordtype">double</span> s[3], vs[3], mass;

  <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> &amp;&amp; no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)  <span class="comment">/* internal node */</span>
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
        suns[j] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].u.<a class="code" href="structNODE.html#a2a31ed85a69cd67dce1861bd327ac6e9">suns</a>[j];  <span class="comment">/* this &quot;backup&quot; is necessary because the nextnode entry will</span>
<span class="comment">                                           overwrite one element (union!) */</span>
      <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= 0)
        {
          <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
            {
              <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)        <span class="comment">/* a pseudo-particle */</span>
                <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>] = no;
              <span class="keywordflow">else</span>
                <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode = no;
            }
          <span class="keywordflow">else</span>
            <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>] = no;
        }

      <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> = no;

      mass = 0;
      s[0] = 0;
      s[1] = 0;
      s[2] = 0;
      vs[0] = 0;
      vs[1] = 0;
      vs[2] = 0;
      hmax = 0;
<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      maxsofttype = 7;
      diffsoftflag = 0;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      maxsoft = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
        {
          <span class="keywordflow">if</span>((p = suns[j]) &gt;= 0)
            {
              <span class="comment">/* check if we have a sibling on the same level */</span>
              <span class="keywordflow">for</span>(jj = j + 1; jj &lt; 8; jj++)
                <span class="keywordflow">if</span>((pp = suns[jj]) &gt;= 0)
                  <span class="keywordflow">break</span>;

              <span class="keywordflow">if</span>(jj &lt; 8)        <span class="comment">/* yes, we do */</span>
                nextsib = pp;
              <span class="keywordflow">else</span>
                nextsib = sib;

              <a class="code" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d">force_update_node_recursive</a>(p, nextsib, no);


              <span class="keywordflow">if</span>(p &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)      <span class="comment">/* an internal node or pseudo particle */</span>
                {
                  <span class="keywordflow">if</span>(p &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)       <span class="comment">/* a pseudo particle */</span>
                    {
                      <span class="comment">/* nothing to be done here because the mass of the</span>
<span class="comment">                       * pseudo-particle is still zero. This will be changed</span>
<span class="comment">                       * later.</span>
<span class="comment">                       */</span>
                    }
                  <span class="keywordflow">else</span>
                    {
                      mass += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass;
                      s[0] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[0];
                      s[1] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[1];
                      s[2] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[2];
                      vs[0] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass * <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[0];
                      vs[1] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass * <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[1];
                      vs[2] += <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass * <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[2];

                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].hmax &gt; hmax)
                        hmax = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[p].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a>;

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>                      diffsoftflag |= (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 5) &amp; 1;

                      <span class="keywordflow">if</span>(maxsofttype == 7)
                        {
                          maxsofttype = (<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7;
                        }
                      <span class="keywordflow">else</span>
                        {
                          <span class="keywordflow">if</span>(((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7) != 7)
                            {
                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7)] &gt;
                                 <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                                {
                                  maxsofttype = ((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7);
                                  diffsoftflag = 1;
                                }
                              <span class="keywordflow">else</span>
                                {
                                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[((<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags &gt;&gt; 2) &amp; 7)] &lt;
                                     <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                                    diffsoftflag = 1;
                                }
                            }
                        }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].maxsoft &gt; maxsoft)
                        maxsoft = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[p].maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                    }
                }
              <span class="keywordflow">else</span>              <span class="comment">/* a particle */</span>
                {
                  pa = &amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p];

                  mass += pa-&gt;<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
                  s[0] += pa-&gt;<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
                  s[1] += pa-&gt;<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
                  s[2] += pa-&gt;<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
                  vs[0] += pa-&gt;<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[0];
                  vs[1] += pa-&gt;<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[1];
                  vs[2] += pa-&gt;<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[2];

<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>                  <span class="keywordflow">if</span>(maxsofttype == 7)
                    {
                      maxsofttype = pa-&gt;<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[pa-&gt;<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                        {
                          maxsofttype = pa-&gt;<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
                          diffsoftflag = 1;
                        }
                      <span class="keywordflow">else</span>
                        {
                          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[pa-&gt;<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[maxsofttype])
                            diffsoftflag = 1;
                        }
                    }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>                  <span class="keywordflow">if</span>(pa-&gt;<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Hsml &gt; maxsoft)
                        maxsoft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[pa-&gt;<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] &gt; maxsoft)
                        maxsoft = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[pa-&gt;<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
                    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                  <span class="keywordflow">if</span>(pa-&gt;<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Hsml &gt; hmax)
                      hmax = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
                }
            }
        }


      <span class="keywordflow">if</span>(mass)
        {
          s[0] /= mass;
          s[1] /= mass;
          s[2] /= mass;
          vs[0] /= mass;
          vs[1] /= mass;
          vs[2] /= mass;
        }
      <span class="keywordflow">else</span>
        {
          s[0] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0];
          s[1] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1];
          s[2] = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2];
        }

      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[0] = s[0];
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[1] = s[1];
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[2] = s[2];
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass = mass;


<span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags = 4 * maxsofttype + 32 * diffsoftflag;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags = 0;
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].maxsoft = maxsoft;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.bitflags = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

      <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[0] = vs[0];
      <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[1] = vs[1];
      <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[2] = vs[2];
      <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a> = hmax;

      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling = sib;
      <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father = father;
    }
  <span class="keywordflow">else</span>                          <span class="comment">/* single particle or pseudo particle */</span>
    {
      <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= 0)
        {
          <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
            {
              <span class="keywordflow">if</span>(<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)        <span class="comment">/* a pseudo-particle */</span>
                <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>] = no;
              <span class="keywordflow">else</span>
                <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode = no;
            }
          <span class="keywordflow">else</span>
            <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[<a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a>] = no;
        }

      <a class="code" href="forcetree_8c.html#a72e27dee31b1c4c6a504fbed29542d97">last</a> = no;

      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)      <span class="comment">/* only set it for single particles */</span>
        <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[no] = father;
    }

}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab745c54c805d07ad255a3f86ff77e18d_cgraph.png" border="0" usemap="#proto_8h_ab745c54c805d07ad255a3f86ff77e18d_cgraph" alt=""/></div>
<map name="proto_8h_ab745c54c805d07ad255a3f86ff77e18d_cgraph" id="proto_8h_ab745c54c805d07ad255a3f86ff77e18d_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="264,29,475,59"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ab745c54c805d07ad255a3f86ff77e18d_icgraph.png" border="0" usemap="#proto_8h_ab745c54c805d07ad255a3f86ff77e18d_icgraph" alt=""/></div>
<map name="proto_8h_ab745c54c805d07ad255a3f86ff77e18d_icgraph" id="proto_8h_ab745c54c805d07ad255a3f86ff77e18d_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="265,109,425,139"/><area shape="rect" id="node5" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="475,109,592,139"/><area shape="rect" id="node7" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="641,56,783,85"/><area shape="rect" id="node16" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="663,109,761,139"/><area shape="rect" id="node21" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="657,163,767,192"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="832,5,1051,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1111,71,1153,100"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1215,111,1268,140"/><area shape="rect" id="node18" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="856,109,1027,139"/><area shape="rect" id="node23" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="921,163,961,192"/><area shape="rect" id="node25" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1099,149,1165,179"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af9a7e3a922557e089da5d7ee1dde89a0"></a><!-- doxytag: member="proto.h::force_update_pseudoparticles" ref="af9a7e3a922557e089da5d7ee1dde89a0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_pseudoparticles </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function updates the multipole moments of the pseudo-particles that represent the mass distribution on different CPUs. For that purpose, it first exchanges the necessary data, and then updates the top-level tree accordingly. The detailed implementation of these two tasks is done in separate functions. </p>

<p>Definition at line <a class="el" href="forcetree_8c_source.html#l00671">671</a> of file <a class="el" href="forcetree_8c_source.html">forcetree.c</a>.</p>

<p>References <a class="el" href="forcetree_8c_source.html#l00684">force_exchange_pseudodata()</a>, and <a class="el" href="forcetree_8c_source.html#l00732">force_treeupdate_pseudos()</a>.</p>

<p>Referenced by <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>, and <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <a class="code" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb">force_exchange_pseudodata</a>();

  <a class="code" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19">force_treeupdate_pseudos</a>();
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af9a7e3a922557e089da5d7ee1dde89a0_cgraph.png" border="0" usemap="#proto_8h_af9a7e3a922557e089da5d7ee1dde89a0_cgraph" alt=""/></div>
<map name="proto_8h_af9a7e3a922557e089da5d7ee1dde89a0_cgraph" id="proto_8h_af9a7e3a922557e089da5d7ee1dde89a0_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb" title="force_exchange_pseudodata" alt="" coords="271,5,476,35"/><area shape="rect" id="node5" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19" title="force_treeupdate_pseudos" alt="" coords="277,59,469,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af9a7e3a922557e089da5d7ee1dde89a0_icgraph.png" border="0" usemap="#proto_8h_af9a7e3a922557e089da5d7ee1dde89a0_icgraph" alt=""/></div>
<map name="proto_8h_af9a7e3a922557e089da5d7ee1dde89a0_icgraph" id="proto_8h_af9a7e3a922557e089da5d7ee1dde89a0_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="271,72,388,101"/><area shape="rect" id="node26" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="271,139,388,168"/><area shape="rect" id="node5" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="439,112,580,141"/><area shape="rect" id="node14" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="460,59,559,88"/><area shape="rect" id="node19" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="455,5,564,35"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="629,163,848,192"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="908,97,951,127"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1012,59,1065,88"/><area shape="rect" id="node16" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="653,59,824,88"/><area shape="rect" id="node21" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="719,5,759,35"/><area shape="rect" id="node23" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="896,19,963,48"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a207b80df2a123bc29295a0d496186d70"></a><!-- doxytag: member="proto.h::force_update_size_of_parent_node" ref="a207b80df2a123bc29295a0d496186d70" args="(int no)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void force_update_size_of_parent_node </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>no</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a99877ff0dc6228eabf8f959569f2771e"></a><!-- doxytag: member="proto.h::free_memory" ref="a99877ff0dc6228eabf8f959569f2771e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_memory </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine frees the memory for the particle storage. Note: We don't actually bother to call it in the code... When the program terminats, the memory will be automatically freed by the operating system. </p>

<p>Definition at line <a class="el" href="allocate_8c_source.html#l00144">144</a> of file <a class="el" href="allocate_8c_source.html">allocate.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00276">global_data_all_processes::MaxPartSph</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8c_source.html#l00128">SphP</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> &gt; 0)
    free(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>);

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> &gt; 0)
    free(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a49492470fcccf9d05bf51993f281f16c"></a><!-- doxytag: member="proto.h::get_bytes_per_blockelement" ref="a49492470fcccf9d05bf51993f281f16c" args="(enum iofields blocknr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_bytes_per_blockelement </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a>&nbsp;</td>
          <td class="paramname"> <em>blocknr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function tells the size of one data entry in each of the blocks defined for the output file. If one wants to add a new output-block, this function should be augmented accordingly. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00366">366</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00669">IO_ACCEL</a>, <a class="el" href="allvars_8h_source.html#l00670">IO_DTENTR</a>, <a class="el" href="allvars_8h_source.html#l00667">IO_HSML</a>, <a class="el" href="allvars_8h_source.html#l00663">IO_ID</a>, <a class="el" href="allvars_8h_source.html#l00664">IO_MASS</a>, <a class="el" href="allvars_8h_source.html#l00661">IO_POS</a>, <a class="el" href="allvars_8h_source.html#l00668">IO_POT</a>, <a class="el" href="allvars_8h_source.html#l00666">IO_RHO</a>, <a class="el" href="allvars_8h_source.html#l00671">IO_TSTP</a>, <a class="el" href="allvars_8h_source.html#l00665">IO_U</a>, and <a class="el" href="allvars_8h_source.html#l00662">IO_VEL</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> bytes_per_blockelement = 0;

  <span class="keywordflow">switch</span> (blocknr)
    {
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a0207eb67d96fe97fb8158c42af624f8f">IO_POS</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aa4c3992546632e0db8015ebe534c0282">IO_VEL</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>:
      bytes_per_blockelement = 3 * <span class="keyword">sizeof</span>(float);
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>:
<span class="preprocessor">#ifdef LONGIDS</span>
<span class="preprocessor"></span>      bytes_per_blockelement = <span class="keyword">sizeof</span>(<span class="keywordtype">long</span> long);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      bytes_per_blockelement = <span class="keyword">sizeof</span>(int);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a72e1cc8b602ab38f0f3491464ed82063">IO_MASS</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a8dd43018a3f2d1caed951b249a38b106">IO_RHO</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a429c6a7a56e3b53597bd1eb72b87f941">IO_HSML</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>:
      bytes_per_blockelement = <span class="keyword">sizeof</span>(float);
      <span class="keywordflow">break</span>;
    }

  <span class="keywordflow">return</span> bytes_per_blockelement;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a49492470fcccf9d05bf51993f281f16c_icgraph.png" border="0" usemap="#proto_8h_a49492470fcccf9d05bf51993f281f16c_icgraph" alt=""/></div>
<map name="proto_8h_a49492470fcccf9d05bf51993f281f16c_icgraph" id="proto_8h_a49492470fcccf9d05bf51993f281f16c_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="263,5,337,35"/><area shape="rect" id="node13" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="261,59,339,88"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="408,5,475,35"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="633,5,673,35"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="811,5,877,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="927,32,980,61"/><area shape="rect" id="node15" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="387,59,496,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="544,59,763,88"/><area shape="rect" id="node19" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="823,59,865,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4d30ce1aad9c69d5af676a6a13173686"></a><!-- doxytag: member="proto.h::get_dataset_name" ref="a4d30ce1aad9c69d5af676a6a13173686" args="(enum iofields blocknr, char *buf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void get_dataset_name </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a>&nbsp;</td>
          <td class="paramname"> <em>blocknr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function returns a descriptive character string that describes the name of the block when the HDF5 file format is used. If one wants to add a new output-block, this function should be augmented accordingly. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00613">613</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00669">IO_ACCEL</a>, <a class="el" href="allvars_8h_source.html#l00670">IO_DTENTR</a>, <a class="el" href="allvars_8h_source.html#l00667">IO_HSML</a>, <a class="el" href="allvars_8h_source.html#l00663">IO_ID</a>, <a class="el" href="allvars_8h_source.html#l00664">IO_MASS</a>, <a class="el" href="allvars_8h_source.html#l00661">IO_POS</a>, <a class="el" href="allvars_8h_source.html#l00668">IO_POT</a>, <a class="el" href="allvars_8h_source.html#l00666">IO_RHO</a>, <a class="el" href="allvars_8h_source.html#l00671">IO_TSTP</a>, <a class="el" href="allvars_8h_source.html#l00665">IO_U</a>, and <a class="el" href="allvars_8h_source.html#l00662">IO_VEL</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{

  strcpy(buf, <span class="stringliteral">&quot;default&quot;</span>);

  <span class="keywordflow">switch</span> (blocknr)
    {
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a0207eb67d96fe97fb8158c42af624f8f">IO_POS</a>:
      strcpy(buf, <span class="stringliteral">&quot;Coordinates&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aa4c3992546632e0db8015ebe534c0282">IO_VEL</a>:
      strcpy(buf, <span class="stringliteral">&quot;Velocities&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>:
      strcpy(buf, <span class="stringliteral">&quot;ParticleIDs&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a72e1cc8b602ab38f0f3491464ed82063">IO_MASS</a>:
      strcpy(buf, <span class="stringliteral">&quot;Masses&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>:
      strcpy(buf, <span class="stringliteral">&quot;InternalEnergy&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a8dd43018a3f2d1caed951b249a38b106">IO_RHO</a>:
      strcpy(buf, <span class="stringliteral">&quot;Density&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a429c6a7a56e3b53597bd1eb72b87f941">IO_HSML</a>:
      strcpy(buf, <span class="stringliteral">&quot;SmoothingLength&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>:
      strcpy(buf, <span class="stringliteral">&quot;Potential&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>:
      strcpy(buf, <span class="stringliteral">&quot;Acceleration&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>:
      strcpy(buf, <span class="stringliteral">&quot;RateOfChangeOfEntropy&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>:
      strcpy(buf, <span class="stringliteral">&quot;TimeStep&quot;</span>);
      <span class="keywordflow">break</span>;
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a4d30ce1aad9c69d5af676a6a13173686_icgraph.png" border="0" usemap="#proto_8h_a4d30ce1aad9c69d5af676a6a13173686_icgraph" alt=""/></div>
<map name="proto_8h_a4d30ce1aad9c69d5af676a6a13173686_icgraph" id="proto_8h_a4d30ce1aad9c69d5af676a6a13173686_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="199,5,273,35"/><area shape="rect" id="node13" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="197,59,275,88"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="344,5,411,35"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="569,5,609,35"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="747,5,813,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="863,32,916,61"/><area shape="rect" id="node15" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="323,59,432,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="480,59,699,88"/><area shape="rect" id="node19" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="759,59,801,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="acdf59daa02f065452a596cf88b4de1a1"></a><!-- doxytag: member="proto.h::get_datatype_in_block" ref="acdf59daa02f065452a596cf88b4de1a1" args="(enum iofields blocknr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_datatype_in_block </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a>&nbsp;</td>
          <td class="paramname"> <em>blocknr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function returns the type of the data contained in a given block of the output file. If one wants to add a new output-block, this function should be augmented accordingly. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00405">405</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00663">IO_ID</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> typekey;

  <span class="keywordflow">switch</span> (blocknr)
    {
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>:
<span class="preprocessor">#ifdef LONGIDS</span>
<span class="preprocessor"></span>      typekey = 2;              <span class="comment">/* native long long */</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      typekey = 0;              <span class="comment">/* native int */</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;

    <span class="keywordflow">default</span>:
      typekey = 1;              <span class="comment">/* native float */</span>
      <span class="keywordflow">break</span>;
    }

  <span class="keywordflow">return</span> typekey;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_acdf59daa02f065452a596cf88b4de1a1_icgraph.png" border="0" usemap="#proto_8h_acdf59daa02f065452a596cf88b4de1a1_icgraph" alt=""/></div>
<map name="proto_8h_acdf59daa02f065452a596cf88b4de1a1_icgraph" id="proto_8h_acdf59daa02f065452a596cf88b4de1a1_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="220,5,295,35"/><area shape="rect" id="node13" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="219,59,296,88"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="365,5,432,35"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="591,5,631,35"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="768,5,835,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="884,32,937,61"/><area shape="rect" id="node15" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="344,59,453,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="501,59,720,88"/><area shape="rect" id="node19" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="780,59,823,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="adadb384299eb936596574417d4b6b28c"></a><!-- doxytag: member="proto.h::get_drift_factor" ref="adadb384299eb936596574417d4b6b28c" args="(int time0, int time1)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double get_drift_factor </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>time0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>time1</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function integrates the cosmological prefactor for a drift step between time0 and time1. The value returned is * </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \int_{a_0}^{a_1} \frac{{\rm d}a}{H(a)} * \]" src="form_3.png"/>
</p>
 
<p><p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors </p>
</p>

<p>Definition at line <a class="el" href="driftfac_8c_source.html#l00067">67</a> of file <a class="el" href="driftfac_8c_source.html">driftfac.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00111">DRIFT_TABLE_LENGTH</a>, <a class="el" href="allvars_8c_source.html#l00098">DriftTable</a>, <a class="el" href="driftfac_8c_source.html#l00016">logTimeBegin</a>, <a class="el" href="driftfac_8c_source.html#l00017">logTimeMax</a>, and <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>.</p>

<p>Referenced by <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> a1, a2, df1, df2, u1, u2;
  <span class="keywordtype">int</span> i1, i2;

  <span class="comment">/* note: will only be called for cosmological integration */</span>

  a1 = <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + time0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
  a2 = <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + time1 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  u1 = (a1 - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / (<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) * DRIFT_TABLE_LENGTH;
  i1 = (int) u1;
  <span class="keywordflow">if</span>(i1 &gt;= <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a>)
    i1 = <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a> - 1;

  <span class="keywordflow">if</span>(i1 &lt;= 1)
    df1 = u1 * <a class="code" href="allvars_8c.html#a074db1ef4adfe88a5f3b07eac8c1daae">DriftTable</a>[0];
  <span class="keywordflow">else</span>
    df1 = DriftTable[i1 - 1] + (DriftTable[i1] - DriftTable[i1 - 1]) * (u1 - i1);


  u2 = (a2 - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / (<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) * DRIFT_TABLE_LENGTH;
  i2 = (int) u2;
  <span class="keywordflow">if</span>(i2 &gt;= <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a>)
    i2 = <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a> - 1;

  <span class="keywordflow">if</span>(i2 &lt;= 1)
    df2 = u2 * DriftTable[0];
  <span class="keywordflow">else</span>
    df2 = DriftTable[i2 - 1] + (DriftTable[i2] - DriftTable[i2 - 1]) * (u2 - i2);

  <span class="keywordflow">return</span> df2 - df1;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_adadb384299eb936596574417d4b6b28c_icgraph.png" border="0" usemap="#proto_8h_adadb384299eb936596574417d4b6b28c_icgraph" alt=""/></div>
<map name="proto_8h_adadb384299eb936596574417d4b6b28c_icgraph" id="proto_8h_adadb384299eb936596574417d4b6b28c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="175,5,292,35"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="341,5,560,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="608,5,651,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="700,5,753,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a29057b821b850ab54b318d7339633059"></a><!-- doxytag: member="proto.h::get_gravkick_factor" ref="a29057b821b850ab54b318d7339633059" args="(int time0, int time1)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double get_gravkick_factor </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>time0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>time1</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function integrates the cosmological prefactor for a kick step of the gravitational force. </p>

<p><p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors </p>
</p>

<p>Definition at line <a class="el" href="driftfac_8c_source.html#l00105">105</a> of file <a class="el" href="driftfac_8c_source.html">driftfac.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00111">DRIFT_TABLE_LENGTH</a>, <a class="el" href="allvars_8c_source.html#l00099">GravKickTable</a>, <a class="el" href="driftfac_8c_source.html#l00016">logTimeBegin</a>, <a class="el" href="driftfac_8c_source.html#l00017">logTimeMax</a>, and <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="global_8c_source.html#l00022">compute_global_quantities_of_system()</a>, <a class="el" href="io_8c_source.html#l00129">fill_write_buffer()</a>, and <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> a1, a2, df1, df2, u1, u2;
  <span class="keywordtype">int</span> i1, i2;

  <span class="comment">/* note: will only be called for cosmological integration */</span>

  a1 = <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + time0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
  a2 = <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + time1 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  u1 = (a1 - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / (<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) * DRIFT_TABLE_LENGTH;
  i1 = (int) u1;
  <span class="keywordflow">if</span>(i1 &gt;= <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a>)
    i1 = <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a> - 1;

  <span class="keywordflow">if</span>(i1 &lt;= 1)
    df1 = u1 * <a class="code" href="allvars_8c.html#a38e5d8b595161f074f7fbede3a8fda66">GravKickTable</a>[0];
  <span class="keywordflow">else</span>
    df1 = GravKickTable[i1 - 1] + (GravKickTable[i1] - GravKickTable[i1 - 1]) * (u1 - i1);


  u2 = (a2 - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / (<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) * DRIFT_TABLE_LENGTH;
  i2 = (int) u2;
  <span class="keywordflow">if</span>(i2 &gt;= <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a>)
    i2 = <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a> - 1;

  <span class="keywordflow">if</span>(i2 &lt;= 1)
    df2 = u2 * GravKickTable[0];
  <span class="keywordflow">else</span>
    df2 = GravKickTable[i2 - 1] + (GravKickTable[i2] - GravKickTable[i2 - 1]) * (u2 - i2);

  <span class="keywordflow">return</span> df2 - df1;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a29057b821b850ab54b318d7339633059_icgraph.png" border="0" usemap="#proto_8h_a29057b821b850ab54b318d7339633059_icgraph" alt=""/></div>
<map name="proto_8h_a29057b821b850ab54b318d7339633059_icgraph" id="proto_8h_a29057b821b850ab54b318d7339633059_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="683,5,891,35"/><area shape="rect" id="node9" href="proto_8h.html#ada58109949c2431ca9b0cdaa01cfb5b1" title="compute_global_quantities_of_system" alt="" coords="368,57,635,87"/><area shape="rect" id="node14" href="proto_8h.html#aea8fa222a10c4796687c6ff25550cd74" title="fill_write_buffer" alt="" coords="203,109,317,139"/><area shape="rect" id="node24" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="201,163,319,192"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1205,84,1248,113"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1297,84,1351,113"/><area shape="rect" id="node11" href="run_8c.html#ae903322da17c6875ab606b032b918099" title="energy_statistics" alt="" coords="983,57,1113,87"/><area shape="rect" id="node16" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="463,111,540,140"/><area shape="rect" id="node18" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="732,111,841,140"/><area shape="rect" id="node20" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="939,161,1157,191"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ace65dca1556185b12c7f22427724c90c"></a><!-- doxytag: member="proto.h::get_hydrokick_factor" ref="ace65dca1556185b12c7f22427724c90c" args="(int time0, int time1)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double get_hydrokick_factor </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>time0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>time1</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function integrates the cosmological prefactor for a kick step of the hydrodynamical force. </p>

<p><p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors </p>
</p>

<p>Definition at line <a class="el" href="driftfac_8c_source.html#l00142">142</a> of file <a class="el" href="driftfac_8c_source.html">driftfac.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00111">DRIFT_TABLE_LENGTH</a>, <a class="el" href="allvars_8c_source.html#l00100">HydroKickTable</a>, <a class="el" href="driftfac_8c_source.html#l00016">logTimeBegin</a>, <a class="el" href="driftfac_8c_source.html#l00017">logTimeMax</a>, and <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="global_8c_source.html#l00022">compute_global_quantities_of_system()</a>, <a class="el" href="io_8c_source.html#l00129">fill_write_buffer()</a>, and <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> a1, a2, df1, df2, u1, u2;
  <span class="keywordtype">int</span> i1, i2;

  <span class="comment">/* note: will only be called for cosmological integration */</span>

  a1 = <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + time0 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
  a2 = <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + time1 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  u1 = (a1 - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / (<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) * DRIFT_TABLE_LENGTH;
  i1 = (int) u1;
  <span class="keywordflow">if</span>(i1 &gt;= <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a>)
    i1 = <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a> - 1;

  <span class="keywordflow">if</span>(i1 &lt;= 1)
    df1 = u1 * <a class="code" href="allvars_8c.html#a274a5737d1578d54d6f82130e3064771">HydroKickTable</a>[0];
  <span class="keywordflow">else</span>
    df1 = HydroKickTable[i1 - 1] + (HydroKickTable[i1] - HydroKickTable[i1 - 1]) * (u1 - i1);


  u2 = (a2 - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / (<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) * DRIFT_TABLE_LENGTH;
  i2 = (int) u2;
  <span class="keywordflow">if</span>(i2 &gt;= <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a>)
    i2 = <a class="code" href="allvars_8h.html#aec9dcf4def3489f6890e20e7d66151c6">DRIFT_TABLE_LENGTH</a> - 1;

  <span class="keywordflow">if</span>(i2 &lt;= 1)
    df2 = u2 * HydroKickTable[0];
  <span class="keywordflow">else</span>
    df2 = HydroKickTable[i2 - 1] + (HydroKickTable[i2] - HydroKickTable[i2 - 1]) * (u2 - i2);

  <span class="keywordflow">return</span> df2 - df1;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ace65dca1556185b12c7f22427724c90c_icgraph.png" border="0" usemap="#proto_8h_ace65dca1556185b12c7f22427724c90c_icgraph" alt=""/></div>
<map name="proto_8h_ace65dca1556185b12c7f22427724c90c_icgraph" id="proto_8h_ace65dca1556185b12c7f22427724c90c_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="691,5,899,35"/><area shape="rect" id="node9" href="proto_8h.html#ada58109949c2431ca9b0cdaa01cfb5b1" title="compute_global_quantities_of_system" alt="" coords="376,57,643,87"/><area shape="rect" id="node14" href="proto_8h.html#aea8fa222a10c4796687c6ff25550cd74" title="fill_write_buffer" alt="" coords="211,109,325,139"/><area shape="rect" id="node24" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="209,163,327,192"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1213,84,1256,113"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1305,84,1359,113"/><area shape="rect" id="node11" href="run_8c.html#ae903322da17c6875ab606b032b918099" title="energy_statistics" alt="" coords="991,57,1121,87"/><area shape="rect" id="node16" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="471,111,548,140"/><area shape="rect" id="node18" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="740,111,849,140"/><area shape="rect" id="node20" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="947,161,1165,191"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5ce310b1efc19d96d530c1264fd5eca9"></a><!-- doxytag: member="proto.h::get_particles_in_block" ref="a5ce310b1efc19d96d530c1264fd5eca9" args="(enum iofields blocknr, int *typelist)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_particles_in_block </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a>&nbsp;</td>
          <td class="paramname"> <em>blocknr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>typelist</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function determines how many particles there are in a given block, based on the information in the header-structure. It also flags particle types that are present in the block in the typelist array. If one wants to add a new output-block, this function should be augmented accordingly. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00465">465</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00162">header</a>, <a class="el" href="allvars_8h_source.html#l00669">IO_ACCEL</a>, <a class="el" href="allvars_8h_source.html#l00670">IO_DTENTR</a>, <a class="el" href="allvars_8h_source.html#l00667">IO_HSML</a>, <a class="el" href="allvars_8h_source.html#l00663">IO_ID</a>, <a class="el" href="allvars_8h_source.html#l00664">IO_MASS</a>, <a class="el" href="allvars_8h_source.html#l00661">IO_POS</a>, <a class="el" href="allvars_8h_source.html#l00668">IO_POT</a>, <a class="el" href="allvars_8h_source.html#l00666">IO_RHO</a>, <a class="el" href="allvars_8h_source.html#l00671">IO_TSTP</a>, <a class="el" href="allvars_8h_source.html#l00665">IO_U</a>, <a class="el" href="allvars_8h_source.html#l00662">IO_VEL</a>, <a class="el" href="allvars_8h_source.html#l00481">global_data_all_processes::MassTable</a>, and <a class="el" href="allvars_8h_source.html#l00632">io_header::npart</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, nall, ntot_withmasses, ngas, nstars;

  nall = 0;
  ntot_withmasses = 0;

  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    {
      typelist[i] = 0;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[i] &gt; 0)
        {
          nall += <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[i];
          typelist[i] = 1;
        }

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[i] == 0)
        ntot_withmasses += <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[i];
    }

  ngas = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[0];
  nstars = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[4];


  <span class="keywordflow">switch</span> (blocknr)
    {
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a0207eb67d96fe97fb8158c42af624f8f">IO_POS</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aa4c3992546632e0db8015ebe534c0282">IO_VEL</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>:
      <span class="keywordflow">return</span> nall;
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a72e1cc8b602ab38f0f3491464ed82063">IO_MASS</a>:
      <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
        {
          typelist[i] = 0;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[i] == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[i] &gt; 0)
            typelist[i] = 1;
        }
      <span class="keywordflow">return</span> ntot_withmasses;
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a8dd43018a3f2d1caed951b249a38b106">IO_RHO</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a429c6a7a56e3b53597bd1eb72b87f941">IO_HSML</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>:
      <span class="keywordflow">for</span>(i = 1; i &lt; 6; i++)
        typelist[i] = 0;
      <span class="keywordflow">return</span> ngas;
      <span class="keywordflow">break</span>;
    }

  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(212);
  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a5ce310b1efc19d96d530c1264fd5eca9_cgraph.png" border="0" usemap="#proto_8h_a5ce310b1efc19d96d530c1264fd5eca9_cgraph" alt=""/></div>
<map name="proto_8h_a5ce310b1efc19d96d530c1264fd5eca9_cgraph" id="proto_8h_a5ce310b1efc19d96d530c1264fd5eca9_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="216,5,283,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="331,5,488,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a5ce310b1efc19d96d530c1264fd5eca9_icgraph.png" border="0" usemap="#proto_8h_a5ce310b1efc19d96d530c1264fd5eca9_icgraph" alt=""/></div>
<map name="proto_8h_a5ce310b1efc19d96d530c1264fd5eca9_icgraph" id="proto_8h_a5ce310b1efc19d96d530c1264fd5eca9_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="217,5,292,35"/><area shape="rect" id="node13" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="216,59,293,88"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="363,5,429,35"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="588,5,628,35"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="765,5,832,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="881,32,935,61"/><area shape="rect" id="node15" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="341,59,451,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="499,59,717,88"/><area shape="rect" id="node19" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="777,59,820,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0d508d57eb6f608ff6eec8ac11bb9c05"></a><!-- doxytag: member="proto.h::get_random_number" ref="a0d508d57eb6f608ff6eec8ac11bb9c05" args="(int id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double get_random_number </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>id</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine returns a random number taken from a table of random numbers, which is refilled every timestep. This method is used to allow random number application to particles independent of the number of processors used, and independent of the particular order the particles have. In order to work properly, the particle IDs should be set properly to unique integer values. </p>

<p><p>&lt; gives the length of a table with random numbers, refreshed at every timestep. This is used to allow application of random numbers to a specific particle in a way that is independent of the number of processors used. </p>
</p>

<p>Definition at line <a class="el" href="system_8c_source.html#l00029">29</a> of file <a class="el" href="system_8c_source.html">system.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00045">RndTable</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>, <a class="el" href="forcetree_8c_source.html#l01126">force_treeevaluate()</a>, <a class="el" href="forcetree_8c_source.html#l01500">force_treeevaluate_shortrange()</a>, <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>, and <a class="el" href="init_8c_source.html#l00020">init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">return</span> <a class="code" href="allvars_8c.html#aa91f67a734086ebfa758994e579c80a9">RndTable</a>[(<span class="keywordtype">id</span> % RNDTABLE)];
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a0d508d57eb6f608ff6eec8ac11bb9c05_icgraph.png" border="0" usemap="#proto_8h_a0d508d57eb6f608ff6eec8ac11bb9c05_icgraph" alt=""/></div>
<map name="proto_8h_a0d508d57eb6f608ff6eec8ac11bb9c05_icgraph" id="proto_8h_a0d508d57eb6f608ff6eec8ac11bb9c05_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="477,16,685,46"/><area shape="rect" id="node9" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="240,228,400,258"/><area shape="rect" id="node26" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1015,228,1055,258"/><area shape="rect" id="node31" href="proto_8h.html#a59ae74ef51d6a7065605638422489391" title="force_treeevaluate" alt="" coords="249,122,391,151"/><area shape="rect" id="node34" href="proto_8h.html#ae01e179b7686a7fe62970160b7bbdb46" title="force_treeevaluate_shortrange" alt="" coords="211,175,429,204"/><area shape="rect" id="node37" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="517,70,645,99"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1204,123,1247,152"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1308,163,1361,192"/><area shape="rect" id="node11" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="523,228,640,258"/><area shape="rect" id="node13" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="735,175,876,204"/><area shape="rect" id="node19" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="756,122,855,151"/><area shape="rect" id="node24" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="751,228,860,258"/><area shape="rect" id="node15" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="925,175,1144,204"/><area shape="rect" id="node21" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="949,71,1120,100"/><area shape="rect" id="node28" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1192,202,1259,231"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a1d72b071e6cb4691ecc0da4de4cb8af8"></a><!-- doxytag: member="proto.h::get_timestep" ref="a1d72b071e6cb4691ecc0da4de4cb8af8" args="(int p, double *a, int flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_timestep </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>aphys</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function normally (for flag==0) returns the maximum allowed timestep of a particle, expressed in terms of the integer mapping that is used to represent the total simulated timespan. The physical acceleration is returned in `aphys'. The latter is used in conjunction with the PSEUDOSYMMETRIC integration option, which also makes of the second function of get_timestep. When it is called with a finite timestep for flag, it returns the physical acceleration that would lead to this timestep, assuming timestep criterion 0. </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29 </p>
</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>p</em>&nbsp;</td><td>particle index </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>aphys</em>&nbsp;</td><td>acceleration (physical units) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flag</em>&nbsp;</td><td>either 0 for normal operation, or finite timestep to get corresponding aphys </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="timestep_8c_source.html#l00423">423</a> of file <a class="el" href="timestep_8c_source.html">timestep.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="timestep_8c_source.html#l00013">atime</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00447">global_data_all_processes::CourantFac</a>, <a class="el" href="timestep_8c_source.html#l00014">dt_displacement</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00433">global_data_all_processes::ErrTolIntAccuracy</a>, <a class="el" href="timestep_8c_source.html#l00013">fac1</a>, <a class="el" href="timestep_8c_source.html#l00013">fac2</a>, <a class="el" href="timestep_8c_source.html#l00013">fac3</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00518">particle_data::GravPM</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="timestep_8c_source.html#l00013">hubble_a</a>, <a class="el" href="allvars_8h_source.html#l00562">sph_particle_data::HydroAccel</a>, <a class="el" href="allvars_8h_source.html#l00568">sph_particle_data::MaxSignalVel</a>, <a class="el" href="allvars_8h_source.html#l00438">global_data_all_processes::MaxSizeTimestep</a>, <a class="el" href="allvars_8h_source.html#l00436">global_data_all_processes::MinSizeTimestep</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00477">global_data_all_processes::SofteningTable</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00041">TIMEBASE</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, and <a class="el" href="allvars_8h_source.html#l00351">global_data_all_processes::TypeOfTimestepCriterion</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> ax, ay, az, ac, csnd;
  <span class="keywordtype">double</span> dt = 0, dt_courant = 0, dt_accel;
  <span class="keywordtype">int</span> ti_step;

<span class="preprocessor">#ifdef CONDUCTION</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_cond;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(flag == 0)
    {
      ax = <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0];
      ay = <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1];
      az = <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2];

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>      ax += <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[0];
      ay += <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[1];
      az += <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[2];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
        {
          ax += <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[0];
          ay += <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[1];
          az += <a class="code" href="timestep_8c.html#a1a666a0983f6d540fa41ec867aa40d09">fac2</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[2];
        }

      ac = sqrt(ax * ax + ay * ay + az * az);   <span class="comment">/* this is now the physical acceleration */</span>
      *aphys = ac;
    }
  <span class="keywordflow">else</span>
    ac = *aphys;

  <span class="keywordflow">if</span>(ac == 0)
    ac = 1.0e-30;

  <span class="keywordflow">switch</span> (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2cc704c49ada031fae9619dbf163e32d">TypeOfTimestepCriterion</a>)
    {
    <span class="keywordflow">case</span> 0:
      <span class="keywordflow">if</span>(flag &gt; 0)
        {
          dt = flag * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
          dt /= <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>;       <span class="comment">/* convert dloga to physical timestep  */</span>
          ac = 2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] / (dt * dt);
          *aphys = ac;
          <span class="keywordflow">return</span> flag;
        }
      dt = dt_accel = sqrt(2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] / ac);
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
        dt = dt_accel = sqrt(2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> / 2.8 / ac);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(888);
      <span class="keywordflow">break</span>;
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
    {
      csnd = sqrt(<a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Pressure / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Density);

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
        dt_courant = 2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa4cf405da4e0a6fc588f5a5ba7e8fde8">CourantFac</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> / (<a class="code" href="timestep_8c.html#aebe1da050ef46b7b63c856394494292c">fac3</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#a86da008875968dfca41b35f4ca7f3164">MaxSignalVel</a>);
      <span class="keywordflow">else</span>
        dt_courant = 2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa4cf405da4e0a6fc588f5a5ba7e8fde8">CourantFac</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#a86da008875968dfca41b35f4ca7f3164">MaxSignalVel</a>;

      <span class="keywordflow">if</span>(dt_courant &lt; dt)
        dt = dt_courant;
    }

  <span class="comment">/* convert the physical timestep to dloga if needed. Note: If comoving integration has not been selected,</span>
<span class="comment">     hubble_a=1.</span>
<span class="comment">   */</span>
  dt *= <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>;

  <span class="keywordflow">if</span>(dt &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>)
    dt = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>;

  <span class="keywordflow">if</span>(dt &gt;= <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a>)
    dt = <a class="code" href="timestep_8c.html#aebcd2de4b9dfac8c2feb1594616f4803">dt_displacement</a>;

  <span class="keywordflow">if</span>(dt &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab5f56d94a4417c5a703b6d2d4cb81a05">MinSizeTimestep</a>)
    {
<span class="preprocessor">#ifndef NOSTOP_WHEN_BELOW_MINTIMESTEP</span>
<span class="preprocessor"></span>      printf(<span class="stringliteral">&quot;warning: Timestep wants to be below the limit `MinSizeTimestep&#39;\n&quot;</span>);

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
        {
          printf
            (<span class="stringliteral">&quot;Part-ID=%d  dt=%g dtc=%g ac=%g xyz=(%g|%g|%g)  hsml=%g  maxsignalvel=%g dt0=%g eps=%g\n&quot;</span>,
             (<span class="keywordtype">int</span>) <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>, dt, dt_courant * <a class="code" href="timestep_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>, ac, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2],
             <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].Hsml, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].MaxSignalVel,
             sqrt(2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a> * <a class="code" href="timestep_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] / ac) * hubble_a,
             <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>]);
        }
      <span class="keywordflow">else</span>
        {
          printf(<span class="stringliteral">&quot;Part-ID=%d  dt=%g ac=%g xyz=(%g|%g|%g)\n&quot;</span>, (<span class="keywordtype">int</span>) <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>, dt, ac, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1],
                 <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2]);
        }
      fflush(stdout);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(888);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      dt = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab5f56d94a4417c5a703b6d2d4cb81a05">MinSizeTimestep</a>;
    }

  ti_step = dt / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  <span class="keywordflow">if</span>(!(ti_step &gt; 0 &amp;&amp; ti_step &lt; <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>))
    {
      printf(<span class="stringliteral">&quot;\nError: A timestep of size zero was assigned on the integer timeline!\n&quot;</span>
             <span class="stringliteral">&quot;We better stop.\n&quot;</span>
             <span class="stringliteral">&quot;Task=%d Part-ID=%d dt=%g tibase=%g ti_step=%d ac=%g xyz=(%g|%g|%g) tree=(%g|%g%g)\n\n&quot;</span>,
             <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, (<span class="keywordtype">int</span>) <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>, dt, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>, ti_step, ac,
             <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2]);
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>      printf(<span class="stringliteral">&quot;pm_force=(%g|%g|%g)\n&quot;</span>, <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].GravPM[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].GravPM[2]);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
        printf(<span class="stringliteral">&quot;hydro-frc=(%g|%g|%g)\n&quot;</span>, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].HydroAccel[0], <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].HydroAccel[1], <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].HydroAccel[2]);

      fflush(stdout);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(818);
    }

  <span class="keywordflow">return</span> ti_step;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a1d72b071e6cb4691ecc0da4de4cb8af8_cgraph.png" border="0" usemap="#proto_8h_a1d72b071e6cb4691ecc0da4de4cb8af8_cgraph" alt=""/></div>
<map name="proto_8h_a1d72b071e6cb4691ecc0da4de4cb8af8_cgraph" id="proto_8h_a1d72b071e6cb4691ecc0da4de4cb8af8_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="160,5,227,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="275,5,432,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a1d72b071e6cb4691ecc0da4de4cb8af8_icgraph.png" border="0" usemap="#proto_8h_a1d72b071e6cb4691ecc0da4de4cb8af8_icgraph" alt=""/></div>
<map name="proto_8h_a1d72b071e6cb4691ecc0da4de4cb8af8_icgraph" id="proto_8h_a1d72b071e6cb4691ecc0da4de4cb8af8_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="160,5,368,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="416,5,459,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="508,5,561,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3892776d6528c51f720d2a48deb2486f"></a><!-- doxytag: member="proto.h::get_values_per_blockelement" ref="a3892776d6528c51f720d2a48deb2486f" args="(enum iofields blocknr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_values_per_blockelement </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a>&nbsp;</td>
          <td class="paramname"> <em>blocknr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function informs about the number of elements stored per particle for the given block of the output file. If one wants to add a new output-block, this function should be augmented accordingly. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00432">432</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00669">IO_ACCEL</a>, <a class="el" href="allvars_8h_source.html#l00670">IO_DTENTR</a>, <a class="el" href="allvars_8h_source.html#l00667">IO_HSML</a>, <a class="el" href="allvars_8h_source.html#l00663">IO_ID</a>, <a class="el" href="allvars_8h_source.html#l00664">IO_MASS</a>, <a class="el" href="allvars_8h_source.html#l00661">IO_POS</a>, <a class="el" href="allvars_8h_source.html#l00668">IO_POT</a>, <a class="el" href="allvars_8h_source.html#l00666">IO_RHO</a>, <a class="el" href="allvars_8h_source.html#l00671">IO_TSTP</a>, <a class="el" href="allvars_8h_source.html#l00665">IO_U</a>, and <a class="el" href="allvars_8h_source.html#l00662">IO_VEL</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> values = 0;

  <span class="keywordflow">switch</span> (blocknr)
    {
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a0207eb67d96fe97fb8158c42af624f8f">IO_POS</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aa4c3992546632e0db8015ebe534c0282">IO_VEL</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a6f80f32dfa1c0cde8a71b773f42bb97a">IO_ACCEL</a>:
      values = 3;
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a34f71f128fc699de3792687fd79edf03">IO_ID</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a72e1cc8b602ab38f0f3491464ed82063">IO_MASS</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a8dd43018a3f2d1caed951b249a38b106">IO_RHO</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a429c6a7a56e3b53597bd1eb72b87f941">IO_HSML</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a27c32f555479567b88ad11dcce803fe9">IO_POT</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a74d42dcd51f76c1919f44e9f89581457">IO_DTENTR</a>:
    <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8aac2070d9e6c597be29ae9a4c9acc36da">IO_TSTP</a>:
      values = 1;
      <span class="keywordflow">break</span>;
    }

  <span class="keywordflow">return</span> values;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a3892776d6528c51f720d2a48deb2486f_icgraph.png" border="0" usemap="#proto_8h_a3892776d6528c51f720d2a48deb2486f_icgraph" alt=""/></div>
<map name="proto_8h_a3892776d6528c51f720d2a48deb2486f_icgraph" id="proto_8h_a3892776d6528c51f720d2a48deb2486f_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="268,5,343,35"/><area shape="rect" id="node13" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="267,59,344,88"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="413,5,480,35"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="639,5,679,35"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="816,5,883,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="932,32,985,61"/><area shape="rect" id="node15" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="392,59,501,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="549,59,768,88"/><area shape="rect" id="node19" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="828,59,871,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae9c157451dcc4cdbe02813141df2be42"></a><!-- doxytag: member="proto.h::grav_tree_compare_key" ref="ae9c157451dcc4cdbe02813141df2be42" args="(const void *a, const void *b)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int grav_tree_compare_key </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>b</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is used as a comparison kernel in a sort routine. It is used to group particles in the communication buffer that are going to be sent to the same CPU. </p>

<p>Definition at line <a class="el" href="gravtree_8c_source.html#l00544">544</a> of file <a class="el" href="gravtree_8c_source.html">gravtree.c</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>, and <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a> *) a)-&gt;Task &lt; (((<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a> *) b)-&gt;Task))
    <span class="keywordflow">return</span> -1;

  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a> *) a)-&gt;Task &gt; (((<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a> *) b)-&gt;Task))
    <span class="keywordflow">return</span> +1;

  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ae9c157451dcc4cdbe02813141df2be42_icgraph.png" border="0" usemap="#proto_8h_ae9c157451dcc4cdbe02813141df2be42_icgraph" alt=""/></div>
<map name="proto_8h_ae9c157451dcc4cdbe02813141df2be42_icgraph" id="proto_8h_ae9c157451dcc4cdbe02813141df2be42_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="231,31,372,60"/><area shape="rect" id="node12" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="237,84,365,113"/><area shape="rect" id="node17" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="252,137,351,167"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="421,5,640,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="688,57,731,87"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="780,57,833,87"/><area shape="rect" id="node14" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="445,109,616,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a51b074bdf1ec1efc0f7a323415a47e79"></a><!-- doxytag: member="proto.h::gravity_forcetest" ref="a51b074bdf1ec1efc0f7a323415a47e79" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void gravity_forcetest </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine does the test of the gravitational tree force by computing the force for a random subset of particles with direct summation. </p>

<p>Definition at line <a class="el" href="gravtree__forcetest_8c_source.html#l00028">28</a> of file <a class="el" href="gravtree__forcetest_8c_source.html">gravtree_forcetest.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00710">gravdata_in::Acc</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00289">global_data_all_processes::BunchSizeForce</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="timestep_8c_source.html#l00013">fac1</a>, <a class="el" href="allvars_8c_source.html#l00095">FdForceTest</a>, <a class="el" href="allvars_8c_source.html#l00091">FdTimings</a>, <a class="el" href="forcetree_8c_source.html#l02909">force_treeevaluate_direct()</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="system_8c_source.html#l00029">get_random_number()</a>, <a class="el" href="gravtree_8c_source.html#l00544">grav_tree_compare_key()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00521">particle_data::GravAccelDirect</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataIn</a>, <a class="el" href="allvars_8c_source.html#l00186">GravDataIndexTable</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataOut</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00518">particle_data::GravPM</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00744">gravdata_index::Index</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00024">NumForceUpdate</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00524">particle_data::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00731">gravdata_in::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8h_source.html#l00490">global_data_all_processes::OutputDir</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00709">gravdata_in::Pos</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="gravtree_8c_source.html#l00487">set_softenings()</a>, <a class="el" href="allvars_8h_source.html#l00745">gravdata_index::SortIndex</a>, <a class="el" href="tags_8h_source.html#l00015">TAG_DIRECT_A</a>, <a class="el" href="tags_8h_source.html#l00016">TAG_DIRECT_B</a>, <a class="el" href="allvars_8h_source.html#l00743">gravdata_index::Task</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8c_source.html#l00081">TimeOfLastTreeConstruction</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, and <a class="el" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">gravdata_in::w</a>.</p>

<p>Referenced by <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> ntot, iter = 0, ntotleft, nthis;
  <span class="keywordtype">double</span> tstart, tend, timetree = 0;
  <span class="keywordtype">int</span> i, j, ndone, ngrp, maxfill, place, ndonetot;

<span class="preprocessor">#ifndef NOGRAVITY</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> *noffset, *nbuffer, *nsend, *nsend_local;
  <span class="keywordtype">int</span> k, nexport;
  <span class="keywordtype">int</span> level, sendTask, recvTask;
  <span class="keywordtype">double</span> <a class="code" href="timestep_8c.html#a59a20f8242197c1ba41f7a0b1b880d62">fac1</a>;
  MPI_Status status;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> costtotal, *costtreelist;
  <span class="keywordtype">double</span> maxt, sumt, *timetreelist;
  <span class="keywordtype">double</span> fac;
  <span class="keywordtype">char</span> buf[200];

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> != <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
    <span class="keywordflow">return</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    <a class="code" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91">set_softenings</a>();           <span class="comment">/* set new softening lengths */</span>

  <span class="keywordflow">for</span>(i = 0, <a class="code" href="allvars_8c.html#a4c8b412a9883b4f6e0e8962ba54fd4ef">NumForceUpdate</a> = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
        {
          <span class="keywordflow">if</span>(<a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>) &lt; FORCETEST)
            {
              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - 1;
              <a class="code" href="allvars_8c.html#a4c8b412a9883b4f6e0e8962ba54fd4ef">NumForceUpdate</a>++;
            }
        }
    }

  <span class="comment">/* NumForceUpdate is the number of particles on this processor that want a force update */</span>

  MPI_Allreduce(&amp;<a class="code" href="allvars_8c.html#a4c8b412a9883b4f6e0e8962ba54fd4ef">NumForceUpdate</a>, &amp;ntot, 1, MPI_INT, MPI_SUM, MPI_COMM_WORLD);

  costtotal = 0;

  noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);        <span class="comment">/* offsets of bunches in common list */</span>
  nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);

  i = 0;                        <span class="comment">/* beginn with this index */</span>
  ntotleft = ntot;              <span class="comment">/* particles left for all tasks together */</span>

  <span class="keywordflow">while</span>(ntotleft &gt; 0)
    {
      iter++;

      <span class="keywordflow">for</span>(j = 0; j &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; j++)
        nsend_local[j] = 0;

      <span class="comment">/* do local particles and prepare export list */</span>
      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; NumPart &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a> - NTask; i++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> &lt; 0)
          {
            ndone++;

            <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
              <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j] = 1;
            <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] = 0;

            costtotal += <a class="code" href="forcetree_8c.html#a0ec221b2517893874b12dc366bfe0da8">force_treeevaluate_direct</a>(i, 0);

            <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
              {
                <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j])
                  {
                    <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                      <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].u.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[k] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[k];

#ifdef UNEQUALSOFTENINGS
                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Type = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
#endif
                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#aba8345d83e2a1512a83563dbd87c9a3f">OldAcc</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a>;

                    <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#afacf7009bcd9677cf8ddff3dc927d6c5">Task</a> = j;
                    <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#aac6e682d48cdd924a09384b4551b678e">Index</a> = i;
                    <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#a34600f886624e73eb38845cb5d51d04c">SortIndex</a> = nexport;

                    nexport++;
                    nsend_local[j]++;
                  }
              }
          }
      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      timetree += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

      qsort(<a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a>), <a class="code" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42">grav_tree_compare_key</a>);

      <span class="keywordflow">for</span>(j = 0; j &lt; nexport; j++)
        <a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a>[j] = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[<a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[j].SortIndex];

      <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
        noffset[j] = noffset[j - 1] + nsend_local[j - 1];

      MPI_Allgather(nsend_local, NTask, MPI_INT, nsend, NTask, MPI_INT, MPI_COMM_WORLD);

      <span class="comment">/* now do the particles that need to be exported */</span>

      <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
        {
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nbuffer[j] = 0;
          <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
            {
              maxfill = 0;
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                {
                  <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                    <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                      maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                }
              <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>)
                <span class="keywordflow">break</span>;

              sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
              recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;

              <span class="keywordflow">if</span>(recvTask &lt; NTask)
                {
                  <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                    {
                      <span class="comment">/* get the particles */</span>
                      MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a>[noffset[recvTask]],
                                   nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#a7183477bbb237b15f13318b2d85fbf1a">TAG_DIRECT_A</a>,
                                   &amp;<a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                   nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#a7183477bbb237b15f13318b2d85fbf1a">TAG_DIRECT_A</a>, MPI_COMM_WORLD, &amp;status);
                    }
                }

              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                  nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
            }

          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]; j++)
            {
              costtotal += <a class="code" href="forcetree_8c.html#a0ec221b2517893874b12dc366bfe0da8">force_treeevaluate_direct</a>(j, 1);
            }
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timetree += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);


          <span class="comment">/* get the result */</span>
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nbuffer[j] = 0;
          <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
            {
              maxfill = 0;
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                {
                  <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                    <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                      maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                }
              <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>)
                <span class="keywordflow">break</span>;

              sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
              recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;
              <span class="keywordflow">if</span>(recvTask &lt; NTask)
                {
                  <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                    {
                      <span class="comment">/* send the results */</span>
                      MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                   nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a769a7abe5d1203e96c74514568e56519">TAG_DIRECT_B</a>,
                                   &amp;<a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a>[noffset[recvTask]],
                                   nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a769a7abe5d1203e96c74514568e56519">TAG_DIRECT_B</a>, MPI_COMM_WORLD, &amp;status);

                      <span class="comment">/* add the result to the particles */</span>
                      <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
                        {
                          place = <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[noffset[recvTask] + j].<a class="code" href="structgravdata__index.html#aac6e682d48cdd924a09384b4551b678e">Index</a>;

                          <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                            <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[place].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[k] += <a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a>[j + noffset[recvTask]].u.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[k];
                        }
                    }
                }

              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                  nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
            }

          level = ngrp - 1;
        }

      MPI_Allreduce(&amp;ndone, &amp;ndonetot, 1, MPI_INT, MPI_SUM, MPI_COMM_WORLD);

      ntotleft -= ndonetot;
    }

  free(nsend);
  free(nsend_local);
  free(nbuffer);
  free(noffset);


  <span class="comment">/* now add things for comoving integration */</span>

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
<span class="preprocessor">#ifndef PERIODIC</span>
<span class="preprocessor"></span>      fac1 = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> &lt; 0)
          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[j] += fac1 * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }



  <span class="comment">/*  muliply by G */</span>

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> &lt; 0)
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[j] *= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>;



  <span class="comment">/* Finally, the following factor allows a computation of cosmological simulation </span>
<span class="comment">     with vacuum energy in physical coordinates */</span>

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a> == 0)
    {
      fac1 = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> &lt; 0)
          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[j] += fac1 * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
    }

  <span class="comment">/* now output the forces to a file */</span>

  <span class="keywordflow">for</span>(nthis = 0; nthis &lt; NTask; nthis++)
    {
      <span class="keywordflow">if</span>(nthis == ThisTask)
        {
          sprintf(buf, <span class="stringliteral">&quot;%s%s&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <span class="stringliteral">&quot;forcetest.txt&quot;</span>);
          <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#ae16a08c18946ccba84c72541b51055dd">FdForceTest</a> = fopen(buf, <span class="stringliteral">&quot;a&quot;</span>)))
            {
              printf(<span class="stringliteral">&quot;error in opening file &#39;%s&#39;\n&quot;</span>, buf);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(17);
            }
          <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> &lt; 0)
              {
<span class="preprocessor">#ifndef PMGRID</span>
<span class="preprocessor"></span>                fprintf(<a class="code" href="allvars_8c.html#ae16a08c18946ccba84c72541b51055dd">FdForceTest</a>, <span class="stringliteral">&quot;%d %g %g %g %g %g %g %g %g %g %g %g\n&quot;</span>,
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - <a class="code" href="allvars_8c.html#ae43d9623e3a2c88558e99ecf90948906">TimeOfLastTreeConstruction</a>,
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2],
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[2],
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2]);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>                fprintf(<a class="code" href="allvars_8c.html#ae16a08c18946ccba84c72541b51055dd">FdForceTest</a>, <span class="stringliteral">&quot;%d %g %g %g %g %g %g %g %g %g %g %g %g %g %g\n&quot;</span>,
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - <a class="code" href="allvars_8c.html#ae43d9623e3a2c88558e99ecf90948906">TimeOfLastTreeConstruction</a>,
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2],
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ae4d6efa44515e66a9b7806d8d57a88bf">GravAccelDirect</a>[2],
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2],
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[0] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0],
                        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[1] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1], <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[2] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2]);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>              }
          fclose(<a class="code" href="allvars_8c.html#ae16a08c18946ccba84c72541b51055dd">FdForceTest</a>);
        }
      MPI_Barrier(MPI_COMM_WORLD);
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> &lt; 0)
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - 1;

  <span class="comment">/* Now the force computation is finished */</span>



  timetreelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * NTask);
  costtreelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * NTask);

  MPI_Gather(&amp;costtotal, 1, MPI_DOUBLE, costtreelist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
  MPI_Gather(&amp;timetree, 1, MPI_DOUBLE, timetreelist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(ThisTask == 0)
    {
      fac = NTask / ((double) <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a>);

      <span class="keywordflow">for</span>(i = 0, maxt = timetreelist[0], sumt = 0, costtotal = 0; i &lt; NTask; i++)
        {
          costtotal += costtreelist[i];

          <span class="keywordflow">if</span>(maxt &lt; timetreelist[i])
            maxt = timetreelist[i];
          sumt += timetreelist[i];
        }

      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;DIRECT Nf= %d    part/sec=%g | %g  ia/part=%g \n&quot;</span>, ntot, ntot / (sumt + 1.0e-20),
              ntot / (maxt * NTask), ((<span class="keywordtype">double</span>) (costtotal)) / ntot);
      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;\n&quot;</span>);

      fflush(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>);
    }

  free(costtreelist);
  free(timetreelist);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a51b074bdf1ec1efc0f7a323415a47e79_cgraph.png" border="0" usemap="#proto_8h_a51b074bdf1ec1efc0f7a323415a47e79_cgraph" alt=""/></div>
<map name="proto_8h_a51b074bdf1ec1efc0f7a323415a47e79_cgraph" id="proto_8h_a51b074bdf1ec1efc0f7a323415a47e79_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="244,5,311,35"/><area shape="rect" id="node7" href="forcetree_8c.html#a0ec221b2517893874b12dc366bfe0da8" title="force_treeevaluate_direct" alt="" coords="185,59,369,88"/><area shape="rect" id="node13" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="199,112,356,141"/><area shape="rect" id="node15" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42" title="grav_tree_compare_key" alt="" coords="189,165,365,195"/><area shape="rect" id="node17" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="244,219,311,248"/><area shape="rect" id="node19" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91" title="set_softenings" alt="" coords="220,272,335,301"/><area shape="rect" id="node21" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="243,325,312,355"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="419,5,576,35"/><area shape="rect" id="node9" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="468,59,527,88"/><area shape="rect" id="node11" href="forcetree_8c.html#ad8b8e212e593e1795f6ba522239086fc" title="ewald_corr" alt="" coords="452,112,543,141"/><area shape="rect" id="node23" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="475,325,520,355"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a51b074bdf1ec1efc0f7a323415a47e79_icgraph.png" border="0" usemap="#proto_8h_a51b074bdf1ec1efc0f7a323415a47e79_icgraph" alt=""/></div>
<map name="proto_8h_a51b074bdf1ec1efc0f7a323415a47e79_icgraph" id="proto_8h_a51b074bdf1ec1efc0f7a323415a47e79_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="184,5,355,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="403,5,445,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="495,5,548,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac559dc2aeb21d5a379a3751bea7736af"></a><!-- doxytag: member="proto.h::gravity_tree" ref="ac559dc2aeb21d5a379a3751bea7736af" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void gravity_tree </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes the gravitational forces for all active particles. If needed, a new tree is constructed, otherwise the dynamically updated tree is used. Particles are only exported to other processors when really needed, thereby allowing a good use of the communication buffer. </p>

<p>Definition at line <a class="el" href="gravtree_8c_source.html#l00027">27</a> of file <a class="el" href="gravtree_8c_source.html">gravtree.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00710">gravdata_in::Acc</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00289">global_data_all_processes::BunchSizeForce</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00413">global_data_all_processes::CPU_CommSum</a>, <a class="el" href="allvars_8h_source.html#l00414">global_data_all_processes::CPU_Imbalance</a>, <a class="el" href="allvars_8h_source.html#l00406">global_data_all_processes::CPU_TreeConstruction</a>, <a class="el" href="allvars_8h_source.html#l00407">global_data_all_processes::CPU_TreeWalk</a>, <a class="el" href="allvars_8h_source.html#l00427">global_data_all_processes::ErrTolTheta</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8c_source.html#l00091">FdTimings</a>, <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>, <a class="el" href="forcetree_8c_source.html#l01126">force_treeevaluate()</a>, <a class="el" href="forcetree_8c_source.html#l01500">force_treeevaluate_shortrange()</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="gravtree_8c_source.html#l00544">grav_tree_compare_key()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00537">particle_data::GravCost</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataGet</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataIn</a>, <a class="el" href="allvars_8c_source.html#l00186">GravDataIndexTable</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataOut</a>, <a class="el" href="allvars_8c_source.html#l00180">GravDataResult</a>, <a class="el" href="allvars_8h_source.html#l00518">particle_data::GravPM</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00526">particle_data::ID</a>, <a class="el" href="allvars_8h_source.html#l00744">gravdata_index::Index</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00732">gravdata_in::Ninteractions</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00364">global_data_all_processes::NumCurrentTiStep</a>, <a class="el" href="allvars_8c_source.html#l00024">NumForceUpdate</a>, <a class="el" href="allvars_8c_source.html#l00140">Numnodestree</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00524">particle_data::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00731">gravdata_in::OldAcc</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00709">gravdata_in::Pos</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="gravtree_8c_source.html#l00487">set_softenings()</a>, <a class="el" href="allvars_8h_source.html#l00745">gravdata_index::SortIndex</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="tags_8h_source.html#l00013">TAG_GRAV_A</a>, <a class="el" href="tags_8h_source.html#l00014">TAG_GRAV_B</a>, <a class="el" href="allvars_8h_source.html#l00743">gravdata_index::Task</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00371">global_data_all_processes::TimeStep</a>, <a class="el" href="allvars_8h_source.html#l00315">global_data_all_processes::TotNumOfForces</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00298">global_data_all_processes::TreeAllocFactor</a>, <a class="el" href="allvars_8c_source.html#l00038">TreeReconstructFlag</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="allvars_8h_source.html#l00350">global_data_all_processes::TypeOfOpeningCriterion</a>, <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>, and <a class="el" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">gravdata_in::w</a>.</p>

<p>Referenced by <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot;
  <span class="keywordtype">int</span> numnodes, nexportsum = 0;
  <span class="keywordtype">int</span> i, j, iter = 0;
  <span class="keywordtype">int</span> *numnodeslist, maxnumnodes, nexport, *numlist, *nrecv, *ndonelist;
  <span class="keywordtype">double</span> tstart, tend, timetree = 0, timecommsumm = 0, timeimbalance = 0, sumimbalance;
  <span class="keywordtype">double</span> ewaldcount;
  <span class="keywordtype">double</span> costtotal, ewaldtot, *costtreelist, *ewaldlist;
  <span class="keywordtype">double</span> maxt, sumt, *timetreelist, *timecommlist;
  <span class="keywordtype">double</span> fac, plb, plb_max, sumcomm;

<span class="preprocessor">#ifndef NOGRAVITY</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> *noffset, *nbuffer, *nsend, *nsend_local;
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntotleft;
  <span class="keywordtype">int</span> ndone, maxfill, ngrp;
  <span class="keywordtype">int</span> k, place;
  <span class="keywordtype">int</span> level, sendTask, recvTask;
  <span class="keywordtype">double</span> ax, ay, az;
  MPI_Status status;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *Nself_interactionsList;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">/* set new softening lengths */</span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    <a class="code" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91">set_softenings</a>();


  <span class="comment">/* contruct tree if needed */</span>
  tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#aa32d7269f9baf3ffdbdd509982fca128">TreeReconstructFlag</a>)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Tree construction.\n&quot;</span>);

      <a class="code" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5">force_treebuild</a>(<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>);

      <a class="code" href="allvars_8c.html#aa32d7269f9baf3ffdbdd509982fca128">TreeReconstructFlag</a> = 0;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Tree construction done.\n&quot;</span>);
    }
  tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac9eb650a8550b48eb464b6a0a8629a27">CPU_TreeConstruction</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

  costtotal = ewaldcount = 0;

  <span class="comment">/* Note: &#39;NumForceUpdate&#39; has already been determined in find_next_sync_point_and_drift() */</span>
  numlist = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a4c8b412a9883b4f6e0e8962ba54fd4ef">NumForceUpdate</a>, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
  <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
    ntot += numlist[i];
  free(numlist);


<span class="preprocessor">#ifndef NOGRAVITY</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;Begin tree force.\n&quot;</span>);


<span class="preprocessor">#ifdef SELECTIVE_NO_GRAVITY</span>
<span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <span class="keywordflow">if</span>(((1 &lt;&lt; <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>) &amp; (SELECTIVE_NO_GRAVITY)))
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - 1;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactions = 0;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactionsSum = 0;
  <span class="keywordflow">for</span> (i = 0; i &lt; INTERACTION_TABLE_LENGTH; i++)
    <span class="keywordflow">for</span>(j = 0; j &lt; PARTICLE_MAX_INTERACTIONS + 1; j++)
      InteractionTable[i][j] = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);        <span class="comment">/* offsets of bunches in common list */</span>
  nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
  nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
  nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask * NTask);
  ndonelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);

  i = 0;                        <span class="comment">/* beginn with this index */</span>
  ntotleft = ntot;              <span class="comment">/* particles left for all tasks together */</span>

  <span class="keywordflow">while</span>(ntotleft &gt; 0)
    {
      iter++;

      <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
        nsend_local[j] = 0;

      <span class="comment">/* do local particles and prepare export list */</span>
      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; NumPart &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a> - NTask; i++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
          {
            ndone++;

            <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
              <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j] = 0;
<span class="preprocessor">#ifndef PMGRID</span>
<span class="preprocessor"></span>            costtotal += <a class="code" href="forcetree_8c.html#a59ae74ef51d6a7065605638422489391">force_treeevaluate</a>(i, 0, &amp;ewaldcount);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            costtotal += <a class="code" href="forcetree_8c.html#ae01e179b7686a7fe62970160b7bbdb46">force_treeevaluate_shortrange</a>(i, 0);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
              {
                <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j])
                  {
                    <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                      <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].u.<a class="code" href="structgravdata__in.html#a8cac0f094027f8638152ecdcf11f1e92">Pos</a>[k] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[k];
#ifdef COMPUTE_SELFINTERACTION_FORDARK
                    <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                      <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Vel[k] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[k];                  
                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Ti_begstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>;
                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Ti_endstep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>;
                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].ID = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>;
                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Type = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
<span class="preprocessor"></span>                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Type = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>;
<span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
<span class="preprocessor"></span>                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Type == 0)
                      <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].Soft = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                    <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#aba8345d83e2a1512a83563dbd87c9a3f">OldAcc</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a>;
                    <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#afacf7009bcd9677cf8ddff3dc927d6c5">Task</a> = j;
                    <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#aac6e682d48cdd924a09384b4551b678e">Index</a> = i;
                    <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#a34600f886624e73eb38845cb5d51d04c">SortIndex</a> = nexport;
                    nexport++;
                    nexportsum++;
                    nsend_local[j]++;
                  }
              }
          }
      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      timetree += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

      qsort(<a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a>), <a class="code" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42">grav_tree_compare_key</a>);

      <span class="keywordflow">for</span>(j = 0; j &lt; nexport; j++)
        <a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a>[j] = <a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[<a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[j].SortIndex];

      <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
        noffset[j] = noffset[j - 1] + nsend_local[j - 1];

      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

      MPI_Allgather(nsend_local, NTask, MPI_INT, nsend, NTask, MPI_INT, MPI_COMM_WORLD);

      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      timeimbalance += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

      <span class="comment">/* now do the particles that need to be exported */</span>

      <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
        {
          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nbuffer[j] = 0;
          <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
            {
              maxfill = 0;
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                {
                  <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                    <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                      maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                }
              <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>)
                <span class="keywordflow">break</span>;

              sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
              recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;

              <span class="keywordflow">if</span>(recvTask &lt; NTask)
                {
                  <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                    {
                      <span class="comment">/* get the particles */</span>
                      MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#aeb6d889627ff712e7f0f30510842eb2c">GravDataIn</a>[noffset[recvTask]],
                                   nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#ab06a1de467a388455caae6dacd9d91cd">TAG_GRAV_A</a>,
                                   &amp;<a class="code" href="allvars_8c.html#abc4ea40ab91f3e9288a0394c2544c65b">GravDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                   nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#ab06a1de467a388455caae6dacd9d91cd">TAG_GRAV_A</a>, MPI_COMM_WORLD, &amp;status);
                    }
                }

              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                  nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
            }
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timecommsumm += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);


          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]; j++)
            {
<span class="preprocessor">#ifndef PMGRID</span>
<span class="preprocessor"></span>              costtotal += <a class="code" href="forcetree_8c.html#a59ae74ef51d6a7065605638422489391">force_treeevaluate</a>(j, 1, &amp;ewaldcount);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>              costtotal += <a class="code" href="forcetree_8c.html#ae01e179b7686a7fe62970160b7bbdb46">force_treeevaluate_shortrange</a>(j, 1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            }
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timetree += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          MPI_Barrier(MPI_COMM_WORLD);
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timeimbalance += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

          <span class="comment">/* get the result */</span>
          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nbuffer[j] = 0;
          <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
            {
              maxfill = 0;
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                {
                  <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                    <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                      maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                }
              <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f6d4697219a2ec2e3db7f09ab31bcea">BunchSizeForce</a>)
                <span class="keywordflow">break</span>;

              sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
              recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;
              <span class="keywordflow">if</span>(recvTask &lt; NTask)
                {
                  <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                    {
                      <span class="comment">/* send the results */</span>
                      MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a1aab0f29675c0745b5c2887e4791c070">GravDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                   nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#aa45a8037459a1e2b706c535a63594b73">TAG_GRAV_B</a>,
                                   &amp;<a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a>[noffset[recvTask]],
                                   nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#aa45a8037459a1e2b706c535a63594b73">TAG_GRAV_B</a>, MPI_COMM_WORLD, &amp;status);

                      <span class="comment">/* add the result to the particles */</span>
                      <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
                        {
                          place = <a class="code" href="allvars_8c.html#a430ddb048d692102568b323d8ebe1812">GravDataIndexTable</a>[noffset[recvTask] + j].<a class="code" href="structgravdata__index.html#aac6e682d48cdd924a09384b4551b678e">Index</a>;

                          <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                            <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[place].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[k] += <a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a>[j + noffset[recvTask]].u.<a class="code" href="structgravdata__in.html#a6850a5b240d113f9c28c27762d3c44ff">Acc</a>[k];
#ifdef COMPUTE_SELFINTERACTION_FORDARK
                          <span class="keywordflow">if</span>( <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a> == 0 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c2a481de17eefbbd973fb8a7bb6f8fc">TypeOfOpeningCriterion</a> == 0)
                            {
                              <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                                <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[place].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[k] += <a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a>[j + noffset[recvTask]].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[k];
                            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[place].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a> += <a class="code" href="allvars_8c.html#a7b537ba13fc3cfff5d6fbb245e892fb6">GravDataOut</a>[j + noffset[recvTask]].<a class="code" href="structgravdata__in.html#aa49666c565d68dcd6c3b6a6015f8a51f">w</a>.<a class="code" href="structgravdata__in.html#a6b47f6ca387f17b375c949bbc9c0572f">Ninteractions</a>;
                        }
                    }
                }

              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                  nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
            }
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timecommsumm += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

          level = ngrp - 1;
        }

      MPI_Allgather(&amp;ndone, 1, MPI_INT, ndonelist, 1, MPI_INT, MPI_COMM_WORLD);
      <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
        ntotleft -= ndonelist[j];
    }

  free(ndonelist);
  free(nsend);
  free(nsend_local);
  free(nbuffer);
  free(noffset);

  <span class="comment">/* now add things for comoving integration */</span>

<span class="preprocessor">#ifndef PERIODIC</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef PMGRID</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      fac = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] += fac * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
      {
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>        ax = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[0] / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>;
        ay = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[1] / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>;
        az = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[2] / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        ax = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[0];
        ay = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[1];
        az = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[2];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a> = sqrt(ax * ax + ay * ay + az * az);
      }


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c2a481de17eefbbd973fb8a7bb6f8fc">TypeOfOpeningCriterion</a> == 1)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a> = 0;        <span class="comment">/* This will switch to the relative opening criterion for the following force computations */</span>

  <span class="comment">/*  muliply by G */</span>
  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] *= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>;


  <span class="comment">/* Finally, the following factor allows a computation of a cosmological simulation </span>
<span class="comment">     with vacuum energy in physical coordinates */</span>
#ifndef PERIODIC
#ifndef PMGRID
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a> == 0)
    {
      fac = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] += fac * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef SELECTIVE_NO_GRAVITY</span>
<span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> &lt; 0)
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - 1;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(ThisTask == 0)
    printf(<span class="stringliteral">&quot;tree is done.\n&quot;</span>);

<span class="preprocessor">#else </span><span class="comment">/* gravity is switched off */</span>

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] = 0;

<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>



  <span class="comment">/* Now the force computation is finished */</span>

  <span class="comment">/*  gather some diagnostic information */</span>

  timetreelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * NTask);
  timecommlist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * NTask);
  costtreelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * NTask);
  numnodeslist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
  ewaldlist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * NTask);
  nrecv = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);

  numnodes = <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a>;

  MPI_Gather(&amp;costtotal, 1, MPI_DOUBLE, costtreelist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
  MPI_Gather(&amp;numnodes, 1, MPI_INT, numnodeslist, 1, MPI_INT, 0, MPI_COMM_WORLD);
  MPI_Gather(&amp;timetree, 1, MPI_DOUBLE, timetreelist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
  MPI_Gather(&amp;timecommsumm, 1, MPI_DOUBLE, timecommlist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
  MPI_Gather(&amp;NumPart, 1, MPI_INT, nrecv, 1, MPI_INT, 0, MPI_COMM_WORLD);
  MPI_Gather(&amp;ewaldcount, 1, MPI_DOUBLE, ewaldlist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;nexportsum, &amp;nexport, 1, MPI_INT, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;timeimbalance, &amp;sumimbalance, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>  Nself_interactionsList = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
  MPI_Gather(&amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactions, 1, MPI_UNSIGNED_LONG, Nself_interactionsList, 1, MPI_UNSIGNED_LONG, 0, MPI_COMM_WORLD);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(ThisTask == 0)
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a44181b6f6375de86c7dda1059d2fc3f4">TotNumOfForces</a> += ntot;

      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;Step= %d  t= %g  dt= %g \n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a05a40a90ec77ac379054f82acbec87dc">TimeStep</a>);
      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;Nf= %d%09d  total-Nf= %d%09d  ex-frac= %g  iter= %d\n&quot;</span>,
              (<span class="keywordtype">int</span>) (ntot / 1000000000), (<span class="keywordtype">int</span>) (ntot % 1000000000),
              (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a44181b6f6375de86c7dda1059d2fc3f4">TotNumOfForces</a> / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a44181b6f6375de86c7dda1059d2fc3f4">TotNumOfForces</a> % 1000000000),
              nexport / ((<span class="keywordtype">double</span>) ntot), iter);
      <span class="comment">/* note: on Linux, the 8-byte integer could be printed with the format identifier &quot;%qd&quot;, but doesn&#39;t work on AIX */</span>

      fac = NTask / ((double) <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a>);

      <span class="keywordflow">for</span>(i = 0, maxt = timetreelist[0], sumt = 0, plb_max = 0,
          maxnumnodes = 0, costtotal = 0, sumcomm = 0, ewaldtot = 0; i &lt; NTask; i++)
        {
<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK</span>
<span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.Nself_interactionsSum += Nself_interactionsList[i];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          costtotal += costtreelist[i];

          sumcomm += timecommlist[i];

          <span class="keywordflow">if</span>(maxt &lt; timetreelist[i])
            maxt = timetreelist[i];
          sumt += timetreelist[i];

          plb = nrecv[i] * fac;

          <span class="keywordflow">if</span>(plb &gt; plb_max)
            plb_max = plb;

          <span class="keywordflow">if</span>(numnodeslist[i] &gt; maxnumnodes)
            maxnumnodes = numnodeslist[i];

          ewaldtot += ewaldlist[i];
        }
      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;work-load balance: %g  max=%g avg=%g PE0=%g\n&quot;</span>,
              maxt / (sumt / NTask), maxt, sumt / NTask, timetreelist[0]);
      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;particle-load balance: %g\n&quot;</span>, plb_max);
      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;max. nodes: %d, filled: %g\n&quot;</span>, maxnumnodes,
              maxnumnodes / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>));
      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;part/sec=%g | %g  ia/part=%g (%g)\n&quot;</span>, ntot / (sumt + 1.0e-20),
              ntot / (maxt * NTask), ((<span class="keywordtype">double</span>) (costtotal)) / ntot, ((<span class="keywordtype">double</span>) ewaldtot) / ntot);
      fprintf(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>, <span class="stringliteral">&quot;\n&quot;</span>);

      fflush(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a>);

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#acf5e983357d7be116cd6663958e5a149">CPU_TreeWalk</a> += sumt / NTask;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a94e4eed16c5b353ec3c3c9ce380ec96a">CPU_Imbalance</a> += sumimbalance / NTask;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a41ab81d126219e1ff8119f8400428216">CPU_CommSum</a> += sumcomm / NTask;
    }

  free(nrecv);
  free(ewaldlist);
  free(numnodeslist);
  free(costtreelist);
  free(timecommlist);
  free(timetreelist);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ac559dc2aeb21d5a379a3751bea7736af_cgraph.png" border="0" usemap="#proto_8h_ac559dc2aeb21d5a379a3751bea7736af_cgraph" alt=""/></div>
<map name="proto_8h_ac559dc2aeb21d5a379a3751bea7736af_cgraph" id="proto_8h_ac559dc2aeb21d5a379a3751bea7736af_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="181,291,299,320"/><area shape="rect" id="node40" href="forcetree_8c.html#a59ae74ef51d6a7065605638422489391" title="force_treeevaluate" alt="" coords="415,660,556,689"/><area shape="rect" id="node57" href="forcetree_8c.html#ae01e179b7686a7fe62970160b7bbdb46" title="force_treeevaluate_shortrange" alt="" coords="376,593,595,623"/><area shape="rect" id="node65" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42" title="grav_tree_compare_key" alt="" coords="152,696,328,725"/><area shape="rect" id="node67" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="207,749,273,779"/><area shape="rect" id="node69" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91" title="set_softenings" alt="" coords="183,803,297,832"/><area shape="rect" id="node71" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="205,856,275,885"/><area shape="rect" id="node5" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7" title="force_flag_localnodes" alt="" coords="407,173,564,203"/><area shape="rect" id="node7" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="405,227,565,256"/><area shape="rect" id="node34" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="379,356,592,385"/><area shape="rect" id="node9" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="956,71,1076,100"/><area shape="rect" id="node13" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="1395,227,1461,256"/><area shape="rect" id="node18" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="673,124,868,153"/><area shape="rect" id="node23" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="947,175,1085,204"/><area shape="rect" id="node25" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="1135,227,1345,256"/><area shape="rect" id="node28" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="665,303,876,332"/><area shape="rect" id="node31" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="692,513,849,543"/><area shape="rect" id="node11" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="1199,71,1281,100"/><area shape="rect" id="node15" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1509,227,1667,256"/><area shape="rect" id="node36" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb" title="force_exchange_pseudodata" alt="" coords="668,356,873,385"/><area shape="rect" id="node38" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19" title="force_treeupdate_pseudos" alt="" coords="675,409,867,439"/><area shape="rect" id="node42" href="sidm__routines_8c.html#a7601ceef7848e2277fd5dd1f2800dfd9" title="calculate_interact_kick" alt="" coords="688,567,853,596"/><area shape="rect" id="node44" href="sidm__routines_8c.html#a06b0e0f213ae5bd086307e76cddc68a4" title="check_interaction_table" alt="" coords="684,620,857,649"/><area shape="rect" id="node47" href="forcetree_8c.html#ab6894fe5ae268ea8f6bc7c4a8c87a87f" title="force_treeevaluate_ewald_correction" alt="" coords="643,831,899,860"/><area shape="rect" id="node50" href="sidm__routines_8c.html#a5b36e92449c7102086706b7b24899be8" title="prob_of_interaction" alt="" coords="699,727,843,756"/><area shape="rect" id="node54" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615" title="update_interaction_table" alt="" coords="680,673,861,703"/><area shape="rect" id="node52" href="sidm__routines_8c.html#ab5ff10bfb368309b0dd01aaa72c6be1d" title="g_geo" alt="" coords="985,727,1047,756"/><area shape="rect" id="node73" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="463,856,508,885"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ac559dc2aeb21d5a379a3751bea7736af_icgraph.png" border="0" usemap="#proto_8h_ac559dc2aeb21d5a379a3751bea7736af_icgraph" alt=""/></div>
<map name="proto_8h_ac559dc2aeb21d5a379a3751bea7736af_icgraph" id="proto_8h_ac559dc2aeb21d5a379a3751bea7736af_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="152,5,323,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="371,5,413,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="463,5,516,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a483c8f5e73b8445bbb44e3bab59f2f1d"></a><!-- doxytag: member="proto.h::gravity_tree_shortrange" ref="a483c8f5e73b8445bbb44e3bab59f2f1d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void gravity_tree_shortrange </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a2eafe05fb12d7f9d954d5b501e186051"></a><!-- doxytag: member="proto.h::gravkick_integ" ref="a2eafe05fb12d7f9d954d5b501e186051" args="(double a, void *param)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double gravkick_integ </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>param</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Integration kernel for gravitational kick factor computation. </p>

<p>Definition at line <a class="el" href="driftfac_8c_source.html#l00191">191</a> of file <a class="el" href="driftfac_8c_source.html">driftfac.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, and <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> h;

  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> / (a * a * a) + (1 - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>) / (a * a) + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>;
  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * sqrt(h);

  <span class="keywordflow">return</span> 1 / (h * a * a);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8331f87f49dedbeb9e7d61d0deb8926a"></a><!-- doxytag: member="proto.h::hydro_compare_key" ref="a8331f87f49dedbeb9e7d61d0deb8926a" args="(const void *a, const void *b)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int hydro_compare_key </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>b</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This is a comparison kernel for a sort routine, which is used to group particles that are going to be exported to the same CPU. </p>

<p>Definition at line <a class="el" href="hydra_8c_source.html#l00563">563</a> of file <a class="el" href="hydra_8c_source.html">hydra.c</a>.</p>

<p>Referenced by <a class="el" href="hydra_8c_source.html#l00050">hydro_force()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) a)-&gt;Task &lt; (((<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) b)-&gt;Task))
    <span class="keywordflow">return</span> -1;
  <span class="keywordflow">if</span>(((<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) a)-&gt;Task &gt; (((<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) b)-&gt;Task))
    <span class="keywordflow">return</span> +1;
  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a8331f87f49dedbeb9e7d61d0deb8926a_icgraph.png" border="0" usemap="#proto_8h_a8331f87f49dedbeb9e7d61d0deb8926a_icgraph" alt=""/></div>
<map name="proto_8h_a8331f87f49dedbeb9e7d61d0deb8926a_icgraph" id="proto_8h_a8331f87f49dedbeb9e7d61d0deb8926a_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="207,5,303,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="352,5,523,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="571,5,613,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="663,5,716,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a818695254c9525e01bc9ddc95e8eaf7e"></a><!-- doxytag: member="proto.h::hydro_evaluate" ref="a818695254c9525e01bc9ddc95e8eaf7e" args="(int target, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void hydro_evaluate </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is the 'core' of the SPH force computation. A target particle is specified which may either be local, or reside in the communication buffer. </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas </p>
</p>

<p>Definition at line <a class="el" href="hydra_8c_source.html#l00353">353</a> of file <a class="el" href="hydra_8c_source.html">hydra.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00307">global_data_all_processes::ArtBulkViscConst</a>, <a class="el" href="hydra_8c_source.html#l00028">boxHalf_X</a>, <a class="el" href="hydra_8c_source.html#l00034">boxHalf_Y</a>, <a class="el" href="hydra_8c_source.html#l00040">boxHalf_Z</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00565">sph_particle_data::CurlVel</a>, <a class="el" href="allvars_8h_source.html#l00780">hydrodata_in::Density</a>, <a class="el" href="allvars_8h_source.html#l00555">sph_particle_data::Density</a>, <a class="el" href="allvars_8h_source.html#l00783">hydrodata_in::DhsmlDensityFactor</a>, <a class="el" href="allvars_8h_source.html#l00567">sph_particle_data::DhsmlDensityFactor</a>, <a class="el" href="system_8c_source.html#l00101">dmin()</a>, <a class="el" href="allvars_8h_source.html#l00794">hydrodata_out::DtEntropy</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="allvars_8h_source.html#l00782">hydrodata_in::F1</a>, <a class="el" href="hydra_8c_source.html#l00019">fac_mu</a>, <a class="el" href="hydra_8c_source.html#l00019">fac_vsic_fix</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="allvars_8h_source.html#l00778">hydrodata_in::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="hydra_8c_source.html#l00019">hubble_a2</a>, <a class="el" href="allvars_8c_source.html#l00201">HydroDataGet</a>, <a class="el" href="allvars_8c_source.html#l00205">HydroDataResult</a>, <a class="el" href="system_8c_source.html#l00111">imax()</a>, <a class="el" href="allvars_8h_source.html#l00127">KERNEL_COEFF_3</a>, <a class="el" href="allvars_8h_source.html#l00130">KERNEL_COEFF_6</a>, <a class="el" href="allvars_8h_source.html#l00682">state_of_system::Mass</a>, <a class="el" href="allvars_8h_source.html#l00779">hydrodata_in::Mass</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00795">hydrodata_out::MaxSignalVel</a>, <a class="el" href="allvars_8h_source.html#l00568">sph_particle_data::MaxSignalVel</a>, <a class="el" href="ngb_8c_source.html#l00064">ngb_treefind_pairs()</a>, <a class="el" href="allvars_8c_source.html#l00036">Ngblist</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00776">hydrodata_in::Pos</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00781">hydrodata_in::Pressure</a>, <a class="el" href="allvars_8h_source.html#l00560">sph_particle_data::Pressure</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="allvars_8h_source.html#l00784">hydrodata_in::Timestep</a>, <a class="el" href="allvars_8h_source.html#l00777">hydrodata_in::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00563">sph_particle_data::VelPred</a>.</p>

<p>Referenced by <a class="el" href="hydra_8c_source.html#l00050">hydro_force()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> j, k, n, timestep, startnode, numngb;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> *pos, *vel;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> mass, h_i, dhsmlDensityFactor, rho, pressure, f1, f2;
  <span class="keywordtype">double</span> acc[3], dtEntropy, maxSignalVel;
  <span class="keywordtype">double</span> dx, dy, dz, dvx, dvy, dvz;
  <span class="keywordtype">double</span> h_i2, hinv, hinv4;
  <span class="keywordtype">double</span> p_over_rho2_i, p_over_rho2_j, soundspeed_i, soundspeed_j;
  <span class="keywordtype">double</span> hfc, dwk_i, vdotr, vdotr2, visc, mu_ij, rho_ij, vsig;
  <span class="keywordtype">double</span> h_j, dwk_j, r, r2, u, hfc_visc;

<span class="preprocessor">#ifndef NOVISCOSITYLIMITER</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> dt;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(mode == 0)
    {
      pos = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>;
      vel = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>;
      h_i = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
      mass = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
      dhsmlDensityFactor = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a>;
      rho = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a>;
      pressure = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a9201a97de5fe06f6ed6fcc33386eccda">Pressure</a>;
      timestep = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[target].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>;
      soundspeed_i = sqrt(<a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> * pressure / rho);
      f1 = fabs(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].DivVel) /
        (fabs(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].DivVel) + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a843c827a50c8783218cd850925deb575">CurlVel</a> +
         0.0001 * soundspeed_i / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> / <a class="code" href="hydra_8c.html#acb165aa9c0459664aba04d793812aa34">fac_mu</a>);
    }
  <span class="keywordflow">else</span>
    {
      pos = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#af50edb8226de4bdcdbcc0f2679cc694d">Pos</a>;
      vel = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#aac935e4620b7700cae000a32a2922df4">Vel</a>;
      h_i = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#ae24f9ceb40451913af1ab6e793772bdd">Hsml</a>;
      mass = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#a5fb05f5111cc5541a5f2d9ad647b0665">Mass</a>;
      dhsmlDensityFactor = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#ad2da50b0d4b51a53f9fb5cb4c41f20b8">DhsmlDensityFactor</a>;
      rho = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#ac408286b56271e4e30f8c149a812948c">Density</a>;
      pressure = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#a95298759ae954d623a92d59f71d318ba">Pressure</a>;
      timestep = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#a6b2160624adc7ad0304597845531ffa7">Timestep</a>;
      soundspeed_i = sqrt(<a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> * pressure / rho);
      f1 = <a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#a2b0cc9653b307eac998cec7175036b20">F1</a>;
    }


  <span class="comment">/* initialize variables before SPH loop is started */</span>
  acc[0] = acc[1] = acc[2] = dtEntropy = 0;
  maxSignalVel = 0;

  p_over_rho2_i = pressure / (rho * rho) * dhsmlDensityFactor;
  h_i2 = h_i * h_i;

  <span class="comment">/* Now start the actual SPH computation for this particle */</span>
  startnode = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;
  <span class="keywordflow">do</span>
    {
      numngb = <a class="code" href="ngb_8c.html#a96ec7acfa3c046abc6902ca77ee4bddd">ngb_treefind_pairs</a>(&amp;pos[0], h_i, &amp;startnode);

      <span class="keywordflow">for</span>(n = 0; n &lt; numngb; n++)
        {
          j = <a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a>[n];

          dx = pos[0] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
          dy = pos[1] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
          dz = pos[2] - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];

<span class="preprocessor">#ifdef PERIODIC                 </span><span class="comment">/*  find the closest image in the given box size  */</span>
          <span class="keywordflow">if</span>(dx &gt; <a class="code" href="hydra_8c.html#a0ecceb71797a529fb6f2b8c47b51686c">boxHalf_X</a>)
            dx -= boxSize_X;
          <span class="keywordflow">if</span>(dx &lt; -<a class="code" href="hydra_8c.html#a0ecceb71797a529fb6f2b8c47b51686c">boxHalf_X</a>)
            dx += boxSize_X;
          <span class="keywordflow">if</span>(dy &gt; <a class="code" href="hydra_8c.html#a59f20d7decc2bdfedcaafb70ef23df0e">boxHalf_Y</a>)
            dy -= boxSize_Y;
          <span class="keywordflow">if</span>(dy &lt; -<a class="code" href="hydra_8c.html#a59f20d7decc2bdfedcaafb70ef23df0e">boxHalf_Y</a>)
            dy += boxSize_Y;
          <span class="keywordflow">if</span>(dz &gt; <a class="code" href="hydra_8c.html#a34e9d5d079320cbfc0576d26f58d2fe7">boxHalf_Z</a>)
            dz -= boxSize_Z;
          <span class="keywordflow">if</span>(dz &lt; -<a class="code" href="hydra_8c.html#a34e9d5d079320cbfc0576d26f58d2fe7">boxHalf_Z</a>)
            dz += boxSize_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;
          h_j = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
          <span class="keywordflow">if</span>(r2 &lt; h_i2 || r2 &lt; h_j * h_j)
            {
              r = sqrt(r2);
              <span class="keywordflow">if</span>(r &gt; 0)
                {
                  p_over_rho2_j = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#a9201a97de5fe06f6ed6fcc33386eccda">Pressure</a> / (<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a>);
                  soundspeed_j = sqrt(<a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> * p_over_rho2_j * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].Density);
                  dvx = vel[0] - <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[0];
                  dvy = vel[1] - <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[1];
                  dvz = vel[2] - <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[2];
                  vdotr = dx * dvx + dy * dvy + dz * dvz;

                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
                    vdotr2 = vdotr + <a class="code" href="hydra_8c.html#a15cf7694d03164516fd55696b858a125">hubble_a2</a> * r2;
                  <span class="keywordflow">else</span>
                    vdotr2 = vdotr;

                  <span class="keywordflow">if</span>(r2 &lt; h_i2)
                    {
                      hinv = 1.0 / h_i;
<span class="preprocessor">#ifndef  TWODIMS</span>
<span class="preprocessor"></span>                      hinv4 = hinv * hinv * hinv * hinv;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>                      hinv4 = hinv * hinv * hinv / boxSize_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                      u = r * hinv;
                      <span class="keywordflow">if</span>(u &lt; 0.5)
                        dwk_i = hinv4 * u * (<a class="code" href="allvars_8h.html#a3bb5c97343f773154b21becfa01914c3">KERNEL_COEFF_3</a> * u - KERNEL_COEFF_4);
                      <span class="keywordflow">else</span>
                        dwk_i = hinv4 * <a class="code" href="allvars_8h.html#a7b9464063f0137e9da842c10d1b86ed2">KERNEL_COEFF_6</a> * (1.0 - u) * (1.0 - u);
                    }
                  <span class="keywordflow">else</span>
                    {
                      dwk_i = 0;
                    }

                  <span class="keywordflow">if</span>(r2 &lt; h_j * h_j)
                    {
                      hinv = 1.0 / h_j;
<span class="preprocessor">#ifndef  TWODIMS</span>
<span class="preprocessor"></span>                      hinv4 = hinv * hinv * hinv * hinv;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>                      hinv4 = hinv * hinv * hinv / boxSize_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                      u = r * hinv;
                      <span class="keywordflow">if</span>(u &lt; 0.5)
                        dwk_j = hinv4 * u * (<a class="code" href="allvars_8h.html#a3bb5c97343f773154b21becfa01914c3">KERNEL_COEFF_3</a> * u - KERNEL_COEFF_4);
                      <span class="keywordflow">else</span>
                        dwk_j = hinv4 * <a class="code" href="allvars_8h.html#a7b9464063f0137e9da842c10d1b86ed2">KERNEL_COEFF_6</a> * (1.0 - u) * (1.0 - u);
                    }
                  <span class="keywordflow">else</span>
                    {
                      dwk_j = 0;
                    }

                  <span class="keywordflow">if</span>(soundspeed_i + soundspeed_j &gt; maxSignalVel)
                    maxSignalVel = soundspeed_i + soundspeed_j;

                  <span class="keywordflow">if</span>(vdotr2 &lt; 0)        <span class="comment">/* ... artificial viscosity */</span>
                    {
                      mu_ij = <a class="code" href="hydra_8c.html#acb165aa9c0459664aba04d793812aa34">fac_mu</a> * vdotr2 / r;      <span class="comment">/* note: this is negative! */</span>

                      vsig = soundspeed_i + soundspeed_j - 3 * mu_ij;

                      <span class="keywordflow">if</span>(vsig &gt; maxSignalVel)
                        maxSignalVel = vsig;

                      rho_ij = 0.5 * (rho + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a>);
                      f2 =
                        fabs(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].DivVel) / (fabs(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].DivVel) + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#a843c827a50c8783218cd850925deb575">CurlVel</a> +
                                                0.0001 * soundspeed_j / <a class="code" href="hydra_8c.html#acb165aa9c0459664aba04d793812aa34">fac_mu</a> / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>);

                      visc = 0.25 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a14b9df6a6579d2ce6ef7c86aa0230217">ArtBulkViscConst</a> * vsig * (-mu_ij) / rho_ij * (f1 + f2);

                      <span class="comment">/* .... end artificial viscosity evaluation */</span>
<span class="preprocessor">#ifndef NOVISCOSITYLIMITER</span>
<span class="preprocessor"></span>                      <span class="comment">/* make sure that viscous acceleration is not too large */</span>
                      dt = <a class="code" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10">imax</a>(timestep, (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>)) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
                      <span class="keywordflow">if</span>(dt &gt; 0 &amp;&amp; (dwk_i + dwk_j) &lt; 0)
                        {
                          visc = <a class="code" href="proto_8h.html#a128779c23a7c6e9cca2374c5e7c91483">dmin</a>(visc, 0.5 * <a class="code" href="hydra_8c.html#a99addeb2d520f107c59e4e228e8e76dd">fac_vsic_fix</a> * vdotr2 /
                                      (0.5 * (mass + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>) * (dwk_i + dwk_j) * r * dt));
                        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                    }
                  <span class="keywordflow">else</span>
                    visc = 0;

                  p_over_rho2_j *= <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[j].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a>;

                  hfc_visc = 0.5 * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * visc * (dwk_i + dwk_j) / r;

                  hfc = hfc_visc + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[j].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> * (p_over_rho2_i * dwk_i + p_over_rho2_j * dwk_j) / r;

                  acc[0] -= hfc * dx;
                  acc[1] -= hfc * dy;
                  acc[2] -= hfc * dz;
                  dtEntropy += 0.5 * hfc_visc * vdotr2;
                }
            }
        }
    }
  <span class="keywordflow">while</span>(startnode &gt;= 0);

  <span class="comment">/* Now collect the result at the right place */</span>
  <span class="keywordflow">if</span>(mode == 0)
    {
      <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
        <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].HydroAccel[k] = acc[k];
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> = dtEntropy;
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[target].<a class="code" href="structsph__particle__data.html#a86da008875968dfca41b35f4ca7f3164">MaxSignalVel</a> = maxSignalVel;
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
        <a class="code" href="allvars_8c.html#a4ec6a36a80786f2f8e7fb9794c1f6629">HydroDataResult</a>[target].Acc[k] = acc[k];
      <a class="code" href="allvars_8c.html#a4ec6a36a80786f2f8e7fb9794c1f6629">HydroDataResult</a>[target].<a class="code" href="structhydrodata__out.html#a0bd5bd8b7c1ec82abf3e5f001543441c">DtEntropy</a> = dtEntropy;
      <a class="code" href="allvars_8c.html#a4ec6a36a80786f2f8e7fb9794c1f6629">HydroDataResult</a>[target].<a class="code" href="structhydrodata__out.html#a6f4c65630e80c636a128d59e0afc4dad">MaxSignalVel</a> = maxSignalVel;
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a818695254c9525e01bc9ddc95e8eaf7e_cgraph.png" border="0" usemap="#proto_8h_a818695254c9525e01bc9ddc95e8eaf7e_cgraph" alt=""/></div>
<map name="proto_8h_a818695254c9525e01bc9ddc95e8eaf7e_cgraph" id="proto_8h_a818695254c9525e01bc9ddc95e8eaf7e_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a128779c23a7c6e9cca2374c5e7c91483" title="dmin" alt="" coords="217,5,271,35"/><area shape="rect" id="node5" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10" title="imax" alt="" coords="217,59,271,88"/><area shape="rect" id="node7" href="ngb_8c.html#a96ec7acfa3c046abc6902ca77ee4bddd" title="ngb_treefind_pairs" alt="" coords="175,112,313,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a818695254c9525e01bc9ddc95e8eaf7e_icgraph.png" border="0" usemap="#proto_8h_a818695254c9525e01bc9ddc95e8eaf7e_icgraph" alt=""/></div>
<map name="proto_8h_a818695254c9525e01bc9ddc95e8eaf7e_icgraph" id="proto_8h_a818695254c9525e01bc9ddc95e8eaf7e_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="175,5,271,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="320,5,491,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="539,5,581,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="631,5,684,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a6789381bce7d1c316df8ecf04b47a607"></a><!-- doxytag: member="proto.h::hydro_force" ref="a6789381bce7d1c316df8ecf04b47a607" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void hydro_force </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is the driver routine for the calculation of hydrodynamical force and rate of change of entropy due to shock heating for all active particles . </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas </p>
</p>

<p>Definition at line <a class="el" href="hydra_8c_source.html#l00050">50</a> of file <a class="el" href="hydra_8c_source.html">hydra.c</a>.</p>

<p>References <a class="el" href="hydra_8c_source.html#l00019">a3inv</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="hydra_8c_source.html#l00019">atime</a>, <a class="el" href="hydra_8c_source.html#l00022">boxHalf</a>, <a class="el" href="hydra_8c_source.html#l00028">boxHalf_X</a>, <a class="el" href="hydra_8c_source.html#l00034">boxHalf_Y</a>, <a class="el" href="hydra_8c_source.html#l00040">boxHalf_Z</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="hydra_8c_source.html#l00022">boxSize</a>, <a class="el" href="hydra_8c_source.html#l00027">boxSize_X</a>, <a class="el" href="hydra_8c_source.html#l00033">boxSize_Y</a>, <a class="el" href="hydra_8c_source.html#l00039">boxSize_Z</a>, <a class="el" href="allvars_8h_source.html#l00291">global_data_all_processes::BunchSizeHydro</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00416">global_data_all_processes::CPU_HydCommSumm</a>, <a class="el" href="allvars_8h_source.html#l00415">global_data_all_processes::CPU_HydCompWalk</a>, <a class="el" href="allvars_8h_source.html#l00417">global_data_all_processes::CPU_HydImbalance</a>, <a class="el" href="allvars_8h_source.html#l00565">sph_particle_data::CurlVel</a>, <a class="el" href="allvars_8h_source.html#l00555">sph_particle_data::Density</a>, <a class="el" href="allvars_8h_source.html#l00780">hydrodata_in::Density</a>, <a class="el" href="allvars_8h_source.html#l00567">sph_particle_data::DhsmlDensityFactor</a>, <a class="el" href="allvars_8h_source.html#l00783">hydrodata_in::DhsmlDensityFactor</a>, <a class="el" href="allvars_8h_source.html#l00794">hydrodata_out::DtEntropy</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8h_source.html#l00782">hydrodata_in::F1</a>, <a class="el" href="hydra_8c_source.html#l00019">fac_egy</a>, <a class="el" href="hydra_8c_source.html#l00019">fac_mu</a>, <a class="el" href="hydra_8c_source.html#l00019">fac_vsic_fix</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="allvars_8h_source.html#l00071">GAMMA_MINUS1</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00778">hydrodata_in::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="hydra_8c_source.html#l00019">hubble_a</a>, <a class="el" href="hydra_8c_source.html#l00019">hubble_a2</a>, <a class="el" href="hydra_8c_source.html#l00563">hydro_compare_key()</a>, <a class="el" href="hydra_8c_source.html#l00353">hydro_evaluate()</a>, <a class="el" href="allvars_8c_source.html#l00201">HydroDataGet</a>, <a class="el" href="allvars_8c_source.html#l00201">HydroDataIn</a>, <a class="el" href="allvars_8c_source.html#l00205">HydroDataPartialResult</a>, <a class="el" href="allvars_8c_source.html#l00205">HydroDataResult</a>, <a class="el" href="allvars_8h_source.html#l00786">hydrodata_in::Index</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00779">hydrodata_in::Mass</a>, <a class="el" href="allvars_8h_source.html#l00795">hydrodata_out::MaxSignalVel</a>, <a class="el" href="allvars_8h_source.html#l00568">sph_particle_data::MaxSignalVel</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8c_source.html#l00025">NumSphUpdate</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00776">hydrodata_in::Pos</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8h_source.html#l00560">sph_particle_data::Pressure</a>, <a class="el" href="allvars_8h_source.html#l00781">hydrodata_in::Pressure</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="tags_8h_source.html#l00017">TAG_HYDRO_A</a>, <a class="el" href="tags_8h_source.html#l00018">TAG_HYDRO_B</a>, <a class="el" href="allvars_8h_source.html#l00785">hydrodata_in::Task</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00784">hydrodata_in::Timestep</a>, <a class="el" href="allvars_8h_source.html#l00777">hydrodata_in::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00563">sph_particle_data::VelPred</a>.</p>

<p>Referenced by <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot, ntotleft;
  <span class="keywordtype">int</span> i, j, k, n, ngrp, maxfill, source, ndone;
  <span class="keywordtype">int</span> *nbuffer, *noffset, *nsend_local, *nsend, *numlist, *ndonelist;
  <span class="keywordtype">int</span> level, sendTask, recvTask, nexport, place;
  <span class="keywordtype">double</span> soundspeed_i;
  <span class="keywordtype">double</span> tstart, tend, sumt, sumcomm;
  <span class="keywordtype">double</span> timecomp = 0, timecommsumm = 0, timeimbalance = 0, sumimbalance;
  MPI_Status status;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <a class="code" href="hydra_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  <a class="code" href="hydra_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#ifdef LONG_X</span>
<span class="preprocessor"></span>  <a class="code" href="hydra_8c.html#a0ecceb71797a529fb6f2b8c47b51686c">boxHalf_X</a> = <a class="code" href="hydra_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_X;
  <a class="code" href="hydra_8c.html#a5c5328b307b005e6682669279878cef0">boxSize_X</a> = <a class="code" href="hydra_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_X;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
<span class="preprocessor"></span>  <a class="code" href="hydra_8c.html#a59f20d7decc2bdfedcaafb70ef23df0e">boxHalf_Y</a> = <a class="code" href="hydra_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_Y;
  <a class="code" href="hydra_8c.html#ab0db73a31e08d33d840e28651e3cf610">boxSize_Y</a> = <a class="code" href="hydra_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_Y;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
<span class="preprocessor"></span>  <a class="code" href="hydra_8c.html#a34e9d5d079320cbfc0576d26f58d2fe7">boxHalf_Z</a> = <a class="code" href="hydra_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_Z;
  <a class="code" href="hydra_8c.html#a8a97a1c456bdd396791c84c370f0aa18">boxSize_Z</a> = <a class="code" href="hydra_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      <span class="comment">/* Factors for comoving integration of hydro */</span>
      <a class="code" href="hydra_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>)
        + (1 - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>) / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>;

      <a class="code" href="hydra_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * sqrt(<a class="code" href="hydra_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>);
      <a class="code" href="hydra_8c.html#a15cf7694d03164516fd55696b858a125">hubble_a2</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="hydra_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a>;

      <a class="code" href="hydra_8c.html#acb165aa9c0459664aba04d793812aa34">fac_mu</a> = <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, 3 * (<a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> - 1) / 2) / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;

      <a class="code" href="hydra_8c.html#a10ab9a51765fc1b79e1282b3cccb2085">fac_egy</a> = <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, 3 * (<a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> - 1));

      <a class="code" href="hydra_8c.html#a99addeb2d520f107c59e4e228e8e76dd">fac_vsic_fix</a> = <a class="code" href="hydra_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>, 3 * <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>);

      <a class="code" href="hydra_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a> = 1 / (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>);
      <a class="code" href="hydra_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
    }
  <span class="keywordflow">else</span>
    <a class="code" href="hydra_8c.html#abb7074f2e4b01309c6f2dc87bb3a1a40">hubble_a</a> = <a class="code" href="hydra_8c.html#a15cf7694d03164516fd55696b858a125">hubble_a2</a> = <a class="code" href="hydra_8c.html#aec7bcb1d46812f966d89f66dc1a399ea">atime</a> = <a class="code" href="hydra_8c.html#acb165aa9c0459664aba04d793812aa34">fac_mu</a> = <a class="code" href="hydra_8c.html#a99addeb2d520f107c59e4e228e8e76dd">fac_vsic_fix</a> = <a class="code" href="hydra_8c.html#a7f2a6bb4bade30e4e04ee29be22d0962">a3inv</a> = <a class="code" href="hydra_8c.html#a10ab9a51765fc1b79e1282b3cccb2085">fac_egy</a> = 1.0;


  <span class="comment">/* `NumSphUpdate&#39; gives the number of particles on this processor that want a force update */</span>
  <span class="keywordflow">for</span>(n = 0, <a class="code" href="allvars_8c.html#a0da112f9d57d7d936055dbb1035cd7fa">NumSphUpdate</a> = 0; n &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; n++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
        <a class="code" href="allvars_8c.html#a0da112f9d57d7d936055dbb1035cd7fa">NumSphUpdate</a>++;
    }

  numlist = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
  MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a0da112f9d57d7d936055dbb1035cd7fa">NumSphUpdate</a>, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
  <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
    ntot += numlist[i];
  free(numlist);


  noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);        <span class="comment">/* offsets of bunches in common list */</span>
  nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
  nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
  nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask * NTask);
  ndonelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);


  i = 0;                        <span class="comment">/* first particle for this task */</span>
  ntotleft = ntot;              <span class="comment">/* particles left for all tasks together */</span>

  <span class="keywordflow">while</span>(ntotleft &gt; 0)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
        nsend_local[j] = 0;

      <span class="comment">/* do local particles and prepare export list */</span>
      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; N_gas &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a> - NTask; i++)
        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
          {
            ndone++;

            <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
              <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j] = 0;

            <a class="code" href="hydra_8c.html#a818695254c9525e01bc9ddc95e8eaf7e">hydro_evaluate</a>(i, 0);

            <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
              {
                <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[j])
                  {
                    <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                      {
                        <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#af50edb8226de4bdcdbcc0f2679cc694d">Pos</a>[k] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[k];
                        <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#aac935e4620b7700cae000a32a2922df4">Vel</a>[k] = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[k];
                      }
                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#ae24f9ceb40451913af1ab6e793772bdd">Hsml</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a>;
                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#a5fb05f5111cc5541a5f2d9ad647b0665">Mass</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a>;
                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#ad2da50b0d4b51a53f9fb5cb4c41f20b8">DhsmlDensityFactor</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af49cca403dc402fdb0d0d481d49d7b53">DhsmlDensityFactor</a>;
                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#ac408286b56271e4e30f8c149a812948c">Density</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a>;
                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#a95298759ae954d623a92d59f71d318ba">Pressure</a> = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a9201a97de5fe06f6ed6fcc33386eccda">Pressure</a>;
                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#a6b2160624adc7ad0304597845531ffa7">Timestep</a> = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a>;

                    <span class="comment">/* calculation of F1 */</span>
                    soundspeed_i = sqrt(<a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Pressure / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Density);
                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#a2b0cc9653b307eac998cec7175036b20">F1</a> = fabs(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].DivVel) /
                      (fabs(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].DivVel) + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a843c827a50c8783218cd850925deb575">CurlVel</a> +
                       0.0001 * soundspeed_i / <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> / <a class="code" href="hydra_8c.html#acb165aa9c0459664aba04d793812aa34">fac_mu</a>);

                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#a630be87b2fd46a0e22f57bde1a48e015">Index</a> = i;
                    <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#a7d38ae5b3289a90c4d33add0572942cc">Task</a> = j;
                    nexport++;
                    nsend_local[j]++;
                  }
              }
          }
      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      timecomp += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

      qsort(<a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a>), <a class="code" href="hydra_8c.html#a8331f87f49dedbeb9e7d61d0deb8926a">hydro_compare_key</a>);

      <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
        noffset[j] = noffset[j - 1] + nsend_local[j - 1];

      tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

      MPI_Allgather(nsend_local, NTask, MPI_INT, nsend, NTask, MPI_INT, MPI_COMM_WORLD);

      tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
      timeimbalance += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);



      <span class="comment">/* now do the particles that need to be exported */</span>

      <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++)
        {
          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nbuffer[j] = 0;
          <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
            {
              maxfill = 0;
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                {
                  <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                    <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                      maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                }
              <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a>)
                <span class="keywordflow">break</span>;

              sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
              recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;

              <span class="keywordflow">if</span>(recvTask &lt; NTask)
                {
                  <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                    {
                      <span class="comment">/* get the particles */</span>
                      MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[noffset[recvTask]],
                                   nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a>), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#ae3ab8ca648ad0e44275fee8f72cec860">TAG_HYDRO_A</a>,
                                   &amp;<a class="code" href="allvars_8c.html#a361f3970d23b525898314bd2742ecf8c">HydroDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                   nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a>), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#ae3ab8ca648ad0e44275fee8f72cec860">TAG_HYDRO_A</a>, MPI_COMM_WORLD, &amp;status);
                    }
                }

              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                  nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
            }
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timecommsumm += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

          <span class="comment">/* now do the imported particles */</span>
          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]; j++)
            <a class="code" href="hydra_8c.html#a818695254c9525e01bc9ddc95e8eaf7e">hydro_evaluate</a>(j, 1);
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timecomp += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

          <span class="comment">/* do a block to measure imbalance */</span>
          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          MPI_Barrier(MPI_COMM_WORLD);
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timeimbalance += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

          <span class="comment">/* get the result */</span>
          tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
            nbuffer[j] = 0;
          <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); ngrp++)
            {
              maxfill = 0;
              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                {
                  <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                    <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * NTask + j])
                      maxfill = nbuffer[j] + nsend[(j ^ ngrp) * NTask + j];
                }
              <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afe2775a289a902710358d98ba607a0aa">BunchSizeHydro</a>)
                <span class="keywordflow">break</span>;

              sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
              recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ ngrp;

              <span class="keywordflow">if</span>(recvTask &lt; NTask)
                {
                  <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> * NTask + recvTask] &gt; 0 || nsend[recvTask * NTask + <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>] &gt; 0)
                    {
                      <span class="comment">/* send the results */</span>
                      MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a4ec6a36a80786f2f8e7fb9794c1f6629">HydroDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>]],
                                   nsend[recvTask * NTask + ThisTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structhydrodata__out.html">hydrodata_out</a>),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#ad8173594acf616a48eb98310f6fd7815">TAG_HYDRO_B</a>,
                                   &amp;<a class="code" href="allvars_8c.html#ab7f7e4c36b3ed818849ba610d82b38bc">HydroDataPartialResult</a>[noffset[recvTask]],
                                   nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structhydrodata__out.html">hydrodata_out</a>),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#ad8173594acf616a48eb98310f6fd7815">TAG_HYDRO_B</a>, MPI_COMM_WORLD, &amp;status);

                      <span class="comment">/* add the result to the particles */</span>
                      <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
                        {
                          source = j + noffset[recvTask];
                          place = <a class="code" href="allvars_8c.html#ac76194e83ab629234cfbe7ea412f4147">HydroDataIn</a>[source].<a class="code" href="structhydrodata__in.html#a630be87b2fd46a0e22f57bde1a48e015">Index</a>;

                          <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
                            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].HydroAccel[k] += <a class="code" href="allvars_8c.html#ab7f7e4c36b3ed818849ba610d82b38bc">HydroDataPartialResult</a>[source].Acc[k];

                          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> += <a class="code" href="allvars_8c.html#ab7f7e4c36b3ed818849ba610d82b38bc">HydroDataPartialResult</a>[source].<a class="code" href="structhydrodata__out.html#a0bd5bd8b7c1ec82abf3e5f001543441c">DtEntropy</a>;

                          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].MaxSignalVel &lt; <a class="code" href="allvars_8c.html#ab7f7e4c36b3ed818849ba610d82b38bc">HydroDataPartialResult</a>[source].MaxSignalVel)
                            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[place].<a class="code" href="structsph__particle__data.html#a86da008875968dfca41b35f4ca7f3164">MaxSignalVel</a> = <a class="code" href="allvars_8c.html#ab7f7e4c36b3ed818849ba610d82b38bc">HydroDataPartialResult</a>[source].<a class="code" href="structhydrodata__out.html#a6f4c65630e80c636a128d59e0afc4dad">MaxSignalVel</a>;
                        }
                    }
                }

              <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
                <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
                  nbuffer[j] += nsend[(j ^ ngrp) * NTask + j];
            }
          tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
          timecommsumm += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

          level = ngrp - 1;
        }

      MPI_Allgather(&amp;ndone, 1, MPI_INT, ndonelist, 1, MPI_INT, MPI_COMM_WORLD);
      <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
        ntotleft -= ndonelist[j];
    }

  free(ndonelist);
  free(nsend);
  free(nsend_local);
  free(nbuffer);
  free(noffset);



  <span class="comment">/* do final operations on results */</span>
  tstart = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> == <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a>)
      {
        <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> *= <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a> / (<a class="code" href="hydra_8c.html#a15cf7694d03164516fd55696b858a125">hubble_a2</a> * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Density, <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>));
<span class="preprocessor">#ifdef SPH_BND_PARTICLES</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a> == 0)
          {
            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> = 0;
            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].HydroAccel[k] = 0;
          }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      }

  tend = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();
  timecomp += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(tstart, tend);

  <span class="comment">/* collect some timing information */</span>

  MPI_Reduce(&amp;timecomp, &amp;sumt, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;timecommsumm, &amp;sumcomm, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
  MPI_Reduce(&amp;timeimbalance, &amp;sumimbalance, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(ThisTask == 0)
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a918e3d80cf4fdaf22a803f4014588ad4">CPU_HydCompWalk</a> += sumt / NTask;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad03842fb23d3c15316ca07c7ac1bce27">CPU_HydCommSumm</a> += sumcomm / NTask;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a848f914dfb3ae24d6faedc1944bcb265">CPU_HydImbalance</a> += sumimbalance / NTask;
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a6789381bce7d1c316df8ecf04b47a607_cgraph.png" border="0" usemap="#proto_8h_a6789381bce7d1c316df8ecf04b47a607_cgraph" alt=""/></div>
<map name="proto_8h_a6789381bce7d1c316df8ecf04b47a607_cgraph" id="proto_8h_a6789381bce7d1c316df8ecf04b47a607_cgraph">
<area shape="rect" id="node3" href="hydra_8c.html#a8331f87f49dedbeb9e7d61d0deb8926a" title="hydro_compare_key" alt="" coords="153,5,303,35"/><area shape="rect" id="node5" href="hydra_8c.html#a818695254c9525e01bc9ddc95e8eaf7e" title="hydro_evaluate" alt="" coords="168,59,288,88"/><area shape="rect" id="node13" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="400,191,445,220"/><area shape="rect" id="node15" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="195,163,261,192"/><area shape="rect" id="node17" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="193,216,263,245"/><area shape="rect" id="node7" href="proto_8h.html#a128779c23a7c6e9cca2374c5e7c91483" title="dmin" alt="" coords="396,5,449,35"/><area shape="rect" id="node9" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10" title="imax" alt="" coords="396,59,449,88"/><area shape="rect" id="node11" href="ngb_8c.html#a96ec7acfa3c046abc6902ca77ee4bddd" title="ngb_treefind_pairs" alt="" coords="353,112,492,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a6789381bce7d1c316df8ecf04b47a607_icgraph.png" border="0" usemap="#proto_8h_a6789381bce7d1c316df8ecf04b47a607_icgraph" alt=""/></div>
<map name="proto_8h_a6789381bce7d1c316df8ecf04b47a607_icgraph" id="proto_8h_a6789381bce7d1c316df8ecf04b47a607_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="152,5,323,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="371,5,413,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="463,5,516,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5ebdee2c7332bed6c1a8994ac3c38c0d"></a><!-- doxytag: member="proto.h::hydrokick_integ" ref="a5ebdee2c7332bed6c1a8994ac3c38c0d" args="(double a, void *param)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double hydrokick_integ </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>param</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Integration kernel for hydrodynamical kick factor computation. </p>

<p><p>&lt; adiabatic index of simulated gas </p>
</p>

<p>Definition at line <a class="el" href="driftfac_8c_source.html#l00204">204</a> of file <a class="el" href="driftfac_8c_source.html">driftfac.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00071">GAMMA_MINUS1</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, and <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> h;

  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> / (a * a * a) + (1 - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>) / (a * a) + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>;
  h = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * sqrt(h);

  <span class="keywordflow">return</span> 1 / (h * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(a, 3 * <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>) * a);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a5ebdee2c7332bed6c1a8994ac3c38c0d_cgraph.png" border="0" usemap="#proto_8h_a5ebdee2c7332bed6c1a8994ac3c38c0d_cgraph" alt=""/></div>
<map name="proto_8h_a5ebdee2c7332bed6c1a8994ac3c38c0d_cgraph" id="proto_8h_a5ebdee2c7332bed6c1a8994ac3c38c0d_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="177,5,223,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a05ba897ffe0dfe737254a09c91c50d10"></a><!-- doxytag: member="proto.h::imax" ref="a05ba897ffe0dfe737254a09c91c50d10" args="(int, int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int imax </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>y</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>returns the maximum of two integers </p>

<p>Definition at line <a class="el" href="system_8c_source.html#l00111">111</a> of file <a class="el" href="system_8c_source.html">system.c</a>.</p>

<p>Referenced by <a class="el" href="hydra_8c_source.html#l00353">hydro_evaluate()</a>, and <a class="el" href="pm__periodic_8c_source.html#l00113">pm_init_periodic_allocate()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(x &gt; y)
    <span class="keywordflow">return</span> x;
  <span class="keywordflow">else</span>
    <span class="keywordflow">return</span> y;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a05ba897ffe0dfe737254a09c91c50d10_icgraph.png" border="0" usemap="#proto_8h_a05ba897ffe0dfe737254a09c91c50d10_icgraph" alt=""/></div>
<map name="proto_8h_a05ba897ffe0dfe737254a09c91c50d10_icgraph" id="proto_8h_a05ba897ffe0dfe737254a09c91c50d10_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a818695254c9525e01bc9ddc95e8eaf7e" title="hydro_evaluate" alt="" coords="139,5,259,35"/><area shape="rect" id="node13" href="proto_8h.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="108,59,289,88"/><area shape="rect" id="node5" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="568,5,664,35"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="760,33,931,63"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1003,85,1045,115"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1095,85,1148,115"/><area shape="rect" id="node15" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="352,59,483,88"/><area shape="rect" id="node20" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="340,112,495,141"/><area shape="rect" id="node17" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="551,59,681,88"/><area shape="rect" id="node22" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="545,112,687,141"/><area shape="rect" id="node24" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="736,137,955,167"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af52841aeeb1b5bf6787e1e2036088644"></a><!-- doxytag: member="proto.h::imin" ref="af52841aeeb1b5bf6787e1e2036088644" args="(int, int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int imin </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>y</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>returns the minimum of two integers </p>

<p>Definition at line <a class="el" href="system_8c_source.html#l00121">121</a> of file <a class="el" href="system_8c_source.html">system.c</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00534">domain_findExchangeNumbers()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(x &lt; y)
    <span class="keywordflow">return</span> x;
  <span class="keywordflow">else</span>
    <span class="keywordflow">return</span> y;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af52841aeeb1b5bf6787e1e2036088644_icgraph.png" border="0" usemap="#proto_8h_af52841aeeb1b5bf6787e1e2036088644_icgraph" alt=""/></div>
<map name="proto_8h_af52841aeeb1b5bf6787e1e2036088644_icgraph" id="proto_8h_af52841aeeb1b5bf6787e1e2036088644_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a0e758ec7eef32fc7180092547f5a11b9" title="domain_findExchangeNumbers" alt="" coords="104,57,325,87"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="373,57,525,87"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="573,57,747,87"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="795,5,1013,35"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1073,56,1116,85"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="884,109,924,139"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1177,83,1231,112"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1061,109,1128,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a2858154e2009b0e6e616f313177762bc"></a><!-- doxytag: member="proto.h::init" ref="a2858154e2009b0e6e616f313177762bc" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void init </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function reads the initial conditions, and allocates storage for the tree. Various variables of the particle data are initialised and An intial domain decomposition is performed. If SPH particles are present, the inial SPH smoothing lengths are determined. </p>

<p><p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29</p>
<p>&lt; defines maximum length of neighbour list</p>
<p>&lt; adiabatic index of simulated gas</p>
<p>&lt; adiabatic index of simulated gas </p>
</p>

<p>Definition at line <a class="el" href="init_8c_source.html#l00020">20</a> of file <a class="el" href="init_8c_source.html">init.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="init_8c_source.html#l00162">check_omega()</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00555">sph_particle_data::Density</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00650">io_header::flag_entropy_instead_u</a>, <a class="el" href="allvars_8c_source.html#l00040">Flag_FullStep</a>, <a class="el" href="forcetree_8c_source.html#l02827">force_treeallocate()</a>, <a class="el" href="allvars_8h_source.html#l00071">GAMMA_MINUS1</a>, <a class="el" href="system_8c_source.html#l00029">get_random_number()</a>, <a class="el" href="allvars_8h_source.html#l00537">particle_data::GravCost</a>, <a class="el" href="allvars_8c_source.html#l00162">header</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00562">sph_particle_data::HydroAccel</a>, <a class="el" href="allvars_8h_source.html#l00280">global_data_all_processes::ICFormat</a>, <a class="el" href="allvars_8h_source.html#l00489">global_data_all_processes::InitCondFile</a>, <a class="el" href="allvars_8h_source.html#l00107">MAX_NGB</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="ngb_8c_source.html#l00358">ngb_treeallocate()</a>, <a class="el" href="ngb_8c_source.html#l00403">ngb_treebuild()</a>, <a class="el" href="allvars_8h_source.html#l00364">global_data_all_processes::NumCurrentTiStep</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00524">particle_data::OldAcc</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00348">global_data_all_processes::PeriodicBoundariesOn</a>, <a class="el" href="allvars_8h_source.html#l00386">global_data_all_processes::PM_Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00523">particle_data::Potential</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="read__ic_8c_source.html#l00031">read_ic()</a>, <a class="el" href="allvars_8c_source.html#l00030">RestartFlag</a>, <a class="el" href="proto_8h.html#aeb05544fcefa17dff1e34bf3c65a0135">seed_glass()</a>, <a class="el" href="gravtree_8c_source.html#l00487">set_softenings()</a>, <a class="el" href="init_8c_source.html#l00199">setup_smoothinglengths()</a>, <a class="el" href="allvars_8h_source.html#l00357">global_data_all_processes::SnapshotFileCount</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00041">TIMEBASE</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="allvars_8h_source.html#l00370">global_data_all_processes::TimeBegin</a>, <a class="el" href="allvars_8h_source.html#l00362">global_data_all_processes::TimeBetStatistics</a>, <a class="el" href="allvars_8h_source.html#l00363">global_data_all_processes::TimeLastStatistics</a>, <a class="el" href="allvars_8h_source.html#l00372">global_data_all_processes::TimeMax</a>, <a class="el" href="allvars_8h_source.html#l00315">global_data_all_processes::TotNumOfForces</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00298">global_data_all_processes::TreeAllocFactor</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, <a class="el" href="allvars_8c_source.html#l00038">TreeReconstructFlag</a>, <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00563">sph_particle_data::VelPred</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j;
  <span class="keywordtype">double</span> a3;

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>;

  <span class="keywordflow">switch</span> (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a>)
    {
    <span class="keywordflow">case</span> 1:
<span class="preprocessor">#if (MAKEGLASS &gt; 1)</span>
<span class="preprocessor"></span>      <a class="code" href="proto_8h.html#aeb05544fcefa17dff1e34bf3c65a0135">seed_glass</a>();
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      <a class="code" href="proto_8h.html#a150344fdc0c6e132aecdb6c646529df1">read_ic</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adacd2b54a924bb4ce144afc1abbc6138">InitCondFile</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 2:
    <span class="keywordflow">case</span> 3:
      <a class="code" href="proto_8h.html#a150344fdc0c6e132aecdb6c646529df1">read_ic</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adacd2b54a924bb4ce144afc1abbc6138">InitCondFile</a>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;ICFormat=%d not supported.\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> = 0;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a> = (log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a>) - log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>)) / <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>;
      a3 = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a> = (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>) / <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>;
      a3 = 1;
    }

  <a class="code" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91">set_softenings</a>();

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a> = 0;     <span class="comment">/* setup some counters */</span>
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aac0d3fcbac688a31e6bda55ef819c44b">SnapshotFileCount</a> = 0;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 2)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aac0d3fcbac688a31e6bda55ef819c44b">SnapshotFileCount</a> = atoi(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adacd2b54a924bb4ce144afc1abbc6138">InitCondFile</a> + strlen(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adacd2b54a924bb4ce144afc1abbc6138">InitCondFile</a>) - 3) + 1;

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a44181b6f6375de86c7dda1059d2fc3f4">TotNumOfForces</a> = 0;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 0;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a52b027433ffad064869c606656e9bf7d">PeriodicBoundariesOn</a> == 1)
      <a class="code" href="init_8c.html#a1b96c5b41f1209ee91cd369f01a52352">check_omega</a>();

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab088f20e7889a88f2e0f652df4781e44">TimeLastStatistics</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a516be9ff5c4fd4171aa8e1a687e1e72d">TimeBetStatistics</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>) <span class="comment">/*  change to new velocity variable */</span>
    {
      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] *= sqrt(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)  <span class="comment">/*  start-up initialization */</span>
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] = 0;
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> = 0;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> = 0;

      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a5466aae28c06365368c9399c8f7cc02d">OldAcc</a> = 0;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a2f34828ae7803611a4e86bb201697317">GravCost</a> = 1;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> = 0;
    }

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef FLEXSTEPS</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.PresentMinStep = TIMEBASE;
  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)  <span class="comment">/*  start-up initialization */</span>
    {
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].FlexStepGrp = (int) (<a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> * <a class="code" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05">get_random_number</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#aefa92af245e44af30d28799ab1419e74">ID</a>));
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i++)    <span class="comment">/* initialize sph_properties */</span>
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a730acdc1da11f80da2214ebb76e6c2b3">VelPred</a>[j] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j];
          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j] = 0;
        }

      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> = 0;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 0)
        {
          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> = 0;
          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a> = -1;
        }
    }

  <a class="code" href="ngb_8c.html#a6f7a3b85f10701b9067f012cc9a30f55">ngb_treeallocate</a>(<a class="code" href="allvars_8h.html#a459bf1b27bb8a17c4496d2783e62161c">MAX_NGB</a>);

  <a class="code" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>);

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;

  <a class="code" href="allvars_8c.html#a6343a9f3619e77c1796309b8deda7f50">Flag_FullStep</a> = 1;            <span class="comment">/* to ensure that Peano-Hilber order is done */</span>

  <a class="code" href="domain_8c.html#ae8e3aa408eaab9544cb7f93e69185492">domain_Decomposition</a>();       <span class="comment">/* do initial domain decomposition (gives equal numbers of particles) */</span>

  <a class="code" href="ngb_8c.html#ac56af97a1dbbbbb07db8207246852f79">ngb_treebuild</a>();              <span class="comment">/* will build tree */</span>

  <a class="code" href="init_8c.html#abca44f066552d38c44a1cd6020d349d5">setup_smoothinglengths</a>();

  <a class="code" href="allvars_8c.html#aa32d7269f9baf3ffdbdd509982fca128">TreeReconstructFlag</a> = 1;

  <span class="comment">/* at this point, the entropy variable normally contains the </span>
<span class="comment">   * internal energy, read in from the initial conditions file, unless the file</span>
<span class="comment">   * explicitly signals that the initial conditions contain the entropy directly. </span>
<span class="comment">   * Once the density has been computed, we can convert thermal energy to entropy.</span>
<span class="comment">   */</span>
<span class="preprocessor">#ifndef ISOTHERM_EQS</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a448788ace72155e22d19af1c01917857">flag_entropy_instead_u</a> == 0)
    <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
      <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy = <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a> * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Density / a3, <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a2858154e2009b0e6e616f313177762bc_cgraph.png" border="0" usemap="#proto_8h_a2858154e2009b0e6e616f313177762bc_cgraph" alt=""/></div>
<map name="proto_8h_a2858154e2009b0e6e616f313177762bc_cgraph" id="proto_8h_a2858154e2009b0e6e616f313177762bc_cgraph">
<area shape="rect" id="node3" href="init_8c.html#a1b96c5b41f1209ee91cd369f01a52352" title="check_omega" alt="" coords="132,1005,241,1034"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="845,801,912,830"/><area shape="rect" id="node9" href="domain_8c.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="100,1692,273,1721"/><area shape="rect" id="node49" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="856,2004,901,2033"/><area shape="rect" id="node52" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="119,1058,255,1088"/><area shape="rect" id="node55" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="800,64,957,93"/><area shape="rect" id="node57" href="ngb_8c.html#a6f7a3b85f10701b9067f012cc9a30f55" title="ngb_treeallocate" alt="" coords="123,220,251,249"/><area shape="rect" id="node60" href="ngb_8c.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="132,153,241,182"/><area shape="rect" id="node73" href="proto_8h.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="153,876,220,905"/><area shape="rect" id="node111" href="proto_8h.html#aeb05544fcefa17dff1e34bf3c65a0135" title="seed_glass" alt="" coords="140,2132,233,2161"/><area shape="rect" id="node113" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91" title="set_softenings" alt="" coords="129,2185,244,2214"/><area shape="rect" id="node115" href="init_8c.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="97,1876,276,1905"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1005,801,1163,830"/><area shape="rect" id="node11" href="predict_8c.html#adda9e167a16a53d1aa40180406950446" title="do_box_wrapping" alt="" coords="336,1718,467,1748"/><area shape="rect" id="node13" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="325,1372,477,1401"/><area shape="rect" id="node37" href="peano_8c.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="327,1665,476,1694"/><area shape="rect" id="node45" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="605,1772,672,1801"/><area shape="rect" id="node47" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="604,1876,673,1905"/><area shape="rect" id="node15" href="domain_8c.html#a77c115c3aa2069d0eb8521329be0483c" title="domain_countToGo" alt="" coords="567,1268,711,1297"/><area shape="rect" id="node17" href="domain_8c.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="543,1398,735,1428"/><area shape="rect" id="node19" href="domain_8c.html#ab7d41435f73c1626208d63b2d5ba28ca" title="domain_exchangeParticles" alt="" coords="543,1161,735,1190"/><area shape="rect" id="node22" href="domain_8c.html#a0e758ec7eef32fc7180092547f5a11b9" title="domain_findExchangeNumbers" alt="" coords="528,1452,749,1481"/><area shape="rect" id="node24" href="domain_8c.html#add5620cbc133c73f0ce7da3a8fe9c01e" title="domain_findExtent" alt="" coords="568,1505,709,1534"/><area shape="rect" id="node26" href="domain_8c.html#a412d5d8810751249cc8dcd9e219e4e57" title="domain_findSplit" alt="" coords="575,1345,703,1374"/><area shape="rect" id="node31" href="domain_8c.html#a89c54187117b91d4270a4f0c406ce2ba" title="domain_shiftSplit" alt="" coords="573,1558,704,1588"/><area shape="rect" id="node34" href="domain_8c.html#a25aada0d3751c2afd2a376151d1d917e" title="domain_sumCost" alt="" coords="572,1214,705,1244"/><area shape="rect" id="node28" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="849,1452,908,1481"/><area shape="rect" id="node39" href="peano_8c.html#af3ffb253e14a79419d1effeee1b7261d" title="compare_key" alt="" coords="585,1665,692,1694"/><area shape="rect" id="node41" href="peano_8c.html#af744cef873e3093ba2924da8265d1711" title="reorder_gas" alt="" coords="589,1718,688,1748"/><area shape="rect" id="node43" href="peano_8c.html#afcb358154dd7fd5de8b4156f417fb0ba" title="reorder_particles" alt="" coords="573,1612,704,1641"/><area shape="rect" id="node62" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="343,141,460,170"/><area shape="rect" id="node64" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7" title="force_flag_localnodes" alt="" coords="560,62,717,92"/><area shape="rect" id="node66" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="559,116,719,145"/><area shape="rect" id="node70" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="532,169,745,198"/><area shape="rect" id="node75" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab" title="distribute_file" alt="" coords="348,796,455,825"/><area shape="rect" id="node79" href="io_8c.html#a10281a87abe1e07d6ca603de6a533345" title="fill_Tab_IO_Labels" alt="" coords="336,849,467,878"/><area shape="rect" id="node81" href="proto_8h.html#ac028b474d53a40e79377b7ae5dde636a" title="find_files" alt="" coords="363,902,440,932"/><area shape="rect" id="node86" href="proto_8h.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="364,617,439,646"/><area shape="rect" id="node84" href="proto_8h.html#af87c21a0c70ac5e7d5f769b952d08fe9" title="read_header_attributes_in_hdf5" alt="" coords="527,854,751,884"/><area shape="rect" id="node88" href="allocate_8c.html#a7fe5e304baaf5f418a22fef9a9cc02c7" title="allocate_memory" alt="" coords="572,748,705,777"/><area shape="rect" id="node91" href="io_8c.html#ad9c685a2d6d48224bfec61680ce82b1e" title="blockpresent" alt="" coords="587,484,691,513"/><area shape="rect" id="node93" href="proto_8h.html#a3757efb7e470353080a128388ccebec9" title="empty_read_buffer" alt="" coords="568,537,709,566"/><area shape="rect" id="node96" href="io_8c.html#a49492470fcccf9d05bf51993f281f16c" title="get_bytes_per_blockelement" alt="" coords="536,590,741,620"/><area shape="rect" id="node98" href="io_8c.html#a4d30ce1aad9c69d5af676a6a13173686" title="get_dataset_name" alt="" coords="568,324,709,353"/><area shape="rect" id="node100" href="io_8c.html#acdf59daa02f065452a596cf88b4de1a1" title="get_datatype_in_block" alt="" coords="556,377,721,406"/><area shape="rect" id="node102" href="io_8c.html#a5ce310b1efc19d96d530c1264fd5eca9" title="get_particles_in_block" alt="" coords="557,801,720,830"/><area shape="rect" id="node105" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f" title="get_values_per_blockelement" alt="" coords="533,430,744,460"/><area shape="rect" id="node107" href="io_8c.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="597,644,680,673"/><area shape="rect" id="node117" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="368,1876,435,1905"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a2858154e2009b0e6e616f313177762bc_icgraph.png" border="0" usemap="#proto_8h_a2858154e2009b0e6e616f313177762bc_icgraph" alt=""/></div>
<map name="proto_8h_a2858154e2009b0e6e616f313177762bc_icgraph" id="proto_8h_a2858154e2009b0e6e616f313177762bc_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="96,5,163,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="212,5,265,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aea1f81063199abb9d89802b444098018"></a><!-- doxytag: member="proto.h::init_drift_table" ref="aea1f81063199abb9d89802b444098018" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void init_drift_table </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes look-up tables for factors needed in cosmological integrations. The (simple) integrations are carried out with the GSL library. Separate factors are computed for the "drift", and the gravitational and hydrodynamical "kicks". The lookup-table is used for reasons of speed. </p>

<p><p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors</p>
<p>&lt; length of the lookup table used to hold the drift and kick factors </p>
</p>

<p>Definition at line <a class="el" href="driftfac_8c_source.html#l00026">26</a> of file <a class="el" href="driftfac_8c_source.html">driftfac.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8c_source.html#l00098">DriftTable</a>, <a class="el" href="allvars_8c_source.html#l00099">GravKickTable</a>, <a class="el" href="allvars_8c_source.html#l00100">HydroKickTable</a>, <a class="el" href="driftfac_8c_source.html#l00016">logTimeBegin</a>, <a class="el" href="driftfac_8c_source.html#l00017">logTimeMax</a>, <a class="el" href="allvars_8h_source.html#l00370">global_data_all_processes::TimeBegin</a>, <a class="el" href="allvars_8h_source.html#l00372">global_data_all_processes::TimeMax</a>, <a class="el" href="driftfac_8c.html#a2adb5d14857fdbea8ba352245450e52a">WORKSIZE</a>, and <a class="el" href="pm__periodic_8c_source.html#l00045">workspace</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
<span class="preprocessor">#define WORKSIZE 100000</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> i;
  <span class="keywordtype">double</span> result, abserr;
  gsl_function F;
  gsl_integration_workspace *<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>;

  <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> = log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>);
  <a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> = log(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a>);

  workspace = gsl_integration_workspace_alloc(WORKSIZE);

  <span class="keywordflow">for</span>(i = 0; i &lt; DRIFT_TABLE_LENGTH; i++)
    {
      F.function = &amp;drift_integ;
      gsl_integration_qag(&amp;F, exp(<a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>), exp(<a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + ((<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / DRIFT_TABLE_LENGTH) * (i + 1)), 0,
                          1.0e-8, WORKSIZE, GSL_INTEG_GAUSS41, workspace, &amp;result, &amp;abserr);
      <a class="code" href="allvars_8c.html#a074db1ef4adfe88a5f3b07eac8c1daae">DriftTable</a>[i] = result;


      F.function = &amp;gravkick_integ;
      gsl_integration_qag(&amp;F, exp(<a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>), exp(<a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + ((<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / DRIFT_TABLE_LENGTH) * (i + 1)), 0,
                          1.0e-8, WORKSIZE, GSL_INTEG_GAUSS41, workspace, &amp;result, &amp;abserr);
      <a class="code" href="allvars_8c.html#a38e5d8b595161f074f7fbede3a8fda66">GravKickTable</a>[i] = result;


      F.function = &amp;hydrokick_integ;
      gsl_integration_qag(&amp;F, exp(<a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>), exp(<a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a> + ((<a class="code" href="driftfac_8c.html#a0e08a12787034f570c56ff664de37e2a">logTimeMax</a> - <a class="code" href="driftfac_8c.html#adf1795a43a5fd6de0a14b805094dac47">logTimeBegin</a>) / DRIFT_TABLE_LENGTH) * (i + 1)), 0,
                          1.0e-8, WORKSIZE, GSL_INTEG_GAUSS41, workspace, &amp;result, &amp;abserr);
      <a class="code" href="allvars_8c.html#a274a5737d1578d54d6f82130e3064771">HydroKickTable</a>[i] = result;
    }

  gsl_integration_workspace_free(workspace);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aea1f81063199abb9d89802b444098018_icgraph.png" border="0" usemap="#proto_8h_aea1f81063199abb9d89802b444098018_icgraph" alt=""/></div>
<map name="proto_8h_aea1f81063199abb9d89802b444098018_icgraph" id="proto_8h_aea1f81063199abb9d89802b444098018_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="165,5,232,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="281,5,335,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5052a0489feb425d7d910e57d7ad8102"></a><!-- doxytag: member="proto.h::init_peano_map" ref="a5052a0489feb425d7d910e57d7ad8102" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void init_peano_map </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a5989a3f57c7d6dfdef205dc6b72a1d25"></a><!-- doxytag: member="proto.h::long_range_force" ref="a5989a3f57c7d6dfdef205dc6b72a1d25" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void long_range_force </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is a driver routine for the long-range PM force computation. It calls periodic and/or non-periodic FFT routines as needed for the present simulation set-up. </p>

<p>Definition at line <a class="el" href="longrange_8c_source.html#l00056">56</a> of file <a class="el" href="longrange_8c_source.html">longrange.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize()</a>, <a class="el" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel()</a>, <a class="el" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic()</a>, and <a class="el" href="pm__periodic_8c_source.html#l00180">pmforce_periodic()</a>.</p>

<p>Referenced by <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;

<span class="preprocessor">#ifndef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> j;
  <span class="keywordtype">double</span> fac;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[0] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[1] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[2] = 0;

<span class="preprocessor">#ifdef NOGRAVITY</span>
<span class="preprocessor"></span>  <span class="keywordflow">return</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <a class="code" href="pm__periodic_8c.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b">pmforce_periodic</a>();
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic</a>(1);
  <span class="keywordflow">if</span>(i == 1)                    <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
    {
      <a class="code" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a>();
      <a class="code" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel</a>();
      i = <a class="code" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic</a>(1);       <span class="comment">/* try again */</span>
    }
  <span class="keywordflow">if</span>(i == 1)
    <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(68686);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic</a>(0);
  <span class="keywordflow">if</span>(i == 1)                    <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
    {
      <a class="code" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a>();
      <a class="code" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel</a>();
      i = <a class="code" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic</a>(0);       <span class="comment">/* try again */</span>
    }
  <span class="keywordflow">if</span>(i == 1)
    <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(68687);
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic</a>(1);
  <span class="keywordflow">if</span>(i == 1)                    <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
    {
      <a class="code" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a>();
      <a class="code" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel</a>();

      <span class="comment">/* try again */</span>

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[0] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[1] = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[2] = 0;

      i = <a class="code" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic</a>(0) + <a class="code" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc">pmforce_nonperiodic</a>(1);
    }
  <span class="keywordflow">if</span>(i != 0)
    <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(68688);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="preprocessor">#ifndef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      fac = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] += fac * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
    }


  <span class="comment">/* Finally, the following factor allows a computation of cosmological simulation </span>
<span class="comment">     with vacuum energy in physical coordinates */</span>

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a> == 0)
    {
      fac = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>;

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j] += fac * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a5989a3f57c7d6dfdef205dc6b72a1d25_cgraph.png" border="0" usemap="#proto_8h_a5989a3f57c7d6dfdef205dc6b72a1d25_cgraph" alt=""/></div>
<map name="proto_8h_a5989a3f57c7d6dfdef205dc6b72a1d25_cgraph" id="proto_8h_a5989a3f57c7d6dfdef205dc6b72a1d25_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="680,90,747,119"/><area shape="rect" id="node7" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97" title="pm_init_regionsize" alt="" coords="223,36,364,66"/><area shape="rect" id="node9" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4" title="pm_setup_nonperiodic_kernel" alt="" coords="187,90,400,119"/><area shape="rect" id="node11" href="proto_8h.html#a8821224474d8690f0db99b8cfab3a8fc" title="pmforce_nonperiodic" alt="" coords="216,143,371,172"/><area shape="rect" id="node13" href="pm__periodic_8c.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="228,196,359,226"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="795,90,952,119"/><area shape="rect" id="node15" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="472,90,608,119"/><area shape="rect" id="node18" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888" title="force_treefree" alt="" coords="484,143,596,172"/><area shape="rect" id="node20" href="pm__periodic_8c.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="449,196,631,226"/><area shape="rect" id="node25" href="pm__periodic_8c.html#a259e6f8400ee889c64bc667334060742" title="pm_init_periodic_free" alt="" coords="461,250,619,279"/><area shape="rect" id="node23" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10" title="imax" alt="" coords="687,196,740,226"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a5989a3f57c7d6dfdef205dc6b72a1d25_icgraph.png" border="0" usemap="#proto_8h_a5989a3f57c7d6dfdef205dc6b72a1d25_icgraph" alt=""/></div>
<map name="proto_8h_a5989a3f57c7d6dfdef205dc6b72a1d25_icgraph" id="proto_8h_a5989a3f57c7d6dfdef205dc6b72a1d25_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="187,5,357,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="405,5,448,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="497,5,551,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af52079f2c63002aca9463ba0b13727df"></a><!-- doxytag: member="proto.h::long_range_init" ref="af52079f2c63002aca9463ba0b13727df" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void long_range_init </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Calls initializiation routines of periodic or/and non-periodic FFT routines. </p>

<p>Definition at line <a class="el" href="longrange_8c_source.html#l00020">20</a> of file <a class="el" href="longrange_8c_source.html">longrange.c</a>.</p>

<p>References <a class="el" href="proto_8h.html#a0784ca56372f6ce3cf46e8b6623e4ea0">pm_init_nonperiodic()</a>, and <a class="el" href="pm__periodic_8c_source.html#l00055">pm_init_periodic()</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <a class="code" href="pm__periodic_8c.html#a13e381f05efdb739cf5026384e908409">pm_init_periodic</a>();
<span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  <a class="code" href="proto_8h.html#a0784ca56372f6ce3cf46e8b6623e4ea0">pm_init_nonperiodic</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <a class="code" href="proto_8h.html#a0784ca56372f6ce3cf46e8b6623e4ea0">pm_init_nonperiodic</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af52079f2c63002aca9463ba0b13727df_cgraph.png" border="0" usemap="#proto_8h_af52079f2c63002aca9463ba0b13727df_cgraph" alt=""/></div>
<map name="proto_8h_af52079f2c63002aca9463ba0b13727df_cgraph" id="proto_8h_af52079f2c63002aca9463ba0b13727df_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a0784ca56372f6ce3cf46e8b6623e4ea0" title="pm_init_nonperiodic" alt="" coords="175,5,324,35"/><area shape="rect" id="node5" href="pm__periodic_8c.html#a13e381f05efdb739cf5026384e908409" title="pm_init_periodic" alt="" coords="187,59,312,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af52079f2c63002aca9463ba0b13727df_icgraph.png" border="0" usemap="#proto_8h_af52079f2c63002aca9463ba0b13727df_icgraph" alt=""/></div>
<map name="proto_8h_af52079f2c63002aca9463ba0b13727df_icgraph" id="proto_8h_af52079f2c63002aca9463ba0b13727df_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="173,5,240,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="289,5,343,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad295b3023b3d8fad337637a640362262"></a><!-- doxytag: member="proto.h::long_range_init_regionsize" ref="ad295b3023b3d8fad337637a640362262" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void long_range_init_regionsize </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function calls subroutines that determine the spatial region covered by the PM mesh. </p>

<p>Definition at line <a class="el" href="longrange_8c_source.html#l00036">36</a> of file <a class="el" href="longrange_8c_source.html">longrange.c</a>.</p>

<p>References <a class="el" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize()</a>, <a class="el" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel()</a>, and <a class="el" href="allvars_8c_source.html#l00030">RestartFlag</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> != 1)
    <a class="code" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a>();
  <a class="code" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> != 1)
    <a class="code" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97">pm_init_regionsize</a>();
  <a class="code" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4">pm_setup_nonperiodic_kernel</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad295b3023b3d8fad337637a640362262_cgraph.png" border="0" usemap="#proto_8h_ad295b3023b3d8fad337637a640362262_cgraph" alt=""/></div>
<map name="proto_8h_ad295b3023b3d8fad337637a640362262_cgraph" id="proto_8h_ad295b3023b3d8fad337637a640362262_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97" title="pm_init_regionsize" alt="" coords="281,5,423,35"/><area shape="rect" id="node5" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4" title="pm_setup_nonperiodic_kernel" alt="" coords="245,59,459,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad295b3023b3d8fad337637a640362262_icgraph.png" border="0" usemap="#proto_8h_ad295b3023b3d8fad337637a640362262_icgraph" alt=""/></div>
<map name="proto_8h_ad295b3023b3d8fad337637a640362262_icgraph" id="proto_8h_ad295b3023b3d8fad337637a640362262_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="245,5,312,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="361,5,415,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a02a8a27a7a75ce5cd6c2a27b4d641e31"></a><!-- doxytag: member="proto.h::move_particles" ref="a02a8a27a7a75ce5cd6c2a27b4d641e31" args="(int time0, int time1)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void move_particles </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>time0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>time1</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function drifts all particles from the current time to the future: time0 - &gt; time1</p>
<p>If there is no explicit tree construction in the following timestep, the tree nodes are also drifted and updated accordingly. Note: For periodic boundary conditions, the mapping of coordinates onto the interval [0,All.BoxSize] is only done before the domain decomposition, or for outputs to snapshot files. This simplifies dynamic tree updates, and allows the domain decomposition to be carried out only every once in a while. </p>

<p><p>&lt; adiabatic index of simulated gas </p>
</p>

<p>Definition at line <a class="el" href="predict_8c_source.html#l00031">31</a> of file <a class="el" href="predict_8c_source.html">predict.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00420">global_data_all_processes::CPU_Predict</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8h_source.html#l00555">sph_particle_data::Density</a>, <a class="el" href="allvars_8h_source.html#l00561">sph_particle_data::DtEntropy</a>, <a class="el" href="allvars_8h_source.html#l00554">sph_particle_data::Entropy</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="forcetree_8c_source.html#l00885">force_update_len()</a>, <a class="el" href="forcetree_8c_source.html#l00671">force_update_pseudoparticles()</a>, <a class="el" href="allvars_8h_source.html#l00068">GAMMA</a>, <a class="el" href="driftfac_8c_source.html#l00067">get_drift_factor()</a>, <a class="el" href="driftfac_8c_source.html#l00105">get_gravkick_factor()</a>, <a class="el" href="driftfac_8c_source.html#l00142">get_hydrokick_factor()</a>, <a class="el" href="allvars_8h_source.html#l00516">particle_data::GravAccel</a>, <a class="el" href="allvars_8h_source.html#l00518">particle_data::GravPM</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00562">sph_particle_data::HydroAccel</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00460">global_data_all_processes::MinGasHsml</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00140">Numnodestree</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8h_source.html#l00560">sph_particle_data::Pressure</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>, <a class="el" href="allvars_8h_source.html#l00515">particle_data::Vel</a>, and <a class="el" href="allvars_8h_source.html#l00619">extNODE::vs</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, j;
  <span class="keywordtype">double</span> dt_drift, dt_gravkick, dt_hydrokick, dt_entr;
  <span class="keywordtype">double</span> t0, t1;


  t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      dt_drift = <a class="code" href="driftfac_8c.html#adadb384299eb936596574417d4b6b28c">get_drift_factor</a>(time0, time1);
      dt_gravkick = <a class="code" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059">get_gravkick_factor</a>(time0, time1);
      dt_hydrokick = <a class="code" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c">get_hydrokick_factor</a>(time0, time1);
    }
  <span class="keywordflow">else</span>
    {
      dt_drift = dt_gravkick = dt_hydrokick = (time1 - time0) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ad7808af1e23fbd920d7eb477bc68bd00">Vel</a>[j] * dt_drift;

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a> == 0)
        {
<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].VelPred[j] +=
              (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[j]) * dt_gravkick + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aa3441b1ee8351048b3dcac10b36b0b6c">HydroAccel</a>[j] * dt_hydrokick;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].VelPred[j] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a601ab390c85cd05a5c965e3353d403f3">GravAccel</a>[j] * dt_gravkick + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].HydroAccel[j] * dt_hydrokick;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#aaeca7f3efec44ebd5b7d36ce79d38779">Density</a> *= exp(-<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].DivVel * dt_drift);
          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> *= exp(0.333333333333 * <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].DivVel * dt_drift);

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Hsml &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aec92c94dd2a1d0f0e1ad56f2e790384a">MinGasHsml</a>)
            <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aec92c94dd2a1d0f0e1ad56f2e790384a">MinGasHsml</a>;

          dt_entr = (time1 - (<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a9201a97de5fe06f6ed6fcc33386eccda">Pressure</a> = (<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> + <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a27aeefa50674867d3dec1c359b7191c8">DtEntropy</a> * dt_entr) * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Density, <a class="code" href="allvars_8h.html#a8659b9de3e544ff142b153b076f30fd5">GAMMA</a>);
        }
    }

  <span class="comment">/* if domain-decomp and tree are not going to be reconstructed, update dynamically.  */</span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>)
    {
      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a>; i++)
        <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
          <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + i].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.s[j] += <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + i].<a class="code" href="structextNODE.html#a8fe64edf0e8598f60ff0ba73a04261bb">vs</a>[j] * dt_drift;

      <a class="code" href="forcetree_8c.html#a04fb647ef783d5baeb9275d806c08365">force_update_len</a>();

      <a class="code" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0">force_update_pseudoparticles</a>();
    }

  t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#afb9d30620ea0dc8b9e46000e3ce0b3e3">CPU_Predict</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a02a8a27a7a75ce5cd6c2a27b4d641e31_cgraph.png" border="0" usemap="#proto_8h_a02a8a27a7a75ce5cd6c2a27b4d641e31_cgraph" alt=""/></div>
<map name="proto_8h_a02a8a27a7a75ce5cd6c2a27b4d641e31_cgraph" id="proto_8h_a02a8a27a7a75ce5cd6c2a27b4d641e31_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a04fb647ef783d5baeb9275d806c08365" title="force_update_len" alt="" coords="216,59,347,88"/><area shape="rect" id="node9" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="175,112,388,141"/><area shape="rect" id="node15" href="driftfac_8c.html#adadb384299eb936596574417d4b6b28c" title="get_drift_factor" alt="" coords="223,165,340,195"/><area shape="rect" id="node17" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="208,219,355,248"/><area shape="rect" id="node19" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="204,272,359,301"/><area shape="rect" id="node21" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="528,376,573,405"/><area shape="rect" id="node23" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="248,376,315,405"/><area shape="rect" id="node25" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="247,429,316,459"/><area shape="rect" id="node5" href="forcetree_8c.html#a4592b750f8555f580691103acf1e5366" title="force_update_node_len_local" alt="" coords="448,5,653,35"/><area shape="rect" id="node7" href="forcetree_8c.html#a5f85438d619d63c812c8e05faf1f0074" title="force_update_node_len_toptree" alt="" coords="439,59,663,88"/><area shape="rect" id="node11" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb" title="force_exchange_pseudodata" alt="" coords="448,112,653,141"/><area shape="rect" id="node13" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19" title="force_treeupdate_pseudos" alt="" coords="455,165,647,195"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a02a8a27a7a75ce5cd6c2a27b4d641e31_icgraph.png" border="0" usemap="#proto_8h_a02a8a27a7a75ce5cd6c2a27b4d641e31_icgraph" alt=""/></div>
<map name="proto_8h_a02a8a27a7a75ce5cd6c2a27b4d641e31_icgraph" id="proto_8h_a02a8a27a7a75ce5cd6c2a27b4d641e31_icgraph">
<area shape="rect" id="node3" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="173,5,392,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="440,5,483,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="532,5,585,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a1609620c03f6b0068601735c42e3c660"></a><!-- doxytag: member="proto.h::my_fread" ref="a1609620c03f6b0068601735c42e3c660" args="(void *ptr, size_t size, size_t nmemb, FILE *stream)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t my_fread </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>nmemb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>stream</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This catches I/O errors occuring for fread(). In this case we better stop. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l01139">1139</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="restart_8c_source.html#l00289">byten()</a>, <a class="el" href="forcetree_8c_source.html#l03079">ewald_init()</a>, <a class="el" href="restart_8c_source.html#l00300">in()</a>, and <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">size_t</span> nread;

  <span class="keywordflow">if</span>((nread = fread(ptr, size, nmemb, stream)) != nmemb)
    {
      printf(<span class="stringliteral">&quot;I/O error (fread) on task=%d has occured: %s\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, strerror(errno));
      fflush(stdout);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(778);
    }
  <span class="keywordflow">return</span> nread;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a1609620c03f6b0068601735c42e3c660_cgraph.png" border="0" usemap="#proto_8h_a1609620c03f6b0068601735c42e3c660_cgraph" alt=""/></div>
<map name="proto_8h_a1609620c03f6b0068601735c42e3c660_cgraph" id="proto_8h_a1609620c03f6b0068601735c42e3c660_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="136,5,203,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="251,5,408,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a1609620c03f6b0068601735c42e3c660_icgraph.png" border="0" usemap="#proto_8h_a1609620c03f6b0068601735c42e3c660_icgraph" alt=""/></div>
<map name="proto_8h_a1609620c03f6b0068601735c42e3c660_icgraph" id="proto_8h_a1609620c03f6b0068601735c42e3c660_icgraph">
<area shape="rect" id="node3" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21" title="byten" alt="" coords="145,5,204,35"/><area shape="rect" id="node14" href="proto_8h.html#a47f99270d9b0b0f75d86b3b9d078dff6" title="ewald_init" alt="" coords="380,111,463,140"/><area shape="rect" id="node17" href="restart_8c.html#a2f4631df8dbc2cc10c5d7ce28c975ad5" title="in" alt="" coords="156,59,193,88"/><area shape="rect" id="node20" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="137,164,212,193"/><area shape="rect" id="node5" href="restart_8c.html#ae81d30f52dddd39aef76bb1890d16f2f" title="restart" alt="" coords="264,33,328,63"/><area shape="rect" id="node7" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="512,99,579,128"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="524,21,567,51"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="628,60,681,89"/><area shape="rect" id="node22" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="263,164,329,193"/><area shape="rect" id="node24" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="401,164,441,193"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aab1e6568bf14b3a23c66f70c94aabd21"></a><!-- doxytag: member="proto.h::my_fwrite" ref="aab1e6568bf14b3a23c66f70c94aabd21" args="(void *ptr, size_t size, size_t nmemb, FILE *stream)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t my_fwrite </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>nmemb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>stream</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This catches I/O errors occuring for <a class="el" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite()</a>. In this case we better stop. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l01122">1122</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="restart_8c_source.html#l00289">byten()</a>, <a class="el" href="forcetree_8c_source.html#l03040">dump_particles()</a>, <a class="el" href="forcetree_8c_source.html#l03079">ewald_init()</a>, <a class="el" href="restart_8c_source.html#l00300">in()</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">size_t</span> nwritten;

  <span class="keywordflow">if</span>((nwritten = fwrite(ptr, size, nmemb, stream)) != nmemb)
    {
      printf(<span class="stringliteral">&quot;I/O error (fwrite) on task=%d has occured: %s\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, strerror(errno));
      fflush(stdout);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(777);
    }
  <span class="keywordflow">return</span> nwritten;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aab1e6568bf14b3a23c66f70c94aabd21_cgraph.png" border="0" usemap="#proto_8h_aab1e6568bf14b3a23c66f70c94aabd21_cgraph" alt=""/></div>
<map name="proto_8h_aab1e6568bf14b3a23c66f70c94aabd21_cgraph" id="proto_8h_aab1e6568bf14b3a23c66f70c94aabd21_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="136,5,203,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="251,5,408,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aab1e6568bf14b3a23c66f70c94aabd21_icgraph.png" border="0" usemap="#proto_8h_aab1e6568bf14b3a23c66f70c94aabd21_icgraph" alt=""/></div>
<map name="proto_8h_aab1e6568bf14b3a23c66f70c94aabd21_icgraph" id="proto_8h_aab1e6568bf14b3a23c66f70c94aabd21_icgraph">
<area shape="rect" id="node3" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21" title="byten" alt="" coords="167,149,225,179"/><area shape="rect" id="node14" href="proto_8h.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="136,253,256,283"/><area shape="rect" id="node40" href="proto_8h.html#a47f99270d9b0b0f75d86b3b9d078dff6" title="ewald_init" alt="" coords="777,8,860,37"/><area shape="rect" id="node43" href="restart_8c.html#a2f4631df8dbc2cc10c5d7ce28c975ad5" title="in" alt="" coords="384,97,421,127"/><area shape="rect" id="node46" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="364,201,441,231"/><area shape="rect" id="node5" href="restart_8c.html#ae81d30f52dddd39aef76bb1890d16f2f" title="restart" alt="" coords="599,104,663,133"/><area shape="rect" id="node7" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1384,112,1451,141"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1396,241,1439,271"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1500,164,1553,193"/><area shape="rect" id="node16" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="305,329,500,359"/><area shape="rect" id="node19" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="551,281,711,311"/><area shape="rect" id="node21" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="760,281,877,311"/><area shape="rect" id="node23" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="927,281,1068,311"/><area shape="rect" id="node29" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="948,359,1047,388"/><area shape="rect" id="node34" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="943,163,1052,192"/><area shape="rect" id="node25" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="1117,267,1336,296"/><area shape="rect" id="node31" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="1141,371,1312,400"/><area shape="rect" id="node36" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1207,163,1247,192"/><area shape="rect" id="node48" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="943,216,1052,245"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a72ee1196e73c7c6e8683d35e4692d840"></a><!-- doxytag: member="proto.h::ngb_clear_buf" ref="a72ee1196e73c7c6e8683d35e4692d840" args="(float searchcenter[3], float hguess, int numngb)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ngb_clear_buf </td>
          <td>(</td>
          <td class="paramtype">float&nbsp;</td>
          <td class="paramname"> <em>searchcenter</em>[3], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&nbsp;</td>
          <td class="paramname"> <em>hsml</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>numngb</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The buffer for the neighbour list has a finite length MAX_NGB. For a large search region, this buffer can get full, in which case this routine can be called to eliminate some of the superfluous particles in the "corners" of the search box - only the ones in the inscribed sphere need to be kept. </p>

<p>Definition at line <a class="el" href="ngb_8c_source.html#l00320">320</a> of file <a class="el" href="ngb_8c_source.html">ngb.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="ngb_8c_source.html#l00047">NGB_PERIODIC_X</a>, <a class="el" href="ngb_8c_source.html#l00048">NGB_PERIODIC_Y</a>, <a class="el" href="ngb_8c_source.html#l00049">NGB_PERIODIC_Z</a>, <a class="el" href="allvars_8c_source.html#l00036">Ngblist</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>.</p>

<p>Referenced by <a class="el" href="ngb_8c_source.html#l00194">ngb_treefind_variable()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, p;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> dx, dy, dz, r2;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> xtmp;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">for</span>(i = 0; i &lt; numngb; i++)
    {
      p = <a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a>[i];
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>      dx = <a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - searchcenter[0]);
      dy = <a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - searchcenter[1]);
      dz = <a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - searchcenter[2]);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      dx = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - searchcenter[0];
      dy = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - searchcenter[1];
      dz = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - searchcenter[2];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;

      <span class="keywordflow">if</span>(r2 &gt; hsml * hsml)
        {
          <a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a>[i] = <a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a>[numngb - 1];
          i--;
          numngb--;
        }
    }

  <span class="keywordflow">return</span> numngb;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a72ee1196e73c7c6e8683d35e4692d840_icgraph.png" border="0" usemap="#proto_8h_a72ee1196e73c7c6e8683d35e4692d840_icgraph" alt=""/></div>
<map name="proto_8h_a72ee1196e73c7c6e8683d35e4692d840_icgraph" id="proto_8h_a72ee1196e73c7c6e8683d35e4692d840_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a008284f92570d4d1fa6e3dadb5902cf8" title="ngb_treefind_variable" alt="" coords="167,32,324,61"/><area shape="rect" id="node5" href="proto_8h.html#a19f7a07621c698ae894f53836e9ff03c" title="density_evaluate" alt="" coords="373,32,504,61"/><area shape="rect" id="node7" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="553,32,620,61"/><area shape="rect" id="node9" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="675,5,845,35"/><area shape="rect" id="node15" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="671,59,849,88"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1001,5,1044,35"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1105,32,1159,61"/><area shape="rect" id="node17" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="900,59,940,88"/><area shape="rect" id="node19" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="989,59,1056,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a6f7a3b85f10701b9067f012cc9a30f55"></a><!-- doxytag: member="proto.h::ngb_treeallocate" ref="a6f7a3b85f10701b9067f012cc9a30f55" args="(int npart)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ngb_treeallocate </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>npart</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Allocates memory for the neighbour list buffer. </p>

<p>Definition at line <a class="el" href="ngb_8c_source.html#l00358">358</a> of file <a class="el" href="ngb_8c_source.html">ngb.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="ngb_8c_source.html#l00020">boxHalf</a>, <a class="el" href="ngb_8c_source.html#l00026">boxHalf_X</a>, <a class="el" href="ngb_8c_source.html#l00032">boxHalf_Y</a>, <a class="el" href="ngb_8c_source.html#l00038">boxHalf_Z</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="ngb_8c_source.html#l00020">boxSize</a>, <a class="el" href="ngb_8c_source.html#l00025">boxSize_X</a>, <a class="el" href="ngb_8c_source.html#l00031">boxSize_Y</a>, <a class="el" href="ngb_8c_source.html#l00037">boxSize_Z</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00036">Ngblist</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l00020">init()</a>, and <a class="el" href="restart_8c_source.html#l00035">restart()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> totbytes = 0;
  <span class="keywordtype">size_t</span> bytes;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <a class="code" href="ngb_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  <a class="code" href="ngb_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> = 0.5 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
<span class="preprocessor">#ifdef LONG_X</span>
<span class="preprocessor"></span>  <a class="code" href="ngb_8c.html#a0ecceb71797a529fb6f2b8c47b51686c">boxHalf_X</a> = <a class="code" href="ngb_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_X;
  <a class="code" href="ngb_8c.html#a5c5328b307b005e6682669279878cef0">boxSize_X</a> = <a class="code" href="ngb_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_X;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
<span class="preprocessor"></span>  <a class="code" href="ngb_8c.html#a59f20d7decc2bdfedcaafb70ef23df0e">boxHalf_Y</a> = <a class="code" href="ngb_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_Y;
  <a class="code" href="ngb_8c.html#ab0db73a31e08d33d840e28651e3cf610">boxSize_Y</a> = <a class="code" href="ngb_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_Y;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
<span class="preprocessor"></span>  <a class="code" href="ngb_8c.html#a34e9d5d079320cbfc0576d26f58d2fe7">boxHalf_Z</a> = <a class="code" href="ngb_8c.html#af62571c97dc75a691aeafead0528b369">boxHalf</a> * LONG_Z;
  <a class="code" href="ngb_8c.html#a8a97a1c456bdd396791c84c370f0aa18">boxSize_Z</a> = <a class="code" href="ngb_8c.html#ac9067960018a06b81c117434c01f19cc">boxSize</a> * LONG_Z;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a> = malloc(bytes = npart * (<span class="keywordtype">long</span>) <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))))
    {
      printf(<span class="stringliteral">&quot;Failed to allocate %g MB for ngblist array\n&quot;</span>, bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(78);
    }
  totbytes += bytes;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;allocated %g Mbyte for ngb search.\n&quot;</span>, totbytes / (1024.0 * 1024.0));
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a6f7a3b85f10701b9067f012cc9a30f55_cgraph.png" border="0" usemap="#proto_8h_a6f7a3b85f10701b9067f012cc9a30f55_cgraph" alt=""/></div>
<map name="proto_8h_a6f7a3b85f10701b9067f012cc9a30f55_cgraph" id="proto_8h_a6f7a3b85f10701b9067f012cc9a30f55_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="184,5,251,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="299,5,456,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a6f7a3b85f10701b9067f012cc9a30f55_icgraph.png" border="0" usemap="#proto_8h_a6f7a3b85f10701b9067f012cc9a30f55_icgraph" alt=""/></div>
<map name="proto_8h_a6f7a3b85f10701b9067f012cc9a30f55_icgraph" id="proto_8h_a6f7a3b85f10701b9067f012cc9a30f55_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="197,5,237,35"/><area shape="rect" id="node9" href="restart_8c.html#ae81d30f52dddd39aef76bb1890d16f2f" title="restart" alt="" coords="185,59,249,88"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="299,5,365,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="415,32,468,61"/><area shape="rect" id="node12" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="311,59,353,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac56af97a1dbbbbb07db8207246852f79"></a><!-- doxytag: member="proto.h::ngb_treebuild" ref="ac56af97a1dbbbbb07db8207246852f79" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ngb_treebuild </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function constructs the neighbour tree. To this end, we actually need to construct the gravitational tree, because we use it now for the neighbour search. </p>

<p>Definition at line <a class="el" href="ngb_8c_source.html#l00403">403</a> of file <a class="el" href="ngb_8c_source.html">ngb.c</a>.</p>

<p>References <a class="el" href="forcetree_8c_source.html#l00061">force_treebuild()</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l00020">init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;Begin Ngb-tree construction.\n&quot;</span>);

  <a class="code" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5">force_treebuild</a>(<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>);

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;Ngb-Tree contruction finished \n&quot;</span>);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ac56af97a1dbbbbb07db8207246852f79_cgraph.png" border="0" usemap="#proto_8h_ac56af97a1dbbbbb07db8207246852f79_cgraph" alt=""/></div>
<map name="proto_8h_ac56af97a1dbbbbb07db8207246852f79_cgraph" id="proto_8h_ac56af97a1dbbbbb07db8207246852f79_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="163,224,280,253"/><area shape="rect" id="node5" href="forcetree_8c.html#a947a734f3bbba14d4092c7480880d3c7" title="force_flag_localnodes" alt="" coords="357,171,515,200"/><area shape="rect" id="node7" href="forcetree_8c.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="356,224,516,253"/><area shape="rect" id="node34" href="forcetree_8c.html#af9a7e3a922557e089da5d7ee1dde89a0" title="force_update_pseudoparticles" alt="" coords="329,416,543,445"/><area shape="rect" id="node9" href="forcetree_8c.html#ab303b92c6d6b4144999c5cebabd65ec0" title="dump_particles" alt="" coords="860,208,980,237"/><area shape="rect" id="node13" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="1299,235,1365,264"/><area shape="rect" id="node18" href="forcetree_8c.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="600,261,795,291"/><area shape="rect" id="node23" href="peano_8c.html#a9eec17b80ae63eb79e98064f2d4f25df" title="peano_hilbert_key" alt="" coords="851,312,989,341"/><area shape="rect" id="node25" href="forcetree_8c.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="1039,337,1249,367"/><area shape="rect" id="node28" href="forcetree_8c.html#ab745c54c805d07ad255a3f86ff77e18d" title="force_update_node_recursive" alt="" coords="592,29,803,59"/><area shape="rect" id="node31" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="619,83,776,112"/><area shape="rect" id="node11" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="1103,208,1185,237"/><area shape="rect" id="node15" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="1413,235,1571,264"/><area shape="rect" id="node36" href="forcetree_8c.html#aaabf16b5e99c9ac6bc6bbe039756bddb" title="force_exchange_pseudodata" alt="" coords="595,469,800,499"/><area shape="rect" id="node38" href="forcetree_8c.html#ab8e5d4fed349d96c6d4f55897473ce19" title="force_treeupdate_pseudos" alt="" coords="601,416,793,445"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ac56af97a1dbbbbb07db8207246852f79_icgraph.png" border="0" usemap="#proto_8h_ac56af97a1dbbbbb07db8207246852f79_icgraph" alt=""/></div>
<map name="proto_8h_ac56af97a1dbbbbb07db8207246852f79_icgraph" id="proto_8h_ac56af97a1dbbbbb07db8207246852f79_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="164,5,204,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="253,5,320,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="369,5,423,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a96ec7acfa3c046abc6902ca77ee4bddd"></a><!-- doxytag: member="proto.h::ngb_treefind_pairs" ref="a96ec7acfa3c046abc6902ca77ee4bddd" args="(float searchcenter[3], float hsml, int *startnode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ngb_treefind_pairs </td>
          <td>(</td>
          <td class="paramtype">float&nbsp;</td>
          <td class="paramname"> <em>searchcenter</em>[3], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&nbsp;</td>
          <td class="paramname"> <em>hsml</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>startnode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine finds all neighbours `j' that can interact with the particle `i' in the communication buffer.</p>
<p>Note that an interaction can take place if <img class="formulaInl" alt="$ r_{ij} < h_i $" src="form_12.png"/> OR if <img class="formulaInl" alt="$ r_{ij} < h_j $" src="form_13.png"/>.</p>
<p>In the range-search this is taken into account, i.e. it is guaranteed that all particles are found that fulfil this condition, including the (more difficult) second part of it. For this purpose, each node knows the maximum h occuring among the particles it represents. </p>

<p><p>&lt; defines maximum length of neighbour list </p>
</p>

<p>Definition at line <a class="el" href="ngb_8c_source.html#l00064">64</a> of file <a class="el" href="ngb_8c_source.html">ngb.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00618">extNODE::hmax</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8h_source.html#l00107">MAX_NGB</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="ngb_8c_source.html#l00047">NGB_PERIODIC_X</a>, <a class="el" href="ngb_8c_source.html#l00048">NGB_PERIODIC_Y</a>, <a class="el" href="ngb_8c_source.html#l00049">NGB_PERIODIC_Z</a>, <a class="el" href="allvars_8c_source.html#l00036">Ngblist</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="hydra_8c_source.html#l00353">hydro_evaluate()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> k, no, p, numngb;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> hdiff;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> searchmin[3], searchmax[3];
  <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *<span class="keyword">this</span>;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> xtmp;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)        <span class="comment">/* cube-box window */</span>
    {
      searchmin[k] = searchcenter[k] - hsml;
      searchmax[k] = searchcenter[k] + hsml;
    }

  numngb = 0;
  no = *startnode;

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)      <span class="comment">/* single particle */</span>
        {
          p = no;
          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Type &gt; 0)
            <span class="keywordflow">continue</span>;

          hdiff = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[p].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> - hsml;
          <span class="keywordflow">if</span>(hdiff &lt; 0)
            hdiff = 0;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0] - searchcenter[0]) &lt; (-hsml - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0] - searchcenter[0]) &gt; (hsml + hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1] - searchcenter[1]) &lt; (-hsml - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1] - searchcenter[1]) &gt; (hsml + hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2] - searchcenter[2]) &lt; (-hsml - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2] - searchcenter[2]) &gt; (hsml + hdiff))
            <span class="keywordflow">continue</span>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0] &lt; (searchmin[0] - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0] &gt; (searchmax[0] + hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1] &lt; (searchmin[1] - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1] &gt; (searchmax[1] + hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2] &lt; (searchmin[2] - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2] &gt; (searchmax[2] + hdiff))
            <span class="keywordflow">continue</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a>[numngb++] = p;

          <span class="keywordflow">if</span>(numngb == <a class="code" href="allvars_8h.html#a459bf1b27bb8a17c4496d2783e62161c">MAX_NGB</a>)
            {
              printf
                (<span class="stringliteral">&quot;ThisTask=%d: Need to do a second neighbour loop in hydro-force for (%g|%g|%g) hsml=%g no=%d\n&quot;</span>,
                 <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, searchcenter[0], searchcenter[1], searchcenter[2], hsml, no);
              *startnode = no;
              <span class="keywordflow">return</span> numngb;
            }
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          <span class="keyword">this</span> = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];
          hdiff = <a class="code" href="allvars_8c.html#a32df265d89a3353759d155bbfad4f3e6">Extnodes</a>[no].<a class="code" href="structextNODE.html#ac479dcb30bffad0266b13b9200bbe9ad">hmax</a> - hsml;
          <span class="keywordflow">if</span>(hdiff &lt; 0)
            hdiff = 0;

          no = this-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.d.sibling;       <span class="comment">/* in case the node can be discarded */</span>

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - searchcenter[0]) + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (-hsml - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - searchcenter[0]) - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (hsml + hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - searchcenter[1]) + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (-hsml - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - searchcenter[1]) - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (hsml + hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - searchcenter[2]) + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (-hsml - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - searchcenter[2]) - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (hsml + hdiff))
            <span class="keywordflow">continue</span>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (searchmin[0] - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (searchmax[0] + hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (searchmin[1] - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (searchmax[1] + hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (searchmin[2] - hdiff))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (searchmax[2] + hdiff))
            <span class="keywordflow">continue</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = this-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.d.nextnode;      <span class="comment">/* ok, we need to open the node */</span>
        }
    }

  *startnode = -1;
  <span class="keywordflow">return</span> numngb;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a96ec7acfa3c046abc6902ca77ee4bddd_icgraph.png" border="0" usemap="#proto_8h_a96ec7acfa3c046abc6902ca77ee4bddd_icgraph" alt=""/></div>
<map name="proto_8h_a96ec7acfa3c046abc6902ca77ee4bddd_icgraph" id="proto_8h_a96ec7acfa3c046abc6902ca77ee4bddd_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a818695254c9525e01bc9ddc95e8eaf7e" title="hydro_evaluate" alt="" coords="195,5,315,35"/><area shape="rect" id="node5" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="364,5,460,35"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="509,5,680,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="728,5,771,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="820,5,873,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a008284f92570d4d1fa6e3dadb5902cf8"></a><!-- doxytag: member="proto.h::ngb_treefind_variable" ref="a008284f92570d4d1fa6e3dadb5902cf8" args="(float searchcenter[3], float hguess, int *startnode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ngb_treefind_variable </td>
          <td>(</td>
          <td class="paramtype">float&nbsp;</td>
          <td class="paramname"> <em>searchcenter</em>[3], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&nbsp;</td>
          <td class="paramname"> <em>hsml</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>startnode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function returns neighbours with distance &lt;= hsml and returns them in Ngblist. Actually, particles in a box of half side length hsml are returned, i.e. the reduction to a sphere still needs to be done in the calling routine. </p>

<p><p>&lt; defines maximum length of neighbour list</p>
<p>&lt; defines maximum length of neighbour list </p>
</p>

<p>Definition at line <a class="el" href="ngb_8c_source.html#l00194">194</a> of file <a class="el" href="ngb_8c_source.html">ngb.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00586">NODE::center</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="allvars_8c_source.html#l00034">Exportflag</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8h_source.html#l00107">MAX_NGB</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="ngb_8c_source.html#l00320">ngb_clear_buf()</a>, <a class="el" href="ngb_8c_source.html#l00047">NGB_PERIODIC_X</a>, <a class="el" href="ngb_8c_source.html#l00048">NGB_PERIODIC_Y</a>, <a class="el" href="ngb_8c_source.html#l00049">NGB_PERIODIC_Z</a>, <a class="el" href="allvars_8c_source.html#l00036">Ngblist</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="density_8c_source.html#l00467">density_evaluate()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> k, numngb;
  <span class="keywordtype">int</span> no, p;
  <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *<span class="keyword">this</span>;
  <a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a> searchmin[3], searchmax[3];

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> xtmp;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)        <span class="comment">/* cube-box window */</span>
    {
      searchmin[k] = searchcenter[k] - hsml;
      searchmax[k] = searchcenter[k] + hsml;
    }

  numngb = 0;
  no = *startnode;

  <span class="keywordflow">while</span>(no &gt;= 0)
    {
      <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)      <span class="comment">/* single particle */</span>
        {
          p = no;
          no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no];

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Type &gt; 0)
            <span class="keywordflow">continue</span>;

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0] - searchcenter[0]) &lt; -hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0] - searchcenter[0]) &gt; hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1] - searchcenter[1]) &lt; -hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1] - searchcenter[1]) &gt; hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2] - searchcenter[2]) &lt; -hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2] - searchcenter[2]) &gt; hsml)
            <span class="keywordflow">continue</span>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0] &lt; searchmin[0])
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[0] &gt; searchmax[0])
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1] &lt; searchmin[1])
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[1] &gt; searchmax[1])
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2] &lt; searchmin[2])
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[p].Pos[2] &gt; searchmax[2])
            <span class="keywordflow">continue</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a>[numngb++] = p;

          <span class="keywordflow">if</span>(numngb == <a class="code" href="allvars_8h.html#a459bf1b27bb8a17c4496d2783e62161c">MAX_NGB</a>)
            {
              numngb = <a class="code" href="ngb_8c.html#a674ac0d18eaff78ba700f1278f078274">ngb_clear_buf</a>(searchcenter, hsml, numngb);
              <span class="keywordflow">if</span>(numngb == <a class="code" href="allvars_8h.html#a459bf1b27bb8a17c4496d2783e62161c">MAX_NGB</a>)
                {
                  printf(<span class="stringliteral">&quot;ThisTask=%d: Need to do a second neighbour loop for (%g|%g|%g) hsml=%g no=%d\n&quot;</span>,
                         <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, searchcenter[0], searchcenter[1], searchcenter[2], hsml, no);
                  *startnode = no;
                  <span class="keywordflow">return</span> numngb;
                }
            }
        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)      <span class="comment">/* pseudo particle */</span>
            {
              <a class="code" href="allvars_8c.html#a768b23818449e1b33a55747cb3cc2025">Exportflag</a>[<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> + <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)]] = 1;
              no = <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[no - <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>];
              <span class="keywordflow">continue</span>;
            }

          <span class="keyword">this</span> = &amp;<a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no];

          no = this-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.d.sibling;       <span class="comment">/* in case the node can be discarded */</span>
<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - searchcenter[0]) + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; -hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a49d4cb21065981774552d097f6f8832c">NGB_PERIODIC_X</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - searchcenter[0]) - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - searchcenter[1]) + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; -hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a3721767146404458e6955428a6e78cfd">NGB_PERIODIC_Y</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - searchcenter[1]) - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - searchcenter[2]) + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; -hsml)
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#ab563068e480f07f2fea4a94fb29ac11b">NGB_PERIODIC_Z</a>(this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - searchcenter[2]) - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; hsml)
            <span class="keywordflow">continue</span>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (searchmin[0]))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[0] - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (searchmax[0]))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (searchmin[1]))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[1] - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (searchmax[1]))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] + 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &lt; (searchmin[2]))
            <span class="keywordflow">continue</span>;
          <span class="keywordflow">if</span>((this-&gt;<a class="code" href="structNODE.html#a27584ddd52a800cbf36c4de8e3fb4bc9">center</a>[2] - 0.5 * this-&gt;<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>) &gt; (searchmax[2]))
            <span class="keywordflow">continue</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          no = this-&gt;<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.d.nextnode;      <span class="comment">/* ok, we need to open the node */</span>
        }
    }

  *startnode = -1;
  <span class="keywordflow">return</span> numngb;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a008284f92570d4d1fa6e3dadb5902cf8_cgraph.png" border="0" usemap="#proto_8h_a008284f92570d4d1fa6e3dadb5902cf8_cgraph" alt=""/></div>
<map name="proto_8h_a008284f92570d4d1fa6e3dadb5902cf8_cgraph" id="proto_8h_a008284f92570d4d1fa6e3dadb5902cf8_cgraph">
<area shape="rect" id="node3" href="ngb_8c.html#a674ac0d18eaff78ba700f1278f078274" title="ngb_clear_buf" alt="" coords="215,5,324,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a008284f92570d4d1fa6e3dadb5902cf8_icgraph.png" border="0" usemap="#proto_8h_a008284f92570d4d1fa6e3dadb5902cf8_icgraph" alt=""/></div>
<map name="proto_8h_a008284f92570d4d1fa6e3dadb5902cf8_icgraph" id="proto_8h_a008284f92570d4d1fa6e3dadb5902cf8_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a19f7a07621c698ae894f53836e9ff03c" title="density_evaluate" alt="" coords="213,32,344,61"/><area shape="rect" id="node5" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="393,32,460,61"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="515,5,685,35"/><area shape="rect" id="node13" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="511,59,689,88"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="841,5,884,35"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="945,32,999,61"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="740,59,780,88"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="829,59,896,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aab22cf240079ef5846d83729e4565f97"></a><!-- doxytag: member="proto.h::ngb_treefree" ref="aab22cf240079ef5846d83729e4565f97" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ngb_treefree </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>free memory allocated for neighbour list buffer. </p>

<p>Definition at line <a class="el" href="ngb_8c_source.html#l00394">394</a> of file <a class="el" href="ngb_8c_source.html">ngb.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00036">Ngblist</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  free(<a class="code" href="allvars_8c.html#ade1b96e6772d0d1ccb06bcbec352b5bd">Ngblist</a>);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab68e970cf33f44c3ff421fc2ea6e9290"></a><!-- doxytag: member="proto.h::ngb_treesearch" ref="ab68e970cf33f44c3ff421fc2ea6e9290" args="(int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ngb_treesearch </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="ad387916b04773b495483e10f3d24e9d6"></a><!-- doxytag: member="proto.h::ngb_treesearch_pairs" ref="ad387916b04773b495483e10f3d24e9d6" args="(int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ngb_treesearch_pairs </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a6895b316b66ff5f9f78910d65823bf00"></a><!-- doxytag: member="proto.h::ngb_update_nodes" ref="a6895b316b66ff5f9f78910d65823bf00" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ngb_update_nodes </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a6f629274f7b036874c743fb81d58ce68"></a><!-- doxytag: member="proto.h::open_outputfiles" ref="a6f629274f7b036874c743fb81d58ce68" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void open_outputfiles </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function opens various log-files that report on the status and performance of the simulstion. On restart from restart-files (start-option 1), the code will append to these files. </p>

<p>Definition at line <a class="el" href="begrun_8c_source.html#l00204">204</a> of file <a class="el" href="begrun_8c_source.html">begrun.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00493">global_data_all_processes::CpuFile</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00492">global_data_all_processes::EnergyFile</a>, <a class="el" href="allvars_8c_source.html#l00092">FdCPU</a>, <a class="el" href="allvars_8c_source.html#l00090">FdEnergy</a>, <a class="el" href="allvars_8c_source.html#l00095">FdForceTest</a>, <a class="el" href="allvars_8c_source.html#l00089">FdInfo</a>, <a class="el" href="allvars_8c_source.html#l00091">FdTimings</a>, <a class="el" href="allvars_8h_source.html#l00494">global_data_all_processes::InfoFile</a>, <a class="el" href="allvars_8h_source.html#l00490">global_data_all_processes::OutputDir</a>, <a class="el" href="allvars_8c_source.html#l00030">RestartFlag</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="allvars_8h_source.html#l00495">global_data_all_processes::TimingsFile</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">char</span> mode[2], buf[200];

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> != 0)             <span class="comment">/* only the root processor writes to the log files */</span>
    <span class="keywordflow">return</span>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 0)
    strcpy(mode, <span class="stringliteral">&quot;w&quot;</span>);
  <span class="keywordflow">else</span>
    strcpy(mode, <span class="stringliteral">&quot;a&quot;</span>);


  sprintf(buf, <span class="stringliteral">&quot;%s%s&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac2ba980c60460b89534ca8bba63cd679">CpuFile</a>);
  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a889700103f4f515009e98a7d789fd164">FdCPU</a> = fopen(buf, mode)))
    {
      printf(<span class="stringliteral">&quot;error in opening file &#39;%s&#39;\n&quot;</span>, buf);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
    }

  sprintf(buf, <span class="stringliteral">&quot;%s%s&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3cbcdacb8b522288268993f0ce5b15ac">InfoFile</a>);
  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#af26719ed46b19cc760b7b55c3cb9968c">FdInfo</a> = fopen(buf, mode)))
    {
      printf(<span class="stringliteral">&quot;error in opening file &#39;%s&#39;\n&quot;</span>, buf);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
    }

  sprintf(buf, <span class="stringliteral">&quot;%s%s&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa97394ab3a522c46b75f8b57a59ca0b5">EnergyFile</a>);
  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a0230903e40950ac42dbff71dddd12176">FdEnergy</a> = fopen(buf, mode)))
    {
      printf(<span class="stringliteral">&quot;error in opening file &#39;%s&#39;\n&quot;</span>, buf);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
    }

  sprintf(buf, <span class="stringliteral">&quot;%s%s&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae0f7c691d211f8076374cc55271022e8">TimingsFile</a>);
  <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a603fc3e63a037dff4463c67aa7a4c91e">FdTimings</a> = fopen(buf, mode)))
    {
      printf(<span class="stringliteral">&quot;error in opening file &#39;%s&#39;\n&quot;</span>, buf);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
    }

<span class="preprocessor">#ifdef FORCETEST</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 0)
    {
      sprintf(buf, <span class="stringliteral">&quot;%s%s&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <span class="stringliteral">&quot;forcetest.txt&quot;</span>);
      <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#ae16a08c18946ccba84c72541b51055dd">FdForceTest</a> = fopen(buf, <span class="stringliteral">&quot;w&quot;</span>)))
        {
          printf(<span class="stringliteral">&quot;error in opening file &#39;%s&#39;\n&quot;</span>, buf);
          <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
        }
      fclose(<a class="code" href="allvars_8c.html#ae16a08c18946ccba84c72541b51055dd">FdForceTest</a>);
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a6f629274f7b036874c743fb81d58ce68_cgraph.png" border="0" usemap="#proto_8h_a6f629274f7b036874c743fb81d58ce68_cgraph" alt=""/></div>
<map name="proto_8h_a6f629274f7b036874c743fb81d58ce68_cgraph" id="proto_8h_a6f629274f7b036874c743fb81d58ce68_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="181,5,248,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="296,5,453,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a6f629274f7b036874c743fb81d58ce68_icgraph.png" border="0" usemap="#proto_8h_a6f629274f7b036874c743fb81d58ce68_icgraph" alt=""/></div>
<map name="proto_8h_a6f629274f7b036874c743fb81d58ce68_icgraph" id="proto_8h_a6f629274f7b036874c743fb81d58ce68_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="181,5,248,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="297,5,351,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9eec17b80ae63eb79e98064f2d4f25df"></a><!-- doxytag: member="proto.h::peano_hilbert_key" ref="a9eec17b80ae63eb79e98064f2d4f25df" args="(int x, int y, int z, int bits)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> peano_hilbert_key </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bits</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function computes a Peano-Hilbert key for an integer triplet (x,y,z), with x,y,z in the range between 0 and 2^bits-1. </p>

<p>Definition at line <a class="el" href="peano_8c_source.html#l00263">263</a> of file <a class="el" href="peano_8c_source.html">peano.c</a>.</p>

<p>References <a class="el" href="peano_8c_source.html#l00207">quadrants</a>, <a class="el" href="peano_8c_source.html#l00249">rotx_table</a>, <a class="el" href="peano_8c_source.html#l00241">rotxmap_table</a>, <a class="el" href="peano_8c_source.html#l00250">roty_table</a>, <a class="el" href="peano_8c_source.html#l00245">rotymap_table</a>, and <a class="el" href="peano_8c_source.html#l00252">sense_table</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00896">domain_determineTopTree()</a>, <a class="el" href="forcetree_8c_source.html#l00292">force_create_empty_nodes()</a>, and <a class="el" href="forcetree_8c_source.html#l00093">force_treebuild_single()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, quad, bitx, bity, bitz;
  <span class="keywordtype">int</span> mask, rotation, rotx, roty, sense;
  <a class="code" href="allvars_8h.html#a63f10772bd5776dcb4b6301f425e0d26">peanokey</a> key;


  mask = 1 &lt;&lt; (bits - 1);
  key = 0;
  rotation = 0;
  sense = 1;


  <span class="keywordflow">for</span>(i = 0; i &lt; bits; i++, mask &gt;&gt;= 1)
    {
      bitx = (x &amp; mask) ? 1 : 0;
      bity = (y &amp; mask) ? 1 : 0;
      bitz = (z &amp; mask) ? 1 : 0;

      quad = <a class="code" href="peano_8c.html#a2ac73023fc426510c30117291895c0cf">quadrants</a>[rotation][bitx][bity][bitz];

      key &lt;&lt;= 3;
      key += (sense == 1) ? (quad) : (7 - quad);

      rotx = <a class="code" href="peano_8c.html#a44d18b8e2bb99c6899f2eb7e06a57e84">rotx_table</a>[quad];
      roty = <a class="code" href="peano_8c.html#a8bfd50e9b83d86c8585a42c306012cba">roty_table</a>[quad];
      sense *= <a class="code" href="peano_8c.html#a4bf6cdb1f31bb545b55e6f70d3b720e5">sense_table</a>[quad];

      <span class="keywordflow">while</span>(rotx &gt; 0)
        {
          rotation = <a class="code" href="peano_8c.html#a1ca16b25390042ce60f1da39ddf70898">rotxmap_table</a>[rotation];
          rotx--;
        }

      <span class="keywordflow">while</span>(roty &gt; 0)
        {
          rotation = <a class="code" href="peano_8c.html#add83bc48170e288d517578afecfca407">rotymap_table</a>[rotation];
          roty--;
        }
    }

  <span class="keywordflow">return</span> key;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a9eec17b80ae63eb79e98064f2d4f25df_icgraph.png" border="0" usemap="#proto_8h_a9eec17b80ae63eb79e98064f2d4f25df_icgraph" alt=""/></div>
<map name="proto_8h_a9eec17b80ae63eb79e98064f2d4f25df_icgraph" id="proto_8h_a9eec17b80ae63eb79e98064f2d4f25df_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="195,59,387,88"/><area shape="rect" id="node21" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="193,136,388,165"/><area shape="rect" id="node24" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="439,143,599,172"/><area shape="rect" id="node5" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="443,59,595,88"/><area shape="rect" id="node7" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="813,59,987,88"/><area shape="rect" id="node9" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="1035,109,1253,139"/><area shape="rect" id="node11" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1313,109,1356,139"/><area shape="rect" id="node15" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1124,5,1164,35"/><area shape="rect" id="node13" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1417,71,1471,100"/><area shape="rect" id="node17" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1301,31,1368,60"/><area shape="rect" id="node26" href="proto_8h.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="648,143,765,172"/><area shape="rect" id="node28" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="829,143,971,172"/><area shape="rect" id="node32" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="851,201,949,231"/><area shape="rect" id="node37" href="proto_8h.html#ac56af97a1dbbbbb07db8207246852f79" title="ngb_treebuild" alt="" coords="845,5,955,35"/><area shape="rect" id="node34" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="1059,213,1229,243"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af3e45a4293584b3fe28e83af75c6ed71"></a><!-- doxytag: member="proto.h::peano_hilbert_order" ref="af3e45a4293584b3fe28e83af75c6ed71" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void peano_hilbert_order </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function puts the particles into Peano-Hilbert order by sorting them according to their keys. The latter half already been computed in the domain decomposition. Since gas particles need to stay at the beginning of the particle list, they are sorted as a separate block. </p>

<p>Definition at line <a class="el" href="peano_8c_source.html#l00034">34</a> of file <a class="el" href="peano_8c_source.html">peano.c</a>.</p>

<p>References <a class="el" href="peano_8c_source.html#l00098">compare_key()</a>, <a class="el" href="peano_8c_source.html#l00026">Id</a>, <a class="el" href="peano_8c_source.html#l00022">peano_hilbert_data::index</a>, <a class="el" href="allvars_8c_source.html#l00070">Key</a>, <a class="el" href="peano_8c_source.html#l00021">peano_hilbert_data::key</a>, <a class="el" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="peano_8c_source.html#l00117">reorder_gas()</a>, <a class="el" href="peano_8c_source.html#l00166">reorder_particles()</a>, and <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>.</p>

<p>Referenced by <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;begin Peano-Hilbert order...\n&quot;</span>);

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>)
    {
      <a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a> = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpeano__hilbert__data.html">peano_hilbert_data</a>) * <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>);
      <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>);

      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i++)
        {
          <a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>[i].<a class="code" href="structpeano__hilbert__data.html#a37ba0b5554835eecd76473f5cd02f257">index</a> = i;
          <a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>[i].<a class="code" href="structpeano__hilbert__data.html#aaa704e82d9ca3b022e83cb23fe715131">key</a> = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[i];
        }

      qsort(<a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>, N_gas, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpeano__hilbert__data.html">peano_hilbert_data</a>), <a class="code" href="peano_8c.html#af3ffb253e14a79419d1effeee1b7261d">compare_key</a>);

      <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
        <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[<a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>[i].index] = i;

      <a class="code" href="peano_8c.html#af744cef873e3093ba2924da8265d1711">reorder_gas</a>();

      free(<a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>);
      free(<a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>);
    }


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> - N_gas &gt; 0)
    {
      <a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a> = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpeano__hilbert__data.html">peano_hilbert_data</a>) * (<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> - N_gas));
      <a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a> -= (N_gas);

      <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> - N_gas));
      <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a> -= (N_gas);

      <span class="keywordflow">for</span>(i = N_gas; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
        {
          <a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>[i].<a class="code" href="structpeano__hilbert__data.html#a37ba0b5554835eecd76473f5cd02f257">index</a> = i;
          <a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>[i].<a class="code" href="structpeano__hilbert__data.html#aaa704e82d9ca3b022e83cb23fe715131">key</a> = <a class="code" href="allvars_8c.html#a828333e1bfb5cffdb0e67942bbcd6cdb">Key</a>[i];
        }

      qsort(<a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a> + N_gas, NumPart - N_gas, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpeano__hilbert__data.html">peano_hilbert_data</a>), <a class="code" href="peano_8c.html#af3ffb253e14a79419d1effeee1b7261d">compare_key</a>);

      <span class="keywordflow">for</span>(i = N_gas; i &lt; NumPart; i++)
        <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[<a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>[i].index] = i;

      <a class="code" href="peano_8c.html#afcb358154dd7fd5de8b4156f417fb0ba">reorder_particles</a>();

      <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a> += N_gas;
      free(<a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>);
      <a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a> += N_gas;
      free(<a class="code" href="peano_8c.html#a6bca09dac540caff82dc91b8875b2893">mp</a>);
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;Peano-Hilbert done.\n&quot;</span>);
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af3e45a4293584b3fe28e83af75c6ed71_cgraph.png" border="0" usemap="#proto_8h_af3e45a4293584b3fe28e83af75c6ed71_cgraph" alt=""/></div>
<map name="proto_8h_af3e45a4293584b3fe28e83af75c6ed71_cgraph" id="proto_8h_af3e45a4293584b3fe28e83af75c6ed71_cgraph">
<area shape="rect" id="node3" href="peano_8c.html#af3ffb253e14a79419d1effeee1b7261d" title="compare_key" alt="" coords="217,5,324,35"/><area shape="rect" id="node5" href="peano_8c.html#af744cef873e3093ba2924da8265d1711" title="reorder_gas" alt="" coords="221,59,320,88"/><area shape="rect" id="node7" href="peano_8c.html#afcb358154dd7fd5de8b4156f417fb0ba" title="reorder_particles" alt="" coords="205,112,336,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af3e45a4293584b3fe28e83af75c6ed71_icgraph.png" border="0" usemap="#proto_8h_af3e45a4293584b3fe28e83af75c6ed71_icgraph" alt=""/></div>
<map name="proto_8h_af3e45a4293584b3fe28e83af75c6ed71_icgraph" id="proto_8h_af3e45a4293584b3fe28e83af75c6ed71_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="205,57,379,87"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="427,5,645,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="705,56,748,85"/><area shape="rect" id="node11" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="516,109,556,139"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="809,83,863,112"/><area shape="rect" id="node13" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="693,109,760,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0784ca56372f6ce3cf46e8b6623e4ea0"></a><!-- doxytag: member="proto.h::pm_init_nonperiodic" ref="a0784ca56372f6ce3cf46e8b6623e4ea0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_init_nonperiodic </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="longrange_8c_source.html#l00020">long_range_init()</a>.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a0784ca56372f6ce3cf46e8b6623e4ea0_icgraph.png" border="0" usemap="#proto_8h_a0784ca56372f6ce3cf46e8b6623e4ea0_icgraph" alt=""/></div>
<map name="proto_8h_a0784ca56372f6ce3cf46e8b6623e4ea0_icgraph" id="proto_8h_a0784ca56372f6ce3cf46e8b6623e4ea0_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af52079f2c63002aca9463ba0b13727df" title="long_range_init" alt="" coords="207,5,324,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="373,5,440,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="489,5,543,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac8030592010e755c61e6ee358ee0895d"></a><!-- doxytag: member="proto.h::pm_init_nonperiodic_allocate" ref="ac8030592010e755c61e6ee358ee0895d" args="(int dimprod)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_init_nonperiodic_allocate </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>dimprod</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="afd73e48ecc5be43d057dd718f78d187d"></a><!-- doxytag: member="proto.h::pm_init_nonperiodic_free" ref="afd73e48ecc5be43d057dd718f78d187d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_init_nonperiodic_free </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a13e381f05efdb739cf5026384e908409"></a><!-- doxytag: member="proto.h::pm_init_periodic" ref="a13e381f05efdb739cf5026384e908409" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_init_periodic </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routines generates the FFTW-plans to carry out the parallel FFTs later on. Some auxiliary variables are also initialized. </p>

<p><p>&lt; @-ASMTH gives the scale of the short-range/long-range force split in units of FFT-mesh cells</p>
<p>&lt; @-RCUT gives the maximum distance (in units of the scale used for the force split) out to which short-range forces are evaluated in the short-range tree walk. </p>
</p>

<p>Definition at line <a class="el" href="pm__periodic_8c_source.html#l00055">55</a> of file <a class="el" href="pm__periodic_8c_source.html">pm_periodic.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00099">ASMTH</a>, <a class="el" href="allvars_8h_source.html#l00393">global_data_all_processes::Asmth</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="pm__periodic_8c_source.html#l00034">fft_forward_plan</a>, <a class="el" href="pm__periodic_8c_source.html#l00034">fft_inverse_plan</a>, <a class="el" href="pm__periodic_8c_source.html#l00043">fftsize</a>, <a class="el" href="pm__periodic_8c_source.html#l00038">first_slab_of_task</a>, <a class="el" href="pm__periodic_8c_source.html#l00043">maxfftsize</a>, <a class="el" href="pm__periodic_8c_source.html#l00039">meshmax_list</a>, <a class="el" href="pm__periodic_8c_source.html#l00039">meshmin_list</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">nslab_x</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">nslab_y</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00103">RCUT</a>, <a class="el" href="allvars_8h_source.html#l00394">global_data_all_processes::Rcut</a>, <a class="el" href="pm__periodic_8c_source.html#l00036">slab_to_task</a>, <a class="el" href="pm__periodic_8c_source.html#l00037">slabs_per_task</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">slabstart_x</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">slabstart_y</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">smallest_slab</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="pm__periodic_8c_source.html#l00049">to_slab_fac</a>.</p>

<p>Referenced by <a class="el" href="longrange_8c_source.html#l00020">long_range_init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;
  <span class="keywordtype">int</span> slab_to_task_local[PMGRID];

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[0] = <a class="code" href="allvars_8h.html#afde936c3d6ae18fa09bca0eb4e5c88dd">ASMTH</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> / PMGRID;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aeb7ceb2f4d86465e1febbfad5fa849d6">Rcut</a>[0] = <a class="code" href="allvars_8h.html#a1757a8f71b37d9f5a7a8c753d9f9cab1">RCUT</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[0];

  <span class="comment">/* Set up the FFTW plan files. */</span>

  <a class="code" href="pm__periodic_8c.html#ada1bb88285e667f67d30ddac8c9fa924">fft_forward_plan</a> = rfftw3d_mpi_create_plan(MPI_COMM_WORLD, PMGRID, PMGRID, PMGRID,
                                             FFTW_REAL_TO_COMPLEX, FFTW_ESTIMATE | FFTW_IN_PLACE);
  <a class="code" href="pm__periodic_8c.html#affe0aa143bfd852f161120fe9a09f285">fft_inverse_plan</a> = rfftw3d_mpi_create_plan(MPI_COMM_WORLD, PMGRID, PMGRID, PMGRID,
                                             FFTW_COMPLEX_TO_REAL, FFTW_ESTIMATE | FFTW_IN_PLACE);

  <span class="comment">/* Workspace out the ranges on each processor. */</span>

  rfftwnd_mpi_local_sizes(<a class="code" href="pm__periodic_8c.html#ada1bb88285e667f67d30ddac8c9fa924">fft_forward_plan</a>, &amp;<a class="code" href="pm__periodic_8c.html#a9dfa9b82d22c2a6cc503bcbebe6d774c">nslab_x</a>, &amp;<a class="code" href="pm__periodic_8c.html#a140eccd2a65fea3b4e2080aea519eff1">slabstart_x</a>, &amp;<a class="code" href="pm__periodic_8c.html#ae33694d88449fd0eb1d291ac33498ac1">nslab_y</a>, &amp;<a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a>, &amp;<a class="code" href="pm__periodic_8c.html#a7575000a7b0c6532786de0ac15da4052">fftsize</a>);

  <span class="keywordflow">for</span>(i = 0; i &lt; PMGRID; i++)
    slab_to_task_local[i] = 0;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="pm__periodic_8c.html#a9dfa9b82d22c2a6cc503bcbebe6d774c">nslab_x</a>; i++)
    slab_to_task_local[<a class="code" href="pm__periodic_8c.html#a140eccd2a65fea3b4e2080aea519eff1">slabstart_x</a> + i] = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;

  MPI_Allreduce(slab_to_task_local, <a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>, PMGRID, MPI_INT, MPI_SUM, MPI_COMM_WORLD);

  MPI_Allreduce(&amp;nslab_x, &amp;<a class="code" href="pm__periodic_8c.html#ab401ed54b1c5572b1b6a2949ffd5c1f8">smallest_slab</a>, 1, MPI_INT, MPI_MIN, MPI_COMM_WORLD);

  <a class="code" href="pm__periodic_8c.html#ad054897488b61bb22501d6ad4b01e6c8">slabs_per_task</a> = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  MPI_Allgather(&amp;nslab_x, 1, MPI_INT, <a class="code" href="pm__periodic_8c.html#ad054897488b61bb22501d6ad4b01e6c8">slabs_per_task</a>, 1, MPI_INT, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; i++)
        printf(<span class="stringliteral">&quot;Task=%d  FFT-Slabs=%d\n&quot;</span>, i, <a class="code" href="pm__periodic_8c.html#ad054897488b61bb22501d6ad4b01e6c8">slabs_per_task</a>[i]);
    }

  <a class="code" href="pm__periodic_8c.html#a8b608f18c44e494650da5577ddb34082">first_slab_of_task</a> = malloc(NTask * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  MPI_Allgather(&amp;<a class="code" href="pm__periodic_8c.html#a140eccd2a65fea3b4e2080aea519eff1">slabstart_x</a>, 1, MPI_INT, <a class="code" href="pm__periodic_8c.html#a8b608f18c44e494650da5577ddb34082">first_slab_of_task</a>, 1, MPI_INT, MPI_COMM_WORLD);

  <a class="code" href="pm__periodic_8c.html#a0bdf8c7e2cab6c38a4357cf4817e7cbf">meshmin_list</a> = malloc(3 * NTask * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  <a class="code" href="pm__periodic_8c.html#aee0d2641b59b02dd9f5ed3070784d995">meshmax_list</a> = malloc(3 * NTask * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));


  <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> = PMGRID / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;

  MPI_Allreduce(&amp;<a class="code" href="pm__periodic_8c.html#a7575000a7b0c6532786de0ac15da4052">fftsize</a>, &amp;<a class="code" href="pm__periodic_8c.html#a9ae463305ca6786e02bc9000726802b1">maxfftsize</a>, 1, MPI_INT, MPI_MAX, MPI_COMM_WORLD);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a13e381f05efdb739cf5026384e908409_icgraph.png" border="0" usemap="#proto_8h_a13e381f05efdb739cf5026384e908409_icgraph" alt=""/></div>
<map name="proto_8h_a13e381f05efdb739cf5026384e908409_icgraph" id="proto_8h_a13e381f05efdb739cf5026384e908409_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af52079f2c63002aca9463ba0b13727df" title="long_range_init" alt="" coords="183,5,300,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="349,5,416,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="465,5,519,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="acb5c64377fad9e1a34bad88fb7c61a3e"></a><!-- doxytag: member="proto.h::pm_init_periodic_allocate" ref="acb5c64377fad9e1a34bad88fb7c61a3e" args="(int dimprod)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_init_periodic_allocate </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>dimprod</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function allocates the memory neeed to compute the long-range PM force. Three fields are used, one to hold the density (and its FFT, and then the real-space potential), one to hold the force field obtained by finite differencing, and finally a workspace field, which is used both as workspace for the parallel FFT, and as buffer for the communication algorithm used in the force computation. </p>

<p>Definition at line <a class="el" href="pm__periodic_8c_source.html#l00113">113</a> of file <a class="el" href="pm__periodic_8c_source.html">pm_periodic.c</a>.</p>

<p>References <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="pm__periodic_8c_source.html#l00046">fft_of_rhogrid</a>, <a class="el" href="pm__periodic_8c_source.html#l00043">fftsize</a>, <a class="el" href="pm__periodic_8c_source.html#l00045">forcegrid</a>, <a class="el" href="system_8c_source.html#l00111">imax()</a>, <a class="el" href="pm__periodic_8c_source.html#l00043">maxfftsize</a>, <a class="el" href="pm__periodic_8c_source.html#l00045">rhogrid</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, and <a class="el" href="pm__periodic_8c_source.html#l00045">workspace</a>.</p>

<p>Referenced by <a class="el" href="pm__periodic_8c_source.html#l00180">pmforce_periodic()</a>, and <a class="el" href="pm__periodic_8c_source.html#l00693">pmpotential_periodic()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keyword">static</span> <span class="keywordtype">int</span> first_alloc = 1;
  <span class="keywordtype">int</span> dimprodmax;
  <span class="keywordtype">double</span> bytes_tot = 0;
  <span class="keywordtype">size_t</span> bytes;

  MPI_Allreduce(&amp;dimprod, &amp;dimprodmax, 1, MPI_INT, MPI_MAX, MPI_COMM_WORLD);

  <span class="comment">/* allocate the memory to hold the FFT fields */</span>

  <span class="keywordflow">if</span>(!(<a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a> = (fftw_real *) malloc(bytes = <a class="code" href="pm__periodic_8c.html#a7575000a7b0c6532786de0ac15da4052">fftsize</a> * <span class="keyword">sizeof</span>(fftw_real))))
    {
      printf(<span class="stringliteral">&quot;failed to allocate memory for `FFT-rhogrid&#39; (%g MB).\n&quot;</span>, bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
    }
  bytes_tot += bytes;


  <span class="keywordflow">if</span>(!(<a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a> = (fftw_real *) malloc(bytes = <a class="code" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10">imax</a>(<a class="code" href="pm__periodic_8c.html#a7575000a7b0c6532786de0ac15da4052">fftsize</a>, dimprodmax) * <span class="keyword">sizeof</span>(fftw_real))))
    {
      printf(<span class="stringliteral">&quot;failed to allocate memory for `FFT-forcegrid&#39; (%g MB).\n&quot;</span>, bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
    }
  bytes_tot += bytes;

  <span class="keywordflow">if</span>(!(<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> = (fftw_real *) malloc(bytes = <a class="code" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10">imax</a>(<a class="code" href="pm__periodic_8c.html#a9ae463305ca6786e02bc9000726802b1">maxfftsize</a>, dimprodmax) * <span class="keyword">sizeof</span>(fftw_real))))
    {
      printf(<span class="stringliteral">&quot;failed to allocate memory for `FFT-workspace&#39; (%g MB).\n&quot;</span>, bytes / (1024.0 * 1024.0));
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1);
    }
  bytes_tot += bytes;

  <span class="keywordflow">if</span>(first_alloc == 1)
    {
      first_alloc = 0;
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nAllocated %g MByte for FFT data.\n\n&quot;</span>, bytes_tot / (1024.0 * 1024.0));
    }

  <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a> = (fftw_complex *) &amp; <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>[0];
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_acb5c64377fad9e1a34bad88fb7c61a3e_cgraph.png" border="0" usemap="#proto_8h_acb5c64377fad9e1a34bad88fb7c61a3e_cgraph" alt=""/></div>
<map name="proto_8h_acb5c64377fad9e1a34bad88fb7c61a3e_cgraph" id="proto_8h_acb5c64377fad9e1a34bad88fb7c61a3e_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="237,5,304,35"/><area shape="rect" id="node7" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10" title="imax" alt="" coords="244,59,297,88"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="352,5,509,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_acb5c64377fad9e1a34bad88fb7c61a3e_icgraph.png" border="0" usemap="#proto_8h_acb5c64377fad9e1a34bad88fb7c61a3e_icgraph" alt=""/></div>
<map name="proto_8h_acb5c64377fad9e1a34bad88fb7c61a3e_icgraph" id="proto_8h_acb5c64377fad9e1a34bad88fb7c61a3e_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="251,5,381,35"/><area shape="rect" id="node13" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="239,59,393,88"/><area shape="rect" id="node5" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="449,5,580,35"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="659,5,829,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="901,57,944,87"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="993,57,1047,87"/><area shape="rect" id="node15" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="444,59,585,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="635,109,853,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a259e6f8400ee889c64bc667334060742"></a><!-- doxytag: member="proto.h::pm_init_periodic_free" ref="a259e6f8400ee889c64bc667334060742" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_init_periodic_free </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine frees the space allocated for the parallel FFT algorithm. </p>

<p>Definition at line <a class="el" href="pm__periodic_8c_source.html#l00160">160</a> of file <a class="el" href="pm__periodic_8c_source.html">pm_periodic.c</a>.</p>

<p>References <a class="el" href="pm__periodic_8c_source.html#l00045">forcegrid</a>, <a class="el" href="pm__periodic_8c_source.html#l00045">rhogrid</a>, and <a class="el" href="pm__periodic_8c_source.html#l00045">workspace</a>.</p>

<p>Referenced by <a class="el" href="pm__periodic_8c_source.html#l00180">pmforce_periodic()</a>, and <a class="el" href="pm__periodic_8c_source.html#l00693">pmpotential_periodic()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="comment">/* allocate the memory to hold the FFT fields */</span>
  free(<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>);
  free(<a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>);
  free(<a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a259e6f8400ee889c64bc667334060742_icgraph.png" border="0" usemap="#proto_8h_a259e6f8400ee889c64bc667334060742_icgraph" alt=""/></div>
<map name="proto_8h_a259e6f8400ee889c64bc667334060742_icgraph" id="proto_8h_a259e6f8400ee889c64bc667334060742_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="227,5,357,35"/><area shape="rect" id="node13" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="215,59,369,88"/><area shape="rect" id="node5" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="425,5,556,35"/><area shape="rect" id="node7" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="635,5,805,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="877,57,920,87"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="969,57,1023,87"/><area shape="rect" id="node15" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="420,59,561,88"/><area shape="rect" id="node17" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="611,109,829,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a57f2f415791cd83ace42bff59b2feb97"></a><!-- doxytag: member="proto.h::pm_init_regionsize" ref="a57f2f415791cd83ace42bff59b2feb97" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_init_regionsize </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="longrange_8c_source.html#l00056">long_range_force()</a>, and <a class="el" href="longrange_8c_source.html#l00036">long_range_init_regionsize()</a>.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a57f2f415791cd83ace42bff59b2feb97_icgraph.png" border="0" usemap="#proto_8h_a57f2f415791cd83ace42bff59b2feb97_icgraph" alt=""/></div>
<map name="proto_8h_a57f2f415791cd83ace42bff59b2feb97_icgraph" id="proto_8h_a57f2f415791cd83ace42bff59b2feb97_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="196,57,337,87"/><area shape="rect" id="node12" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="201,111,332,140"/><area shape="rect" id="node17" href="proto_8h.html#ad295b3023b3d8fad337637a640362262" title="long_range_init_regionsize" alt="" coords="401,163,591,192"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="387,5,605,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="665,84,708,113"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="769,111,823,140"/><area shape="rect" id="node14" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="411,109,581,139"/><area shape="rect" id="node19" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="653,137,720,167"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae3950c19708f6a2886dd32897efa10c4"></a><!-- doxytag: member="proto.h::pm_setup_nonperiodic_kernel" ref="ae3950c19708f6a2886dd32897efa10c4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_setup_nonperiodic_kernel </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="longrange_8c_source.html#l00056">long_range_force()</a>, and <a class="el" href="longrange_8c_source.html#l00036">long_range_init_regionsize()</a>.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ae3950c19708f6a2886dd32897efa10c4_icgraph.png" border="0" usemap="#proto_8h_ae3950c19708f6a2886dd32897efa10c4_icgraph" alt=""/></div>
<map name="proto_8h_ae3950c19708f6a2886dd32897efa10c4_icgraph" id="proto_8h_ae3950c19708f6a2886dd32897efa10c4_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="268,57,409,87"/><area shape="rect" id="node12" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="273,111,404,140"/><area shape="rect" id="node17" href="proto_8h.html#ad295b3023b3d8fad337637a640362262" title="long_range_init_regionsize" alt="" coords="473,163,663,192"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="459,5,677,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="737,84,780,113"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="841,111,895,140"/><area shape="rect" id="node14" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="483,109,653,139"/><area shape="rect" id="node19" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="725,137,792,167"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8821224474d8690f0db99b8cfab3a8fc"></a><!-- doxytag: member="proto.h::pmforce_nonperiodic" ref="a8821224474d8690f0db99b8cfab3a8fc" args="(int grnr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int pmforce_nonperiodic </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>grnr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="longrange_8c_source.html#l00056">long_range_force()</a>.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a8821224474d8690f0db99b8cfab3a8fc_icgraph.png" border="0" usemap="#proto_8h_a8821224474d8690f0db99b8cfab3a8fc_icgraph" alt=""/></div>
<map name="proto_8h_a8821224474d8690f0db99b8cfab3a8fc_icgraph" id="proto_8h_a8821224474d8690f0db99b8cfab3a8fc_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="212,5,343,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="392,5,563,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="611,5,653,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="703,5,756,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af8dfaf42f3b513118ad6aa3ab5cd3c1b"></a><!-- doxytag: member="proto.h::pmforce_periodic" ref="af8dfaf42f3b513118ad6aa3ab5cd3c1b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pmforce_periodic </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Calculates the long-range periodic force given the particle positions using the PM method. The force is Gaussian filtered with Asmth, given in mesh-cell units. We carry out a CIC charge assignment, and compute the potenial by Fourier transform methods. The potential is finite differenced using a 4-point finite differencing formula, and the forces are interpolated tri-linearly to the particle positions. The CIC kernel is deconvolved. Note that the particle distribution is not in the slab decomposition that is used for the FFT. Instead, overlapping patches between local domains and FFT slabs are communicated as needed. </p>

<p>Definition at line <a class="el" href="pm__periodic_8c_source.html#l00180">180</a> of file <a class="el" href="pm__periodic_8c_source.html">pm_periodic.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00393">global_data_all_processes::Asmth</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="pm__periodic_8c_source.html#l00034">fft_forward_plan</a>, <a class="el" href="pm__periodic_8c_source.html#l00034">fft_inverse_plan</a>, <a class="el" href="pm__periodic_8c_source.html#l00046">fft_of_rhogrid</a>, <a class="el" href="pm__periodic_8c_source.html#l00043">fftsize</a>, <a class="el" href="pm__periodic_8c_source.html#l00038">first_slab_of_task</a>, <a class="el" href="forcetree_8c_source.html#l02827">force_treeallocate()</a>, <a class="el" href="forcetree_8c_source.html#l02892">force_treefree()</a>, <a class="el" href="pm__periodic_8c_source.html#l00045">forcegrid</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="allvars_8h_source.html#l00518">particle_data::GravPM</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="pm__periodic_8c_source.html#l00039">meshmax_list</a>, <a class="el" href="pm__periodic_8c_source.html#l00039">meshmin_list</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">nslab_y</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="pm__periodic_8c_source.html#l00113">pm_init_periodic_allocate()</a>, <a class="el" href="pm__periodic_8c_source.html#l00160">pm_init_periodic_free()</a>, <a class="el" href="pm__periodic_8c_source.html#l00029">PMGRID2</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="pm__periodic_8c_source.html#l00045">rhogrid</a>, <a class="el" href="pm__periodic_8c_source.html#l00036">slab_to_task</a>, <a class="el" href="pm__periodic_8c_source.html#l00037">slabs_per_task</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">slabstart_y</a>, <a class="el" href="tags_8h_source.html#l00020">TAG_PERIODIC_A</a>, <a class="el" href="tags_8h_source.html#l00021">TAG_PERIODIC_B</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="pm__periodic_8c_source.html#l00049">to_slab_fac</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00298">global_data_all_processes::TreeAllocFactor</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, and <a class="el" href="pm__periodic_8c_source.html#l00045">workspace</a>.</p>

<p>Referenced by <a class="el" href="longrange_8c_source.html#l00056">long_range_force()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> k2, kx, ky, kz, smth;
  <span class="keywordtype">double</span> dx, dy, dz;
  <span class="keywordtype">double</span> fx, fy, fz, ff;
  <span class="keywordtype">double</span> asmth2, fac, acc_dim;
  <span class="keywordtype">int</span> i, j, slab, level, sendTask, recvTask;
  <span class="keywordtype">int</span> x, y, z, xl, yl, zl, xr, yr, zr, xll, yll, zll, xrr, yrr, zrr, ip, dim;
  <span class="keywordtype">int</span> slab_x, slab_y, slab_z;
  <span class="keywordtype">int</span> slab_xx, slab_yy, slab_zz;
  <span class="keywordtype">int</span> meshmin[3], meshmax[3], sendmin, sendmax, recvmin, recvmax;
  <span class="keywordtype">int</span> rep, ncont, cont_sendmin[2], cont_sendmax[2], cont_recvmin[2], cont_recvmax[2];
  <span class="keywordtype">int</span> dimx, dimy, dimz, recv_dimx, recv_dimy, recv_dimz;
  MPI_Status status;


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;Starting periodic PM calculation.\n&quot;</span>);
      fflush(stdout);
    }


  <a class="code" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888">force_treefree</a>();


  asmth2 = (2 * M_PI) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[0] / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  asmth2 *= asmth2;

  fac = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a> / (M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>);   <span class="comment">/* to get potential */</span>
  fac *= 1 / (2 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a> / PMGRID);        <span class="comment">/* for finite differencing */</span>

  <span class="comment">/* first, establish the extension of the local patch in the PMGRID  */</span>

  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    {
      meshmin[j] = PMGRID;
      meshmax[j] = 0;
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          slab = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
          <span class="keywordflow">if</span>(slab &gt;= PMGRID)
            slab = PMGRID - 1;

          <span class="keywordflow">if</span>(slab &lt; meshmin[j])
            meshmin[j] = slab;

          <span class="keywordflow">if</span>(slab &gt; meshmax[j])
            meshmax[j] = slab;
        }
    }

  MPI_Allgather(meshmin, 3, MPI_INT, <a class="code" href="pm__periodic_8c.html#a0bdf8c7e2cab6c38a4357cf4817e7cbf">meshmin_list</a>, 3, MPI_INT, MPI_COMM_WORLD);
  MPI_Allgather(meshmax, 3, MPI_INT, <a class="code" href="pm__periodic_8c.html#aee0d2641b59b02dd9f5ed3070784d995">meshmax_list</a>, 3, MPI_INT, MPI_COMM_WORLD);

  dimx = meshmax[0] - meshmin[0] + 2;
  dimy = meshmax[1] - meshmin[1] + 2;
  dimz = meshmax[2] - meshmin[2] + 2;

  <a class="code" href="pm__periodic_8c.html#acb5c64377fad9e1a34bad88fb7c61a3e">pm_init_periodic_allocate</a>((dimx + 4) * (dimy + 4) * (dimz + 4));

  <span class="keywordflow">for</span>(i = 0; i &lt; dimx * dimy * dimz; i++)
    <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[i] = 0;

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    {
      slab_x = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
      <span class="keywordflow">if</span>(slab_x &gt;= PMGRID)
        slab_x = PMGRID - 1;
      dx = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - slab_x;
      slab_x -= meshmin[0];
      slab_xx = slab_x + 1;

      slab_y = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
      <span class="keywordflow">if</span>(slab_y &gt;= PMGRID)
        slab_y = PMGRID - 1;
      dy = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - slab_y;
      slab_y -= meshmin[1];
      slab_yy = slab_y + 1;

      slab_z = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
      <span class="keywordflow">if</span>(slab_z &gt;= PMGRID)
        slab_z = PMGRID - 1;
      dz = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - slab_z;
      slab_z -= meshmin[2];
      slab_zz = slab_z + 1;

      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_x * dimy + slab_y) * dimz + slab_z] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (1.0 - dx) * (1.0 - dy) * (1.0 - dz);
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_x * dimy + slab_yy) * dimz + slab_z] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (1.0 - dx) * dy * (1.0 - dz);
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_x * dimy + slab_y) * dimz + slab_zz] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (1.0 - dx) * (1.0 - dy) * dz;
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_x * dimy + slab_yy) * dimz + slab_zz] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (1.0 - dx) * dy * dz;

      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_xx * dimy + slab_y) * dimz + slab_z] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (dx) * (1.0 - dy) * (1.0 - dz);
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_xx * dimy + slab_yy) * dimz + slab_z] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (dx) * dy * (1.0 - dz);
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_xx * dimy + slab_y) * dimz + slab_zz] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (dx) * (1.0 - dy) * dz;
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_xx * dimy + slab_yy) * dimz + slab_zz] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (dx) * dy * dz;
    }


  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="pm__periodic_8c.html#a7575000a7b0c6532786de0ac15da4052">fftsize</a>; i++)  <span class="comment">/* clear local density field */</span>
    <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>[i] = 0;

  <span class="keywordflow">for</span>(level = 0; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++) <span class="comment">/* note: for level=0, target is the same task */</span>
    {
      sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
      recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ level;
      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        {
          <span class="comment">/* check how much we have to send */</span>
          sendmin = 2 * PMGRID;
          sendmax = -1;
          <span class="keywordflow">for</span>(slab_x = meshmin[0]; slab_x &lt; meshmax[0] + 2; slab_x++)
            <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[slab_x % PMGRID] == recvTask)
              {
                <span class="keywordflow">if</span>(slab_x &lt; sendmin)
                  sendmin = slab_x;
                <span class="keywordflow">if</span>(slab_x &gt; sendmax)
                  sendmax = slab_x;
              }
          <span class="keywordflow">if</span>(sendmax == -1)
            sendmin = 0;

          <span class="comment">/* check how much we have to receive */</span>
          recvmin = 2 * PMGRID;
          recvmax = -1;
          <span class="keywordflow">for</span>(slab_x = <a class="code" href="pm__periodic_8c.html#a0bdf8c7e2cab6c38a4357cf4817e7cbf">meshmin_list</a>[3 * recvTask]; slab_x &lt; <a class="code" href="pm__periodic_8c.html#aee0d2641b59b02dd9f5ed3070784d995">meshmax_list</a>[3 * recvTask] + 2; slab_x++)
            <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[slab_x % PMGRID] == sendTask)
              {
                <span class="keywordflow">if</span>(slab_x &lt; recvmin)
                  recvmin = slab_x;
                <span class="keywordflow">if</span>(slab_x &gt; recvmax)
                  recvmax = slab_x;
              }
          <span class="keywordflow">if</span>(recvmax == -1)
            recvmin = 0;


          <span class="keywordflow">if</span>((recvmax - recvmin) &gt;= 0 || (sendmax - sendmin) &gt;= 0)      <span class="comment">/* ok, we have a contribution to the slab */</span>
            {
              recv_dimx = meshmax_list[3 * recvTask + 0] - <a class="code" href="pm__periodic_8c.html#a0bdf8c7e2cab6c38a4357cf4817e7cbf">meshmin_list</a>[3 * recvTask + 0] + 2;
              recv_dimy = meshmax_list[3 * recvTask + 1] - meshmin_list[3 * recvTask + 1] + 2;
              recv_dimz = meshmax_list[3 * recvTask + 2] - meshmin_list[3 * recvTask + 2] + 2;

              <span class="keywordflow">if</span>(level &gt; 0)
                {
                  MPI_Sendrecv(<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> + (sendmin - meshmin[0]) * dimy * dimz,
                               (sendmax - sendmin + 1) * dimy * dimz * <span class="keyword">sizeof</span>(fftw_real), MPI_BYTE, recvTask,
                               <a class="code" href="tags_8h.html#a4a6e55a8ac447faebc4a6c279d5f5b8a">TAG_PERIODIC_A</a>, <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>,
                               (recvmax - recvmin + 1) * recv_dimy * recv_dimz * <span class="keyword">sizeof</span>(fftw_real), MPI_BYTE,
                               recvTask, <a class="code" href="tags_8h.html#a4a6e55a8ac447faebc4a6c279d5f5b8a">TAG_PERIODIC_A</a>, MPI_COMM_WORLD, &amp;status);
                }
              <span class="keywordflow">else</span>
                {
                  memcpy(<a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>, <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> + (sendmin - meshmin[0]) * dimy * dimz,
                         (sendmax - sendmin + 1) * dimy * dimz * <span class="keyword">sizeof</span>(fftw_real));
                }

              <span class="keywordflow">for</span>(slab_x = recvmin; slab_x &lt;= recvmax; slab_x++)
                {
                  slab_xx = (slab_x % PMGRID) - <a class="code" href="pm__periodic_8c.html#a8b608f18c44e494650da5577ddb34082">first_slab_of_task</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>];

                  <span class="keywordflow">if</span>(slab_xx &gt;= 0 &amp;&amp; slab_xx &lt; <a class="code" href="pm__periodic_8c.html#ad054897488b61bb22501d6ad4b01e6c8">slabs_per_task</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>])
                    {
                      <span class="keywordflow">for</span>(slab_y = meshmin_list[3 * recvTask + 1];
                          slab_y &lt;= meshmax_list[3 * recvTask + 1] + 1; slab_y++)
                        {
                          slab_yy = slab_y;
                          <span class="keywordflow">if</span>(slab_yy &gt;= PMGRID)
                            slab_yy -= PMGRID;

                          <span class="keywordflow">for</span>(slab_z = meshmin_list[3 * recvTask + 2];
                              slab_z &lt;= meshmax_list[3 * recvTask + 2] + 1; slab_z++)
                            {
                              slab_zz = slab_z;
                              <span class="keywordflow">if</span>(slab_zz &gt;= PMGRID)
                                slab_zz -= PMGRID;

                              <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>[PMGRID * <a class="code" href="pm__periodic_8c.html#a8a4d19d2948b1d7b3eff694719e5f436">PMGRID2</a> * slab_xx + <a class="code" href="pm__periodic_8c.html#a8a4d19d2948b1d7b3eff694719e5f436">PMGRID2</a> * slab_yy + slab_zz] +=
                                <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[((slab_x - recvmin) * recv_dimy +
                                           (slab_y - meshmin_list[3 * recvTask + 1])) * recv_dimz +
                                          (slab_z - meshmin_list[3 * recvTask + 2])];
                            }
                        }
                    }
                }
            }
        }
    }

  <span class="comment">/* Do the FFT of the density field */</span>

  rfftwnd_mpi(<a class="code" href="pm__periodic_8c.html#ada1bb88285e667f67d30ddac8c9fa924">fft_forward_plan</a>, 1, <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>, <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>, FFTW_TRANSPOSED_ORDER);

  <span class="comment">/* multiply with Green&#39;s function for the potential */</span>

  <span class="keywordflow">for</span>(y = <a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a>; y &lt; <a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a> + <a class="code" href="pm__periodic_8c.html#ae33694d88449fd0eb1d291ac33498ac1">nslab_y</a>; y++)
    <span class="keywordflow">for</span>(x = 0; x &lt; PMGRID; x++)
      <span class="keywordflow">for</span>(z = 0; z &lt; PMGRID / 2 + 1; z++)
        {
          <span class="keywordflow">if</span>(x &gt; PMGRID / 2)
            kx = x - PMGRID;
          <span class="keywordflow">else</span>
            kx = x;
          <span class="keywordflow">if</span>(y &gt; PMGRID / 2)
            ky = y - PMGRID;
          <span class="keywordflow">else</span>
            ky = y;
          <span class="keywordflow">if</span>(z &gt; PMGRID / 2)
            kz = z - PMGRID;
          <span class="keywordflow">else</span>
            kz = z;

          k2 = kx * kx + ky * ky + kz * kz;

          <span class="keywordflow">if</span>(k2 &gt; 0)
            {
              smth = -exp(-k2 * asmth2) / k2;

              <span class="comment">/* do deconvolution */</span>

              fx = fy = fz = 1;
              <span class="keywordflow">if</span>(kx != 0)
                {
                  fx = (M_PI * kx) / PMGRID;
                  fx = sin(fx) / fx;
                }
              <span class="keywordflow">if</span>(ky != 0)
                {
                  fy = (M_PI * ky) / PMGRID;
                  fy = sin(fy) / fy;
                }
              <span class="keywordflow">if</span>(kz != 0)
                {
                  fz = (M_PI * kz) / PMGRID;
                  fz = sin(fz) / fz;
                }
              ff = 1 / (fx * fy * fz);
              smth *= ff * ff * ff * ff;

              <span class="comment">/* end deconvolution */</span>

              ip = PMGRID * (PMGRID / 2 + 1) * (y - <a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a>) + (PMGRID / 2 + 1) * x + z;
              <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a>[ip].re *= smth;
              <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a>[ip].im *= smth;
            }
        }

  <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a> == 0)
    <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a>[0].re = <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a>[0].im = 0.0;

  <span class="comment">/* Do the FFT to get the potential */</span>

  rfftwnd_mpi(<a class="code" href="pm__periodic_8c.html#affe0aa143bfd852f161120fe9a09f285">fft_inverse_plan</a>, 1, <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>, <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>, FFTW_TRANSPOSED_ORDER);

  <span class="comment">/* Now rhogrid holds the potential */</span>
  <span class="comment">/* construct the potential for the local patch */</span>


  dimx = meshmax[0] - meshmin[0] + 6;
  dimy = meshmax[1] - meshmin[1] + 6;
  dimz = meshmax[2] - meshmin[2] + 6;

  <span class="keywordflow">for</span>(level = 0; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++) <span class="comment">/* note: for level=0, target is the same task */</span>
    {
      sendTask = ThisTask;
      recvTask = ThisTask ^ level;

      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        {

          <span class="comment">/* check how much we have to send */</span>
          sendmin = 2 * PMGRID;
          sendmax = -PMGRID;
          <span class="keywordflow">for</span>(slab_x = meshmin_list[3 * recvTask] - 2; slab_x &lt; meshmax_list[3 * recvTask] + 4; slab_x++)
            <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] == sendTask)
              {
                <span class="keywordflow">if</span>(slab_x &lt; sendmin)
                  sendmin = slab_x;
                <span class="keywordflow">if</span>(slab_x &gt; sendmax)
                  sendmax = slab_x;
              }
          <span class="keywordflow">if</span>(sendmax == -PMGRID)
            sendmin = sendmax + 1;


          <span class="comment">/* check how much we have to receive */</span>
          recvmin = 2 * PMGRID;
          recvmax = -PMGRID;
          <span class="keywordflow">for</span>(slab_x = meshmin[0] - 2; slab_x &lt; meshmax[0] + 4; slab_x++)
            <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] == recvTask)
              {
                <span class="keywordflow">if</span>(slab_x &lt; recvmin)
                  recvmin = slab_x;
                <span class="keywordflow">if</span>(slab_x &gt; recvmax)
                  recvmax = slab_x;
              }
          <span class="keywordflow">if</span>(recvmax == -PMGRID)
            recvmin = recvmax + 1;

          <span class="keywordflow">if</span>((recvmax - recvmin) &gt;= 0 || (sendmax - sendmin) &gt;= 0)      <span class="comment">/* ok, we have a contribution to the slab */</span>
            {
              recv_dimx = meshmax_list[3 * recvTask + 0] - meshmin_list[3 * recvTask + 0] + 6;
              recv_dimy = meshmax_list[3 * recvTask + 1] - meshmin_list[3 * recvTask + 1] + 6;
              recv_dimz = meshmax_list[3 * recvTask + 2] - meshmin_list[3 * recvTask + 2] + 6;

              ncont = 1;
              cont_sendmin[0] = sendmin;
              cont_sendmax[0] = sendmax;
              cont_sendmin[1] = sendmax + 1;
              cont_sendmax[1] = sendmax;

              cont_recvmin[0] = recvmin;
              cont_recvmax[0] = recvmax;
              cont_recvmin[1] = recvmax + 1;
              cont_recvmax[1] = recvmax;

              <span class="keywordflow">for</span>(slab_x = sendmin; slab_x &lt;= sendmax; slab_x++)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] != ThisTask)
                    {
                      <span class="comment">/* non-contiguous */</span>
                      cont_sendmax[0] = slab_x - 1;
                      <span class="keywordflow">while</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] != ThisTask)
                        slab_x++;
                      cont_sendmin[1] = slab_x;
                      ncont++;
                    }
                }

              <span class="keywordflow">for</span>(slab_x = recvmin; slab_x &lt;= recvmax; slab_x++)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] != recvTask)
                    {
                      <span class="comment">/* non-contiguous */</span>
                      cont_recvmax[0] = slab_x - 1;
                      <span class="keywordflow">while</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] != recvTask)
                        slab_x++;
                      cont_recvmin[1] = slab_x;
                      <span class="keywordflow">if</span>(ncont == 1)
                        ncont++;
                    }
                }


              <span class="keywordflow">for</span>(rep = 0; rep &lt; ncont; rep++)
                {
                  sendmin = cont_sendmin[rep];
                  sendmax = cont_sendmax[rep];
                  recvmin = cont_recvmin[rep];
                  recvmax = cont_recvmax[rep];

                  <span class="comment">/* prepare what we want to send */</span>
                  <span class="keywordflow">if</span>(sendmax - sendmin &gt;= 0)
                    {
                      <span class="keywordflow">for</span>(slab_x = sendmin; slab_x &lt;= sendmax; slab_x++)
                        {
                          slab_xx = ((slab_x + PMGRID) % PMGRID) - <a class="code" href="pm__periodic_8c.html#a8b608f18c44e494650da5577ddb34082">first_slab_of_task</a>[ThisTask];

                          <span class="keywordflow">for</span>(slab_y = meshmin_list[3 * recvTask + 1] - 2;
                              slab_y &lt; meshmax_list[3 * recvTask + 1] + 4; slab_y++)
                            {
                              slab_yy = (slab_y + PMGRID) % PMGRID;

                              <span class="keywordflow">for</span>(slab_z = meshmin_list[3 * recvTask + 2] - 2;
                                  slab_z &lt; meshmax_list[3 * recvTask + 2] + 4; slab_z++)
                                {
                                  slab_zz = (slab_z + PMGRID) % PMGRID;

                                  <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[((slab_x - sendmin) * recv_dimy +
                                             (slab_y - (meshmin_list[3 * recvTask + 1] - 2))) * recv_dimz +
                                            slab_z - (meshmin_list[3 * recvTask + 2] - 2)] =
                                    <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>[PMGRID * <a class="code" href="pm__periodic_8c.html#a8a4d19d2948b1d7b3eff694719e5f436">PMGRID2</a> * slab_xx + <a class="code" href="pm__periodic_8c.html#a8a4d19d2948b1d7b3eff694719e5f436">PMGRID2</a> * slab_yy + slab_zz];
                                }
                            }
                        }
                    }

                  <span class="keywordflow">if</span>(level &gt; 0)
                    {
                      MPI_Sendrecv(<a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>,
                                   (sendmax - sendmin + 1) * recv_dimy * recv_dimz * <span class="keyword">sizeof</span>(fftw_real),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#ab2ae970ad97e212acadb61581cd5643e">TAG_PERIODIC_B</a>,
                                   <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> + (recvmin - (meshmin[0] - 2)) * dimy * dimz,
                                   (recvmax - recvmin + 1) * dimy * dimz * <span class="keyword">sizeof</span>(fftw_real), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#ab2ae970ad97e212acadb61581cd5643e">TAG_PERIODIC_B</a>, MPI_COMM_WORLD, &amp;status);
                    }
                  <span class="keywordflow">else</span>
                    {
                      memcpy(<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> + (recvmin - (meshmin[0] - 2)) * dimy * dimz,
                             <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>, (recvmax - recvmin + 1) * dimy * dimz * <span class="keyword">sizeof</span>(fftw_real));
                    }
                }
            }
        }
    }


  dimx = meshmax[0] - meshmin[0] + 2;
  dimy = meshmax[1] - meshmin[1] + 2;
  dimz = meshmax[2] - meshmin[2] + 2;

  recv_dimx = meshmax[0] - meshmin[0] + 6;
  recv_dimy = meshmax[1] - meshmin[1] + 6;
  recv_dimz = meshmax[2] - meshmin[2] + 6;


  <span class="keywordflow">for</span>(dim = 0; dim &lt; 3; dim++)  <span class="comment">/* Calculate each component of the force. */</span>
    {
      <span class="comment">/* get the force component by finite differencing the potential */</span>
      <span class="comment">/* note: &quot;workspace&quot; now contains the potential for the local patch, plus a suffiently large buffer region */</span>

      <span class="keywordflow">for</span>(x = 0; x &lt; meshmax[0] - meshmin[0] + 2; x++)
        <span class="keywordflow">for</span>(y = 0; y &lt; meshmax[1] - meshmin[1] + 2; y++)
          <span class="keywordflow">for</span>(z = 0; z &lt; meshmax[2] - meshmin[2] + 2; z++)
            {
              xrr = xll = xr = xl = x;
              yrr = yll = yr = yl = y;
              zrr = zll = zr = zl = z;

              <span class="keywordflow">switch</span> (dim)
                {
                <span class="keywordflow">case</span> 0:
                  xr = x + 1;
                  xrr = x + 2;
                  xl = x - 1;
                  xll = x - 2;
                  <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> 1:
                  yr = y + 1;
                  yl = y - 1;
                  yrr = y + 2;
                  yll = y - 2;
                  <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> 2:
                  zr = z + 1;
                  zl = z - 1;
                  zrr = z + 2;
                  zll = z - 2;
                  <span class="keywordflow">break</span>;
                }

              <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(x * dimy + y) * dimz + z]
                =
                fac * ((4.0 / 3) *
                       (<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[((xl + 2) * recv_dimy + (yl + 2)) * recv_dimz + (zl + 2)]
                        - <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[((xr + 2) * recv_dimy + (yr + 2)) * recv_dimz + (zr + 2)]) -
                       (1.0 / 6) *
                       (<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[((xll + 2) * recv_dimy + (yll + 2)) * recv_dimz + (zll + 2)] -
                        <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[((xrr + 2) * recv_dimy + (yrr + 2)) * recv_dimz + (zrr + 2)]));
            }

      <span class="comment">/* read out the forces */</span>

      <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
        {
          slab_x = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
          <span class="keywordflow">if</span>(slab_x &gt;= PMGRID)
            slab_x = PMGRID - 1;
          dx = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - slab_x;
          slab_x -= meshmin[0];
          slab_xx = slab_x + 1;

          slab_y = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
          <span class="keywordflow">if</span>(slab_y &gt;= PMGRID)
            slab_y = PMGRID - 1;
          dy = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - slab_y;
          slab_y -= meshmin[1];
          slab_yy = slab_y + 1;

          slab_z = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
          <span class="keywordflow">if</span>(slab_z &gt;= PMGRID)
            slab_z = PMGRID - 1;
          dz = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - slab_z;
          slab_z -= meshmin[2];
          slab_zz = slab_z + 1;

          acc_dim =
            <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_x * dimy + slab_y) * dimz + slab_z] * (1.0 - dx) * (1.0 - dy) * (1.0 - dz);
          acc_dim += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_x * dimy + slab_yy) * dimz + slab_z] * (1.0 - dx) * dy * (1.0 - dz);
          acc_dim += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_x * dimy + slab_y) * dimz + slab_zz] * (1.0 - dx) * (1.0 - dy) * dz;
          acc_dim += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_x * dimy + slab_yy) * dimz + slab_zz] * (1.0 - dx) * dy * dz;

          acc_dim += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_xx * dimy + slab_y) * dimz + slab_z] * (dx) * (1.0 - dy) * (1.0 - dz);
          acc_dim += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_xx * dimy + slab_yy) * dimz + slab_z] * (dx) * dy * (1.0 - dz);
          acc_dim += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_xx * dimy + slab_y) * dimz + slab_zz] * (dx) * (1.0 - dy) * dz;
          acc_dim += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_xx * dimy + slab_yy) * dimz + slab_zz] * (dx) * dy * dz;

          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a66cad4fae4501e68c9be5f6c643a8798">GravPM</a>[dim] = acc_dim;
        }
    }

  <a class="code" href="pm__periodic_8c.html#a259e6f8400ee889c64bc667334060742">pm_init_periodic_free</a>();
  <a class="code" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>);

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;

  <span class="keywordflow">if</span>(ThisTask == 0)
    {
      printf(<span class="stringliteral">&quot;done PM.\n&quot;</span>);
      fflush(stdout);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af8dfaf42f3b513118ad6aa3ab5cd3c1b_cgraph.png" border="0" usemap="#proto_8h_af8dfaf42f3b513118ad6aa3ab5cd3c1b_cgraph" alt=""/></div>
<map name="proto_8h_af8dfaf42f3b513118ad6aa3ab5cd3c1b_cgraph" id="proto_8h_af8dfaf42f3b513118ad6aa3ab5cd3c1b_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="211,5,347,35"/><area shape="rect" id="node9" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888" title="force_treefree" alt="" coords="223,59,335,88"/><area shape="rect" id="node11" href="pm__periodic_8c.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="188,112,369,141"/><area shape="rect" id="node16" href="pm__periodic_8c.html#a259e6f8400ee889c64bc667334060742" title="pm_init_periodic_free" alt="" coords="200,165,357,195"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="419,32,485,61"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="533,32,691,61"/><area shape="rect" id="node14" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10" title="imax" alt="" coords="425,112,479,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af8dfaf42f3b513118ad6aa3ab5cd3c1b_icgraph.png" border="0" usemap="#proto_8h_af8dfaf42f3b513118ad6aa3ab5cd3c1b_icgraph" alt=""/></div>
<map name="proto_8h_af8dfaf42f3b513118ad6aa3ab5cd3c1b_icgraph" id="proto_8h_af8dfaf42f3b513118ad6aa3ab5cd3c1b_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="188,5,319,35"/><area shape="rect" id="node5" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="368,5,539,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="587,5,629,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="679,5,732,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a480e7cb454d4e690653cc0db2bb9ebf9"></a><!-- doxytag: member="proto.h::pmpotential_nonperiodic" ref="a480e7cb454d4e690653cc0db2bb9ebf9" args="(int grnr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int pmpotential_nonperiodic </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>grnr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a480e7cb454d4e690653cc0db2bb9ebf9_icgraph.png" border="0" usemap="#proto_8h_a480e7cb454d4e690653cc0db2bb9ebf9_icgraph" alt=""/></div>
<map name="proto_8h_a480e7cb454d4e690653cc0db2bb9ebf9_icgraph" id="proto_8h_a480e7cb454d4e690653cc0db2bb9ebf9_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="236,32,377,61"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="427,5,645,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="693,32,736,61"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="785,32,839,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a7938f2181f23d56ac46f3625d1a855a0"></a><!-- doxytag: member="proto.h::pmpotential_periodic" ref="a7938f2181f23d56ac46f3625d1a855a0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pmpotential_periodic </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Calculates the long-range potential using the PM method. The potential is Gaussian filtered with Asmth, given in mesh-cell units. We carry out a CIC charge assignment, and compute the potenial by Fourier transform methods. The CIC kernel is deconvolved. </p>

<p>Definition at line <a class="el" href="pm__periodic_8c_source.html#l00693">693</a> of file <a class="el" href="pm__periodic_8c_source.html">pm_periodic.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00393">global_data_all_processes::Asmth</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="pm__periodic_8c_source.html#l00034">fft_forward_plan</a>, <a class="el" href="pm__periodic_8c_source.html#l00034">fft_inverse_plan</a>, <a class="el" href="pm__periodic_8c_source.html#l00046">fft_of_rhogrid</a>, <a class="el" href="pm__periodic_8c_source.html#l00043">fftsize</a>, <a class="el" href="pm__periodic_8c_source.html#l00038">first_slab_of_task</a>, <a class="el" href="forcetree_8c_source.html#l02827">force_treeallocate()</a>, <a class="el" href="forcetree_8c_source.html#l02892">force_treefree()</a>, <a class="el" href="pm__periodic_8c_source.html#l00045">forcegrid</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="pm__periodic_8c_source.html#l00039">meshmax_list</a>, <a class="el" href="pm__periodic_8c_source.html#l00039">meshmin_list</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">nslab_y</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="pm__periodic_8c_source.html#l00113">pm_init_periodic_allocate()</a>, <a class="el" href="pm__periodic_8c_source.html#l00160">pm_init_periodic_free()</a>, <a class="el" href="pm__periodic_8c_source.html#l00029">PMGRID2</a>, <a class="el" href="allvars_8h_source.html#l00513">particle_data::Pos</a>, <a class="el" href="allvars_8h_source.html#l00523">particle_data::Potential</a>, <a class="el" href="allvars_8c_source.html#l00017">PTask</a>, <a class="el" href="pm__periodic_8c_source.html#l00045">rhogrid</a>, <a class="el" href="pm__periodic_8c_source.html#l00036">slab_to_task</a>, <a class="el" href="pm__periodic_8c_source.html#l00037">slabs_per_task</a>, <a class="el" href="pm__periodic_8c_source.html#l00041">slabstart_y</a>, <a class="el" href="tags_8h_source.html#l00022">TAG_PERIODIC_C</a>, <a class="el" href="tags_8h_source.html#l00023">TAG_PERIODIC_D</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="pm__periodic_8c_source.html#l00049">to_slab_fac</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00298">global_data_all_processes::TreeAllocFactor</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, and <a class="el" href="pm__periodic_8c_source.html#l00045">workspace</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> k2, kx, ky, kz, smth;
  <span class="keywordtype">double</span> dx, dy, dz;
  <span class="keywordtype">double</span> fx, fy, fz, ff;
  <span class="keywordtype">double</span> asmth2, fac;
  <span class="keywordtype">int</span> i, j, slab, level, sendTask, recvTask;
  <span class="keywordtype">int</span> x, y, z, ip;
  <span class="keywordtype">int</span> slab_x, slab_y, slab_z;
  <span class="keywordtype">int</span> slab_xx, slab_yy, slab_zz;
  <span class="keywordtype">int</span> meshmin[3], meshmax[3], sendmin, sendmax, recvmin, recvmax;
  <span class="keywordtype">int</span> rep, ncont, cont_sendmin[2], cont_sendmax[2], cont_recvmin[2], cont_recvmax[2];
  <span class="keywordtype">int</span> dimx, dimy, dimz, recv_dimx, recv_dimy, recv_dimz;
  MPI_Status status;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;Starting periodic PM calculation.\n&quot;</span>);
      fflush(stdout);
    }

  asmth2 = (2 * M_PI) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3bf3f2dd9be45f8f203424e57b9d9de3">Asmth</a>[0] / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  asmth2 *= asmth2;

  fac = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a> / (M_PI * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>);   <span class="comment">/* to get potential */</span>

  <a class="code" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888">force_treefree</a>();

  <span class="comment">/* first, establish the extension of the local patch in the PMGRID  */</span>

  <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
    {
      meshmin[j] = PMGRID;
      meshmax[j] = 0;
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
        {
          slab = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[j];
          <span class="keywordflow">if</span>(slab &gt;= PMGRID)
            slab = PMGRID - 1;

          <span class="keywordflow">if</span>(slab &lt; meshmin[j])
            meshmin[j] = slab;

          <span class="keywordflow">if</span>(slab &gt; meshmax[j])
            meshmax[j] = slab;
        }
    }

  MPI_Allgather(meshmin, 3, MPI_INT, <a class="code" href="pm__periodic_8c.html#a0bdf8c7e2cab6c38a4357cf4817e7cbf">meshmin_list</a>, 3, MPI_INT, MPI_COMM_WORLD);
  MPI_Allgather(meshmax, 3, MPI_INT, <a class="code" href="pm__periodic_8c.html#aee0d2641b59b02dd9f5ed3070784d995">meshmax_list</a>, 3, MPI_INT, MPI_COMM_WORLD);

  dimx = meshmax[0] - meshmin[0] + 2;
  dimy = meshmax[1] - meshmin[1] + 2;
  dimz = meshmax[2] - meshmin[2] + 2;

  <a class="code" href="pm__periodic_8c.html#acb5c64377fad9e1a34bad88fb7c61a3e">pm_init_periodic_allocate</a>((dimx + 4) * (dimy + 4) * (dimz + 4));

  <span class="keywordflow">for</span>(i = 0; i &lt; dimx * dimy * dimz; i++)
    <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[i] = 0;

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    {
      slab_x = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
      <span class="keywordflow">if</span>(slab_x &gt;= PMGRID)
        slab_x = PMGRID - 1;
      dx = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - slab_x;
      slab_x -= meshmin[0];
      slab_xx = slab_x + 1;

      slab_y = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
      <span class="keywordflow">if</span>(slab_y &gt;= PMGRID)
        slab_y = PMGRID - 1;
      dy = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - slab_y;
      slab_y -= meshmin[1];
      slab_yy = slab_y + 1;

      slab_z = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
      <span class="keywordflow">if</span>(slab_z &gt;= PMGRID)
        slab_z = PMGRID - 1;
      dz = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - slab_z;
      slab_z -= meshmin[2];
      slab_zz = slab_z + 1;

      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_x * dimy + slab_y) * dimz + slab_z] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (1.0 - dx) * (1.0 - dy) * (1.0 - dz);
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_x * dimy + slab_yy) * dimz + slab_z] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (1.0 - dx) * dy * (1.0 - dz);
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_x * dimy + slab_y) * dimz + slab_zz] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (1.0 - dx) * (1.0 - dy) * dz;
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_x * dimy + slab_yy) * dimz + slab_zz] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (1.0 - dx) * dy * dz;

      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_xx * dimy + slab_y) * dimz + slab_z] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (dx) * (1.0 - dy) * (1.0 - dz);
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_xx * dimy + slab_yy) * dimz + slab_z] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (dx) * dy * (1.0 - dz);
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_xx * dimy + slab_y) * dimz + slab_zz] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (dx) * (1.0 - dy) * dz;
      <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[(slab_xx * dimy + slab_yy) * dimz + slab_zz] += <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].Mass * (dx) * dy * dz;
    }


  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="pm__periodic_8c.html#a7575000a7b0c6532786de0ac15da4052">fftsize</a>; i++)  <span class="comment">/* clear local density field */</span>
    <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>[i] = 0;

  <span class="keywordflow">for</span>(level = 0; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++) <span class="comment">/* note: for level=0, target is the same task */</span>
    {
      sendTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>;
      recvTask = <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> ^ level;
      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        {
          <span class="comment">/* check how much we have to send */</span>
          sendmin = 2 * PMGRID;
          sendmax = -1;
          <span class="keywordflow">for</span>(slab_x = meshmin[0]; slab_x &lt; meshmax[0] + 2; slab_x++)
            <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[slab_x % PMGRID] == recvTask)
              {
                <span class="keywordflow">if</span>(slab_x &lt; sendmin)
                  sendmin = slab_x;
                <span class="keywordflow">if</span>(slab_x &gt; sendmax)
                  sendmax = slab_x;
              }
          <span class="keywordflow">if</span>(sendmax == -1)
            sendmin = 0;

          <span class="comment">/* check how much we have to receive */</span>
          recvmin = 2 * PMGRID;
          recvmax = -1;
          <span class="keywordflow">for</span>(slab_x = <a class="code" href="pm__periodic_8c.html#a0bdf8c7e2cab6c38a4357cf4817e7cbf">meshmin_list</a>[3 * recvTask]; slab_x &lt; <a class="code" href="pm__periodic_8c.html#aee0d2641b59b02dd9f5ed3070784d995">meshmax_list</a>[3 * recvTask] + 2; slab_x++)
            <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[slab_x % PMGRID] == sendTask)
              {
                <span class="keywordflow">if</span>(slab_x &lt; recvmin)
                  recvmin = slab_x;
                <span class="keywordflow">if</span>(slab_x &gt; recvmax)
                  recvmax = slab_x;
              }
          <span class="keywordflow">if</span>(recvmax == -1)
            recvmin = 0;


          <span class="keywordflow">if</span>((recvmax - recvmin) &gt;= 0 || (sendmax - sendmin) &gt;= 0)      <span class="comment">/* ok, we have a contribution to the slab */</span>
            {
              recv_dimx = meshmax_list[3 * recvTask + 0] - <a class="code" href="pm__periodic_8c.html#a0bdf8c7e2cab6c38a4357cf4817e7cbf">meshmin_list</a>[3 * recvTask + 0] + 2;
              recv_dimy = meshmax_list[3 * recvTask + 1] - meshmin_list[3 * recvTask + 1] + 2;
              recv_dimz = meshmax_list[3 * recvTask + 2] - meshmin_list[3 * recvTask + 2] + 2;

              <span class="keywordflow">if</span>(level &gt; 0)
                {
                  MPI_Sendrecv(<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> + (sendmin - meshmin[0]) * dimy * dimz,
                               (sendmax - sendmin + 1) * dimy * dimz * <span class="keyword">sizeof</span>(fftw_real), MPI_BYTE, recvTask,
                               <a class="code" href="tags_8h.html#a610ba4f94d6150970c21c76fa9a22af1">TAG_PERIODIC_C</a>, <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>,
                               (recvmax - recvmin + 1) * recv_dimy * recv_dimz * <span class="keyword">sizeof</span>(fftw_real), MPI_BYTE,
                               recvTask, <a class="code" href="tags_8h.html#a610ba4f94d6150970c21c76fa9a22af1">TAG_PERIODIC_C</a>, MPI_COMM_WORLD, &amp;status);
                }
              <span class="keywordflow">else</span>
                {
                  memcpy(<a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>, <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> + (sendmin - meshmin[0]) * dimy * dimz,
                         (sendmax - sendmin + 1) * dimy * dimz * <span class="keyword">sizeof</span>(fftw_real));
                }

              <span class="keywordflow">for</span>(slab_x = recvmin; slab_x &lt;= recvmax; slab_x++)
                {
                  slab_xx = (slab_x % PMGRID) - <a class="code" href="pm__periodic_8c.html#a8b608f18c44e494650da5577ddb34082">first_slab_of_task</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>];

                  <span class="keywordflow">if</span>(slab_xx &gt;= 0 &amp;&amp; slab_xx &lt; <a class="code" href="pm__periodic_8c.html#ad054897488b61bb22501d6ad4b01e6c8">slabs_per_task</a>[<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>])
                    {
                      <span class="keywordflow">for</span>(slab_y = meshmin_list[3 * recvTask + 1];
                          slab_y &lt;= meshmax_list[3 * recvTask + 1] + 1; slab_y++)
                        {
                          slab_yy = slab_y;
                          <span class="keywordflow">if</span>(slab_yy &gt;= PMGRID)
                            slab_yy -= PMGRID;

                          <span class="keywordflow">for</span>(slab_z = meshmin_list[3 * recvTask + 2];
                              slab_z &lt;= meshmax_list[3 * recvTask + 2] + 1; slab_z++)
                            {
                              slab_zz = slab_z;
                              <span class="keywordflow">if</span>(slab_zz &gt;= PMGRID)
                                slab_zz -= PMGRID;

                              <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>[PMGRID * <a class="code" href="pm__periodic_8c.html#a8a4d19d2948b1d7b3eff694719e5f436">PMGRID2</a> * slab_xx + <a class="code" href="pm__periodic_8c.html#a8a4d19d2948b1d7b3eff694719e5f436">PMGRID2</a> * slab_yy + slab_zz] +=
                                <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[((slab_x - recvmin) * recv_dimy +
                                           (slab_y - meshmin_list[3 * recvTask + 1])) * recv_dimz +
                                          (slab_z - meshmin_list[3 * recvTask + 2])];
                            }
                        }
                    }
                }
            }
        }
    }



  <span class="comment">/* Do the FFT of the density field */</span>

  rfftwnd_mpi(<a class="code" href="pm__periodic_8c.html#ada1bb88285e667f67d30ddac8c9fa924">fft_forward_plan</a>, 1, <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>, <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>, FFTW_TRANSPOSED_ORDER);

  <span class="comment">/* multiply with Green&#39;s function for the potential */</span>

  <span class="keywordflow">for</span>(y = <a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a>; y &lt; <a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a> + <a class="code" href="pm__periodic_8c.html#ae33694d88449fd0eb1d291ac33498ac1">nslab_y</a>; y++)
    <span class="keywordflow">for</span>(x = 0; x &lt; PMGRID; x++)
      <span class="keywordflow">for</span>(z = 0; z &lt; PMGRID / 2 + 1; z++)
        {
          <span class="keywordflow">if</span>(x &gt; PMGRID / 2)
            kx = x - PMGRID;
          <span class="keywordflow">else</span>
            kx = x;
          <span class="keywordflow">if</span>(y &gt; PMGRID / 2)
            ky = y - PMGRID;
          <span class="keywordflow">else</span>
            ky = y;
          <span class="keywordflow">if</span>(z &gt; PMGRID / 2)
            kz = z - PMGRID;
          <span class="keywordflow">else</span>
            kz = z;

          k2 = kx * kx + ky * ky + kz * kz;

          <span class="keywordflow">if</span>(k2 &gt; 0)
            {
              smth = -exp(-k2 * asmth2) / k2 * fac;
              <span class="comment">/* do deconvolution */</span>
              fx = fy = fz = 1;
              <span class="keywordflow">if</span>(kx != 0)
                {
                  fx = (M_PI * kx) / PMGRID;
                  fx = sin(fx) / fx;
                }
              <span class="keywordflow">if</span>(ky != 0)
                {
                  fy = (M_PI * ky) / PMGRID;
                  fy = sin(fy) / fy;
                }
              <span class="keywordflow">if</span>(kz != 0)
                {
                  fz = (M_PI * kz) / PMGRID;
                  fz = sin(fz) / fz;
                }
              ff = 1 / (fx * fy * fz);
              smth *= ff * ff * ff * ff;
              <span class="comment">/* end deconvolution */</span>

              ip = PMGRID * (PMGRID / 2 + 1) * (y - <a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a>) + (PMGRID / 2 + 1) * x + z;
              <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a>[ip].re *= smth;
              <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a>[ip].im *= smth;
            }
        }

  <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#a17e825b584286e00d2e435dff44af196">slabstart_y</a> == 0)
    <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a>[0].re = <a class="code" href="pm__periodic_8c.html#a8f0b56ad473150630454fbceefe2c1e7">fft_of_rhogrid</a>[0].im = 0.0;

  <span class="comment">/* Do the FFT to get the potential */</span>

  rfftwnd_mpi(<a class="code" href="pm__periodic_8c.html#affe0aa143bfd852f161120fe9a09f285">fft_inverse_plan</a>, 1, <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>, <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>, FFTW_TRANSPOSED_ORDER);

  <span class="comment">/* note: &quot;rhogrid&quot; now contains the potential */</span>



  dimx = meshmax[0] - meshmin[0] + 6;
  dimy = meshmax[1] - meshmin[1] + 6;
  dimz = meshmax[2] - meshmin[2] + 6;

  <span class="keywordflow">for</span>(level = 0; level &lt; (1 &lt;&lt; <a class="code" href="allvars_8c.html#a9a18606803f69f24d3cb2864640c122e">PTask</a>); level++) <span class="comment">/* note: for level=0, target is the same task */</span>
    {
      sendTask = ThisTask;
      recvTask = ThisTask ^ level;

      <span class="keywordflow">if</span>(recvTask &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
        {

          <span class="comment">/* check how much we have to send */</span>
          sendmin = 2 * PMGRID;
          sendmax = -PMGRID;
          <span class="keywordflow">for</span>(slab_x = meshmin_list[3 * recvTask] - 2; slab_x &lt; meshmax_list[3 * recvTask] + 4; slab_x++)
            <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] == sendTask)
              {
                <span class="keywordflow">if</span>(slab_x &lt; sendmin)
                  sendmin = slab_x;
                <span class="keywordflow">if</span>(slab_x &gt; sendmax)
                  sendmax = slab_x;
              }
          <span class="keywordflow">if</span>(sendmax == -PMGRID)
            sendmin = sendmax + 1;


          <span class="comment">/* check how much we have to receive */</span>
          recvmin = 2 * PMGRID;
          recvmax = -PMGRID;
          <span class="keywordflow">for</span>(slab_x = meshmin[0] - 2; slab_x &lt; meshmax[0] + 4; slab_x++)
            <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] == recvTask)
              {
                <span class="keywordflow">if</span>(slab_x &lt; recvmin)
                  recvmin = slab_x;
                <span class="keywordflow">if</span>(slab_x &gt; recvmax)
                  recvmax = slab_x;
              }
          <span class="keywordflow">if</span>(recvmax == -PMGRID)
            recvmin = recvmax + 1;

          <span class="keywordflow">if</span>((recvmax - recvmin) &gt;= 0 || (sendmax - sendmin) &gt;= 0)      <span class="comment">/* ok, we have a contribution to the slab */</span>
            {
              recv_dimx = meshmax_list[3 * recvTask + 0] - meshmin_list[3 * recvTask + 0] + 6;
              recv_dimy = meshmax_list[3 * recvTask + 1] - meshmin_list[3 * recvTask + 1] + 6;
              recv_dimz = meshmax_list[3 * recvTask + 2] - meshmin_list[3 * recvTask + 2] + 6;

              ncont = 1;
              cont_sendmin[0] = sendmin;
              cont_sendmax[0] = sendmax;
              cont_sendmin[1] = sendmax + 1;
              cont_sendmax[1] = sendmax;

              cont_recvmin[0] = recvmin;
              cont_recvmax[0] = recvmax;
              cont_recvmin[1] = recvmax + 1;
              cont_recvmax[1] = recvmax;

              <span class="keywordflow">for</span>(slab_x = sendmin; slab_x &lt;= sendmax; slab_x++)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] != ThisTask)
                    {
                      <span class="comment">/* non-contiguous */</span>
                      cont_sendmax[0] = slab_x - 1;
                      <span class="keywordflow">while</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] != ThisTask)
                        slab_x++;
                      cont_sendmin[1] = slab_x;
                      ncont++;
                    }
                }

              <span class="keywordflow">for</span>(slab_x = recvmin; slab_x &lt;= recvmax; slab_x++)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] != recvTask)
                    {
                      <span class="comment">/* non-contiguous */</span>
                      cont_recvmax[0] = slab_x - 1;
                      <span class="keywordflow">while</span>(<a class="code" href="pm__periodic_8c.html#af5fc4d76c1156f1aabbfa15968b9ad4c">slab_to_task</a>[(slab_x + PMGRID) % PMGRID] != recvTask)
                        slab_x++;
                      cont_recvmin[1] = slab_x;
                      <span class="keywordflow">if</span>(ncont == 1)
                        ncont++;
                    }
                }


              <span class="keywordflow">for</span>(rep = 0; rep &lt; ncont; rep++)
                {
                  sendmin = cont_sendmin[rep];
                  sendmax = cont_sendmax[rep];
                  recvmin = cont_recvmin[rep];
                  recvmax = cont_recvmax[rep];

                  <span class="comment">/* prepare what we want to send */</span>
                  <span class="keywordflow">if</span>(sendmax - sendmin &gt;= 0)
                    {
                      <span class="keywordflow">for</span>(slab_x = sendmin; slab_x &lt;= sendmax; slab_x++)
                        {
                          slab_xx = ((slab_x + PMGRID) % PMGRID) - <a class="code" href="pm__periodic_8c.html#a8b608f18c44e494650da5577ddb34082">first_slab_of_task</a>[ThisTask];

                          <span class="keywordflow">for</span>(slab_y = meshmin_list[3 * recvTask + 1] - 2;
                              slab_y &lt; meshmax_list[3 * recvTask + 1] + 4; slab_y++)
                            {
                              slab_yy = (slab_y + PMGRID) % PMGRID;

                              <span class="keywordflow">for</span>(slab_z = meshmin_list[3 * recvTask + 2] - 2;
                                  slab_z &lt; meshmax_list[3 * recvTask + 2] + 4; slab_z++)
                                {
                                  slab_zz = (slab_z + PMGRID) % PMGRID;

                                  <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[((slab_x - sendmin) * recv_dimy +
                                             (slab_y - (meshmin_list[3 * recvTask + 1] - 2))) * recv_dimz +
                                            slab_z - (meshmin_list[3 * recvTask + 2] - 2)] =
                                    <a class="code" href="pm__periodic_8c.html#a07a721ff607175c756095575f9c14fe3">rhogrid</a>[PMGRID * <a class="code" href="pm__periodic_8c.html#a8a4d19d2948b1d7b3eff694719e5f436">PMGRID2</a> * slab_xx + <a class="code" href="pm__periodic_8c.html#a8a4d19d2948b1d7b3eff694719e5f436">PMGRID2</a> * slab_yy + slab_zz];
                                }
                            }
                        }
                    }

                  <span class="keywordflow">if</span>(level &gt; 0)
                    {
                      MPI_Sendrecv(<a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>,
                                   (sendmax - sendmin + 1) * recv_dimy * recv_dimz * <span class="keyword">sizeof</span>(fftw_real),
                                   MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a0434224ef1101b06dd3142342582069a">TAG_PERIODIC_D</a>,
                                   <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> + (recvmin - (meshmin[0] - 2)) * dimy * dimz,
                                   (recvmax - recvmin + 1) * dimy * dimz * <span class="keyword">sizeof</span>(fftw_real), MPI_BYTE,
                                   recvTask, <a class="code" href="tags_8h.html#a0434224ef1101b06dd3142342582069a">TAG_PERIODIC_D</a>, MPI_COMM_WORLD, &amp;status);
                    }
                  <span class="keywordflow">else</span>
                    {
                      memcpy(<a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a> + (recvmin - (meshmin[0] - 2)) * dimy * dimz,
                             <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>, (recvmax - recvmin + 1) * dimy * dimz * <span class="keyword">sizeof</span>(fftw_real));
                    }
                }
            }
        }
    }


  dimx = meshmax[0] - meshmin[0] + 2;
  dimy = meshmax[1] - meshmin[1] + 2;
  dimz = meshmax[2] - meshmin[2] + 2;

  recv_dimx = meshmax[0] - meshmin[0] + 6;
  recv_dimy = meshmax[1] - meshmin[1] + 6;
  recv_dimz = meshmax[2] - meshmin[2] + 6;



  <span class="keywordflow">for</span>(x = 0; x &lt; meshmax[0] - meshmin[0] + 2; x++)
    <span class="keywordflow">for</span>(y = 0; y &lt; meshmax[1] - meshmin[1] + 2; y++)
      <span class="keywordflow">for</span>(z = 0; z &lt; meshmax[2] - meshmin[2] + 2; z++)
        {
          <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(x * dimy + y) * dimz + z] =
            <a class="code" href="pm__periodic_8c.html#a182a8913bc59d672bb2a85e63ffcde0f">workspace</a>[((x + 2) * recv_dimy + (y + 2)) * recv_dimz + (z + 2)];
        }


  <span class="comment">/* read out the potential */</span>

  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
    {
      slab_x = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0];
      <span class="keywordflow">if</span>(slab_x &gt;= PMGRID)
        slab_x = PMGRID - 1;
      dx = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[0] - slab_x;
      slab_x -= meshmin[0];
      slab_xx = slab_x + 1;

      slab_y = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1];
      <span class="keywordflow">if</span>(slab_y &gt;= PMGRID)
        slab_y = PMGRID - 1;
      dy = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[1] - slab_y;
      slab_y -= meshmin[1];
      slab_yy = slab_y + 1;

      slab_z = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2];
      <span class="keywordflow">if</span>(slab_z &gt;= PMGRID)
        slab_z = PMGRID - 1;
      dz = <a class="code" href="pm__periodic_8c.html#a2a1ee0c9996dcb96caf409aacc6888cd">to_slab_fac</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a764ffe35d82a64065f585e3a84263dd1">Pos</a>[2] - slab_z;
      slab_z -= meshmin[2];
      slab_zz = slab_z + 1;

      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> +=
        <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_x * dimy + slab_y) * dimz + slab_z] * (1.0 - dx) * (1.0 - dy) * (1.0 - dz);
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_x * dimy + slab_yy) * dimz + slab_z] * (1.0 - dx) * dy * (1.0 - dz);
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_x * dimy + slab_y) * dimz + slab_zz] * (1.0 - dx) * (1.0 - dy) * dz;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_x * dimy + slab_yy) * dimz + slab_zz] * (1.0 - dx) * dy * dz;

      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_xx * dimy + slab_y) * dimz + slab_z] * (dx) * (1.0 - dy) * (1.0 - dz);
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_xx * dimy + slab_yy) * dimz + slab_z] * (dx) * dy * (1.0 - dz);
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_xx * dimy + slab_y) * dimz + slab_zz] * (dx) * (1.0 - dy) * dz;
      <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9d45a0cefc6121831905e169072550d0">Potential</a> += <a class="code" href="pm__periodic_8c.html#afa4a65b248baddbf9f8c388a48a1787f">forcegrid</a>[(slab_xx * dimy + slab_yy) * dimz + slab_zz] * (dx) * dy * dz;
    }

  <a class="code" href="pm__periodic_8c.html#a259e6f8400ee889c64bc667334060742">pm_init_periodic_free</a>();
  <a class="code" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>);

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;

  <span class="keywordflow">if</span>(ThisTask == 0)
    {
      printf(<span class="stringliteral">&quot;done PM-Potential.\n&quot;</span>);
      fflush(stdout);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a7938f2181f23d56ac46f3625d1a855a0_cgraph.png" border="0" usemap="#proto_8h_a7938f2181f23d56ac46f3625d1a855a0_cgraph" alt=""/></div>
<map name="proto_8h_a7938f2181f23d56ac46f3625d1a855a0_cgraph" id="proto_8h_a7938f2181f23d56ac46f3625d1a855a0_cgraph">
<area shape="rect" id="node3" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="235,5,371,35"/><area shape="rect" id="node9" href="forcetree_8c.html#a0a9667f530dad09ebed8c0c98e5d3888" title="force_treefree" alt="" coords="247,59,359,88"/><area shape="rect" id="node11" href="pm__periodic_8c.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="212,112,393,141"/><area shape="rect" id="node16" href="pm__periodic_8c.html#a259e6f8400ee889c64bc667334060742" title="pm_init_periodic_free" alt="" coords="224,165,381,195"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="443,32,509,61"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="557,32,715,61"/><area shape="rect" id="node14" href="proto_8h.html#a05ba897ffe0dfe737254a09c91c50d10" title="imax" alt="" coords="449,112,503,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a7938f2181f23d56ac46f3625d1a855a0_icgraph.png" border="0" usemap="#proto_8h_a7938f2181f23d56ac46f3625d1a855a0_icgraph" alt=""/></div>
<map name="proto_8h_a7938f2181f23d56ac46f3625d1a855a0_icgraph" id="proto_8h_a7938f2181f23d56ac46f3625d1a855a0_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="212,32,353,61"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="403,5,621,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="669,32,712,61"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="761,32,815,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a96ae9abed439401fd6dd28a1e2c2f94e"></a><!-- doxytag: member="proto.h::pow" ref="a96ae9abed439401fd6dd28a1e2c2f94e" args="(double, double)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double pow </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="global_8c_source.html#l00022">compute_global_quantities_of_system()</a>, <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="density_8c_source.html#l00056">density()</a>, <a class="el" href="io_8c_source.html#l00129">fill_write_buffer()</a>, <a class="el" href="timestep_8c_source.html#l00566">find_dt_displacement_constraint()</a>, <a class="el" href="driftfac_8c_source.html#l00214">growthfactor_integ()</a>, <a class="el" href="hydra_8c_source.html#l00050">hydro_force()</a>, <a class="el" href="driftfac_8c_source.html#l00204">hydrokick_integ()</a>, <a class="el" href="init_8c_source.html#l00020">init()</a>, <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>, <a class="el" href="begrun_8c_source.html#l00154">set_units()</a>, <a class="el" href="init_8c_source.html#l00199">setup_smoothinglengths()</a>, and <a class="el" href="system_8c_source.html#l00070">timediff()</a>.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a96ae9abed439401fd6dd28a1e2c2f94e_icgraph.png" border="0" usemap="#proto_8h_a96ae9abed439401fd6dd28a1e2c2f94e_icgraph" alt=""/></div>
<map name="proto_8h_a96ae9abed439401fd6dd28a1e2c2f94e_icgraph" id="proto_8h_a96ae9abed439401fd6dd28a1e2c2f94e_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="379,222,587,252"/><area shape="rect" id="node9" href="proto_8h.html#ada58109949c2431ca9b0cdaa01cfb5b1" title="compute_global_quantities_of_system" alt="" coords="635,373,901,402"/><area shape="rect" id="node14" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="697,848,839,877"/><area shape="rect" id="node20" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="449,326,516,356"/><area shape="rect" id="node25" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="679,192,857,221"/><area shape="rect" id="node27" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1039,192,1079,221"/><area shape="rect" id="node32" href="proto_8h.html#aea8fa222a10c4796687c6ff25550cd74" title="fill_write_buffer" alt="" coords="159,693,273,722"/><area shape="rect" id="node40" href="timestep_8c.html#a78ed439b8a1cb93647a2b9de998d9269" title="find_dt_displacement_constraint" alt="" coords="101,222,331,252"/><area shape="rect" id="node43" href="driftfac_8c.html#a9690d42f31f3e278745a9e19b5a0ec6f" title="growthfactor_integ" alt="" coords="145,478,287,508"/><area shape="rect" id="node45" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="435,380,531,409"/><area shape="rect" id="node48" href="proto_8h.html#a5ebdee2c7332bed6c1a8994ac3c38c0d" title="hydrokick_integ" alt="" coords="156,590,276,620"/><area shape="rect" id="node51" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="424,948,541,977"/><area shape="rect" id="node54" href="proto_8h.html#aba986f6be1d66945199c7ea43e5c9610" title="set_units" alt="" coords="1019,104,1099,133"/><area shape="rect" id="node58" href="system_8c.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="181,537,251,566"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1228,614,1271,644"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1332,614,1385,644"/><area shape="rect" id="node11" href="run_8c.html#ae903322da17c6875ab606b032b918099" title="energy_statistics" alt="" coords="993,410,1124,440"/><area shape="rect" id="node16" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="949,745,1168,774"/><area shape="rect" id="node22" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="683,465,853,494"/><area shape="rect" id="node29" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1216,192,1283,221"/><area shape="rect" id="node34" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="444,742,521,772"/><area shape="rect" id="node36" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="713,693,823,722"/><area shape="rect" id="node64" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="681,640,855,669"/><area shape="rect" id="node70" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="419,484,547,513"/><area shape="rect" id="node73" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="433,537,532,566"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="affd0f4e6b7bcdabf7d6f8191145f78d1"></a><!-- doxytag: member="proto.h::read_file" ref="affd0f4e6b7bcdabf7d6f8191145f78d1" args="(char *fname, int readTask, int lastTask)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void read_file </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>readTask</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>lastTask</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function reads a snapshot file and distributes the data it contains to tasks 'readTask' to 'lastTask'. </p>

<p><p>&lt; total number of defined 0 0 for snapshot files. Must be equal to the number of entries in "enum iofields" </p>
</p>

<p>Definition at line <a class="el" href="read__ic_8c_source.html#l00244">244</a> of file <a class="el" href="read__ic_8c_source.html">read_ic.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allocate_8c_source.html#l00103">allocate_memory()</a>, <a class="el" href="io_8c_source.html#l00532">blockpresent()</a>, <a class="el" href="allvars_8h_source.html#l00288">global_data_all_processes::BufferSize</a>, <a class="el" href="allvars_8c_source.html#l00102">CommBuffer</a>, <a class="el" href="read__ic_8c_source.html#l00168">empty_read_buffer()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="io_8c_source.html#l00366">get_bytes_per_blockelement()</a>, <a class="el" href="io_8c_source.html#l00613">get_dataset_name()</a>, <a class="el" href="io_8c_source.html#l00405">get_datatype_in_block()</a>, <a class="el" href="io_8c_source.html#l00465">get_particles_in_block()</a>, <a class="el" href="io_8c_source.html#l00432">get_values_per_blockelement()</a>, <a class="el" href="allvars_8c_source.html#l00162">header</a>, <a class="el" href="allvars_8h_source.html#l00280">global_data_all_processes::ICFormat</a>, <a class="el" href="allvars_8h_source.html#l00665">IO_U</a>, <a class="el" href="allvars_8h_source.html#l00633">io_header::mass</a>, <a class="el" href="allvars_8h_source.html#l00481">global_data_all_processes::MassTable</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00276">global_data_all_processes::MaxPartSph</a>, <a class="el" href="io_8c_source.html#l01139">my_fread()</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8h_source.html#l00632">io_header::npart</a>, <a class="el" href="allvars_8h_source.html#l00639">io_header::npartTotal</a>, <a class="el" href="allvars_8h_source.html#l00649">io_header::npartTotalHighWord</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00642">io_header::num_files</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00294">global_data_all_processes::PartAllocFactor</a>, <a class="el" href="read__ic_8c_source.html#l00764">read_header_attributes_in_hdf5()</a>, <a class="el" href="allvars_8c_source.html#l00030">RestartFlag</a>, <a class="el" href="allvars_8c_source.html#l00167">Tab_IO_Labels</a>, <a class="el" href="tags_8h_source.html#l00006">TAG_HEADER</a>, <a class="el" href="tags_8h_source.html#l00007">TAG_PDATA</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00635">io_header::time</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00370">global_data_all_processes::TimeBegin</a>, <a class="el" href="allvars_8h_source.html#l00273">global_data_all_processes::TotN_gas</a>, and <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00031">read_ic()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> blockmaxlen;
  <span class="keywordtype">int</span> i, n_in_file, n_for_this_task, ntask, pc, offset = 0, task;
  <span class="keywordtype">int</span> blksize1, blksize2;
  MPI_Status status;
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a> = 0;
  <span class="keywordtype">int</span> nall;
  <span class="keywordtype">int</span> type;
  <span class="keywordtype">char</span> label[4];
  <span class="keywordtype">int</span> nstart, bytes_per_blockelement, npart, nextblock, typelist[6];
  <span class="keyword">enum</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr;

<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>  <span class="keywordtype">char</span> buf[500];
  <span class="keywordtype">int</span> rank, pcsum;
  hid_t hdf5_file, hdf5_grp[6], hdf5_dataspace_in_file;
  hid_t hdf5_datatype, hdf5_dataspace_in_memory, hdf5_dataset;
  hsize_t dims[2], count[2], start[2];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define SKIP  {my_fread(&amp;blksize1,sizeof(int),1,fd);}</span>
<span class="preprocessor"></span><span class="preprocessor">#define SKIP2  {my_fread(&amp;blksize2,sizeof(int),1,fd);}</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == readTask)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
        {
          <span class="keywordflow">if</span>(!(fd = fopen(fname, <span class="stringliteral">&quot;r&quot;</span>)))
            {
              printf(<span class="stringliteral">&quot;can&#39;t open file `%s&#39; for reading initial conditions.\n&quot;</span>, fname);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(123);
            }

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
            {
              SKIP;
              <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;label, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 4, fd);
              <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;nextblock, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, fd);
              printf(<span class="stringliteral">&quot;Reading header =&gt; &#39;%c%c%c%c&#39; (%d byte)\n&quot;</span>, label[0], label[1], label[2], label[3],
                     nextblock);
              SKIP2;
            }

          SKIP;
          <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>), 1, fd);
          SKIP2;

          <span class="keywordflow">if</span>(blksize1 != 256 || blksize2 != 256)
            {
              printf(<span class="stringliteral">&quot;incorrect header format\n&quot;</span>);
              fflush(stdout);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(890);
            }
        }


<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
        {
          <a class="code" href="proto_8h.html#af87c21a0c70ac5e7d5f769b952d08fe9">read_header_attributes_in_hdf5</a>(fname);

          hdf5_file = H5Fopen(fname, H5F_ACC_RDONLY, H5P_DEFAULT);

          <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type] &gt; 0)
                {
                  sprintf(buf, <span class="stringliteral">&quot;/PartType%d&quot;</span>, type);
                  hdf5_grp[type] = H5Gopen(hdf5_file, buf);
                }
            }
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      <span class="keywordflow">for</span>(task = readTask + 1; task &lt;= lastTask; task++)
        MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>), MPI_BYTE, task, <a class="code" href="tags_8h.html#a048ec72bf4150a4d7d2aa377a18d6cb8">TAG_HEADER</a>, MPI_COMM_WORLD);
    }
  <span class="keywordflow">else</span>
    MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>), MPI_BYTE, readTask, <a class="code" href="tags_8h.html#a048ec72bf4150a4d7d2aa377a18d6cb8">TAG_HEADER</a>, MPI_COMM_WORLD, &amp;status);


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> == 0)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a> &lt;= 1)
        <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
          <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[i] = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[i];

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2bb70816a4d5f56e0df2d9b8d706cef2">TotN_gas</a> = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[0] + (((<span class="keywordtype">long</span> <span class="keywordtype">long</span>) <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a56f54a68fe289b19902b3c4c561a7159">npartTotalHighWord</a>[0]) &lt;&lt; 32);

      <span class="keywordflow">for</span>(i = 0, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> = 0; i &lt; 6; i++)
        {
          <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> += <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[i];
          <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> += (((<span class="keywordtype">long</span> long) <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a56f54a68fe289b19902b3c4c561a7159">npartTotalHighWord</a>[i]) &lt;&lt; 32);
        }


      <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[i] = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a2c387b0c7c823287d424fedc70175917">mass</a>[i];

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a> * (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> / <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);     <span class="comment">/* sets the maximum number of particles that may */</span>
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a> * (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2bb70816a4d5f56e0df2d9b8d706cef2">TotN_gas</a> / <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);    <span class="comment">/* sets the maximum number of particles that may </span>
<span class="comment">                                                                           reside on a processor */</span>
      <a class="code" href="allocate_8c.html#a7fe5e304baaf5f418a22fef9a9cc02c7">allocate_memory</a>();

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 2)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a> = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad6237959a3590772366f18000a47a7d6">time</a>;
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == readTask)
    {
      <span class="keywordflow">for</span>(i = 0, n_in_file = 0; i &lt; 6; i++)
        n_in_file += <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[i];

      printf(<span class="stringliteral">&quot;\nreading file `%s&#39; on task=%d (contains %d particles.)\n&quot;</span>
             <span class="stringliteral">&quot;distributing this file to tasks %d-%d\n&quot;</span>
             <span class="stringliteral">&quot;Type 0 (gas):   %8d  (tot=%6d%09d) masstab=%g\n&quot;</span>
             <span class="stringliteral">&quot;Type 1 (halo):  %8d  (tot=%6d%09d) masstab=%g\n&quot;</span>
             <span class="stringliteral">&quot;Type 2 (disk):  %8d  (tot=%6d%09d) masstab=%g\n&quot;</span>
             <span class="stringliteral">&quot;Type 3 (bulge): %8d  (tot=%6d%09d) masstab=%g\n&quot;</span>
             <span class="stringliteral">&quot;Type 4 (stars): %8d  (tot=%6d%09d) masstab=%g\n&quot;</span>
             <span class="stringliteral">&quot;Type 5 (bndry): %8d  (tot=%6d%09d) masstab=%g\n\n&quot;</span>, fname, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, n_in_file, readTask,
             lastTask, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[0], (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[0] / 1000000000),
             (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[0] % 1000000000), <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[0], <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[1],
             (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[1] / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[1] % 1000000000),
             <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[1], <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[2], (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[2] / 1000000000),
             (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[2] % 1000000000), <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[2], <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[3],
             (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[3] / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[3] % 1000000000),
             <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[3], <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[4], (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[4] / 1000000000),
             (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[4] % 1000000000), <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[4], <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[5],
             (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[5] / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[5] % 1000000000),
             <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[5]);
      fflush(stdout);
    }


  ntask = lastTask - readTask + 1;


  <span class="comment">/* to collect the gas particles all at the beginning (in case several</span>
<span class="comment">     snapshot files are read on the current CPU) we move the collisionless</span>
<span class="comment">     particles such that a gap of the right size is created */</span>

  <span class="keywordflow">for</span>(type = 0, nall = 0; type &lt; 6; type++)
    {
      n_in_file = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type];

      n_for_this_task = n_in_file / ntask;
      <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> - readTask) &lt; (n_in_file % ntask))
        n_for_this_task++;

      nall += n_for_this_task;
    }

  memmove(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> + nall], &amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>], (<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> - N_gas) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>));
  nstart = N_gas;



  <span class="keywordflow">for</span>(blocknr = 0; blocknr &lt; IO_NBLOCKS; blocknr++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="io_8c.html#ad9c685a2d6d48224bfec61680ce82b1e">blockpresent</a>(blocknr))
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 0 &amp;&amp; blocknr &gt; <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8a942cbf4dca00cd5260edc905f5976682">IO_U</a>)
            <span class="keywordflow">continue</span>;           <span class="comment">/* ignore all other blocks in initial conditions */</span>

          bytes_per_blockelement = <a class="code" href="io_8c.html#a49492470fcccf9d05bf51993f281f16c">get_bytes_per_blockelement</a>(blocknr);

          blockmaxlen = ((int) (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a> * 1024 * 1024)) / bytes_per_blockelement;

          npart = <a class="code" href="io_8c.html#a5ce310b1efc19d96d530c1264fd5eca9">get_particles_in_block</a>(blocknr, &amp;typelist[0]);

          <span class="keywordflow">if</span>(npart &gt; 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == readTask)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
                    {
                      SKIP;
                      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;label, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 4, fd);
                      <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(&amp;nextblock, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, fd);
                      printf(<span class="stringliteral">&quot;Reading header =&gt; &#39;%c%c%c%c&#39; (%d byte)\n&quot;</span>, label[0], label[1], label[2],
                             label[3], nextblock);
                      SKIP2;

                      <span class="keywordflow">if</span>(strncmp(label, <a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[blocknr], 4) != 0)
                        {
                          printf(<span class="stringliteral">&quot;incorrect block-structure!\n&quot;</span>);
                          printf(<span class="stringliteral">&quot;expected &#39;%c%c%c%c&#39; but found &#39;%c%c%c%c&#39;\n&quot;</span>,
                                 label[0], label[1], label[2], label[3],
                                 <a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[blocknr][0], <a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[blocknr][1],
                                 <a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[blocknr][2], <a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[blocknr][3]);
                          fflush(stdout);
                          <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1890);
                        }
                    }

                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
                    SKIP;
                }

              <span class="keywordflow">for</span>(type = 0, offset = 0; type &lt; 6; type++)
                {
                  n_in_file = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type];
<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>                  pcsum = 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                  <span class="keywordflow">if</span>(typelist[type] == 0)
                    {
                      n_for_this_task = n_in_file / ntask;
                      <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> - readTask) &lt; (n_in_file % ntask))
                        n_for_this_task++;

                      offset += n_for_this_task;
                    }
                  <span class="keywordflow">else</span>
                    {
                      <span class="keywordflow">for</span>(task = readTask; task &lt;= lastTask; task++)
                        {
                          n_for_this_task = n_in_file / ntask;
                          <span class="keywordflow">if</span>((task - readTask) &lt; (n_in_file % ntask))
                            n_for_this_task++;

                          <span class="keywordflow">if</span>(task == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> + n_for_this_task &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
                              {
                                printf(<span class="stringliteral">&quot;too many particles\n&quot;</span>);
                                <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1313);
                              }


                          <span class="keywordflow">do</span>
                            {
                              pc = n_for_this_task;

                              <span class="keywordflow">if</span>(pc &gt; blockmaxlen)
                                pc = blockmaxlen;

                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == readTask)
                                {
                                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
                                    <a class="code" href="io_8c.html#a1609620c03f6b0068601735c42e3c660">my_fread</a>(<a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>, bytes_per_blockelement, pc, fd);
<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>                                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
                                    {
                                      <a class="code" href="io_8c.html#a4d30ce1aad9c69d5af676a6a13173686">get_dataset_name</a>(blocknr, buf);
                                      hdf5_dataset = H5Dopen(hdf5_grp[type], buf);

                                      dims[0] = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type];
                                      dims[1] = <a class="code" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f">get_values_per_blockelement</a>(blocknr);
                                      <span class="keywordflow">if</span>(dims[1] == 1)
                                        rank = 1;
                                      <span class="keywordflow">else</span>
                                        rank = 2;

                                      hdf5_dataspace_in_file = H5Screate_simple(rank, dims, NULL);

                                      dims[0] = pc;
                                      hdf5_dataspace_in_memory = H5Screate_simple(rank, dims, NULL);

                                      start[0] = pcsum;
                                      start[1] = 0;

                                      count[0] = pc;
                                      count[1] = <a class="code" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f">get_values_per_blockelement</a>(blocknr);
                                      pcsum += pc;

                                      H5Sselect_hyperslab(hdf5_dataspace_in_file, H5S_SELECT_SET,
                                                          start, NULL, count, NULL);

                                      <span class="keywordflow">switch</span> (<a class="code" href="io_8c.html#acdf59daa02f065452a596cf88b4de1a1">get_datatype_in_block</a>(blocknr))
                                        {
                                        <span class="keywordflow">case</span> 0:
                                          hdf5_datatype = H5Tcopy(H5T_NATIVE_UINT);
                                          <span class="keywordflow">break</span>;
                                        <span class="keywordflow">case</span> 1:
                                          hdf5_datatype = H5Tcopy(H5T_NATIVE_FLOAT);
                                          <span class="keywordflow">break</span>;
                                        <span class="keywordflow">case</span> 2:
                                          hdf5_datatype = H5Tcopy(H5T_NATIVE_UINT64);
                                          <span class="keywordflow">break</span>;
                                        }

                                      H5Dread(hdf5_dataset, hdf5_datatype, hdf5_dataspace_in_memory,
                                              hdf5_dataspace_in_file, H5P_DEFAULT, <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>);

                                      H5Tclose(hdf5_datatype);
                                      H5Sclose(hdf5_dataspace_in_memory);
                                      H5Sclose(hdf5_dataspace_in_file);
                                      H5Dclose(hdf5_dataset);
                                    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                                }

                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == readTask &amp;&amp; task != readTask)
                                MPI_Ssend(<a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>, bytes_per_blockelement * pc, MPI_BYTE, task, <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>,
                                          MPI_COMM_WORLD);

                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> != readTask &amp;&amp; task == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                                MPI_Recv(<a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>, bytes_per_blockelement * pc, MPI_BYTE, readTask,
                                         <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>, MPI_COMM_WORLD, &amp;status);

                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == task)
                                {
                                  <a class="code" href="proto_8h.html#a3757efb7e470353080a128388ccebec9">empty_read_buffer</a>(blocknr, nstart + offset, pc, type);

                                  offset += pc;
                                }

                              n_for_this_task -= pc;
                            }
                          <span class="keywordflow">while</span>(n_for_this_task &gt; 0);
                        }
                    }
                }
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == readTask)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
                    {
                      SKIP2;
                      <span class="keywordflow">if</span>(blksize1 != blksize2)
                        {
                          printf(<span class="stringliteral">&quot;incorrect block-sizes detected!\n&quot;</span>);
                          printf(<span class="stringliteral">&quot;Task=%d   blocknr=%d  blksize1=%d  blksize2=%d\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, blocknr,
                                 blksize1, blksize2);
                          fflush(stdout);
                          <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(1889);
                        }
                    }
                }
            }
        }
    }


  <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
    {
      n_in_file = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type];

      n_for_this_task = n_in_file / ntask;
      <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> - readTask) &lt; (n_in_file % ntask))
        n_for_this_task++;

      <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> += n_for_this_task;

      <span class="keywordflow">if</span>(type == 0)
        N_gas += n_for_this_task;
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == readTask)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 2)
        fclose(fd);
<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
        {
          <span class="keywordflow">for</span>(type = 5; type &gt;= 0; type--)
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type] &gt; 0)
              H5Gclose(hdf5_grp[type]);
          H5Fclose(hdf5_file);
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_affd0f4e6b7bcdabf7d6f8191145f78d1_cgraph.png" border="0" usemap="#proto_8h_affd0f4e6b7bcdabf7d6f8191145f78d1_cgraph" alt=""/></div>
<map name="proto_8h_affd0f4e6b7bcdabf7d6f8191145f78d1_cgraph" id="proto_8h_affd0f4e6b7bcdabf7d6f8191145f78d1_cgraph">
<area shape="rect" id="node3" href="allocate_8c.html#a7fe5e304baaf5f418a22fef9a9cc02c7" title="allocate_memory" alt="" coords="177,5,311,35"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="405,217,472,247"/><area shape="rect" id="node9" href="io_8c.html#ad9c685a2d6d48224bfec61680ce82b1e" title="blockpresent" alt="" coords="192,109,296,139"/><area shape="rect" id="node11" href="proto_8h.html#a3757efb7e470353080a128388ccebec9" title="empty_read_buffer" alt="" coords="173,163,315,192"/><area shape="rect" id="node14" href="io_8c.html#a49492470fcccf9d05bf51993f281f16c" title="get_bytes_per_blockelement" alt="" coords="141,216,347,245"/><area shape="rect" id="node16" href="io_8c.html#a4d30ce1aad9c69d5af676a6a13173686" title="get_dataset_name" alt="" coords="173,269,315,299"/><area shape="rect" id="node18" href="io_8c.html#acdf59daa02f065452a596cf88b4de1a1" title="get_datatype_in_block" alt="" coords="161,323,327,352"/><area shape="rect" id="node20" href="io_8c.html#a5ce310b1efc19d96d530c1264fd5eca9" title="get_particles_in_block" alt="" coords="163,376,325,405"/><area shape="rect" id="node23" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f" title="get_values_per_blockelement" alt="" coords="139,429,349,459"/><area shape="rect" id="node25" href="io_8c.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="203,483,285,512"/><area shape="rect" id="node28" href="proto_8h.html#af87c21a0c70ac5e7d5f769b952d08fe9" title="read_header_attributes_in_hdf5" alt="" coords="132,536,356,565"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="520,217,677,247"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_affd0f4e6b7bcdabf7d6f8191145f78d1_icgraph.png" border="0" usemap="#proto_8h_affd0f4e6b7bcdabf7d6f8191145f78d1_icgraph" alt=""/></div>
<map name="proto_8h_affd0f4e6b7bcdabf7d6f8191145f78d1_icgraph" id="proto_8h_affd0f4e6b7bcdabf7d6f8191145f78d1_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="132,5,199,35"/><area shape="rect" id="node5" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="249,5,289,35"/><area shape="rect" id="node7" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="339,5,405,35"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="455,5,508,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af87c21a0c70ac5e7d5f769b952d08fe9"></a><!-- doxytag: member="proto.h::read_header_attributes_in_hdf5" ref="af87c21a0c70ac5e7d5f769b952d08fe9" args="(char *fname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void read_header_attributes_in_hdf5 </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fname</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function reads the header information in case the HDF5 file format is used. </p>

<p>Definition at line <a class="el" href="read__ic_8c_source.html#l00764">764</a> of file <a class="el" href="read__ic_8c_source.html">read_ic.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00650">io_header::flag_entropy_instead_u</a>, <a class="el" href="allvars_8c_source.html#l00162">header</a>, <a class="el" href="allvars_8h_source.html#l00633">io_header::mass</a>, <a class="el" href="allvars_8h_source.html#l00632">io_header::npart</a>, <a class="el" href="allvars_8h_source.html#l00639">io_header::npartTotal</a>, <a class="el" href="allvars_8h_source.html#l00649">io_header::npartTotalHighWord</a>, <a class="el" href="allvars_8h_source.html#l00642">io_header::num_files</a>, and <a class="el" href="allvars_8h_source.html#l00635">io_header::time</a>.</p>

<p>Referenced by <a class="el" href="read__ic_8c_source.html#l00615">find_files()</a>, and <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  hid_t hdf5_file, hdf5_headergrp, hdf5_attribute;


  hdf5_file = H5Fopen(fname, H5F_ACC_RDONLY, H5P_DEFAULT);
  hdf5_headergrp = H5Gopen(hdf5_file, <span class="stringliteral">&quot;/Header&quot;</span>);


  hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">&quot;NumPart_ThisFile&quot;</span>);
  H5Aread(hdf5_attribute, H5T_NATIVE_INT, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>);
  H5Aclose(hdf5_attribute);

  hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">&quot;NumPart_Total&quot;</span>);
  H5Aread(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>);
  H5Aclose(hdf5_attribute);

  hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">&quot;NumPart_Total_HighWord&quot;</span>);
  H5Aread(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a56f54a68fe289b19902b3c4c561a7159">npartTotalHighWord</a>);
  H5Aclose(hdf5_attribute);

  hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">&quot;MassTable&quot;</span>);
  H5Aread(hdf5_attribute, H5T_NATIVE_DOUBLE, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a2c387b0c7c823287d424fedc70175917">mass</a>);
  H5Aclose(hdf5_attribute);

  hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">&quot;Time&quot;</span>);
  H5Aread(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad6237959a3590772366f18000a47a7d6">time</a>);
  H5Aclose(hdf5_attribute);

  hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">&quot;NumFilesPerSnapshot&quot;</span>);
  H5Aread(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a>);
  H5Aclose(hdf5_attribute);

  hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">&quot;Flag_Entropy_ICs&quot;</span>);
  H5Aread(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a448788ace72155e22d19af1c01917857">flag_entropy_instead_u</a>);
  H5Aclose(hdf5_attribute);

  H5Gclose(hdf5_headergrp);
  H5Fclose(hdf5_file);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af87c21a0c70ac5e7d5f769b952d08fe9_icgraph.png" border="0" usemap="#proto_8h_af87c21a0c70ac5e7d5f769b952d08fe9_icgraph" alt=""/></div>
<map name="proto_8h_af87c21a0c70ac5e7d5f769b952d08fe9_icgraph" id="proto_8h_af87c21a0c70ac5e7d5f769b952d08fe9_icgraph">
<area shape="rect" id="node3" href="read__ic_8c.html#ac028b474d53a40e79377b7ae5dde636a" title="find_files" alt="" coords="280,5,357,35"/><area shape="rect" id="node13" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="281,59,356,88"/><area shape="rect" id="node5" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="407,32,473,61"/><area shape="rect" id="node7" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="524,32,564,61"/><area shape="rect" id="node9" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="613,32,680,61"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="729,32,783,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a150344fdc0c6e132aecdb6c646529df1"></a><!-- doxytag: member="proto.h::read_ic" ref="a150344fdc0c6e132aecdb6c646529df1" args="(char *fname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void read_ic </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fname</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function reads initial conditions, in one of the three possible file formats currently supported by Gadget. Note: When a snapshot file is started from initial conditions (start-option 0), not all the information in the header is used, in particular, the STARTING TIME needs to be set in the parameterfile. Also, for gas particles, only the internal energy is read, the density and mean molecular weight will be recomputed by the code. When InitGasTemp&gt;0 is given, the gas temperature will be initialzed to this value assuming a mean colecular weight either corresponding to complete neutrality, or full ionization.</p>
<p>However, when the code is started with start-option 2, then all the this data in the snapshot files is preserved, i.e. this is also the way to resume a simulation from a snapshot file in case a regular restart file is not available. </p>

<p><p>&lt; adiabatic index of simulated gas</p>
<p>&lt; mass fraction of hydrogen, relevant only for radiative cooling</p>
<p>&lt; mass fraction of hydrogen, relevant only for radiative cooling </p>
</p>

<p>Definition at line <a class="el" href="read__ic_8c_source.html#l00031">31</a> of file <a class="el" href="read__ic_8c_source.html">read_ic.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00082">BOLTZMANN</a>, <a class="el" href="read__ic_8c_source.html#l00724">distribute_file()</a>, <a class="el" href="system_8c_source.html#l00091">dmax()</a>, <a class="el" href="allvars_8h_source.html#l00554">sph_particle_data::Entropy</a>, <a class="el" href="io_8c_source.html#l00566">fill_Tab_IO_Labels()</a>, <a class="el" href="read__ic_8c_source.html#l00615">find_files()</a>, <a class="el" href="allvars_8h_source.html#l00071">GAMMA_MINUS1</a>, <a class="el" href="allvars_8h_source.html#l00280">global_data_all_processes::ICFormat</a>, <a class="el" href="allvars_8h_source.html#l00308">global_data_all_processes::InitGasTemp</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8h_source.html#l00481">global_data_all_processes::MassTable</a>, <a class="el" href="allvars_8h_source.html#l00310">global_data_all_processes::MinEgySpec</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00285">global_data_all_processes::NumFilesWrittenInParallel</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="read__ic_8c_source.html#l00244">read_file()</a>, <a class="el" href="allvars_8c_source.html#l00030">RestartFlag</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00531">particle_data::Type</a>, <a class="el" href="allvars_8h_source.html#l00329">global_data_all_processes::UnitEnergy_in_cgs</a>, and <a class="el" href="allvars_8h_source.html#l00323">global_data_all_processes::UnitMass_in_g</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l00020">init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, num_files, rest_files, ngroups, gr, filenr, masterTask, lastTask, groupMaster;
  <span class="keywordtype">double</span> u_init;
  <span class="keywordtype">char</span> buf[500];

<span class="preprocessor">#ifndef ISOTHERM_EQS</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> molecular_weight;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef SFR</span>
<span class="preprocessor"></span>  <span class="keywordtype">double</span> original_gas_mass, <a class="code" href="structNODE.html#adfb345bd40fc1835e54589b46622efda">mass</a>, masstot;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> = 0;
  <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> = 0;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> = 0;

  num_files = <a class="code" href="proto_8h.html#ac028b474d53a40e79377b7ae5dde636a">find_files</a>(fname);

  rest_files = num_files;

  <a class="code" href="io_8c.html#a10281a87abe1e07d6ca603de6a533345">fill_Tab_IO_Labels</a>();

  <span class="keywordflow">while</span>(rest_files &gt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
    {
      sprintf(buf, <span class="stringliteral">&quot;%s.%d&quot;</span>, fname, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> + (rest_files - <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>));
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
        sprintf(buf, <span class="stringliteral">&quot;%s.%d.hdf5&quot;</span>, fname, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> + (rest_files - <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>));

      ngroups = <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>;
      <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> % <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>))
        ngroups++;
      groupMaster = (<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> / ngroups) * ngroups;

      <span class="keywordflow">for</span>(gr = 0; gr &lt; ngroups; gr++)
        {
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == (groupMaster + gr))    <span class="comment">/* ok, it&#39;s this processor&#39;s turn */</span>
            <a class="code" href="proto_8h.html#affd0f4e6b7bcdabf7d6f8191145f78d1">read_file</a>(buf, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
          MPI_Barrier(MPI_COMM_WORLD);
        }

      rest_files -= <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>;
    }


  <span class="keywordflow">if</span>(rest_files &gt; 0)
    {
      <a class="code" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab">distribute_file</a>(rest_files, 0, 0, <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> - 1, &amp;filenr, &amp;masterTask, &amp;lastTask);

      <span class="keywordflow">if</span>(num_files &gt; 1)
        {
          sprintf(buf, <span class="stringliteral">&quot;%s.%d&quot;</span>, fname, filenr);
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
            sprintf(buf, <span class="stringliteral">&quot;%s.%d.hdf5&quot;</span>, fname, filenr);
        }
      <span class="keywordflow">else</span>
        {
          sprintf(buf, <span class="stringliteral">&quot;%s&quot;</span>, fname);
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a> == 3)
            sprintf(buf, <span class="stringliteral">&quot;%s.hdf5&quot;</span>, fname);
        }

      ngroups = rest_files / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>;
      <span class="keywordflow">if</span>((rest_files % <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>))
        ngroups++;

      <span class="keywordflow">for</span>(gr = 0; gr &lt; ngroups; gr++)
        {
          <span class="keywordflow">if</span>((filenr / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>) == gr)    <span class="comment">/* ok, it&#39;s this processor&#39;s turn */</span>
            <a class="code" href="proto_8h.html#affd0f4e6b7bcdabf7d6f8191145f78d1">read_file</a>(buf, masterTask, lastTask);
          MPI_Barrier(MPI_COMM_WORLD);
        }
    }


  <span class="comment">/* this makes sure that masses are initialized in the case that the mass-block</span>
<span class="comment">     is completely empty */</span>
  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>] != 0)
        <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#ab6119b261ff95e8f84ae171139704cbd">Type</a>];
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 0)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a633fbd557554f7932dab2641d15e6ea1">InitGasTemp</a> &gt; 0)
        {
          u_init = (<a class="code" href="allvars_8h.html#aa1487dae81baa2e0a5643e7b571633a0">BOLTZMANN</a> / PROTONMASS) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a633fbd557554f7932dab2641d15e6ea1">InitGasTemp</a>;
          u_init *= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adccf5aa82d4252d8d24ead7681b29052">UnitMass_in_g</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0d48e2253ad31d76eda8e677eba2cf1">UnitEnergy_in_cgs</a>;  <span class="comment">/* unit conversion */</span>

#ifdef ISOTHERM_EQS
          u_init *= 1.0;
#<span class="keywordflow">else</span>
          u_init *= (1.0 / <a class="code" href="allvars_8h.html#a75216f9bf4030240b1fc0e1855e032d2">GAMMA_MINUS1</a>);

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a633fbd557554f7932dab2641d15e6ea1">InitGasTemp</a> &gt; 1.0e4)   <span class="comment">/* assuming FULL ionization */</span>
            molecular_weight = 4 / (8 - 5 * (1 - HYDROGEN_MASSFRAC));
          <span class="keywordflow">else</span>                  <span class="comment">/* assuming NEUTRAL GAS */</span>
            molecular_weight = 4 / (1 + 3 * HYDROGEN_MASSFRAC);

          u_init /= molecular_weight;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
          <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i++)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy == 0)
                <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a> = u_init;

              <span class="comment">/* Note: the coversion to entropy will be done in the function init(),</span>
<span class="comment">                 after the densities have been computed */</span>
            }
        }
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i++)
    <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].Entropy = <a class="code" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85">dmax</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a>, <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#a7cbe9bb2086f525f400b2c12103b3116">Entropy</a>);

  MPI_Barrier(MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;reading done.\n&quot;</span>);
      fflush(stdout);
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;Total number of particles :  %d%09d\n\n&quot;</span>,
             (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> % 1000000000));
      fflush(stdout);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a150344fdc0c6e132aecdb6c646529df1_cgraph.png" border="0" usemap="#proto_8h_a150344fdc0c6e132aecdb6c646529df1_cgraph" alt=""/></div>
<map name="proto_8h_a150344fdc0c6e132aecdb6c646529df1_cgraph" id="proto_8h_a150344fdc0c6e132aecdb6c646529df1_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab" title="distribute_file" alt="" coords="136,29,243,59"/><area shape="rect" id="node6" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="160,83,219,112"/><area shape="rect" id="node8" href="io_8c.html#a10281a87abe1e07d6ca603de6a533345" title="fill_Tab_IO_Labels" alt="" coords="124,136,255,165"/><area shape="rect" id="node10" href="proto_8h.html#ac028b474d53a40e79377b7ae5dde636a" title="find_files" alt="" coords="151,189,228,219"/><area shape="rect" id="node18" href="proto_8h.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="152,427,227,456"/><area shape="rect" id="node12" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="579,293,645,323"/><area shape="rect" id="node16" href="proto_8h.html#af87c21a0c70ac5e7d5f769b952d08fe9" title="read_header_attributes_in_hdf5" alt="" coords="305,189,529,219"/><area shape="rect" id="node14" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="693,293,851,323"/><area shape="rect" id="node20" href="allocate_8c.html#a7fe5e304baaf5f418a22fef9a9cc02c7" title="allocate_memory" alt="" coords="351,293,484,323"/><area shape="rect" id="node23" href="io_8c.html#ad9c685a2d6d48224bfec61680ce82b1e" title="blockpresent" alt="" coords="365,347,469,376"/><area shape="rect" id="node25" href="proto_8h.html#a3757efb7e470353080a128388ccebec9" title="empty_read_buffer" alt="" coords="347,400,488,429"/><area shape="rect" id="node28" href="io_8c.html#a49492470fcccf9d05bf51993f281f16c" title="get_bytes_per_blockelement" alt="" coords="315,453,520,483"/><area shape="rect" id="node30" href="io_8c.html#a4d30ce1aad9c69d5af676a6a13173686" title="get_dataset_name" alt="" coords="347,507,488,536"/><area shape="rect" id="node32" href="io_8c.html#acdf59daa02f065452a596cf88b4de1a1" title="get_datatype_in_block" alt="" coords="335,560,500,589"/><area shape="rect" id="node34" href="io_8c.html#a5ce310b1efc19d96d530c1264fd5eca9" title="get_particles_in_block" alt="" coords="336,613,499,643"/><area shape="rect" id="node37" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f" title="get_values_per_blockelement" alt="" coords="312,667,523,696"/><area shape="rect" id="node39" href="io_8c.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="376,720,459,749"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a150344fdc0c6e132aecdb6c646529df1_icgraph.png" border="0" usemap="#proto_8h_a150344fdc0c6e132aecdb6c646529df1_icgraph" alt=""/></div>
<map name="proto_8h_a150344fdc0c6e132aecdb6c646529df1_icgraph" id="proto_8h_a150344fdc0c6e132aecdb6c646529df1_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="124,5,164,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="213,5,280,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="329,5,383,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a849a294ac908c933ffb82dc4319af513"></a><!-- doxytag: member="proto.h::read_outputlist" ref="a849a294ac908c933ffb82dc4319af513" args="(char *fname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int read_outputlist </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fname</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>this function reads a table with a list of desired output times. The table does not have to be ordered in any way, but may not contain more than MAXLEN_OUTPUTLIST entries. </p>

<p><p>&lt; maxmimum number of entries in list of snapshot output times </p>
</p>

<p>Definition at line <a class="el" href="begrun_8c_source.html#l00770">770</a> of file <a class="el" href="begrun_8c_source.html">begrun.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="allvars_8h_source.html#l00109">MAXLEN_OUTPUTLIST</a>, <a class="el" href="allvars_8h_source.html#l00501">global_data_all_processes::OutputListLength</a>, and <a class="el" href="allvars_8h_source.html#l00500">global_data_all_processes::OutputListTimes</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00285">read_parameter_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>;

  <span class="keywordflow">if</span>(!(fd = fopen(fname, <span class="stringliteral">&quot;r&quot;</span>)))
    {
      printf(<span class="stringliteral">&quot;can&#39;t read output list in file &#39;%s&#39;\n&quot;</span>, fname);
      <span class="keywordflow">return</span> 1;
    }

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a> = 0;
  <span class="keywordflow">do</span>
    {
      <span class="keywordflow">if</span>(fscanf(fd, <span class="stringliteral">&quot; %lg &quot;</span>, &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7f3307450336a806e545661ba6c79ba5">OutputListTimes</a>[<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a>]) == 1)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a>++;
      <span class="keywordflow">else</span>
        <span class="keywordflow">break</span>;
    }
  <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a> &lt; <a class="code" href="allvars_8h.html#a15241b0cd53f02da974a64ebb05dcc8d">MAXLEN_OUTPUTLIST</a>);

  fclose(fd);

  printf(<span class="stringliteral">&quot;\nfound %d times in output-list.\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a>);

  <span class="keywordflow">return</span> 0;
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a849a294ac908c933ffb82dc4319af513_icgraph.png" border="0" usemap="#proto_8h_a849a294ac908c933ffb82dc4319af513_icgraph" alt=""/></div>
<map name="proto_8h_a849a294ac908c933ffb82dc4319af513_icgraph" id="proto_8h_a849a294ac908c933ffb82dc4319af513_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a952eae1977b498c4fdfabed1742a3ba2" title="read_parameter_file" alt="" coords="175,5,324,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="373,5,440,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="489,5,543,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a952eae1977b498c4fdfabed1742a3ba2"></a><!-- doxytag: member="proto.h::read_parameter_file" ref="a952eae1977b498c4fdfabed1742a3ba2" args="(char *fname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void read_parameter_file </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fname</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function parses the parameterfile in a simple way. Each paramater is defined by a keyword (`tag'), and can be either of type double, int, or character string. The routine makes sure that each parameter appears exactly once in the parameterfile, otherwise error messages are produced that complain about the missing parameters. </p>

<p>Definition at line <a class="el" href="begrun_8c_source.html#l00285">285</a> of file <a class="el" href="begrun_8c_source.html">begrun.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00307">global_data_all_processes::ArtBulkViscConst</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="allvars_8h_source.html#l00288">global_data_all_processes::BufferSize</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00447">global_data_all_processes::CourantFac</a>, <a class="el" href="allvars_8h_source.html#l00493">global_data_all_processes::CpuFile</a>, <a class="el" href="allvars_8h_source.html#l00360">global_data_all_processes::CpuTimeBetRestartFile</a>, <a class="el" href="allvars_8h_source.html#l00304">global_data_all_processes::DesNumNgb</a>, <a class="el" href="begrun_8c.html#a8747af38b86aa2bbcda2f1b1aa0888c2">DOUBLE</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8h_source.html#l00492">global_data_all_processes::EnergyFile</a>, <a class="el" href="allvars_8h_source.html#l00428">global_data_all_processes::ErrTolForceAcc</a>, <a class="el" href="allvars_8h_source.html#l00433">global_data_all_processes::ErrTolIntAccuracy</a>, <a class="el" href="allvars_8h_source.html#l00427">global_data_all_processes::ErrTolTheta</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="allvars_8h_source.html#l00331">global_data_all_processes::GravityConstantInternal</a>, <a class="el" href="allvars_8h_source.html#l00342">global_data_all_processes::HubbleParam</a>, <a class="el" href="allvars_8h_source.html#l00280">global_data_all_processes::ICFormat</a>, <a class="el" href="allvars_8h_source.html#l00494">global_data_all_processes::InfoFile</a>, <a class="el" href="allvars_8h_source.html#l00489">global_data_all_processes::InitCondFile</a>, <a class="el" href="allvars_8h_source.html#l00308">global_data_all_processes::InitGasTemp</a>, <a class="el" href="begrun_8c.html#afeeffe52c8fd59db7c61cf8b02042dbf">INT</a>, <a class="el" href="allvars_8h_source.html#l00305">global_data_all_processes::MaxNumNgbDeviation</a>, <a class="el" href="allvars_8h_source.html#l00440">global_data_all_processes::MaxRMSDisplacementFac</a>, <a class="el" href="allvars_8h_source.html#l00438">global_data_all_processes::MaxSizeTimestep</a>, <a class="el" href="allvars_8h_source.html#l00459">global_data_all_processes::MinGasHsmlFractional</a>, <a class="el" href="allvars_8h_source.html#l00309">global_data_all_processes::MinGasTemp</a>, <a class="el" href="allvars_8h_source.html#l00436">global_data_all_processes::MinSizeTimestep</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00284">global_data_all_processes::NumFilesPerSnapshot</a>, <a class="el" href="allvars_8h_source.html#l00285">global_data_all_processes::NumFilesWrittenInParallel</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00341">global_data_all_processes::OmegaBaryon</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8h_source.html#l00490">global_data_all_processes::OutputDir</a>, <a class="el" href="allvars_8h_source.html#l00498">global_data_all_processes::OutputListFilename</a>, <a class="el" href="allvars_8h_source.html#l00501">global_data_all_processes::OutputListLength</a>, <a class="el" href="allvars_8h_source.html#l00352">global_data_all_processes::OutputListOn</a>, <a class="el" href="allvars_8h_source.html#l00294">global_data_all_processes::PartAllocFactor</a>, <a class="el" href="allvars_8h_source.html#l00348">global_data_all_processes::PeriodicBoundariesOn</a>, <a class="el" href="begrun_8c_source.html#l00770">read_outputlist()</a>, <a class="el" href="allvars_8h_source.html#l00496">global_data_all_processes::RestartFile</a>, <a class="el" href="allvars_8h_source.html#l00497">global_data_all_processes::ResubmitCommand</a>, <a class="el" href="allvars_8h_source.html#l00349">global_data_all_processes::ResubmitOn</a>, <a class="el" href="allvars_8h_source.html#l00282">global_data_all_processes::SnapFormat</a>, <a class="el" href="allvars_8h_source.html#l00491">global_data_all_processes::SnapshotFileBase</a>, <a class="el" href="allvars_8h_source.html#l00468">global_data_all_processes::SofteningBndry</a>, <a class="el" href="allvars_8h_source.html#l00475">global_data_all_processes::SofteningBndryMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00466">global_data_all_processes::SofteningBulge</a>, <a class="el" href="allvars_8h_source.html#l00473">global_data_all_processes::SofteningBulgeMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00465">global_data_all_processes::SofteningDisk</a>, <a class="el" href="allvars_8h_source.html#l00472">global_data_all_processes::SofteningDiskMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00463">global_data_all_processes::SofteningGas</a>, <a class="el" href="allvars_8h_source.html#l00470">global_data_all_processes::SofteningGasMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00464">global_data_all_processes::SofteningHalo</a>, <a class="el" href="allvars_8h_source.html#l00471">global_data_all_processes::SofteningHaloMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00467">global_data_all_processes::SofteningStars</a>, <a class="el" href="allvars_8h_source.html#l00474">global_data_all_processes::SofteningStarsMaxPhys</a>, <a class="el" href="begrun_8c.html#a0f4d394a3ab4e09bff60f714c66dc5ee">STRING</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00370">global_data_all_processes::TimeBegin</a>, <a class="el" href="allvars_8h_source.html#l00358">global_data_all_processes::TimeBetSnapshot</a>, <a class="el" href="allvars_8h_source.html#l00362">global_data_all_processes::TimeBetStatistics</a>, <a class="el" href="allvars_8h_source.html#l00405">global_data_all_processes::TimeLimitCPU</a>, <a class="el" href="allvars_8h_source.html#l00372">global_data_all_processes::TimeMax</a>, <a class="el" href="allvars_8h_source.html#l00359">global_data_all_processes::TimeOfFirstSnapshot</a>, <a class="el" href="allvars_8h_source.html#l00495">global_data_all_processes::TimingsFile</a>, <a class="el" href="allvars_8h_source.html#l00298">global_data_all_processes::TreeAllocFactor</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, <a class="el" href="allvars_8h_source.html#l00350">global_data_all_processes::TypeOfOpeningCriterion</a>, <a class="el" href="allvars_8h_source.html#l00351">global_data_all_processes::TypeOfTimestepCriterion</a>, <a class="el" href="allvars_8h_source.html#l00325">global_data_all_processes::UnitLength_in_cm</a>, <a class="el" href="allvars_8h_source.html#l00323">global_data_all_processes::UnitMass_in_g</a>, and <a class="el" href="allvars_8h_source.html#l00324">global_data_all_processes::UnitVelocity_in_cm_per_s</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
<span class="preprocessor">#define DOUBLE 1</span>
<span class="preprocessor"></span><span class="preprocessor">#define STRING 2</span>
<span class="preprocessor"></span><span class="preprocessor">#define INT 3</span>
<span class="preprocessor"></span><span class="preprocessor">#define MAXTAGS 300</span>
<span class="preprocessor"></span>
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>, *fdout;
  <span class="keywordtype">char</span> buf[200], buf1[200], buf2[200], buf3[400];
  <span class="keywordtype">int</span> i, j, nt;
  <span class="keywordtype">int</span> <span class="keywordtype">id</span>[MAXTAGS];
  <span class="keywordtype">void</span> *addr[MAXTAGS];
  <span class="keywordtype">char</span> tag[MAXTAGS][50];
  <span class="keywordtype">int</span>  errorFlag = 0;


  <span class="keywordflow">if</span>(<span class="keyword">sizeof</span>(<span class="keywordtype">long</span> <span class="keywordtype">long</span>) != 8)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nType `long long&#39; is not 64 bit on this platform. Stopping.\n\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

  <span class="keywordflow">if</span>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) != 4)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nType `int&#39; is not 32 bit on this platform. Stopping.\n\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

  <span class="keywordflow">if</span>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) != 4)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nType `float&#39; is not 32 bit on this platform. Stopping.\n\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

  <span class="keywordflow">if</span>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) != 8)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nType `double&#39; is not 64 bit on this platform. Stopping.\n\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)             <span class="comment">/* read parameter file on process 0 */</span>
    {
      nt = 0;

      strcpy(tag[nt], <span class="stringliteral">&quot;InitCondFile&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adacd2b54a924bb4ce144afc1abbc6138">InitCondFile</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;OutputDir&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;SnapshotFileBase&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4bcf5b5c31545691038015af9ae9acb3">SnapshotFileBase</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;EnergyFile&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa97394ab3a522c46b75f8b57a59ca0b5">EnergyFile</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;CpuFile&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac2ba980c60460b89534ca8bba63cd679">CpuFile</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;InfoFile&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3cbcdacb8b522288268993f0ce5b15ac">InfoFile</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;TimingsFile&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae0f7c691d211f8076374cc55271022e8">TimingsFile</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;RestartFile&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a67e197a37469217aa8ad32c42230b286">RestartFile</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;ResubmitCommand&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a59f86964a3a1b03933a787cfc280951a">ResubmitCommand</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;OutputListFilename&quot;</span>);
      addr[nt] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a063be13ecadec873ebaad1b3645a5323">OutputListFilename</a>;
      <span class="keywordtype">id</span>[nt++] = STRING;

      strcpy(tag[nt], <span class="stringliteral">&quot;OutputListOn&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4e9d69a3dd88c6aef6f4afd640243950">OutputListOn</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;Omega0&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;OmegaBaryon&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5656f8668fd420a86cb7372869745fee">OmegaBaryon</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;OmegaLambda&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;HubbleParam&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a51f2bde6feb49841d60397964a9740ac">HubbleParam</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;BoxSize&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;PeriodicBoundariesOn&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a52b027433ffad064869c606656e9bf7d">PeriodicBoundariesOn</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;TimeOfFirstSnapshot&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a18e4063fbc1f92e8c59d6e59c7b20631">TimeOfFirstSnapshot</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;CpuTimeBetRestartFile&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af087b459cc41cb6b81bdbdd0e339cb6f">CpuTimeBetRestartFile</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;TimeBetStatistics&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a516be9ff5c4fd4171aa8e1a687e1e72d">TimeBetStatistics</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;TimeBegin&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;TimeMax&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;TimeBetSnapshot&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c02c06bb5214dcf72dd4eb757df8ad3">TimeBetSnapshot</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;UnitVelocity_in_cm_per_s&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a04f4a1972c99f3ab4ba2483237a9d8ab">UnitVelocity_in_cm_per_s</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;UnitLength_in_cm&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a111a45896aafd67faa8f0c9ef897612f">UnitLength_in_cm</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;UnitMass_in_g&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adccf5aa82d4252d8d24ead7681b29052">UnitMass_in_g</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;TreeDomainUpdateFrequency&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;ErrTolIntAccuracy&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a73f3a95e03513c038cf3215a2204bce4">ErrTolIntAccuracy</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;ErrTolTheta&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac3edc89fa5616655618ddccb430e3dfe">ErrTolTheta</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;ErrTolForceAcc&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5a8eb914026679a7c816a09c20d25de0">ErrTolForceAcc</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;MinGasHsmlFractional&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#acddf5d973c6847405b85f4531d5b7510">MinGasHsmlFractional</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;MaxSizeTimestep&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7303c9f6c34ee3befcac84043c8ec3ea">MaxSizeTimestep</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;MinSizeTimestep&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab5f56d94a4417c5a703b6d2d4cb81a05">MinSizeTimestep</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;MaxRMSDisplacementFac&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a988ecf1fcfe5e61ff9ac29792c816c24">MaxRMSDisplacementFac</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;ArtBulkViscConst&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a14b9df6a6579d2ce6ef7c86aa0230217">ArtBulkViscConst</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;CourantFac&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa4cf405da4e0a6fc588f5a5ba7e8fde8">CourantFac</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;DesNumNgb&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;MaxNumNgbDeviation&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a388690a6ee1497eea2f19e3984afa088">MaxNumNgbDeviation</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;ComovingIntegrationOn&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;ICFormat&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1c63650e75378a527870ab40f1145df1">ICFormat</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;SnapFormat&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;NumFilesPerSnapshot&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3749135400fbf51c319054233d7a64a7">NumFilesPerSnapshot</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;NumFilesWrittenInParallel&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;ResubmitOn&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6578ce0ee08f770891c662c0ab4ad10c">ResubmitOn</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;TypeOfTimestepCriterion&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2cc704c49ada031fae9619dbf163e32d">TypeOfTimestepCriterion</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;TypeOfOpeningCriterion&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0c2a481de17eefbbd973fb8a7bb6f8fc">TypeOfOpeningCriterion</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;TimeLimitCPU&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accf0e0ec1acab3f51f583470910049d2">TimeLimitCPU</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningHalo&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a892cb7014ecd4b3910c493755b875b7e">SofteningHalo</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningDisk&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4a4453f9f76bb91ff3418d864caf3222">SofteningDisk</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningBulge&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1a0c9ca2f3dfdb2371785b66ced141d7">SofteningBulge</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningGas&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1f85943960c69ff351b48fc2f3933ec2">SofteningGas</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningStars&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5502dc85fd165d33e9ba8d0f8c01867c">SofteningStars</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningBndry&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a8c31c4a347bca34b4e8d2292f710596d">SofteningBndry</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningHaloMaxPhys&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1d4f323715e8df4ea4be9296348cca25">SofteningHaloMaxPhys</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningDiskMaxPhys&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a575a685feed5223ffc7c5b42b2b369b9">SofteningDiskMaxPhys</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningBulgeMaxPhys&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a215c28ea2e54629e8537bd9868401fa7">SofteningBulgeMaxPhys</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningGasMaxPhys&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1e7634a0c6aa4affa124e095bf32285b">SofteningGasMaxPhys</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningStarsMaxPhys&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7ace4652c6c05275e4fa28dfe6fb374e">SofteningStarsMaxPhys</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;SofteningBndryMaxPhys&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af989ac3052ad7e6bf7d7bfc824274715">SofteningBndryMaxPhys</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;BufferSize&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a>;
      <span class="keywordtype">id</span>[nt++] = INT;

      strcpy(tag[nt], <span class="stringliteral">&quot;PartAllocFactor&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;TreeAllocFactor&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;GravityConstantInternal&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3ebe48dc90c65aa0ed7ddfe8431987b1">GravityConstantInternal</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;InitGasTemp&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a633fbd557554f7932dab2641d15e6ea1">InitGasTemp</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

      strcpy(tag[nt], <span class="stringliteral">&quot;MinGasTemp&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a728a84084280f547b1b68dbb143570ad">MinGasTemp</a>;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;

<span class="preprocessor">#ifdef COMPUTE_SELFINTERACTION_FORDARK </span>
<span class="preprocessor"></span>      strcpy(tag[nt], <span class="stringliteral">&quot;InteractionCrossSection&quot;</span>);
      addr[nt] = &amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.InteractionCrossSection;
      <span class="keywordtype">id</span>[nt++] = DOUBLE;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      <span class="keywordflow">if</span>((fd = fopen(fname, <span class="stringliteral">&quot;r&quot;</span>)))
        {
          sprintf(buf, <span class="stringliteral">&quot;%s%s&quot;</span>, fname, <span class="stringliteral">&quot;-usedvalues&quot;</span>);
          <span class="keywordflow">if</span>(!(fdout = fopen(buf, <span class="stringliteral">&quot;w&quot;</span>)))
            {
              printf(<span class="stringliteral">&quot;error opening file &#39;%s&#39; \n&quot;</span>, buf);
              errorFlag = 1;
            }
          <span class="keywordflow">else</span>
            {
              <span class="keywordflow">while</span>(!feof(fd))
                {
                  *buf = 0;
                  fgets(buf, 200, fd);
                  <span class="keywordflow">if</span>(sscanf(buf, <span class="stringliteral">&quot;%s%s%s&quot;</span>, buf1, buf2, buf3) &lt; 2)
                    <span class="keywordflow">continue</span>;

                  <span class="keywordflow">if</span>(buf1[0] == <span class="charliteral">&#39;%&#39;</span>)
                    <span class="keywordflow">continue</span>;

                  <span class="keywordflow">for</span>(i = 0, j = -1; i &lt; nt; i++)
                    <span class="keywordflow">if</span>(strcmp(buf1, tag[i]) == 0)
                      {
                        j = i;
                        tag[i][0] = 0;
                        <span class="keywordflow">break</span>;
                      }

                  <span class="keywordflow">if</span>(j &gt;= 0)
                    {
                      <span class="keywordflow">switch</span> (<span class="keywordtype">id</span>[j])
                        {
                        <span class="keywordflow">case</span> <a class="code" href="begrun_8c.html#a8747af38b86aa2bbcda2f1b1aa0888c2">DOUBLE</a>:
                          *((<span class="keywordtype">double</span> *) addr[j]) = atof(buf2);
                          fprintf(fdout, <span class="stringliteral">&quot;%-35s%g\n&quot;</span>, buf1, *((<span class="keywordtype">double</span> *) addr[j]));
                          <span class="keywordflow">break</span>;
                        <span class="keywordflow">case</span> <a class="code" href="begrun_8c.html#a0f4d394a3ab4e09bff60f714c66dc5ee">STRING</a>:
                          strcpy(addr[j], buf2);
                          fprintf(fdout, <span class="stringliteral">&quot;%-35s%s\n&quot;</span>, buf1, buf2);
                          <span class="keywordflow">break</span>;
                        <span class="keywordflow">case</span> <a class="code" href="begrun_8c.html#afeeffe52c8fd59db7c61cf8b02042dbf">INT</a>:
                          *((<span class="keywordtype">int</span> *) addr[j]) = atoi(buf2);
                          fprintf(fdout, <span class="stringliteral">&quot;%-35s%d\n&quot;</span>, buf1, *((<span class="keywordtype">int</span> *) addr[j]));
                          <span class="keywordflow">break</span>;
                        }
                    }
                  <span class="keywordflow">else</span>
                    {
                      fprintf(stdout, <span class="stringliteral">&quot;Error in file %s:   Tag &#39;%s&#39; not allowed or multiple defined.\n&quot;</span>,
                              fname, buf1);
                      errorFlag = 1;
                    }
                }
              fclose(fd);
              fclose(fdout);

              i = strlen(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>);
              <span class="keywordflow">if</span>(i &gt; 0)
                <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>[i - 1] != <span class="charliteral">&#39;/&#39;</span>)
                  strcat(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <span class="stringliteral">&quot;/&quot;</span>);

              sprintf(buf1, <span class="stringliteral">&quot;%s%s&quot;</span>, fname, <span class="stringliteral">&quot;-usedvalues&quot;</span>);
              sprintf(buf2, <span class="stringliteral">&quot;%s%s&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <span class="stringliteral">&quot;parameters-usedvalues&quot;</span>);
              sprintf(buf3, <span class="stringliteral">&quot;cp %s %s&quot;</span>, buf1, buf2);
              system(buf3);
            }
        }
      <span class="keywordflow">else</span>
        {
          printf(<span class="stringliteral">&quot;\nParameter file %s not found.\n\n&quot;</span>, fname);
          errorFlag = 2;
        }

      <span class="keywordflow">if</span>(errorFlag != 2)
        <span class="keywordflow">for</span>(i = 0; i &lt; nt; i++)
          {
            <span class="keywordflow">if</span>(*tag[i])
              {
                printf(<span class="stringliteral">&quot;Error. I miss a value for tag &#39;%s&#39; in parameter file &#39;%s&#39;.\n&quot;</span>, tag[i], fname);
                errorFlag = 1;
              }
          }

      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4e9d69a3dd88c6aef6f4afd640243950">OutputListOn</a> &amp;&amp; errorFlag == 0)
        errorFlag += <a class="code" href="begrun_8c.html#a849a294ac908c933ffb82dc4319af513">read_outputlist</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a063be13ecadec873ebaad1b3645a5323">OutputListFilename</a>);
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af0ada535a17b75233e0e0de6ff8fa448">OutputListLength</a> = 0;
    }

  MPI_Bcast(&amp;errorFlag, 1, MPI_INT, 0, MPI_COMM_WORLD);

  <span class="keywordflow">if</span>(errorFlag)
    {
      MPI_Finalize();
      exit(0);
    }

  <span class="comment">/* now communicate the relevant parameters to the other processes */</span>
  MPI_Bcast(&amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structglobal__data__all__processes.html">global_data_all_processes</a>), MPI_BYTE, 0, MPI_COMM_WORLD);


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a> &lt; 1)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;NumFilesWrittenInParallel MUST be at least 1\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a> &gt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;NumFilesWrittenInParallel MUST be smaller than number of processors\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

<span class="preprocessor">#ifdef PERIODIC</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a52b027433ffad064869c606656e9bf7d">PeriodicBoundariesOn</a> == 0)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;Code was compiled with periodic boundary conditions switched on.\n&quot;</span>);
          printf(<span class="stringliteral">&quot;You must set `PeriodicBoundariesOn=1&#39;, or recompile the code.\n&quot;</span>);
        }
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a52b027433ffad064869c606656e9bf7d">PeriodicBoundariesOn</a> == 1)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;Code was compiled with periodic boundary conditions switched off.\n&quot;</span>);
          printf(<span class="stringliteral">&quot;You must set `PeriodicBoundariesOn=0&#39;, or recompile the code.\n&quot;</span>);
        }
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2cc704c49ada031fae9619dbf163e32d">TypeOfTimestepCriterion</a> &gt;= 1)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          printf(<span class="stringliteral">&quot;The specified timestep criterion\n&quot;</span>);
          printf(<span class="stringliteral">&quot;is not valid\n&quot;</span>);
        }
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }

<span class="preprocessor">#if defined(LONG_X) ||  defined(LONG_Y) || defined(LONG_Z)</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef NOGRAVITY</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;Code was compiled with LONG_X/Y/Z, but not with NOGRAVITY.\n&quot;</span>);
      printf(<span class="stringliteral">&quot;Stretched periodic boxes are not implemented for gravity yet.\n&quot;</span>);
    }
  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#undef DOUBLE</span>
<span class="preprocessor"></span><span class="preprocessor">#undef STRING</span>
<span class="preprocessor"></span><span class="preprocessor">#undef INT</span>
<span class="preprocessor"></span><span class="preprocessor">#undef MAXTAGS</span>
<span class="preprocessor"></span>}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a952eae1977b498c4fdfabed1742a3ba2_cgraph.png" border="0" usemap="#proto_8h_a952eae1977b498c4fdfabed1742a3ba2_cgraph" alt=""/></div>
<map name="proto_8h_a952eae1977b498c4fdfabed1742a3ba2_cgraph" id="proto_8h_a952eae1977b498c4fdfabed1742a3ba2_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="232,5,299,35"/><area shape="rect" id="node7" href="begrun_8c.html#a849a294ac908c933ffb82dc4319af513" title="read_outputlist" alt="" coords="207,59,324,88"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="373,5,531,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a952eae1977b498c4fdfabed1742a3ba2_icgraph.png" border="0" usemap="#proto_8h_a952eae1977b498c4fdfabed1742a3ba2_icgraph" alt=""/></div>
<map name="proto_8h_a952eae1977b498c4fdfabed1742a3ba2_icgraph" id="proto_8h_a952eae1977b498c4fdfabed1742a3ba2_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="205,5,272,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="321,5,375,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="acc4d1f5e4e51140090a7ce25ea263b98"></a><!-- doxytag: member="proto.h::readjust_timebase" ref="acc4d1f5e4e51140090a7ce25ea263b98" args="(double TimeMax_old, double TimeMax_new)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void readjust_timebase </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>TimeMax_old</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>TimeMax_new</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>If a restart from restart-files is carried out where the TimeMax variable is increased, then the integer timeline needs to be adjusted. The approach taken here is to reduce the resolution of the integer timeline by factors of 2 until the new final time can be reached within TIMEBASE. </p>

<p><p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29 </p>
</p>

<p>Definition at line <a class="el" href="begrun_8c_source.html#l00804">804</a> of file <a class="el" href="begrun_8c_source.html">begrun.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00386">global_data_all_processes::PM_Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00385">global_data_all_processes::PM_Ti_endstep</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00533">particle_data::Ti_begstep</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00532">particle_data::Ti_endstep</a>, <a class="el" href="allvars_8h_source.html#l00041">TIMEBASE</a>, <a class="el" href="allvars_8h_source.html#l00377">global_data_all_processes::Timebase_interval</a>, <a class="el" href="allvars_8h_source.html#l00370">global_data_all_processes::TimeBegin</a>, and <a class="el" href="allvars_8h_source.html#l00372">global_data_all_processes::TimeMax</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;
  <span class="keywordtype">long</span> <span class="keywordtype">long</span> ti_end;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;\nAll.TimeMax has been changed in the parameterfile\n&quot;</span>);
      printf(<span class="stringliteral">&quot;Need to adjust integer timeline\n\n\n&quot;</span>);
    }

  <span class="keywordflow">if</span>(TimeMax_new &lt; TimeMax_old)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;\nIt is not allowed to reduce All.TimeMax\n\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(556);
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    ti_end = log(TimeMax_new / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>) / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;
  <span class="keywordflow">else</span>
    ti_end = (TimeMax_new - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ad671e0af15abea094631b996dc78c8f1">TimeBegin</a>) / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a>;

  <span class="keywordflow">while</span>(ti_end &gt; <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a>)
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0dd4962a455bb955f04ec271d7af7bb4">Timebase_interval</a> *= 2.0;

      ti_end /= 2;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> /= 2;

<span class="preprocessor">#ifdef PMGRID</span>
<span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a53412b692a49924318748259987031aa">PM_Ti_begstep</a> /= 2;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a723a0aa2f2ac0ac4cc58ebc049dda9b3">PM_Ti_endstep</a> /= 2;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
        {
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a6c9f057d234839cecaaeffc87b7a9794">Ti_begstep</a> /= 2;
          <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a9bf2c52c7378a961222d9fe8faa9c208">Ti_endstep</a> /= 2;
        }
    }

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a> = TimeMax_new;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_acc4d1f5e4e51140090a7ce25ea263b98_cgraph.png" border="0" usemap="#proto_8h_acc4d1f5e4e51140090a7ce25ea263b98_cgraph" alt=""/></div>
<map name="proto_8h_acc4d1f5e4e51140090a7ce25ea263b98_cgraph" id="proto_8h_acc4d1f5e4e51140090a7ce25ea263b98_cgraph">
<area shape="rect" id="node3" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="195,5,261,35"/><area shape="rect" id="node5" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="309,5,467,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_acc4d1f5e4e51140090a7ce25ea263b98_icgraph.png" border="0" usemap="#proto_8h_acc4d1f5e4e51140090a7ce25ea263b98_icgraph" alt=""/></div>
<map name="proto_8h_acc4d1f5e4e51140090a7ce25ea263b98_icgraph" id="proto_8h_acc4d1f5e4e51140090a7ce25ea263b98_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="195,5,261,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="311,5,364,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af744cef873e3093ba2924da8265d1711"></a><!-- doxytag: member="proto.h::reorder_gas" ref="af744cef873e3093ba2924da8265d1711" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void reorder_gas </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function brings the gas particles into the same order as the sorted keys. (The sort is first done only on the keys themselves and done directly on the gas particles in order to reduce the amount of data that needs to be moved in memory. Only once the order is established, the gas particles are rearranged, such that each particle has to be moved at most once.) </p>

<p>Definition at line <a class="el" href="peano_8c_source.html#l00117">117</a> of file <a class="el" href="peano_8c_source.html">peano.c</a>.</p>

<p>References <a class="el" href="peano_8c_source.html#l00026">Id</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, and <a class="el" href="allvars_8c_source.html#l00128">SphP</a>.</p>

<p>Referenced by <a class="el" href="peano_8c_source.html#l00034">peano_hilbert_order()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;
  <span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a> Psave, Psource;
  <span class="keyword">struct </span><a class="code" href="structsph__particle__data.html">sph_particle_data</a> SphPsave, SphPsource;
  <span class="keywordtype">int</span> idsource, idsave, dest;

  <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[i] != i)
        {
          Psource = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i];
          SphPsource = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i];

          idsource = <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[i];
          dest = <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[i];

          <span class="keywordflow">do</span>
            {
              Psave = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[dest];
              SphPsave = <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[dest];
              idsave = <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[dest];

              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[dest] = Psource;
              <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[dest] = SphPsource;
              <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[dest] = idsource;

              <span class="keywordflow">if</span>(dest == i)
                <span class="keywordflow">break</span>;

              Psource = Psave;
              SphPsource = SphPsave;
              idsource = idsave;

              dest = idsource;
            }
          <span class="keywordflow">while</span>(1);
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af744cef873e3093ba2924da8265d1711_icgraph.png" border="0" usemap="#proto_8h_af744cef873e3093ba2924da8265d1711_icgraph" alt=""/></div>
<map name="proto_8h_af744cef873e3093ba2924da8265d1711_icgraph" id="proto_8h_af744cef873e3093ba2924da8265d1711_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="153,57,303,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="352,57,525,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="573,5,792,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="852,56,895,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="663,109,703,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="956,83,1009,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="840,109,907,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="afcb358154dd7fd5de8b4156f417fb0ba"></a><!-- doxytag: member="proto.h::reorder_particles" ref="afcb358154dd7fd5de8b4156f417fb0ba" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void reorder_particles </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function brings the collisionless particles into the same order as the sorted keys. (The sort is first done only on the keys themselves and done directly on the particles in order to reduce the amount of data that needs to be moved in memory. Only once the order is established, the particles are rearranged, such that each particle has to be moved at most once.) </p>

<p>Definition at line <a class="el" href="peano_8c_source.html#l00166">166</a> of file <a class="el" href="peano_8c_source.html">peano.c</a>.</p>

<p>References <a class="el" href="peano_8c_source.html#l00026">Id</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, and <a class="el" href="allvars_8c_source.html#l00120">P</a>.</p>

<p>Referenced by <a class="el" href="peano_8c_source.html#l00034">peano_hilbert_order()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;
  <span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a> Psave, Psource;
  <span class="keywordtype">int</span> idsource, idsave, dest;

  <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[i] != i)
        {
          Psource = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i];
          idsource = <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[i];

          dest = <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[i];

          <span class="keywordflow">do</span>
            {
              Psave = <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[dest];
              idsave = <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[dest];

              <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[dest] = Psource;
              <a class="code" href="peano_8c.html#a202e834159688d90a2ea91fb77e7a094">Id</a>[dest] = idsource;

              <span class="keywordflow">if</span>(dest == i)
                <span class="keywordflow">break</span>;

              Psource = Psave;
              idsource = idsave;

              dest = idsource;
            }
          <span class="keywordflow">while</span>(1);
        }
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_afcb358154dd7fd5de8b4156f417fb0ba_icgraph.png" border="0" usemap="#proto_8h_afcb358154dd7fd5de8b4156f417fb0ba_icgraph" alt=""/></div>
<map name="proto_8h_afcb358154dd7fd5de8b4156f417fb0ba_icgraph" id="proto_8h_afcb358154dd7fd5de8b4156f417fb0ba_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="185,57,335,87"/><area shape="rect" id="node5" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="384,57,557,87"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="605,5,824,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="884,56,927,85"/><area shape="rect" id="node13" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="695,109,735,139"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="988,83,1041,112"/><area shape="rect" id="node15" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="872,109,939,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af3e3dd8294f983f9ed9f75c81d149ec9"></a><!-- doxytag: member="proto.h::restart" ref="af3e3dd8294f983f9ed9f75c81d149ec9" args="(int mod)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void restart </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>modus</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function reads or writes the restart files. Each processor writes its own restart file, with the I/O being done in parallel. To avoid congestion of the disks you can tell the program to restrict the number of files that are simultaneously written to NumFilesWrittenInParallel.</p>
<p>If modus&gt;0 the <a class="el" href="proto_8h.html#af3e3dd8294f983f9ed9f75c81d149ec9">restart()</a>-routine reads, if modus==0 it writes a restart file. </p>

<p><p>&lt; defines maximum length of neighbour list</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition</p>
<p>&lt; Maximum number of nodes in the top-level tree used for domain decomposition </p>
</p>

<p>Definition at line <a class="el" href="restart_8c_source.html#l00035">35</a> of file <a class="el" href="restart_8c_source.html">restart.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allocate_8c_source.html#l00103">allocate_memory()</a>, <a class="el" href="restart_8c_source.html#l00289">byten()</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="allvars_8c_source.html#l00049">DomainCenter</a>, <a class="el" href="allvars_8c_source.html#l00048">DomainCorner</a>, <a class="el" href="allvars_8c_source.html#l00055">DomainEndList</a>, <a class="el" href="allvars_8c_source.html#l00051">DomainFac</a>, <a class="el" href="allvars_8c_source.html#l00063">DomainHmax</a>, <a class="el" href="allvars_8c_source.html#l00050">DomainLen</a>, <a class="el" href="allvars_8c_source.html#l00065">DomainMoment</a>, <a class="el" href="allvars_8c_source.html#l00053">DomainMyLast</a>, <a class="el" href="allvars_8c_source.html#l00052">DomainMyStart</a>, <a class="el" href="allvars_8c_source.html#l00061">DomainNodeIndex</a>, <a class="el" href="allvars_8c_source.html#l00054">DomainStartList</a>, <a class="el" href="allvars_8c_source.html#l00060">DomainTask</a>, <a class="el" href="allvars_8c_source.html#l00062">DomainTreeNodeLen</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="allvars_8c_source.html#l00152">Extnodes_base</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="allvars_8h_source.html#l00119">FLOAT</a>, <a class="el" href="forcetree_8c_source.html#l02827">force_treeallocate()</a>, <a class="el" href="restart_8c_source.html#l00300">in()</a>, <a class="el" href="allvars_8h_source.html#l00107">MAX_NGB</a>, <a class="el" href="allvars_8c_source.html#l00139">MaxNodes</a>, <a class="el" href="allvars_8h_source.html#l00275">global_data_all_processes::MaxPart</a>, <a class="el" href="allvars_8h_source.html#l00276">global_data_all_processes::MaxPartSph</a>, <a class="el" href="allvars_8h_source.html#l00045">MAXTOPNODES</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00148">Nextnode</a>, <a class="el" href="ngb_8c_source.html#l00358">ngb_treeallocate()</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes_base</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="allvars_8h_source.html#l00285">global_data_all_processes::NumFilesWrittenInParallel</a>, <a class="el" href="allvars_8c_source.html#l00140">Numnodestree</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00490">global_data_all_processes::OutputDir</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="allvars_8h_source.html#l00294">global_data_all_processes::PartAllocFactor</a>, <a class="el" href="allvars_8c_source.html#l00043">random_generator</a>, <a class="el" href="allvars_8h_source.html#l00496">global_data_all_processes::RestartFile</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00273">global_data_all_processes::TotN_gas</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00298">global_data_all_processes::TreeAllocFactor</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>, and <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">char</span> buf[200], buf_bak[200], buf_mv[500];
  <span class="keywordtype">double</span> save_PartAllocFactor, save_TreeAllocFactor;
  <span class="keywordtype">int</span> i, nprocgroup, masterTask, groupTask, old_MaxPart, old_MaxNodes;
  <span class="keyword">struct </span><a class="code" href="structglobal__data__all__processes.html">global_data_all_processes</a> all_task0;


  sprintf(buf, <span class="stringliteral">&quot;%s%s.%d&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a67e197a37469217aa8ad32c42230b286">RestartFile</a>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
  sprintf(buf_bak, <span class="stringliteral">&quot;%s%s.%d.bak&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a67e197a37469217aa8ad32c42230b286">RestartFile</a>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
  sprintf(buf_mv, <span class="stringliteral">&quot;mv %s %s&quot;</span>, buf, buf_bak);


  <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>))
    {
      printf
        (<span class="stringliteral">&quot;Fatal error.\nNumber of processors must be a smaller or equal than `NumFilesWrittenInParallel&#39;.\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(2131);
    }

  nprocgroup = <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>;

  <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> % <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>))
    {
      nprocgroup++;
    }

  masterTask = (<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> / nprocgroup) * nprocgroup;

  <span class="keywordflow">for</span>(groupTask = 0; groupTask &lt; nprocgroup; groupTask++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == (masterTask + groupTask))  <span class="comment">/* ok, it&#39;s this processor&#39;s turn */</span>
        {
          <span class="keywordflow">if</span>(modus)
            {
              <span class="keywordflow">if</span>(!(<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a> = fopen(buf, <span class="stringliteral">&quot;r&quot;</span>)))
                {
                  printf(<span class="stringliteral">&quot;Restart file &#39;%s&#39; not found.\n&quot;</span>, buf);
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(7870);
                }
            }
          <span class="keywordflow">else</span>
            {
              system(buf_mv);   <span class="comment">/* move old restart files to .bak files */</span>

              <span class="keywordflow">if</span>(!(<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a> = fopen(buf, <span class="stringliteral">&quot;w&quot;</span>)))
                {
                  printf(<span class="stringliteral">&quot;Restart file &#39;%s&#39; cannot be opened.\n&quot;</span>, buf);
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(7878);
                }
            }


          save_PartAllocFactor = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a>;
          save_TreeAllocFactor = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a>;

          <span class="comment">/* common data  */</span>
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(&amp;<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structglobal__data__all__processes.html">global_data_all_processes</a>), modus);

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0 &amp;&amp; modus &gt; 0)
            all_task0 = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>;

          <span class="keywordflow">if</span>(modus &gt; 0 &amp;&amp; groupTask == 0)       <span class="comment">/* read */</span>
            {
              MPI_Bcast(&amp;all_task0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structglobal__data__all__processes.html">global_data_all_processes</a>), MPI_BYTE, 0, MPI_COMM_WORLD);
            }

          old_MaxPart = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;
          old_MaxNodes = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>;

          <span class="keywordflow">if</span>(modus)             <span class="comment">/* read */</span>
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a> != save_PartAllocFactor)
                {
                  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a> = save_PartAllocFactor;
                  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a> * (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a> / <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
                  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a> * (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2bb70816a4d5f56e0df2d9b8d706cef2">TotN_gas</a> / <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>);
                  save_PartAllocFactor = -1;
                }

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> != save_TreeAllocFactor)
                {
                  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> = save_TreeAllocFactor;
                  save_TreeAllocFactor = -1;
                }

              <span class="keywordflow">if</span>(all_task0.Time != <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>)
                {
                  printf(<span class="stringliteral">&quot;The restart file on task=%d is not consistent with the one on task=0\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>);
                  fflush(stdout);
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(16);
                }

              <a class="code" href="allocate_8c.html#a7fe5e304baaf5f418a22fef9a9cc02c7">allocate_memory</a>();
            }

          <a class="code" href="restart_8c.html#a2f4631df8dbc2cc10c5d7ce28c975ad5">in</a>(&amp;<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>, modus);

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>)
            {
              printf
                (<span class="stringliteral">&quot;it seems you have reduced(!) &#39;PartAllocFactor&#39; below the value of %g needed to load the restart file.\n&quot;</span>,
                 <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> / (((<span class="keywordtype">double</span>) <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a>) / <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>));
              printf(<span class="stringliteral">&quot;fatal error\n&quot;</span>);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(22);
            }

          <span class="comment">/* Particle data  */</span>
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(&amp;<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[0], <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), modus);

          <a class="code" href="restart_8c.html#a2f4631df8dbc2cc10c5d7ce28c975ad5">in</a>(&amp;<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>, modus);

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> &gt; 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a43dccd3997af759d43a2f3bcce44a2c4">MaxPartSph</a>)
                {
                  printf
                    (<span class="stringliteral">&quot;SPH: it seems you have reduced(!) &#39;PartAllocFactor&#39; below the value of %g needed to load the restart file.\n&quot;</span>,
                     <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> / (((<span class="keywordtype">double</span>) <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2bb70816a4d5f56e0df2d9b8d706cef2">TotN_gas</a>) / <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>));
                  printf(<span class="stringliteral">&quot;fatal error\n&quot;</span>);
                  <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(222);
                }
              <span class="comment">/* Sph-Particle data  */</span>
              <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(&amp;<a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[0], <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>), modus);
            }

          <span class="comment">/* write state of random number generator */</span>
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(gsl_rng_state(<a class="code" href="allvars_8c.html#a4ec93729b85eb5da23dd6ffb23c3702b">random_generator</a>), gsl_rng_size(<a class="code" href="allvars_8c.html#a4ec93729b85eb5da23dd6ffb23c3702b">random_generator</a>), modus);


          <span class="comment">/* now store relevant data for tree */</span>

          <span class="keywordflow">if</span>(modus)             <span class="comment">/* read */</span>
            {
              <a class="code" href="ngb_8c.html#a6f7a3b85f10701b9067f012cc9a30f55">ngb_treeallocate</a>(<a class="code" href="allvars_8h.html#a459bf1b27bb8a17c4496d2783e62161c">MAX_NGB</a>);

              <a class="code" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2">force_treeallocate</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>);
            }


          <a class="code" href="restart_8c.html#a2f4631df8dbc2cc10c5d7ce28c975ad5">in</a>(&amp;<a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a>, modus);

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a> &gt; <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>)
            {
              printf
                (<span class="stringliteral">&quot;Tree storage: it seems you have reduced(!) &#39;PartAllocFactor&#39; below the value needed to load the restart file (task=%d). &quot;</span>
                 <span class="stringliteral">&quot;Numnodestree=%d  MaxNodes=%d\n&quot;</span>, <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>, <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a>, <a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a>);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(221);
            }

          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>, <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structNODE.html">NODE</a>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#a57932378336b142ac6e6a9ddb60dce3f">Extnodes_base</a>, <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structextNODE.html">extNODE</a>), modus);

          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>, <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);

          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>, <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a> + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>, <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);

          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#a3c2a7b96fe94b5151d568fe321888d23">DomainStartList</a>, <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#abb42257c117a39d968334cd054c16dcf">DomainEndList</a>, <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#a6f4a30ea20d1347d14d2e32de91390bb">DomainTask</a>, <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>, <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#a52e5390127f5298d6639b9399077bfbf">DomainTreeNodeLen</a>, <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#a5a4689ebf26bc52b81819580362ef4dc">DomainHmax</a>, <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#ae8690abbffa85934d64d545920e2b108">FLOAT</a>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#ad90674eef0b2180889d1620d5cc8672b">DomainMoment</a>, <a class="code" href="allvars_8h.html#a803069f3cb8753ac3db10d5decebfc0d">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structDomainNODE.html">DomainNODE</a>), modus);

          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#a55dacf524ba7bbc5210fc68469a05d0f">DomainCorner</a>, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(<a class="code" href="allvars_8c.html#ad13aabcbb50307c005ffa0b2edccdaeb">DomainCenter</a>, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(&amp;<a class="code" href="allvars_8c.html#a3dd9593672bf68f0c36fa3e5451e9265">DomainLen</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(&amp;<a class="code" href="allvars_8c.html#a4488078cfcc203156f193c43a1d3a2ef">DomainFac</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(&amp;<a class="code" href="allvars_8c.html#a424b31dae72cd3331485d2fb6490c7ac">DomainMyStart</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);
          <a class="code" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21">byten</a>(&amp;<a class="code" href="allvars_8c.html#ad6c1a01f55d5c8b7b642525118acbebe">DomainMyLast</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), modus);

          <span class="keywordflow">if</span>(modus)             <span class="comment">/* read */</span>
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aa9ceb5cacadcf2cadfc7154ab8d7fc88">PartAllocFactor</a> != save_PartAllocFactor || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a374a92c40b930e388b7180b8862c3670">TreeAllocFactor</a> != save_TreeAllocFactor)
              {
                <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; i++)
                  <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[i] += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart);

                <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[i] &gt;= old_MaxPart)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[i] &gt;= old_MaxPart + old_MaxNodes)
                        <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[i] += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart) + (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> - old_MaxPart);
                      <span class="keywordflow">else</span>
                        <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[i] += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart);
                    }

                <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#acf4151281b98d29aa500c5e56e66741f">Numnodestree</a>; i++)
                  {
                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling &gt;= old_MaxPart)
                      {
                        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling &gt;= old_MaxPart + old_MaxNodes)
                          <a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling +=
                            (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart) + (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> - old_MaxNodes);
                        <span class="keywordflow">else</span>
                          <a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.sibling += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart);
                      }

                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father &gt;= old_MaxPart)
                      {
                        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father &gt;= old_MaxPart + old_MaxNodes)
                          <a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart) + (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> - old_MaxNodes);
                        <span class="keywordflow">else</span>
                          <a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart);
                      }

                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode &gt;= old_MaxPart)
                      {
                        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].u.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode &gt;= old_MaxPart + old_MaxNodes)
                          <a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode +=
                            (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart) + (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> - old_MaxNodes);
                        <span class="keywordflow">else</span>
                          <a class="code" href="allvars_8c.html#a0cb940c6ac9331805bcc91b437c78e9a">Nodes_base</a>[i].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.nextnode += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart);
                      }
                  }

                <span class="keywordflow">for</span>(i = 0; i &lt; MAXTOPNODES; i++)
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[i + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>] &gt;= old_MaxPart)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[i + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>] &gt;= old_MaxPart + old_MaxNodes)
                        <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[i + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>] += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart) + (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> - old_MaxNodes);
                      <span class="keywordflow">else</span>
                        <a class="code" href="allvars_8c.html#ad14ab43f541f9c33cb9222ea018c1365">Nextnode</a>[i + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a>] += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart);
                    }

                <span class="keywordflow">for</span>(i = 0; i &lt; MAXTOPNODES; i++)
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i] &gt;= old_MaxPart)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i] &gt;= old_MaxPart + old_MaxNodes)
                        <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i] += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart) + (<a class="code" href="allvars_8c.html#aca70a1751175167a36c1c6775a338bee">MaxNodes</a> - old_MaxNodes);
                      <span class="keywordflow">else</span>
                        <a class="code" href="allvars_8c.html#acd2b211f08f9b7e83da8cb58bf3931a0">DomainNodeIndex</a>[i] += (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a413b30e91ae833d0c78b42744a99e67f">MaxPart</a> - old_MaxPart);
                    }
              }

          fclose(<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>);
        }
      <span class="keywordflow">else</span>                      <span class="comment">/* wait inside the group */</span>
        {
          <span class="keywordflow">if</span>(modus &gt; 0 &amp;&amp; groupTask == 0)       <span class="comment">/* read */</span>
            {
              MPI_Bcast(&amp;all_task0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structglobal__data__all__processes.html">global_data_all_processes</a>), MPI_BYTE, 0, MPI_COMM_WORLD);
            }
        }

      MPI_Barrier(MPI_COMM_WORLD);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9_cgraph.png" border="0" usemap="#proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9_cgraph" alt=""/></div>
<map name="proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9_cgraph" id="proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9_cgraph">
<area shape="rect" id="node3" href="allocate_8c.html#a7fe5e304baaf5f418a22fef9a9cc02c7" title="allocate_memory" alt="" coords="301,55,435,84"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="485,135,552,164"/><area shape="rect" id="node9" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21" title="byten" alt="" coords="156,108,215,138"/><area shape="rect" id="node18" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="300,215,436,244"/><area shape="rect" id="node21" href="restart_8c.html#a2f4631df8dbc2cc10c5d7ce28c975ad5" title="in" alt="" coords="167,162,204,191"/><area shape="rect" id="node25" href="ngb_8c.html#a6f7a3b85f10701b9067f012cc9a30f55" title="ngb_treeallocate" alt="" coords="121,266,249,295"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="600,135,757,164"/><area shape="rect" id="node11" href="io_8c.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="327,108,409,138"/><area shape="rect" id="node14" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="327,162,409,191"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9_icgraph.png" border="0" usemap="#proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9_icgraph" alt=""/></div>
<map name="proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9_icgraph" id="proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="120,5,187,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="132,59,175,88"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="236,32,289,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a05e0ffe612d44e6d7f3a9ae5b9df56a2"></a><!-- doxytag: member="proto.h::run" ref="a05e0ffe612d44e6d7f3a9ae5b9df56a2" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void run </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine contains the main simulation loop that iterates over single timesteps. The loop terminates when the cpu-time limit is reached, when a `stop' file is found in the output directory, or when the simulation ends because we arrived at TimeMax. </p>

<p><p>&lt; The simulated timespan is mapped onto the integer interval [0,TIMESPAN], * where TIMESPAN needs to be a power of 2. Note that (1&lt;&lt;28) corresponds to 2^29 </p>
</p>

<p>Definition at line <a class="el" href="run_8c_source.html#l00020">20</a> of file <a class="el" href="run_8c_source.html">run.c</a>.</p>

<p>References <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="begrun_8c_source.html#l00262">close_outputfiles()</a>, <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>, <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="allvars_8h_source.html#l00412">global_data_all_processes::CPU_Total</a>, <a class="el" href="allvars_8c_source.html#l00027">CPUThisRun</a>, <a class="el" href="allvars_8h_source.html#l00360">global_data_all_processes::CpuTimeBetRestartFile</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="run_8c_source.html#l00432">energy_statistics()</a>, <a class="el" href="run_8c_source.html#l00370">every_timestep_stuff()</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>, <a class="el" href="allvars_8h_source.html#l00364">global_data_all_processes::NumCurrentTiStep</a>, <a class="el" href="allvars_8h_source.html#l00490">global_data_all_processes::OutputDir</a>, <a class="el" href="restart_8c_source.html#l00035">restart()</a>, <a class="el" href="allvars_8h_source.html#l00497">global_data_all_processes::ResubmitCommand</a>, <a class="el" href="allvars_8h_source.html#l00349">global_data_all_processes::ResubmitOn</a>, <a class="el" href="io_8c_source.html#l00033">savepositions()</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8h_source.html#l00357">global_data_all_processes::SnapshotFileCount</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00378">global_data_all_processes::Ti_Current</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00041">TIMEBASE</a>, <a class="el" href="allvars_8h_source.html#l00362">global_data_all_processes::TimeBetStatistics</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00361">global_data_all_processes::TimeLastRestartFile</a>, <a class="el" href="allvars_8h_source.html#l00363">global_data_all_processes::TimeLastStatistics</a>, <a class="el" href="allvars_8h_source.html#l00405">global_data_all_processes::TimeLimitCPU</a>, and <a class="el" href="allvars_8h_source.html#l00372">global_data_all_processes::TimeMax</a>.</p>

<p>Referenced by <a class="el" href="main_8c_source.html#l00022">main()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>;
  <span class="keywordtype">int</span> stopflag = 0;
  <span class="keywordtype">char</span> stopfname[200], contfname[200];
  <span class="keywordtype">double</span> t0, t1;


  sprintf(stopfname, <span class="stringliteral">&quot;%sstop&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>);
  sprintf(contfname, <span class="stringliteral">&quot;%scont&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>);
  unlink(contfname);

  <span class="keywordflow">do</span>                            <span class="comment">/* main loop */</span>
    {
      t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

      <a class="code" href="proto_8h.html#ad52604af910b3e1677718d863ab09391">find_next_sync_point_and_drift</a>(); <span class="comment">/* find next synchronization point and drift particles to this time.</span>
<span class="comment">                                         * If needed, this function will also write an output file</span>
<span class="comment">                                         * at the desired time.</span>
<span class="comment">                                         */</span>

      <a class="code" href="proto_8h.html#a7e26319b203616f2c85b5fd6f2ade85d">every_timestep_stuff</a>();   <span class="comment">/* write some info to log-files */</span>


      <a class="code" href="domain_8c.html#ae8e3aa408eaab9544cb7f93e69185492">domain_Decomposition</a>();   <span class="comment">/* do domain decomposition if needed */</span>


      <a class="code" href="accel_8c.html#a147f9422f4bca4666608da992486b417">compute_accelerations</a>(0); <span class="comment">/* compute accelerations for </span>
<span class="comment">                                 * the particles that are to be advanced  </span>
<span class="comment">                                 */</span>

      <span class="comment">/* check whether we want a full energy statistics */</span>
      <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab088f20e7889a88f2e0f652df4781e44">TimeLastStatistics</a>) &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a516be9ff5c4fd4171aa8e1a687e1e72d">TimeBetStatistics</a>)
        {
<span class="preprocessor">#ifdef COMPUTE_POTENTIAL_ENERGY</span>
<span class="preprocessor"></span>          <a class="code" href="potential_8c.html#a04474459731219f9601aaefedb37ab27">compute_potential</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>          <a class="code" href="proto_8h.html#ae903322da17c6875ab606b032b918099">energy_statistics</a>();  <span class="comment">/* compute and output energy statistics */</span>
          <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab088f20e7889a88f2e0f652df4781e44">TimeLastStatistics</a> += <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a516be9ff5c4fd4171aa8e1a687e1e72d">TimeBetStatistics</a>;
        }

      <a class="code" href="proto_8h.html#a05e5a546d63684b55d2457aa56efdd06">advance_and_find_timesteps</a>();     <span class="comment">/* &#39;kick&#39; active particles in</span>
<span class="comment">                                         * momentum space and compute new</span>
<span class="comment">                                         * timesteps for them</span>
<span class="comment">                                         */</span>
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a35de8a7666698b80478bfedf4362e844">NumCurrentTiStep</a>++;

      <span class="comment">/* Check whether we need to interrupt the run */</span>
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          <span class="comment">/* Is the stop-file present? If yes, interrupt the run. */</span>
          <span class="keywordflow">if</span>((fd = fopen(stopfname, <span class="stringliteral">&quot;r&quot;</span>)))
            {
              fclose(fd);
              stopflag = 1;
              unlink(stopfname);
            }

          <span class="comment">/* are we running out of CPU-time ? If yes, interrupt run. */</span>
          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a2550e86a899b36eaf7428b23f98a05ec">CPUThisRun</a> &gt; 0.85 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accf0e0ec1acab3f51f583470910049d2">TimeLimitCPU</a>)
            {
              printf(<span class="stringliteral">&quot;reaching time-limit. stopping.\n&quot;</span>);
              stopflag = 2;
            }
        }

      MPI_Bcast(&amp;stopflag, 1, MPI_INT, 0, MPI_COMM_WORLD);

      <span class="keywordflow">if</span>(stopflag)
        {
          <a class="code" href="proto_8h.html#af3e3dd8294f983f9ed9f75c81d149ec9">restart</a>(0);           <span class="comment">/* write restart file */</span>
          MPI_Barrier(MPI_COMM_WORLD);

          <span class="keywordflow">if</span>(stopflag == 2 &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
            {
              <span class="keywordflow">if</span>((fd = fopen(contfname, <span class="stringliteral">&quot;w&quot;</span>)))
                fclose(fd);
            }

          <span class="keywordflow">if</span>(stopflag == 2 &amp;&amp; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6578ce0ee08f770891c662c0ab4ad10c">ResubmitOn</a> &amp;&amp; <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
            {
              <a class="code" href="begrun_8c.html#aa1abb9ee0e0a43ec19cdaa55c8ecd43c">close_outputfiles</a>();
              system(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a59f86964a3a1b03933a787cfc280951a">ResubmitCommand</a>);
            }
          <span class="keywordflow">return</span>;
        }

      <span class="comment">/* is it time to write a regular restart-file? (for security) */</span>
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        {
          <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a2550e86a899b36eaf7428b23f98a05ec">CPUThisRun</a> - <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1042ebf3c648c2b23dca6fc65ff22785">TimeLastRestartFile</a>) &gt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af087b459cc41cb6b81bdbdd0e339cb6f">CpuTimeBetRestartFile</a>)
            {
              <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1042ebf3c648c2b23dca6fc65ff22785">TimeLastRestartFile</a> = <a class="code" href="allvars_8c.html#a2550e86a899b36eaf7428b23f98a05ec">CPUThisRun</a>;
              stopflag = 3;
            }
          <span class="keywordflow">else</span>
            stopflag = 0;
        }

      MPI_Bcast(&amp;stopflag, 1, MPI_INT, 0, MPI_COMM_WORLD);

      <span class="keywordflow">if</span>(stopflag == 3)
        {
          <a class="code" href="proto_8h.html#af3e3dd8294f983f9ed9f75c81d149ec9">restart</a>(0);           <span class="comment">/* write an occasional restart file */</span>
          stopflag = 0;
        }

      t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3d87cd9a94ce540341d4fb713b253c9e">CPU_Total</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);
      <a class="code" href="allvars_8c.html#a2550e86a899b36eaf7428b23f98a05ec">CPUThisRun</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);
    }
  <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0720db6b598f7295ec843708a1d3c6f">Ti_Current</a> &lt; <a class="code" href="allvars_8h.html#ad44dabdb7a0bef8536e2d34a01177d48">TIMEBASE</a> &amp;&amp; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> &lt;= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3e22fbc2ce177c1e383e9acbbf44f8d5">TimeMax</a>);

  <a class="code" href="proto_8h.html#af3e3dd8294f983f9ed9f75c81d149ec9">restart</a>(0);

  <a class="code" href="io_8c.html#a523730833804b6d92aa7f4dd474805c5">savepositions</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aac0d3fcbac688a31e6bda55ef819c44b">SnapshotFileCount</a>++);       <span class="comment">/* write a last snapshot</span>
<span class="comment">                                                 * file at final time (will</span>
<span class="comment">                                                 * be overwritten if</span>
<span class="comment">                                                 * All.TimeMax is increased</span>
<span class="comment">                                                 * and the run is continued)</span>
<span class="comment">                                                 */</span>
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a05e0ffe612d44e6d7f3a9ae5b9df56a2_cgraph.png" border="0" usemap="#proto_8h_a05e0ffe612d44e6d7f3a9ae5b9df56a2_cgraph" alt=""/></div>
<map name="proto_8h_a05e0ffe612d44e6d7f3a9ae5b9df56a2_cgraph" id="proto_8h_a05e0ffe612d44e6d7f3a9ae5b9df56a2_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="392,450,600,479"/><area shape="rect" id="node20" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="759,239,825,268"/><area shape="rect" id="node22" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="757,551,827,580"/><area shape="rect" id="node25" href="begrun_8c.html#aa1abb9ee0e0a43ec19cdaa55c8ecd43c" title="close_outputfiles" alt="" coords="141,502,269,531"/><area shape="rect" id="node27" href="accel_8c.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="120,294,291,323"/><area shape="rect" id="node69" href="potential_8c.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="425,815,567,844"/><area shape="rect" id="node93" href="domain_8c.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="409,1328,583,1358"/><area shape="rect" id="node104" href="proto_8h.html#ae903322da17c6875ab606b032b918099" title="energy_statistics" alt="" coords="140,688,271,718"/><area shape="rect" id="node111" href="proto_8h.html#a7e26319b203616f2c85b5fd6f2ade85d" title="every_timestep_stuff" alt="" coords="128,610,283,639"/><area shape="rect" id="node115" href="proto_8h.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="96,754,315,783"/><area shape="rect" id="node129" href="io_8c.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="441,1548,551,1578"/><area shape="rect" id="node144" href="proto_8h.html#af3e3dd8294f983f9ed9f75c81d149ec9" title="restart" alt="" coords="760,1487,824,1516"/><area shape="rect" id="node5" href="proto_8h.html#a78ed439b8a1cb93647a2b9de998d9269" title="find_dt_displacement_constraint" alt="" coords="677,394,907,423"/><area shape="rect" id="node7" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="1073,526,1119,555"/><area shape="rect" id="node9" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="719,604,865,634"/><area shape="rect" id="node11" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="715,708,869,738"/><area shape="rect" id="node13" href="proto_8h.html#a0d508d57eb6f608ff6eec8ac11bb9c05" title="get_random_number" alt="" coords="713,79,871,108"/><area shape="rect" id="node15" href="proto_8h.html#a1d72b071e6cb4691ecc0da4de4cb8af8" title="get_timestep" alt="" coords="1043,419,1149,448"/><area shape="rect" id="node17" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="1285,1223,1352,1252"/><area shape="rect" id="node29" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="463,31,529,60"/><area shape="rect" id="node35" href="forcetree_8c.html#a4764c1fb83a956c1712345538630854c" title="force_update_hmax" alt="" coords="421,188,571,218"/><area shape="rect" id="node37" href="gravtree__forcetest_8c.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="432,84,560,114"/><area shape="rect" id="node47" href="gravtree_8c.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="447,242,545,271"/><area shape="rect" id="node55" href="hydra_8c.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="448,396,544,426"/><area shape="rect" id="node60" href="longrange_8c.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="431,1148,561,1178"/><area shape="rect" id="node41" href="gravtree_8c.html#ae9c157451dcc4cdbe02813141df2be42" title="grav_tree_compare_key" alt="" coords="704,132,880,162"/><area shape="rect" id="node44" href="gravtree_8c.html#aab39b7857a85e95ef6f926ac82d4ff91" title="set_softenings" alt="" coords="735,186,849,215"/><area shape="rect" id="node49" href="forcetree_8c.html#a10f92098e86f82baec9f84a283f4c9e5" title="force_treebuild" alt="" coords="733,447,851,476"/><area shape="rect" id="node63" href="proto_8h.html#a57f2f415791cd83ace42bff59b2feb97" title="pm_init_regionsize" alt="" coords="721,1122,863,1151"/><area shape="rect" id="node65" href="proto_8h.html#ae3950c19708f6a2886dd32897efa10c4" title="pm_setup_nonperiodic_kernel" alt="" coords="685,1175,899,1204"/><area shape="rect" id="node73" href="forcetree_8c.html#af29d257a1e4545ba4b9c3648444979b6" title="force_treeevaluate_potential" alt="" coords="993,991,1199,1020"/><area shape="rect" id="node76" href="forcetree_8c.html#abd9d86a6c08e77a4fa78fa76b96cdde7" title="force_treeevaluate_potential_shortrange" alt="" coords="955,1094,1237,1123"/><area shape="rect" id="node82" href="proto_8h.html#a480e7cb454d4e690653cc0db2bb9ebf9" title="pmpotential_nonperiodic" alt="" coords="703,863,881,892"/><area shape="rect" id="node84" href="pm__periodic_8c.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="715,1068,869,1098"/><area shape="rect" id="node86" href="forcetree_8c.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="1028,1276,1164,1306"/><area shape="rect" id="node95" href="predict_8c.html#adda9e167a16a53d1aa40180406950446" title="do_box_wrapping" alt="" coords="727,1434,857,1463"/><area shape="rect" id="node97" href="domain_8c.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="1020,1330,1172,1359"/><area shape="rect" id="node100" href="peano_8c.html#af3e45a4293584b3fe28e83af75c6ed71" title="peano_hilbert_order" alt="" coords="717,1380,867,1410"/><area shape="rect" id="node106" href="global_8c.html#ada58109949c2431ca9b0cdaa01cfb5b1" title="compute_global_quantities_of_system" alt="" coords="363,762,629,791"/><area shape="rect" id="node113" href="proto_8h.html#a9cb45ef22cae101906f021fb7a23afbe" title="set_random_numbers" alt="" coords="415,604,577,634"/><area shape="rect" id="node119" href="proto_8h.html#a532b4637166ab194c1b1d0dee9f003f2" title="find_next_outputtime" alt="" coords="1017,1223,1175,1252"/><area shape="rect" id="node122" href="predict_8c.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="437,708,555,738"/><area shape="rect" id="node131" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab" title="distribute_file" alt="" coords="739,1564,845,1594"/><area shape="rect" id="node135" href="io_8c.html#a10281a87abe1e07d6ca603de6a533345" title="fill_Tab_IO_Labels" alt="" coords="727,1618,857,1647"/><area shape="rect" id="node139" href="io_8c.html#a2b3f5bacd7313da0f3ffa55e41907481" title="write_file" alt="" coords="1057,1658,1135,1687"/><area shape="rect" id="node146" href="allocate_8c.html#a7fe5e304baaf5f418a22fef9a9cc02c7" title="allocate_memory" alt="" coords="1029,1487,1163,1516"/><area shape="rect" id="node149" href="restart_8c.html#aaecf930e789ca4889b8e40770306fe21" title="byten" alt="" coords="1067,1540,1125,1570"/><area shape="rect" id="node153" href="restart_8c.html#a2f4631df8dbc2cc10c5d7ce28c975ad5" title="in" alt="" coords="1077,1594,1115,1623"/><area shape="rect" id="node155" href="ngb_8c.html#a6f7a3b85f10701b9067f012cc9a30f55" title="ngb_treeallocate" alt="" coords="1032,1383,1160,1412"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a05e0ffe612d44e6d7f3a9ae5b9df56a2_icgraph.png" border="0" usemap="#proto_8h_a05e0ffe612d44e6d7f3a9ae5b9df56a2_icgraph" alt=""/></div>
<map name="proto_8h_a05e0ffe612d44e6d7f3a9ae5b9df56a2_icgraph" id="proto_8h_a05e0ffe612d44e6d7f3a9ae5b9df56a2_icgraph">
<area shape="rect" id="node3" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="97,5,151,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a523730833804b6d92aa7f4dd474805c5"></a><!-- doxytag: member="proto.h::savepositions" ref="a523730833804b6d92aa7f4dd474805c5" args="(int num)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void savepositions </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>num</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function writes a snapshot of the particle distribution to one or several files using the selected file format. If NumFilesPerSnapshot&gt;1, the snapshot is distributed onto several files, several of them can be written simultaneously (up to NumFilesWrittenInParallel). Each file contains data from a group of processors. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00033">33</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00411">global_data_all_processes::CPU_Snapshot</a>, <a class="el" href="read__ic_8c_source.html#l00724">distribute_file()</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="io_8c_source.html#l00566">fill_Tab_IO_Labels()</a>, <a class="el" href="io_8c_source.html#l00021">n_type</a>, <a class="el" href="allvars_8c_source.html#l00016">NTask</a>, <a class="el" href="io_8c_source.html#l00022">ntot_type_all</a>, <a class="el" href="allvars_8h_source.html#l00284">global_data_all_processes::NumFilesPerSnapshot</a>, <a class="el" href="allvars_8h_source.html#l00285">global_data_all_processes::NumFilesWrittenInParallel</a>, <a class="el" href="allvars_8h_source.html#l00316">global_data_all_processes::NumForcesSinceLastDomainDecomp</a>, <a class="el" href="allvars_8c_source.html#l00019">NumPart</a>, <a class="el" href="allvars_8h_source.html#l00490">global_data_all_processes::OutputDir</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="system_8c_source.html#l00049">second()</a>, <a class="el" href="allvars_8h_source.html#l00282">global_data_all_processes::SnapFormat</a>, <a class="el" href="allvars_8h_source.html#l00491">global_data_all_processes::SnapshotFileBase</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="system_8c_source.html#l00070">timediff()</a>, <a class="el" href="allvars_8h_source.html#l00272">global_data_all_processes::TotNumPart</a>, <a class="el" href="allvars_8h_source.html#l00452">global_data_all_processes::TreeDomainUpdateFrequency</a>, and <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p>Referenced by <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>, and <a class="el" href="run_8c_source.html#l00020">run()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> t0, t1;
  <span class="keywordtype">char</span> buf[500];
  <span class="keywordtype">int</span> i, j, *temp, n, filenr, gr, ngroups, masterTask, lastTask;

  t0 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;\nwriting snapshot file... \n&quot;</span>);

<span class="preprocessor">#if defined(SFR) || defined(BLACK_HOLES)</span>
<span class="preprocessor"></span>  rearrange_particle_sequence();
  <span class="comment">/* ensures that new tree will be constructed */</span>
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a64e0b5f35f25dd09297bc41acf0502f7">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a31f122fafb06e13f611ff905f514bfa9">TreeDomainUpdateFrequency</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a853bbd3ea833c0a6a57af1434b611868">TotNumPart</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> &lt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3749135400fbf51c319054233d7a64a7">NumFilesPerSnapshot</a>)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Fatal error.\nNumber of processors must be larger or equal than All.NumFilesPerSnapshot.\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }
  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> &lt; 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> &gt; 3)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Unsupported File-Format\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }
<span class="preprocessor">#ifndef  HAVE_HDF5</span>
<span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 3)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
        printf(<span class="stringliteral">&quot;Code wasn&#39;t compiled with HDF5 support enabled!\n&quot;</span>);
      <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(0);
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="comment">/* determine global and local particle numbers */</span>
  <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
    <a class="code" href="io_8c.html#a217c441656b4bdc1caf0019b5a809bee">n_type</a>[n] = 0;

  <span class="keywordflow">for</span>(n = 0; n &lt; <a class="code" href="allvars_8c.html#a9ec69b53278f9bbe12890e50299026af">NumPart</a>; n++)
    <a class="code" href="io_8c.html#a217c441656b4bdc1caf0019b5a809bee">n_type</a>[<a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[n].Type]++;

  <span class="comment">/* because ntot_type_all[] is of type `long long&#39;, we cannot do a simple</span>
<span class="comment">   * MPI_Allreduce() to sum the total particle numbers </span>
<span class="comment">   */</span>
  temp = malloc(<a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> * 6 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
  MPI_Allgather(<a class="code" href="io_8c.html#a217c441656b4bdc1caf0019b5a809bee">n_type</a>, 6, MPI_INT, temp, 6, MPI_INT, MPI_COMM_WORLD);
  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    {
      <a class="code" href="io_8c.html#a3cfb701790acb5a9b71ba995148bbf40">ntot_type_all</a>[i] = 0;
      <span class="keywordflow">for</span>(j = 0; j &lt; <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a>; j++)
        <a class="code" href="io_8c.html#a3cfb701790acb5a9b71ba995148bbf40">ntot_type_all</a>[i] += temp[j * 6 + i];
    }
  free(temp);


  <span class="comment">/* assign processors to output files */</span>
  <a class="code" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab">distribute_file</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3749135400fbf51c319054233d7a64a7">NumFilesPerSnapshot</a>, 0, 0, <a class="code" href="allvars_8c.html#a675acdcd149f5993271a1fdc11673b65">NTask</a> - 1, &amp;filenr, &amp;masterTask, &amp;lastTask);

  <a class="code" href="io_8c.html#a10281a87abe1e07d6ca603de6a533345">fill_Tab_IO_Labels</a>();

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3749135400fbf51c319054233d7a64a7">NumFilesPerSnapshot</a> &gt; 1)
    sprintf(buf, <span class="stringliteral">&quot;%s%s_%03d.%d&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4bcf5b5c31545691038015af9ae9acb3">SnapshotFileBase</a>, num, filenr);
  <span class="keywordflow">else</span>
    sprintf(buf, <span class="stringliteral">&quot;%s%s_%03d&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aebda5d1b80cfb767b9668d7858c36bcc">OutputDir</a>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4bcf5b5c31545691038015af9ae9acb3">SnapshotFileBase</a>, num);

  ngroups = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3749135400fbf51c319054233d7a64a7">NumFilesPerSnapshot</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>;
  <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3749135400fbf51c319054233d7a64a7">NumFilesPerSnapshot</a> % <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>))
    ngroups++;

  <span class="keywordflow">for</span>(gr = 0; gr &lt; ngroups; gr++)
    {
      <span class="keywordflow">if</span>((filenr / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0e328240a1fb59c7bf55332a1a691029">NumFilesWrittenInParallel</a>) == gr)        <span class="comment">/* ok, it&#39;s this processor&#39;s turn */</span>
        <a class="code" href="io_8c.html#a2b3f5bacd7313da0f3ffa55e41907481">write_file</a>(buf, masterTask, lastTask);
      MPI_Barrier(MPI_COMM_WORLD);
    }


  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    printf(<span class="stringliteral">&quot;done with snapshot.\n&quot;</span>);

  t1 = <a class="code" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second</a>();

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4b533ec2fc1af7ee057eaa5805a65a7a">CPU_Snapshot</a> += <a class="code" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d">timediff</a>(t0, t1);

}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a523730833804b6d92aa7f4dd474805c5_cgraph.png" border="0" usemap="#proto_8h_a523730833804b6d92aa7f4dd474805c5_cgraph" alt=""/></div>
<map name="proto_8h_a523730833804b6d92aa7f4dd474805c5_cgraph" id="proto_8h_a523730833804b6d92aa7f4dd474805c5_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#abf75a70e8719e8ed6de565a6ae90f1ab" title="distribute_file" alt="" coords="176,29,283,59"/><area shape="rect" id="node6" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="663,185,729,215"/><area shape="rect" id="node10" href="io_8c.html#a10281a87abe1e07d6ca603de6a533345" title="fill_Tab_IO_Labels" alt="" coords="164,451,295,480"/><area shape="rect" id="node12" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="196,504,263,533"/><area shape="rect" id="node14" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="195,397,264,427"/><area shape="rect" id="node18" href="io_8c.html#a2b3f5bacd7313da0f3ffa55e41907481" title="write_file" alt="" coords="191,344,268,373"/><area shape="rect" id="node8" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="821,185,979,215"/><area shape="rect" id="node16" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="673,663,719,692"/><area shape="rect" id="node20" href="io_8c.html#ad9c685a2d6d48224bfec61680ce82b1e" title="blockpresent" alt="" coords="405,504,509,533"/><area shape="rect" id="node23" href="io_8c.html#a4b34f2381777023014f80c959ad1f88a" title="fill_write_buffer" alt="" coords="400,557,515,587"/><area shape="rect" id="node32" href="io_8c.html#a49492470fcccf9d05bf51993f281f16c" title="get_bytes_per_blockelement" alt="" coords="355,611,560,640"/><area shape="rect" id="node34" href="io_8c.html#a4d30ce1aad9c69d5af676a6a13173686" title="get_dataset_name" alt="" coords="387,184,528,213"/><area shape="rect" id="node36" href="io_8c.html#acdf59daa02f065452a596cf88b4de1a1" title="get_datatype_in_block" alt="" coords="375,291,540,320"/><area shape="rect" id="node38" href="io_8c.html#a5ce310b1efc19d96d530c1264fd5eca9" title="get_particles_in_block" alt="" coords="376,237,539,267"/><area shape="rect" id="node41" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f" title="get_values_per_blockelement" alt="" coords="352,397,563,427"/><area shape="rect" id="node43" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="416,344,499,373"/><area shape="rect" id="node46" href="io_8c.html#ad5243b69dcba17be62f7d64f422bfbbf" title="write_header_attributes_in_hdf5" alt="" coords="344,451,571,480"/><area shape="rect" id="node25" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="667,556,725,585"/><area shape="rect" id="node27" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="623,609,769,639"/><area shape="rect" id="node29" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="619,503,773,532"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a523730833804b6d92aa7f4dd474805c5_icgraph.png" border="0" usemap="#proto_8h_a523730833804b6d92aa7f4dd474805c5_icgraph" alt=""/></div>
<map name="proto_8h_a523730833804b6d92aa7f4dd474805c5_icgraph" id="proto_8h_a523730833804b6d92aa7f4dd474805c5_icgraph">
<area shape="rect" id="node3" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="163,5,381,35"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="429,32,472,61"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="521,32,575,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad24c35a2016ce428248988795c1d3174"></a><!-- doxytag: member="proto.h::second" ref="ad24c35a2016ce428248988795c1d3174" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double second </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>returns the number of cpu-ticks in seconds that have elapsed, or the wall-clock time obtained with MPI_Wtime(). </p>

<p>Definition at line <a class="el" href="system_8c_source.html#l00049">49</a> of file <a class="el" href="system_8c_source.html">system.c</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>, <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="density_8c_source.html#l00056">density()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>, <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>, <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>, <a class="el" href="hydra_8c_source.html#l00050">hydro_force()</a>, <a class="el" href="main_8c_source.html#l00022">main()</a>, <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>, <a class="el" href="run_8c_source.html#l00020">run()</a>, and <a class="el" href="io_8c_source.html#l00033">savepositions()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
<span class="preprocessor">#ifdef WALLCLOCK</span>
<span class="preprocessor"></span>  <span class="keywordflow">return</span> MPI_Wtime();
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordflow">return</span> ((<span class="keywordtype">double</span>) clock()) / CLOCKS_PER_SEC;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  
  <span class="comment">/* note: on AIX and presumably many other 32bit systems, </span>
<span class="comment">   * clock() has only a resolution of 10ms=0.01sec </span>
<span class="comment">   */</span>
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad24c35a2016ce428248988795c1d3174_icgraph.png" border="0" usemap="#proto_8h_ad24c35a2016ce428248988795c1d3174_icgraph" alt=""/></div>
<map name="proto_8h_ad24c35a2016ce428248988795c1d3174_icgraph" id="proto_8h_ad24c35a2016ce428248988795c1d3174_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="349,431,557,460"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="611,278,653,307"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="817,278,871,307"/><area shape="rect" id="node9" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="368,510,539,539"/><area shape="rect" id="node12" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="139,67,280,96"/><area shape="rect" id="node14" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="344,174,563,203"/><area shape="rect" id="node18" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="176,643,243,672"/><area shape="rect" id="node28" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="123,278,296,307"/><area shape="rect" id="node34" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="145,536,273,566"/><area shape="rect" id="node37" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="160,590,259,619"/><area shape="rect" id="node40" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="161,432,257,462"/><area shape="rect" id="node44" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="151,120,268,150"/><area shape="rect" id="node48" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="155,224,264,254"/><area shape="rect" id="node21" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="364,603,543,632"/><area shape="rect" id="node23" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="612,379,652,408"/><area shape="rect" id="node25" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="701,354,768,383"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aeb05544fcefa17dff1e34bf3c65a0135"></a><!-- doxytag: member="proto.h::seed_glass" ref="aeb05544fcefa17dff1e34bf3c65a0135" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void seed_glass </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="init_8c_source.html#l00020">init()</a>.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aeb05544fcefa17dff1e34bf3c65a0135_icgraph.png" border="0" usemap="#proto_8h_aeb05544fcefa17dff1e34bf3c65a0135_icgraph" alt=""/></div>
<map name="proto_8h_aeb05544fcefa17dff1e34bf3c65a0135_icgraph" id="proto_8h_aeb05544fcefa17dff1e34bf3c65a0135_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="148,5,188,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="237,5,304,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="353,5,407,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9cb45ef22cae101906f021fb7a23afbe"></a><!-- doxytag: member="proto.h::set_random_numbers" ref="a9cb45ef22cae101906f021fb7a23afbe" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void set_random_numbers </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This routine fills the random number table. </p>

<p><p>&lt; gives the length of a table with random numbers, refreshed at every timestep. This is used to allow application of random numbers to a specific particle in a way that is independent of the number of processors used. </p>
</p>

<p>Definition at line <a class="el" href="system_8c_source.html#l00037">37</a> of file <a class="el" href="system_8c_source.html">system.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00043">random_generator</a>, and <a class="el" href="allvars_8c_source.html#l00045">RndTable</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>, and <a class="el" href="run_8c_source.html#l00370">every_timestep_stuff()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;

  <span class="keywordflow">for</span>(i = 0; i &lt; RNDTABLE; i++)
    <a class="code" href="allvars_8c.html#aa91f67a734086ebfa758994e579c80a9">RndTable</a>[i] = gsl_rng_uniform(<a class="code" href="allvars_8c.html#a4ec93729b85eb5da23dd6ffb23c3702b">random_generator</a>);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a9cb45ef22cae101906f021fb7a23afbe_icgraph.png" border="0" usemap="#proto_8h_a9cb45ef22cae101906f021fb7a23afbe_icgraph" alt=""/></div>
<map name="proto_8h_a9cb45ef22cae101906f021fb7a23afbe_icgraph" id="proto_8h_a9cb45ef22cae101906f021fb7a23afbe_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="421,5,488,35"/><area shape="rect" id="node7" href="run_8c.html#a7e26319b203616f2c85b5fd6f2ade85d" title="every_timestep_stuff" alt="" coords="217,59,372,88"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="537,32,591,61"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="433,59,476,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aab39b7857a85e95ef6f926ac82d4ff91"></a><!-- doxytag: member="proto.h::set_softenings" ref="aab39b7857a85e95ef6f926ac82d4ff91" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void set_softenings </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function sets the (comoving) softening length of all particle types in the table All.SofteningTable[...]. We check that the physical softening length is bounded by the Softening-MaxPhys values. </p>

<p>Definition at line <a class="el" href="gravtree_8c_source.html#l00487">487</a> of file <a class="el" href="gravtree_8c_source.html">gravtree.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="allvars_8h_source.html#l00478">global_data_all_processes::ForceSoftening</a>, <a class="el" href="allvars_8h_source.html#l00460">global_data_all_processes::MinGasHsml</a>, <a class="el" href="allvars_8h_source.html#l00459">global_data_all_processes::MinGasHsmlFractional</a>, <a class="el" href="allvars_8h_source.html#l00468">global_data_all_processes::SofteningBndry</a>, <a class="el" href="allvars_8h_source.html#l00475">global_data_all_processes::SofteningBndryMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00466">global_data_all_processes::SofteningBulge</a>, <a class="el" href="allvars_8h_source.html#l00473">global_data_all_processes::SofteningBulgeMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00465">global_data_all_processes::SofteningDisk</a>, <a class="el" href="allvars_8h_source.html#l00472">global_data_all_processes::SofteningDiskMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00463">global_data_all_processes::SofteningGas</a>, <a class="el" href="allvars_8h_source.html#l00470">global_data_all_processes::SofteningGasMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00464">global_data_all_processes::SofteningHalo</a>, <a class="el" href="allvars_8h_source.html#l00471">global_data_all_processes::SofteningHaloMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00467">global_data_all_processes::SofteningStars</a>, <a class="el" href="allvars_8h_source.html#l00474">global_data_all_processes::SofteningStarsMaxPhys</a>, <a class="el" href="allvars_8h_source.html#l00477">global_data_all_processes::SofteningTable</a>, and <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>.</p>

<p>Referenced by <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>, <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>, and <a class="el" href="init_8c_source.html#l00020">init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1f85943960c69ff351b48fc2f3933ec2">SofteningGas</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1e7634a0c6aa4affa124e095bf32285b">SofteningGasMaxPhys</a>)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[0] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1e7634a0c6aa4affa124e095bf32285b">SofteningGasMaxPhys</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[0] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1f85943960c69ff351b48fc2f3933ec2">SofteningGas</a>;
      
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a892cb7014ecd4b3910c493755b875b7e">SofteningHalo</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1d4f323715e8df4ea4be9296348cca25">SofteningHaloMaxPhys</a>)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[1] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1d4f323715e8df4ea4be9296348cca25">SofteningHaloMaxPhys</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[1] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a892cb7014ecd4b3910c493755b875b7e">SofteningHalo</a>;
      
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4a4453f9f76bb91ff3418d864caf3222">SofteningDisk</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a575a685feed5223ffc7c5b42b2b369b9">SofteningDiskMaxPhys</a>)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[2] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a575a685feed5223ffc7c5b42b2b369b9">SofteningDiskMaxPhys</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[2] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4a4453f9f76bb91ff3418d864caf3222">SofteningDisk</a>;
      
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1a0c9ca2f3dfdb2371785b66ced141d7">SofteningBulge</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a215c28ea2e54629e8537bd9868401fa7">SofteningBulgeMaxPhys</a>)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[3] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a215c28ea2e54629e8537bd9868401fa7">SofteningBulgeMaxPhys</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[3] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1a0c9ca2f3dfdb2371785b66ced141d7">SofteningBulge</a>;
      
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5502dc85fd165d33e9ba8d0f8c01867c">SofteningStars</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7ace4652c6c05275e4fa28dfe6fb374e">SofteningStarsMaxPhys</a>)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[4] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a7ace4652c6c05275e4fa28dfe6fb374e">SofteningStarsMaxPhys</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[4] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5502dc85fd165d33e9ba8d0f8c01867c">SofteningStars</a>;
      
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a8c31c4a347bca34b4e8d2292f710596d">SofteningBndry</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> &gt; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af989ac3052ad7e6bf7d7bfc824274715">SofteningBndryMaxPhys</a>)
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[5] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#af989ac3052ad7e6bf7d7bfc824274715">SofteningBndryMaxPhys</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;
      <span class="keywordflow">else</span>
        <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[5] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a8c31c4a347bca34b4e8d2292f710596d">SofteningBndry</a>;
    }
  <span class="keywordflow">else</span>
    {
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[0] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1f85943960c69ff351b48fc2f3933ec2">SofteningGas</a>;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[1] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a892cb7014ecd4b3910c493755b875b7e">SofteningHalo</a>;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[2] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4a4453f9f76bb91ff3418d864caf3222">SofteningDisk</a>;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[3] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1a0c9ca2f3dfdb2371785b66ced141d7">SofteningBulge</a>;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[4] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5502dc85fd165d33e9ba8d0f8c01867c">SofteningStars</a>;
      <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[5] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a8c31c4a347bca34b4e8d2292f710596d">SofteningBndry</a>;
    }

  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[i] = 2.8 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a5d557dca41d454bbc34153a0df2a4338">SofteningTable</a>[i];

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aec92c94dd2a1d0f0e1ad56f2e790384a">MinGasHsml</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#acddf5d973c6847405b85f4531d5b7510">MinGasHsmlFractional</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a2f875884085b35ff64047e46f5348be4">ForceSoftening</a>[0];
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aab39b7857a85e95ef6f926ac82d4ff91_icgraph.png" border="0" usemap="#proto_8h_aab39b7857a85e95ef6f926ac82d4ff91_icgraph" alt=""/></div>
<map name="proto_8h_aab39b7857a85e95ef6f926ac82d4ff91_icgraph" id="proto_8h_aab39b7857a85e95ef6f926ac82d4ff91_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="169,5,311,35"/><area shape="rect" id="node12" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="176,59,304,88"/><area shape="rect" id="node17" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="191,112,289,141"/><area shape="rect" id="node20" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="449,163,489,192"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="360,5,579,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="639,109,681,139"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="743,136,796,165"/><area shape="rect" id="node14" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="384,109,555,139"/><area shape="rect" id="node22" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="627,163,693,192"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aba986f6be1d66945199c7ea43e5c9610"></a><!-- doxytag: member="proto.h::set_units" ref="aba986f6be1d66945199c7ea43e5c9610" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void set_units </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Computes conversion factors between internal code units and the cgs-system. </p>

<p><p>&lt; Gravitational constant (in cgs units)</p>
<p>&lt; mass fraction of hydrogen, relevant only for radiative cooling</p>
<p>&lt; adiabatic index of simulated gas </p>
</p>

<p>Definition at line <a class="el" href="begrun_8c_source.html#l00154">154</a> of file <a class="el" href="begrun_8c_source.html">begrun.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="allvars_8h_source.html#l00082">BOLTZMANN</a>, <a class="el" href="allvars_8h_source.html#l00321">global_data_all_processes::G</a>, <a class="el" href="allvars_8h_source.html#l00077">GRAVITY</a>, <a class="el" href="allvars_8h_source.html#l00331">global_data_all_processes::GravityConstantInternal</a>, <a class="el" href="allvars_8h_source.html#l00091">HUBBLE</a>, <a class="el" href="allvars_8h_source.html#l00338">global_data_all_processes::Hubble</a>, <a class="el" href="allvars_8h_source.html#l00310">global_data_all_processes::MinEgySpec</a>, <a class="el" href="allvars_8h_source.html#l00309">global_data_all_processes::MinGasTemp</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8h_source.html#l00087">PROTONMASS</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00328">global_data_all_processes::UnitCoolingRate_in_cgs</a>, <a class="el" href="allvars_8h_source.html#l00327">global_data_all_processes::UnitDensity_in_cgs</a>, <a class="el" href="allvars_8h_source.html#l00329">global_data_all_processes::UnitEnergy_in_cgs</a>, <a class="el" href="allvars_8h_source.html#l00325">global_data_all_processes::UnitLength_in_cm</a>, <a class="el" href="allvars_8h_source.html#l00323">global_data_all_processes::UnitMass_in_g</a>, <a class="el" href="allvars_8h_source.html#l00326">global_data_all_processes::UnitPressure_in_cgs</a>, <a class="el" href="allvars_8h_source.html#l00330">global_data_all_processes::UnitTime_in_Megayears</a>, <a class="el" href="allvars_8h_source.html#l00322">global_data_all_processes::UnitTime_in_s</a>, and <a class="el" href="allvars_8h_source.html#l00324">global_data_all_processes::UnitVelocity_in_cm_per_s</a>.</p>

<p>Referenced by <a class="el" href="begrun_8c_source.html#l00028">begrun()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> meanweight;

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4fa94d45bad042101623c3403f6b8c37">UnitTime_in_s</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a111a45896aafd67faa8f0c9ef897612f">UnitLength_in_cm</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a04f4a1972c99f3ab4ba2483237a9d8ab">UnitVelocity_in_cm_per_s</a>;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a833ed48234b2780d7a668ae90c84318e">UnitTime_in_Megayears</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4fa94d45bad042101623c3403f6b8c37">UnitTime_in_s</a> / SEC_PER_MEGAYEAR;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3ebe48dc90c65aa0ed7ddfe8431987b1">GravityConstantInternal</a> == 0)
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a> = <a class="code" href="allvars_8h.html#a6801baa546c6112d19eb095111d24720">GRAVITY</a> / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a111a45896aafd67faa8f0c9ef897612f">UnitLength_in_cm</a>, 3) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adccf5aa82d4252d8d24ead7681b29052">UnitMass_in_g</a> * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4fa94d45bad042101623c3403f6b8c37">UnitTime_in_s</a>, 2);
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3ebe48dc90c65aa0ed7ddfe8431987b1">GravityConstantInternal</a>;

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aeccb92d371d0cfbd90cc34f85c8aa25f">UnitDensity_in_cgs</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adccf5aa82d4252d8d24ead7681b29052">UnitMass_in_g</a> / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a111a45896aafd67faa8f0c9ef897612f">UnitLength_in_cm</a>, 3);
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4938f30bc3da1d4583d42f806ad11201">UnitPressure_in_cgs</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adccf5aa82d4252d8d24ead7681b29052">UnitMass_in_g</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a111a45896aafd67faa8f0c9ef897612f">UnitLength_in_cm</a> / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4fa94d45bad042101623c3403f6b8c37">UnitTime_in_s</a>, 2);
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a79739025eb7e66065966227036437e06">UnitCoolingRate_in_cgs</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4938f30bc3da1d4583d42f806ad11201">UnitPressure_in_cgs</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4fa94d45bad042101623c3403f6b8c37">UnitTime_in_s</a>;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0d48e2253ad31d76eda8e677eba2cf1">UnitEnergy_in_cgs</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adccf5aa82d4252d8d24ead7681b29052">UnitMass_in_g</a> * <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a111a45896aafd67faa8f0c9ef897612f">UnitLength_in_cm</a>, 2) / <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4fa94d45bad042101623c3403f6b8c37">UnitTime_in_s</a>, 2);

  <span class="comment">/* convert some physical input parameters to internal units */</span>

  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a> = <a class="code" href="allvars_8h.html#a5de72d8762faf787d06d4dd47daeddeb">HUBBLE</a> * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4fa94d45bad042101623c3403f6b8c37">UnitTime_in_s</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == 0)
    {
      printf(<span class="stringliteral">&quot;\nHubble (internal units) = %g\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e6a37250907d90a56f92a55aefdda5f">Hubble</a>);
      printf(<span class="stringliteral">&quot;G (internal units) = %g\n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a1250b5c6e116b576ff09cbcd928d2063">G</a>);
      printf(<span class="stringliteral">&quot;UnitMass_in_g = %g \n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adccf5aa82d4252d8d24ead7681b29052">UnitMass_in_g</a>);
      printf(<span class="stringliteral">&quot;UnitTime_in_s = %g \n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4fa94d45bad042101623c3403f6b8c37">UnitTime_in_s</a>);
      printf(<span class="stringliteral">&quot;UnitVelocity_in_cm_per_s = %g \n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a04f4a1972c99f3ab4ba2483237a9d8ab">UnitVelocity_in_cm_per_s</a>);
      printf(<span class="stringliteral">&quot;UnitDensity_in_cgs = %g \n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#aeccb92d371d0cfbd90cc34f85c8aa25f">UnitDensity_in_cgs</a>);
      printf(<span class="stringliteral">&quot;UnitEnergy_in_cgs = %g \n&quot;</span>, <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0d48e2253ad31d76eda8e677eba2cf1">UnitEnergy_in_cgs</a>);
      printf(<span class="stringliteral">&quot;\n&quot;</span>);
    }

  meanweight = 4.0 / (1 + 3 * HYDROGEN_MASSFRAC);       <span class="comment">/* note: we assume neutral gas here */</span>

<span class="preprocessor">#ifdef ISOTHERM_EQS</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a> = 0;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a> = 1 / meanweight * (1.0 / GAMMA_MINUS1) * (<a class="code" href="allvars_8h.html#aa1487dae81baa2e0a5643e7b571633a0">BOLTZMANN</a> / <a class="code" href="allvars_8h.html#a7e6cfbe5535ec2470a672abeba3fcd4d">PROTONMASS</a>) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a728a84084280f547b1b68dbb143570ad">MinGasTemp</a>;
  <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae298f2b76a8f1d0b932bee24c28987cf">MinEgySpec</a> *= <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#adccf5aa82d4252d8d24ead7681b29052">UnitMass_in_g</a> / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ab0d48e2253ad31d76eda8e677eba2cf1">UnitEnergy_in_cgs</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aba986f6be1d66945199c7ea43e5c9610_cgraph.png" border="0" usemap="#proto_8h_aba986f6be1d66945199c7ea43e5c9610_cgraph" alt=""/></div>
<map name="proto_8h_aba986f6be1d66945199c7ea43e5c9610_cgraph" id="proto_8h_aba986f6be1d66945199c7ea43e5c9610_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="135,5,180,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_aba986f6be1d66945199c7ea43e5c9610_icgraph.png" border="0" usemap="#proto_8h_aba986f6be1d66945199c7ea43e5c9610_icgraph" alt=""/></div>
<map name="proto_8h_aba986f6be1d66945199c7ea43e5c9610_icgraph" id="proto_8h_aba986f6be1d66945199c7ea43e5c9610_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="133,5,200,35"/><area shape="rect" id="node5" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="249,5,303,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="abca44f066552d38c44a1cd6020d349d5"></a><!-- doxytag: member="proto.h::setup_smoothinglengths" ref="abca44f066552d38c44a1cd6020d349d5" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_smoothinglengths </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is used to find an initial smoothing length for each SPH particle. It guarantees that the number of neighbours will be between desired_ngb-MAXDEV and desired_ngb+MAXDEV. For simplicity, a first guess of the smoothing length is provided to the function <a class="el" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c">density()</a>, which will then iterate if needed to find the right smoothing length. </p>

<p>Definition at line <a class="el" href="init_8c_source.html#l00199">199</a> of file <a class="el" href="init_8c_source.html">init.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">NODE::d</a>, <a class="el" href="density_8c_source.html#l00056">density()</a>, <a class="el" href="allvars_8h_source.html#l00304">global_data_all_processes::DesNumNgb</a>, <a class="el" href="allvars_8c_source.html#l00149">Father</a>, <a class="el" href="allvars_8h_source.html#l00556">sph_particle_data::Hsml</a>, <a class="el" href="allvars_8h_source.html#l00585">NODE::len</a>, <a class="el" href="allvars_8h_source.html#l00514">particle_data::Mass</a>, <a class="el" href="allvars_8c_source.html#l00020">N_gas</a>, <a class="el" href="allvars_8c_source.html#l00142">Nodes</a>, <a class="el" href="allvars_8c_source.html#l00120">P</a>, <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>, <a class="el" href="allvars_8c_source.html#l00030">RestartFlag</a>, <a class="el" href="allvars_8c_source.html#l00128">SphP</a>, and <a class="el" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">NODE::u</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l00020">init()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> i, no, p;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a7f2decfd266dfa9b4560409b9e72b4ab">RestartFlag</a> == 0)
    {

      <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a8312e7470883d71db46cda5f1e616974">N_gas</a>; i++)
        {
          no = <a class="code" href="allvars_8c.html#ae1adfde6b271afd077130a64e6b85766">Father</a>[i];

          <span class="keywordflow">while</span>(10 * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> &gt; <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass)
            {
              p = <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.father;

              <span class="keywordflow">if</span>(p &lt; 0)
                <span class="keywordflow">break</span>;

              no = p;
            }
<span class="preprocessor">#ifndef TWODIMS</span>
<span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> =
            <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(3.0 / (4 * M_PI) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> / <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass, 1.0 / 3) * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a331d32b863e95f7d488a26ae38bda6af">SphP</a>[i].<a class="code" href="structsph__particle__data.html#af9efa599cdd656b26a0df5f89430b4d1">Hsml</a> =
            <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(1.0 / (M_PI) * <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#accb74aa1ccf3fb13e31f5704bb692313">DesNumNgb</a> * <a class="code" href="allvars_8c.html#a29aa1b496fa7d42c32c4cae3c77aa068">P</a>[i].<a class="code" href="structparticle__data.html#a710e551be01f4ef85442d0928aca728c">Mass</a> / <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#acd7e6747d70c2205a6fb3d44b6465dd4">u</a>.<a class="code" href="structNODE.html#a5ab829c8c9c85992ba220635f776de74">d</a>.mass, 1.0 / 2) * <a class="code" href="allvars_8c.html#ac46f89ba3715dfa877c2e1b8822da657">Nodes</a>[no].<a class="code" href="structNODE.html#aae35ad626e2613a4926d4e07fdf9be5c">len</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }
    }

  <a class="code" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c">density</a>();
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_abca44f066552d38c44a1cd6020d349d5_cgraph.png" border="0" usemap="#proto_8h_abca44f066552d38c44a1cd6020d349d5_cgraph" alt=""/></div>
<map name="proto_8h_abca44f066552d38c44a1cd6020d349d5_cgraph" id="proto_8h_abca44f066552d38c44a1cd6020d349d5_cgraph">
<area shape="rect" id="node3" href="density_8c.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="236,192,303,221"/><area shape="rect" id="node19" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="604,323,649,352"/><area shape="rect" id="node5" href="density_8c.html#ab6453dd0ac2ecf2478b1208374e68ae1" title="dens_compare_key" alt="" coords="352,5,499,35"/><area shape="rect" id="node7" href="density_8c.html#a4e6b32342a24a33518b6ae8723809749" title="density_evaluate" alt="" coords="360,59,491,88"/><area shape="rect" id="node13" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="396,112,455,141"/><area shape="rect" id="node15" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="392,165,459,195"/><area shape="rect" id="node21" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174" title="second" alt="" coords="392,269,459,299"/><area shape="rect" id="node23" href="proto_8h.html#a890645bdc4536bd797ca53028072e30d" title="timediff" alt="" coords="391,323,460,352"/><area shape="rect" id="node9" href="ngb_8c.html#ae39a878e9bb71ae346097aace71632f9" title="ngb_treefind_variable" alt="" coords="548,59,705,88"/><area shape="rect" id="node11" href="ngb_8c.html#a674ac0d18eaff78ba700f1278f078274" title="ngb_clear_buf" alt="" coords="756,59,865,88"/><area shape="rect" id="node17" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="548,165,705,195"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_abca44f066552d38c44a1cd6020d349d5_icgraph.png" border="0" usemap="#proto_8h_abca44f066552d38c44a1cd6020d349d5_icgraph" alt=""/></div>
<map name="proto_8h_abca44f066552d38c44a1cd6020d349d5_icgraph" id="proto_8h_abca44f066552d38c44a1cd6020d349d5_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="236,5,276,35"/><area shape="rect" id="node5" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="325,5,392,35"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="441,5,495,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad47ac005519641e0cfc423c3802d3ef2"></a><!-- doxytag: member="proto.h::statistics" ref="ad47ac005519641e0cfc423c3802d3ef2" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void statistics </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a869daac8b2af5667db265026f09fb9d8"></a><!-- doxytag: member="proto.h::terminate_processes" ref="a869daac8b2af5667db265026f09fb9d8" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void terminate_processes </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a869daac8b2af5667db265026f09fb9d8_icgraph.png" border="0" usemap="#proto_8h_a869daac8b2af5667db265026f09fb9d8_icgraph" alt=""/></div>
<map name="proto_8h_a869daac8b2af5667db265026f09fb9d8_icgraph" id="proto_8h_a869daac8b2af5667db265026f09fb9d8_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a9c69e0b6a074bb9341cf9854f17f245d" title="endrun" alt="" coords="211,975,277,1004"/><area shape="rect" id="node5" href="proto_8h.html#a9e761db39213af33ba28aeed461f1a5a" title="allocate_commbuffers" alt="" coords="1375,227,1537,256"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1729,424,1783,453"/><area shape="rect" id="node11" href="proto_8h.html#a7fe5e304baaf5f418a22fef9a9cc02c7" title="allocate_memory" alt="" coords="365,585,499,615"/><area shape="rect" id="node13" href="read__ic_8c.html#affd0f4e6b7bcdabf7d6f8191145f78d1" title="read_file" alt="" coords="691,431,765,460"/><area shape="rect" id="node17" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="1436,547,1476,576"/><area shape="rect" id="node20" href="restart_8c.html#ae81d30f52dddd39aef76bb1890d16f2f" title="restart" alt="" coords="696,713,760,743"/><area shape="rect" id="node26" href="sidm__routines_8c.html#a75d4b55f95852e708a563c3521438fe1" title="AllocateInteractionTable" alt="" coords="1369,379,1543,408"/><area shape="rect" id="node29" href="proto_8h.html#a1b96c5b41f1209ee91cd369f01a52352" title="check_omega" alt="" coords="1153,533,1263,563"/><area shape="rect" id="node32" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="923,1088,1064,1117"/><area shape="rect" id="node38" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="960,637,1027,667"/><area shape="rect" id="node46" href="proto_8h.html#a647e0c1a76b7f064ed5d201662f364bf" title="domain_decompose" alt="" coords="917,1300,1069,1329"/><area shape="rect" id="node53" href="proto_8h.html#ab7d41435f73c1626208d63b2d5ba28ca" title="domain_exchangeParticles" alt="" coords="632,1268,824,1297"/><area shape="rect" id="node56" href="proto_8h.html#a606de536756a67ad8f79f1135009195e" title="domain_topsplit" alt="" coords="371,1409,493,1439"/><area shape="rect" id="node62" href="proto_8h.html#aa5001f9be833c4673392b40e7be3a421" title="domain_topsplit_local" alt="" coords="352,1332,512,1361"/><area shape="rect" id="node66" href="read__ic_8c.html#ac028b474d53a40e79377b7ae5dde636a" title="find_files" alt="" coords="689,353,767,383"/><area shape="rect" id="node69" href="run_8c.html#a00802290d71ce2a6de3f121de55ddd20" title="find_next_outputtime" alt="" coords="1129,843,1287,872"/><area shape="rect" id="node73" href="proto_8h.html#a8eaedfa5c6d72bca79b465003679ed89" title="force_create_empty_nodes" alt="" coords="335,1743,529,1772"/><area shape="rect" id="node76" href="proto_8h.html#aadc9b1624ed78f3ccd0dbb9908fe0bb6" title="force_treebuild_single" alt="" coords="648,1743,808,1772"/><area shape="rect" id="node78" href="proto_8h.html#ad9e0a57b7577d64a315c142e197d292d" title="force_insert_pseudo_particles" alt="" coords="327,1796,537,1825"/><area shape="rect" id="node81" href="proto_8h.html#ab98788ba31869c7bc55ce71b807d2ff2" title="force_treeallocate" alt="" coords="364,793,500,823"/><area shape="rect" id="node86" href="proto_8h.html#a5989a3f57c7d6dfdef205dc6b72a1d25" title="long_range_force" alt="" coords="928,947,1059,976"/><area shape="rect" id="node94" href="proto_8h.html#a59ae74ef51d6a7065605638422489391" title="force_treeevaluate" alt="" coords="657,1861,799,1891"/><area shape="rect" id="node96" href="proto_8h.html#a804166b1847da509d8fe57072b40d5f9" title="force_treeevaluate_potential" alt="" coords="625,1205,831,1235"/><area shape="rect" id="node99" href="proto_8h.html#abd9d86a6c08e77a4fa78fa76b96cdde7" title="force_treeevaluate_potential_shortrange" alt="" coords="587,1101,869,1131"/><area shape="rect" id="node102" href="proto_8h.html#ae01e179b7686a7fe62970160b7bbdb46" title="force_treeevaluate_shortrange" alt="" coords="619,1927,837,1956"/><area shape="rect" id="node104" href="proto_8h.html#a5ce310b1efc19d96d530c1264fd5eca9" title="get_particles_in_block" alt="" coords="351,1204,513,1233"/><area shape="rect" id="node107" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="689,1513,767,1543"/><area shape="rect" id="node109" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="1153,1349,1263,1379"/><area shape="rect" id="node113" href="timestep_8c.html#af48922752ff457721f558510789e61e1" title="get_timestep" alt="" coords="379,2004,485,2033"/><area shape="rect" id="node115" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="929,893,1057,923"/><area shape="rect" id="node121" href="proto_8h.html#a1609620c03f6b0068601735c42e3c660" title="my_fread" alt="" coords="391,380,473,409"/><area shape="rect" id="node124" href="proto_8h.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="391,1564,473,1593"/><area shape="rect" id="node127" href="proto_8h.html#a6f7a3b85f10701b9067f012cc9a30f55" title="ngb_treeallocate" alt="" coords="368,689,496,719"/><area shape="rect" id="node131" href="proto_8h.html#a6f629274f7b036874c743fb81d58ce68" title="open_outputfiles" alt="" coords="1392,468,1520,497"/><area shape="rect" id="node134" href="proto_8h.html#acb5c64377fad9e1a34bad88fb7c61a3e" title="pm_init_periodic_allocate" alt="" coords="341,948,523,977"/><area shape="rect" id="node139" href="proto_8h.html#a952eae1977b498c4fdfabed1742a3ba2" title="read_parameter_file" alt="" coords="1381,73,1531,103"/><area shape="rect" id="node142" href="proto_8h.html#acc4d1f5e4e51140090a7ce25ea263b98" title="readjust_timebase" alt="" coords="923,124,1064,153"/><area shape="rect" id="node147" href="sidm__routines_8c.html#a07ab80a1f9370ead2bc2a38884436615" title="update_interaction_table" alt="" coords="341,1900,523,1929"/><area shape="rect" id="node7" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="1613,424,1680,453"/><area shape="rect" id="node15" href="read__ic_8c.html#a150344fdc0c6e132aecdb6c646529df1" title="read_ic" alt="" coords="960,431,1027,460"/><area shape="rect" id="node23" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="1625,1024,1668,1053"/><area shape="rect" id="node34" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="1347,1076,1565,1105"/><area shape="rect" id="node40" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="1123,921,1293,951"/><area shape="rect" id="node43" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="1119,637,1297,667"/><area shape="rect" id="node48" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="1121,1128,1295,1157"/><area shape="rect" id="node58" href="proto_8h.html#a25b4f5eb395f918bad4b4bc1fc3dc729" title="domain_determineTopTree" alt="" coords="632,1332,824,1361"/><area shape="rect" id="node84" href="proto_8h.html#af8dfaf42f3b513118ad6aa3ab5cd3c1b" title="pmforce_periodic" alt="" coords="663,944,793,973"/><area shape="rect" id="node89" href="proto_8h.html#a7938f2181f23d56ac46f3625d1a855a0" title="pmpotential_periodic" alt="" coords="651,997,805,1027"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a890645bdc4536bd797ca53028072e30d"></a><!-- doxytag: member="proto.h::timediff" ref="a890645bdc4536bd797ca53028072e30d" args="(double t0, double t1)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double timediff </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>t0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>t1</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>returns the time difference between two measurements obtained with <a class="el" href="proto_8h.html#ad24c35a2016ce428248988795c1d3174">second()</a>. The routine takes care of the possible overflow of the tick counter on 32bit systems, but depending on the system, this may not always work properly. Similarly, in some MPI implementations, the MPI_Wtime() function may also overflow, in which case a negative time difference would be returned. The routine returns instead a time difference equal to 0. </p>

<p>Definition at line <a class="el" href="system_8c_source.html#l00070">70</a> of file <a class="el" href="system_8c_source.html">system.c</a>.</p>

<p>References <a class="el" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow()</a>.</p>

<p>Referenced by <a class="el" href="timestep_8c_source.html#l00024">advance_and_find_timesteps()</a>, <a class="el" href="accel_8c_source.html#l00024">compute_accelerations()</a>, <a class="el" href="potential_8c_source.html#l00022">compute_potential()</a>, <a class="el" href="density_8c_source.html#l00056">density()</a>, <a class="el" href="domain_8c_source.html#l00062">domain_Decomposition()</a>, <a class="el" href="run_8c_source.html#l00151">find_next_sync_point_and_drift()</a>, <a class="el" href="gravtree__forcetest_8c_source.html#l00028">gravity_forcetest()</a>, <a class="el" href="gravtree_8c_source.html#l00027">gravity_tree()</a>, <a class="el" href="hydra_8c_source.html#l00050">hydro_force()</a>, <a class="el" href="main_8c_source.html#l00022">main()</a>, <a class="el" href="predict_8c_source.html#l00031">move_particles()</a>, <a class="el" href="run_8c_source.html#l00020">run()</a>, and <a class="el" href="io_8c_source.html#l00033">savepositions()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">double</span> dt;

  dt = t1 - t0;

  <span class="keywordflow">if</span>(dt &lt; 0)    <span class="comment">/* overflow has occured (for systems with 32bit tick counter) */</span>
    {
<span class="preprocessor">#ifdef WALLCLOCK</span>
<span class="preprocessor"></span>      dt = 0;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      dt = t1 + <a class="code" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e">pow</a>(2, 32) / CLOCKS_PER_SEC - t0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

  <span class="keywordflow">return</span> dt;
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a890645bdc4536bd797ca53028072e30d_cgraph.png" border="0" usemap="#proto_8h_a890645bdc4536bd797ca53028072e30d_cgraph" alt=""/></div>
<map name="proto_8h_a890645bdc4536bd797ca53028072e30d_cgraph" id="proto_8h_a890645bdc4536bd797ca53028072e30d_cgraph">
<area shape="rect" id="node3" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="127,5,172,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a890645bdc4536bd797ca53028072e30d_icgraph.png" border="0" usemap="#proto_8h_a890645bdc4536bd797ca53028072e30d_icgraph" alt=""/></div>
<map name="proto_8h_a890645bdc4536bd797ca53028072e30d_icgraph" id="proto_8h_a890645bdc4536bd797ca53028072e30d_icgraph">
<area shape="rect" id="node3" href="timestep_8c.html#a05e5a546d63684b55d2457aa56efdd06" title="advance_and_find_timesteps" alt="" coords="352,431,560,460"/><area shape="rect" id="node5" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="613,277,656,307"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="820,277,873,307"/><area shape="rect" id="node9" href="proto_8h.html#a147f9422f4bca4666608da992486b417" title="compute_accelerations" alt="" coords="371,509,541,539"/><area shape="rect" id="node12" href="proto_8h.html#a04474459731219f9601aaefedb37ab27" title="compute_potential" alt="" coords="141,67,283,96"/><area shape="rect" id="node14" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="347,173,565,203"/><area shape="rect" id="node18" href="proto_8h.html#ad86cdeb9e3bfbe9af379ac9f7daf194c" title="density" alt="" coords="179,643,245,672"/><area shape="rect" id="node28" href="proto_8h.html#ae8e3aa408eaab9544cb7f93e69185492" title="domain_Decomposition" alt="" coords="125,277,299,307"/><area shape="rect" id="node34" href="proto_8h.html#a51b074bdf1ec1efc0f7a323415a47e79" title="gravity_forcetest" alt="" coords="148,536,276,565"/><area shape="rect" id="node37" href="proto_8h.html#ac559dc2aeb21d5a379a3751bea7736af" title="gravity_tree" alt="" coords="163,589,261,619"/><area shape="rect" id="node40" href="proto_8h.html#a6789381bce7d1c316df8ecf04b47a607" title="hydro_force" alt="" coords="164,432,260,461"/><area shape="rect" id="node44" href="proto_8h.html#a02a8a27a7a75ce5cd6c2a27b4d641e31" title="move_particles" alt="" coords="153,120,271,149"/><area shape="rect" id="node48" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="157,224,267,253"/><area shape="rect" id="node21" href="proto_8h.html#abca44f066552d38c44a1cd6020d349d5" title="setup_smoothinglengths" alt="" coords="367,603,545,632"/><area shape="rect" id="node23" href="proto_8h.html#a2858154e2009b0e6e616f313177762bc" title="init" alt="" coords="615,379,655,408"/><area shape="rect" id="node25" href="proto_8h.html#aceeb5c8909331b90ea8345e0fc853f82" title="begrun" alt="" coords="704,353,771,383"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a48b0ed3a843924501df8ed871e08e77c"></a><!-- doxytag: member="proto.h::write_file" ref="a48b0ed3a843924501df8ed871e08e77c" args="(char *fname, int readTask, int lastTask)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void write_file </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>writeTask</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>lastTask</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function writes an actual snapshot file containing the data from processors 'writeTask' to 'lastTask'. 'writeTask' is the one that actually writes. Each snapshot file contains a header first, then particle positions, velocities and ID's. Particle masses are written only for those particle types with zero entry in MassTable. After that, first the internal energies u, and then the density is written for the SPH particles. If cooling is enabled, mean molecular weight and neutral hydrogen abundance are written for the gas particles. This is followed by the SPH smoothing length and further blocks of information, depending on included physics and compile-time flags. If HDF5 is used, the header is stored in a group called "/Header", and the particle data is stored separately for each particle type in groups calles "/PartType0", "/PartType1", etc. The sequence of the blocks is unimportant in this case. </p>

<p><p>&lt; Various tags used for labelling MPI messages</p>
<p>&lt; Various tags used for labelling MPI messages</p>
<p>&lt; total number of defined 0 0 for snapshot files. Must be equal to the number of entries in "enum iofields" </p>
</p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00672">672</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8c_source.html#l00112">All</a>, <a class="el" href="io_8c_source.html#l00532">blockpresent()</a>, <a class="el" href="allvars_8h_source.html#l00278">global_data_all_processes::BoxSize</a>, <a class="el" href="allvars_8h_source.html#l00643">io_header::BoxSize</a>, <a class="el" href="allvars_8h_source.html#l00288">global_data_all_processes::BufferSize</a>, <a class="el" href="allvars_8c_source.html#l00102">CommBuffer</a>, <a class="el" href="allvars_8h_source.html#l00347">global_data_all_processes::ComovingIntegrationOn</a>, <a class="el" href="endrun_8c_source.html#l00025">endrun()</a>, <a class="el" href="restart_8c_source.html#l00021">fd</a>, <a class="el" href="io_8c_source.html#l00129">fill_write_buffer()</a>, <a class="el" href="allvars_8h_source.html#l00641">io_header::flag_cooling</a>, <a class="el" href="allvars_8h_source.html#l00638">io_header::flag_feedback</a>, <a class="el" href="allvars_8h_source.html#l00648">io_header::flag_metals</a>, <a class="el" href="allvars_8h_source.html#l00637">io_header::flag_sfr</a>, <a class="el" href="allvars_8h_source.html#l00647">io_header::flag_stellarage</a>, <a class="el" href="io_8c_source.html#l00366">get_bytes_per_blockelement()</a>, <a class="el" href="io_8c_source.html#l00613">get_dataset_name()</a>, <a class="el" href="io_8c_source.html#l00405">get_datatype_in_block()</a>, <a class="el" href="io_8c_source.html#l00465">get_particles_in_block()</a>, <a class="el" href="io_8c_source.html#l00432">get_values_per_blockelement()</a>, <a class="el" href="allvars_8c_source.html#l00162">header</a>, <a class="el" href="allvars_8h_source.html#l00342">global_data_all_processes::HubbleParam</a>, <a class="el" href="allvars_8h_source.html#l00646">io_header::HubbleParam</a>, <a class="el" href="allvars_8h_source.html#l00633">io_header::mass</a>, <a class="el" href="allvars_8h_source.html#l00481">global_data_all_processes::MassTable</a>, <a class="el" href="io_8c_source.html#l01122">my_fwrite()</a>, <a class="el" href="io_8c_source.html#l00021">n_type</a>, <a class="el" href="allvars_8h_source.html#l00632">io_header::npart</a>, <a class="el" href="allvars_8h_source.html#l00639">io_header::npartTotal</a>, <a class="el" href="allvars_8h_source.html#l00649">io_header::npartTotalHighWord</a>, <a class="el" href="io_8c_source.html#l00022">ntot_type_all</a>, <a class="el" href="allvars_8h_source.html#l00642">io_header::num_files</a>, <a class="el" href="allvars_8h_source.html#l00284">global_data_all_processes::NumFilesPerSnapshot</a>, <a class="el" href="allvars_8h_source.html#l00339">global_data_all_processes::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00644">io_header::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00340">global_data_all_processes::OmegaLambda</a>, <a class="el" href="allvars_8h_source.html#l00645">io_header::OmegaLambda</a>, <a class="el" href="allvars_8h_source.html#l00636">io_header::redshift</a>, <a class="el" href="allvars_8h_source.html#l00282">global_data_all_processes::SnapFormat</a>, <a class="el" href="allvars_8c_source.html#l00167">Tab_IO_Labels</a>, <a class="el" href="tags_8h_source.html#l00032">TAG_LOCALN</a>, <a class="el" href="tags_8h_source.html#l00005">TAG_N</a>, <a class="el" href="tags_8h_source.html#l00019">TAG_NFORTHISTASK</a>, <a class="el" href="tags_8h_source.html#l00007">TAG_PDATA</a>, <a class="el" href="allvars_8c_source.html#l00015">ThisTask</a>, <a class="el" href="allvars_8h_source.html#l00369">global_data_all_processes::Time</a>, <a class="el" href="allvars_8h_source.html#l00635">io_header::time</a>, and <a class="el" href="io_8c_source.html#l00998">write_header_attributes_in_hdf5()</a>.</p>

<p>Referenced by <a class="el" href="io_8c_source.html#l00033">savepositions()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> type, bytes_per_blockelement, npart, nextblock, typelist[6];
  <span class="keywordtype">int</span> n_for_this_task, ntask, n, p, pc, offset = 0, task;
  <span class="keywordtype">int</span> blockmaxlen, ntot_type[6], nn[6];
  <span class="keyword">enum</span> <a class="code" href="allvars_8h.html#a3f7452ec51c4f746e7070abd666147d8">iofields</a> blocknr;
  <span class="keywordtype">int</span> blksize;
  MPI_Status status;
  FILE *<a class="code" href="restart_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a> = 0;

<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>  hid_t hdf5_file = 0, hdf5_grp[6], hdf5_headergrp = 0, hdf5_dataspace_memory;
  hid_t hdf5_datatype = 0, hdf5_dataspace_in_file = 0, hdf5_dataset = 0;
  herr_t hdf5_status;
  hsize_t dims[2], count[2], start[2];
  <span class="keywordtype">int</span> rank, pcsum = 0;
  <span class="keywordtype">char</span> buf[500];
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define SKIP  {my_fwrite(&amp;blksize,sizeof(int),1,fd);}</span>
<span class="preprocessor"></span>
  <span class="comment">/* determine particle numbers of each type in file */</span>

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask)
    {
      <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
        ntot_type[n] = <a class="code" href="io_8c.html#a217c441656b4bdc1caf0019b5a809bee">n_type</a>[n];

      <span class="keywordflow">for</span>(task = writeTask + 1; task &lt;= lastTask; task++)
        {
          MPI_Recv(&amp;nn[0], 6, MPI_INT, task, <a class="code" href="tags_8h.html#a6c22de1ede8c37798a40f89dbaa7cf25">TAG_LOCALN</a>, MPI_COMM_WORLD, &amp;status);
          <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
            ntot_type[n] += nn[n];
        }

      <span class="keywordflow">for</span>(task = writeTask + 1; task &lt;= lastTask; task++)
        MPI_Send(&amp;ntot_type[0], 6, MPI_INT, task, <a class="code" href="tags_8h.html#a8b9f258d53a5b3f5291fd7b034d74a02">TAG_N</a>, MPI_COMM_WORLD);
    }
  <span class="keywordflow">else</span>
    {
      MPI_Send(&amp;<a class="code" href="io_8c.html#a217c441656b4bdc1caf0019b5a809bee">n_type</a>[0], 6, MPI_INT, writeTask, <a class="code" href="tags_8h.html#a6c22de1ede8c37798a40f89dbaa7cf25">TAG_LOCALN</a>, MPI_COMM_WORLD);
      MPI_Recv(&amp;ntot_type[0], 6, MPI_INT, writeTask, <a class="code" href="tags_8h.html#a8b9f258d53a5b3f5291fd7b034d74a02">TAG_N</a>, MPI_COMM_WORLD, &amp;status);
    }



  <span class="comment">/* fill file header */</span>

  <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
    {
      <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[n] = ntot_type[n];
      <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>[n] = (<span class="keywordtype">unsigned</span> int) <a class="code" href="io_8c.html#a3cfb701790acb5a9b71ba995148bbf40">ntot_type_all</a>[n];
      <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a56f54a68fe289b19902b3c4c561a7159">npartTotalHighWord</a>[n] = (<span class="keywordtype">unsigned</span> int) (<a class="code" href="io_8c.html#a3cfb701790acb5a9b71ba995148bbf40">ntot_type_all</a>[n] &gt;&gt; 32);
    }

  <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
    <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a2c387b0c7c823287d424fedc70175917">mass</a>[n] = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a0d1dbe97a03958559781d9619f8b17c1">MassTable</a>[n];

  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad6237959a3590772366f18000a47a7d6">time</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a>;

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a4104c753df69fb4da0dd9bbb57e2a5f4">ComovingIntegrationOn</a>)
    <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ae2484703f374288fb266ff268a1ffa91">redshift</a> = 1.0 / <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a25b9da73fdcbdc45fbe4a6ad45479f09">Time</a> - 1;
  <span class="keywordflow">else</span>
    <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ae2484703f374288fb266ff268a1ffa91">redshift</a> = 0;

  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#afe21a629578012fd99d118d2ad834763">flag_sfr</a> = 0;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a98679063cc311c5f6184459600fa05a5">flag_feedback</a> = 0;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ae877c2fcde2f096886193c22b9b73cbf">flag_cooling</a> = 0;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#abe83e840bb4778a3be11a084dfa85c3c">flag_stellarage</a> = 0;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ac025f6c1cff1914d893ce0c7c5fd46bb">flag_metals</a> = 0;

<span class="preprocessor">#ifdef COOLING</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ae877c2fcde2f096886193c22b9b73cbf">flag_cooling</a> = 1;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef SFR</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#afe21a629578012fd99d118d2ad834763">flag_sfr</a> = 1;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a98679063cc311c5f6184459600fa05a5">flag_feedback</a> = 1;
<span class="preprocessor">#ifdef STELLARAGE</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#abe83e840bb4778a3be11a084dfa85c3c">flag_stellarage</a> = 1;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef METALS</span>
<span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ac025f6c1cff1914d893ce0c7c5fd46bb">flag_metals</a> = 1;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a3749135400fbf51c319054233d7a64a7">NumFilesPerSnapshot</a>;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#aacb7ba10d16ae90490a9deba37ace731">BoxSize</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ac1b2e52cf547f5b2fe4bdfb0eaafa22f">BoxSize</a>;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#af0d78ac0e8131523be64b3686aab9550">Omega0</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abac5eca1b5851e670eec01d4dd47c417">Omega0</a>;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#aa2cdc9653addc264b58134006bca1bb8">OmegaLambda</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#ae272abeafbcb16230374a903a3e4e298">OmegaLambda</a>;
  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad0f0d02804350f8935aadca9b5ef0fcf">HubbleParam</a> = <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a51f2bde6feb49841d60397964a9740ac">HubbleParam</a>;


  <span class="comment">/* open file and write header */</span>

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 3)
        {
<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>          sprintf(buf, <span class="stringliteral">&quot;%s.hdf5&quot;</span>, fname);
          hdf5_file = H5Fcreate(buf, H5F_ACC_TRUNC, H5P_DEFAULT, H5P_DEFAULT);

          hdf5_headergrp = H5Gcreate(hdf5_file, <span class="stringliteral">&quot;/Header&quot;</span>, 0);

          <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type] &gt; 0)
                {
                  sprintf(buf, <span class="stringliteral">&quot;/PartType%d&quot;</span>, type);
                  hdf5_grp[type] = H5Gcreate(hdf5_file, buf, 0);
                }
            }

          <a class="code" href="io_8c.html#ad5243b69dcba17be62f7d64f422bfbbf">write_header_attributes_in_hdf5</a>(hdf5_headergrp);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }
      <span class="keywordflow">else</span>
        {
          <span class="keywordflow">if</span>(!(fd = fopen(fname, <span class="stringliteral">&quot;w&quot;</span>)))
            {
              printf(<span class="stringliteral">&quot;can&#39;t open file `%s&#39; for writing snapshot.\n&quot;</span>, fname);
              <a class="code" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839">endrun</a>(123);
            }

          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 2)
            {
              blksize = <span class="keyword">sizeof</span>(int) + 4 * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>);
              SKIP;
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(<span class="stringliteral">&quot;HEAD&quot;</span>, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 4, fd);
              nextblock = <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>) + 2 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>);
              <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;nextblock, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, fd);
              SKIP;
            }

          blksize = <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>);
          SKIP;
          <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>), 1, fd);
          SKIP;
        }
    }

  ntask = lastTask - writeTask + 1;

  <span class="keywordflow">for</span>(blocknr = 0; blocknr &lt; IO_NBLOCKS; blocknr++)
    {
      <span class="keywordflow">if</span>(<a class="code" href="io_8c.html#ad9c685a2d6d48224bfec61680ce82b1e">blockpresent</a>(blocknr))
        {
          bytes_per_blockelement = <a class="code" href="io_8c.html#a49492470fcccf9d05bf51993f281f16c">get_bytes_per_blockelement</a>(blocknr);

          blockmaxlen = ((int) (<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#abd0120516eb7fee5a534464546fc5c7f">BufferSize</a> * 1024 * 1024)) / bytes_per_blockelement;

          npart = <a class="code" href="io_8c.html#a5ce310b1efc19d96d530c1264fd5eca9">get_particles_in_block</a>(blocknr, &amp;typelist[0]);

          <span class="keywordflow">if</span>(npart &gt; 0)
            {
              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask)
                {

                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 2)
                    {
                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 2)
                        {
                          blksize = <span class="keyword">sizeof</span>(int) + 4 * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>);
                          SKIP;
                          <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(<a class="code" href="allvars_8c.html#ab0664df93d97f96270978b84eb6fb80c">Tab_IO_Labels</a>[blocknr], <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 4, fd);
                          nextblock = npart * bytes_per_blockelement + 2 * <span class="keyword">sizeof</span>(int);
                          <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(&amp;nextblock, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, fd);
                          SKIP;
                        }

                      blksize = npart * bytes_per_blockelement;
                      SKIP;

                    }
                }

              <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
                {
                  <span class="keywordflow">if</span>(typelist[type])
                    {
<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask &amp;&amp; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 3 &amp;&amp; <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type] &gt; 0)
                        {
                          <span class="keywordflow">switch</span> (<a class="code" href="io_8c.html#acdf59daa02f065452a596cf88b4de1a1">get_datatype_in_block</a>(blocknr))
                            {
                            <span class="keywordflow">case</span> 0:
                              hdf5_datatype = H5Tcopy(H5T_NATIVE_UINT);
                              <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> 1:
                              hdf5_datatype = H5Tcopy(H5T_NATIVE_FLOAT);
                              <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> 2:
                              hdf5_datatype = H5Tcopy(H5T_NATIVE_UINT64);
                              <span class="keywordflow">break</span>;
                            }

                          dims[0] = <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type];
                          dims[1] = <a class="code" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f">get_values_per_blockelement</a>(blocknr);
                          <span class="keywordflow">if</span>(dims[1] == 1)
                            rank = 1;
                          <span class="keywordflow">else</span>
                            rank = 2;

                          <a class="code" href="io_8c.html#a4d30ce1aad9c69d5af676a6a13173686">get_dataset_name</a>(blocknr, buf);

                          hdf5_dataspace_in_file = H5Screate_simple(rank, dims, NULL);
                          hdf5_dataset =
                            H5Dcreate(hdf5_grp[type], buf, hdf5_datatype, hdf5_dataspace_in_file,
                                      H5P_DEFAULT);
                          pcsum = 0;
                        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
                      <span class="keywordflow">for</span>(task = writeTask, offset = 0; task &lt;= lastTask; task++)
                        {
                          <span class="keywordflow">if</span>(task == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                            {
                              n_for_this_task = <a class="code" href="io_8c.html#a217c441656b4bdc1caf0019b5a809bee">n_type</a>[type];

                              <span class="keywordflow">for</span>(p = writeTask; p &lt;= lastTask; p++)
                                <span class="keywordflow">if</span>(p != <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                                  MPI_Send(&amp;n_for_this_task, 1, MPI_INT, p, <a class="code" href="tags_8h.html#a1acb707e12b7d1963c1d9101e93f6f4e">TAG_NFORTHISTASK</a>, MPI_COMM_WORLD);
                            }
                          <span class="keywordflow">else</span>
                            MPI_Recv(&amp;n_for_this_task, 1, MPI_INT, task, <a class="code" href="tags_8h.html#a1acb707e12b7d1963c1d9101e93f6f4e">TAG_NFORTHISTASK</a>, MPI_COMM_WORLD,
                                     &amp;status);

                          <span class="keywordflow">while</span>(n_for_this_task &gt; 0)
                            {
                              pc = n_for_this_task;

                              <span class="keywordflow">if</span>(pc &gt; blockmaxlen)
                                pc = blockmaxlen;

                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == task)
                                <a class="code" href="io_8c.html#a4b34f2381777023014f80c959ad1f88a">fill_write_buffer</a>(blocknr, &amp;offset, pc, type);

                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask &amp;&amp; task != writeTask)
                                MPI_Recv(<a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>, bytes_per_blockelement * pc, MPI_BYTE, task,
                                         <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>, MPI_COMM_WORLD, &amp;status);

                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> != writeTask &amp;&amp; task == <a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a>)
                                MPI_Ssend(<a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>, bytes_per_blockelement * pc, MPI_BYTE, writeTask,
                                          <a class="code" href="tags_8h.html#a41c046c7898c1956074313fd83f50b39">TAG_PDATA</a>, MPI_COMM_WORLD);

                              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask)
                                {
                                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 3)
                                    {
<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>                                      start[0] = pcsum;
                                      start[1] = 0;

                                      count[0] = pc;
                                      count[1] = <a class="code" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f">get_values_per_blockelement</a>(blocknr);
                                      pcsum += pc;

                                      H5Sselect_hyperslab(hdf5_dataspace_in_file, H5S_SELECT_SET,
                                                          start, NULL, count, NULL);

                                      dims[0] = pc;
                                      dims[1] = <a class="code" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f">get_values_per_blockelement</a>(blocknr);
                                      hdf5_dataspace_memory = H5Screate_simple(rank, dims, NULL);

                                      hdf5_status =
                                        H5Dwrite(hdf5_dataset, hdf5_datatype, hdf5_dataspace_memory,
                                                 hdf5_dataspace_in_file, H5P_DEFAULT, <a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>);

                                      H5Sclose(hdf5_dataspace_memory);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                                    }
                                  <span class="keywordflow">else</span>
                                    <a class="code" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21">my_fwrite</a>(<a class="code" href="allvars_8c.html#ab9d6a5a8cf4049ad304ea6d23d8efb09">CommBuffer</a>, bytes_per_blockelement, pc, fd);
                                }

                              n_for_this_task -= pc;
                            }
                        }

<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask &amp;&amp; <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 3 &amp;&amp; <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type] &gt; 0)
                        {
                          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 3)
                            {
                              H5Dclose(hdf5_dataset);
                              H5Sclose(hdf5_dataspace_in_file);
                              H5Tclose(hdf5_datatype);
                            }
                        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                    }
                }

              <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask)
                {
                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 1 || <a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 2)
                    SKIP;
                }
            }
        }
    }

  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a52c8c7d2abff436111942e02c5bb466a">ThisTask</a> == writeTask)
    {
      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#ad49123ae0461ffe61629a0d4cf2ba91f">All</a>.<a class="code" href="structglobal__data__all__processes.html#a6e7d07e68bd6242059d1adac6dabf0d1">SnapFormat</a> == 3)
        {
<span class="preprocessor">#ifdef HAVE_HDF5</span>
<span class="preprocessor"></span>          <span class="keywordflow">for</span>(type = 5; type &gt;= 0; type--)
            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>[type] &gt; 0)
              H5Gclose(hdf5_grp[type]);
          H5Gclose(hdf5_headergrp);
          H5Fclose(hdf5_file);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }
      <span class="keywordflow">else</span>
        fclose(fd);
    }
}
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a48b0ed3a843924501df8ed871e08e77c_cgraph.png" border="0" usemap="#proto_8h_a48b0ed3a843924501df8ed871e08e77c_cgraph" alt=""/></div>
<map name="proto_8h_a48b0ed3a843924501df8ed871e08e77c_cgraph" id="proto_8h_a48b0ed3a843924501df8ed871e08e77c_cgraph">
<area shape="rect" id="node3" href="io_8c.html#ad9c685a2d6d48224bfec61680ce82b1e" title="blockpresent" alt="" coords="192,32,296,61"/><area shape="rect" id="node5" href="endrun_8c.html#a6c7c5d488c8a9e1fb9c408ae00aa8839" title="endrun" alt="" coords="449,349,516,379"/><area shape="rect" id="node9" href="io_8c.html#a4b34f2381777023014f80c959ad1f88a" title="fill_write_buffer" alt="" coords="187,85,301,115"/><area shape="rect" id="node19" href="io_8c.html#a49492470fcccf9d05bf51993f281f16c" title="get_bytes_per_blockelement" alt="" coords="141,189,347,219"/><area shape="rect" id="node21" href="io_8c.html#a4d30ce1aad9c69d5af676a6a13173686" title="get_dataset_name" alt="" coords="173,243,315,272"/><area shape="rect" id="node23" href="io_8c.html#acdf59daa02f065452a596cf88b4de1a1" title="get_datatype_in_block" alt="" coords="161,296,327,325"/><area shape="rect" id="node25" href="io_8c.html#a5ce310b1efc19d96d530c1264fd5eca9" title="get_particles_in_block" alt="" coords="163,349,325,379"/><area shape="rect" id="node28" href="io_8c.html#a3892776d6528c51f720d2a48deb2486f" title="get_values_per_blockelement" alt="" coords="139,403,349,432"/><area shape="rect" id="node30" href="io_8c.html#aab1e6568bf14b3a23c66f70c94aabd21" title="my_fwrite" alt="" coords="203,456,285,485"/><area shape="rect" id="node33" href="io_8c.html#ad5243b69dcba17be62f7d64f422bfbbf" title="write_header_attributes_in_hdf5" alt="" coords="131,509,357,539"/><area shape="rect" id="node7" href="proto_8h.html#a869daac8b2af5667db265026f09fb9d8" title="terminate_processes" alt="" coords="608,349,765,379"/><area shape="rect" id="node11" href="proto_8h.html#ac5e72d197cde6d71017e89db9b986b85" title="dmax" alt="" coords="453,5,512,35"/><area shape="rect" id="node13" href="driftfac_8c.html#a29057b821b850ab54b318d7339633059" title="get_gravkick_factor" alt="" coords="409,59,556,88"/><area shape="rect" id="node15" href="driftfac_8c.html#ace65dca1556185b12c7f22427724c90c" title="get_hydrokick_factor" alt="" coords="405,112,560,141"/><area shape="rect" id="node17" href="proto_8h.html#a96ae9abed439401fd6dd28a1e2c2f94e" title="pow" alt="" coords="460,165,505,195"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_a48b0ed3a843924501df8ed871e08e77c_icgraph.png" border="0" usemap="#proto_8h_a48b0ed3a843924501df8ed871e08e77c_icgraph" alt=""/></div>
<map name="proto_8h_a48b0ed3a843924501df8ed871e08e77c_icgraph" id="proto_8h_a48b0ed3a843924501df8ed871e08e77c_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="131,32,240,61"/><area shape="rect" id="node5" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="288,5,507,35"/><area shape="rect" id="node7" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="555,32,597,61"/><area shape="rect" id="node9" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="647,32,700,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad5243b69dcba17be62f7d64f422bfbbf"></a><!-- doxytag: member="proto.h::write_header_attributes_in_hdf5" ref="ad5243b69dcba17be62f7d64f422bfbbf" args="(hid_t handle)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void write_header_attributes_in_hdf5 </td>
          <td>(</td>
          <td class="paramtype">hid_t&nbsp;</td>
          <td class="paramname"> <em>handle</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function writes the header information in case HDF5 is selected as file format. </p>

<p>Definition at line <a class="el" href="io_8c_source.html#l00998">998</a> of file <a class="el" href="io_8c_source.html">io.c</a>.</p>

<p>References <a class="el" href="allvars_8h_source.html#l00643">io_header::BoxSize</a>, <a class="el" href="allvars_8h_source.html#l00641">io_header::flag_cooling</a>, <a class="el" href="allvars_8h_source.html#l00650">io_header::flag_entropy_instead_u</a>, <a class="el" href="allvars_8h_source.html#l00638">io_header::flag_feedback</a>, <a class="el" href="allvars_8h_source.html#l00648">io_header::flag_metals</a>, <a class="el" href="allvars_8h_source.html#l00637">io_header::flag_sfr</a>, <a class="el" href="allvars_8h_source.html#l00647">io_header::flag_stellarage</a>, <a class="el" href="allvars_8c_source.html#l00162">header</a>, <a class="el" href="allvars_8h_source.html#l00646">io_header::HubbleParam</a>, <a class="el" href="allvars_8h_source.html#l00633">io_header::mass</a>, <a class="el" href="allvars_8h_source.html#l00632">io_header::npart</a>, <a class="el" href="allvars_8h_source.html#l00639">io_header::npartTotal</a>, <a class="el" href="allvars_8h_source.html#l00649">io_header::npartTotalHighWord</a>, <a class="el" href="allvars_8h_source.html#l00642">io_header::num_files</a>, <a class="el" href="allvars_8h_source.html#l00644">io_header::Omega0</a>, <a class="el" href="allvars_8h_source.html#l00645">io_header::OmegaLambda</a>, <a class="el" href="allvars_8h_source.html#l00636">io_header::redshift</a>, and <a class="el" href="allvars_8h_source.html#l00635">io_header::time</a>.</p>

<p>Referenced by <a class="el" href="io_8c_source.html#l00672">write_file()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  hsize_t adim[1] = { 6 };
  hid_t hdf5_dataspace, hdf5_attribute;

  hdf5_dataspace = H5Screate(H5S_SIMPLE);
  H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;NumPart_ThisFile&quot;</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#adc88d581cf3d57eb975a51f587538bdd">npart</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SIMPLE);
  H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;NumPart_Total&quot;</span>, H5T_NATIVE_UINT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad63a8b413a6b56c33bf5ecc25550a6dd">npartTotal</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SIMPLE);
  H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;NumPart_Total_HW&quot;</span>, H5T_NATIVE_UINT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a56f54a68fe289b19902b3c4c561a7159">npartTotalHighWord</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);


  hdf5_dataspace = H5Screate(H5S_SIMPLE);
  H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;MassTable&quot;</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a2c387b0c7c823287d424fedc70175917">mass</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Time&quot;</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad6237959a3590772366f18000a47a7d6">time</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Redshift&quot;</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ae2484703f374288fb266ff268a1ffa91">redshift</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;BoxSize&quot;</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#aacb7ba10d16ae90490a9deba37ace731">BoxSize</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;NumFilesPerSnapshot&quot;</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a5688351781a2845beb2c52a035cc5f71">num_files</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Omega0&quot;</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#af0d78ac0e8131523be64b3686aab9550">Omega0</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;OmegaLambda&quot;</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#aa2cdc9653addc264b58134006bca1bb8">OmegaLambda</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;HubbleParam&quot;</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ad0f0d02804350f8935aadca9b5ef0fcf">HubbleParam</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Flag_Sfr&quot;</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#afe21a629578012fd99d118d2ad834763">flag_sfr</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Flag_Cooling&quot;</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ae877c2fcde2f096886193c22b9b73cbf">flag_cooling</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Flag_StellarAge&quot;</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#abe83e840bb4778a3be11a084dfa85c3c">flag_stellarage</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Flag_Metals&quot;</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#ac025f6c1cff1914d893ce0c7c5fd46bb">flag_metals</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  hdf5_dataspace = H5Screate(H5S_SCALAR);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Flag_Feedback&quot;</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a98679063cc311c5f6184459600fa05a5">flag_feedback</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);

  <a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a448788ace72155e22d19af1c01917857">flag_entropy_instead_u</a> = 0;

  hdf5_dataspace = H5Screate(H5S_SIMPLE);
  H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
  hdf5_attribute = H5Acreate(handle, <span class="stringliteral">&quot;Flag_Entropy_ICs&quot;</span>, H5T_NATIVE_UINT, hdf5_dataspace, H5P_DEFAULT);
  H5Awrite(hdf5_attribute, H5T_NATIVE_UINT, &amp;<a class="code" href="allvars_8c.html#a5d111aa83cef5894eea3939d815bb803">header</a>.<a class="code" href="structio__header.html#a448788ace72155e22d19af1c01917857">flag_entropy_instead_u</a>);
  H5Aclose(hdf5_attribute);
  H5Sclose(hdf5_dataspace);
}
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="proto_8h_ad5243b69dcba17be62f7d64f422bfbbf_icgraph.png" border="0" usemap="#proto_8h_ad5243b69dcba17be62f7d64f422bfbbf_icgraph" alt=""/></div>
<map name="proto_8h_ad5243b69dcba17be62f7d64f422bfbbf_icgraph" id="proto_8h_ad5243b69dcba17be62f7d64f422bfbbf_icgraph">
<area shape="rect" id="node3" href="proto_8h.html#a48b0ed3a843924501df8ed871e08e77c" title="write_file" alt="" coords="280,32,357,61"/><area shape="rect" id="node5" href="proto_8h.html#a523730833804b6d92aa7f4dd474805c5" title="savepositions" alt="" coords="405,32,515,61"/><area shape="rect" id="node7" href="run_8c.html#ad52604af910b3e1677718d863ab09391" title="find_next_sync_point_and_drift" alt="" coords="563,5,781,35"/><area shape="rect" id="node9" href="run_8c.html#a05e0ffe612d44e6d7f3a9ae5b9df56a2" title="run" alt="" coords="829,32,872,61"/><area shape="rect" id="node11" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="921,32,975,61"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a38a8b7521229c82f0f4146f60b88d9c5"></a><!-- doxytag: member="proto.h::write_pid_file" ref="a38a8b7521229c82f0f4146f60b88d9c5" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void write_pid_file </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Dec 3 2010 18:45:45 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
