\hypertarget{restart_8c}{\section{restart.\-c \-File \-Reference}
\label{restart_8c}\index{restart.\-c@{restart.\-c}}
}


\-Code for reading and writing restart files.  


{\ttfamily \#include $<$stdio.\-h$>$}\*
{\ttfamily \#include $<$stdlib.\-h$>$}\*
{\ttfamily \#include $<$string.\-h$>$}\*
{\ttfamily \#include $<$math.\-h$>$}\*
{\ttfamily \#include $<$mpi.\-h$>$}\*
{\ttfamily \#include $<$fcntl.\-h$>$}\*
{\ttfamily \#include $<$sys/stat.\-h$>$}\*
{\ttfamily \#include $<$sys/types.\-h$>$}\*
{\ttfamily \#include $<$sys/file.\-h$>$}\*
{\ttfamily \#include $<$unistd.\-h$>$}\*
{\ttfamily \#include $<$gsl/gsl\-\_\-rng.\-h$>$}\*
{\ttfamily \#include \char`\"{}allvars.\-h\char`\"{}}\*
{\ttfamily \#include \char`\"{}proto.\-h\char`\"{}}\*
\-Include dependency graph for restart.\-c\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{restart_8c__incl}
\end{center}
\end{figure}
\subsection*{\-Functions}
\begin{DoxyCompactItemize}
\item 
static void \hyperlink{restart_8c_a2f4631df8dbc2cc10c5d7ce28c975ad5}{in} (int $\ast$x, int modus)
\item 
static void \hyperlink{restart_8c_aaecf930e789ca4889b8e40770306fe21}{byten} (void $\ast$x, size\-\_\-t n, int modus)
\item 
void \hyperlink{restart_8c_ae81d30f52dddd39aef76bb1890d16f2f}{restart} (int modus)
\end{DoxyCompactItemize}
\subsection*{\-Variables}
\begin{DoxyCompactItemize}
\item 
static \-F\-I\-L\-E $\ast$ \hyperlink{restart_8c_a600b792d6d2ff2e71096dfa60d97a3b0}{fd}
\end{DoxyCompactItemize}


\subsection{\-Detailed \-Description}
\-Code for reading and writing restart files. 

\-Definition in file \hyperlink{restart_8c_source}{restart.\-c}.



\subsection{\-Function \-Documentation}
\hypertarget{restart_8c_aaecf930e789ca4889b8e40770306fe21}{\index{restart.\-c@{restart.\-c}!byten@{byten}}
\index{byten@{byten}!restart.c@{restart.\-c}}
\subsubsection[{byten}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf byten} (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{x, }
\item[{size\-\_\-t}]{n, }
\item[{int}]{modus}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{restart_8c_aaecf930e789ca4889b8e40770306fe21}
reads/writes n bytes in restart routine 

\-Definition at line 289 of file restart.\-c.



\-References fd, my\-\_\-fread(), and my\-\_\-fwrite().



\-Referenced by restart().


\begin{DoxyCode}
{
  if(modus)
    my_fread(x, n, 1, fd);
  else
    my_fwrite(x, n, 1, fd);
}
\end{DoxyCode}


\-Here is the call graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{restart_8c_aaecf930e789ca4889b8e40770306fe21_cgraph}
\end{center}
\end{figure}




\-Here is the caller graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{restart_8c_aaecf930e789ca4889b8e40770306fe21_icgraph}
\end{center}
\end{figure}


\hypertarget{restart_8c_a2f4631df8dbc2cc10c5d7ce28c975ad5}{\index{restart.\-c@{restart.\-c}!in@{in}}
\index{in@{in}!restart.c@{restart.\-c}}
\subsubsection[{in}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf in} (
\begin{DoxyParamCaption}
\item[{int $\ast$}]{x, }
\item[{int}]{modus}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{restart_8c_a2f4631df8dbc2cc10c5d7ce28c975ad5}
reads/writes one `int' variable in restart routine 

\-Definition at line 300 of file restart.\-c.



\-References fd, my\-\_\-fread(), and my\-\_\-fwrite().



\-Referenced by restart().


\begin{DoxyCode}
{
  if(modus)
    my_fread(x, 1, sizeof(int), fd);
  else
    my_fwrite(x, 1, sizeof(int), fd);
}
\end{DoxyCode}


\-Here is the call graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{restart_8c_a2f4631df8dbc2cc10c5d7ce28c975ad5_cgraph}
\end{center}
\end{figure}




\-Here is the caller graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{restart_8c_a2f4631df8dbc2cc10c5d7ce28c975ad5_icgraph}
\end{center}
\end{figure}


\hypertarget{restart_8c_ae81d30f52dddd39aef76bb1890d16f2f}{\index{restart.\-c@{restart.\-c}!restart@{restart}}
\index{restart@{restart}!restart.c@{restart.\-c}}
\subsubsection[{restart}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf restart} (
\begin{DoxyParamCaption}
\item[{int}]{modus}
\end{DoxyParamCaption}
)}}\label{restart_8c_ae81d30f52dddd39aef76bb1890d16f2f}
\-This function reads or writes the restart files. \-Each processor writes its own restart file, with the \-I/\-O being done in parallel. \-To avoid congestion of the disks you can tell the program to restrict the number of files that are simultaneously written to \-Num\-Files\-Written\-In\-Parallel.

\-If modus$>$0 the \hyperlink{proto_8h_af3e3dd8294f983f9ed9f75c81d149ec9}{restart()}-\/routine reads, if modus==0 it writes a restart file. $<$ defines maximum length of neighbour list

$<$ \-Maximum number of nodes in the top-\/level tree used for domain decomposition

$<$ \-Maximum number of nodes in the top-\/level tree used for domain decomposition

$<$ \-Maximum number of nodes in the top-\/level tree used for domain decomposition

$<$ \-Maximum number of nodes in the top-\/level tree used for domain decomposition

$<$ \-Maximum number of nodes in the top-\/level tree used for domain decomposition

$<$ \-Maximum number of nodes in the top-\/level tree used for domain decomposition

$<$ \-Maximum number of nodes in the top-\/level tree used for domain decomposition

$<$ \-Maximum number of nodes in the top-\/level tree used for domain decomposition 

\-Definition at line 35 of file restart.\-c.



\-References \-All, allocate\-\_\-memory(), byten(), \-Domain\-Center, \-Domain\-Corner, \-Domain\-End\-List, \-Domain\-Fac, \-Domain\-Hmax, \-Domain\-Len, \-Domain\-Moment, \-Domain\-My\-Last, \-Domain\-My\-Start, \-Domain\-Node\-Index, \-Domain\-Start\-List, \-Domain\-Task, \-Domain\-Tree\-Node\-Len, endrun(), \-Extnodes\-\_\-base, \-Father, fd, force\-\_\-treeallocate(), in(), \-Max\-Nodes, \-N\-\_\-gas, \-Nextnode, ngb\-\_\-treeallocate(), \-Nodes\-\_\-base, \-N\-Task, \-Numnodestree, \-Num\-Part, \-P, random\-\_\-generator, \-Sph\-P, and \-This\-Task.



\-Referenced by begrun(), and run().


\begin{DoxyCode}
{
  char buf[200], buf_bak[200], buf_mv[500];
  double save_PartAllocFactor, save_TreeAllocFactor;
  int i, nprocgroup, masterTask, groupTask, old_MaxPart, old_MaxNodes;
  struct global_data_all_processes all_task0;


  sprintf(buf, "%s%s.%d", All.OutputDir, All.RestartFile, ThisTask);
  sprintf(buf_bak, "%s%s.%d.bak", All.OutputDir, All.RestartFile, ThisTask);
  sprintf(buf_mv, "mv %s %s", buf, buf_bak);


  if((NTask < All.NumFilesWrittenInParallel))
    {
      printf
        ("Fatal error.\nNumber of processors must be a smaller or equal than
       `NumFilesWrittenInParallel'.\n");
      endrun(2131);
    }

  nprocgroup = NTask / All.NumFilesWrittenInParallel;

  if((NTask % All.NumFilesWrittenInParallel))
    {
      nprocgroup++;
    }

  masterTask = (ThisTask / nprocgroup) * nprocgroup;

  for(groupTask = 0; groupTask < nprocgroup; groupTask++)
    {
      if(ThisTask == (masterTask + groupTask))  /* ok, it's this processor's
       turn */
        {
          if(modus)
            {
              if(!(fd = fopen(buf, "r")))
                {
                  printf("Restart file '%s' not found.\n", buf);
                  endrun(7870);
                }
            }
          else
            {
              system(buf_mv);   /* move old restart files to .bak files */

              if(!(fd = fopen(buf, "w")))
                {
                  printf("Restart file '%s' cannot be opened.\n", buf);
                  endrun(7878);
                }
            }


          save_PartAllocFactor = All.PartAllocFactor;
          save_TreeAllocFactor = All.TreeAllocFactor;

          /* common data  */
          byten(&All, sizeof(struct global_data_all_processes), modus);

          if(ThisTask == 0 && modus > 0)
            all_task0 = All;

          if(modus > 0 && groupTask == 0)       /* read */
            {
              MPI_Bcast(&all_task0, sizeof(struct global_data_all_processes), 
      MPI_BYTE, 0, MPI_COMM_WORLD);
            }

          old_MaxPart = All.MaxPart;
          old_MaxNodes = All.TreeAllocFactor * All.MaxPart;

          if(modus)             /* read */
            {
              if(All.PartAllocFactor != save_PartAllocFactor)
                {
                  All.PartAllocFactor = save_PartAllocFactor;
                  All.MaxPart = All.PartAllocFactor * (All.TotNumPart / NTask);
                  All.MaxPartSph = All.PartAllocFactor * (All.TotN_gas / NTask)
      ;
                  save_PartAllocFactor = -1;
                }

              if(All.TreeAllocFactor != save_TreeAllocFactor)
                {
                  All.TreeAllocFactor = save_TreeAllocFactor;
                  save_TreeAllocFactor = -1;
                }

              if(all_task0.Time != All.Time)
                {
                  printf("The restart file on task=%d is not consistent with
       the one on task=0\n", ThisTask);
                  fflush(stdout);
                  endrun(16);
                }

              allocate_memory();
            }

          in(&NumPart, modus);

          if(NumPart > All.MaxPart)
            {
              printf
                ("it seems you have reduced(!) 'PartAllocFactor' below the
       value of %g needed to load the restart file.\n",
                 NumPart / (((double) All.TotNumPart) / NTask));
              printf("fatal error\n");
              endrun(22);
            }

          /* Particle data  */
          byten(&P[0], NumPart * sizeof(struct particle_data), modus);

          in(&N_gas, modus);

          if(N_gas > 0)
            {
              if(N_gas > All.MaxPartSph)
                {
                  printf
                    ("SPH: it seems you have reduced(!) 'PartAllocFactor' below
       the value of %g needed to load the restart file.\n",
                     N_gas / (((double) All.TotN_gas) / NTask));
                  printf("fatal error\n");
                  endrun(222);
                }
              /* Sph-Particle data  */
              byten(&SphP[0], N_gas * sizeof(struct sph_particle_data), modus);
            }

          /* write state of random number generator */
          byten(gsl_rng_state(random_generator), gsl_rng_size(random_generator)
      , modus);


          /* now store relevant data for tree */

          if(modus)             /* read */
            {
              ngb_treeallocate(MAX_NGB);

              force_treeallocate(All.TreeAllocFactor * All.MaxPart, All.MaxPart
      );
            }


          in(&Numnodestree, modus);

          if(Numnodestree > MaxNodes)
            {
              printf
                ("Tree storage: it seems you have reduced(!) 'PartAllocFactor'
       below the value needed to load the restart file (task=%d). "
                 "Numnodestree=%d  MaxNodes=%d\n", ThisTask, Numnodestree, 
      MaxNodes);
              endrun(221);
            }

          byten(Nodes_base, Numnodestree * sizeof(struct NODE), modus);
          byten(Extnodes_base, Numnodestree * sizeof(struct extNODE), modus);

          byten(Father, NumPart * sizeof(int), modus);

          byten(Nextnode, NumPart * sizeof(int), modus);
          byten(Nextnode + All.MaxPart, MAXTOPNODES * sizeof(int), modus);

          byten(DomainStartList, NTask * sizeof(int), modus);
          byten(DomainEndList, NTask * sizeof(int), modus);
          byten(DomainTask, MAXTOPNODES * sizeof(int), modus);
          byten(DomainNodeIndex, MAXTOPNODES * sizeof(int), modus);
          byten(DomainTreeNodeLen, MAXTOPNODES * sizeof(FLOAT), modus);
          byten(DomainHmax, MAXTOPNODES * sizeof(FLOAT), modus);
          byten(DomainMoment, MAXTOPNODES * sizeof(struct DomainNODE), modus);

          byten(DomainCorner, 3 * sizeof(double), modus);
          byten(DomainCenter, 3 * sizeof(double), modus);
          byten(&DomainLen, sizeof(double), modus);
          byten(&DomainFac, sizeof(double), modus);
          byten(&DomainMyStart, sizeof(int), modus);
          byten(&DomainMyLast, sizeof(int), modus);

          if(modus)             /* read */
            if(All.PartAllocFactor != save_PartAllocFactor || All.
      TreeAllocFactor != save_TreeAllocFactor)
              {
                for(i = 0; i < NumPart; i++)
                  Father[i] += (All.MaxPart - old_MaxPart);

                for(i = 0; i < NumPart; i++)
                  if(Nextnode[i] >= old_MaxPart)
                    {
                      if(Nextnode[i] >= old_MaxPart + old_MaxNodes)
                        Nextnode[i] += (All.MaxPart - old_MaxPart) + (MaxNodes 
      - old_MaxPart);
                      else
                        Nextnode[i] += (All.MaxPart - old_MaxPart);
                    }

                for(i = 0; i < Numnodestree; i++)
                  {
                    if(Nodes_base[i].u.d.sibling >= old_MaxPart)
                      {
                        if(Nodes_base[i].u.d.sibling >= old_MaxPart + 
      old_MaxNodes)
                          Nodes_base[i].u.d.sibling +=
                            (All.MaxPart - old_MaxPart) + (MaxNodes - 
      old_MaxNodes);
                        else
                          Nodes_base[i].u.d.sibling += (All.MaxPart - 
      old_MaxPart);
                      }

                    if(Nodes_base[i].u.d.father >= old_MaxPart)
                      {
                        if(Nodes_base[i].u.d.father >= old_MaxPart + 
      old_MaxNodes)
                          Nodes_base[i].u.d.father += (All.MaxPart - 
      old_MaxPart) + (MaxNodes - old_MaxNodes);
                        else
                          Nodes_base[i].u.d.father += (All.MaxPart - 
      old_MaxPart);
                      }

                    if(Nodes_base[i].u.d.nextnode >= old_MaxPart)
                      {
                        if(Nodes_base[i].u.d.nextnode >= old_MaxPart + 
      old_MaxNodes)
                          Nodes_base[i].u.d.nextnode +=
                            (All.MaxPart - old_MaxPart) + (MaxNodes - 
      old_MaxNodes);
                        else
                          Nodes_base[i].u.d.nextnode += (All.MaxPart - 
      old_MaxPart);
                      }
                  }

                for(i = 0; i < MAXTOPNODES; i++)
                  if(Nextnode[i + All.MaxPart] >= old_MaxPart)
                    {
                      if(Nextnode[i + All.MaxPart] >= old_MaxPart + 
      old_MaxNodes)
                        Nextnode[i + All.MaxPart] += (All.MaxPart - old_MaxPart
      ) + (MaxNodes - old_MaxNodes);
                      else
                        Nextnode[i + All.MaxPart] += (All.MaxPart - old_MaxPart
      );
                    }

                for(i = 0; i < MAXTOPNODES; i++)
                  if(DomainNodeIndex[i] >= old_MaxPart)
                    {
                      if(DomainNodeIndex[i] >= old_MaxPart + old_MaxNodes)
                        DomainNodeIndex[i] += (All.MaxPart - old_MaxPart) + (
      MaxNodes - old_MaxNodes);
                      else
                        DomainNodeIndex[i] += (All.MaxPart - old_MaxPart);
                    }
              }

          fclose(fd);
        }
      else                      /* wait inside the group */
        {
          if(modus > 0 && groupTask == 0)       /* read */
            {
              MPI_Bcast(&all_task0, sizeof(struct global_data_all_processes), 
      MPI_BYTE, 0, MPI_COMM_WORLD);
            }
        }

      MPI_Barrier(MPI_COMM_WORLD);
    }
}
\end{DoxyCode}


\-Here is the call graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{restart_8c_ae81d30f52dddd39aef76bb1890d16f2f_cgraph}
\end{center}
\end{figure}




\-Here is the caller graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=294pt]{restart_8c_ae81d30f52dddd39aef76bb1890d16f2f_icgraph}
\end{center}
\end{figure}




\subsection{\-Variable \-Documentation}
\hypertarget{restart_8c_a600b792d6d2ff2e71096dfa60d97a3b0}{\index{restart.\-c@{restart.\-c}!fd@{fd}}
\index{fd@{fd}!restart.c@{restart.\-c}}
\subsubsection[{fd}]{\setlength{\rightskip}{0pt plus 5cm}\-F\-I\-L\-E$\ast$ {\bf fd}\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{restart_8c_a600b792d6d2ff2e71096dfa60d97a3b0}


\-Definition at line 21 of file restart.\-c.



\-Referenced by byten(), dump\-\_\-particles(), ewald\-\_\-init(), find\-\_\-files(), in(), read\-\_\-file(), read\-\_\-outputlist(), read\-\_\-parameter\-\_\-file(), restart(), run(), and write\-\_\-file().

